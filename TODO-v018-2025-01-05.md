# Kanban Work - TODO一覧

**バージョン**: v018
**作成日**: 2025-01-05
**最終更新**: 2025-01-05
**ステータス**: 徹底検証完了・問題点洗い出し済み

---

## 最重要: 次のエージェントへの引き継ぎ

### 必ず最初に読むファイル
1. **このファイル (TODO-v018)**
2. **error-logs/2025-12-15-git-checkout-disaster.md**
3. **error-logs/2025-12-15-cache-stale-reading-problem.md**

### 絶対に守ること
1. **破壊的gitコマンド禁止**: `git checkout --`, `git reset --hard`, `git clean -fd`, `git push --force`
2. **変更したらすぐコミット**
3. **セッション開始時にTODO/エラーログを全て読む**

### 開発環境
```
開発環境: http://localhost:8080/index-kanban.html
本番環境: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/index-kanban.html
起動方法: cd /home/muranaka-tenma/sales-task-manager/sales-task-core && python3 -m http.server 8080
```

---

## 2025-01-05 徹底検証結果

### 確認済み（完了）
| 項目 | 状態 | 根拠 |
|------|------|------|
| git checkout災害の36項目復旧 | **100%完了** | index-kanban.html実装確認、E2Eテスト63/63 PASS |

---

## 残タスク一覧（27項目）

### P0: 即時対応必須（4項目）

| # | 項目 | 詳細 | 行番号/ファイル |
|---|------|------|----------------|
| 1 | タスクドラッグ&ドロップの動作確認 | 修正適用済み、確認待ち | index-kanban.html |
| 2 | ID重複問題修正 | `completion-rate`が2箇所で定義 | 行1455（統計バー）, 行1963（アナリティクス） |
| 3 | ID重複問題修正 | `task-hidden-input`が2箇所で定義 | 行1760（タスクモーダル）, 行5047（PJ作成） |
| 4 | pj-create.htmlの二重Firebase設定 | 両方のfirebase-configを読み込み | 行8, 行792 |
| 5 | キャッシュ問題の恒久的解決 | 調査中のまま根本原因未特定 | error-logs/2025-12-15-cache-stale-reading-problem.md |

### P1: 高優先度（8項目）

| # | 項目 | 詳細 | 行番号/ファイル |
|---|------|------|----------------|
| 6 | ログイン関連ファイルのFirebase設定統一 | 古いfirebase-config.jsを使用中 | login.html, my-profile.html, fix-session.html |
| 7 | auth-fix版にメソッド追加 | signOut, updatePassword, onAuthStateChanged | firebase-config-auth-fix-20250819-132508.js |
| 8 | div閉じタグ不足修正 | 463開始タグ vs 462終了タグ | index-kanban.html全体 |
| 9 | window.tasks/let tasks混在解消 | グローバル変数の整理 | 行2301-2302 |
| 10 | roleMap重複定義の統合 | 2箇所で同一定義 | 行68-76, 行167-175 |
| 11 | 本番環境での継続的監視体制 | Netlifyビルドログ、Firebase使用状況の定期確認 | - |
| 12 | Firebaseセキュリティルール定期監査 | 公開キーの安全性確保 | Firebase Console |
| 13 | 破壊的gitコマンド自動検出 | 再発防止策（pre-commitフック等） | .git/hooks/ |

### P2: 中優先度（4項目）

| # | 項目 | 詳細 | 行番号/ファイル |
|---|------|------|----------------|
| 14 | 空のcatchブロックにエラーログ追加 | エラーが隠蔽されている | 行43, 行7741 |
| 15 | console.log削減 | 778箇所→必要最小限 | index-kanban.html全体 |
| 16 | E2Eテストのセレクタ修正 | Puppeteer使用（Playwrightではない） | /e2e/, /tests/ |
| 17 | 複数デバイス・ブラウザでの動作確認 | iOS Safari, Android Chrome, Edge, Firefox | - |

### P3: 低優先度（9項目）

| # | 項目 | 詳細 | 行番号/ファイル |
|---|------|------|----------------|
| 18 | 未使用関数40個の整理 | loadTasksFromStorage等 | index-kanban.html |
| 19 | test-*.js（19ファイル）移動 | テストフォルダへ整理 | sales-task-core/ |
| 20 | debug-*.html/js（13ファイル）整理 | 削除または移動 | sales-task-core/ |
| 21 | レガシーコード削除 | migrateProjectsToFirebase等54行 | index-kanban.html |
| 22 | パフォーマンス改善 | Violation 2574ms問題 | index-kanban.html |
| 23 | はてなボタンのチュートリアル化 | 現在の機能説明をチュートリアル形式に | index-kanban.html |
| 24 | 巨大関数の分割 | 100行超の関数が複数存在 | index-kanban.html |
| 25 | マジックナンバーの定数化 | タイムアウト値、z-index等がハードコード | index-kanban.html |
| 26 | UI/UX Phase 2 | プログレスバー、アニメーション等 | index-kanban.html |

### 至上命題: LocalStorage脱却（1項目）

| # | 項目 | キー | 使用箇所数 |
|---|------|-----|-----------|
| 27 | LocalStorage脱却設計と実装 | currentSession | 27箇所 |
| | | kanbanColumns | 24箇所 |
| | | systemUsers | 16箇所 |
| | | taskTemplates | 8箇所 |
| | | recurringTemplates | 6箇所 |
| | | defaultDeadlineDays | 3箇所 |
| | | defaultDeadlineTime | 3箇所 |

---

## 発見された問題の詳細

### ID重複問題（P0）

**completion-rate**:
```html
<!-- 行1455: 統計バー -->
<span class="stat-number" id="completion-rate">-</span>

<!-- 行1963: アナリティクスモーダル -->
<div id="completion-rate">-</div>
```
**影響**: `getElementById`が常に行1455を返す → アナリティクス表示が異常

**task-hidden-input**:
```html
<!-- 行1760: タスクモーダル -->
<input type="checkbox" id="task-hidden-input">

<!-- 行5047: プロジェクトタスク作成モーダル -->
<input type="checkbox" id="task-hidden-input">
```
**影響**: 非表示フラグ設定時の競合

### Firebase設定ファイル問題（P0/P1）

**使用状況**:
| ファイル | 使用設定 | 問題 |
|---------|---------|------|
| index-kanban.html | auth-fix版 | OK |
| admin-dashboard.html | auth-fix版 | OK |
| user-management.html | auth-fix版 | OK |
| pj-settings.html | auth-fix版 | OK |
| **pj-create.html** | **両方** | **矛盾** |
| **login.html** | **古い版** | **統一必要** |
| **my-profile.html** | **古い版** | **統一必要** |
| **fix-session.html** | **古い版** | **統一必要** |

**auth-fix版に不足しているメソッド**:
- `signOut()` - ログアウト機能
- `updatePassword()` - パスワード変更
- `onAuthStateChanged()` - 認証状態監視

---

## エラーログ未解決項目

### キャッシュ問題（P0）
- **ファイル**: error-logs/2025-12-15-cache-stale-reading-problem.md
- **状態**: 調査中
- **問題**: 開発環境で古いバージョンがキャッシュされ続ける
- **考えられる原因**:
  1. ブラウザキャッシュ
  2. Service Worker
  3. live-serverのキャッシュ
  4. HTTPキャッシュヘッダー
  5. WSL環境のファイル同期遅延

### タスクドラッグ&ドロップ（P0）
- **ファイル**: error-logs/2025-12-15-session-errors.md
- **状態**: 修正適用済み、動作確認待ち
- **原因**: document.addEventListener('mouseup')がHTML5 Drag APIと干渉

---

## 前バージョン（v017）で完了した項目

| 日付 | 項目 |
|------|------|
| 12/26 | 開発環境URL統一（localhost:8080） |
| 12/26 | 不要ファイル削除（34,440行削減） |
| 12/26 | emailToNameMap統合 |
| 12/26 | 本番デプロイ完了 |
| 12/25 | フィルター簡素化（単一選択・全員オプション） |
| 12/25 | 担当者表示ローマ字バグ修正 |
| 12/23 | カラム削除タスクチェック強化 |
| 12/23 | 管理者ダッシュボード速度改善（5ms以下） |
| 12/22 | テンプレート・プロジェクトカラー修正 |
| 12/22 | アーカイブ重複防止 |
| 12/19 | E2Eテスト全実行（63/63 PASS） |

---

## E2Eテスト状況

### 正常動作（Puppeteer）
| ファイル | 結果 | 最終実行 |
|---------|------|---------|
| run-e2e-tests.js | 14/14 PASS | 12/19 |
| run-e2e-tests-full.js | 7ユーザー PASS | 12/19 |
| test-project-fixes-simple.js | 63/63 PASS | 12/22 |
| test-1222-night-fixes.js | 34/34 PASS | 12/23 |

### 実行不可（Playwright）
- セレクタ不一致（`#email` → 実際は`#username`）
- 廃止メソッド使用（`page.waitForTimeout()`）

---

## バージョン履歴

| バージョン | 日付 | 主な内容 |
|-----------|------|---------|
| v001-v003 | 11/19-20 | 初期要件定義 |
| v004 | 11/20 | 包括的要件定義（22項目） |
| v005 | 12/01 | UI/UX Phase 1完了 |
| v006 | 12/01-02 | 統計ロジック修正（14箇所） |
| v007 | 12/04 | タスク増殖バグ修正 |
| v008 | 12/08 | OCR削除、ヘルプモーダル |
| v009 | 12/09 | マイページ統計修正 |
| v010 | 12/11 | TERRAブランディング |
| v011-v013 | 12/15 | git checkout災害・復旧計画 |
| v014-v015 | 12/16 | 復旧進捗27/36 |
| v016 | 12/18 | カラム設定全ユーザー開放 |
| v017 | 12/19-26 | 43項目完了、クリーンアップ |
| **v018** | **01/05** | **徹底検証完了、27項目の問題洗い出し** |

---

**最終更新**: 2025-01-05
**作成者**: Claude Code
**ステータス**: 徹底検証完了・問題点洗い出し済み
**次のステップ**: P0の5項目から順に対応
