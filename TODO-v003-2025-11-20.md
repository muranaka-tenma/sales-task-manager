# 営業タスク管理システム - TODO一覧

**バージョン**: v003
**更新日**: 2025-11-20 16:30
**合計残作業時間**: 約9-12時間

---

## 本日の完了作業（2025-11-20）

### ✅ プロジェクトタスクのDONE/TRASH機能完全実装
**コミット**: 57fd84c

#### 1. 完了・ゴミ箱への移動時アラートが出ない問題を修正
- `getColumnNameById()` 関数を追加（プロジェクトカラムID `pj_{projectId}_{index}` から実際のカラム名を取得）
- `isDoneColumn()` と `isTrashColumn()` ヘルパー関数を実装
- プロジェクトタスクでも通常タスクと同じ確認アラートが表示されるように修正
- **変更箇所**: index-kanban.html:3167-3226

#### 2. プロジェクト編集モーダルの×ボタン修正
- モーダルに `id='projectEditModal'` を付与
- `this.closest('div').remove()` から `document.getElementById('projectEditModal').remove()` に変更
- キャンセルボタンも同様に修正
- **変更箇所**: index-kanban.html:13355, 13377, 13426

#### 3. 完了カラムのタスクが期限切れで赤くなる問題を修正
- `isOverdue()` と `isToday()` 関数を修正
- 完了カラム・ゴミ箱カラムでは期限切れ判定をスキップ
- 3日停滞フラグも完了・ゴミ箱カラムでは除外
- **変更箇所**: index-kanban.html:3642-3658, 6662

#### 4. ゴミ箱の180日後自動削除機能をプロジェクトタスクにも対応
- `cleanupTrash()` 関数で `isTrashColumn()` を使用
- 通常タスクとプロジェクトタスク両方のゴミ箱を自動削除対象に
- **変更箇所**: index-kanban.html:12441, 12465

#### 5. プロジェクトタスク編集画面で管理IDを非表示
- モーダルタイトルから `${editingTask.projectId}` を削除
- ユーザーに不要な技術的情報を非表示化
- **変更前**: `👥 プロジェクトタスク編集: project_1763615181994`
- **変更後**: `👥 プロジェクトタスク編集`
- **変更箇所**: index-kanban.html:4431

#### 6. 本番環境へデプロイ完了
- APP_VERSION: `2025-11-20-v8-hide-management-id`
- GitHubへプッシュ完了
- Netlify自動デプロイ実行中

---

## 🔴 明日の確認事項（優先）

### 1. 本番環境動作確認 **(30分)**
- Netlifyデプロイ完了後、全ての修正が正しく反映されているか確認
- プロジェクトタスクのDONE/TRASH機能テスト
- 管理ID非表示の確認

### 2. 全ユーザーで非表示タスクテスト **(30分)**
- 各ユーザーアカウントでログインして非表示タスク機能をテスト
- 自動チェック・保存・表示/非表示が正常に動作するか確認

### 3. 複数デバイス同期テスト **(20分)**
- 異なるデバイス/ブラウザで同じアカウントにログイン
- タスクデータが正しく同期されるか確認

---

## 🔴🔴🔴 最優先（緊急）

### 1. パスワードハードコード問題の解決 **(検討中)**
- login.htmlからパスワードを削除するか判断

---

## 🔴 高優先度（大きな山）

### 2. LocalStorage完全脱却プロジェクト **(3-5時間)** ⚠️超大きな山

現在132箇所でLocalStorage使用中

| データ | Firebase | LocalStorage | 状態 |
|-------|----------|--------------|------|
| タスク | ✅ | ❌ | 完全移行済み |
| プロジェクト | ✅ | ❌ | 完全移行済み |
| ユーザー情報 | ✅ | ⚠️ キャッシュ | 移行済み |
| currentSession | ❌ | ✅ | **要移行** |
| taskTemplates | ❌ | ✅ | **要移行** |
| projectSettings | ❌ | ✅ | **要移行** |
| kanbanColumns | ❌ | ✅ | **要移行** |
| recurringTemplates | ❌ | ✅ | **要移行** |

---

## 🟡 中優先度（実装・調査タスク）

### 3. ユーザー追加時のセッション上書き問題 **(1時間)**
- 症状: ユーザー追加後、自動でそのユーザーにログインされてしまう
- ヘッダーは元のユーザー（邨中天真）のまま、マイページは追加したユーザーになる
- この状態で非表示タスクをチェックすると誰も選択されない
- 対応: createUser処理でセッションを上書きしないよう修正
- 関連ファイル: `user-management.html`の745行目付近

### 4. タスク移動パフォーマンス改善 **(1時間)**
- 症状: `[Violation] 'drop' handler took 2574ms`
- 対応: Firebase保存の非同期化、楽観的UI更新

### 5. systemUsersのname未定義問題 **(30分)**
- 一部ユーザーのnameがundefined

### 6. プロジェクト公開設定の実装 **(30分)**
- 機能の動作確認
- 実装方法の調査

### 7. 管理者ダッシュボードのアクセス権限拡大 **(20分)**
- 加藤・朝日（admin権限）にもダッシュボード表示

### 8. メイン画面の統計ロジック確認 **(30分)**
- 「要調整」の判定ロジック調査

### 9. マイページの個人詳細統計 **(1時間)**
- 機能していない
- 所要時間集計の実現可能性調査

### 10. ダッシュボード統計ロジック確認 **(30分)**
- 完了タスク判別方法
- カラム名変更時の挙動

### 11. ユーザー管理の非表示/無効化の違い説明 **(20分)**

---

## 🟢 低優先度（調査・意見提示）

### 12. シークレットタスク実現可能性 **(30分)**
- 非表示タスク機能は実装済み

### 13. 期限日・優先度の必要性 **(20分)**

### 14. テンプレートカテゴリ必要性確認 **(15分)**

---

## ⚪ 完了済み

- ✅ saveTasks データ消失バグ修正（コミット: 5f2f1dd）
- ✅ 非表示タスク機能実装
- ✅ モーダルスクロール位置リセット修正
- ✅ systemUsers初期化問題の根本解決
- ✅ Firebase認証時の日本語名取得修正
- ✅ E2Eテスト実装（Playwright）
- ✅ マイページ管理機能リンク削除
- ✅ パスワード変更機能確認
- ✅ 全データ削除機能の扱い提案（後回し決定）
- ✅ 本番環境ログイン問題の解決
- ✅ プロジェクトタスク作成モーダル統合（2025-11-19）
- ✅ 非表示タスクの自動チェック問題修正（2025-11-19）
- ✅ **完了・ゴミ箱への移動時アラートが出ない問題を修正**（2025-11-20）
- ✅ **プロジェクト編集モーダルの×ボタン修正**（2025-11-20）
- ✅ **完了カラムのタスクが期限切れで赤くなる問題を修正**（2025-11-20）
- ✅ **ゴミ箱の180日後自動削除機能をプロジェクトタスクにも対応**（2025-11-20）
- ✅ **プロジェクトタスク編集画面で管理IDを非表示**（2025-11-20）
- ✅ **本番環境へデプロイ**（2025-11-20）

---

## 📝 運用ルール

1. セッション終了時にこのファイルを更新
2. 大きな変更があった場合は新バージョン作成（例: `TODO-v004-2025-11-21.md`）
3. 「TODOを見せて」と言われたら、最も高いバージョン番号のファイルを読む

### ⚠️ デプロイフロー（重要）

**必ず以下の順序を守ること：**

1. **開発環境でテスト** - `npm run test:local` でローカルテスト実行
2. **ユーザーのGOを待つ** - 本番デプロイ前に必ず承認を得る
3. **本番環境にデプロイ** - `git push` でNetlifyに自動デプロイ

**禁止事項：**
- ユーザー確認なしに本番環境を変更しない
- 開発環境でテストせずに本番デプロイしない

---

## 📁 関連ファイル

- **本番URL**: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/
- **メインコード**: `sales-task-core/index-kanban.html`
- **プロジェクト設定**: `sales-task-core/pj-settings.html`
- **Firebase設定**: `sales-task-core/firebase-config-auth-fix-20250819-132508.js`
- **セッション履歴**: `SESSION.md`
- **要件定義**: `handover/requirements/2025-11-10-new-requirements.md`

---

## 🔧 本日の技術的な変更詳細（2025-11-20）

### 追加した関数
1. `getColumnNameById()` - プロジェクトカラムIDから実際のカラム名を取得（行3167-3194）
2. `isDoneColumn()` - カラムが完了カラムかどうかを判定（行3197-3210）
3. `isTrashColumn()` - カラムがゴミ箱カラムかどうかを判定（行3213-3226）

### 修正した関数
1. `isOverdue()` - 完了・ゴミ箱カラムでは期限切れ判定しない（行3642-3648）
2. `isToday()` - 完了・ゴミ箱カラムでは本日期限判定しない（行3650-3658）
3. `cleanupTrash()` - プロジェクトタスクのゴミ箱も自動削除対象に（行12441, 12465）
4. プロジェクトタスク編集モーダルタイトル - 管理ID非表示（行4431）

### 重要な実装パターン
- **プロジェクトカラムID形式**: `pj_{projectId}_{index}`
- **カラム名パターンマッチング**:
  - 完了: `/完了|done|完成/i`
  - ゴミ箱: `/ゴミ箱|trash|削除/i`
- **通常タスクとプロジェクトタスクの統一的な扱い**: ヘルパー関数で両方に対応

### APP_VERSION履歴
- v5: delete-button-fix
- v6: alert-and-modal-fix
- v7: trash-cleanup-fix
- v8: hide-management-id（現在）

---

## 🎯 次回セッション優先事項

1. 本番環境の動作確認
2. LocalStorage脱却プロジェクトの検討
3. パフォーマンス改善（ドロップハンドラー最適化）
