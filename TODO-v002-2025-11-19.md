# 営業タスク管理システム - TODO一覧

**バージョン**: v002
**更新日**: 2025-11-19 21:40
**合計残作業時間**: 約10-13時間

---

## 本日の完了作業

### ✅ プロジェクトタスク作成モーダル統合
- タスク作成モーダルでプロジェクト選択時にカラムドロップダウンを動的に切り替え
- `updateColumnOptionsForProject()` 関数を追加
- プロジェクトタスク作成専用ボタンを廃止
- **コミット**: ad41b24

### ✅ 非表示タスクの自動チェック問題を修正
- `getCurrentUserDisplayName()` ヘルパー関数を追加（メールアドレスから日本語名を取得）
- イベントリスナーの重複防止を実装
- 保存時バリデーションも同じ関数を使用するように統一
- 開発者アカウント（muranaka-tenma@terracom.co.jp → 邨中天真）の特別処理を追加
- **原因**: FirebaseコンソールにアカウントIDが重複していた可能性

---

## 🔴 明日の確認事項（優先）

### 1. 全ユーザーで非表示タスクテスト **(30分)**
- 各ユーザーアカウントでログインして非表示タスク機能をテスト
- 自動チェック・保存・表示/非表示が正常に動作するか確認

### 2. 複数デバイス同期テスト **(20分)**
- 異なるデバイス/ブラウザで同じアカウントにログイン
- タスクデータが正しく同期されるか確認

### 3. 本番環境デプロイ **(10分)**
- 開発環境でのテスト完了後、本番環境にデプロイ
- E2Eテスト実行

---

## 🔴🔴🔴 最優先（緊急）

### 1. パスワードハードコード問題の解決 **(検討中)**
- login.htmlからパスワードを削除するか判断

---

## 🔴 高優先度（大きな山）

### 2. LocalStorage完全脱却プロジェクト **(3-5時間)** ⚠️超大きな山

現在132箇所でLocalStorage使用中

| データ | Firebase | LocalStorage | 状態 |
|-------|----------|--------------|------|
| タスク | ✅ | ❌ | 完全移行済み |
| プロジェクト | ✅ | ❌ | 完全移行済み |
| ユーザー情報 | ✅ | ⚠️ キャッシュ | 移行済み |
| currentSession | ❌ | ✅ | **要移行** |
| taskTemplates | ❌ | ✅ | **要移行** |
| projectSettings | ❌ | ✅ | **要移行** |
| kanbanColumns | ❌ | ✅ | **要移行** |
| recurringTemplates | ❌ | ✅ | **要移行** |

---

## 🟡 中優先度（実装・調査タスク）

### 3. ユーザー追加時のセッション上書き問題 **(1時間)**
- 症状: ユーザー追加後、自動でそのユーザーにログインされてしまう
- ヘッダーは元のユーザー（邨中天真）のまま、マイページは追加したユーザーになる
- この状態で非表示タスクをチェックすると誰も選択されない
- 対応: createUser処理でセッションを上書きしないよう修正
- 関連ファイル: `user-management.html`の745行目付近

### 4. タスク移動パフォーマンス改善 **(1時間)**
- 症状: `[Violation] 'drop' handler took 2574ms`
- 対応: Firebase保存の非同期化、楽観的UI更新

### 4. systemUsersのname未定義問題 **(30分)**
- 一部ユーザーのnameがundefined

### 5. プロジェクト公開設定の実装 **(30分)**
- 機能の動作確認
- 実装方法の調査

### 6. 管理者ダッシュボードのアクセス権限拡大 **(20分)**
- 加藤・朝日（admin権限）にもダッシュボード表示

### 7. 期限切れタスク赤色表示修正 **(20分)**
- 期限切れタスクのカードが赤くならない問題

### 8. メイン画面の統計ロジック確認 **(30分)**
- 「要調整」の判定ロジック調査

### 9. マイページの個人詳細統計 **(1時間)**
- 機能していない
- 所要時間集計の実現可能性調査

### 10. ダッシュボード統計ロジック確認 **(30分)**
- 完了タスク判別方法
- カラム名変更時の挙動

### 11. ユーザー管理の非表示/無効化の違い説明 **(20分)**

---

## 🟢 低優先度（調査・意見提示）

### 12. シークレットタスク実現可能性 **(30分)**
- 非表示タスク機能は実装済み

### 13. 期限日・優先度の必要性 **(20分)**

### 14. テンプレートカテゴリ必要性確認 **(15分)**

---

## ⚪ 完了済み

- ✅ saveTasks データ消失バグ修正（コミット: 5f2f1dd）
- ✅ 非表示タスク機能実装
- ✅ モーダルスクロール位置リセット修正
- ✅ systemUsers初期化問題の根本解決
- ✅ Firebase認証時の日本語名取得修正
- ✅ E2Eテスト実装（Playwright）
- ✅ マイページ管理機能リンク削除
- ✅ パスワード変更機能確認
- ✅ 全データ削除機能の扱い提案（後回し決定）
- ✅ 本番環境ログイン問題の解決
- ✅ **プロジェクトタスク作成モーダル統合**（2025-11-19）
- ✅ **非表示タスクの自動チェック問題修正**（2025-11-19）

---

## 📝 運用ルール

1. セッション終了時にこのファイルを更新
2. 大きな変更があった場合は新バージョン作成（例: `TODO-v003-2025-11-20.md`）
3. 「TODOを見せて」と言われたら、最も高いバージョン番号のファイルを読む

### ⚠️ デプロイフロー（重要）

**必ず以下の順序を守ること：**

1. **開発環境でテスト** - `npm run test:local` でローカルテスト実行
2. **ユーザーのGOを待つ** - 本番デプロイ前に必ず承認を得る
3. **本番環境にデプロイ** - `git push` でNetlifyに自動デプロイ

**禁止事項：**
- ユーザー確認なしに本番環境を変更しない
- 開発環境でテストせずに本番デプロイしない

---

## 📁 関連ファイル

- **本番URL**: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/
- **メインコード**: `sales-task-core/index-kanban.html`
- **Firebase設定**: `sales-task-core/firebase-config-auth-fix-20250819-132508.js`
- **セッション履歴**: `SESSION.md`
- **要件定義**: `handover/requirements/2025-11-10-new-requirements.md`

---

## 🔧 本日の技術的な変更詳細

### 追加した関数
1. `getCurrentUserDisplayName()` - メールアドレスから日本語名を取得（行4008-4052）
2. `updateColumnOptionsForProject()` - プロジェクト選択時のカラム切り替え（行3919-3976）
3. `setupProjectSelectListener()` - プロジェクト選択変更リスナー（行3979-3990）

### 修正した箇所
1. `setupHiddenTaskValidation()` - イベントリスナー重複防止、動的ユーザー名取得（行4039-4152）
2. 保存時バリデーション - `getCurrentUserDisplayName()`使用に変更（行5328-5369）

### 注意点
- 開発者アカウント（muranaka-tenma@terracom.co.jp）は特別処理で「邨中天真」を返す
- systemUsersとのメールアドレスマッチングが重要
