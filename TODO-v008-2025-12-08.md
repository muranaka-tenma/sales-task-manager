# 営業タスク管理システム - TODO一覧

**バージョン**: v008
**作成日**: 2025-12-08
**最終更新**: 2025-12-08
**合計残作業時間**: 約12-18時間

---

## ⚠️ 次回セッション開始時の必読事項

### 必ず確認すべきファイル
1. **このファイル（TODO-v008）** - 最新の正式版
2. **エラーログ（error-logs/）** - 過去のミスと再発防止策
   - `2025-12-08-ocr-feature-removal.md` - OCR機能完全削除
   - `2025-12-08-trash-to-archive-rename.md` - ゴミ箱→アーカイブ リネーム
   - `2025-12-04-project-task-duplication-fix.md` - プロジェクトタスク増殖バグ修正
   - `2025-12-04-wrong-dev-url-repeated-mistake.md` - 開発環境URL繰り返しミス
   - `2025-12-02-statistics-logic-column-detection-fix.md` - 統計ロジック修正14箇所

### 開発環境URL（重要）
```
開発環境: http://localhost:3000/index-kanban.html
本番環境: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/index-kanban.html
```
※ 開発環境に `sales-task-core/` は不要！

---

## ✅ 本日完了（2025-12-08）

### カラム名変更
- ✅ **「ゴミ箱」→「アーカイブ」リネーム**
  - `isTrashColumn()` / `isRequiredColumn()` にパターン追加
  - デフォルトカラム名変更（通常タスク・プロジェクト両方）
  - 確認メッセージ・アラート・ログ出力を更新
  - 変更ログ: `error-logs/2025-12-08-trash-to-archive-rename.md`
  - **互換性**: 既存の「ゴミ箱」もパターンマッチで認識

### サービス名変更
- ✅ **「営業タスク管理」→「Kanban Work」に変更**
  - index-kanban.html、login.html、各種関連ページのタイトル更新

### ヘッダー・サイドバーUI整理
- ✅ **ヘッダー右上にユーザー名表示を追加**
  - クリックでマイページを開く
- ✅ **右パネルのユーザー情報を非表示に**
- ✅ **ヘッダー左上のユーザー名表示を削除**（Kanban Workのみ表示）

### OCR機能削除
- ✅ **OCR機能完全削除**
  - Tesseract.js読み込み削除
  - OCRインポートボタン削除
  - タスクインポートモーダル削除
  - OCR関連JavaScript関数削除（約1,500行）
  - ハンバーガーメニューのOCR項目削除
  - 変更ログ: `error-logs/2025-12-08-ocr-feature-removal.md`
  - **削除理由**: 精度が微妙、コード肥大化、メンテナンス負荷

### ヘルプ・チュートリアル機能
- ✅ **ヘルプモーダル実装**
  - タブ切り替え構成（チュートリアル・機能一覧・FAQ）
  - スポットライト式チュートリアル（3コース）
    - 基本操作ツアー（5ステップ）
    - プロジェクト管理（3ステップ）
    - 応用機能（4ステップ）
  - FAQ（アコーディオン形式、6項目）
  - ヘッダーの「?」ボタンから起動

### kanbanColumns Firestore移行
- ✅ **カラム設定のFirestore移行完了**
  - 保存先: `users/{userId}/settings/columns`
  - `FirebaseDB.getColumns()` / `saveColumns()` / `migrateColumnsToFirestore()` 追加
  - `saveColumnsToFirestore()` / `initColumnsFromFirestore()` ヘルパー追加
  - 初回ログイン時にLocalStorage→Firestoreへ自動マイグレーション
  - 「ゴミ箱」→「アーカイブ」自動リネーム
  - LocalStorageはオフライン用キャッシュとして残存
  - **検証済み**: 別ブラウザ（Edge）でも同じカラム構成が表示されることを確認

### OCR削除後のエラー修正
- ✅ **`processImportText is not defined`** - window参照を削除
- ✅ **`loadImportDefaults` nullエラー** - 要素存在チェック追加
- ✅ **`renderBoard is not defined`** - `render()` に修正

---

## ✅ 前回完了（2025-12-04）

### 緊急バグ修正
- ✅ **プロジェクトタスク増殖バグ修正**
- ✅ **通常タスクのアーカイブカラム削除保護を追加**

### カラムシステム検証
- ✅ **現行システムの安全性確認**
  - 結論: **カラムシステム再設計は延期OK**

---

## 🔴🔴🔴 最優先（至上命題）

### 1. LocalStorage完全脱却プロジェクト **(3-5時間)**

**ユーザーコメント**: 「至上命題です。超重要です。」

| データ | Firebase | LocalStorage | 状態 |
|-------|----------|--------------|------|
| タスク | ✅ | ❌ | 完全移行済み |
| プロジェクト | ✅ | ❌ | 完全移行済み |
| ユーザー情報 | ✅ | ⚠️ キャッシュ | 移行済み |
| currentSession | ❌ | ✅ | **要移行** |
| taskTemplates | ❌ | ✅ | **要移行** |
| kanbanColumns | ✅ | ⚠️ キャッシュ | **移行済み（2025-12-08）** |
| recurringTemplates | ❌ | ✅ | **要移行** |

**📝 kanbanColumns移行（2025-12-08完了）**:
- Firestore保存先: `users/{userId}/settings/columns`
- 初回ログイン時にLocalStorageからFirestoreへ自動マイグレーション
- `id: 'trash'`のtitleが「ゴミ箱」の場合は「アーカイブ」に自動変換
- LocalStorageはオフライン対応用キャッシュとして残存
- 変更関数: `saveColumnsToFirestore()`, `initColumnsFromFirestore()`

---

## 🔴 高優先度

### 2. タスク作成と移動が重い **(3-5時間)**
- ドラッグ&ドロップ時に `[Violation] 'drop' handler took 2574ms`
- 対応: Firebase保存の非同期化、楽観的UI更新

### ~~3. ヘッダー・サイドバーのUI整理~~ ✅ 対応済み（2025-12-08）

### ~~4. 新規タスク・複数選択ボタンの配置検討~~ ✅ 対応済み

### ~~5. はてなボタンの機能更新~~ ✅ 対応済み（2025-12-08）
- ヘルプモーダル実装（チュートリアル・機能一覧・FAQ）
- スポットライト式チュートリアル機能（基本操作・プロジェクト・応用機能）

### 13. プロジェクト作成時のカラム移動ボタン不具合 **(1時間)** 🆕
- 移動ボタンをクリックしてもドラッグ扱いになる
- 完了・アーカイブカラムの並び順変更ができない

### 14. プロジェクト一覧にタイムスタンプ表示 **(30分)** 🆕
- サイドパネルのプロジェクト一覧に作成日時を表示

### ~~15. OCR機能の削除~~ ✅ 対応済み（2025-12-08）
- 変更ログ: `error-logs/2025-12-08-ocr-feature-removal.md`

---

## 🔴 新規要件（2025-12-08追加）

### 16. ユーザーごとカラムカスタマイズ **(要検証・大規模)** 🆕

**設計書**: `design/user-column-customization-2025-12-08.md`

**概要**: 各ユーザーが自分専用のカラム構成を設定できるようにする

**実装優先順位**:
1. kanbanColumns を Firestore へ移行（#1の一部）
2. カラム位置変更機能（#13含む）
3. ユーザーごとカラムカスタマイズ
4. 「全員」表示時の特殊表示

#### 表示モード別の動作

| 表示モード | カラム構成 | 備考 |
|-----------|-----------|------|
| 自分のタスク | 自分のカラム設定 | 通常カンバン |
| 特定ユーザー | そのユーザーのカラム設定 | 通常カンバン |
| **全員** | 固定3カラム | 特殊表示 |

#### 「全員」表示時
- **未完了タスク一覧**: 完了・アーカイブ以外を全てまとめて表示
- **完了**: 全ユーザーの完了タスク
- **アーカイブ**: 全ユーザーのアーカイブタスク

#### カラム編集ルール

| カラム | 名前変更 | 削除 | 位置変更 |
|--------|----------|------|----------|
| 完了 | ❌ 禁止 | ❌ 禁止 | ⭕ 可能 |
| アーカイブ | ❌ 禁止 | ❌ 禁止 | ⭕ 可能 |
| その他 | ⭕ | ⭕ | ⭕ |

※ developerロールのみ完了・アーカイブも編集可能

#### 検証ポイント（実装前に確認必須）

1. **表示切り替え影響**
   - ユーザー切り替え時のカラム再描画
   - 異なるユーザーのカラム設定読み込み

2. **全員表示の未完了一覧**
   - 表示順ロジック（期限順？優先度順？）
   - 大量タスク時の縦長問題 → ページネーション/折りたたみ必要？

3. **ID整合性**
   - 位置変更でdone/trashのIDがバグらないか
   - プロジェクトカラムとの整合性

4. **データ保存**
   - Firestore: `users/{userId}/settings/kanbanColumns`
   - LocalStorage脱却との関連

5. **既存機能への影響**
   - 統計ロジック（isDoneColumn, isTrashColumn）
   - タスク移動処理
   - フィルター機能

#### 関連する既存課題
- #13 プロジェクトカラム位置変更ボタン不具合
- #1 LocalStorage完全脱却

---

## 🟡 中優先度

### 6. ユーザー追加時のセッション上書き問題 **(1時間)**

### 7. マイページの個人詳細統計 **(1時間)**

### ~~8. ダッシュボード統計ロジック確認~~ ✅ 対応済み

---

## 🎨 UI/UX Phase 2（最後の仕上げ）

### 9. カラムヘッダーにミニプログレスバー **(1-2時間)**
### 10. 統計サマリーのカード化 **(2時間)**
### 11. タスク作成時のアニメーション **(1時間)**
### 12. カラーテーマ切り替え **(2-3時間)**
- LocalStorage脱却後に実装

---

## 📋 延期・保留

### カラムシステム再設計
- **設計ドキュメント**: `design/column-system-redesign-2025-12-02.md`
- **状態**: 設計完了、実装延期
- **実装タイミング**:
  - カラム並び替え機能を実装する時
  - カラム名変更で統計が壊れる問題が発生した時
- **現状の保護**:
  - プロジェクトタスク: `isRequiredColumn()`でパターンマッチ保護
  - 通常タスク: `id === 'done' || id === 'trash'`で保護
- **📝 2025-12-08追記**: カラム名は自由に編集可能（パターンマッチで認識）

---

## 📊 作業時間見積もり

| 優先度 | 時間 |
|-------|------|
| 🔴🔴🔴 最優先（至上命題） | 3-5時間 |
| 🔴 高優先度 | 6.5-9時間 |
| 🟡 中優先度 | 2.5時間 |
| 🎨 UI/UX Phase 2 | 6-8時間 |
| **総合計** | **約12-18時間** |

---

## ⚠️ デプロイフロー

1. **開発環境でテスト**: `http://localhost:3000/index-kanban.html`
2. **ユーザーのGOを待つ**
3. **本番デプロイ**: `git push origin main`

---

## 📁 関連ファイル

- **本番URL**: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/index-kanban.html
- **開発URL**: http://localhost:3000/index-kanban.html
- **メインコード**: `sales-task-core/index-kanban.html`
- **Firebase設定**: `sales-task-core/firebase-config-auth-fix-20250819-132508.js`
- **カラム設計**: `design/column-system-redesign-2025-12-02.md`

---

## バージョン履歴

| バージョン | 日付 | 主な変更 |
|-----------|------|---------|
| v001-v003 | 11/19-20 | 初期要件定義 |
| v004 | 11/20 | 包括的要件定義（22項目） |
| v005 | 12/01 | UI/UX Phase 1完了 |
| v006 | 12/01-02 | ユーザーフィードバック反映、統計ロジック修正 |
| v007 | 12/04 | タスク増殖バグ修正、カラム保護強化、システム検証完了 |
| **v008** | **12-08** | **アーカイブ化、Kanban Work命名、UI整理、新規要件追加** |

---

**最終更新**: 2025-12-08 (セッション中更新)
**作成者**: Claude Code
**ステータス**: ✅ 最新版
