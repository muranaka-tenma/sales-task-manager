# 営業タスク管理システム - TODO一覧

**バージョン**: v006 - FINAL
**作成日**: 2025-12-01（最終版）
**最終更新**: 2025-12-04
**合計残作業時間**: 約12.25-18.75時間（2025-12-04更新 - タスク増殖バグ修正完了）

---

## ⚠️ 次回セッション開始時の必読事項

### 必ず確認すべきファイル
1. **このファイル（TODO-v006）** - ユーザーの指示を反映した正式版
2. **エラーログ（error-logs/）** - 過去のミスと再発防止策
   - `2025-12-04-project-task-duplication-fix.md` - プロジェクトタスク増殖バグ修正 🆕
   - `2025-12-04-wrong-dev-url-repeated-mistake.md` - 開発環境URL繰り返しミス 🆕
   - `2025-12-02-statistics-logic-column-detection-fix.md` - 統計ロジック修正14箇所
   - `2025-12-02-firestore-user-fields-inconsistency-verified-ok.md` - Firestoreフィールド不統一調査
   - `2025-12-01-requirement-misunderstanding-text-alignment.md` - 6回繰り返されても理解できなかった問題
   - `2025-12-01-css-not-applying-inline-style-override.md` - inline styleの詳細度問題
   - `2025-11-28-project-edit-member-removal.md` - カラム追加即時反映修正
   - `2025-11-28-clear-all-data-fix.md` - 全データ削除ボタン修正
   - `2025-11-21-mention-notification-fix.md` - メンション通知修正

### 参考資料（補助的）
- `REQUIREMENTS-VERIFICATION-2025-12-01.md` - 要件検証レポート（参考資料）
- `SUMMARY-2025-12-01.md` - セッションサマリー（参考資料）
- `handover/requirements/2025-12-01-ui-enhancement-phase1.md` - UI/UX Phase 1 完了報告

---

## ✅ 本日完了（2025-12-01）

### UI/UX 大規模改善プロジェクト - Phase 1 完了
- ✅ 絵文字完全削除・タイポグラフィ改善
- ✅ すべての要素の中央揃え統一
- ✅ 設定モーダルの最適化
- ✅ ボタンサイズの完全統一
- ✅ CSS詳細度の問題解決
- ✅ プロジェクト作成エラー修正
- ✅ カラムカウンター視認性向上
- ✅ UI視覚強化（グラデーション・シャドウ・アニメーション）

### 緊急バグ修正
- ✅ コメントメンション通知修正
- ✅ 全データ削除ボタン修正
- ✅ カラム追加即時反映修正

### コード検証で判明した完了済み要件
- ✅ **複数選択の削除機能** - 完全に実装済み（`bulkDeleteSelected()` 関数）
- ✅ **プロジェクト公開設定** - 完全に実装済み（`isPublic` プロパティ）

**関連ドキュメント**:
- `handover/requirements/2025-12-01-ui-enhancement-phase1.md`
- `REQUIREMENTS-VERIFICATION-2025-12-01.md`
- `error-logs/2025-12-01-requirement-misunderstanding-text-alignment.md`
- `error-logs/2025-12-01-css-not-applying-inline-style-override.md`

---

## ✅ 本日完了（2025-12-04）

### 緊急バグ修正
- ✅ **プロジェクトタスク増殖バグ修正** - `saveTask()`内で`saveTasks()`と`createTask()`が二重呼び出しされていた問題を修正
  - 修正ファイル: `firebase-config-auth-fix-20250819-132508.js`, `index-kanban.html`
  - 関連エラーログ: `error-logs/2025-12-04-project-task-duplication-fix.md`

---

## ✅ 完了（2025-12-02）

### 権限修正
- ✅ **加藤・朝日の管理者権限修正** - Line 2337, 2346, 2505-2506 を `'user'` → `'admin'` に変更完了

### 統計ロジック修正（2時間）
- ✅ **メイン画面の統計ロジック確認** - 「要調整」判定ロジックの調査と修正完了
- ✅ **統計ロジック全体修正** - 14箇所を修正
  - ゴミ箱除外追加: 4箇所（Line 6958, 10496, 13076, 13082）
  - プロジェクトタスク対応: 10箇所（`task.columnId === 'done'` → `isDoneColumn(task.columnId)`）
- ✅ **修正による効果**:
  - プロジェクトタスクの完了が全統計に反映される
  - ゴミ箱のタスクが未完了タスクにカウントされない
  - 負荷調整、期限切れ警告、停滞警告が正確になる

### カラムシステム設計
- ✅ **カラムID設計ドキュメント作成** - 一意のID + isDone/isTrash属性ベースの設計完了
- 📋 **実装は延期** - LocalStorage完全脱却プロジェクト完了後に実装予定

**関連ドキュメント**:
- `error-logs/2025-12-02-firestore-user-fields-inconsistency-verified-ok.md` - Firestoreフィールド不統一の調査（問題なし確認済み）
- `error-logs/2025-12-02-statistics-logic-column-detection-fix.md` - 統計ロジック修正の詳細ログ
- `design/column-system-redesign-2025-12-02.md` - カラムシステム再設計ドキュメント

---

## 🔴🔴🔴 最優先（至上命題）

### 1. LocalStorage完全脱却プロジェクト **(3-5時間)** ⚠️ **至上命題**

**ユーザーコメント**: 「至上命題です。超重要です。」

現在132箇所でLocalStorage使用中

| データ | Firebase | LocalStorage | 状態 |
|-------|----------|--------------|------|
| タスク | ✅ | ❌ | 完全移行済み |
| プロジェクト | ✅ | ❌ | 完全移行済み |
| ユーザー情報 | ✅ | ⚠️ キャッシュ | 移行済み |
| currentSession | ❌ | ✅ | **要移行** |
| taskTemplates | ❌ | ✅ | **要移行** |
| projectSettings | ❌ | ✅ | **要移行** |
| kanbanColumns | ❌ | ✅ | **要移行** |
| recurringTemplates | ❌ | ✅ | **要移行** |

**作業内容**:
1. currentSession の Firebase 移行（ユーザーごとに保存）
2. taskTemplates の Firebase 移行
3. projectSettings の Firebase 移行
4. kanbanColumns の Firebase 移行
5. recurringTemplates の Firebase 移行
6. LocalStorage への書き込みをすべて削除
7. テスト・動作確認

---

## 🔴 高優先度（パフォーマンス・UI改善）

### 2. タスク作成と移動が重い - リファクタリング必要 **(3-5時間)** ⚠️大きな山
- タスク作成時のレスポンスが遅い
- ドラッグ&ドロップ時に `[Violation] 'drop' handler took 2574ms`
- 対応: Firebase保存の非同期化、楽観的UI更新、デバウンス適用

### 3. ヘッダー・サイドバーのUI整理 **(1時間)** 🆕
**ユーザー要望**: 「ヘッダーのユーザー名を削除、サイドバーのユーザー情報を右上（ログアウト・マニュアル付近）に移動」

**現状の問題**:
- ヘッダー（営業タスク管理-Kanbanボード）横にユーザー名がある
- サイドバーにもユーザー情報がある
- カニバリ（重複）している

**対応**:
1. ヘッダーのユーザー名表示を削除
2. サイドバーのユーザー情報を右上（ログアウト、マニュアルボタン付近）に移動
3. デザインの統一とスペース効率化

### 4. 新規タスク・複数選択ボタンの配置検討 **(30分-1時間)**
**ユーザーコメント**: 「確かに要検討」

- 現在の配置の問題点を確認
- より使いやすい配置案を提示
- ユーザーと相談して決定

### 5. 右上のはてなボタンの機能更新 **(2時間)**
- 現在の機能に対応していないインフォメーション
- 将来的にマニュアル（使い方）を載せたい
- ヘルプシステムの設計が必要

---

## 🟡 中優先度（実装・調査タスク）

### 6. ユーザー追加時のセッション上書き問題 **(1時間)**
- ユーザー追加後、自動でそのユーザーにログインされてしまう
- ヘッダーは元のユーザー（邨中天真）のまま、マイページは追加したユーザーになる
- 対応: user-management.html:777 の `loadUsers()` がセッションを上書きしないよう修正

### 7. マイページの個人詳細統計 **(1時間)**
- 機能していない
- 所要時間集計の実現可能性調査

### 8. ダッシュボード統計ロジック確認 **(30分)**
- 完了タスク判別方法（✅ 2025-12-02に統計ロジック修正で対応済み、追加確認が必要かチェック）
- カラム名変更時の挙動（✅ 2025-12-02にカラムシステム設計完了、実装は延期）

---

## 🎨 UI/UX Phase 2（最後の仕上げ）

**ユーザーコメント**: 「最後の仕上げかな。」

### 10. カラムヘッダーにミニプログレスバー **(1-2時間)**
- 各カラムの完了率を視覚化

### 11. 統計サマリーのカード化 **(2時間)**
- グラデーションカード + プログレスバー

### 12. タスク作成時のアニメーション **(1時間)**
- fadeIn + slideDown アニメーション

### 13. カラーテーマ切り替え **(2-3時間)** 🎨
- LocalStorage使用、`.dark-theme` クラス切り替え
- **注意**: LocalStorage完全脱却後に実装

---

## ⚪ 完了済み

### 2025-12-02 完了
- ✅ **加藤・朝日の管理者権限修正** (15分)
- ✅ **Firestoreフィールド不統一調査** - 問題なし確認済み
- ✅ **メイン画面の統計ロジック確認** (2時間) - 14箇所修正
  - ゴミ箱除外追加（4箇所）
  - プロジェクトタスク対応（10箇所）
- ✅ **カラムシステム再設計** - 設計ドキュメント作成（実装は延期）

### 2025-12-01 完了
- ✅ **UI/UX Phase 1 完了**（絵文字削除、中央揃え、設定モーダル、ボタンサイズ、CSS詳細度問題、カラムカウンター、UI強化）
- ✅ **コメントメンション通知修正**
- ✅ **全データ削除ボタン修正**
- ✅ **カラム追加即時反映修正**
- ✅ **複数選択の削除機能** - コード検証で実装済み確認
- ✅ **プロジェクト公開設定** - コード検証で実装済み確認

### 2025-11-20 完了
- ✅ プロジェクトタスクのDONE/TRASH機能完全実装
- ✅ 完了・ゴミ箱への移動時アラート修正
- ✅ プロジェクト編集モーダルの×ボタン修正
- ✅ 完了カラムのタスクが期限切れで赤くなる問題を修正
- ✅ ゴミ箱の180日後自動削除機能をプロジェクトタスクにも対応
- ✅ プロジェクトタスク編集画面で管理IDを非表示
- ✅ 本番環境へデプロイ
- ✅ 包括的要件定義作成

### それ以前
- ✅ saveTasks データ消失バグ修正
- ✅ 非表示タスク機能実装
- ✅ モーダルスクロール位置リセット修正
- ✅ systemUsers初期化問題の根本解決
- ✅ Firebase認証時の日本語名取得修正
- ✅ E2Eテスト実装（Playwright）
- ✅ マイページ管理機能リンク削除
- ✅ パスワード変更機能確認
- ✅ 全データ削除機能の扱い提案（後回し決定）
- ✅ 本番環境ログイン問題の解決
- ✅ プロジェクトタスク作成モーダル統合
- ✅ 非表示タスクの自動チェック問題修正
- ✅ **ユーザー管理の非表示/無効化の違い説明** - おおむね解決
- ✅ **パスワードハードコード問題** - 解決済み
- ✅ **シークレットタスク実現可能性** - 非表示タスク機能で実現済み
- ✅ **期限日・優先度の必要性** - 解決済み
- ✅ **テンプレートカテゴリ必要性確認** - 解決済み

---

## 🗑️ 削除された要件（v005から削除）

**理由**: ユーザーフィードバックにより、以下の要件は既に解決済みまたは不要と判明

- ❌ systemUsersのname未定義問題 - 「何を言われているかわからない」（ユーザー認識なし）
- ❌ ユーザー管理の非表示/無効化の違い説明 - おおむね解決している
- ❌ パスワードハードコード問題の解決 - 完全に解決している
- ❌ シークレットタスク実現可能性 - 完全に解決している
- ❌ 期限日・優先度の必要性 - 完全に解決している
- ❌ テンプレートカテゴリ必要性確認 - 完全に解決している

---

## 📝 運用ルール

1. セッション終了時にこのファイルを更新
2. 大きな変更があった場合は新バージョン作成（例: `TODO-v007-2025-12-02.md`）
3. 「TODOを見せて」と言われたら、最も高いバージョン番号のファイルを読む
4. **要件定義は `handover/requirements/` に保存する**

### ⚠️ デプロイフロー（重要）

**必ず以下の順序を守ること：**

1. **開発環境でテスト** - `npm run test:local` でローカルテスト実行
2. **ユーザーのGOを待つ** - 本番デプロイ前に必ず承認を得る
3. **本番環境にデプロイ** - `git push` でNetlifyに自動デプロイ

**禁止事項：**
- ユーザー確認なしに本番環境を変更しない
- 開発環境でテストせずに本番デプロイしない

---

## 📁 関連ファイル

- **本番URL**: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/
- **メインコード**: `sales-task-core/index-kanban.html`
- **プロジェクト設定**: `sales-task-core/pj-settings.html`
- **Firebase設定**: `sales-task-core/firebase-config-auth-fix-20250819-132508.js`
- **セッション履歴**: `SESSION.md`
- **最新要件定義**: `handover/requirements/2025-12-01-ui-enhancement-phase1.md`
- **要件検証レポート**: `REQUIREMENTS-VERIFICATION-2025-12-01.md`
- **エラーログ**:
  - `error-logs/2025-12-01-requirement-misunderstanding-text-alignment.md`
  - `error-logs/2025-12-01-css-not-applying-inline-style-override.md`

---

## 🎯 次回セッション優先事項

### Phase 1: 至上命題（3-5時間）
1. **LocalStorage完全脱却プロジェクト**（3-5時間）⚠️ 最優先

### Phase 2: パフォーマンス改善（6.5-9時間）
1. **タスク作成・移動のリファクタリング**（3-5時間）
2. **ヘッダー・サイドバーのUI整理**（1時間）
3. **新規タスク・複数選択ボタンの配置検討**（30分-1時間）
4. **はてなボタンの機能更新**（2時間）

### Phase 3: バグ修正・調査（3.0時間）
1. **ユーザー追加時のセッション上書き問題**（1時間）
2. **メイン画面の統計ロジック確認**（30分）
3. **マイページの個人詳細統計**（1時間）
4. **ダッシュボード統計ロジック確認**（30分）

### Phase 4: UI/UX Phase 2（最後の仕上げ、6-8時間）
1. カラムヘッダーにミニプログレスバー（1-2時間）
2. 統計サマリーのカード化（2時間）
3. タスク作成時のアニメーション（1時間）
4. カラーテーマ切り替え（2-3時間）← LocalStorage脱却後に実装

---

## 📊 作業時間見積もり（総計）

- 🔴🔴🔴 最優先（至上命題）: 3-5時間
- 🔴 高優先度: 6.5-9時間
- 🟡 中優先度: 3.0時間（2025-12-02更新: 加藤・朝日の権限修正完了により-0.25時間）
- 🎨 UI/UX Phase 2（最後の仕上げ）: 6-8時間

**総合計**: 約12.75-19.25時間（2025-12-02更新）

**v005からの削減**: 約6項目削除、6-7時間削減
**v006からの進捗**: 1項目完了、0.25時間削減

---

## 🚨 重要な変更点（v005 → v006）

### 📝 ユーザーフィードバック（2025-12-01）

#### 1. 管理者権限について
**ユーザー**: 「加藤と朝日はもとより管理者権限です。」
- **現状**: Line 2505-2506 で `'user'` になっている
- **対応**: `'admin'` に修正が必要

#### 2. systemUsersのname未定義問題
**ユーザー**: 「何を言われているかわからない。」
- **結論**: この要件は削除（ユーザーが認識していない問題）

#### 3. ヘッダー・サイドバーのUI
**ユーザー**: 「営業タスク管理-Kanbanボードのヘッダー横にもユーザー名があってカニばっているから、ヘッダーの方は消して、サイドのユーザーは右上のログアウトとかマニュアルらへんに位置してもいいかな。」
- **対応**: 新規要件として追加（1時間）

#### 4. LocalStorage完全脱却
**ユーザー**: 「至上命題です。超重要です。」
- **対応**: 最優先に格上げ

#### 5. 新規タスク・複数選択ボタンの配置
**ユーザー**: 「確かに要検討。」
- **対応**: 要件として継続

#### 6. ユーザー管理の非表示/無効化
**ユーザー**: 「おおむね解決しているはず。」
- **対応**: 完了済みとして削除

#### 7. 低優先度項目
**ユーザー**: 「完全に解決している認識。」
- **対応**: 低優先度4項目をすべて削除

#### 8. UI/UX Phase 2
**ユーザー**: 「最後の仕上げかな。」
- **対応**: 優先度を下げる

---

### 優先度の大幅変更
1. **LocalStorage完全脱却**: 中優先度 → 🔴🔴🔴 最優先（至上命題）
2. **UI/UX Phase 2**: 中優先度 → 🎨 最後の仕上げ（優先度下げ）

### 新規追加
3. **ヘッダー・サイドバーのUI整理**（1時間）← ユーザー要望
4. **加藤・朝日の管理者権限修正**（15分）← ユーザー指摘

### 削除（合計6項目）
5. systemUsersのname未定義問題 ← ユーザー: 「何を言われているかわからない」
6. ユーザー管理の非表示/無効化の違い説明 ← ユーザー: 「おおむね解決」
7. パスワードハードコード問題 ← ユーザー: 「完全に解決」
8. シークレットタスク実現可能性 ← ユーザー: 「完全に解決」
9. 期限日・優先度の必要性 ← ユーザー: 「完全に解決」
10. テンプレートカテゴリ必要性確認 ← ユーザー: 「完全に解決」

### 完了済みとして追加（コード検証）
11. 複数選択の削除機能 ← `bulkDeleteSelected()` 関数が実装済み
12. プロジェクト公開設定 ← `isPublic` プロパティが実装済み

---

**最終更新**: 2025-12-01
**作成者**: Claude Code
**レビュー**: 邨中天真
**ステータス**: ✅ v006 FINAL - クリーンアップ完了

---

## 📌 重要な注意事項（次回セッション担当者へ）

### v00シリーズが正式版
- **TODO-v006-2025-12-01-FINAL.md** が正式版（ユーザーの指示を反映）
- SUMMARY や VERIFICATION レポートは参考資料
- **必ずエラーログを確認してから作業開始**

### エラーログの重要性
過去のミスと再発防止策が記録されている：
1. `2025-12-01-requirement-misunderstanding-text-alignment.md`
   - ユーザーが6回繰り返しても理解できなかった問題
   - 再発防止策: ユーザーが2回以上繰り返したら自分の理解が間違っている

2. `2025-12-01-css-not-applying-inline-style-override.md`
   - CSS詳細度の問題（inline style > CSS class）
   - 再発防止策: 動的生成要素は inline style を確認

3. その他のエラーログも必ず確認

### バージョン履歴
- v001-v003: 初期要件定義
- v004: 包括的要件定義（22項目）
- v005: UI/UX Phase 1 完了（24項目）
- **v006 (FINAL)**: ユーザーフィードバック反映、大幅クリーンアップ（14項目）

---

**このファイルが正式版です。次回セッションでは必ずこのファイルとエラーログを確認してください。**
