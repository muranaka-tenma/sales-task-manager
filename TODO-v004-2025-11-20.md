# 営業タスク管理システム - TODO一覧

**バージョン**: v004
**作成日**: 2025-11-20 17:15
**最終更新**: 2025-12-01（最優先3件完了）
**合計残作業時間**: 約14.5-19.5時間（3.5時間削減）

---

## 📝 新規発見問題（2025-11-20 追加）

### ✅ 最優先（緊急バグ）- 2025-12-01 完了

#### 1. ✅ コメントメンションの通知機能が正常動作しない **(2時間)** - 完了
- ~~メンションした全員がSlack内でメンションされていない~~
- ~~メンションしていないのに通知が行くことがある~~
- **修正完了**: 2025-12-01
- **修正内容**: メンションなしコメントは通知なし（メモ機能化）
- **関連ログ**: error-logs/2025-11-21-mention-notification-fix.md

#### 2. ✅ 全データ削除ボタンが機能しなくなっている **(30分)** - 完了
- ~~設定画面の全データ削除ボタンが動作しない~~
- ~~Firebase完全移行後のロジック要修正~~
- **修正完了**: 2025-12-01
- **修正内容**: clearAllData() 関数実装、二重確認機能追加
- **関連ログ**: error-logs/2025-11-28-clear-all-data-fix.md

#### 3. ✅ カラムの追加が即時反映されない **(1時間)** - 完了
- ~~プロジェクトカラム追加後、画面に即座に反映されない~~
- ~~リアルタイム更新ロジックの確認が必要~~
- **修正完了**: 2025-12-01
- **修正内容**: loadTasks() 追加、メンバー選択削除、モーダル即座クローズ、公開設定削除
- **関連ログ**: error-logs/2025-11-28-project-edit-member-removal.md

### 🔴 高優先度（パフォーマンス・UI改善）

#### 4. タスク作成と移動が重い - リファクタリング必要 **(3-5時間)** ⚠️大きな山
- タスク作成時のレスポンスが遅い
- ドラッグ&ドロップ時に `[Violation] 'drop' handler took 2574ms`
- 対応: Firebase保存の非同期化、楽観的UI更新、デバウンス適用

#### 5. 新規タスクと複数選択ボタンの配置を中央寄りに **(30分)**
- ボタンの配置が使いづらい
- CSSレイアウト調整

#### 6. 複数選択の削除機能の動作確認 **(1時間)**
- 複数選択での削除は完全に消えている？
- 削除とゴミ箱が機能混同していないか？
- 仕様の明確化と修正が必要

#### 7. 右上のはてなボタンの機能更新 **(2時間)**
- 現在の機能に対応していないインフォメーション
- 将来的にマニュアル（使い方）を載せたい
- ヘルプシステムの設計が必要

---

## 本日の完了作業（2025-11-20）

### ✅ プロジェクトタスクのDONE/TRASH機能完全実装
**コミット**: 57fd84c

#### 1. 完了・ゴミ箱への移動時アラートが出ない問題を修正
- `getColumnNameById()` 関数を追加（プロジェクトカラムID `pj_{projectId}_{index}` から実際のカラム名を取得）
- `isDoneColumn()` と `isTrashColumn()` ヘルパー関数を実装
- プロジェクトタスクでも通常タスクと同じ確認アラートが表示されるように修正
- **変更箇所**: index-kanban.html:3167-3226

#### 2. プロジェクト編集モーダルの×ボタン修正
- モーダルに `id='projectEditModal'` を付与
- `this.closest('div').remove()` から `document.getElementById('projectEditModal').remove()` に変更
- キャンセルボタンも同様に修正
- **変更箇所**: index-kanban.html:13355, 13377, 13426

#### 3. 完了カラムのタスクが期限切れで赤くなる問題を修正
- `isOverdue()` と `isToday()` 関数を修正
- 完了カラム・ゴミ箱カラムでは期限切れ判定をスキップ
- 3日停滞フラグも完了・ゴミ箱カラムでは除外
- **変更箇所**: index-kanban.html:3642-3658, 6662

#### 4. ゴミ箱の180日後自動削除機能をプロジェクトタスクにも対応
- `cleanupTrash()` 関数で `isTrashColumn()` を使用
- 通常タスクとプロジェクトタスク両方のゴミ箱を自動削除対象に
- **変更箇所**: index-kanban.html:12441, 12465

#### 5. プロジェクトタスク編集画面で管理IDを非表示
- モーダルタイトルから `${editingTask.projectId}` を削除
- ユーザーに不要な技術的情報を非表示化
- **変更前**: `👥 プロジェクトタスク編集: project_1763615181994`
- **変更後**: `👥 プロジェクトタスク編集`
- **変更箇所**: index-kanban.html:4431

#### 6. 本番環境へデプロイ完了
- APP_VERSION: `2025-11-20-v8-hide-management-id`
- GitHubへプッシュ完了
- Netlify自動デプロイ実行済み

#### 7. 引継ぎ書作成・プッシュ完了
- TODO-v003作成
- 包括的要件定義作成（2025-11-20-comprehensive-requirements.md）

---

## 🔴 継続高優先度（既存要件）

### 2. LocalStorage完全脱却プロジェクト **(3-5時間)** ⚠️超大きな山

現在132箇所でLocalStorage使用中

| データ | Firebase | LocalStorage | 状態 |
|-------|----------|--------------|------|
| タスク | ✅ | ❌ | 完全移行済み |
| プロジェクト | ✅ | ❌ | 完全移行済み |
| ユーザー情報 | ✅ | ⚠️ キャッシュ | 移行済み |
| currentSession | ❌ | ✅ | **要移行** |
| taskTemplates | ❌ | ✅ | **要移行** |
| projectSettings | ❌ | ✅ | **要移行** |
| kanbanColumns | ❌ | ✅ | **要移行** |
| recurringTemplates | ❌ | ✅ | **要移行** |

---

## 🟡 中優先度（実装・調査タスク）

### 3. ユーザー追加時のセッション上書き問題 **(1時間)**
- 症状: ユーザー追加後、自動でそのユーザーにログインされてしまう
- ヘッダーは元のユーザー（邨中天真）のまま、マイページは追加したユーザーになる
- この状態で非表示タスクをチェックすると誰も選択されない
- 対応: createUser処理でセッションを上書きしないよう修正
- 関連ファイル: `user-management.html`の745行目付近

### 4. systemUsersのname未定義問題 **(30分)**
- 一部ユーザーのnameがundefined

### 5. プロジェクト公開設定の実装 **(30分)**
- 機能の動作確認
- 実装方法の調査

### 6. 管理者ダッシュボードのアクセス権限拡大 **(20分)**
- 加藤・朝日（admin権限）にもダッシュボード表示

### 7. メイン画面の統計ロジック確認 **(30分)**
- 「要調整」の判定ロジック調査

### 8. マイページの個人詳細統計 **(1時間)**
- 機能していない
- 所要時間集計の実現可能性調査

### 9. ダッシュボード統計ロジック確認 **(30分)**
- 完了タスク判別方法
- カラム名変更時の挙動

### 10. ユーザー管理の非表示/無効化の違い説明 **(20分)**

---

## 🟢 低優先度（調査・意見提示）

### 11. パスワードハードコード問題の解決 **(検討中)**
- login.htmlからパスワードを削除するか判断

### 12. シークレットタスク実現可能性 **(30分)**
- 非表示タスク機能は実装済み

### 13. 期限日・優先度の必要性 **(20分)**

### 14. テンプレートカテゴリ必要性確認 **(15分)**

---

## ⚪ 完了済み

- ✅ saveTasks データ消失バグ修正（コミット: 5f2f1dd）
- ✅ 非表示タスク機能実装
- ✅ モーダルスクロール位置リセット修正
- ✅ systemUsers初期化問題の根本解決
- ✅ Firebase認証時の日本語名取得修正
- ✅ E2Eテスト実装（Playwright）
- ✅ マイページ管理機能リンク削除
- ✅ パスワード変更機能確認
- ✅ 全データ削除機能の扱い提案（後回し決定）
- ✅ 本番環境ログイン問題の解決
- ✅ プロジェクトタスク作成モーダル統合（2025-11-19）
- ✅ 非表示タスクの自動チェック問題修正（2025-11-19）
- ✅ **完了・ゴミ箱への移動時アラートが出ない問題を修正**（2025-11-20）
- ✅ **プロジェクト編集モーダルの×ボタン修正**（2025-11-20）
- ✅ **完了カラムのタスクが期限切れで赤くなる問題を修正**（2025-11-20）
- ✅ **ゴミ箱の180日後自動削除機能をプロジェクトタスクにも対応**（2025-11-20）
- ✅ **プロジェクトタスク編集画面で管理IDを非表示**（2025-11-20）
- ✅ **本番環境へデプロイ**（2025-11-20）
- ✅ **包括的要件定義作成**（2025-11-20）

---

## 📝 運用ルール

1. セッション終了時にこのファイルを更新
2. 大きな変更があった場合は新バージョン作成（例: `TODO-v005-2025-11-21.md`）
3. 「TODOを見せて」と言われたら、最も高いバージョン番号のファイルを読む
4. **要件定義は `handover/requirements/` に保存する**

### ⚠️ デプロイフロー（重要）

**必ず以下の順序を守ること：**

1. **開発環境でテスト** - `npm run test:local` でローカルテスト実行
2. **ユーザーのGOを待つ** - 本番デプロイ前に必ず承認を得る
3. **本番環境にデプロイ** - `git push` でNetlifyに自動デプロイ

**禁止事項：**
- ユーザー確認なしに本番環境を変更しない
- 開発環境でテストせずに本番デプロイしない

---

## 📁 関連ファイル

- **本番URL**: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/
- **メインコード**: `sales-task-core/index-kanban.html`
- **プロジェクト設定**: `sales-task-core/pj-settings.html`
- **Firebase設定**: `sales-task-core/firebase-config-auth-fix-20250819-132508.js`
- **セッション履歴**: `SESSION.md`
- **要件定義**: `handover/requirements/2025-11-20-comprehensive-requirements.md`
- **前バージョンの要件**: `handover/requirements/2025-11-10-new-requirements.md`

---

## 🔧 本日の技術的な変更詳細（2025-11-20）

### 追加した関数
1. `getColumnNameById()` - プロジェクトカラムIDから実際のカラム名を取得（行3167-3194）
2. `isDoneColumn()` - カラムが完了カラムかどうかを判定（行3197-3210）
3. `isTrashColumn()` - カラムがゴミ箱カラムかどうかを判定（行3213-3226）

### 修正した関数
1. `isOverdue()` - 完了・ゴミ箱カラムでは期限切れ判定しない（行3642-3648）
2. `isToday()` - 完了・ゴミ箱カラムでは本日期限判定しない（行3650-3658）
3. `cleanupTrash()` - プロジェクトタスクのゴミ箱も自動削除対象に（行12441, 12465）
4. プロジェクトタスク編集モーダルタイトル - 管理ID非表示（行4431）

### 重要な実装パターン
- **プロジェクトカラムID形式**: `pj_{projectId}_{index}`
- **カラム名パターンマッチング**:
  - 完了: `/完了|done|完成/i`
  - ゴミ箱: `/ゴミ箱|trash|削除/i`
- **通常タスクとプロジェクトタスクの統一的な扱い**: ヘルパー関数で両方に対応

### APP_VERSION履歴
- v5: delete-button-fix
- v6: alert-and-modal-fix
- v7: trash-cleanup-fix
- v8: hide-management-id（現在）

---

## 🎯 次回セッション優先事項

1. **緊急バグ修正（3.5時間）**
   - コメントメンション通知修正
   - 全データ削除ボタン修正
   - カラム追加即時反映修正

2. **パフォーマンス改善（6.5-8.5時間）**
   - タスク作成・移動のリファクタリング
   - UI配置調整
   - 複数選択削除機能
   - はてなボタン更新

3. **LocalStorage脱却プロジェクト（3-5時間）**

---

## 📊 作業時間見積もり（総計）

- 🔴🔴🔴 最優先: 3.5時間
- 🔴 高優先度: 6.5-8.5時間
- 🟡 中優先度: 7.5-9.5時間
- 🟢 低優先度: 1.5時間

**総合計**: 約18-23時間

---

**最終更新**: 2025-11-20 17:15 JST
