# エラーログ: ユーザー名不一致によるタスク・カラム表示問題

**発生日**: 2025-12-15
**重要度**: 高
**ステータス**: 修正完了

---

## 問題の概要

ログイン時の自動表示対象設定で「苗字のみ」を使用したため、「フルネーム」で登録されているタスク担当者と一致せず、タスクが表示されない問題が発生。

## 発生した問題一覧

### 1. ログイン時にタスクが表示されない
- **現象**: 朝日でログイン → 表示対象「朝日」→ タスク0件
- **原因**: タスクの担当者は「朝日圭一」で登録されている
- **期待動作**: 表示対象「朝日圭一」→ タスク表示

### 2. カラム追加が即座に反映されない
- **現象**: カラム追加後、画面更新しないと表示されない
- **原因**: 表示対象の名前（苗字）とFirestoreパスの不整合

### 3. ログインし直すとカラム追加が消える
- **現象**: カラム追加 → ログアウト → ログイン → カラムがない
- **原因**: 苗字「朝日」でFirestore保存 → フルネーム「朝日圭一」で取得しようとして見つからない

### 4. 苗字/フルネームで動作が異なる
- **現象**: 苗字表示だとカラム変更即反映、フルネームだと画面更新必要
- **原因**: 名前の不一致による状態管理の混乱

## 根本原因

`firebase-config-auth-fix-20250819-132508.js` の `nameMap` で苗字のみを設定していた：

```javascript
const nameMap = {
    'asahi-keiichi@terracom.co.jp': '朝日',  // ❌ 苗字のみ
    // ...
};
```

タスクの担当者フィールドはフルネーム（「朝日圭一」）で登録されているため不一致。

## 修正内容

ハードコードの`nameMap`を削除し、Firestoreから取得した`systemUsers`を使用：

```javascript
// 🔥 Firestoreから取得したsystemUsersを使用（ハードコードしない）
const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
const matchedUser = systemUsers.find(u =>
    u.email && u.email.trim().toLowerCase() === targetEmail
);
displayName = matchedUser.name || matchedUser.displayName;
```

## 修正対象ファイル

- `sales-task-core/firebase-config-auth-fix-20250819-132508.js` (128-136行目)

## 再発防止策

1. ユーザー名は必ずFirestoreの`users`コレクションから取得する
2. ハードコードの名前マッピングは`users`コレクションと同期を取る
3. 名前の形式（苗字のみ/フルネーム）を統一する

## テスト項目

- [ ] ログイン時に自分のタスクが表示される
- [ ] カラム追加が即座に反映される
- [ ] ログインし直してもカラムが保持される
- [ ] 他ユーザーの表示切替が正常動作

---

**作成者**: Claude Code
**最終更新**: 2025-12-15
