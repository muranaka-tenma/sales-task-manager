# エラーログ: 2025-12-15 セッション - 連続障害

**発生日**: 2025-12-15
**重要度**: 最高
**ステータス**: 一部未解決

---

## 本日発生した問題一覧

### 1. ユーザー名ハードコード問題
- **現象**: ログイン時の表示対象が苗字のみで、フルネームのタスクとマッチしない
- **原因**: `nameMap`で苗字のみをハードコード
- **修正**: Firestoreの`systemUsers`から取得するように変更
- **ステータス**: ✅ 解決済み

### 2. カラム移動権限がdeveloperのみ
- **現象**: 橋本さんがカラムの移動ができない
- **原因**: `canMoveColumn = currentUser.role === 'developer'`
- **修正**: `canMoveColumn = true`に変更
- **ステータス**: ✅ 解決済み

### 3. 設定画面のカラムドラッグ&ドロップが動作しない
- **現象**: ドラッグ開始直後にドラッグ終了になる
- **原因**: inline event handler（ondragstart等）がモーダル内で正常動作しない
- **修正**: マウスイベント（mousedown/mousemove/mouseup）方式に変更
- **ステータス**: ✅ 解決済み

### 4. カラム追加入力フィールドが半分になった
- **現象**: 入力フィールドの幅が半分になった
- **原因**: `addColumnSection.style.display = 'block'`で`flex`が失われた
- **修正**: `display = 'flex'`に修正
- **ステータス**: ✅ 解決済み

### 5. 🔴 タスクカードのドラッグ&ドロップが動作しなくなった
- **現象**: タスクをドラッグしようとすると即座にドラッグ終了になる
- **原因**: カラム管理用のdocument.addEventListener('mouseup')が毎回追加され、タスクのHTML5 Drag APIと干渉
- **修正試行**:
  - イベントリスナーの一度だけ登録（`*ListenersInitialized`フラグ）
  - `e.stopPropagation()`追加
- **ステータス**: ❌ 未解決（修正後の確認待ち）

---

## 未解決・ユーザー未確認の問題

### 1. タスクカードのドラッグ&ドロップ
- 修正コードは適用済みだが、動作確認待ち

### 2. プロジェクト選択時の表示対象変更
- 要件: プロジェクト名のみ表示、フィルター変更不可
- 実装途中で中断

### 3. ログインし直すとカラム追加が消える問題
- TODO-v011に記載済み
- 未調査

### 4. LocalStorage完全脱却
- TODO-v011に記載済み
- 未着手

---

## 根本原因分析

### なぜ連続して既存機能が壊れたか

1. **影響範囲の確認不足**
   - カラム管理のドラッグ機能追加時、既存のタスクドラッグへの影響を考慮しなかった
   - `document.addEventListener`がグローバルに影響することを軽視

2. **段階的テストの欠如**
   - 一度に複数の変更を行い、各変更後の動作確認をしなかった
   - 「設定画面のカラムドラッグ」を修正しようとして「タスクのドラッグ」を壊した

3. **CSSプロパティの理解不足**
   - `display: block`が`flex`レイアウトを破壊することを考慮しなかった

---

## 再発防止策

1. **変更前に影響範囲を明示**
   - どの機能に影響するか事前にリストアップ
   - 特にグローバルイベントリスナー追加時は注意

2. **各変更後に基本動作テスト**
   - タスクのドラッグ&ドロップ
   - カラム操作
   - フィルター機能

3. **既存コードの動作原理を理解してから変更**
   - HTML5 Drag & Drop APIとマウスイベントの違い
   - CSSのdisplayプロパティの影響

---

## 修正対象ファイル

- `/home/muranaka-tenma/sales-task-manager/sales-task-core/index-kanban.html`
- `/home/muranaka-tenma/sales-task-manager/sales-task-core/firebase-config-auth-fix-20250819-132508.js`

---

**作成者**: Claude Code
**最終更新**: 2025-12-15
