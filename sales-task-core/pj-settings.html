<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ»ç®¡ç† - Kanban Work</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            color: #026aa7;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #026aa7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #025aa0;
        }
        
        .btn-secondary {
            background: #e4e6eb;
            color: #172b4d;
        }
        
        .btn-secondary:hover {
            background: #d1d3d8;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e4e6eb;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .project-list {
            display: grid;
            gap: 1rem;
        }
        
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #026aa7;
        }
        
        .project-info h3 {
            margin: 0 0 0.5rem 0;
            color: #026aa7;
        }
        
        .project-meta {
            font-size: 0.9rem;
            color: #666;
        }
        
        .project-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #f57c00;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .columns-container {
            display: grid;
            gap: 0.5rem;
        }
        
        .column-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e4e6eb;
        }
        
        .column-drag-handle {
            cursor: move;
            color: #666;
        }
        
        .column-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.25rem;
        }
        
        .column-input:focus {
            outline: none;
            background: white;
            border: 1px solid #026aa7;
            border-radius: 3px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            margin: 0;
            color: #026aa7;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state .emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .project-item {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .project-actions {
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ»ç®¡ç†</h1>
            <div>
                <button class="btn btn-primary" onclick="openCreateModal()">
                    â• æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                </button>
                <a href="index-kanban.html" class="btn btn-secondary">
                    â¬…ï¸ æˆ»ã‚‹
                </a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
                <span id="project-count">0 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
            </div>
            <div class="card-body">
                <div id="project-list" class="project-list">
                    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                </div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div class="emoji">ğŸ“‚</div>
                    <p>ã¾ã ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <p>ã€Œæ–°è¦PJä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PJä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">æ–°è¦PJä½œæˆ</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="project-form">
                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¯è‡ªå‹•ç”Ÿæˆï¼ˆproject_TIMESTAMPï¼‰ã®ãŸã‚å…¥åŠ›ä¸è¦ -->

                <div class="form-group">
                    <label class="form-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå *</label>
                    <input type="text" id="project-name" class="form-input" required placeholder="ä¾‹: æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥PJ">
                </div>
                
                <div class="form-group">
                    <label class="form-label">èª¬æ˜</label>
                    <textarea id="project-description" class="form-textarea" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦ã‚„ç›®çš„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ¼</label>
                    <div id="color-selector" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" class="color-btn" data-color="#0097A7" style="width: 36px; height: 36px; background: #0097A7; border: 3px solid transparent; border-radius: 6px; cursor: pointer;" onclick="selectProjectColor('#0097A7')" title="TERRA"></button>
                        <button type="button" class="color-btn" data-color="#3b82f6" style="width: 36px; height: 36px; background: #3b82f6; border: 3px solid transparent; border-radius: 6px; cursor: pointer;" onclick="selectProjectColor('#3b82f6')" title="Blue"></button>
                        <button type="button" class="color-btn" data-color="#10b981" style="width: 36px; height: 36px; background: #10b981; border: 3px solid transparent; border-radius: 6px; cursor: pointer;" onclick="selectProjectColor('#10b981')" title="Green"></button>
                        <button type="button" class="color-btn" data-color="#f59e0b" style="width: 36px; height: 36px; background: #f59e0b; border: 3px solid transparent; border-radius: 6px; cursor: pointer;" onclick="selectProjectColor('#f59e0b')" title="Orange"></button>
                        <button type="button" class="color-btn" data-color="#ef4444" style="width: 36px; height: 36px; background: #ef4444; border: 3px solid transparent; border-radius: 6px; cursor: pointer;" onclick="selectProjectColor('#ef4444')" title="Red"></button>
                        <button type="button" class="color-btn" data-color="#8b5cf6" style="width: 36px; height: 36px; background: #8b5cf6; border: 3px solid transparent; border-radius: 6px; cursor: pointer;" onclick="selectProjectColor('#8b5cf6')" title="Purple"></button>
                        <button type="button" class="color-btn" data-color="#ec4899" style="width: 36px; height: 36px; background: #ec4899; border: 3px solid transparent; border-radius: 6px; cursor: pointer;" onclick="selectProjectColor('#ec4899')" title="Pink"></button>
                        <button type="button" class="color-btn" data-color="#6b7280" style="width: 36px; height: 36px; background: #6b7280; border: 3px solid transparent; border-radius: 6px; cursor: pointer;" onclick="selectProjectColor('#6b7280')" title="Gray"></button>
                    </div>
                    <input type="hidden" id="project-color" value="#0097A7">
                </div>

                <div class="form-group">
                    <label class="form-label">ã‚«ãƒ©ãƒ è¨­å®š</label>
                    <div id="columns-container" class="columns-container">
                        <!-- ã‚«ãƒ©ãƒ ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addColumn()" style="margin-top: 0.5rem;">
                        â• ã‚«ãƒ©ãƒ è¿½åŠ 
                    </button>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-success" id="save-project-btn">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ğŸ”¥ Firebaseè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <script type="module" src="./firebase-config-auth-fix-20250819-132508.js"></script>

    <script>
        // ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
        let currentEditingProjectId = null;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ è¨­å®š
        const DEFAULT_COLUMNS = ["ğŸ“‹ TODO", "ğŸ”„ é€²è¡Œä¸­", "âœ… å®Œäº†", "ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–"];

        // ğŸ”’ ã€å¿…é ˆã‚«ãƒ©ãƒ ã€‘å®Œäº†ã¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¯å‰Šé™¤ä¸å¯ï¼ˆDONE/ARCHIVEã¨ã—ã¦æ©Ÿèƒ½ï¼‰
        const REQUIRED_COLUMNS = {
            done: { pattern: /å®Œäº†|done|å®Œæˆ/i, default: "âœ… å®Œäº†" },
            trash: { pattern: /ã‚´ãƒŸç®±|trash|å‰Šé™¤|ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–|archive/i, default: "ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–" }
        };

        // ã‚«ãƒ©ãƒ ãŒå¿…é ˆã‚«ãƒ©ãƒ ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isRequiredColumn(columnName) {
            return REQUIRED_COLUMNS.done.pattern.test(columnName) ||
                   REQUIRED_COLUMNS.trash.pattern.test(columnName);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ¼é¸æŠï¼ˆè¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä»˜ãï¼‰
        function selectProjectColor(color) {
            // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
            document.getElementById('project-color').value = color;

            // å…¨ã¦ã®ã‚«ãƒ©ãƒ¼ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
            document.querySelectorAll('#color-selector .color-btn').forEach(btn => {
                btn.style.border = '3px solid transparent';
                btn.style.boxShadow = 'none';
            });

            // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const selectedBtn = document.querySelector(`#color-selector .color-btn[data-color="${color}"]`);
            if (selectedBtn) {
                selectedBtn.style.border = '3px solid #333';
                selectedBtn.style.boxShadow = '0 0 8px rgba(0,0,0,0.3)';
            }

            console.log('ğŸ¨ [COLOR] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ¼é¸æŠ:', color);
        }

        // ğŸ”¥ getProjectSettings()ã¨saveProjectSettings()ã¯å‰Šé™¤ï¼ˆFirebaseåŒ–ã«ã‚ˆã‚Šä¸è¦ï¼‰
        // ğŸ”¥ validateProjectId()é–¢æ•°ã¯å‰Šé™¤ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—IDã¯æ¤œè¨¼ä¸è¦ï¼‰

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        function getCurrentUser() {
            try {
                const user = localStorage.getItem('currentUser');
                console.log('ğŸ” [USER] Raw localStorage data:', user);
                
                if (!user) {
                    console.log('âš ï¸ [USER] No currentUser in localStorage, creating developer session');
                    // â˜…â˜…â˜… localStorageãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸå ´åˆã¯developerã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ â˜…â˜…â˜…
                    const defaultUser = { name: 'é‚¨ä¸­å¤©çœŸ', role: 'developer', isLoggedIn: true };
                    localStorage.setItem('currentUser', JSON.stringify(defaultUser));
                    return defaultUser;
                }
                
                // ãƒ‡ãƒ¼ã‚¿ãŒæ–‡å­—åŒ–ã‘ã—ã¦ã„ã‚‹å ´åˆã®ç‰¹åˆ¥å‡¦ç†
                if (user === '"é‚¨ä¸­å¤©çœŸ"' || user.includes('é‚¨ä¸­å¤©çœŸ')) {
                    console.log('ğŸ”§ [USER] Detected corrupted data, clearing and using fallback');
                    localStorage.removeItem('currentUser');
                    return { name: 'é‚¨ä¸­å¤©çœŸ', role: 'developer', isLoggedIn: true };
                }
                
                const parsed = JSON.parse(user);
                console.log('âœ… [USER] User loaded:', parsed);
                return parsed;
            } catch (error) {
                console.error('âŒ [USER] JSON parse error, clearing corrupted data:', error);
                console.log('ğŸ”§ [USER] Raw data that failed to parse:', localStorage.getItem('currentUser'));
                localStorage.removeItem('currentUser');
                
                // æ–‡å­—åŒ–ã‘ã—ãŸåå‰ã‚’ä½¿ã£ã¦å¾©æ—§
                return { name: 'é‚¨ä¸­å¤©çœŸ', role: 'developer', isLoggedIn: true };
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®è¡¨ç¤º
        async function loadProjects(forceRefresh = false) {
            if (!window.FirebaseDB) {
                console.error('âŒ [LOAD PROJECTS] Firebaseæœªæ¥ç¶š');
                return;
            }

            const result = await window.FirebaseDB.getProjects(forceRefresh);
            if (!result.success) {
                console.error('âŒ [LOAD PROJECTS] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—å¤±æ•—:', result.error);
                return;
            }

            const projects = result.projects;
            const projectList = document.getElementById('project-list');
            const emptyState = document.getElementById('empty-state');
            const projectCount = document.getElementById('project-count');

            projectCount.textContent = `${projects.length} ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ`;

            if (projects.length === 0) {
                projectList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            projectList.style.display = 'block';
            emptyState.style.display = 'none';

            // ã‚¿ã‚¹ã‚¯æ•°ã‚’å–å¾—ï¼ˆFirebaseå¯¾å¿œï¼‰
            const tasksResult = await window.FirebaseDB.getTasks();
            const tasks = tasksResult.success ? tasksResult.tasks : [];
            const currentUser = getCurrentUser();
            const canDelete = currentUser.role !== 'user';

            console.log('ğŸ” [DELETE BUTTONS] Global check - User:', currentUser.name, 'Role:', currentUser.role, 'CanDelete:', canDelete);
            console.log('ğŸ” [DELETE BUTTONS] Projects to process:', projects.length);

            projectList.innerHTML = projects.map(project => {
                const createdDate = new Date(project.createdAt).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                // ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯æ•°ã‚’å–å¾—
                const projectTasks = tasks.filter(task => task.projectId === project.id);

                console.log(`ğŸ” [DELETE BUTTON] Project ${project.id}: canDelete=${canDelete}`);

                const projectHTML = `
                    <div class="project-item">
                        <div class="project-info">
                            <h3>${project.name}</h3>
                            <div class="project-meta">
                                ğŸ“… ä½œæˆæ—¥: ${createdDate} | ğŸ‘¤ ä½œæˆè€…: ${project.createdBy} | ğŸ“Š ã‚¿ã‚¹ã‚¯æ•°: ${projectTasks.length}ä»¶
                                <br>ğŸ“ ${project.description || 'èª¬æ˜ãªã—'}
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-secondary" onclick="editProject('${project.id}')">
                                âœï¸ ç·¨é›†
                            </button>
                            ${canDelete ? `
                                <button class="btn btn-danger" onclick="deleteProject('${project.id}')">
                                    ğŸ—‘ï¸ å‰Šé™¤
                                </button>
                            ` : '<!-- å‰Šé™¤æ¨©é™ãªã— -->'}
                        </div>
                    </div>
                `;

                console.log(`ğŸ” [HTML] Project ${project.id} HTML contains delete button:`, projectHTML.includes('ğŸ—‘ï¸ å‰Šé™¤'));
                return projectHTML;
            }).join('');
        }
        
        // PJä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openCreateModal() {
            console.log('ğŸ” [CREATE MODAL] Opening create modal');
            currentEditingProjectId = null;
            document.getElementById('modal-title').textContent = 'æ–°è¦PJä½œæˆ';
            // ğŸ”¥ project-idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‰Šé™¤æ¸ˆã¿
            document.getElementById('project-name').value = '';
            document.getElementById('project-description').value = '';
            loadDefaultColumns();
            // ã‚«ãƒ©ãƒ¼é¸æŠã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆTERRAï¼‰ã«ãƒªã‚»ãƒƒãƒˆ
            selectProjectColor('#0097A7');
            document.getElementById('project-modal').classList.add('active');
            console.log('ğŸ” [CREATE MODAL] Modal should be visible now');
        }
        
        // PJç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆFirebaseå¯¾å¿œï¼‰
        async function editProject(projectId) {
            if (!window.FirebaseDB) {
                console.error('âŒ [EDIT PROJECT] Firebaseæœªæ¥ç¶š');
                return;
            }

            const result = await window.FirebaseDB.getProjects();
            if (!result.success) {
                console.error('âŒ [EDIT PROJECT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—å¤±æ•—:', result.error);
                return;
            }

            const project = result.projects.find(p => p.id === projectId);
            if (!project) {
                console.error('âŒ [EDIT PROJECT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', projectId);
                return;
            }

            currentEditingProjectId = projectId;
            document.getElementById('modal-title').textContent = 'PJç·¨é›†';
            // ğŸ”¥ project-idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆIDã¯è‡ªå‹•ç”Ÿæˆã®ãŸã‚è¡¨ç¤ºãƒ»ç·¨é›†ä¸è¦ï¼‰
            document.getElementById('project-name').value = project.name;
            document.getElementById('project-description').value = project.description || '';
            loadColumns(project.columns);
            // æ—¢å­˜ã®ã‚«ãƒ©ãƒ¼ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
            selectProjectColor(project.color || '#0097A7');
            document.getElementById('project-modal').classList.add('active');
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('project-modal').classList.remove('active');
            currentEditingProjectId = null;
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã‚€
        function loadDefaultColumns() {
            loadColumns(DEFAULT_COLUMNS);
        }
        
        // ã‚«ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã‚€
        function loadColumns(columns) {
            console.log('ğŸ¨ [LOAD-COLUMNS] ã‚«ãƒ©ãƒ èª­ã¿è¾¼ã¿é–‹å§‹:', columns);
            const container = document.getElementById('columns-container');
            container.innerHTML = columns.map((column, index) => {
                const isRequired = isRequiredColumn(column);
                console.log(`ğŸ¨ [LOAD-COLUMNS] ã‚«ãƒ©ãƒ  ${index}: "${column}" - å¿…é ˆ=${isRequired}`);
                return `
                    <div class="column-item" data-index="${index}">
                        <span class="column-drag-handle">â‹®â‹®</span>
                        <input type="text" class="column-input" value="${column}" onchange="updateColumn(${index}, this.value)" ${isRequired ? 'readonly' : ''}>
                        ${isRequired ?
                            `<span style="color: #666; font-size: 0.8rem; padding: 0.25rem;">ğŸ”’ å¿…é ˆ</span>` :
                            `<button type="button" class="btn btn-danger" onclick="removeColumn(${index})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">âœ•</button>`
                        }
                    </div>
                `;
            }).join('');
            console.log('âœ… [LOAD-COLUMNS] ã‚«ãƒ©ãƒ èª­ã¿è¾¼ã¿å®Œäº†');
        }
        
        // ã‚«ãƒ©ãƒ è¿½åŠ 
        function addColumn() {
            const container = document.getElementById('columns-container');
            const currentColumns = getCurrentColumns();
            currentColumns.push('æ–°ã—ã„ã‚«ãƒ©ãƒ ');
            loadColumns(currentColumns);
        }
        
        // ã‚«ãƒ©ãƒ å‰Šé™¤
        function removeColumn(index) {
            const currentColumns = getCurrentColumns();
            if (currentColumns.length <= 1) {
                alert('æœ€ä½1ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                return;
            }

            // ğŸ”’ å¿…é ˆã‚«ãƒ©ãƒ ã¯å‰Šé™¤ä¸å¯
            const columnToRemove = currentColumns[index];
            if (isRequiredColumn(columnToRemove)) {
                alert('ã€Œå®Œäº†ã€ã¨ã€Œã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã€ã‚«ãƒ©ãƒ ã¯å¿…é ˆã®ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚\n\nã“ã‚Œã‚‰ã®ã‚«ãƒ©ãƒ ã¯DONE/ARCHIVEã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚');
                return;
            }

            currentColumns.splice(index, 1);
            loadColumns(currentColumns);
        }
        
        // ã‚«ãƒ©ãƒ æ›´æ–°
        function updateColumn(index, value) {
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€ç‰¹åˆ¥ãªå‡¦ç†ã¯ä¸è¦
        }
        
        // ç¾åœ¨ã®ã‚«ãƒ©ãƒ è¨­å®šã‚’å–å¾—
        function getCurrentColumns() {
            const inputs = document.querySelectorAll('.column-input');
            return Array.from(inputs).map(input => input.value.trim()).filter(val => val);
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜ï¼ˆFirebaseå¯¾å¿œï¼‰
        async function saveProject(event) {
            console.log('ğŸ” [PJ SAVE] Function called');
            event.preventDefault();

            // ğŸ”¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¯è‡ªå‹•ç”Ÿæˆï¼ˆç·¨é›†æ™‚ã¯æ—¢å­˜IDã€æ–°è¦æ™‚ã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
            const projectId = currentEditingProjectId || `project_${Date.now()}`;
            const name = document.getElementById('project-name').value.trim();
            const description = document.getElementById('project-description').value.trim();
            const columns = getCurrentColumns();

            console.log('ğŸ” [PJ SAVE] Form values:', { projectId, name, description, columns });

            if (!name) {
                console.error('âŒ [PJ SAVE] Project name is empty');
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (columns.length === 0) {
                console.error('âŒ [PJ SAVE] No columns provided');
                alert('æœ€ä½1ã¤ã®ã‚«ãƒ©ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }

            // ğŸ”’ ã€å¿…é ˆã‚«ãƒ©ãƒ è‡ªå‹•è¿½åŠ ã€‘å®Œäº†ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚«ãƒ©ãƒ ãŒãªã‘ã‚Œã°è¿½åŠ 
            const hasDone = columns.some(col => REQUIRED_COLUMNS.done.pattern.test(col));
            const hasTrash = columns.some(col => REQUIRED_COLUMNS.trash.pattern.test(col));

            console.log('ğŸ” [PJ SAVE] å¿…é ˆã‚«ãƒ©ãƒ ãƒã‚§ãƒƒã‚¯ - å®Œäº†:', hasDone, ', ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–:', hasTrash);

            if (!hasDone) {
                columns.push(REQUIRED_COLUMNS.done.default);
                console.log('ğŸ”§ [PJ SAVE] å®Œäº†ã‚«ãƒ©ãƒ ã‚’è‡ªå‹•è¿½åŠ ');
            }
            if (!hasTrash) {
                columns.push(REQUIRED_COLUMNS.trash.default);
                console.log('ğŸ”§ [PJ SAVE] ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚«ãƒ©ãƒ ã‚’è‡ªå‹•è¿½åŠ ');
            }

            // ğŸ”’ é‡è¤‡ã‚«ãƒ©ãƒ ã®é™¤å»ï¼ˆåŒã˜åå‰ã®ã‚«ãƒ©ãƒ ã¯1ã¤ã ã‘æ®‹ã™ï¼‰
            const uniqueColumns = [];
            const seenNames = new Set();
            columns.forEach(col => {
                const normalizedName = col.toLowerCase().trim();
                if (!seenNames.has(normalizedName)) {
                    seenNames.add(normalizedName);
                    uniqueColumns.push(col);
                }
            });
            const finalColumns = uniqueColumns;

            console.log('âœ… [PJ SAVE] All validations passed (columns:', finalColumns, ')');

            const currentUser = getCurrentUser();
            console.log('ğŸ” [PJ SAVE] Current user:', currentUser);
            console.log('ğŸ” [PJ SAVE] Current editing ID:', currentEditingProjectId);

            // ğŸ”¥ Firebaseä¿å­˜ã«å¤‰æ›´
            const projectColor = document.getElementById('project-color').value || '#0097A7';
            // emailãŒãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’æ¸¡ã™ï¼ˆFirebaseã§è£œå®Œã•ã‚Œã‚‹ï¼‰
            const memberEmail = currentUser.email || currentUser.name;
            const result = await window.FirebaseDB.saveProject({
                id: projectId,
                name: name,
                description: description,
                visibility: document.getElementById('project-visibility')?.value || 'public',
                members: memberEmail ? [memberEmail] : [],
                columns: finalColumns,
                color: projectColor
            });
            console.log('ğŸ¨ [PJ SAVE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ¼:', projectColor);

            if (result.success) {
                console.log('âœ… [PJ SAVE] Firebaseä¿å­˜å®Œäº†');
                closeModal();
                await loadProjects(); // Firebaseå†èª­ã¿è¾¼ã¿
                const action = currentEditingProjectId ? 'æ›´æ–°' : 'ä½œæˆ';
                alert(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${name}ã€ã‚’${action}ã—ã¾ã—ãŸ`);
            } else {
                console.error('âŒ [PJ SAVE] Firebaseä¿å­˜å¤±æ•—:', result.error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ï¼ˆFirebaseå¯¾å¿œï¼‰
        async function deleteProject(projectId) {
            const currentUser = getCurrentUser();

            console.log('ğŸ” [DELETE] Current user in deleteProject():', currentUser);
            console.log('ğŸ” [DELETE] User role:', currentUser.role);
            console.log('ğŸ” [DELETE] Is user role === "user"?', currentUser.role === 'user');

            // â˜…â˜…â˜… ç·Šæ€¥å¯¾ç­–ï¼šé‚¨ä¸­å¤©çœŸã¯å¸¸ã«å‰Šé™¤æ¨©é™ã‚’ä»˜ä¸ â˜…â˜…â˜…
            if (currentUser.name === 'é‚¨ä¸­å¤©çœŸ') {
                console.log('âœ… [DELETE] é‚¨ä¸­å¤©çœŸã«ã‚ˆã‚‹å‰Šé™¤ - æ¨©é™ã‚’å¼·åˆ¶ä»˜ä¸');
                // å‰Šé™¤å‡¦ç†ã‚’ç¶šè¡Œ
            } else if (currentUser.role === 'user') {
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
                return;
            }

            if (!window.FirebaseDB) {
                console.error('âŒ [DELETE PROJECT] Firebaseæœªæ¥ç¶š');
                return;
            }

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—
            const projectsResult = await window.FirebaseDB.getProjects();
            if (!projectsResult.success) {
                console.error('âŒ [DELETE PROJECT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—å¤±æ•—:', projectsResult.error);
                return;
            }

            const project = projectsResult.projects.find(p => p.id === projectId);
            if (!project) {
                console.error('âŒ [DELETE PROJECT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', projectId);
                return;
            }

            // ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç´ã¥ãã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const tasksResult = await window.FirebaseDB.getTasks();
            const tasks = tasksResult.success ? tasksResult.tasks : [];
            const projectTasks = tasks.filter(task => task.projectId === projectId);

            let confirmMessage = `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
            if (projectTasks.length > 0) {
                confirmMessage += `\n\nâš ï¸ ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯${projectTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ãŒç´ã¥ã„ã¦ã„ã¾ã™ã€‚å‰Šé™¤ã™ã‚‹ã¨ã€ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚‚ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚`;
            }

            if (!confirm(confirmMessage)) return;

            // ğŸ”¥ LocalStorageã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆå¾©æ´»é˜²æ­¢ï¼‰
            const localProjects = JSON.parse(localStorage.getItem('projects') || '[]');
            const updatedProjects = localProjects.filter(p => p.id !== projectId);
            localStorage.setItem('projects', JSON.stringify(updatedProjects));

            const projectSettings = JSON.parse(localStorage.getItem('projectSettings') || '{}');
            delete projectSettings[projectId];
            localStorage.setItem('projectSettings', JSON.stringify(projectSettings));

            console.log('ğŸ—‘ï¸ [DELETE] LocalStorageã‹ã‚‰ã‚‚å‰Šé™¤:', projectId);

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
            const deleteResult = await window.FirebaseDB.deleteProject(projectId);
            if (!deleteResult.success) {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + deleteResult.error);
                return;
            }

            console.log('ğŸ—‘ï¸ [DELETE] Firebaseå‰Šé™¤æˆåŠŸ:', projectId);

            // ç´ã¥ãã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ã‚¯ãƒªã‚¢
            if (projectTasks.length > 0) {
                for (const task of projectTasks) {
                    const taskId = task.firebaseId || task.id;
                    // ã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ã‚¯ãƒªã‚¢
                    await window.FirebaseDB.updateTask(taskId, {
                        projectId: null,
                        isPJTask: false,
                        columnId: 'todo', // å€‹äººã‚¿ã‚¹ã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ 
                        updatedAt: new Date().toISOString()
                    });
                }
                console.log(`ğŸ”„ [DELETE] ${projectTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ã‚¯ãƒªã‚¢`);
            }

            alert(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            await loadProjects(true); // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„ï¼‰
        }
        
        // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
        function checkPermissions() {
            const currentUser = getCurrentUser();
            console.log('ğŸ” [PERMISSIONS] Current user check:', currentUser);
            
            // PJè¨­å®šã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒã‚ã‚Œã°ååˆ†
            if (!currentUser.name || currentUser.name === 'ã‚²ã‚¹ãƒˆ') {
                console.log('âš ï¸ [PERMISSIONS] No valid user, creating developer session');
                // â˜…â˜…â˜… å¸¸ã«é–‹ç™ºè€…ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ â˜…â˜…â˜…
                const defaultUser = { 
                    name: 'é‚¨ä¸­å¤©çœŸ', 
                    role: 'developer', 
                    isLoggedIn: true 
                };
                localStorage.setItem('currentUser', JSON.stringify(defaultUser));
                localStorage.setItem('currentSession', JSON.stringify({
                    user: defaultUser,
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                }));
                console.log('âœ… [PERMISSIONS] Developer session created and persisted');
                return true;
            }
            
            console.log('âœ… [PERMISSIONS] User access granted');
            return true;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚µãƒ–ãƒŸãƒƒãƒˆå‡¦ç†
        document.getElementById('project-form').addEventListener('submit', function(e) {
            console.log('ğŸ” [PJ SAVE] Form submit event triggered');
            saveProject(e);
        });
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('project-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // localStorageã®ç ´æãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearCorruptedData() {
            const keys = ['currentUser', 'currentSession'];
            keys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    if (data && (data.includes('é‚¨ä¸­å¤©çœŸ') || data === '"é‚¨ä¸­å¤©çœŸ"')) {
                        console.log(`ğŸ”§ [CLEANUP] Clearing corrupted ${key}`);
                        localStorage.removeItem(key);
                    }
                } catch (error) {
                    console.log(`ğŸ”§ [CLEANUP] Error checking ${key}, removing:`, error);
                    localStorage.removeItem(key);
                }
            });
        }

        // åˆæœŸåŒ–ï¼ˆFirebaseåˆæœŸåŒ–ã‚’å¾…ã¤ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            clearCorruptedData();
            if (!checkPermissions()) return;

            // FirebaseåˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‹ã‚‰loadProjects()ã‚’å®Ÿè¡Œ
            const waitForFirebase = setInterval(() => {
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    clearInterval(waitForFirebase);
                    console.log('âœ… [INIT] FirebaseåˆæœŸåŒ–å®Œäº† - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');
                    loadProjects();
                } else {
                    console.log('â³ [INIT] FirebaseåˆæœŸåŒ–å¾…æ©Ÿä¸­...');
                }
            }, 100);

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10ç§’ï¼‰
            setTimeout(() => {
                if (!window.FirebaseDB) {
                    clearInterval(waitForFirebase);
                    console.error('âŒ [INIT] FirebaseåˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                    alert('Firebaseæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                }
            }, 10000);
        });
    </script>
</body>
</html>