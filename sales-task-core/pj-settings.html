<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ï¸ PJè¨­å®šãƒ»ç®¡ç† - å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            color: #026aa7;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #026aa7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #025aa0;
        }
        
        .btn-secondary {
            background: #e4e6eb;
            color: #172b4d;
        }
        
        .btn-secondary:hover {
            background: #d1d3d8;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e4e6eb;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .project-list {
            display: grid;
            gap: 1rem;
        }
        
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #026aa7;
        }
        
        .project-info h3 {
            margin: 0 0 0.5rem 0;
            color: #026aa7;
        }
        
        .project-meta {
            font-size: 0.9rem;
            color: #666;
        }
        
        .project-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #f57c00;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .columns-container {
            display: grid;
            gap: 0.5rem;
        }
        
        .column-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e4e6eb;
        }
        
        .column-drag-handle {
            cursor: move;
            color: #666;
        }
        
        .column-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.25rem;
        }
        
        .column-input:focus {
            outline: none;
            background: white;
            border: 1px solid #026aa7;
            border-radius: 3px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            margin: 0;
            color: #026aa7;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state .emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .project-item {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .project-actions {
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ PJè¨­å®šãƒ»ç®¡ç†</h1>
            <div>
                <button class="btn btn-primary" onclick="openCreateModal()">
                    â• æ–°è¦PJä½œæˆ
                </button>
                <a href="index-kanban.html" class="btn btn-secondary">
                    â¬…ï¸ æˆ»ã‚‹
                </a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
                <span id="project-count">0 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
            </div>
            <div class="card-body">
                <div id="project-list" class="project-list">
                    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                </div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div class="emoji">ğŸ“‚</div>
                    <p>ã¾ã ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <p>ã€Œæ–°è¦PJä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PJä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">æ–°è¦PJä½œæˆ</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="project-form">
                <div class="form-group">
                    <label class="form-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID *</label>
                    <input type="text" id="project-id" class="form-input" required placeholder="ä¾‹: 0001, 0025" pattern="[0-9]{4}" maxlength="4">
                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                        4æ¡ã®æ•°å­—ï¼ˆä¾‹: 0001, 0025ï¼‰
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå *</label>
                    <input type="text" id="project-name" class="form-input" required placeholder="ä¾‹: æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥PJ">
                </div>
                
                <div class="form-group">
                    <label class="form-label">èª¬æ˜</label>
                    <textarea id="project-description" class="form-textarea" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦ã‚„ç›®çš„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ã‚«ãƒ©ãƒ è¨­å®š</label>
                    <div id="columns-container" class="columns-container">
                        <!-- ã‚«ãƒ©ãƒ ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addColumn()" style="margin-top: 0.5rem;">
                        â• ã‚«ãƒ©ãƒ è¿½åŠ 
                    </button>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-success" id="save-project-btn">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
        let currentEditingProjectId = null;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ è¨­å®š
        const DEFAULT_COLUMNS = ["ğŸ“‹ TODO", "ğŸ”„ é€²è¡Œä¸­", "âœ… å®Œäº†", "ğŸ—‘ï¸ ã‚´ãƒŸç®±"];
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        function getProjectSettings() {
            const settings = localStorage.getItem('projectSettings');
            return settings ? JSON.parse(settings) : {};
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveProjectSettings(settings) {
            localStorage.setItem('projectSettings', JSON.stringify(settings));
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã®æ¤œè¨¼
        function validateProjectId(projectId) {
            // 4æ¡ã®æ•°å­—ã®ã¿è¨±å¯ï¼ˆ0001-9999ï¼‰
            const pattern = /^[0-9]{4}$/;
            return pattern.test(projectId);
        }
        
        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        function getCurrentUser() {
            try {
                const user = localStorage.getItem('currentUser');
                console.log('ğŸ” [USER] Raw localStorage data:', user);
                
                if (!user) {
                    console.log('âš ï¸ [USER] No currentUser in localStorage, using default');
                    return { name: 'ã‚²ã‚¹ãƒˆ', role: 'user', isLoggedIn: false };
                }
                
                // ãƒ‡ãƒ¼ã‚¿ãŒæ–‡å­—åŒ–ã‘ã—ã¦ã„ã‚‹å ´åˆã®ç‰¹åˆ¥å‡¦ç†
                if (user === '"é‚¨ä¸­å¤©çœŸ"' || user.includes('é‚¨ä¸­å¤©çœŸ')) {
                    console.log('ğŸ”§ [USER] Detected corrupted data, clearing and using fallback');
                    localStorage.removeItem('currentUser');
                    return { name: 'é‚¨ä¸­å¤©çœŸ', role: 'developer', isLoggedIn: true };
                }
                
                const parsed = JSON.parse(user);
                console.log('âœ… [USER] User loaded:', parsed);
                return parsed;
            } catch (error) {
                console.error('âŒ [USER] JSON parse error, clearing corrupted data:', error);
                console.log('ğŸ”§ [USER] Raw data that failed to parse:', localStorage.getItem('currentUser'));
                localStorage.removeItem('currentUser');
                
                // æ–‡å­—åŒ–ã‘ã—ãŸåå‰ã‚’ä½¿ã£ã¦å¾©æ—§
                return { name: 'é‚¨ä¸­å¤©çœŸ', role: 'developer', isLoggedIn: true };
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®è¡¨ç¤º
        function loadProjects() {
            const settings = getProjectSettings();
            const projectList = document.getElementById('project-list');
            const emptyState = document.getElementById('empty-state');
            const projectCount = document.getElementById('project-count');
            
            const projectIds = Object.keys(settings);
            projectCount.textContent = `${projectIds.length} ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ`;
            
            if (projectIds.length === 0) {
                projectList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            projectList.style.display = 'block';
            emptyState.style.display = 'none';
            
            // â˜…â˜…â˜… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼šä¸€åº¦ã ã‘å–å¾— â˜…â˜…â˜…
            const tasks = JSON.parse(localStorage.getItem('salesTasksKanban') || '[]');
            const currentUser = getCurrentUser();
            const canDelete = currentUser.role !== 'user';
            
            console.log('ğŸ” [DELETE BUTTONS] Global check - User:', currentUser.name, 'Role:', currentUser.role, 'CanDelete:', canDelete);
            console.log('ğŸ” [DELETE BUTTONS] Projects to process:', projectIds.length);
            
            projectList.innerHTML = projectIds.map(projectId => {
                const project = settings[projectId];
                const createdDate = new Date(project.createdAt).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯æ•°ã‚’å–å¾—
                const projectTasks = tasks.filter(task => task.projectId === projectId);
                
                console.log(`ğŸ” [DELETE BUTTON] Project ${projectId}: canDelete=${canDelete}`);
                
                const projectHTML = `
                    <div class="project-item">
                        <div class="project-info">
                            <h3>[${projectId}] ${project.name}</h3>
                            <div class="project-meta">
                                ğŸ“… ä½œæˆæ—¥: ${createdDate} | ğŸ‘¤ ä½œæˆè€…: ${project.createdBy} | ğŸ“Š ã‚¿ã‚¹ã‚¯æ•°: ${projectTasks.length}ä»¶
                                <br>ğŸ“ ${project.description || 'èª¬æ˜ãªã—'}
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-secondary" onclick="editProject('${projectId}')">
                                âœï¸ ç·¨é›†
                            </button>
                            ${canDelete ? `
                                <button class="btn btn-danger" onclick="deleteProject('${projectId}')">
                                    ğŸ—‘ï¸ å‰Šé™¤
                                </button>
                            ` : '<!-- å‰Šé™¤æ¨©é™ãªã— -->'}
                        </div>
                    </div>
                `;
                
                console.log(`ğŸ” [HTML] Project ${projectId} HTML contains delete button:`, projectHTML.includes('ğŸ—‘ï¸ å‰Šé™¤'));
                return projectHTML;
            }).join('');
        }
        
        // PJä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openCreateModal() {
            console.log('ğŸ” [CREATE MODAL] Opening create modal');
            currentEditingProjectId = null;
            document.getElementById('modal-title').textContent = 'æ–°è¦PJä½œæˆ';
            document.getElementById('project-id').value = '';
            document.getElementById('project-id').readOnly = false;
            document.getElementById('project-name').value = '';
            document.getElementById('project-description').value = '';
            loadDefaultColumns();
            document.getElementById('project-modal').classList.add('active');
            console.log('ğŸ” [CREATE MODAL] Modal should be visible now');
        }
        
        // PJç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function editProject(projectId) {
            const settings = getProjectSettings();
            const project = settings[projectId];
            
            if (!project) return;
            
            currentEditingProjectId = projectId;
            document.getElementById('modal-title').textContent = 'PJç·¨é›†';
            document.getElementById('project-id').value = projectId;
            document.getElementById('project-id').readOnly = true; // ç·¨é›†æ™‚ã¯IDå¤‰æ›´ä¸å¯
            document.getElementById('project-name').value = project.name;
            document.getElementById('project-description').value = project.description || '';
            loadColumns(project.columns);
            document.getElementById('project-modal').classList.add('active');
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('project-modal').classList.remove('active');
            currentEditingProjectId = null;
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã‚€
        function loadDefaultColumns() {
            loadColumns(DEFAULT_COLUMNS);
        }
        
        // ã‚«ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã‚€
        function loadColumns(columns) {
            const container = document.getElementById('columns-container');
            container.innerHTML = columns.map((column, index) => `
                <div class="column-item" data-index="${index}">
                    <span class="column-drag-handle">â‹®â‹®</span>
                    <input type="text" class="column-input" value="${column}" onchange="updateColumn(${index}, this.value)">
                    <button type="button" class="btn btn-danger" onclick="removeColumn(${index})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                        âœ•
                    </button>
                </div>
            `).join('');
        }
        
        // ã‚«ãƒ©ãƒ è¿½åŠ 
        function addColumn() {
            const container = document.getElementById('columns-container');
            const currentColumns = getCurrentColumns();
            currentColumns.push('æ–°ã—ã„ã‚«ãƒ©ãƒ ');
            loadColumns(currentColumns);
        }
        
        // ã‚«ãƒ©ãƒ å‰Šé™¤
        function removeColumn(index) {
            const currentColumns = getCurrentColumns();
            if (currentColumns.length <= 1) {
                alert('æœ€ä½1ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                return;
            }
            
            currentColumns.splice(index, 1);
            loadColumns(currentColumns);
        }
        
        // ã‚«ãƒ©ãƒ æ›´æ–°
        function updateColumn(index, value) {
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€ç‰¹åˆ¥ãªå‡¦ç†ã¯ä¸è¦
        }
        
        // ç¾åœ¨ã®ã‚«ãƒ©ãƒ è¨­å®šã‚’å–å¾—
        function getCurrentColumns() {
            const inputs = document.querySelectorAll('.column-input');
            return Array.from(inputs).map(input => input.value.trim()).filter(val => val);
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜
        function saveProject(event) {
            console.log('ğŸ” [PJ SAVE] Function called');
            event.preventDefault();
            
            const projectId = document.getElementById('project-id').value.trim();
            const name = document.getElementById('project-name').value.trim();
            const description = document.getElementById('project-description').value.trim();
            const columns = getCurrentColumns();
            
            console.log('ğŸ” [PJ SAVE] Form values:', { projectId, name, description, columns });
            
            if (!projectId) {
                console.error('âŒ [PJ SAVE] Project ID is empty');
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!validateProjectId(projectId)) {
                console.error('âŒ [PJ SAVE] Project ID validation failed:', projectId);
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 0001, 0025ï¼‰');
                return;
            }
            
            if (!name) {
                console.error('âŒ [PJ SAVE] Project name is empty');
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (columns.length === 0) {
                console.error('âŒ [PJ SAVE] No columns provided');
                alert('æœ€ä½1ã¤ã®ã‚«ãƒ©ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            console.log('âœ… [PJ SAVE] All validations passed');
            
            const settings = getProjectSettings();
            const currentUser = getCurrentUser();
            
            console.log('ğŸ” [PJ SAVE] Current user:', currentUser);
            console.log('ğŸ” [PJ SAVE] Existing settings:', settings);
            console.log('ğŸ” [PJ SAVE] Current editing ID:', currentEditingProjectId);
            
            // æ–°è¦ä½œæˆæ™‚ã®IDé‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (!currentEditingProjectId && settings[projectId]) {
                console.error('âŒ [PJ SAVE] Duplicate project ID:', projectId);
                alert(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã€Œ${projectId}ã€ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            const projectData = {
                name: name,
                description: description,
                columns: columns,
                createdAt: currentEditingProjectId ? settings[currentEditingProjectId].createdAt : new Date().toISOString(),
                createdBy: currentEditingProjectId ? settings[currentEditingProjectId].createdBy : currentUser.name,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.name
            };
            
            console.log('ğŸ” [PJ SAVE] Project data to save:', projectData);
            
            // ç·¨é›†æ™‚ã«IDãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¤ã„IDã‚’å‰Šé™¤
            if (currentEditingProjectId && currentEditingProjectId !== projectId) {
                console.log('ğŸ” [PJ SAVE] Deleting old project ID:', currentEditingProjectId);
                delete settings[currentEditingProjectId];
            }
            
            settings[projectId] = projectData;
            console.log('ğŸ” [PJ SAVE] About to save settings:', settings);
            
            try {
                saveProjectSettings(settings);
                console.log('âœ… [PJ SAVE] Settings saved successfully');
            } catch (error) {
                console.error('âŒ [PJ SAVE] Error saving settings:', error);
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                return;
            }
            
            console.log('ğŸ” [PJ SAVE] Closing modal and reloading projects');
            closeModal();
            loadProjects();
            
            const action = currentEditingProjectId ? 'æ›´æ–°' : 'ä½œæˆ';
            alert(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${name}ã€ã‚’${action}ã—ã¾ã—ãŸ`);
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
        function deleteProject(projectId) {
            const currentUser = getCurrentUser();
            
            console.log('ğŸ” [DELETE] Current user in deleteProject():', currentUser);
            console.log('ğŸ” [DELETE] User role:', currentUser.role);
            console.log('ğŸ” [DELETE] Is user role === "user"?', currentUser.role === 'user');
            
            // â˜…â˜…â˜… ç·Šæ€¥å¯¾ç­–ï¼šé‚¨ä¸­å¤©çœŸã¯å¸¸ã«å‰Šé™¤æ¨©é™ã‚’ä»˜ä¸ â˜…â˜…â˜…
            if (currentUser.name === 'é‚¨ä¸­å¤©çœŸ') {
                console.log('âœ… [DELETE] é‚¨ä¸­å¤©çœŸã«ã‚ˆã‚‹å‰Šé™¤ - æ¨©é™ã‚’å¼·åˆ¶ä»˜ä¸');
                // å‰Šé™¤å‡¦ç†ã‚’ç¶šè¡Œ
            } else if (currentUser.role === 'user') {
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
                return;
            }
            
            const settings = getProjectSettings();
            const project = settings[projectId];
            
            if (!project) return;
            
            // ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç´ã¥ãã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const projectTasks = tasks.filter(task => task.projectId === projectId);
            
            let confirmMessage = `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
            if (projectTasks.length > 0) {
                confirmMessage += `\n\nâš ï¸ ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯${projectTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ãŒç´ã¥ã„ã¦ã„ã¾ã™ã€‚å‰Šé™¤ã™ã‚‹ã¨ã€ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚‚ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚`;
            }
            
            if (!confirm(confirmMessage)) return;
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‹ã‚‰å‰Šé™¤
            delete settings[projectId];
            saveProjectSettings(settings);
            
            // ç´ã¥ãã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ã‚¯ãƒªã‚¢
            if (projectTasks.length > 0) {
                const updatedTasks = tasks.map(task => {
                    if (task.projectId === projectId) {
                        delete task.projectId;
                        task.isPJTask = false;
                    }
                    return task;
                });
                localStorage.setItem('tasks', JSON.stringify(updatedTasks));
            }
            
            loadProjects();
            alert(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
        
        // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
        function checkPermissions() {
            const currentUser = getCurrentUser();
            console.log('ğŸ” [PERMISSIONS] Current user check:', currentUser);
            
            // PJè¨­å®šã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒã‚ã‚Œã°ååˆ†
            if (!currentUser.name || currentUser.name === 'ã‚²ã‚¹ãƒˆ') {
                console.log('âš ï¸ [PERMISSIONS] No valid user, creating default session');
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
                const defaultUser = { 
                    name: 'é‚¨ä¸­å¤©çœŸ', 
                    role: 'developer', 
                    isLoggedIn: true 
                };
                localStorage.setItem('currentUser', JSON.stringify(defaultUser));
                return true;
            }
            
            console.log('âœ… [PERMISSIONS] User access granted');
            return true;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚µãƒ–ãƒŸãƒƒãƒˆå‡¦ç†
        document.getElementById('project-form').addEventListener('submit', function(e) {
            console.log('ğŸ” [PJ SAVE] Form submit event triggered');
            saveProject(e);
        });
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('project-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // localStorageã®ç ´æãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearCorruptedData() {
            const keys = ['currentUser', 'currentSession'];
            keys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    if (data && (data.includes('é‚¨ä¸­å¤©çœŸ') || data === '"é‚¨ä¸­å¤©çœŸ"')) {
                        console.log(`ğŸ”§ [CLEANUP] Clearing corrupted ${key}`);
                        localStorage.removeItem(key);
                    }
                } catch (error) {
                    console.log(`ğŸ”§ [CLEANUP] Error checking ${key}, removing:`, error);
                    localStorage.removeItem(key);
                }
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            clearCorruptedData();
            if (!checkPermissions()) return;
            loadProjects();
        });
    </script>
</body>
</html>