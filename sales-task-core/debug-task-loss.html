<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ã‚¿ã‚¹ã‚¯æ¶ˆå¤±ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            background: #026aa7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .btn:hover {
            background: #025aa0;
        }
        .output {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        .alert {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ã‚¿ã‚¹ã‚¯æ¶ˆå¤±ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="alert">
            <strong>âš ï¸ å•é¡Œå ±å‘Š:</strong> ãƒšãƒ¼ã‚¸ã‚’2å›æ›´æ–°ã™ã‚‹ã¨ã‚¿ã‚¹ã‚¯ãŒæ¶ˆå¤±ã™ã‚‹ç¾è±¡ã‚’èª¿æŸ»ã—ã¾ã™ã€‚
        </div>
        
        <div class="section">
            <h3>ğŸ“Š ç¾åœ¨ã®çŠ¶æ³ç¢ºèª</h3>
            <button class="btn" onclick="checkCurrentState()">ç¾åœ¨ã®çŠ¶æ³ã‚’ç¢ºèª</button>
            <button class="btn" onclick="checkAllStorageKeys()">å…¨LocalStorageã‚­ãƒ¼ã‚’ç¢ºèª</button>
            <button class="btn" onclick="simulatePageReload()">ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
            <div id="current-state-output" class="output"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ”„ åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹è¿½è·¡</h3>
            <button class="btn" onclick="traceInitialization()">åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¿½è·¡</button>
            <button class="btn" onclick="checkUserDatabaseInit()">ãƒ¦ãƒ¼ã‚¶ãƒ¼DBåˆæœŸåŒ–ã‚’ç¢ºèª</button>
            <div id="init-trace-output" class="output"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ³</h3>
            <button class="btn" onclick="checkBackups()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’ç¢ºèª</button>
            <button class="btn" onclick="createTestBackup()">ãƒ†ã‚¹ãƒˆç”¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
            <div id="backup-output" class="output"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ“ä½œ</h3>
            <button class="btn" onclick="createTestTasks()">ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ</button>
            <button class="btn" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
            <button class="btn" onclick="restoreFromLatestBackup()">æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§</button>
            <div id="test-output" class="output"></div>
        </div>
    </div>
    
    <script>
        function log(message) {
            console.log(`[DEBUG] ${new Date().toISOString()}: ${message}`);
        }
        
        function checkCurrentState() {
            const output = document.getElementById('current-state-output');
            let result = '=== ç¾åœ¨ã®çŠ¶æ³ ===\n\n';
            
            try {
                // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿
                const tasks = localStorage.getItem('salesTasksKanban');
                const parsedTasks = tasks ? JSON.parse(tasks) : [];
                result += `ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿:\n`;
                result += `- å­˜åœ¨: ${tasks ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
                result += `- ã‚¿ã‚¹ã‚¯æ•°: ${parsedTasks.length}ä»¶\n`;
                result += `- ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${tasks ? tasks.length : 0}æ–‡å­—\n\n`;
                
                if (parsedTasks.length > 0) {
                    result += `ã‚¿ã‚¹ã‚¯ä¸€è¦§:\n`;
                    parsedTasks.slice(0, 5).forEach((task, index) => {
                        result += `${index + 1}. ${task.title} (${task.columnId})\n`;
                    });
                    if (parsedTasks.length > 5) {
                        result += `...ä»–${parsedTasks.length - 5}ä»¶\n`;
                    }
                    result += '\n';
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
                const users = localStorage.getItem('systemUsers');
                const parsedUsers = users ? JSON.parse(users) : [];
                result += `ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿:\n`;
                result += `- å­˜åœ¨: ${users ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
                result += `- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${parsedUsers.length}å\n\n`;
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
                const session = localStorage.getItem('currentSession');
                const currentUser = localStorage.getItem('currentUser');
                result += `ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±:\n`;
                result += `- currentSession: ${session ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
                result += `- currentUser: ${currentUser || 'ãªã—'}\n\n`;
                
                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
                result += `ç¢ºèªæ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}\n`;
                
            } catch (error) {
                result += `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}\n`;
            }
            
            output.textContent = result;
            log(`Current state checked: ${parsedTasks.length} tasks found`);
        }
        
        function checkAllStorageKeys() {
            const output = document.getElementById('current-state-output');
            let result = '=== å…¨LocalStorageã‚­ãƒ¼ ===\n\n';
            
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                keys.push(localStorage.key(i));
            }
            
            keys.sort();
            
            result += `ç·ã‚­ãƒ¼æ•°: ${keys.length}\n\n`;
            
            const categories = {
                'ã‚¿ã‚¹ã‚¯é–¢é€£': keys.filter(k => k.includes('Task') || k.includes('kanban')),
                'ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£': keys.filter(k => k.includes('User') || k.includes('Session')),
                'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—': keys.filter(k => k.includes('backup')),
                'ãã®ä»–': keys.filter(k => !k.includes('Task') && !k.includes('kanban') && !k.includes('User') && !k.includes('Session') && !k.includes('backup'))
            };
            
            Object.entries(categories).forEach(([category, categoryKeys]) => {
                if (categoryKeys.length > 0) {
                    result += `ã€${category}ã€‘\n`;
                    categoryKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        const size = value ? value.length : 0;
                        result += `- ${key}: ${size}æ–‡å­—\n`;
                    });
                    result += '\n';
                }
            });
            
            output.textContent = result;
            log(`Storage keys checked: ${keys.length} total keys`);
        }
        
        function simulatePageReload() {
            const output = document.getElementById('current-state-output');
            let result = '=== ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ===\n\n';
            
            try {
                // ãƒªãƒ­ãƒ¼ãƒ‰å‰ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
                const beforeTasks = localStorage.getItem('salesTasksKanban');
                const beforeTaskCount = beforeTasks ? JSON.parse(beforeTasks).length : 0;
                result += `ãƒªãƒ­ãƒ¼ãƒ‰å‰: ${beforeTaskCount}ä»¶ã®ã‚¿ã‚¹ã‚¯\n`;
                
                // åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆindex-kanban.htmlã®å‡¦ç†ã‚’æ¨¡æ“¬ï¼‰
                result += '\n--- åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹ ---\n';
                
                // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒã‚§ãƒƒã‚¯
                const session = localStorage.getItem('currentSession');
                result += `1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯: ${session ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}\n`;
                
                // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ï¼ˆå•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚‹ç®‡æ‰€ï¼‰
                if (typeof initializeSharedUserDatabase === 'function') {
                    result += '2. å…±æœ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼DBåˆæœŸåŒ–å®Ÿè¡Œ\n';
                } else {
                    result += '2. é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼DBåˆæœŸåŒ–å®Ÿè¡Œ\n';
                }
                
                // 3. ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const afterTasks = localStorage.getItem('salesTasksKanban');
                const afterTaskCount = afterTasks ? JSON.parse(afterTasks).length : 0;
                result += `3. ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${afterTaskCount}ä»¶\n`;
                
                // 4. çµæœæ¯”è¼ƒ
                result += '\n--- çµæœ ---\n';
                result += `ãƒªãƒ­ãƒ¼ãƒ‰å‰: ${beforeTaskCount}ä»¶\n`;
                result += `ãƒªãƒ­ãƒ¼ãƒ‰å¾Œ: ${afterTaskCount}ä»¶\n`;
                
                if (beforeTaskCount !== afterTaskCount) {
                    result += `âŒ ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ¤œå‡º! ${beforeTaskCount - afterTaskCount}ä»¶ã®ã‚¿ã‚¹ã‚¯ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ\n`;
                } else {
                    result += `âœ… ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§OK\n`;
                }
                
            } catch (error) {
                result += `âŒ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}\n`;
            }
            
            output.textContent = result;
        }
        
        function traceInitialization() {
            const output = document.getElementById('init-trace-output');
            let result = '=== åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹è©³ç´°è¿½è·¡ ===\n\n';
            
            // LocalStorageã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
            const snapshot = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                snapshot[key] = localStorage.getItem(key);
            }
            
            result += `åˆæœŸåŒ–å‰ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆå®Œäº†\n`;
            result += `è¨˜éŒ²ã•ã‚ŒãŸã‚­ãƒ¼æ•°: ${Object.keys(snapshot).length}\n\n`;
            
            // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ç‰¹å®šç¢ºèª
            const taskData = snapshot['salesTasksKanban'];
            if (taskData) {
                try {
                    const tasks = JSON.parse(taskData);
                    result += `ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ç¢ºèª:\n`;
                    result += `- æœ‰åŠ¹ãªJSON: ã¯ã„\n`;
                    result += `- ã‚¿ã‚¹ã‚¯æ•°: ${tasks.length}ä»¶\n`;
                    result += `- é…åˆ—å½¢å¼: ${Array.isArray(tasks) ? 'ã¯ã„' : 'ã„ã„ãˆ'}\n\n`;
                } catch (e) {
                    result += `ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ç¢ºèª:\n`;
                    result += `- æœ‰åŠ¹ãªJSON: ã„ã„ãˆ (${e.message})\n\n`;
                }
            } else {
                result += `ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ç¢ºèª:\n`;
                result += `- å­˜åœ¨: ã„ã„ãˆ\n\n`;
            }
            
            output.textContent = result;
        }
        
        function checkUserDatabaseInit() {
            const output = document.getElementById('init-trace-output');
            let result = '=== ãƒ¦ãƒ¼ã‚¶ãƒ¼DBåˆæœŸåŒ–ç¢ºèª ===\n\n';
            
            try {
                // åˆæœŸåŒ–å‰ã®çŠ¶æ…‹
                const beforeUsers = localStorage.getItem('systemUsers');
                const beforeTasks = localStorage.getItem('salesTasksKanban');
                
                result += `åˆæœŸåŒ–å‰:\n`;
                result += `- ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${beforeUsers ? JSON.parse(beforeUsers).length : 0}å\n`;
                result += `- ã‚¿ã‚¹ã‚¯: ${beforeTasks ? JSON.parse(beforeTasks).length : 0}ä»¶\n\n`;
                
                // shared-users-database.jsã®é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                result += `åˆ©ç”¨å¯èƒ½ãªåˆæœŸåŒ–é–¢æ•°:\n`;
                result += `- initializeSharedUserDatabase: ${typeof initializeSharedUserDatabase !== 'undefined' ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
                result += `- initializeUserDatabase: ${typeof initializeUserDatabase !== 'undefined' ? 'ã‚ã‚Š' : 'ãªã—'}\n\n`;
                
                // å®Ÿéš›ã®åˆæœŸåŒ–å®Ÿè¡Œï¼ˆå®‰å…¨ã«ï¼‰
                if (typeof initializeSharedUserDatabase === 'function') {
                    result += `å…±æœ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼DBåˆæœŸåŒ–ã‚’å®Ÿè¡Œä¸­...\n`;
                    initializeSharedUserDatabase();
                } else if (typeof initializeUserDatabase === 'function') {
                    result += `é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼DBåˆæœŸåŒ–ã‚’å®Ÿè¡Œä¸­...\n`;
                    initializeUserDatabase();
                } else {
                    result += `è­¦å‘Š: åˆæœŸåŒ–é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n`;
                }
                
                // åˆæœŸåŒ–å¾Œã®çŠ¶æ…‹
                const afterUsers = localStorage.getItem('systemUsers');
                const afterTasks = localStorage.getItem('salesTasksKanban');
                
                result += `\nåˆæœŸåŒ–å¾Œ:\n`;
                result += `- ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${afterUsers ? JSON.parse(afterUsers).length : 0}å\n`;
                result += `- ã‚¿ã‚¹ã‚¯: ${afterTasks ? JSON.parse(afterTasks).length : 0}ä»¶\n\n`;
                
                // å¤‰æ›´æ¤œå‡º
                const tasksBefore = beforeTasks ? JSON.parse(beforeTasks).length : 0;
                const tasksAfter = afterTasks ? JSON.parse(afterTasks).length : 0;
                
                if (tasksBefore !== tasksAfter) {
                    result += `âŒ ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼\n`;
                    result += `å¤‰æ›´é‡: ${tasksBefore} â†’ ${tasksAfter} (${tasksAfter - tasksBefore})\n`;
                } else {
                    result += `âœ… ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã—ãŸ\n`;
                }
                
            } catch (error) {
                result += `âŒ ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}\n`;
            }
            
            output.textContent = result;
        }
        
        function checkBackups() {
            const output = document.getElementById('backup-output');
            let result = '=== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª ===\n\n';
            
            const backupKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('backup') || key.includes('Backup'))) {
                    backupKeys.push(key);
                }
            }
            
            result += `ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${backupKeys.length}\n\n`;
            
            if (backupKeys.length === 0) {
                result += 'âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n';
            } else {
                backupKeys.sort();
                backupKeys.forEach(key => {
                    try {
                        const data = localStorage.getItem(key);
                        const parsed = JSON.parse(data);
                        const timestamp = key.match(/_(\d+)$/)?.[1];
                        const date = timestamp ? new Date(parseInt(timestamp)) : new Date();
                        
                        result += `ğŸ“¦ ${key}\n`;
                        result += `   ä½œæˆæ—¥æ™‚: ${date.toLocaleString('ja-JP')}\n`;
                        result += `   ã‚¿ã‚¹ã‚¯æ•°: ${Array.isArray(parsed) ? parsed.length : 'ä¸æ˜'}ä»¶\n`;
                        result += `   ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${data.length}æ–‡å­—\n\n`;
                    } catch (e) {
                        result += `ğŸ“¦ ${key}\n`;
                        result += `   ã‚¨ãƒ©ãƒ¼: ${e.message}\n\n`;
                    }
                });
            }
            
            output.textContent = result;
        }
        
        function createTestBackup() {
            const output = document.getElementById('backup-output');
            
            try {
                const currentTasks = localStorage.getItem('salesTasksKanban') || '[]';
                const backupKey = `salesTasksKanban_debug_backup_${Date.now()}`;
                localStorage.setItem(backupKey, currentTasks);
                
                const tasksCount = JSON.parse(currentTasks).length;
                output.textContent = `âœ… ãƒ‡ãƒãƒƒã‚°ç”¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ\n\nã‚­ãƒ¼: ${backupKey}\nã‚¿ã‚¹ã‚¯æ•°: ${tasksCount}ä»¶\nä½œæˆæ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`;
                
            } catch (error) {
                output.textContent = `âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }
        
        function createTestTasks() {
            const output = document.getElementById('test-output');
            
            try {
                const testTasks = [
                    {
                        id: Date.now() + 1,
                        title: 'ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ1',
                        description: 'ãƒ†ã‚¹ãƒˆç”¨ã‚¿ã‚¹ã‚¯1',
                        columnId: 'todo',
                        priority: 'medium',
                        assignee: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: Date.now() + 2,
                        title: 'ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ2',
                        description: 'ãƒ†ã‚¹ãƒˆç”¨ã‚¿ã‚¹ã‚¯2',
                        columnId: 'in-progress',
                        priority: 'high',
                        assignee: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                        createdAt: new Date().toISOString()
                    }
                ];
                
                localStorage.setItem('salesTasksKanban', JSON.stringify(testTasks));
                output.textContent = `âœ… ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ\n\nã‚¿ã‚¹ã‚¯æ•°: ${testTasks.length}ä»¶\nä½œæˆæ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`;
                
            } catch (error) {
                output.textContent = `âŒ ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }
        
        function clearAllData() {
            const output = document.getElementById('test-output');
            
            if (confirm('å…¨ã¦ã®LocalStorageãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                try {
                    const keyCount = localStorage.length;
                    localStorage.clear();
                    output.textContent = `âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ\n\nå‰Šé™¤ã•ã‚ŒãŸã‚­ãƒ¼æ•°: ${keyCount}\nå‰Šé™¤æ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`;
                } catch (error) {
                    output.textContent = `âŒ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
            }
        }
        
        function restoreFromLatestBackup() {
            const output = document.getElementById('test-output');
            
            try {
                const backupKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('salesTasksKanban_') && key.includes('backup')) {
                        backupKeys.push(key);
                    }
                }
                
                if (backupKeys.length === 0) {
                    output.textContent = 'âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    return;
                }
                
                // æœ€æ–°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’é¸æŠ
                backupKeys.sort();
                const latestBackup = backupKeys[backupKeys.length - 1];
                const backupData = localStorage.getItem(latestBackup);
                
                localStorage.setItem('salesTasksKanban', backupData);
                
                const restoredTasks = JSON.parse(backupData);
                output.textContent = `âœ… æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§ã—ã¾ã—ãŸ\n\nãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${latestBackup}\nå¾©æ—§ã‚¿ã‚¹ã‚¯æ•°: ${restoredTasks.length}ä»¶\nå¾©æ—§æ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`;
                
            } catch (error) {
                output.textContent = `âŒ å¾©æ—§ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            checkCurrentState();
            log('Debug tool loaded');
        });
        
        // shared-users-database.jsã®èª­ã¿è¾¼ã¿
        const script = document.createElement('script');
        script.src = 'shared-users-database.js';
        document.head.appendChild(script);
    </script>
</body>
</html>