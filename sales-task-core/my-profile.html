<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸ - å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            min-height: 100vh;
        }
        
        .header {
            background: var(--theme-color, #026aa7);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .profile-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            background: var(--theme-color, #026aa7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .profile-role {
            color: #666;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .profile-email {
            color: #666;
            font-size: 0.9rem;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #172b4d;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .action-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .action-card:hover {
            border-color: var(--theme-color, #026aa7);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .action-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .action-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .action-desc {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .stats-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--theme-color, #026aa7);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .admin-section {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .admin-section .section-title {
            color: #e65100;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="header-title">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
        <button onclick="window.location.href='index-kanban.html'" class="back-btn">â† ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹</button>
    </div>
    
    <div class="container">
        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ± -->
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar">-</div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                    <div class="profile-role" id="profile-role">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
                    <div class="profile-email" id="profile-email">-</div>
                </div>
            </div>
        </div>
        
        <!-- å€‹äººã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section-title">âš™ï¸ å€‹äººè¨­å®š</div>
        <div class="action-grid">
            <div class="action-card" onclick="changePassword()">
                <div class="action-icon">ğŸ”</div>
                <div class="action-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</div>
                <div class="action-desc">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™</div>
            </div>
            
            <div class="action-card" onclick="window.location.href='index-kanban.html'; setTimeout(() => openSettings(), 1000)">
                <div class="action-icon">âš™ï¸</div>
                <div class="action-title">ã‚¿ã‚¹ã‚¯è¨­å®š</div>
                <div class="action-desc">ã‚«ãƒ©ãƒ è¨­å®šã€ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šãªã©</div>
            </div>
            
            <div class="action-card" onclick="window.location.href='index-kanban.html'; setTimeout(() => showTemplateModal(), 1000)">
                <div class="action-icon">ğŸ“‘</div>
                <div class="action-title">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</div>
                <div class="action-desc">ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆãƒ»ç·¨é›†</div>
            </div>
        </div>
        
        <!-- å€‹äººçµ±è¨ˆ -->
        <div class="stats-section">
            <div class="section-title">ğŸ“Š å€‹äººçµ±è¨ˆ</div>
            <div class="stats-grid" id="personal-stats">
                <div class="stat-item">
                    <div class="stat-number" id="my-total-tasks">-</div>
                    <div class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="my-completed-tasks">-</div>
                    <div class="stat-label">å®Œäº†ã‚¿ã‚¹ã‚¯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="my-pending-tasks">-</div>
                    <div class="stat-label">é€²è¡Œä¸­ã‚¿ã‚¹ã‚¯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="my-project-tasks">-</div>
                    <div class="stat-label">PJã‚¿ã‚¹ã‚¯</div>
                </div>
            </div>
        </div>
        
        <!-- ç®¡ç†è€…æ©Ÿèƒ½ -->
        <div class="admin-section" id="admin-section" style="display: none;">
            <div class="section-title">ğŸ‘¥ ç®¡ç†æ©Ÿèƒ½</div>
            <div class="action-grid">
                <div class="action-card" onclick="window.location.href='user-management.html'">
                    <div class="action-icon">ğŸ‘¥</div>
                    <div class="action-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</div>
                    <div class="action-desc">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='admin-dashboard.html'">
                    <div class="action-icon">ğŸ“Š</div>
                    <div class="action-title">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
                    <div class="action-desc">å…¨ä½“çµ±è¨ˆã¨ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†</div>
                </div>
                
                <div class="action-card" onclick="showTeamStats()">
                    <div class="action-icon">ğŸ“ˆ</div>
                    <div class="action-title">ãƒãƒ¼ãƒ çµ±è¨ˆ</div>
                    <div class="action-desc">ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã®çµ±è¨ˆæƒ…å ±</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        function checkAuthentication() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (!session) {
                    window.location.href = 'login.html';
                    return null;
                }
                if (new Date() > new Date(session.expiresAt)) {
                    localStorage.removeItem('currentSession');
                    window.location.href = 'login.html';
                    return null;
                }
                return session.user;
            } catch (error) {
                window.location.href = 'login.html';
                return null;
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            const currentUser = checkAuthentication();
            if (!currentUser) return;
            
            updateProfileInfo(currentUser);
            loadPersonalStats(currentUser);
            
            // ç®¡ç†è€…ãƒ»é–‹ç™ºè€…ã®ã¿ç®¡ç†æ©Ÿèƒ½ã‚’è¡¨ç¤º
            if (currentUser.role === 'developer' || currentUser.role === 'admin') {
                document.getElementById('admin-section').style.display = 'block';
            }
        });
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®æ›´æ–°
        function updateProfileInfo(user) {
            document.getElementById('profile-avatar').textContent = user.name ? user.name.charAt(0) : '-';
            document.getElementById('profile-name').textContent = user.name || 'ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼';
            document.getElementById('profile-email').textContent = user.email || '-';
            
            let roleText = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            if (user.role === 'developer') roleText = 'é–‹ç™ºè€…';
            else if (user.role === 'admin') roleText = 'ç®¡ç†è€…';
            document.getElementById('profile-role').textContent = roleText;
        }
        
        // å€‹äººçµ±è¨ˆã®èª­ã¿è¾¼ã¿
        function loadPersonalStats(user) {
            try {
                const tasks = JSON.parse(localStorage.getItem('salesTasksKanban') || '[]');
                
                // è‡ªåˆ†ãŒæ‹…å½“è€…ã«ãªã£ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡º
                const myTasks = tasks.filter(task => 
                    task.assignees && task.assignees.includes(user.name)
                );
                
                const completedTasks = myTasks.filter(task => task.columnId === 'done');
                const pendingTasks = myTasks.filter(task => task.columnId !== 'done' && task.columnId !== 'trash');
                const projectTasks = myTasks.filter(task => task.isProjectTask);
                
                document.getElementById('my-total-tasks').textContent = myTasks.length;
                document.getElementById('my-completed-tasks').textContent = completedTasks.length;
                document.getElementById('my-pending-tasks').textContent = pendingTasks.length;
                document.getElementById('my-project-tasks').textContent = projectTasks.length;
                
            } catch (error) {
                console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
        function changePassword() {
            const currentUser = checkAuthentication();
            if (!currentUser) return;
            
            const currentPassword = prompt('ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!currentPassword) return;
            
            // ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const user = users.find(u => u.email === currentUser.email);
            
            if (!user || user.password !== currentPassword) {
                alert('ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const newPassword = prompt('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!newPassword || newPassword.length < 4) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const confirmPassword = prompt('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†åº¦å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (newPassword !== confirmPassword) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                return;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
            user.password = newPassword;
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ');
        }
        
        // ãƒãƒ¼ãƒ çµ±è¨ˆè¡¨ç¤ºï¼ˆç®¡ç†è€…ãƒ»é–‹ç™ºè€…ã®ã¿ï¼‰
        function showTeamStats() {
            try {
                const tasks = JSON.parse(localStorage.getItem('salesTasksKanban') || '[]');
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                
                let statsText = 'ğŸ“ˆ ãƒãƒ¼ãƒ çµ±è¨ˆ\n\n';
                
                users.forEach(user => {
                    const userTasks = tasks.filter(task => 
                        task.assignees && task.assignees.includes(user.name)
                    );
                    const completedTasks = userTasks.filter(task => task.columnId === 'done');
                    const pendingTasks = userTasks.filter(task => task.columnId !== 'done' && task.columnId !== 'trash');
                    
                    statsText += `ğŸ‘¤ ${user.name} (${user.role})\n`;
                    statsText += `   ç·ã‚¿ã‚¹ã‚¯: ${userTasks.length}ä»¶\n`;
                    statsText += `   å®Œäº†: ${completedTasks.length}ä»¶\n`;
                    statsText += `   é€²è¡Œä¸­: ${pendingTasks.length}ä»¶\n\n`;
                });
                
                alert(statsText);
                
            } catch (error) {
                console.error('ãƒãƒ¼ãƒ çµ±è¨ˆã‚¨ãƒ©ãƒ¼:', error);
                alert('çµ±è¨ˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
    </script>
</body>
</html>