<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>👤 マイページ - 営業タスク管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            min-height: 100vh;
        }
        
        .header {
            background: var(--theme-color, #026aa7);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .profile-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            background: var(--theme-color, #026aa7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .profile-role {
            color: #666;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .profile-email {
            color: #666;
            font-size: 0.9rem;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #172b4d;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .action-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .action-card:hover {
            border-color: var(--theme-color, #026aa7);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .action-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .action-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .action-desc {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .stats-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--theme-color, #026aa7);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .admin-section {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .admin-section .section-title {
            color: #e65100;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="header-title">👤 マイページ</h1>
        <button onclick="window.location.href='index-kanban.html'" class="back-btn">← メインに戻る</button>
    </div>
    
    <div class="container">
        <!-- プロフィール情報 -->
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar">-</div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">ゲストユーザー</div>
                    <div class="profile-role" id="profile-role">未ログイン</div>
                    <div class="profile-email" id="profile-email">-</div>
                </div>
            </div>
        </div>
        
        <!-- 個人アクション -->
        <div class="section-title">⚙️ 個人設定</div>
        <div class="action-grid">
            <div class="action-card" onclick="changePassword()">
                <div class="action-icon">🔐</div>
                <div class="action-title">パスワード変更</div>
                <div class="action-desc">現在のパスワードを変更します</div>
            </div>
            
            <div class="action-card" onclick="window.location.href='index-kanban.html'">
                <div class="action-icon">🏠</div>
                <div class="action-title">メイン画面に戻る</div>
                <div class="action-desc">設定やテンプレートはハンバーガーメニューから</div>
            </div>
        </div>
        
        <!-- 個人詳細統計 -->
        <div class="stats-section">
            <div class="section-title">📊 個人詳細統計</div>
            
            <!-- 期間選択 -->
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                <span style="font-weight: 600;">期間:</span>
                <button class="period-btn" onclick="showPersonalAnalyticsForPeriod('all')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">全期間</button>
                <button class="period-btn" onclick="showPersonalAnalyticsForPeriod('today')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">今日</button>
                <button class="period-btn active" onclick="showPersonalAnalyticsForPeriod('week')" style="padding: 0.5rem 1rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer;">今週</button>
                <button class="period-btn" onclick="showPersonalAnalyticsForPeriod('month')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">今月</button>
            </div>
            
            <!-- 統計カード -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;" id="my-total-tasks">-</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">総タスク数</div>
                </div>
                <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;" id="my-completion-rate">-</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">完了率</div>
                </div>
                <div style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;" id="my-deadline-compliance">-</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">期限遵守率</div>
                </div>
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 1.5rem; border-radius: 12px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;" id="my-avg-completion-time">-</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">平均完了時間</div>
                </div>
            </div>
            
            <!-- パフォーマンス詳細 -->
            <div id="personal-performance-details" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <!-- 詳細情報がここに表示される -->
            </div>
        </div>
        
        <!-- 開発者専用機能 -->
        <div class="admin-section" id="developer-section" style="display: none;">
            <div class="section-title">⚙️ 開発者機能</div>
            <div class="action-grid">
                <div class="action-card" onclick="showDevelopmentLog()">
                    <div class="action-icon">📝</div>
                    <div class="action-title">機能改善書</div>
                    <div class="action-desc">要件・改善ログ・開発メモの管理</div>
                </div>
                
                <div class="action-card" onclick="showSystemInfo()">
                    <div class="action-icon">🔧</div>
                    <div class="action-title">システム情報</div>
                    <div class="action-desc">バージョン・デプロイ状況・技術情報</div>
                </div>
            </div>
        </div>
        
        <!-- 管理機能案内 -->
        <div class="admin-section" id="admin-section" style="display: none;">
            <div class="section-title">👥 管理機能について</div>
            <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                <h3 style="margin-bottom: 1rem;">管理者ダッシュボード</h3>
                <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.6;">
                    • 緊急対応が必要な項目のアラート表示<br>
                    • チーム生産性推移とタスク完了率のグラフ<br>
                    • メンバー別のパフォーマンス分析<br>
                    • システム状況の監視（サーバー応答時間等）
                </p>
                <p style="color: #999; font-size: 0.9rem; margin-bottom: 1.5rem;">
                    ユーザー管理や詳細な統計情報は<br>左上のハンバーガーメニューからアクセスできます
                </p>
                <button onclick="window.location.href='index-kanban.html'" style="padding: 0.75rem 2rem; background: var(--theme-color, #026aa7); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                    メイン画面に戻る
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 現在のユーザー情報を取得（メイン画面と同じ関数）
        function getCurrentUser() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user) {
                    // セッション期限チェック
                    if (new Date() > new Date(session.expiresAt)) {
                        localStorage.removeItem('currentSession');
                        return {
                            name: null,
                            email: null,
                            role: null,
                            isLoggedIn: false
                        };
                    }
                    return {
                        name: session.user.name,
                        email: session.user.email,
                        role: session.user.role,
                        isLoggedIn: true
                    };
                }
            } catch (error) {
                console.error('セッション取得エラー:', error);
            }
            return {
                name: null,
                email: null,
                role: null,
                isLoggedIn: false
            };
        }
        
        // 認証チェック（リダイレクト用）
        function checkAuthentication() {
            const currentUser = getCurrentUser();
            if (!currentUser.isLoggedIn) {
                window.location.href = 'login.html';
                return null;
            }
            return currentUser;
        }
        
        // ページ読み込み時の初期化
        window.addEventListener('DOMContentLoaded', () => {
            const currentUser = checkAuthentication();
            if (!currentUser) return;
            
            updateProfileInfo(currentUser);
            loadPersonalStats(currentUser);
            
            // 開発者専用機能
            if (currentUser.role === 'developer') {
                document.getElementById('developer-section').style.display = 'block';
            }
            
            // 管理者・開発者のみ管理機能案内を表示
            if (currentUser.role === 'developer' || currentUser.role === 'admin') {
                document.getElementById('admin-section').style.display = 'block';
            }
            
            // URLハッシュが#development-logの場合、機能改善書を自動で開く
            if (window.location.hash === '#development-log' && currentUser.role === 'developer') {
                setTimeout(() => {
                    showDevelopmentLog();
                }, 500);
            }
            
        });
        
        // プロフィール情報の更新
        function updateProfileInfo(user) {
            document.getElementById('profile-avatar').textContent = user.name ? user.name.charAt(0) : '-';
            document.getElementById('profile-name').textContent = user.name || 'ゲストユーザー';
            document.getElementById('profile-email').textContent = user.email || '-';
            
            let roleText = 'ユーザー';
            if (user.role === 'developer') roleText = '開発者';
            else if (user.role === 'admin') roleText = '管理者';
            document.getElementById('profile-role').textContent = roleText;
        }
        
        // 個人詳細統計の読み込み
        function loadPersonalStats(user) {
            try {
                // デフォルトは今週の統計を表示
                calculatePersonalAnalytics(user, 'week');
            } catch (error) {
                console.error('統計読み込みエラー:', error);
            }
        }
        
        // 期間選択ボタンクリック時の処理
        function showPersonalAnalyticsForPeriod(period) {
            const currentUser = checkAuthentication();
            if (!currentUser) return;
            
            // すべてのボタンからactiveクラスを削除
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.style.background = '#e2e8f0';
                btn.style.color = '#333';
            });
            
            // クリックしたボタンにactiveスタイルを適用
            event.target.style.background = '#026aa7';
            event.target.style.color = 'white';
            
            // 期間に応じて分析を再計算
            calculatePersonalAnalytics(currentUser, period);
        }
        
        // 個人統計の計算
        function calculatePersonalAnalytics(user, period = 'all') {
            try {
                const tasks = JSON.parse(localStorage.getItem('salesTasksKanban') || '[]');
                
                // 自分が担当者になっているタスクを抽出
                let myTasks = tasks.filter(task => 
                    task.assignees && task.assignees.includes(user.name)
                );
                
                // 期間フィルター
                const now = new Date();
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                if (period === 'today') {
                    myTasks = myTasks.filter(task => {
                        if (task.createdAt) {
                            const createdDate = new Date(task.createdAt);
                            return createdDate >= startOfToday;
                        }
                        return false;
                    });
                } else if (period === 'week') {
                    const startOfWeek = new Date(startOfToday);
                    startOfWeek.setDate(startOfToday.getDate() - startOfToday.getDay());
                    myTasks = myTasks.filter(task => {
                        if (task.createdAt) {
                            const createdDate = new Date(task.createdAt);
                            return createdDate >= startOfWeek;
                        }
                        return false;
                    });
                } else if (period === 'month') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    myTasks = myTasks.filter(task => {
                        if (task.createdAt) {
                            const createdDate = new Date(task.createdAt);
                            return createdDate >= startOfMonth;
                        }
                        return false;
                    });
                }
                
                // 統計計算
                const totalTasks = myTasks.length;
                const completedTasks = myTasks.filter(task => task.columnId === 'done');
                const pendingTasks = myTasks.filter(task => task.columnId !== 'done' && task.columnId !== 'trash');
                
                // 完了率
                const completionRate = totalTasks > 0 ? Math.round((completedTasks.length / totalTasks) * 100) : 0;
                
                // 期限遵守率計算
                const tasksWithDeadlines = completedTasks.filter(task => task.deadline);
                let onTimeCompletions = 0;
                let totalCompletionTime = 0; // 分単位
                
                tasksWithDeadlines.forEach(task => {
                    const deadline = new Date(task.deadline);
                    // 完了日は更新日時から推定（実際の完了日時がない場合）
                    const completedAt = task.updatedAt ? new Date(task.updatedAt) : new Date();
                    
                    if (completedAt <= deadline) {
                        onTimeCompletions++;
                    }
                    
                    // 平均完了時間計算（作成日から完了日まで）
                    if (task.createdAt) {
                        const createdAt = new Date(task.createdAt);
                        const completionTimeMs = completedAt - createdAt;
                        totalCompletionTime += Math.max(0, completionTimeMs / (1000 * 60 * 60 * 24)); // 日単位
                    }
                });
                
                const deadlineCompliance = tasksWithDeadlines.length > 0 ? 
                    Math.round((onTimeCompletions / tasksWithDeadlines.length) * 100) : 0;
                
                const avgCompletionTime = tasksWithDeadlines.length > 0 ? 
                    (totalCompletionTime / tasksWithDeadlines.length).toFixed(1) : 0;
                
                // UI更新
                document.getElementById('my-total-tasks').textContent = totalTasks;
                document.getElementById('my-completion-rate').textContent = completionRate + '%';
                document.getElementById('my-deadline-compliance').textContent = deadlineCompliance + '%';
                document.getElementById('my-avg-completion-time').textContent = avgCompletionTime + '日';
                
                // 詳細情報を表示
                const detailsDiv = document.getElementById('personal-performance-details');
                detailsDiv.innerHTML = `
                    <h4 style="margin: 0 0 1rem 0; color: #172b4d;">📈 パフォーマンス詳細</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="font-weight: 600; color: #666; margin-bottom: 0.5rem;">タスク状況</div>
                            <div>完了: ${completedTasks.length}件</div>
                            <div>進行中: ${pendingTasks.length}件</div>
                            <div>PJタスク: ${myTasks.filter(t => t.isProjectTask).length}件</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #666; margin-bottom: 0.5rem;">期限管理</div>
                            <div>期限付きタスク: ${tasksWithDeadlines.length}件</div>
                            <div>期限内完了: ${onTimeCompletions}件</div>
                            <div>遅延完了: ${tasksWithDeadlines.length - onTimeCompletions}件</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #666; margin-bottom: 0.5rem;">効率性</div>
                            <div>平均完了時間: ${avgCompletionTime}日</div>
                            <div>期限遵守率: ${deadlineCompliance}%</div>
                            <div>完了率: ${completionRate}%</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('個人統計計算エラー:', error);
            }
        }
        
        // パスワード変更
        function changePassword() {
            const currentUser = checkAuthentication();
            if (!currentUser) return;
            
            const currentPassword = prompt('現在のパスワードを入力してください:');
            if (!currentPassword) return;
            
            // 現在のパスワード確認
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const user = users.find(u => u.email === currentUser.email);
            
            if (!user || user.password !== currentPassword) {
                alert('現在のパスワードが正しくありません');
                return;
            }
            
            const newPassword = prompt('新しいパスワードを入力してください:');
            if (!newPassword || newPassword.length < 4) {
                alert('パスワードは4文字以上で入力してください');
                return;
            }
            
            const confirmPassword = prompt('新しいパスワードを再度入力してください:');
            if (newPassword !== confirmPassword) {
                alert('パスワードが一致しません');
                return;
            }
            
            // パスワード更新
            user.password = newPassword;
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            alert('パスワードが正常に変更されました');
        }
        
        // 機能改善書表示（開発者専用）
        function showDevelopmentLog() {
            // 既存のモーダルがあれば削除
            const existingModal = document.getElementById('developmentLogModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const existingLog = localStorage.getItem('developmentLog') || '';
            
            const logModal = document.createElement('div');
            logModal.id = 'developmentLogModal';
            logModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 2rem;
            `;
            
            logModal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div style="padding: 2rem; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #172b4d;">📝 機能改善書</h2>
                        <button onclick="closeDevelopmentLog()" 
                                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; padding: 0.5rem;">×</button>
                    </div>
                    <div style="padding: 2rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: #666; margin-bottom: 0.5rem;">💡 使用方法</h4>
                            <p style="color: #888; font-size: 0.9rem; line-height: 1.5;">
                                • 要件や改善内容を記録<br>
                                • セッション停止時の状況メモ<br>
                                • 次回開発時の引き継ぎ事項<br>
                                • 機能追加・修正履歴
                            </p>
                        </div>
                        <textarea id="devLogContent" placeholder="開発メモ・要件・改善ログを記入してください..."
                                  style="width: 100%; height: 300px; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; 
                                         font-family: monospace; font-size: 0.9rem; resize: vertical;">${existingLog}</textarea>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="saveDevelopmentLog()" 
                                    style="padding: 0.75rem 1.2rem; background: #026aa7; color: white; border: none; 
                                           border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                                💾 保存
                            </button>
                            <button onclick="addManualDeployRecord()" 
                                    style="padding: 0.75rem 1.2rem; background: #17a2b8; color: white; border: none; 
                                           border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                                🚀 デプロイ記録
                            </button>
                            <button onclick="autoUpdateDeployHistory()" 
                                    style="padding: 0.75rem 1.2rem; background: #20c997; color: white; border: none; 
                                           border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                                🔄 自動更新
                            </button>
                            <button onclick="generateHandoverSummary()" 
                                    style="padding: 0.75rem 1.2rem; background: #fd7e14; color: white; border: none; 
                                           border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                                📋 引き継ぎ
                            </button>
                            <button onclick="exportDevelopmentLog()" 
                                    style="padding: 0.75rem 1.2rem; background: #28a745; color: white; border: none; 
                                           border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                                📄 エクスポート
                            </button>
                            <button onclick="clearDevelopmentLog()" 
                                    style="padding: 0.75rem 1.2rem; background: #dc3545; color: white; border: none; 
                                           border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                                🗑️ クリア
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(logModal);
        }
        
        // 機能改善書を閉じる
        function closeDevelopmentLog() {
            const modal = document.getElementById('developmentLogModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 開発ログ保存
        function saveDevelopmentLog() {
            const content = document.getElementById('devLogContent').value;
            const timestamp = new Date().toLocaleString('ja-JP');
            const logEntry = `[${timestamp}] 手動保存\n${content}\n\n`;
            
            localStorage.setItem('developmentLog', content);
            localStorage.setItem('developmentLogHistory', 
                (localStorage.getItem('developmentLogHistory') || '') + logEntry
            );
            
            alert('📝 機能改善書を保存しました');
        }
        
        // デプロイ記録の自動追加
        function addDeploymentRecord(commitMsg, remainingTasks) {
            const timestamp = new Date().toLocaleString('ja-JP');
            const deployRecord = `
=== 🚀 デプロイ記録 [${timestamp}] ===
コミット内容: ${commitMsg}

残りタスク:
${remainingTasks}

次回開発予定:
- (ここに次回の開発予定を記入)

---

`;
            
            const currentHistory = localStorage.getItem('developmentLogHistory') || '';
            localStorage.setItem('developmentLogHistory', deployRecord + currentHistory);
            
            // 機能改善書にも自動更新
            const currentLog = localStorage.getItem('developmentLog') || '';
            const updatedLog = `最新デプロイ: ${timestamp}\n${commitMsg}\n\n${currentLog}`;
            localStorage.setItem('developmentLog', updatedLog);
        }
        
        // デプロイ記録手動追加
        function addManualDeployRecord() {
            const commitMsg = prompt('今回のデプロイ内容を入力してください:');
            if (!commitMsg) return;
            
            const remainingTasks = prompt('残りタスクを入力してください (改行は \\n で区切る):');
            if (remainingTasks === null) return;
            
            const formattedTasks = remainingTasks.replace(/\\n/g, '\n- ');
            addDeploymentRecord(commitMsg, '- ' + formattedTasks);
            
            alert('📝 デプロイ記録を追加しました');
            
            // 機能改善書が開いている場合は更新
            const logContent = document.getElementById('devLogContent');
            if (logContent) {
                logContent.value = localStorage.getItem('developmentLog') || '';
            }
        }
        
        // 自動デプロイ履歴更新機能
        function autoUpdateDeployHistory() {
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            
            // 現在の要件リスト（更新すべき項目を定義）
            const currentRequirements = [
                '次のセッション向け改善項目を随時追記',
                'ユーザビリティ向上案の検討',
                'パフォーマンス最適化の実施',
                'セキュリティ強化策の検討',
                'レスポンシブデザインの改善'
            ];
            
            // 最新のデプロイ内容（この関数が呼ばれた文脈での実装内容）
            const latestDeployment = `⏰ OCR期限設定改善完了 - ${timestamp}`;
            const remainingItems = currentRequirements.map(item => `- ${item}`).join('\n');
            
            // デプロイ記録を追加
            addDeploymentRecord(latestDeployment, remainingItems);
            
            // 機能改善書の内容を自動更新
            const autoUpdateContent = `
=== 🔄 自動更新 ${timestamp} ===
✅ 最新デプロイ: ${latestDeployment}

📋 現在の残り要件:
${remainingItems}

💡 次回セッションで対応予定:
- ユーザーからのフィードバック対応
- 新機能要求への対応
- バグ修正・改善

=== 更新完了 ===

`;
            
            // 既存の内容と結合
            const existingLog = localStorage.getItem('developmentLog') || '';
            const updatedLog = autoUpdateContent + existingLog;
            localStorage.setItem('developmentLog', updatedLog);
            
            // 画面に反映
            const logContent = document.getElementById('devLogContent');
            if (logContent) {
                logContent.value = updatedLog;
            }
            
            alert('🔄 デプロイ履歴と要件を自動更新しました！\n\n新しい要件や改善事項があれば追記してください。');
        }
        
        // 引き継ぎ用サマリー生成
        function generateHandoverSummary() {
            const timestamp = new Date().toLocaleString('ja-JP');
            const history = localStorage.getItem('developmentLogHistory') || '';
            const currentLog = localStorage.getItem('developmentLog') || '';
            
            const summary = `# 営業タスク管理ツール - 開発引き継ぎサマリー
生成日時: ${timestamp}

## 🏗️ プロジェクト概要
- URL: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/index-kanban.html  
- 技術: HTML/CSS/JavaScript (Vanilla), Netlify, LocalStorage
- 権限: developer(全権限) > admin(管理) > user(基本)

## 📦 主要機能（実装済み）
✅ タスク管理 (Kanbanボード方式)
✅ PJタスク管理 (承認フロー付き)
✅ ユーザー権限管理 (3段階)
✅ 詳細統計・分析機能
✅ OCR文字認識 (Tesseract.js)
✅ デスクトップ通知
✅ ハンバーガーメニュー
✅ マイページ (個人統計・パスワード変更)
✅ 機能改善書 (開発者専用)

## 🔧 最近の実装内容
${history ? history.split('===').slice(0, 3).join('===') : '記録なし'}

## 📝 現在の開発メモ
${currentLog || '記録なし'}

## 🚀 次回開発者への指示
1. この内容をコピーして機能改善書に貼り付け
2. 新しい要件や修正が必要な箇所があれば追記
3. デプロイ時は「🚀 デプロイ記録」ボタンで履歴を更新

## 🔑 重要なデータ構造
- salesTasksKanban: メインタスクデータ
- systemUsers: ユーザー情報
- currentSession: ログインセッション  
- developmentLog: 開発メモ

## 🎯 推奨開発フロー
1. 機能改善書で現状確認
2. 要件・改善点をメモに記録
3. 実装・テスト
4. デプロイ記録で履歴更新
5. 次回開発予定を記載`;

            // クリップボードにコピー
            navigator.clipboard.writeText(summary).then(() => {
                alert('📋 引き継ぎサマリーをクリップボードにコピーしました！\\n\\n次の開発者がスムーズに継続できます。');
            }).catch(() => {
                // クリップボードが使えない場合はダウンロード
                const blob = new Blob([summary], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = \`引き継ぎサマリー_\${timestamp.replace(/[:/]/g, '-')}.txt\`;
                a.click();
                URL.revokeObjectURL(url);
                alert('📋 引き継ぎサマリーをダウンロードしました！');
            });
        }
        
        // 開発ログエクスポート
        function exportDevelopmentLog() {
            const content = document.getElementById('devLogContent').value;
            const history = localStorage.getItem('developmentLogHistory') || '';
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            
            const exportData = `# 機能改善書 - エクスポート\n生成日時: ${new Date().toLocaleString('ja-JP')}\n\n## 現在の内容\n${content}\n\n## 履歴\n${history}`;
            
            const blob = new Blob([exportData], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `機能改善書_${timestamp}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // 開発ログクリア
        function clearDevelopmentLog() {
            if (confirm('機能改善書をクリアしますか？\n（履歴は保持されます）')) {
                document.getElementById('devLogContent').value = '';
                localStorage.removeItem('developmentLog');
                alert('🗑️ 機能改善書をクリアしました');
            }
        }
        
        // システム情報表示（開発者専用）
        function showSystemInfo() {
            const deployInfo = `
📊 システム情報

🏗️ プロジェクト構成:
• フロントエンド: HTML/CSS/JavaScript (Vanilla)
• デプロイ: Netlify (GitHub連携)  
• ストレージ: LocalStorage
• 認証: セッション管理

🔧 技術スタック:
• Chart.js (統計グラフ)
• Tesseract.js (OCR機能)
• Material Icons
• Web Notifications API

🌐 デプロイ情報:
• URL: https://stellar-biscochitos-e19cb4.netlify.app/
• メイン: /sales-task-core/index-kanban.html
• リポジトリ: GitHub自動デプロイ

📦 主要機能:
• タスク管理 (Kanban方式)
• PJタスク管理
• ユーザー権限管理 (developer/admin/user)
• 詳細統計・分析
• OCR文字認識
• 通知システム

🔑 権限レベル:
• developer(3): 全権限 + 開発機能
• admin(2): 管理機能 + ユーザー管理
• user(1): 基本機能のみ

💾 データ構造:
• salesTasksKanban: タスクデータ
• systemUsers: ユーザー情報
• currentSession: ログインセッション
• developmentLog: 開発メモ

最終更新: ${new Date().toLocaleString('ja-JP')}
            `;
            
            alert(deployInfo);
        }
    </script>
</body>
</html>