<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿®æ­£ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .success {
            background: #4CAF50;
            color: white;
        }
        .danger {
            background: #f44336;
            color: white;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿®æ­£ãƒ„ãƒ¼ãƒ«</h1>
    
    <h2>ç¾åœ¨ã®çŠ¶æ…‹</h2>
    <pre id="current-state"></pre>
    
    <h2>ä¿®æ­£ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
    
    <button onclick="clearOldSession()" class="danger">
        1. å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
    </button>
    
    <button onclick="fixCurrentSession()" class="success">
        2. ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£ï¼ˆåŠ è—¤ç´”ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®å ´åˆï¼‰
    </button>
    
    <button onclick="showAllData()">
        3. å…¨ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    </button>
    
    <button onclick="completeReset()" class="danger">
        4. å®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰
    </button>
    
    <h2>ãƒ­ã‚°</h2>
    <pre id="log"></pre>
    
    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            logEl.textContent += message + '\n';
            console.log(message);
        }
        
        function showCurrentState() {
            const state = {
                currentSession: JSON.parse(localStorage.getItem('currentSession') || 'null'),
                currentUser: localStorage.getItem('currentUser'),
                lastLoginUser: localStorage.getItem('lastLoginUser'),
                systemUsers: JSON.parse(localStorage.getItem('systemUsers') || '[]').map(u => ({
                    name: u.name,
                    email: u.email,
                    role: u.role
                }))
            };
            
            document.getElementById('current-state').textContent = JSON.stringify(state, null, 2);
        }
        
        function clearOldSession() {
            log('ğŸ—‘ï¸ å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ä¸­...');
            
            // é‚¨ä¸­å¤©çœŸã®ç—•è·¡ã‚’å‰Šé™¤
            const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (session && session.user && session.user.name === 'é‚¨ä¸­å¤©çœŸ') {
                localStorage.removeItem('currentSession');
                log('âœ… é‚¨ä¸­å¤©çœŸã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤');
            }
            
            // currentUserã‚‚ç¢ºèª
            if (localStorage.getItem('currentUser') === 'é‚¨ä¸­å¤©çœŸ') {
                localStorage.removeItem('currentUser');
                log('âœ… currentUserã‹ã‚‰é‚¨ä¸­å¤©çœŸã‚’å‰Šé™¤');
            }
            
            // lastLoginUserã‚‚ç¢ºèª
            if (localStorage.getItem('lastLoginUser') === 'é‚¨ä¸­å¤©çœŸ') {
                localStorage.removeItem('lastLoginUser');
                log('âœ… lastLoginUserã‹ã‚‰é‚¨ä¸­å¤©çœŸã‚’å‰Šé™¤');
            }
            
            showCurrentState();
            log('ğŸ¯ å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªã‚¢å®Œäº†');
        }
        
        function fixCurrentSession() {
            log('ğŸ”§ ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£ä¸­...');
            
            // Firebaseã®èªè¨¼æƒ…å ±ã‚’å–å¾—
            const firebaseUser = window.firebaseAuth?.currentUser;
            if (firebaseUser) {
                log(`ğŸ“§ Firebaseèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${firebaseUser.email}`);
                
                // systemUsersã‹ã‚‰æ­£ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const correctUser = systemUsers.find(u => u.email === firebaseUser.email);
                
                if (correctUser) {
                    // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
                    const newSession = {
                        user: {
                            id: correctUser.id,
                            name: correctUser.name,
                            email: correctUser.email,
                            role: correctUser.role,
                            department: correctUser.department
                        },
                        loginTime: new Date().toISOString(),
                        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                    };
                    
                    localStorage.setItem('currentSession', JSON.stringify(newSession));
                    localStorage.setItem('currentUser', correctUser.name);
                    
                    log(`âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£: ${correctUser.name} (${correctUser.role})`);
                } else {
                    log(`âŒ systemUsersã«${firebaseUser.email}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }
            } else {
                log('âŒ Firebaseèªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                log('ğŸ’¡ ã¾ãšãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
            }
            
            showCurrentState();
        }
        
        function showAllData() {
            log('\nğŸ“Š å…¨LocalStorageãƒ‡ãƒ¼ã‚¿:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('user') || key.includes('User') || key.includes('session') || key.includes('Session')) {
                    const value = localStorage.getItem(key);
                    log(`${key}: ${value.substring(0, 100)}...`);
                }
            }
        }
        
        function completeReset() {
            if (confirm('ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('currentSession');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('lastLoginUser');
                log('âœ… å®Œå…¨ãƒªã‚»ãƒƒãƒˆå®Œäº† - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        // åˆæœŸè¡¨ç¤º
        showCurrentState();
        log('ğŸš€ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿®æ­£ãƒ„ãƒ¼ãƒ«èµ·å‹•');
        
        // Firebaseèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
        setTimeout(() => {
            if (window.firebaseAuth?.currentUser) {
                log(`ğŸ”¥ Firebaseèªè¨¼æ¸ˆã¿: ${window.firebaseAuth.currentUser.email}`);
            } else {
                log('âš ï¸ Firebaseæœªèªè¨¼');
            }
        }, 1000);
    </script>
    
    <!-- Firebase -->
    <script type="module" src="firebase-config.js"></script>
</body>
</html>