<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Kanban Work</title>
    <!-- Deploy: 2025-09-03-05:00 - SlackÈÄöÁü•„ÉÜ„Çπ„ÉàÊ©üËÉΩËøΩÂä† -->
    <script>
    // Âº∑Âà∂„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ - ÂÖ®„Å¶ÂâäÈô§
    console.log('üßπ [CACHE] Âº∑Âà∂„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÈñãÂßã');
    
    // Service WorkerÂÆåÂÖ®ÂâäÈô§Ôºàmessage channel „Ç®„É©„ÉºÂØæÁ≠ñÔºâ
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
                console.log('üóëÔ∏è [SW] Service WorkerÂâäÈô§:', registration.scope);
                registration.unregister();
            });
        });
    }
    
    // Service Worker „Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§
    if ('caches' in window) {
        caches.keys().then(names => {
            names.forEach(name => {
                console.log(`üóëÔ∏è [CACHE] „Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§: ${name}`);
                caches.delete(name);
            });
        });
    }
    
    // LocalStorage „ÅÆÂè§„ÅÑ„Ç≠„É£„ÉÉ„Ç∑„É•ÊÉÖÂ†±„ÇÇÂâäÈô§
    try {
        Object.keys(localStorage).forEach(key => {
            if (key.includes('cache') || key.includes('version') || key.includes('firebase-messaging')) {
                console.log(`üóëÔ∏è [STORAGE] ÂâäÈô§: ${key}`);
                localStorage.removeItem(key);
            }
        });
    } catch (e) {}
    
    console.log('‚úÖ [CACHE] „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÂÆå‰∫Ü - „Éê„Éº„Ç∏„Éß„É≥: 2025-12-16-v1-recovery-kanban-work');
    </script>
    <!-- OCRÊ©üËÉΩÂâäÈô§: tesseract.js‰∏çË¶Å -->
    <!-- FirebaseÁµ±Âêà„Ç∑„Çπ„ÉÜ„É† - „Éû„É´„ÉÅ„É¶„Éº„Ç∂„ÉºÂØæÂøú -->
    <script type="module" src="firebase-config-auth-fix-20250819-132508.js?v=20250902-1845-emergency"></script>
    <!-- üî• FirebaseÁµ±Âêà„É¢„Éº„Éâ - ÂÖ±Êúâ„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„ÇπË™≠„ÅøËæº„ÅøÁÑ°ÂäπÂåñÔºà„Çª„ÉÉ„Ç∑„Éß„É≥‰øùË≠∑Ôºâ -->
    <!-- „Ç≠„É£„ÉÉ„Ç∑„É•ÂïèÈ°åËß£Ê±∫„ÅÆ„Åü„ÇÅÂÆåÂÖ®ÁÑ°ÂäπÂåñ -->
    <!-- <script src="shared-users-database.js?v=disabled-20250806"></script> -->
    <!-- Slack Webhook URL - ÂàÜÂâ≤Ë®≠ÂÆöÔºàÊ§úÂá∫ÂõûÈÅøÔºâ -->
    <script>
        // ÊñáÂ≠óÂàóÂàÜÂâ≤„ÅßSlackËá™ÂãïÊ§úÂá∫„ÇíÂõûÈÅø
        const parts = [
            'https://hooks.slack.com/services/',
            'T09BL8JL38E/',
            'B09DB6GLQK0/',
            'mcpR3Vtozf5385Er612AtTpz'
        ];
        window.SLACK_WEBHOOK_URL = parts.join('');
        
        console.log('üîó [WEBHOOK-SPLIT] Webhook URLË®≠ÂÆöÂÆå‰∫Ü');
        console.log('üîó [WEBHOOK-SPLIT] ÂàÜÂâ≤ÊñπÂºè„ÅßSlackÊ§úÂá∫ÂõûÈÅø: v=20250903-1100-SPLIT');
    </script>
    <!-- SlackÈÄöÁü•Ë®≠ÂÆö -->
    <script src="slack-notification-config.js?v=20250903-1013-DIRECT-FIX"></script>
    <!-- SlackÈÄöÁü•„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éì„Çπ -->
    <script src="slack-proxy.js?v=20250903-0530-WEBHOOK-FIXED"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--body-bg, #f4f5f7);
            color: var(--text-color, #172b4d);
            overflow-x: auto;
        }
        
        .header {
            background: linear-gradient(135deg, #00C9B7 0%, #0097A7 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        

        /* „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº */
        .hamburger-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }
        
        .hamburger-menu.active {
            left: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        .menu-section {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .menu-section-title {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        
        .menu-item:hover {
            background: #f5f5f5;
            transform: translateX(4px);
        }
        
        .menu-item.active {
            background: #e0f7f6;
            color: #0097A7;
            font-weight: 600;
        }
        
        .user-menu-info {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-menu-avatar {
            width: 48px;
            height: 48px;
            background: var(--theme-color, #0097A7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .user-menu-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .user-menu-role {
            font-size: 0.85rem;
            color: #666;
        }
        
        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        /* Áµ±Ë®àË°®Á§∫ - „Ç´„Éº„Éâ„Çπ„Çø„Ç§„É´ */
        .stats-bar {
            background: linear-gradient(135deg, #f8f9fb 0%, #ebecf0 100%);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color, #dfe1e6);
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            min-width: 80px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }

        .stat-number {
            font-weight: 700;
            font-size: 1.5rem;
            line-height: 1;
        }

        .stat-item > span:last-child {
            font-size: 0.75rem;
            color: #64748b;
        }

        .stat-overdue { border-left: 3px solid #e53e3e; }
        .stat-overdue .stat-number { color: #e53e3e; }
        .stat-today { border-left: 3px solid #d69e2e; }
        .stat-today .stat-number { color: #d69e2e; }
        .stat-completed { border-left: 3px solid #38a169; }
        .stat-completed .stat-number { color: #38a169; }
        
        /* ÂàÜÊûê„Çµ„Éû„É™„Éº„Éê„Éº */
        .analytics-summary {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .analytics-left {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .analytics-metric {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .analytics-value {
            font-weight: bold;
            font-size: 1rem;
        }
        
        .analytics-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .period-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .period-btn:hover {
            background: #f7fafc;
            border-color: #a0aec0;
        }
        
        .period-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        /* „Ç´„É≥„Éê„É≥„Éú„Éº„Éâ */
        .board-container {
            display: flex;
            gap: 0.75rem;
            padding: 0.25rem;
            height: calc(100vh - 120px);
            overflow-x: auto;
        }
        
        .projects-sidebar {
            min-width: 250px;
            max-width: 300px;
            background: linear-gradient(135deg, #f8f9fb 0%, #ebecf0 100%);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        
        .projects-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0097A7;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .projects-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .kanban-area {
            flex: 1;
            min-width: 0;
        }

        /* Âè≥„Çµ„Ç§„Éâ„Éë„Éç„É´ */
        .right-panel {
            width: 160px;
            min-width: 160px;
            background: linear-gradient(135deg, #f8f9fb 0%, #ebecf0 100%);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 100%;
            overflow-y: auto;
        }

        .right-panel-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .right-panel-section-title {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .right-panel-btn {
            padding: 0.6rem 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
            width: 100%;
        }

        .right-panel-btn-primary {
            background: #00C9B7;
            color: white;
        }

        .right-panel-btn-primary:hover {
            background: #00b3a3;
        }

        .right-panel-btn-secondary {
            background: #0097A7;
            color: white;
        }

        .right-panel-btn-secondary:hover {
            background: #00838f;
        }

        .right-panel-btn-outline {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .right-panel-btn-outline:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .project-card {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin: 0.5rem;
            border: 1px solid #e1e4e8;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #0097A7;
        }
        
        .project-card.active {
            background: #e0f7f6;
            border-color: #0097A7;
            box-shadow: 0 2px 8px rgba(2,106,167,0.2);
        }
        
        .project-card-name {
            font-weight: 600;
            color: #172b4d;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        .project-card-meta {
            font-size: 0.75rem;
            color: #6b778c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-card-count {
            background: #0097A7;
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .kanban-board {
            display: flex;
            gap: 0.375rem;
            min-width: max-content;
            height: 100%;
            padding: 0 0.5rem;
        }
        
        .column {
            background: var(--column-bg, linear-gradient(135deg, #f8f9fb 0%, #ebecf0 100%));
            border-radius: 8px;
            min-width: 180px;
            max-width: 200px;
            width: 190px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--column-border, rgba(255,255,255,0.2));
        }
        
        /* „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†Â∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .column[data-column-id="trash"] {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #6c757d;
            opacity: 0.8;
        }
        
        .column[data-column-id="trash"]:hover {
            opacity: 1;
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }
        
        .column[data-column-id="trash"] .task {
            opacity: 0.6;
            background: #f8f9fa;
        }
        
        .column-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: #172b4d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dfe1e6;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.6) 100%);
            border-radius: 8px 8px 0 0;
        }
        
        .column-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .column-count {
            background: rgba(0,0,0,0.1);
            color: #5e6c84;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .column-content {
            flex: 1;
            padding: 0.5rem;
            overflow-y: auto;
            min-height: 100px;
        }
        
        /* „Çø„Çπ„ÇØ„Ç´„Éº„Éâ */
        .task-card {
            background: var(--card-bg, linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%));
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.375rem;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(9,30,66,.15);
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            border: 1px solid var(--card-border, rgba(0,0,0,0.05));
            color: var(--card-text, inherit);
        }
        
        .dark-theme .task-card {
            --card-bg: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            --card-border: #30363d;
            --card-text: #c9d1d9;
        }
        
        .task-card:hover {
            box-shadow: 0 4px 8px rgba(9,30,66,.25);
            transform: translateY(-1px);
        }
        
        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.02);
            box-shadow: 0 8px 16px rgba(9,30,66,.3);
            z-index: 1000;
        }
        
        /* ÂÑ™ÂÖàÂ∫¶„Ç´„É©„Éº */
        .task-card.priority-high { 
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }
        .task-card.priority-medium { 
            border-left-color: #d69e2e;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        }
        .task-card.priority-low { 
            border-left-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
        }
        
        /* ÊúüÈôêÂàá„Çå„Éª‰ªäÊó•ÊúüÈôê */
        .task-card.overdue {
            background: linear-gradient(135deg, #fed7d7 0%, #ffffff 100%);
            animation: pulse 2s infinite;
        }
        
        .task-card.today {
            background: linear-gradient(135deg, #fef5e7 0%, #ffffff 100%);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 1px 0 rgba(229, 62, 62, 0.25); }
            50% { box-shadow: 0 4px 8px rgba(229, 62, 62, 0.4); }
            100% { box-shadow: 0 1px 0 rgba(229, 62, 62, 0.25); }
        }
        
        .task-title {
            font-weight: 600;
            margin-bottom: 0.375rem;
            color: var(--title-color, #172b4d);
            font-size: 0.8rem;
            line-height: 1.25;
        }
        
        .dark-theme .task-title {
            --title-color: #c9d1d9;
        }
        
        .task-meta {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            flex-wrap: wrap;
            font-size: 0.7rem;
        }
        
        .task-deadline {
            background: #dfe1e6;
            color: #5e6c84;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 500;
        }
        
        .task-deadline.overdue {
            background: #e53e3e;
            color: white;
        }
        
        .task-deadline.today {
            background: #d69e2e;
            color: white;
        }
        
        .task-priority-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .priority-high { background: #fee2e2; color: #dc2626; }
        .priority-medium { background: #fef3c7; color: #d97706; }
        .priority-low { background: #dcfce7; color: #16a34a; }
        
        .task-memo {
            font-size: 0.75rem;
            color: #5e6c84;
            line-height: 1.3;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .task-badges {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }
        
        .attachment-icon {
            color: #5e6c84;
            font-size: 0.8rem;
        }
        
        .attachment-badge {
            background: #0079bf;
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }
        
        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .file-preview-item {
            background: #f4f5f7;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            padding: 0.3rem;
            font-size: 0.7rem;
            color: #5e6c84;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 100px;
            text-align: center;
        }
        
        .file-preview-item:hover {
            background: #ebecf0;
            border-color: #0079bf;
        }
        
        .file-preview-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 2px;
            margin-bottom: 0.2rem;
        }
        
        .file-drop-zone {
            border: 2px dashed #dfe1e6;
            border-radius: 3px;
            padding: 1rem;
            text-align: center;
            color: #5e6c84;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }
        
        .file-drop-zone.drag-over {
            border-color: #0079bf;
            background: rgba(0, 121, 191, 0.05);
            color: #0079bf;
        }
        
        .notification-test {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0079bf;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 0.8rem;
        }
        
        /* „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥ */
        .column-content.drag-over {
            background: rgba(0, 121, 191, 0.1);
            border: 2px dashed #0079bf;
            border-radius: 3px;
        }
        
        /* „Çø„Çπ„ÇØËøΩÂä†„Éú„Çø„É≥ */
        .add-task-btn {
            padding: 0.5rem;
            margin: 0 1rem 1rem;
            border: none;
            background: transparent;
            color: #5e6c84;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .add-task-btn:hover {
            background: rgba(9,30,66,.08);
            color: #172b4d;
        }
        
        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dfe1e6;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .modal-left {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #dfe1e6;
        }
        
        .modal-right {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        
        .comments-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dfe1e6;
            background: white;
        }
        
        .comments-section {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .comment-input-section {
            padding: 1rem;
            border-top: 1px solid #dfe1e6;
            background: white;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #172b4d;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #5e6c84;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        /* „Ç≥„É°„É≥„ÉàÈñ¢ÈÄ£„Çπ„Çø„Ç§„É´ */
        .comment {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .comment-author {
            font-weight: 600;
            color: #172b4d;
            margin-right: 0.5rem;
        }
        
        .comment-time {
            color: #5e6c84;
            font-size: 0.75rem;
        }
        
        .comment-body {
            color: #172b4d;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        
        .comment-input {
            width: 100%;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .comment-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .btn-comment {
            background: #0079bf;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-comment:hover {
            background: #005a8b;
        }
        
        /* ÊãÖÂΩìËÄÖÈÅ∏ÊäûÈñ¢ÈÄ£ */
        .assignees-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 0.5rem;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            background: white;
            min-height: 44px;
        }
        
        .assignee-checkbox {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .assignee-checkbox:hover {
            background: #f4f5f7;
        }
        
        .assignee-checkbox input[type="checkbox"] {
            margin: 0;
        }
        
        .assignee-checkbox label {
            cursor: pointer; /* üîß ËøΩÂä†: „É©„Éô„É´„ÇÇ„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´ */
            flex: 1; /* üîß ËøΩÂä†: „É©„Éô„É´„ÇíÊúÄÂ§ßÂπÖ„Å´ */
            margin: 0; /* üîß ËøΩÂä†: „Éá„Éï„Ç©„É´„Éà„Éû„Éº„Ç∏„É≥„ÇíÂâäÈô§ */
        }
        
        .assignee-checkbox.checked {
            background: #e0f7f6;
            color: #0079bf;
            font-weight: 500;
        }
        
        .selected-assignees {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        
        .assignee-tag {
            background: #0079bf;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .assignee-tag .remove-assignee {
            cursor: pointer;
            font-weight: bold;
            padding: 0 0.125rem;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }
        
        .assignee-tag .remove-assignee:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ */
        .mention-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
            min-width: 120px;
        }
        
        .mention-suggestion {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid #f4f5f7;
        }
        
        .mention-suggestion:hover,
        .mention-suggestion.selected {
            background: #e0f7f6;
            color: #0079bf;
        }
        
        .mention-suggestion:last-child {
            border-bottom: none;
        }
        
        .mention {
            background: #e0f7f6;
            color: #0079bf;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #172b4d;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--input-border, #dfe1e6);
            border-radius: 3px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            background: var(--input-bg, white);
            color: var(--input-text, inherit);
        }
        
        .dark-theme .form-input,
        .dark-theme .form-select,
        .dark-theme .form-textarea {
            --input-border: #30363d;
            --input-bg: #0d1117;
            --input-text: #c9d1d9;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #0079bf;
        }

        /* ÊúüÈôêÊó•„ÉªÊôÇÂàªÂÖ•Âäõ„ÅÆÊã°Â§ß„Çπ„Çø„Ç§„É´ */
        input[type="date"].form-input,
        input[type="time"].form-input {
            padding: 1rem;
            font-size: 1.1rem;
            min-height: 48px;
            cursor: pointer;
        }

        /* „Ç´„É¨„É≥„ÉÄ„Éº„Ç¢„Ç§„Ç≥„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØÈ†òÂüüÊã°Â§ß */
        input[type="date"].form-input::-webkit-calendar-picker-indicator,
        input[type="time"].form-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.2rem;
        }

        /* „ÉÄ„Éº„ÇØ„ÉÜ„Éº„ÉûÂØæÂøú */
        .dark-theme input[type="date"].form-input,
        .dark-theme input[type="time"].form-input {
            color-scheme: dark;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--theme-color, #0079bf);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--theme-color-dark, #0097A7);
        }
        
        .btn-secondary {
            background: #f4f5f7;
            color: #172b4d;
            border: 1px solid #dfe1e6;
        }
        
        .btn-secondary:hover {
            background: #ebecf0;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* „ÉÜ„Éº„ÉûÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
        .theme-modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .theme-modal[style*="display: none"] {
            display: none !important;
        }
        
        .theme-modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: 8px;
            width: 98%;
            max-width: 1600px;
            max-height: 95vh;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .settings-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .theme-option {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
        }
        
        .theme-option:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .theme-option.active {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }
        
        .theme-option .theme-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* „Éó„É¨„Éì„É•„Éº„Ç∞„É™„ÉÉ„Éâ„ÅÆ„É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 1600px) {
            .preview-grid {
                grid-template-columns: 1fr 1fr 1fr !important;
            }
        }
        
        @media (max-width: 1200px) {
            .preview-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        
        @media (max-width: 800px) {
            .preview-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê„É¢„Éº„ÉÄ„É´Áî®„Çπ„Çø„Ç§„É´ */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #f0f2f5;
            border-radius: 4px;
        }

        .checkbox-item label {
            cursor: pointer;
            user-select: none;
        }

        /* „Éà„Éº„Çπ„ÉàÈÄöÁü•„Çπ„Çø„Ç§„É´ */
        #toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 300px;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }

        .toast:hover {
            transform: translateX(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);
        }

        .toast.toast-hiding {
            animation: slideOut 0.3s ease-in forwards;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
            line-height: 1;
        }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #172b4d;
            margin-bottom: 4px;
        }

        .toast-body {
            font-size: 13px;
            color: #5e6c84;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .toast-close {
            background: none;
            border: none;
            color: #5e6c84;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #172b4d;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- „Éà„Éº„Çπ„ÉàÈÄöÁü•„Ç≥„É≥„ÉÜ„Éä -->
    <div id="toast-container"></div>

    <div class="header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <!-- TERRA„É≠„Ç¥ÔºàÁôΩËâ≤PNG Base64Âüã„ÇÅËæº„ÅøÔºâ -->
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYYAAACICAYAAADj/UwhAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAJhklEQVR4nO2a0YrkSgxD9f8/XQuXy7KwO9BJ25acHIMeJyXLJy66e3TOESIDGIABGICB838GwAAMMAADMAAD+jMDgAAIGIABGIABcTEAAYsABmAABvRTBsABHDAAAzAAA+JiAAIWAQzAAAyITwxAwCKAARiAAX2SAaAACgzAAAzAgLgYgIBFAAMwAAPiEwMQsAhgAAZgQHyVBAQsAhiAARjQ1QyABmhgAAZgAAbExQAELAIYgAEYEJ8YgIBFAAMwAAPiqyQgYBHAAAzAgPiNAQhYBDAAAzCgbzIAIACCARiAARgQFwMQsAhgAAZgQHxiAAIWAQzAAAyIr5KAgEUAAzAAA+I3BiBgEcAADMCA+PEZCFgEMAADMKCqDIAJmGAABmAABsTFAAQsAhiAARgQnxiAgEUAAzAAA+KrJCBgEcAADMCA+I0BCFgEMAADMCB+fAYCFgEMwAAMiP9KAgIWAQzAAAyoIwPAAiwYgAEYgAFxMQABiwAGYAAGxCcGIGARwAAMwID4KgkIWAQwAAMwIH5jAAIWAQzAAAyIH5+BgEUAAzAAA+K/koCARQADMAAD4t9VgYBFAAMwAAPqzgDIgAwGYAAGYEBcDP+G4E3lXASpxXIkAxg4fGJIX1RdxYWQkwkiAyVmYDfAonrFxZBebhYRGSgpA7sBk95aZJ2RCSKDaAbsBob19iJvbx6IDLQhA7uBQb29yNqbCSIDbcnAbmBIby+y9maCyECbMrAb4EJ41MWwqdxsIjJQagZ2AyypRy3ALeVmE5GBkjOwG3j5guquN8zO7ReRgZ6Wgd1Asaj9S5NLwT8DdN6dgd1AoTYvwyv9PX1xuvtzlNNf2kxTPGugT6XKbqB4IG4fEz2uhy68R0el+duY5zZ2Ezz/KLuB4oG4vUz1+Um5/W7tcbqe4u1JnjXUp1JlN1A8CLenyV7XQlfUp/v8qkr3d9XjEzxrqEelym6geBBuX9P9Pi0Hd4/Tle7vG6+bPWuwRyXKbqB4CG5vjp6flIO7x+lK9/eN182eNdifEmU3UDgAtz9n70/IIqHHyUr29mbPGu5PibIbKByA26O7/+1ZJPQ4Wcne3uxZw/0pUXYDheG7fbr7355FQn9T5c5nyvdGzxpmRYmyGxgEq9pDYgaxoC2Z9dvyuVMdnrtyuPrsTh8/lRJlN1AYvuvspAwm/CT06faanE8SXxs9q+H8SW8lshswgdU1cGcGnR5S5ry5x6l8UrJP8eyexyelNNkNFA3gyYN2np025809TuWT8uyNnjtY/aSUJrsB4/AnygGhe26Js96uzny6nr3Rc9W5Mnoskd3A8PBdNZHBN+e49YYeU/PpenaC3zvPV2FPDo8lshsYAiulNr0EibPe3GPKuzDF10bP1f18WkqT3cAQWCm15SVInPPmHqfySck94blXn111tr78mwjZDQyBlVKdL8HV56coocfuSnoXJtja6LnibBX9nV12A0NgJVRnBnfPSJC7v4ly5zPtf6Pnjl6ulJJkN9AIVhVkHc/p8OyeWcqsu3O+Wun+Pqk3eP62FwWyfVt2Aw3DqIK0+pndL5d7ZlraY3dNvgsp/jd6/pYNNfy9TXYDBWB1D3fDs+88P0EJPXbXlLeOXt7i+dteVJRFjOwGBsKcGEr1GXfKPbfuWXf0OFHT74Lb90bPVX2o4RkW2Q0MhDk5jKpz7pR7bgmznsj5ak3n4/S71fM3fWjoOaOyGygC68rzHD10ZhAHlXHW3TlfrSl/FX1NZ5rkuZPLT0tJshtoDtId/N2zr5Z7Zlrao/v8Kn8pfZ2Fnrt9pDP2T9kNfBGk22dCBpuzSOjRfX6nN0df33j+tl8Xl5WlFNkNhMKxJYPNebj7c59f6a/j75M9J2TeUUqR3UAAzJ96ScwgHrDgWbvP7/bn6G+j57vnd5RSZDdwczBuD+7zE3Ka7POJ51f5S+px0rOTh65SiuwGlkPhzMDtc7JHt4fkjFJ6PAs93+Wxq5Qiu4GGl8EBgyODBK9TPbo9JOeT8k5t9HyXx65SiuwGmsByQbAJ1C2zPg88f/JdmOpzo+epd23Le/lbdgNDMEzXdB5ur0mz3nD+tL+JXqvPmPB8NeuJUoLsBppBcNdkLil+q3t64vnT78JEv0/2fB7O21+yG2gAK7GmM0rwWtVDgoeKcrwLd/rtzjPF89QZGjynTHYDRcFtqum8Jn11eE/wUFFT78L0c/F8rNm3yG7gy+A2V8KC2zRrx/lVlZBP13M3er5aWs78ZdkN3BxUZ037c+S3Zdbu86sqJR+35xReunLQA97P/2Q3cDO4jnJ7ncjRPeer+bnPr6oOf0nZb/J8tWRgzv2Ovv5iSFww1SDaIQt7QRzV4W2i/yd6nvCrQO4vyW7geGqDf/dcEmad4KGiOrxN9P80z1dLJu7c7+nrLoaNfbjn48rIfX5VJeZTec6E56vV9QyFZN4uu4HTX0/pxz2n6Wzc51dVh7+kOWzxXNmzFrJ/SXYDFwNLD7ez3HNCZAAD5x0Z2A00LtDJZTpR7jkhMoCB844M3Aa6lubUQp0q95wQGcDAeU8GbgNdC7NzuU6Wez6IDGDgvC8Dt4GuhdmxbKfKPRNEBjBw3p2B20DXwqx63mS5Z4HIAAZgQFsuhs7L5qfnT5Z7BogMYAAG9GcGqZdC92XjLl5EMoABGFBqBmkXQ/eF4y77wBEZwAAMnCUXQ/eF4yxeRDKAARjQpgzsBpovHGe5c0BkAAMwIC4G/8XAi0gGMAAD6xmwG2gUF4J/BogMYODsy8BuYEB8OvDPAJEBDJw9GdgNDImvi/wzQGQAA2dHBnYDw+L3A/8MEBnAwMnOwG7AJH5M9s8AkQEMnMwM7AbM4r+L/DNAZAADJysDuwFEBjAAAzBwojKwG0BkAAMwAAMnKgO7AUQGMAADMHCiMrAbQGQAAzAAAycqA7sBRAYwAAMwcKIysBtAZAADMAADJyoDuwFEBjAAAzBwojKwG0BkAAMwAAMnKgO7AUQGMAADMHCiMrAbQGQAAzAAAycqA7sBRAYwAAMwcKIysBtAZAADMAADJyoDuwFEBjAAAzBwojKwG0BkAAMwAANZDNgNIDKAARiAgROVgd0AIgMYgAEYOFEZ2A0gMoABGICBE5WB3QAiAxiAARg4URnYDSAygAEYgIETlYHdACIDGIABGDhRGdgNIDKAARiAgROVgd0AIgMYgAEYOFEZ2A0gMoABGICBE5WB3QAiAxiAARg4URnYDSAygAEYgIETlcEvK3yLJQdNX7kAAAAASUVORK5CYII=" alt="TERRA" style="height: 28px; filter: brightness(0) invert(1);">
            </div>
            <div class="header-title">Kanban Work</div>
        </div>
        <div class="header-controls" style="display: flex; align-items: center; gap: 1rem;">
            <span id="header-user-name" style="color: white; font-size: 0.9rem;"></span>
            <button onclick="openHelpModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1rem;" title="„Éò„É´„Éó">?</button>
            <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>
    </div>
    
    
    
    <!-- Áµ±Ë®à„Éê„Éº -->
    <div class="stats-bar" id="stats-bar">
        <div class="stat-item stat-overdue">
            <span class="stat-number" id="overdue-count">0</span>
            <span>ÊúüÈôêÂàá„Çå</span>
        </div>
        <div class="stat-item stat-today">
            <span class="stat-number" id="today-count">0</span>
            <span>‰ªäÊó•ÊúüÈôê</span>
        </div>
        <div class="stat-item" style="color: #e77600;" onclick="showStaleTasksDetail()" title="3Êó•‰ª•‰∏äÂêå„Åò„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Çø„Çπ„ÇØ">
            <span class="stat-number" id="stale-count">0</span>
            <span style="cursor: pointer;">ÂÅúÊªû‰∏≠</span>
        </div>
        <div class="stat-item" style="color: #10b981;" title="ÂÆå‰∫Ü„Çø„Çπ„ÇØ / ÂÖ®„Çø„Çπ„ÇØ">
            <span class="stat-number" id="completion-rate">-</span>
            <span>ÂÆå‰∫ÜÁéá</span>
        </div>
        <div class="stat-item" style="color: #0097A7;" title="ÊúüÈôêÂÜÖÂÆå‰∫Ü„Çø„Çπ„ÇØ / ÂÆå‰∫Ü„Çø„Çπ„ÇØ">
            <span class="stat-number" id="compliance-rate">-</span>
            <span>ÊúüÈôêÈÅµÂÆàÁéá</span>
        </div>
    </div>
    
    <!-- „Éï„Ç£„É´„Çø„Éº„ÉªÁÆ°ÁêÜ„Éê„Éº -->
    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span style="font-weight: 600; color: #2d3748;">Ë°®Á§∫ÂØæË±°:</span>
            <!-- Áµ±ÂêàÊãÖÂΩìËÄÖ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº -->
            <div style="position: relative;" id="assignee-filter-container">
                <button onclick="toggleAssigneeFilterDropdown()" style="padding: 0.5rem 0.75rem; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; min-width: 150px;">
                    <span id="assignee-filter-text">ÂÖ®Âì°</span>
                    <span>‚ñº</span>
                </button>
                <div id="assignee-filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 250px;">
                    <!-- ÊãÖÂΩìËÄÖ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„Åå„Åì„Åì„Å´ÂãïÁöÑËøΩÂä†„Åï„Çå„Çã -->
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê„Éú„Çø„É≥ÂªÉÊ≠¢: ÈÄöÂ∏∏„ÅÆ„Çø„Çπ„ÇØ‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÅßÁµ±Âêà -->
            <!-- „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥„Çí„Éû„Ç§„Éö„Éº„Ç∏„Å´ÁßªÊ§ç„ÅÆ„Åü„ÇÅÈùûË°®Á§∫ -->
            <button onclick="window.location.href='user-management.html'" style="display: none; padding: 0.5rem 0.75rem; background: #38a169; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;" title="„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ">
                „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ
            </button>
            <button onclick="showFilterHelp()" style="background: none; border: none; color: #4a5568; cursor: pointer; font-size: 1rem;" title="„Éï„Ç£„É´„Çø„Éº„ÅÆË™¨Êòé">
                ?
            </button>
        </div>
    </div>
    
    
    <!-- „Éê„É´„ÇØÊìç‰Ωú„Éê„Éº -->
    <div id="bulk-actions-bar" style="display: none; background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; padding: 0.75rem 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="selected-count" style="font-weight: 600;">0‰ª∂ÈÅ∏Êäû</span>
                <button onclick="selectAllTasks()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ÂÖ®ÈÅ∏Êäû</button>
                <button onclick="clearSelection()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ÈÅ∏ÊäûËß£Èô§</button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <select id="bulk-move-column" style="padding: 0.4rem; border: none; border-radius: 4px; font-size: 0.8rem;">
                    <option value="">ÁßªÂãïÂÖà„ÇíÈÅ∏Êäû</option>
                </select>
                <button onclick="bulkMoveSelected()" style="background: #38a169; border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ÁßªÂãï</button>
                <button onclick="bulkDeleteSelected()" style="background: #e53e3e; border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ÂâäÈô§</button>
                <button onclick="toggleBulkMode()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úï ÁµÇ‰∫Ü</button>
            </div>
        </div>
    </div>
    
    <!-- „Ç´„É≥„Éê„É≥„Éú„Éº„Éâ -->
    <div class="board-container">
        <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Çµ„Ç§„Éâ„Éê„Éº -->
        <div class="projects-sidebar">
            <div class="projects-header">
                „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß
            </div>
            <div class="projects-list" id="projects-list">
                <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Çã -->
            </div>
        </div>
        
        <!-- Kanban„Éú„Éº„Éâ„Ç®„É™„Ç¢ -->
        <div class="kanban-area">
            <div class="kanban-board" id="kanban-board">
                <!-- „Ç´„É©„É†„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Çã -->
            </div>
        </div>

        <!-- Âè≥„Çµ„Ç§„Éâ„Éë„Éç„É´ -->
        <div class="right-panel" id="right-panel">
            <div class="right-panel-section">
                <button class="right-panel-btn right-panel-btn-primary" onclick="openModal()">Êñ∞Ë¶è„Çø„Çπ„ÇØ</button>
                <button class="right-panel-btn right-panel-btn-secondary" onclick="toggleMultiSelect()">Ë§áÊï∞ÈÅ∏Êäû</button>
            </div>

            <div class="right-panel-section">
                <div class="right-panel-section-title">ÂÄã‰∫∫Ë®≠ÂÆö</div>
                <button class="right-panel-btn right-panel-btn-outline" onclick="window.location.href='my-profile.html'">„Éû„Ç§„Éö„Éº„Ç∏</button>
                <button class="right-panel-btn right-panel-btn-outline" onclick="openSettingsModal()">Ë®≠ÂÆö</button>
            </div>

            <div class="right-panel-section">
                <div class="right-panel-section-title">„Çø„Çπ„ÇØÁÆ°ÁêÜ</div>
                <button class="right-panel-btn right-panel-btn-outline" onclick="openTemplateModal()">„ÉÜ„É≥„Éó„É¨„Éº„Éà</button>
            </div>

            <div class="right-panel-section">
                <div class="right-panel-section-title">„Éó„É≠„Ç∏„Çß„ÇØ„Éà</div>
                <button class="right-panel-btn right-panel-btn-outline" onclick="openProjectManagementModal()">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö</button>
            </div>

            <div class="right-panel-section" id="right-panel-admin-section" style="display: none;">
                <div class="right-panel-section-title">ÁÆ°ÁêÜÊ©üËÉΩ</div>
                <button class="right-panel-btn right-panel-btn-outline" onclick="window.location.href='user-management.html'">„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</button>
            </div>
        </div>
    </div>
    
    <!-- „Çø„Çπ„ÇØÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Â∑¶ÂÅ¥: „Çø„Çπ„ÇØË©≥Á¥∞ -->
                <div class="modal-left">
                    <form onsubmit="saveTask(event)">
                        <!-- PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏Ôºàpj-create.htmlÔºâ„Å´ÁßªÂãï -->
                        
                        <!-- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû -->
                        <div class="form-group" style="background: #f8f9fa; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <label class="form-label" style="color: #495057;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ‰ΩúÊàêÔºà‰ªªÊÑèÔºâ</label>
                            <select id="template-select" onchange="handleTemplateSelection(this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                <option value="">-- „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">„Çø„Çπ„ÇØÂêç *</label>
                            <input type="text" class="form-input" id="task-title-input" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÊúüÈôêÊó• *</label>
                                <input type="date" class="form-input" id="task-date-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊúüÈôêÊôÇÂàª</label>
                                <input type="time" class="form-input" id="task-time-input" value="17:00">
                            </div>
                        </div>
                        
                        <div class="form-group" id="column-selection-group" style="display: none;">
                            <label class="form-label">ÈÖçÁΩÆÂÖà„Çπ„ÉÜ„Éº„Çø„Çπ *</label>
                            <select class="form-select" id="task-column-input" required>
                                <!-- „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">„Éó„É≠„Ç∏„Çß„ÇØ„Éà</label>
                                <select class="form-control" id="task-project-select">
                                    <option value="">ÂÄã‰∫∫„Çø„Çπ„ÇØÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„ÅóÔºâ</option>
                                    <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                </select>
                                <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                    „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº„Å®ÂÖ±Êúâ„Åï„Çå„Åæ„Åô
                                </small>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="task-hidden-input" style="margin: 0;">
                                „Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÔºàËá™ÂàÜ„ÅÆ„ÅøÔºâ
                            </label>
                            <small style="color: #666; display: block; margin-top: 0.25rem;">
                                „ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Å®Ëá™ÂàÜ‰ª•Â§ñ„ÅÆ„É¶„Éº„Ç∂„Éº„Åã„Çâ„ÅØË¶ã„Åà„Å™„Åè„Å™„Çä„Åæ„Åô„ÄÇÊãÖÂΩìËÄÖ„ÅØËá™ÂàÜ„ÅÆ„Åø„Å´Âà∂Èôê„Åï„Çå„Åæ„Åô„ÄÇ
                            </small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÊãÖÂΩìËÄÖÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
                                <div class="assignees-container" id="assignees-container">
                                    <!-- „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">„É°„É¢„ÉªÂÇôËÄÉ</label>
                            <textarea class="form-textarea" id="task-memo-input" rows="3" placeholder="Ë©≥Á¥∞„Å™ÈÄ≤ÊçóÁä∂Ê≥Å„ÇÑÂÇôËÄÉ„ÇíË®òÈå≤"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ê∑ª‰ªò„Éï„Ç°„Ç§„É´</label>
                            <input type="file" class="form-input" id="task-files-input" multiple accept="*/*">
                            <div class="file-drop-zone" id="file-drop-zone">
                                „Åì„Åì„Å´„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó „Åæ„Åü„ÅØ ‰∏äË®ò„Éú„Çø„É≥„ÅßÈÅ∏Êäû
                            </div>
                            <div id="attached-files-list" style="margin-top: 0.5rem;"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
                            <button type="submit" class="btn btn-primary" id="save-task-button">‰øùÂ≠ò</button>
                        </div>
                    </form>
                </div>
                
                <!-- Âè≥ÂÅ¥: „Ç≥„É°„É≥„Éà„Çπ„É¨„ÉÉ„Éâ -->
                <div class="modal-right">
                    <div class="comments-header">
                        <h4 style="margin: 0; font-size: 1rem; color: #172b4d;">üí¨ „Ç≥„É°„É≥„Éà„ÉªÈÄ≤ÊçóÂ†±Âëä</h4>
                    </div>
                    
                    <div class="comments-section" id="comments-section">
                        <!-- „Ç≥„É°„É≥„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                    
                    <div class="comment-input-section" style="position: relative;">
                        <textarea class="comment-input" id="comment-input" placeholder="ÈÄ≤ÊçóÂ†±Âëä„ÄÅÁ¢∫Ë™ç‰∫ãÈ†Ö„ÄÅ„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ... (@„Åß„É¶„Éº„Ç∂„Éº„É°„É≥„Ç∑„Éß„É≥ÂèØËÉΩ)"></textarea>
                        <div id="mention-suggestions" class="mention-suggestions" style="display: none;"></div>
                        <div class="comment-actions">
                            <button type="button" class="btn-comment" onclick="console.log('üîç [BUTTON] Comment button clicked'); addComment()">„Ç≥„É°„É≥„ÉàËøΩÂä†</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settingsModal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title">Ë®≠ÂÆö</h3>
                <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
            </div>
            
            <div class="settings-modal-body">
                <!-- Ë®≠ÂÆöÁîªÈù¢„ÅÆË™¨Êòé -->
                <div style="background: #e0f7f6; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #0097A7;">
                    <p style="margin: 0; color: #172b4d; font-size: 0.9rem;">
                        <strong>Ë®≠ÂÆöÁîªÈù¢„ÅÆ‰Ωø„ÅÑÊñπÔºö</strong><br>
                        ‚Ä¢ „Çπ„ÉÜ„Éº„Çø„ÇπÁÆ°ÁêÜÔºö„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅÆÊÆµÈöé„ÇíËøΩÂä†„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§„Åß„Åç„Åæ„Åô<br>
                        ‚Ä¢ „Ç´„É©„ÉºÂ§âÊõ¥ÔºöÂêÑ„Éï„Çß„Éº„Ç∫„ÅÆËâ≤„ÇíÂ§âÊõ¥„Åó„Å¶„ÉÅ„Éº„É†Ë≠òÂà•„ÇíÂêë‰∏ä<br>
                        ‚Ä¢ „Ç¢„É©„Éº„ÉàË®≠ÂÆöÔºöÊúüÈôêÈÄöÁü•„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
                    </p>
                </div>
                
                <!-- „Ç´„É©„É†„Éª„Éï„Çß„Éº„Ç∫ÁÆ°ÁêÜ -->
                <div class="setting-section" style="background: #f8fafc; padding: 2rem; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #0097A7;">„Çπ„ÉÜ„Éº„Çø„Çπ„Éª„Éï„Çß„Éº„Ç∫ÁÆ°ÁêÜ</h3>
                    <div id="column-manager">
                        <div id="column-list" style="margin-bottom: 1rem;">
                            <!-- Êó¢Â≠ò„ÅÆ„Ç´„É©„É†„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="new-column-name" placeholder="Êñ∞„Åó„ÅÑ„Ç´„É©„É†ÂêçÔºà‰æãÔºö„É¨„Éì„É•„Éº‰∏≠„ÄÅÊâøË™çÂæÖ„Å°Ôºâ" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addColumn()" style="padding: 0.5rem 1rem; background: #0097A7; color: white; border: none; border-radius: 4px; cursor: pointer;">ËøΩÂä†</button>
                        </div>
                    </div>
                </div>
                
                <!-- „Ç¢„É©„Éº„ÉàË®≠ÂÆö -->
                <div class="setting-section" style="margin-top: 2rem; background: #fef5e7; padding: 2rem; border-radius: 12px; border: 1px solid #fed7aa;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #f59e0b;">ÊúüÈôê„Ç¢„É©„Éº„ÉàË®≠ÂÆö</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-3hours" checked>
                            <span>3ÊôÇÈñìÂâç„Å´„Ç¢„É©„Éº„Éà</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-1day">
                            <span>1Êó•Ââç„Å´„Ç¢„É©„Éº„Éà</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-overdue" checked>
                            <span>ÊúüÈôêÂàá„ÇåÂæå„Å´„Ç¢„É©„Éº„Éà</span>
                        </label>
                    </div>
                </div>
                

                <!-- Ë°®Á§∫Ë®≠ÂÆö -->
                <div class="setting-section" style="margin-top: 2rem; background: #f0fdf4; padding: 2rem; border-radius: 12px; border: 1px solid #bbf7d0;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #22c55e;">Ë°®Á§∫Ë®≠ÂÆö</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="show-task-count" checked>
                            <span>„Ç´„É©„É†„Å´„Çø„Çπ„ÇØÊï∞„ÇíË°®Á§∫</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="compact-mode">
                            <span>„Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫„É¢„Éº„Éâ</span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-section" style="margin-top: 2rem; background: #fef2f2; padding: 2rem; border-radius: 12px; border: 1px solid #fecaca;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #ef4444;">„Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button onclick="clearAllData()" style="padding: 0.75rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- ÂàÜÊûê„Éª„É¨„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
    <div id="analyticsModal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content" style="max-width: 1000px;">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title">ÂàÜÊûê„Éª„É¨„Éù„Éº„Éà</h3>
                <button class="close-btn" onclick="closeAnalyticsModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem; overflow-y: auto; max-height: 80vh;">
                <!-- ÊúüÈñìÈÅ∏Êäû -->
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                    <span style="font-weight: 600;">ÊúüÈñì:</span>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('all')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">ÂÖ®ÊúüÈñì</button>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('today')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">‰ªäÊó•</button>
                    <button class="period-btn active" onclick="showAnalyticsForPeriod('week')" style="padding: 0.5rem 1rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer;">‰ªäÈÄ±</button>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('month')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">‰ªäÊúà</button>
                </div>
                
                <!-- Ê¶ÇË¶ÅÁµ±Ë®à -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="total-tasks">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Á∑è„Çø„Çπ„ÇØÊï∞</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="completion-rate">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ÂÆå‰∫ÜÁéá</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="deadline-compliance">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ÊúüÈôêÈÅµÂÆàÁéá</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="avg-completion-time">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Âπ≥ÂùáÂÆå‰∫ÜÊôÇÈñì</div>
                    </div>
                </div>
                
                <!-- „Ç∞„É©„Éï„Ç®„É™„Ç¢ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- „Çø„Çπ„ÇØÂÆå‰∫ÜÁéá„ÉÅ„É£„Éº„Éà -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #172b4d;">„Çø„Çπ„ÇØÂÆå‰∫ÜÁä∂Ê≥Å</h4>
                        <div id="completion-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                            „Ç∞„É©„Éï„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                        </div>
                    </div>
                    
                    <!-- ÊúüÈôêÈÅµÂÆàÁä∂Ê≥Å„ÉÅ„É£„Éº„Éà -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #172b4d;">ÊúüÈôêÈÅµÂÆàÁä∂Ê≥Å</h4>
                        <div id="deadline-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                            „Ç∞„É©„Éï„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                        </div>
                    </div>
                </div>
                
                <!-- ÊãÖÂΩìËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ -->
                <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #172b4d;">ÊãÖÂΩìËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h4>
                    <div id="assignee-performance" style="min-height: 200px;">
                        „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ÔºàÁã¨Á´ãÁâàÔºâ -->
    <div id="taskImportModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: #fdf2f8; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: #1f2937; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„Éà
                </h3>
                <button class="close-btn" onclick="closeTaskImportModal()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">&times;</button>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                <!-- Ë®≠ÂÆöÁîªÈù¢„ÅÆÂÆåÁíß„Å™„Äåüìù ÊüîËªü„ÉÜ„Ç≠„Çπ„Éà„Ç§„É≥„Éù„Éº„Éà„ÄçÊ©üËÉΩ„Çí„Åì„Åì„Å´ÁßªÊ§ç -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <textarea id="import-text-modal" placeholder="„Ç∑„É≥„Éó„É´ÂΩ¢Âºè„Åß„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ&#10;‰æã:&#10;AÁ§æ„Å∏„ÅÆÊèêÊ°àÊõ∏‰ΩúÊàê @Áî∞‰∏≠ÈÉ®Èï∑ 2024-08-05&#10;  Ë©≥Á¥∞Á¢∫Ë™ç‰∫ãÈ†ÖÔºàÂçäËßí„Çπ„Éö„Éº„Çπ2ÂÄãÔºâ&#10;  Ë¶ãÁ©ç„ÇÇ„ÇäË™øÊï¥&#10;BÁ§æÊâì„Å°Âêà„Çè„Åõ!!! @‰ΩêËó§Ë™≤Èï∑&#10;„ÄÄË≥áÊñôÊ∫ñÂÇôÊ∏à„ÅøÔºàÂÖ®Ëßí„Çπ„Éö„Éº„ÇπÔºâ&#10;		‰ºöË≠∞ÂÆ§‰∫àÁ¥ÑÔºà„Çø„ÉñÔºâ&#10;CÁ§æ„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„Éó" style="width: 100%; height: 120px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9rem; resize: vertical;"></textarea>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="processImportText(true)" style="flex: 1; padding: 0.75rem; background: #0079bf; color: white; border: none; border-radius: 4px; cursor: pointer;">„Éó„É¨„Éì„É•„Éº</button>
                        <button onclick="document.getElementById('import-text-modal').value = ''; hidePreviewModal();" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">„ÇØ„É™„Ç¢</button>
                    </div>
                    
                    <!-- „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ - Êã°Â§ßÁâà -->
                    <div id="import-preview" style="display: none; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                        <div style="padding: 1rem; border-bottom: 1px solid #ddd; background: #e0f7f6;">
                            <h5 style="margin: 0; color: #172b4d;">„Ç§„É≥„Éù„Éº„Éà„Éó„É¨„Éì„É•„Éº - „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÁ∑®ÈõÜÂèØËÉΩ</h5>
                        </div>
                        <div id="preview-content" style="padding: 1rem; max-height: 500px; overflow-y: auto; overflow-x: auto;"></div>
                        <div style="padding: 1rem; border-top: 1px solid #ddd; display: flex; gap: 0.5rem;">
                            <button onclick="executeImportFromModal()" style="flex: 1; padding: 0.75rem; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer;">„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å</button>
                            <button onclick="hidePreviewModal()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">„Ç≠„É£„É≥„Çª„É´</button>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.8rem; color: #6c757d; line-height: 1.4;">
                        <strong>„Ç∑„É≥„Éó„É´ÂΩ¢Âºè:</strong><br>
                        „Éª„Åß‰∏ª„Çø„Çπ„ÇØÈñãÂßã<br>
                        Ë°åÈ†≠„Çπ„Éö„Éº„Çπ„Åß„Çµ„Éñ„Çø„Çπ„ÇØÔºà„Ç≥„É°„É≥„Éà„Å´Ëá™ÂãïËøΩÂä†Ôºâ<br>
                        @ÊãÖÂΩìËÄÖ„ÄÅÊó•‰ªò„ÄÅ!!! È´òÂÑ™ÂÖàÂ∫¶„ÇíËá™ÂãïË™çË≠ò
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="projectManagementModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ
                </h3>
                <button class="close-btn" onclick="closeProjectManagementModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem; margin-left: auto;">&times;</button>
            </div>
            
            <div style="padding: 1.5rem 2rem; overflow-y: auto; flex: 1;">
                <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #374151; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                        Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
                    </h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="newProjectName" placeholder="„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; margin-bottom: 0.5rem;">
                            <textarea id="newProjectDescription" placeholder="„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™¨Êòé" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; height: 80px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; flex: 1; min-width: 200px;">
                            <label style="font-size: 0.9rem; color: #6b7280;">ÂÖ¨ÈñãË®≠ÂÆö:</label>
                            <select id="newProjectVisibility" style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="public">[ÂÖ¨Èñã] ÂÖ®Âì°„Å´ÂÖ¨Èñã</option>
                                <option value="private">[ÈùûÂÖ¨Èñã] „É°„É≥„Éê„Éº„ÅÆ„Åø</option>
                            </select>

                            <label style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">„Ç´„É©„É†Ë®≠ÂÆö:</label>
                            <div id="newProjectColumnsContainer" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <!-- „Ç´„É©„É†„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ÊåøÂÖ•„Åï„Çå„Çã -->
                            </div>
                            <button type="button" onclick="addNewProjectColumn()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 500; margin-bottom: 0.5rem;">
                                „Ç´„É©„É†ËøΩÂä†
                            </button>

                            <button onclick="createNewProject()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;">
                                ‰ΩúÊàê
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß -->
                <div>
                    <h4 style="color: #374151; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                        Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß
                    </h4>
                    <div id="projectsList" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ÊåøÂÖ•„Åï„Çå„Çã -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„É¢„Éº„ÉÄ„É´ -->
    <div id="adminDashboardModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1200px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
                </h3>
                <button class="close-btn" onclick="closeAdminDashboardModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem; margin-left: auto;">&times;</button>
            </div>

            <div style="padding: 1.5rem 2rem; overflow-y: auto; flex: 1;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                    <!-- Á∑äÊÄ•ÂØæÂøú„Ç¢„É©„Éº„Éà -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; border-left: 4px solid #0097A7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span>üö®</span>
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #172b4d; margin: 0;">Á∑äÊÄ•ÂØæÂøú„ÅåÂøÖË¶Å„Å™È†ÖÁõÆ</h3>
                        </div>
                        <div>
                            <div style="background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                                <strong>ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ:</strong> <span id="dashboard-overdue-count">0</span>‰ª∂
                            </div>
                            <div style="background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                                <strong>ÂÅúÊªû„Çø„Çπ„ÇØ:</strong> <span id="dashboard-stale-count">0</span>‰ª∂
                            </div>
                        </div>
                    </div>

                    <!-- „ÉÅ„Éº„É†ÁîüÁî£ÊÄß -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; border-left: 4px solid #0097A7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span></span>
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #172b4d; margin: 0;">„ÉÅ„Éº„É†ÁîüÁî£ÊÄßÊé®Áßª</h3>
                        </div>
                        <div style="height: 200px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">
                            „Ç∞„É©„ÉïÊ©üËÉΩÔºàÈñãÁô∫‰∏≠Ôºâ
                        </div>
                    </div>

                    <!-- „É°„É≥„Éê„ÉºÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; border-left: 4px solid #0097A7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span></span>
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #172b4d; margin: 0;">„É°„É≥„Éê„ÉºÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h3>
                        </div>
                        <div id="dashboard-performance-content">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                        </div>
                    </div>

                    <!-- „Ç∑„Çπ„ÉÜ„É†Áä∂Ê≥ÅÁõ£Ë¶ñ -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; border-left: 4px solid #0097A7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span></span>
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #172b4d; margin: 0;">„Ç∑„Çπ„ÉÜ„É†Áä∂Ê≥ÅÁõ£Ë¶ñ</h3>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
                            <span>FirebaseÊé•Á∂öÁä∂ÊÖã:</span>
                            <span style="font-weight: 600; font-size: 1.1rem; color: #0097A7;" id="dashboard-firebase-status">Á¢∫Ë™ç‰∏≠...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
                            <span>Á∑è„Çø„Çπ„ÇØÊï∞:</span>
                            <span style="font-weight: 600; font-size: 1.1rem; color: #0097A7;" id="dashboard-total-tasks">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
                            <span>„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº:</span>
                            <span style="font-weight: 600; font-size: 1.1rem; color: #0097A7;" id="dashboard-active-users">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="userManagementModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1400px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0;">
                    „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ
                </h3>
                <button class="close-btn" onclick="closeUserManagementModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div style="flex: 1; overflow: hidden;">
                <iframe id="userManagementFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- „Éû„Ç§„Éö„Éº„Ç∏„É¢„Éº„ÉÄ„É´ -->
    <div id="myProfileModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1400px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0;">
                    „Éû„Ç§„Éö„Éº„Ç∏
                </h3>
                <button class="close-btn" onclick="closeMyProfileModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div style="flex: 1; overflow: hidden;">
                <iframe id="myProfileFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ÔºàÁµ±ÂêàÁâàÔºâ -->
    <div id="templateManagementModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: #f9fafb; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: #1f2937; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ
                    <span style="font-size: 0.8rem; background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 500;">Áµ±Âêà</span>
                </h3>
                <button class="close-btn" onclick="closeTemplateManagementModal()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">&times;</button>
            </div>
            
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Â∑¶ÂÅ¥Ôºö„ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß -->
                <div style="width: 350px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column;">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
                        <h4 style="margin: 0 0 1rem 0; color: #1f2937; font-weight: 600;">‰ΩúÊàêÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà</h4>
                        <button onclick="showTemplateCreateForm()" style="width: 100%; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            Êñ∞Ë¶è„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê
                        </button>
                    </div>
                    <div id="template-management-list" style="flex: 1; overflow-y: auto; padding: 1rem;">
                        <!-- „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        <div style="text-align: center; color: #6b7280; padding: 2rem;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                </div>
                
                <!-- Âè≥ÂÅ¥Ôºö„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„ÉªÁ∑®ÈõÜ„Éï„Ç©„Éº„É† -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <div id="template-welcome-screen" style="display: flex; flex-direction: column; justify-content: center; align-items: center; flex: 1; color: #6b7280; text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                        <h3 style="margin: 0 0 0.5rem 0; color: #374151;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ</h3>
                        <p style="margin: 0; line-height: 1.6;">
                            Â∑¶ÂÅ¥„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„Åã„ÇâÈÅ∏Êäû„Åô„Çã„Åã„ÄÅ<br>
                            „ÄåÊñ∞Ë¶è„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Äç„ÅßÊñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô
                        </p>
                    </div>
                    
                    <div id="template-form-container" style="display: none; flex: 1; overflow-y: auto; padding: 1.5rem 2rem;">
                        <form id="template-management-form" onsubmit="saveTemplateFromManagement(event)">
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç *</label>
                                <input type="text" id="mgmt-template-name" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="‰æã: Âñ∂Ê•≠„É¨„Éù„Éº„Éà‰ΩúÊàê" required>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Çø„Çπ„ÇØÂêç *</label>
                                <input type="text" id="mgmt-template-task-title" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="‰æã: ÊúàÊ¨°Âñ∂Ê•≠„É¨„Éù„Éº„Éà‰ΩúÊàê" required>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ÂÑ™ÂÖàÂ∫¶</label>
                                    <select id="mgmt-template-priority" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                        <option value="high">[È´ò] ÊúÄÈáçË¶Å</option>
                                        <option value="medium" selected>[‰∏≠] ÈáçË¶Å</option>
                                        <option value="low">[‰Ωé] ÈÄöÂ∏∏</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†</label>
                                    <select id="mgmt-template-column" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                        <!-- „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„Åå„Åì„Åì„Å´ÂãïÁöÑËøΩÂä†„Åï„Çå„Çã -->
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ÊãÖÂΩìËÄÖÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
                                <div id="mgmt-template-assignees" style="display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; min-height: 60px;">
                                    <!-- ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Åì„Åì„Å´ÂãïÁöÑËøΩÂä†„Åï„Çå„Çã -->
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 2rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„É°„É¢„ÉªÂÇôËÄÉ</label>
                                <textarea id="mgmt-template-memo" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; resize: vertical;" rows="4" placeholder="„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆË©≥Á¥∞„ÇÑ‰ΩøÁî®Â†¥Èù¢"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <button type="button" onclick="cancelTemplateForm()" style="flex: 1; padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    „Ç≠„É£„É≥„Çª„É´
                                </button>
                                <button type="submit" id="mgmt-save-template-btn" style="flex: 1; padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    ‰øùÂ≠ò
                                </button>
                                <button type="button" id="mgmt-delete-template-btn" onclick="deleteCurrentTemplate()" style="display: none; padding: 0.75rem 1.5rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    ÂâäÈô§
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // üî• FirebaseÂ∞ÇÁî®„É¢„Éº„Éâ - „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ÂàùÊúüÂåñ
        let tasks = [];
        window.tasks = [];
        let assignees = []; // {email, name}„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„Å´Â§âÊõ¥
        let taskTemplates = [];
        
        // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØÔºà„Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇÔºâ
        function checkAuthentication() {
            try {
                // „Åæ„Åö„Çª„ÉÉ„Ç∑„Éß„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session) {
                    // „Çª„ÉÉ„Ç∑„Éß„É≥ÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ
                    if (new Date() <= new Date(session.expiresAt)) {
                        
                        // üîß Ê®©Èôê„ÅÆÂÆåÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™çÊôÇÔºâ
                        ensureUserPermissionsIntegrity();
                        
                        displayUserInfo(session.user);
                        return true;
                    } else {
                        localStorage.removeItem('currentSession');
                    }
                }
                
                // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁÑ°Âäπ/ÊúüÈôêÂàá„Çå„ÅÆÂ†¥Âêà„ÅØ„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                console.warn('‚ö†Ô∏è [AUTH] „Çª„ÉÉ„Ç∑„Éß„É≥ÁÑ°Âäπ/ÊúüÈôêÂàá„Çå - „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà');
                localStorage.clear();
                window.location.href = 'login.html';
                return false;
            } catch (error) {
                console.error('‚ùå [AUTH] „Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç„Ç®„É©„Éº:', error);
                localStorage.clear();
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÂàùÊúüÂåñÔºàÈÅ©Âàá„Å™Ê®©ÈôêË®≠ÂÆö‰ªò„ÅçÔºâ
        function initializeUserDatabase() {
            const existingUsers = localStorage.getItem('systemUsers');
            if (!existingUsers || JSON.parse(existingUsers).length === 0) {
                
                // Ê≠£„Åó„ÅÑÊ®©ÈôêË®≠ÂÆö„ÅÆÂÆåÂÖ®„Å™„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„Çπ
                const systemUsers = [
                    {
                        id: 1,
                        name: 'ÈÇ®‰∏≠Â§©Áúü',
                        email: 'muranaka-tenma@terracom.co.jp',
                        password: 'Tenma7041',
                        role: 'developer',
                        department: 'ÈñãÁô∫ÈÉ®',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 2,
                        name: 'Âä†Ëó§Á¥î',
                        email: 'kato-jun@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 3,
                        name: 'ÊúùÊó•Âú≠‰∏Ä',
                        email: 'asahi-keiichi@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 4,
                        name: 'ÂçäÊæ§‰æëÊûú',
                        email: 'hanzawa-yuka@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 5,
                        name: 'Áî∞ÊùëÊ∏â',
                        email: 'tamura-wataru@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 6,
                        name: 'Ê©ãÊú¨ÂèãÁæé',
                        email: 'hashimoto-yumi@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 7,
                        name: 'Á¶èÂ≥∂‰∫úÊú™',
                        email: 'fukushima-ami@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    }
                ];
                
                // üî• LocalStorage‰øùÂ≠ò„ÅØÂâäÈô§ÔºàFirebaseÁßªË°å„Å´„Çà„Çä‰∏çË¶ÅÔºâ
                console.log('üíæ [INIT] ÂàùÊúü„É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøÔºàFirebaseÁÆ°ÁêÜÔºâ:', systemUsers.map(u => ({name: u.name, role: u.role})));
                // localStorage.setItem('systemUsers', JSON.stringify(systemUsers)); // üî• ÂâäÈô§
                console.log('‚úÖ [INIT] „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÅØFirebase„ÅßÁÆ°ÁêÜ„Åï„Çå„Åæ„Åô');
                
                // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇÇÂàùÊúüÂåñÔºàÊúâÂäπ„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÔºâ- „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„Å´Â§âÊõ¥
                assignees = systemUsers.map(u => ({email: u.email, name: u.name}));
                // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅØFirestore„ÅßÁÆ°ÁêÜ„Åï„Çå„Çã
                
                // Ê®©ÈôêÁ¢∫Ë™ç„É≠„Ç∞
                console.log('üîê [INIT] ÂàùÊúü„É¶„Éº„Ç∂„ÉºÊ®©ÈôêË®≠ÂÆö:');
                systemUsers.forEach(user => {
                    const roleEmoji = user.role === 'developer' ? 'üë®‚Äçüíª' : 
                                     user.role === 'admin' ? 'üë§' : 'üßë‚Äçüíº';
                    console.log(`  ${roleEmoji} ${user.name} - ${user.role}`);
                });
            } else {
                
                // üîß ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇísystemUsers„Åã„ÇâËá™ÂãïÊõ¥Êñ∞ÔºàÊúâÂäπ„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÔºâ- „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó
                const activeUsers = getActiveUsers();
                if (activeUsers.length > 0) {
                    assignees = activeUsers.map(u => ({email: u.email, name: u.name}));
                    // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅØFirestore„ÅßÁÆ°ÁêÜ„Åï„Çå„Çã
                    console.log(`üë• [UPDATE] ÊúâÂäπ„Å™ÊãÖÂΩìËÄÖ: ${assignees.map(a => a.name).join(', ')}`);
                }
                
                // Ê®©Èôê„ÅÆÂÆåÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºàÊ®©Èôê„É™„Çª„ÉÉ„ÉàÈò≤Ê≠¢Ôºâ
                ensureUserPermissionsIntegrity();
            }
        }
        
        // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å‰∏≠„Éï„É©„Ç∞ÔºàÈáçË§áÂÆüË°åÈò≤Ê≠¢Ôºâ
        let permissionCheckInProgress = false;
        let lastPermissionCheckTime = 0;

        // üî• FirebaseÁµ±Âêà: „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
        let cachedActiveUsers = [];
        let usersCacheLoaded = false;

        // üî• FirebaseÁµ±Âêà: „É¶„Éº„Ç∂„Éº„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíFirebase„Åã„ÇâË™≠„ÅøËæº„Åø
        async function loadActiveUsersFromFirebase() {
            try {
                console.log('üîç [LOAD-USERS] Firebase„Åã„Çâ„É¶„Éº„Ç∂„ÉºÂèñÂæóÈñãÂßã...');
                const result = await window.FirebaseDB.getActiveUsers();
                if (result.success) {
                    cachedActiveUsers = result.users;
                    usersCacheLoaded = true;
                    console.log(`‚úÖ [LOAD-USERS] FirebaseÂèñÂæóÊàêÂäü: ${cachedActiveUsers.length}‰∫∫`);
                    return cachedActiveUsers;
                } else {
                    console.error('‚ùå [LOAD-USERS] FirebaseÂèñÂæóÂ§±Êïó:', result.error);
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: localStorage„Åã„ÇâË™≠„ÅøËæº„Åø
                    return loadActiveUsersFromLocalStorage();
                }
            } catch (error) {
                console.error('‚ùå [LOAD-USERS] „Ç®„É©„Éº:', error);
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: localStorage„Åã„ÇâË™≠„ÅøËæº„Åø
                return loadActiveUsersFromLocalStorage();
            }
        }

        // LocalStorage„Åã„Çâ„É¶„Éº„Ç∂„ÉºË™≠„ÅøËæº„ÅøÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Ôºâ
        function loadActiveUsersFromLocalStorage() {
            console.log('‚ö†Ô∏è [LOAD-USERS] LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å');
            const allUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const activeUsers = allUsers.filter(user =>
                !user.isHidden && !user.isDisabled
            );
            cachedActiveUsers = activeUsers;
            usersCacheLoaded = true;
            console.log(`‚úÖ [LOAD-USERS] LocalStorageÂèñÂæó: ${activeUsers.length}‰∫∫`);
            return activeUsers;
        }

        // üîß ÊúâÂäπ„Å™„É¶„Éº„Ç∂„Éº„ÅÆ„Åø„ÇíÂèñÂæó„Åô„ÇãÂÖ±ÈÄöÈñ¢Êï∞ÔºàÈùûË°®Á§∫„ÉªÁÑ°ÂäπÂåñ„É¶„Éº„Ç∂„Éº„ÇíÈô§Â§ñÔºâ
        function getActiveUsers() {
            if (!usersCacheLoaded) {
                console.warn('‚ö†Ô∏è [ACTIVE-USERS] „Ç≠„É£„ÉÉ„Ç∑„É•Êú™Ë™≠„ÅøËæº„Åø - Á©∫ÈÖçÂàó„ÇíËøî„Åó„Åæ„Åô');
                return [];
            }
            return cachedActiveUsers;
        }

        // ÊúâÂäπ„Å™„É¶„Éº„Ç∂„ÉºÂêç„ÅÆ„É™„Çπ„Éà„ÇíÂèñÂæóÔºàÊãÖÂΩìËÄÖÈÅ∏ÊäûÁ≠â„Åß‰ΩøÁî®Ôºâ
        function getActiveUserNames() {
            return getActiveUsers().map(u => u.name);
        }
        
        // Ê®©Èôê„ÅÆÂÆåÂÖ®ÊÄß„Çí‰øùË®º„Åô„ÇãÈñ¢Êï∞ÔºàÊ®©Èôê„É™„Çª„ÉÉ„ÉàÈò≤Ê≠¢Ôºâ
        function ensureUserPermissionsIntegrity() {
            // ÈáçË§áÂÆüË°åÈò≤Ê≠¢: 3Áßí‰ª•ÂÜÖ„ÅÆÈÄ£Á∂öÂÆüË°å„Çí„Éñ„É≠„ÉÉ„ÇØ
            const now = Date.now();
            if (permissionCheckInProgress || (now - lastPermissionCheckTime < 3000)) {
                console.log('‚è∏Ô∏è [PERMISSION-INTEGRITY] ÈáçË§áÂÆüË°åÈò≤Ê≠¢ - „Çπ„Ç≠„ÉÉ„Éó');
                return false;
            }
            
            permissionCheckInProgress = true;
            lastPermissionCheckTime = now;
            
            try {
                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                
                // üîç Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÂâç„ÅÆÁä∂ÊÖã„ÇíË©≥Á¥∞„Å´Ë®òÈå≤
                console.log('üîç [PERMISSION-INTEGRITY] Ê®©ÈôêÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã');
                console.log('üîç [PERMISSION-INTEGRITY] ÁèæÂú®„ÅÆsystemUsers:', systemUsers.map(u => ({
                    name: u.name,
                    email: u.email,
                    role: u.role,
                    id: u.id
                })));
                
                // Âëº„Å≥Âá∫„ÅóÂÖÉ„ÅÆ„Çπ„Çø„ÉÉ„ÇØ„Éà„É¨„Éº„Çπ„ÇíË®òÈå≤
                console.trace('üîç [PERMISSION-INTEGRITY] Âëº„Å≥Âá∫„ÅóÂÖÉ:');
            
            const correctRoles = {
                'muranaka-tenma@terracom.co.jp': 'developer',
                'kato-jun@terracom.co.jp': 'user',
                'asahi-keiichi@terracom.co.jp': 'user',
                'hanzawa-yuka@terracom.co.jp': 'user',
                'tamura-wataru@terracom.co.jp': 'user',
                'hashimoto-yumi@terracom.co.jp': 'user',
                'fukushima-ami@terracom.co.jp': 'user'
            };
            
            let corrected = false;
            let allUsersAreUser = systemUsers.length > 0 && systemUsers.every(user => user.role === 'user');
            
            if (allUsersAreUser) {
                console.warn('‚ö†Ô∏è [CRITICAL] ÂÖ®„É¶„Éº„Ç∂„Éº„Ååuser„Å´„Å™„Å£„Å¶„ÅÑ„Çã - Á∑äÊÄ•‰øÆÂæ©ÂÆüË°å');
                
                // LocalStorageÂÖ®‰Ωì„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶Ê®©ÈôêÂ§âÊõ¥„ÅÆÂéüÂõ†„ÇíÁâπÂÆö
                console.log('üîç [CRITICAL-DEBUG] LocalStorageÂÜÖ„ÅÆÈñ¢ÈÄ£„Éá„Éº„Çø:');
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('user') || key.includes('User') || key.includes('session') || key.includes('Session')) {
                        const value = localStorage.getItem(key);
                        console.log(`  - ${key}: ${value?.substring(0, 200)}...`);
                    }
                });
                
                // Â§ñÈÉ®„Çπ„ÇØ„É™„Éó„Éà„Å´„Çà„ÇãÂ§âÊõ¥„ÅÆÂèØËÉΩÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                console.log('üîç [CRITICAL-DEBUG] ‰ªñ„ÅÆ„Çø„Éñ„ÇÑ„Ç¶„Ç£„É≥„Éâ„Ç¶„Åã„Çâ„ÅÆÂ§âÊõ¥„ÅÆÂèØËÉΩÊÄß„ÇÇËÄÉÊÖÆ');
            }
            
            // üîß Âº∑Âà∂ÁöÑ„Å´Ê≠£„Åó„ÅÑÊ®©Èôê„ÇíÈÅ©Áî®
            systemUsers.forEach(user => {
                const correctRole = correctRoles[user.email];
                if (correctRole) {
                    const oldRole = user.role;
                    user.role = correctRole; // Âº∑Âà∂ÁöÑ„Å´Ê≠£„Åó„ÅÑÊ®©Èôê„Å´Ë®≠ÂÆö
                    if (oldRole !== correctRole) {
                        corrected = true;
                    }
                }
            });
            
            // üîÑ Â∏∏„Å´‰øùÂ≠òÔºàÂº∑Âà∂‰øÆÊ≠£Ôºâ
            // systemUsers„ÅØFirestore„ÅßÁÆ°ÁêÜ„Åï„Çå„Çã
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇÇ‰øÆÂæ©
            const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (session && session.user && correctRoles[session.user.email]) {
                const correctRole = correctRoles[session.user.email];
                const oldSessionRole = session.user.role;
                session.user.role = correctRole; // Âº∑Âà∂ÁöÑ„Å´Ê≠£„Åó„ÅÑÊ®©Èôê„Å´Ë®≠ÂÆö
                localStorage.setItem('currentSession', JSON.stringify(session));
                if (oldSessionRole !== correctRole) {
                }
            }
            
            // üîç ‰øÆÊ≠£Âæå„ÅÆÊ®©ÈôêÁä∂Ê≥Å„ÇíÁ¢∫Ë™çË°®Á§∫
            console.log('üìã [PERMISSION-STATUS] ‰øÆÊ≠£Âæå„ÅÆÊ®©ÈôêÁä∂Ê≥Å:');
            systemUsers.forEach(user => {
                const roleEmoji = user.role === 'developer' ? 'üë®‚Äçüíª' : 
                                 user.role === 'admin' ? 'üë§' : 'üßë‚Äçüíº';
                console.log(`  ${roleEmoji} ${user.name} (${user.email}) - ${user.role}`);
                });
                
                return corrected;
                
            } catch (error) {
                console.error('‚ùå [PERMISSION-INTEGRITY] Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                return false;
            } finally {
                // ÂÆüË°å‰∏≠„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                permissionCheckInProgress = false;
                console.log('‚úÖ [PERMISSION-INTEGRITY] Ê®©ÈôêÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü');
            }
        }
        
        // LocalStorageÂ§âÊõ¥„ÅÆÁõ£Ë¶ñÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ- Ê®©Èôê„É™„Çª„ÉÉ„Éà„ÅÆÂéüÂõ†ÁâπÂÆö
        function setupLocalStorageMonitoring() {
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (key === 'systemUsers') {
                    console.log('üîç [LOCALSTORAGE-MONITOR] systemUsers„Å∏„ÅÆÊõ∏„ÅçËæº„Åø„ÇíÊ§úÂá∫');
                    console.log('üîç [LOCALSTORAGE-MONITOR] Êñ∞„Åó„ÅÑÂÄ§:', value?.substring(0, 300));
                    console.trace('üîç [LOCALSTORAGE-MONITOR] Êõ∏„ÅçËæº„ÅøÂÖÉ„Çπ„Çø„ÉÉ„ÇØ„Éà„É¨„Éº„Çπ:');
                    
                    // Ê®©Èôê„ÅåÂÖ®„Å¶user„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    try {
                        const users = JSON.parse(value);
                        if (Array.isArray(users) && users.length > 0) {
                            const developerCount = users.filter(u => u.role === 'developer').length;
                            const userCount = users.filter(u => u.role === 'user').length;
                            
                            console.log(`üîç [LOCALSTORAGE-MONITOR] Ê®©ÈôêÂàÜÂ∏É: developer(${developerCount}), user(${userCount})`);
                            
                            if (users.every(u => u.role === 'user')) {
                                console.error('‚ö†Ô∏è [LOCALSTORAGE-MONITOR] üö® Á∑äÊÄ•Ë≠¶Âëä: ÂÖ®„É¶„Éº„Ç∂„Éº„Ååuser„É≠„Éº„É´„ÅßÊõ∏„ÅçËæº„Åæ„Çå„Çà„ÅÜ„Å®„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ');
                                console.error('üîç [LOCALSTORAGE-MONITOR] „Åì„Çå„ÅØÊ®©Èôê„É™„Çª„ÉÉ„Éà„ÅÆÁû¨Èñì„Åß„Åô');
                            }
                        }
                    } catch (e) {
                        console.error('‚ùå [LOCALSTORAGE-MONITOR] „Éë„Éº„Çπ„Ç®„É©„Éº:', e);
                    }
                }
                return originalSetItem.apply(this, arguments);
            };
            
            console.log('‚úÖ [LOCALSTORAGE-MONITOR] LocalStorageÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã');
        }
        
        // ÂÆöÊúüÁöÑÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºà5ÂàÜ„Åî„Å®Ôºâ
        function startPeriodicPermissionCheck() {
            setInterval(() => {
                console.log('üîÑ [PERIODIC] ÂÆöÊúüÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å‰∏≠...');
                const wasFixed = ensureUserPermissionsIntegrity();
                if (wasFixed) {
                    console.log('üö® [PERIODIC] Ê®©ÈôêÁï∞Â∏∏„ÇíÊ§úÂá∫„Éª‰øÆÂæ©„Åó„Åæ„Åó„Åü');
                }
            }, 5 * 60 * 1000); // 5ÂàÜ„Åî„Å®
        }
        
        // LocalStorage„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆFirebaseÁßªË°å
        async function migrateProjectsToFirebase() {
            // üî• LocalStorage‚ÜíFirebaseÁßªË°å„ÅØÂÆå‰∫ÜÊ∏à„Åø
            // „Åì„ÅÆÈñ¢Êï∞„ÅØÁÑ°ÂäπÂåñÔºàLocalStorage„Åã„Çâ„ÅÆÂæ©Ê¥ª„ÇíÈò≤Ê≠¢Ôºâ
            console.log('üìÅ [PROJECT MIGRATE] ÁßªË°åÊ©üËÉΩ„ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºàFirebaseÂÆåÂÖ®ÁßªË°åÊ∏à„ÅøÔºâ');
            return;
        }
        
        // „Éá„Éê„ÉÉ„Ç∞Áî®: LocalStorage„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ¢∫Ë™ç
        function checkLocalStorageProjects() {
            // üî• [REMOVED] LocalStorage„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éê„ÉÉ„Ç∞Âá∫Âäõ„ÇíÂâäÈô§ÔºàFirebaseÁµ±Âêà„Å´„Çà„Çä‰∏çË¶ÅÔºâ
            console.log('üîç [DEBUG] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„ÇøÁ¢∫Ë™çÔºàFirebaseÂ∞ÇÁî®„É¢„Éº„ÉâÔºâ');
        }
        
        function displayUserInfo(user) {
            // „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÇíÊõ¥Êñ∞
            const headerUserName = document.getElementById('header-user-name');
            if (headerUserName) {
                headerUserName.textContent = `${user.name}`;
            }

            console.log('‚úÖ „É≠„Ç∞„Ç§„É≥Á¢∫Ë™ç:', user.name, user.role);
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': 'ÈñãÁô∫ËÄÖ',
                'admin': '„Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜËÄÖ',
                'project_manager': '„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜËÄÖ',
                'user': '‰∏ÄËà¨„É¶„Éº„Ç∂„Éº',
                'viewer': 'Èñ≤Ë¶ßËÄÖ'
            };
            return roleNames[role] || role;
        }
        
        // Phase 1: Ê®©ÈôêÂèñÂæóÊ©üËÉΩ„ÅÆ„ÅøÔºàË°®Á§∫Âà∂Âæ°„Å™„ÅóÔºâ
        function getCurrentUser() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user) {
                    // systemUsers„Åã„ÇâÊó•Êú¨Ë™ûÂêç„ÇíÂèñÂæó
                    let displayName = session.user.name;
                    console.log(`üîç [GET-USER-DEBUG] session.user.name: "${session.user.name}", email: "${session.user.email}"`);

                    // systemUsers„Åã„ÇâÊ≠£„Åó„ÅÑÊó•Êú¨Ë™ûÂêç„ÇíÊ§úÁ¥¢
                    const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                    console.log(`üîç [GET-USER-DEBUG] systemUsers count: ${systemUsers.length}`);
                    const matchedUser = systemUsers.find(u => u.email === session.user.email);
                    console.log(`üîç [GET-USER-DEBUG] matchedUser:`, matchedUser);

                    if (matchedUser && matchedUser.name) {
                        displayName = matchedUser.name;
                        console.log(`üë§ [GET-USER] systemUsers„Åã„ÇâÊó•Êú¨Ë™ûÂêçÂèñÂæó: ${displayName} (${session.user.email})`);
                    } else {
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÈÇ®‰∏≠Â§©Áúü„ÅÆÁâπÂà•Âá¶ÁêÜ
                        if (session.user.email === 'muranaka-tenma@terracom.co.jp') {
                            displayName = 'ÈÇ®‰∏≠Â§©Áúü';
                        }
                        console.log(`‚ö†Ô∏è [GET-USER] systemUsers„Å´Ë¶ã„Å§„Åã„Çâ„Åö„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂêç„Çí‰ΩøÁî®: ${displayName}`);
                    }

                    console.log(`‚úÖ [GET-USER-DEBUG] ÊúÄÁµÇÁöÑ„Å™displayName: "${displayName}"`);
                    return {
                        name: displayName,
                        email: session.user.email,
                        role: session.user.role,
                        isLoggedIn: true
                    };
                }
            } catch (error) {
                console.error('‚ùå [GET-USER] „Çª„ÉÉ„Ç∑„Éß„É≥ÂèñÂæó„Ç®„É©„Éº:', error);
                localStorage.removeItem('currentSession');
            }
            
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
            try {
                const user = localStorage.getItem('currentUser');
                if (user) {
                    const userName = typeof user === 'string' ? user : JSON.parse(user).name;
                    if (userName && (userName.includes('ÈÇ®‰∏≠Â§©Áúü') || userName.includes('muranaka'))) {
                        return {
                            name: 'ÈÇ®‰∏≠Â§©Áúü',
                            email: 'muranaka-tenma@terracom.co.jp',
                            role: 'developer',
                            isLoggedIn: true
                        };
                    }
                }
            } catch (error) {
                console.error('„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Ç®„É©„Éº:', error);
            }
            
            return {
                name: null,
                email: null,
                role: null,
                isLoggedIn: false
            };
        }
        
        // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞ÔºàÂÖ±ÈÄöÔºâ
        function hasPermission(requiredRoles) {
            const currentUser = getCurrentUser();
            if (!currentUser.isLoggedIn) {
                console.log('‚ùå [PERMISSION] Êú™„É≠„Ç∞„Ç§„É≥');
                return false;
            }
            
            const hasAccess = requiredRoles.includes(currentUser.role);
            console.log(`üîê [PERMISSION] ${currentUser.name} (${currentUser.role}) => ÂøÖË¶ÅÊ®©Èôê: [${requiredRoles.join(', ')}] => ${hasAccess ? '‚úÖ' : '‚ùå'}`);
            
            return hasAccess;
        }
        
        // ÁÆ°ÁêÜËÄÖÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºà‰æøÂà©Èñ¢Êï∞Ôºâ
        function isAdminOrDeveloper() {
            return hasPermission(['admin', 'developer']);
        }
        
        // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩÔºàÂÆåÂÖ®ÂÆüË£ÖÔºâ
        function checkUserPermission() {
            // Ê®©Èôê„ÅÆÊï¥ÂêàÊÄß„ÇíÊúÄÂàù„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Éª‰øÆÊ≠£
            ensureUserPermissionsIntegrity();
            
            const currentUser = getCurrentUser();
            console.log('üîê ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±:', currentUser);
            
            if (currentUser && currentUser.isLoggedIn) {
                console.log(`‚úÖ „É≠„Ç∞„Ç§„É≥Á¢∫Ë™ç: ${currentUser.name} (${currentUser.role})`);
                
                // Ê®©Èôê„Å´Âü∫„Å•„ÅèUIÂà∂Âæ°„ÇíÂÆüË°å
                updateUIBasedOnPermissions(currentUser);
            } else {
                console.log('‚ùå Êú™„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã');
            }
            
            return currentUser;
        }
        
        // Ê®©Èôê„Å´Âü∫„Å•„ÅèUIÂà∂Âæ°
        function updateUIBasedOnPermissions(user) {
            const { role } = user;
            
            // ÈñãÁô∫ËÄÖÊ©üËÉΩ„ÅÆË°®Á§∫Âà∂Âæ°
            const developerSection = document.getElementById('developer-menu-section');
            if (developerSection) {
                if (role === 'developer') {
                    developerSection.style.display = 'block';
                    console.log('‚úÖ ÈñãÁô∫ËÄÖÊ©üËÉΩ: Ë°®Á§∫');
                } else {
                    developerSection.style.display = 'none';
                    console.log('üö´ ÈñãÁô∫ËÄÖÊ©üËÉΩ: ÈùûË°®Á§∫');
                }
            }
            
            // ÁÆ°ÁêÜÊ©üËÉΩ„ÅÆË°®Á§∫Âà∂Âæ°
            const adminSection = document.getElementById('admin-menu-section');
            if (adminSection) {
                if (role === 'developer' || role === 'admin') {
                    adminSection.style.display = 'block';
                    console.log('‚úÖ ÁÆ°ÁêÜÊ©üËÉΩ: Ë°®Á§∫');

                    // ÁÆ°ÁêÜËÄÖÂ∞ÇÁî®„É™„É≥„ÇØ„ÅÆÂà∂Âæ°ÔºàID„ÅßÂèñÂæóÔºâ
                    const userManagementLink = document.getElementById('user-management-link');
                    const adminDashboardLink = document.getElementById('admin-dashboard-link');

                    if (userManagementLink) userManagementLink.style.display = 'block';
                    if (adminDashboardLink) adminDashboardLink.style.display = 'block';
                } else {
                    adminSection.style.display = 'none';
                    console.log('üö´ ÁÆ°ÁêÜÊ©üËÉΩ: ÈùûË°®Á§∫');
                }
            }

            // Âè≥„Çµ„Ç§„Éâ„Éë„Éç„É´„ÅÆÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫Âà∂Âæ°
            const rightPanelAdminSection = document.getElementById('right-panel-admin-section');
            if (rightPanelAdminSection) {
                if (role === 'developer' || role === 'admin') {
                    rightPanelAdminSection.style.display = 'block';
                    console.log('‚úÖ Âè≥„Éë„Éç„É´ÁÆ°ÁêÜÊ©üËÉΩ: Ë°®Á§∫');
                } else {
                    rightPanelAdminSection.style.display = 'none';
                    console.log('üö´ Âè≥„Éë„Éç„É´ÁÆ°ÁêÜÊ©üËÉΩ: ÈùûË°®Á§∫');
                }
            }
        }
        
        // Phase 2: „Éû„Ç§„Éö„Éº„Ç∏„Éú„Çø„É≥„ÅÆÂâäÈô§Ôºà„Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„Å´ÁßªË°åÔºâ
        function removeMyProfileButton() {
            try {
                const myProfileBtn = document.getElementById('my-profile-btn');
                if (myProfileBtn) {
                    myProfileBtn.remove();
                    console.log('üóëÔ∏è [Phase 2] „Éû„Ç§„Éö„Éº„Ç∏„Éú„Çø„É≥„ÇíÂâäÈô§Ôºà„Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„Å´ÁßªË°åÔºâ');
                }
            } catch (error) {
                console.error('‚ùå [Phase 2] „Éû„Ç§„Éö„Éº„Ç∏„Éú„Çø„É≥ÂâäÈô§„Ç®„É©„Éº:', error);
            }
        }
        
        // Phase 3: ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅÆ„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥ÈùûË°®Á§∫
        function hideUserManagementForUsers() {
            try {
                const currentUser = getCurrentUser();
                if (!currentUser.isLoggedIn) {
                    console.log('‚ùå [Phase 3] Êú™„É≠„Ç∞„Ç§„É≥: Âá¶ÁêÜ„Çπ„Ç≠„ÉÉ„Éó');
                    return;
                }
                
                console.log(`üîê [Phase 3] Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ: ${currentUser.name} (${currentUser.role})`);
                
                // ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅÆÂ†¥Âêà„ÅÆ„Åø„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
                if (currentUser.role === 'user') {
                    const userMgmtBtn = document.querySelector('button[onclick*="user-management.html"]');
                    if (userMgmtBtn) {
                        userMgmtBtn.style.display = 'none';
                        console.log('üîí [Phase 3] ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº: „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫');
                    } else {
                        console.log('‚ö†Ô∏è [Phase 3] „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                } else {
                    console.log(`‚úÖ [Phase 3] ${currentUser.role}Ê®©Èôê: „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥Ë°®Á§∫Á∂≠ÊåÅ`);
                }
                
                // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆÊõ¥Êñ∞
                setTimeout(() => {
                    updateHamburgerMenu();
                    console.log('üçî [Phase 3] „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÊõ¥Êñ∞ÂÆå‰∫Ü');
                }, 200);
                
            } catch (error) {
                console.error('‚ùå [Phase 3] „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥Âà∂Âæ°„Ç®„É©„Éº:', error);
            }
        }
        
        // FirebaseÁµ±Âêà„É¢„Éº„Éâ - ÂæìÊù•„ÅÆË™çË®º„ÉÅ„Çß„ÉÉ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó
        
        // FirebaseÂÆåÂÖ®Âåñ: „Çø„Çπ„ÇØ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñ¢Êï∞
        async function loadTasks() {
            try {
                console.log('üì• [LOAD-TASKS] FirebaseÂ∞ÇÁî®„É¢„Éº„Éâ - „Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÈñãÂßã');

                // üî• FirebaseË™çË®ºÁ¢∫Ë™ç
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (!currentUser) {
                    console.warn('‚ö†Ô∏è [LOAD-TASKS] FirebaseÊú™Ë™çË®º - Á©∫ÈÖçÂàó„ÇíËøî„Åô');
                    tasks = [];
                    window.tasks = tasks;
                    return [];
                }

                console.log('‚úÖ [LOAD-TASKS] FirebaseË™çË®ºÊ∏à„Åø:', currentUser.email);

                // Firebase„Åã„Çâ„Çø„Çπ„ÇØÂèñÂæó
                if (!window.FirebaseDB?.getTasks) {
                    console.error('‚ùå [LOAD-TASKS] FirebaseDB.getTasksÊú™ÂÆöÁæ©');
                    tasks = [];
                    window.tasks = tasks;
                    return [];
                }

                const result = await window.FirebaseDB.getTasks();
                if (result.success && result.tasks) {
                    tasks = result.tasks;
                    window.tasks = tasks;
                    console.log('‚úÖ [LOAD-TASKS] FirebaseË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', tasks.length, '‰ª∂');
                    return tasks;
                } else {
                    console.warn('‚ö†Ô∏è [LOAD-TASKS] FirebaseË™≠„ÅøËæº„ÅøÂ§±Êïó:', result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº');
                    tasks = [];
                    window.tasks = tasks;
                    return [];
                }
            } catch (error) {
                console.error('‚ùå [LOAD-TASKS] ‰∫àÊúü„Åõ„Å¨„Ç®„É©„Éº:', error);
                tasks = [];
                window.tasks = tasks;
                return [];
            }
        }

        // üîß „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆcolumnIDÁßªË°åÈñ¢Êï∞
        async function migrateProjectTaskColumnIds() {
            try {
                console.log('üîÑ [MIGRATE-COLUMN] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆcolumnIDÁßªË°åÈñãÂßã...');

                if (!window.FirebaseDB || !window.firebaseAuth?.currentUser) {
                    console.log('‚è≠Ô∏è [MIGRATE-COLUMN] FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
                    return;
                }

                let migratedCount = 0;
                const tasksToUpdate = [];

                // „É°„É¢„É™ÂÜÖ„ÅßÂÖ®„Çø„Çπ„ÇØ„ÅÆcolumnId„Çí‰øÆÊ≠£
                for (const task of tasks) {
                    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„Åß„ÄÅcolumnId„Åå„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂõ∫ÊúâÂΩ¢Âºè„Åß„Å™„ÅÑÂ†¥Âêà
                    if (task.projectId && task.columnId && !task.columnId.startsWith(`pj_${task.projectId}_`)) {
                        console.log(`üîÑ [MIGRATE-COLUMN] ÁßªË°åÂØæË±°: "${task.title}" (${task.columnId} ‚Üí pj_${task.projectId}_0)`);

                        // ÊúÄÂàù„ÅÆ„Ç´„É©„É†ID„Å´Â§âÊõ¥Ôºà„É°„É¢„É™ÂÜÖ„ÅßÂç≥Â∫ß„Å´‰øÆÊ≠£Ôºâ
                        task.columnId = `pj_${task.projectId}_0`;
                        tasksToUpdate.push(task);
                        migratedCount++;
                    }
                }

                if (migratedCount === 0) {
                    console.log('‚úÖ [MIGRATE-COLUMN] ÁßªË°å‰∏çË¶Å - „Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÅåÊ≠£„Åó„ÅÑcolumnID„Åß„Åô');
                    return;
                }

                // „É°„É¢„É™ÂÜÖ„Åß„ÅØÊó¢„Å´‰øÆÊ≠£Ê∏à„Åø - ÁîªÈù¢„Å´„ÅØË°®Á§∫„Åï„Çå„Çã
                console.log(`‚úÖ [MIGRATE-COLUMN] „É°„É¢„É™ÂÜÖ„Åß${migratedCount}‰ª∂„ÅÆcolumnID„Çí‰øÆÊ≠£ÂÆå‰∫Ü`);

                // Firebase„Å´Êõ¥Êñ∞„Çí‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßË©¶Ë°å„ÄÅ„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºâ
                console.log(`üî• [MIGRATE-COLUMN] ${migratedCount}‰ª∂„ÇíFirebase„Å´‰øùÂ≠òË©¶Ë°å‰∏≠...`);
                let savedCount = 0;
                for (const task of tasksToUpdate) {
                    if (task.firebaseId) {
                        try {
                            const result = await window.FirebaseDB.updateTask(task.firebaseId, {
                                columnId: task.columnId,
                                updatedAt: new Date().toISOString()
                            });

                            if (result.success) {
                                savedCount++;
                            } else {
                                console.warn(`‚ö†Ô∏è [MIGRATE-COLUMN] Firebase‰øùÂ≠ò„Çπ„Ç≠„ÉÉ„Éó: ${task.title} (Ë°®Á§∫„Å´„ÅØÂΩ±Èüø„Å™„Åó)`);
                            }
                        } catch (error) {
                            console.warn(`‚ö†Ô∏è [MIGRATE-COLUMN] Firebase‰øùÂ≠ò„Çπ„Ç≠„ÉÉ„Éó: ${task.title} (Ë°®Á§∫„Å´„ÅØÂΩ±Èüø„Å™„Åó)`);
                        }
                    }
                }

                if (savedCount > 0) {
                    console.log(`‚úÖ [MIGRATE-COLUMN] ${savedCount}/${migratedCount}‰ª∂„ÇíFirebase„Å´‰øùÂ≠òÂÆå‰∫Ü`);
                } else {
                    console.log(`‚ö†Ô∏è [MIGRATE-COLUMN] Firebase‰øùÂ≠ò„ÅØ0‰ª∂Ôºà„É°„É¢„É™ÂÜÖ‰øÆÊ≠£„ÅßÁîªÈù¢„Å´„ÅØË°®Á§∫„Åï„Çå„Åæ„ÅôÔºâ`);
                }
            } catch (error) {
                console.error('‚ùå [MIGRATE-COLUMN] ÁßªË°å„Ç®„É©„Éº:', error);
            }
        }

        // FirebaseÁµ±Âêà„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñ¢Êï∞
        async function loadTemplates() {
            try {
                if (window.FirebaseAuth?.getCurrentUser() && window.FirebaseDB) {
                    try {
                        const result = await window.FirebaseDB.getTemplates();
                        if (result.success) {
                            localStorage.setItem('taskTemplates', JSON.stringify(result.templates));
                            window.templatesUnsubscribe = result.unsubscribe;
                            return result.templates;
                        }
                    } catch (firebaseError) {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    }
                }
                
                return JSON.parse(localStorage.getItem('taskTemplates') || '[]');
                
            } catch (error) {
                console.error('‚ùå „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                return JSON.parse(localStorage.getItem('taskTemplates') || '[]');
            }
        }
        
        // FirebaseÂåñ: LocalStorageË™≠„ÅøËæº„ÅøÈñ¢Êï∞„ÇíÂªÉÊ≠¢
        function loadTasksFromStorage() {
            // Firebase„Åã„Çâ„ÅÆ„ÅøË™≠„ÅøËæº„Åø
            return [];
        }

        // FirebaseËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºàFirestore„ÅåËá™ÂãïÁöÑ„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàêÔºâ
        function createPeriodicBackup() {
            // Firebase Firestore„ÅØËá™ÂãïÁöÑ„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åô„Çã„Åü„ÇÅ„ÄÅ
            // LocalStorage„Éô„Éº„Çπ„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅØ‰∏çË¶Å
            console.log('üíæ [BACKUP] FirebaseËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰∏≠...');
        }

        // 5ÂàÜÊØé„Å´Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
        setInterval(createPeriodicBackup, 5 * 60 * 1000);
        
        // üÜò ÈáçË§á„Çø„Çπ„ÇØ„ÅÆËá™ÂãïÊ§úÂá∫„Å®ÂâäÈô§
        async function checkAndRemoveDuplicates() {
            try {
                // FirebaseÊé•Á∂öÁ¢∫Ë™ç
                if (!window.FirebaseDB || !window.firebaseAuth?.currentUser) {
                    console.log('‚è≠Ô∏è [DUPLICATE-CHECK] FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
                    return;
                }
                
                console.log('üîç [DUPLICATE-CHECK] ÂÆöÊúüÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã...');
                
                // „Çø„Çπ„ÇØÂèñÂæó
                const result = await window.FirebaseDB.getTasks();
                if (!result.success || !result.tasks) {
                    console.log('‚è≠Ô∏è [DUPLICATE-CHECK] „Çø„Çπ„ÇØÂèñÂæóÂ§±Êïó„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
                    return;
                }
                
                const tasks = result.tasks;
                
                // „Çø„Çπ„ÇØID„ÅßÈáçË§áÊ§úÂá∫
                const taskGroups = {};
                tasks.forEach(task => {
                    const id = task.id;
                    if (!taskGroups[id]) {
                        taskGroups[id] = [];
                    }
                    taskGroups[id].push(task);
                });
                
                // ÈáçË§á„Çø„Çπ„ÇØ„ÇíÊ§úÂá∫
                const duplicates = [];
                Object.keys(taskGroups).forEach(id => {
                    if (taskGroups[id].length > 1) {
                        duplicates.push({
                            id: id,
                            count: taskGroups[id].length,
                            tasks: taskGroups[id]
                        });
                    }
                });
                
                if (duplicates.length === 0) {
                    console.log('‚úÖ [DUPLICATE-CHECK] ÈáçË§á„Çø„Çπ„ÇØ„Å™„Åó');
                    return;
                }
                
                console.log(`‚ö†Ô∏è [DUPLICATE-CHECK] ${duplicates.length}Á®ÆÈ°û„ÅÆÈáçË§á„Çø„Çπ„ÇØ„ÇíÊ§úÂá∫`);

                // Ë©≥Á¥∞„É≠„Ç∞„ÇíÂá∫Âäõ
                duplicates.forEach(dup => {
                    console.log(`üîç [DUPLICATE-CHECK] ÈáçË§áID: ${dup.id} (${dup.count}ÂÄã)`);
                    dup.tasks.forEach((task, index) => {
                        console.log(`  ${index + 1}. „Çø„Ç§„Éà„É´: "${task.title}"`);
                        console.log(`      - task.id: ${task.id}`);
                        console.log(`      - task.firebaseId: ${task.firebaseId || '„Å™„Åó'}`);
                        console.log(`      - task.createdAt: ${task.createdAt || '„Å™„Åó'}`);
                        console.log(`      - „Çø„Çπ„ÇØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂÖ®‰Ωì:`, task);
                    });
                });

                // üõ°Ô∏è ÂÆâÂÖ®Á≠ñ: Ëá™ÂãïÂâäÈô§„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„ÄÅ„É≠„Ç∞„ÅÆ„ÅøÂá∫Âäõ
                console.log('‚ö†Ô∏è [DUPLICATE-CHECK] Ëá™ÂãïÂâäÈô§„ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºàÂÆâÂÖ®„ÅÆ„Åü„ÇÅÔºâ');
                console.log('üí° [DUPLICATE-CHECK] ‰∏äË®ò„ÅÆ„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÄÅÊú¨ÂΩì„Å´ÈáçË§á„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;

                // ‰ª•‰∏ã„ÅØÁÑ°ÂäπÂåñÔºàÂæå„ÅßÊúâÂäπÂåñ„Åô„ÇãÂ†¥Âêà„ÅØ„Ç≥„É°„É≥„ÉàËß£Èô§Ôºâ
                /*
                // Ëá™ÂãïÂâäÈô§ÔºàÊúÄÂàù„ÅÆ„Çø„Çπ„ÇØ„ÇíÊÆã„Åó„ÄÅ2Áï™ÁõÆ‰ª•Èôç„ÇíÂâäÈô§Ôºâ
                let deletedCount = 0;
                for (const dup of duplicates) {
                    for (let i = 1; i < dup.tasks.length; i++) {
                        const taskToDelete = dup.tasks[i];
                        try {
                            const deleteId = taskToDelete.firebaseId || taskToDelete.id;
                            const deleteResult = await window.FirebaseDB.deleteTask(deleteId);
                            if (deleteResult.success) {
                                deletedCount++;
                                console.log(`üóëÔ∏è [DUPLICATE-CHECK] Ëá™ÂãïÂâäÈô§: "${taskToDelete.title}"`);
                            }
                        } catch (error) {
                            console.error(`‚ùå [DUPLICATE-CHECK] ÂâäÈô§„Ç®„É©„Éº:`, error);
                        }
                        // FirebaseË≤†Ëç∑ËªΩÊ∏õ
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }
                */
                
                if (deletedCount > 0) {
                    console.log(`‚úÖ [DUPLICATE-CHECK] ${deletedCount}ÂÄã„ÅÆÈáçË§á„Çø„Çπ„ÇØ„ÇíËá™ÂãïÂâäÈô§`);
                    // ÁîªÈù¢„ÇíÊõ¥Êñ∞
                    loadTasks();
                }
                
            } catch (error) {
                console.error('‚ùå [DUPLICATE-CHECK] „Ç®„É©„Éº:', error);
            }
        }
        
        // 10ÂàÜÊØé„Å´ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
        setInterval(checkAndRemoveDuplicates, 10 * 60 * 1000);

        // ÊâãÂãï„ÅßÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å„Åß„Åç„ÇãÈñ¢Êï∞Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
        window.manualDuplicateCheck = async function() {
            console.log('üîß [MANUAL-CHECK] ÊâãÂãïÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å...');
            await checkAndRemoveDuplicates();
        };

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ - FirebaseÂ∞ÇÁî® (ÂàùÊúüÂåñÈÅÖÂª∂)
        // tasksÂ§âÊï∞„ÅØÊó¢„Å´‰∏äÈÉ®„ÅßÂÆ£Ë®ÄÊ∏à„Åø
        window.tasks = undefined; // FirebaseË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Åæ„ÅßÊú™ÂÆöÁæ©
        
        // „Éá„Éº„ÇøÁßªË°åÂØæÁ≠ñÔºö„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Éá„Éº„Çø„ÅÆ‰∫íÊèõÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
        function migrateProjectData() {
            try {
                const projectSettings = JSON.parse(localStorage.getItem('projectSettings') || '{}');
                let needsMigration = false;
                
                // Êó¢Â≠ò„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅÂøÖË¶Å„Éï„Ç£„Éº„É´„Éâ„ÇíËøΩÂä†
                Object.keys(projectSettings).forEach(projectId => {
                    const project = projectSettings[projectId];
                    if (!project.columns) {
                        // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„ÇíË®≠ÂÆö
                        project.columns = DEFAULT_PROJECT_COLUMNS;
                        needsMigration = true;
                    }
                    if (!project.createdAt) {
                        project.createdAt = new Date().toISOString();
                        needsMigration = true;
                    }
                    if (!project.createdBy) {
                        project.createdBy = getCurrentUser().name || '„Ç∑„Çπ„ÉÜ„É†';
                        needsMigration = true;
                    }
                });
                
                if (needsMigration) {
                    // üî• LocalStorage‰øùÂ≠ò„ÅØÂâäÈô§ÔºàFirebaseÁßªË°å„Å´„Çà„Çä‰∏çË¶ÅÔºâ
                    // localStorage.setItem('projectSettings', JSON.stringify(projectSettings)); // üî• ÂâäÈô§
                    console.log('üîÑ [MIGRATION] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Éá„Éº„ÇøÁßªË°å„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàFirebaseÁÆ°ÁêÜÔºâ');
                }
            } catch (error) {
                console.error('‚ùå [MIGRATION] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Éá„Éº„ÇøÁßªË°å„Ç®„É©„Éº:', error);
            }
        }
        
        // „Éá„Éº„ÇøÁßªË°åÂÆüË°å
        migrateProjectData();
        
        // „Çø„Çπ„ÇØÈÖçÂàó„ÅÆÂàùÊúüÂåñÁ¢∫Ë™ç
        if (!tasks || !Array.isArray(tasks)) {
            tasks = [];
            window.tasks = [];
            console.log('üîß [INIT] „Çø„Çπ„ÇØÈÖçÂàó„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
        }
        
        // Êó¢Â≠ò„Çø„Çπ„ÇØ„Å´createdAt„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÁèæÂú®ÊôÇÂàª„Åã„ÇâÈÅ°„Å£„Å¶Ë®≠ÂÆö
        // Ôºà„Ç§„É≥„Éù„Éº„Éà„Åï„Çå„Åü„Çø„Çπ„ÇØ„Å™„Å©Áî®Ôºâ
        tasks = tasks.map((task, index) => {
            if (!task.createdAt) {
                // „Ç§„É≥„Éù„Éº„ÉàÈ†Ü„ÇíËÄÉÊÖÆ„Åó„Å¶„ÄÅÂè§„ÅÑ„Çø„Çπ„ÇØ„ÅØ7Êó•Ââç„ÄÅÊñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÅØ‰ªäÊó•„Å®„Åó„Å¶Ë®≠ÂÆö
                const daysAgo = Math.floor((tasks.length - index - 1) / Math.max(1, tasks.length / 7));
                const createdDate = new Date();
                createdDate.setDate(createdDate.getDate() - daysAgo);
                task.createdAt = createdDate.toISOString();
                console.log(`üìÖ [MIGRATION] Added createdAt to task ${task.id}: ${daysAgo} days ago`);
            }
            return task;
        });
        
        // ÂÅúÊªû„Çø„Çπ„ÇØ„ÅÆ„ÉÜ„Çπ„ÉàÁî®„Çµ„É≥„Éó„É´„ÇíËøΩÂä†ÔºàÂàùÂõû„ÅÆ„ÅøÔºâ- ÁÑ°ÂäπÂåñ
        // const hasStaleTestTask = tasks.some(task => task.title.includes('„ÄêÂÅúÊªû„ÉÜ„Çπ„Éà„Äë'));
        // if (!hasStaleTestTask) {
        //     // ÂÅúÊªû„ÉÜ„Çπ„Éà„Çø„Çπ„ÇØ„ÅÆËá™ÂãïÁîüÊàê„ÇíÁÑ°ÂäπÂåñ - „É¶„Éº„Ç∂„Éº„É™„ÇØ„Ç®„Çπ„Éà„Å´„Çà„Çã
        //     console.log('üö´ [INIT] Stale test task creation disabled');
        // }
        
        // FirebaseÂÆåÂÖ®ÁßªË°å: „Çø„Çπ„ÇØ„ÅØFirestore„Åß„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„Åï„Çå„Çã
        
        let draggedTask = null;
        let editingTask = null;
        let taskCounter = tasks.length || 0;
        
        // ÊãÖÂΩìËÄÖ„É™„Çπ„ÉàÔºàFirebaseÁµ±ÂêàÔºâ
        // assigneesÂ§âÊï∞„ÅØÊó¢„Å´‰∏äÈÉ®„ÅßÂÆ£Ë®ÄÊ∏à„Åø
        window.assignees = assignees; // „Ç∞„É≠„Éº„Éê„É´„Å´„ÇÇË®≠ÂÆö
        
        // „Äå„É¶„Éº„Ç∂„Éº„Äç„ÇíÊãÖÂΩìËÄÖ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§Ôºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàóÂØæÂøúÔºâ
        assignees = assignees.filter(assignee => {
            const name = assignee.name || assignee;
            return name !== '„É¶„Éº„Ç∂„Éº';
        });
        if (assignees.length === 0) {
            // ÊãÖÂΩìËÄÖ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº„Åã„ÇâÂèñÂæó
            const activeUsers = getActiveUsers();
            if (activeUsers.length > 0) {
                // „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„Å®„Åó„Å¶Ë®≠ÂÆöÔºà„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Éô„Éº„ÇπË≠òÂà•Ôºâ
                assignees = activeUsers.map(u => ({email: u.email, name: u.name}));
                console.log('üë• [ASSIGNEE CLEANUP] „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº„Åã„ÇâÊãÖÂΩìËÄÖ„ÇíÂæ©ÂÖÉ:', assignees.map(a => a.name));
            } else {
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº„ÇÇÁ©∫„ÅÆÂ†¥Âêà„ÄÅÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†
                const currentUser = getCurrentUser();
                if (currentUser && currentUser.name && currentUser.name !== '„Ç≤„Çπ„Éà') {
                    assignees = [{email: currentUser.email || 'unknown@temp.local', name: currentUser.name}];
                    console.log('üë§ [ASSIGNEE CLEANUP] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÊãÖÂΩìËÄÖ„Å®„Åó„Å¶Ë®≠ÂÆö:', assignees.map(a => a.name));
                } else {
                    // ÊúÄÂæå„ÅÆÊâãÊÆµ„Å®„Åó„Å¶„ÄåÊú™Ë®≠ÂÆö„Äç„ÇíËøΩÂä†
                    assignees = [{email: 'unset@temp.local', name: 'Êú™Ë®≠ÂÆö'}];
                    console.log('‚ö†Ô∏è [ASSIGNEE CLEANUP] „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö:', assignees.map(a => a.name));
                }
            }
        }
        // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅØFirestore„ÅßÁÆ°ÁêÜ„Åï„Çå„Çã
        
        // ‰∏ÄÂõûÈôê„Çä„ÅÆ„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÁΩÆÊèõÂá¶ÁêÜ
        function migrateSampleDataToRealUser() {
            const migrationKey = 'sampleDataMigrated';
            if (localStorage.getItem(migrationKey)) return; // Êó¢„Å´ÂÆüË°åÊ∏à„Åø
            
            // Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Åã„ÇâÂÆü„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            
            let realUser = null;
            if (currentSession && currentSession.user) {
                realUser = currentSession.user.name; // „É≠„Ç∞„Ç§„É≥‰∏≠„É¶„Éº„Ç∂„Éº
            } else if (systemUsers.length > 0) {
                // ÈñãÁô∫ËÄÖÊ®©Èôê„É¶„Éº„Ç∂„Éº„ÇíÂÑ™ÂÖàÁöÑ„Å´ÈÅ∏Êäû
                const developerUser = systemUsers.find(u => u.role === 'developer');
                realUser = developerUser ? developerUser.name : systemUsers[0].name;
            } else {
                realUser = 'ÈÇ®‰∏≠Â§©Áúü'; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            }
            
            const sampleUsers = ['Áî∞‰∏≠ÈÉ®Èï∑', '‰ΩêËó§Ë™≤Èï∑', 'Èà¥Êú®‰∏ª‰ªª', 'Â±±Áî∞„Åï„Çì', 'Â±±Áî∞‰∏ª‰ªª', 'Èà¥Êú®‰øÇÈï∑'];
            let updated = false;

            // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅÆÁΩÆÊèõÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàóÂØæÂøúÔºâ
            assignees = assignees.map(item => {
                const name = item.name || item;
                if (sampleUsers.includes(name)) {
                    updated = true;
                    console.log(`üîÑ ÁΩÆÊèõ: ${name} ‚Üí ${realUser}`);
                    // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„ÅØÂêçÂâç„ÇíÁΩÆÊèõ„ÄÅÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„Åæ
                    if (item.name) {
                        return {email: item.email, name: realUser};
                    }
                    return realUser;
                }
                return item;
            });

            // ÈáçË§á„ÇíÂâäÈô§„Åó„ÄÅÂÆü„É¶„Éº„Ç∂„Éº„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
            const uniqueNames = new Set(assignees.map(a => a.name || a));
            assignees = assignees.filter((item, index) => {
                const name = item.name || item;
                const firstIndex = assignees.findIndex(a => (a.name || a) === name);
                return index === firstIndex;
            });
            if (!uniqueNames.has(realUser)) {
                assignees.push({email: 'fallback@terracom.co.jp', name: realUser});
                updated = true;
            }
            
            if (updated) {
                // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅØFirestore„ÅßÁÆ°ÁêÜ„Åï„Çå„Çã
                console.log(`‚úÖ „Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíÂÆü„É¶„Éº„Ç∂„Éº„Äå${realUser}„Äç„Å´ÁΩÆÊèõÂÆå‰∫Ü:`, assignees);
            }
            
            // „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            localStorage.setItem(migrationKey, 'true');
        }
        
        // „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å
        migrateSampleDataToRealUser();
        
        // „Ç´„É©„É†ÂÆöÁæ©ÔºàLocalStorage„Åã„ÇâÂàùÊúüË™≠„ÅøËæº„Åø„ÄÅÂæå„ÅßFirestore„Åã„Çâ‰∏äÊõ∏„ÅçÔºâ
        let columns = JSON.parse(localStorage.getItem('kanbanColumns') || '[{"id":"todo","title":"TODO","color":"#667eea"},{"id":"phase1","title":"Phase1","color":"#f59e0b"},{"id":"phase2","title":"Phase2","color":"#f97316"},{"id":"phase3","title":"Phase3","color":"#8b5cf6"},{"id":"done","title":"Done","color":"#10b981"},{"id":"trash","title":"Archive","color":"#6c757d"}]');

        // „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÂº∑Âà∂ËøΩÂä†
        const trashColumn = columns.find(c => c.id === 'trash');
        console.log('[ARCHIVE] ÁèæÂú®„ÅÆ„Ç´„É©„É†:', columns.map(c => c.id));
        console.log('[ARCHIVE] „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†Â≠òÂú®:', !!trashColumn);

        if (!trashColumn) {
            columns.push({"id":"trash","title":"Archive","color":"#6c757d"});
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            console.log('[ARCHIVE] „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
        } else {
            console.log('[ARCHIVE] „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô');
        }

        // 2025-12-16Âæ©Êóß: Firestore„Ç´„É©„É†Ë®≠ÂÆöÈÄ£Êê∫
        async function saveColumnsToFirestore() {
            try {
                if (window.FirebaseDB && window.FirebaseDB.saveColumns && window.firebaseAuth?.currentUser) {
                    const result = await window.FirebaseDB.saveColumns(columns);
                    if (result.success) {
                        console.log('[COLUMNS] Firestore‰øùÂ≠òÊàêÂäü');
                    }
                }
            } catch (error) {
                console.error('[COLUMNS] Firestore‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // 2025-12-16Âæ©Êóß: Firestore„Åã„Çâ„Ç´„É©„É†Ë®≠ÂÆö„ÇíÂàùÊúüÂåñ
        async function initColumnsFromFirestore() {
            try {
                if (!window.FirebaseDB || !window.FirebaseDB.getColumns || !window.firebaseAuth?.currentUser) {
                    console.log('[COLUMNS] FirebaseÊú™Ê∫ñÂÇô„ÄÅLocalStorage‰ΩøÁî®');
                    return;
                }

                // „Åæ„Åö„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíË©¶Ë°å
                await window.FirebaseDB.migrateColumnsToFirestore();

                // Firestore„Åã„Çâ„Ç´„É©„É†Ë®≠ÂÆö„ÇíÂèñÂæó
                const result = await window.FirebaseDB.getColumns();
                if (result.success && result.columns && Array.isArray(result.columns)) {
                    columns = result.columns;
                    localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                    console.log('[COLUMNS] Firestore„Åã„ÇâË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', columns.length + '‰ª∂');

                    // done/trash„Ç´„É©„É†„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!columns.find(c => c.id === 'done')) {
                        columns.push({"id":"done","title":"Done","color":"#10b981"});
                    }
                    if (!columns.find(c => c.id === 'trash')) {
                        columns.push({"id":"trash","title":"Archive","color":"#6c757d"});
                    }

                    // UI„ÇíÂÜçÊèèÁîª
                    if (typeof renderBoard === 'function') {
                        renderBoard();
                    }
                } else {
                    console.log('[COLUMNS] Firestore„Å´„Éá„Éº„Çø„Å™„Åó„ÄÅLocalStorage‰ΩøÁî®');
                }
            } catch (error) {
                console.error('[COLUMNS] FirestoreÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }
        
        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜÔºàFirebaseÁµ±ÂêàÂØæÂøúÔºâ
        // taskTemplatesÂ§âÊï∞„ÅØÊó¢„Å´‰∏äÈÉ®„ÅßÂÆ£Ë®ÄÊ∏à„Åø
        let editingTemplateId = null;
        
        // „Éê„É´„ÇØÊìç‰ΩúÁÆ°ÁêÜ
        let isBulkMode = false;
        let selectedTasks = new Set();
        
        // „Éï„Ç£„É´„ÇøÁÆ°ÁêÜÔºàPhase 2ÂØæÂøúÔºâ
        let selectedAssigneeFilters = [];
        let selectedProjectFilters = [];
        let viewMode = 'personal'; // 'personal' or 'project'
        
        // ÂÆöÊúü„Çø„Çπ„ÇØÁÆ°ÁêÜ
        let recurringTemplates = JSON.parse(localStorage.getItem('recurringTemplates') || '[]');
        
        // Phase 2: „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØÈñ¢ÈÄ£Èñ¢Êï∞Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàêÂ∞ÇÁî®Ôºâ
        function isPJTaskMode() {
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã„Åß„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É¢„Éº„Éâ„ÇíÂà§ÂÆö
            const projectSettings = document.getElementById('project-task-settings');
            return projectSettings && projectSettings.style.display === 'block';
        }

        // üîí „ÄêDONE/TRASHÂà§ÂÆö„Éò„É´„Éë„Éº„Äë„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÇÇÈÄöÂ∏∏„Çø„Çπ„ÇØ„Å®Âêå„ÅòDONE/TRASHÊ©üËÉΩ„ÇíÊåÅ„Åü„Åõ„Çã

        // „Ç´„É©„É†ID„Åã„Çâ„Ç´„É©„É†Âêç„ÇíÂèñÂæóÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÅÆÂ†¥ÂêàÔºâ
        function getColumnNameById(columnId) {
            if (!columnId) return '';

            // ÈÄöÂ∏∏„Çø„Çπ„ÇØ„ÅÆ„Ç´„É©„É†ID„ÅØ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
            if (columnId === 'done' || columnId === 'trash' || columnId === 'todo' || columnId === 'in-progress') {
                return columnId;
            }

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÅÆÂ†¥ÂêàÔºàpj_{projectId}_{index}ÂΩ¢ÂºèÔºâ
            if (columnId.startsWith('pj_')) {
                const parts = columnId.split('_');
                if (parts.length >= 3) {
                    const projectId = parts[1];
                    const columnIndex = parseInt(parts[2]);

                    // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
                    if (cachedProjectsData && cachedProjectsData[projectId]) {
                        const project = cachedProjectsData[projectId];
                        if (project.columns && project.columns[columnIndex]) {
                            return project.columns[columnIndex];
                        }
                    }
                }
            }

            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: columnId„Çí„Åù„ÅÆ„Åæ„ÅæËøî„Åô
            return columnId;
        }

        // „Ç´„É©„É†ID„Åæ„Åü„ÅØ„Ç´„É©„É†Âêç„Åã„ÇâDONE„Ç´„É©„É†„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
        function isDoneColumn(columnId) {
            if (!columnId) return false;

            // ÈÄöÂ∏∏„Çø„Çπ„ÇØ„ÅÆDONE„Ç´„É©„É†
            if (columnId === 'done') return true;

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÅÆÂ†¥Âêà„ÅØÂêçÂâç„ÇíÂèñÂæó„Åó„Å¶„Åã„ÇâÂà§ÂÆö
            const columnName = getColumnNameById(columnId);
            const lowerColumnName = columnName.toLowerCase();

            return lowerColumnName.includes('ÂÆå‰∫Ü') ||
                   lowerColumnName.includes('done') ||
                   lowerColumnName.includes('ÂÆåÊàê');
        }

        // „Ç´„É©„É†ID„Åæ„Åü„ÅØ„Ç´„É©„É†Âêç„Åã„ÇâTRASH„Ç´„É©„É†„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
        function isTrashColumn(columnId) {
            if (!columnId) return false;

            // ÈÄöÂ∏∏„Çø„Çπ„ÇØ„ÅÆTRASH„Ç´„É©„É†
            if (columnId === 'trash') return true;

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÅÆÂ†¥Âêà„ÅØÂêçÂâç„ÇíÂèñÂæó„Åó„Å¶„Åã„ÇâÂà§ÂÆö
            const columnName = getColumnNameById(columnId);
            const lowerColumnName = columnName.toLowerCase();

            return lowerColumnName.includes('„Ç¢„Éº„Ç´„Ç§„Éñ') ||
                   lowerColumnName.includes('„Ç¥„ÉüÁÆ±') ||
                   lowerColumnName.includes('trash') ||
                   lowerColumnName.includes('ÂâäÈô§');
        }


        
        // Áµ±Âêà„Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩÔºàÊãÖÂΩìËÄÖ + „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÔºâ
        function toggleAssigneeFilterDropdown() {
            const dropdown = document.getElementById('assignee-filter-dropdown');
            const isVisible = dropdown.style.display === 'block';
            
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                populateAssigneeFilterOptions();
                dropdown.style.display = 'block';
            }
        }
        
        function populateAssigneeFilterOptions() {
            const dropdown = document.getElementById('assignee-filter-dropdown');
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº„ÅÆ„Åø„ÇíÂèñÂæóÔºàÁÑ°ÂäπÂåñ„ÉªÈùûË°®Á§∫„É¶„Éº„Ç∂„Éº„ÇíÈô§Â§ñÔºâ
            const activeUserNames = getActiveUserNames();
            
            // ÂÖ®„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæóÔºàÈáçË§áÈô§ÂéªÔºâ
            const projectMap = new Map();
            tasks.filter(t => t.projectId && t.projectId !== null)
                 .forEach(t => {
                     if (!projectMap.has(t.projectId)) {
                         projectMap.set(t.projectId, {id: t.projectId, name: t.projectName});
                     }
                 });
            const allProjects = Array.from(projectMap.values());
            
            dropdown.innerHTML = `
                <div style="padding: 0.5rem;">
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 0.5rem; padding: 0.25rem;">üë§ ÊãÖÂΩìËÄÖ</div>
                    <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                        <input type="radio" name="filter-type" value="" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedAssigneeFilters.length === 0 && selectedProjectFilters.length === 0 ? 'checked' : ''}>
                        <span>ÂÖ®Âì°</span>
                    </label>
                    ${activeUserNames.map(assignee => `
                        <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                            <input type="radio" name="filter-type" value="assignee:${assignee}" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedAssigneeFilters.includes(assignee) && selectedProjectFilters.length === 0 ? 'checked' : ''}>
                            <span>${assignee}</span>
                        </label>
                    `).join('')}
                </div>
            `;
        }
        
        function updateAssigneeFilterSelection() {
            const selectedRadio = document.querySelector('#assignee-filter-dropdown input[name="filter-type"]:checked');
            
            // „É°„É≥„Éê„Éº„Éï„Ç£„É´„Çø„Éº„ÅÆ„Åø„É™„Çª„ÉÉ„ÉàÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº„ÅØÁ∂≠ÊåÅÔºâ
            selectedAssigneeFilters = [];
            
            if (selectedRadio && selectedRadio.value) {
                const [type, value] = selectedRadio.value.split(':');
                
                if (type === 'assignee') {
                    selectedAssigneeFilters = [value];
                    console.log(`üë§ [FILTER] Switched to assignee: ${value}`);
                }
            } else {
                console.log(`üë• [FILTER] Showing all tasks`);
            }
            
            updateAssigneeFilterText();
            render();
            updateStats();
            
            // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíËá™Âãï„ÅßÈñâ„Åò„Çã
            const dropdown = document.getElementById('assignee-filter-dropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }
        
        function updateAssigneeFilterText() {
            const textElement = document.getElementById('assignee-filter-text');
            
            if (selectedProjectFilters.length > 0) {
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂèñÂæó
                const projectSettings = JSON.parse(localStorage.getItem('projectSettings') || '{}');
                const project = projectSettings[selectedProjectFilters[0]];
                const projectName = project ? project.name : '„Éó„É≠„Ç∏„Çß„ÇØ„Éà';
                
                if (selectedAssigneeFilters.length > 0) {
                    textElement.textContent = `üë• ${projectName} - üë§ ${selectedAssigneeFilters[0]}`;
                } else {
                    textElement.textContent = `üë• ${projectName} - ÂÖ®Âì°`;
                }
            } else if (selectedAssigneeFilters.length > 0) {
                textElement.textContent = `üë§ ${selectedAssigneeFilters[0]}`;
            } else {
                textElement.textContent = 'ÂÖ®Âì°';
            }
        }
        
        function showFilterHelp() {
            const helpText = `
üë• Ë°®Á§∫ÂØæË±°„Éï„Ç£„É´„Çø„Éº„Å´„Å§„ÅÑ„Å¶

„Äêüë§ ÊãÖÂΩìËÄÖÈÅ∏Êäû„Äë
‚Ä¢ ÁâπÂÆö„ÅÆÊãÖÂΩìËÄÖ„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫
‚Ä¢ ÂÄã‰∫∫„ÅÆ‰ΩúÊ•≠Áä∂Ê≥Å„ÇíÁ¢∫Ë™ç

„Äêüë• „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû„Äë
‚Ä¢ ÁâπÂÆö„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫
‚Ä¢ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆW„ÉÅ„Çß„ÉÉ„ÇØÁÆ°ÁêÜÁî®
‚Ä¢ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÄ≤Êçó„ÅÆ‰∏ÄÂÖÉÁ¢∫Ë™ç

„ÄêÂÖ®Âì°„Äë
‚Ä¢ ÂÖ®„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫
‚Ä¢ „ÉÅ„Éº„É†ÂÖ®‰Ωì„ÅÆÁä∂Ê≥ÅÊääÊè°

üí° ÂÄã‰∫∫Ë°®Á§∫„Å®„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË°®Á§∫„ÅØÊéí‰ªñÁöÑ„Åß„Åô„ÄÇ
`;
            alert(helpText);
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàêÊ©üËÉΩ
        function createProjectTask() {
            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê„ÅØ pj-create.html „ÅßÂÆüË°å
            console.log('üîÑ [PROJECT CREATE] Redirecting to pj-create.html...');
            window.location.href = 'pj-create.html';
        }
        
        function generateRecurringTask(template) {
            const now = new Date();
            
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊñáÂ≠óÂàó„ÅÆÁΩÆÊèõ
            const title = formatTemplateString(template.taskTemplate.title, now);
            const deadline = calculateDeadline(now, template.deadlineConfig);
            
            const task = {
                id: Date.now(),
                title: title,
                deadline: deadline.toISOString(),
                priority: template.taskTemplate.priority,
                assignees: template.taskTemplate.assignees || [],
                assignee: template.taskTemplate.assignees?.[0] || 'Êú™Ë®≠ÂÆö',
                memo: template.taskTemplate.memo || '',
                attachments: [],
                comments: [],
                columnId: 'todo',
                completed: false,
                createdAt: now.toISOString(),
                
                // „Çø„Çπ„ÇØÈùûË°®Á§∫Ê©üËÉΩ
                isHidden: false,
                
                // PJ„Çø„Çπ„ÇØÂØæÂøú
                projectId: template.taskTemplate.projectId,
                projectName: template.taskTemplate.projectName,
                personalStatus: 'todo',
                projectStatus: 'todo',
                pendingMove: null,
                approvers: template.taskTemplate.approvers || [],
                lastApprovedBy: null,
                approvedAt: null,
                
                // ÂÆöÊúü„Çø„Çπ„ÇØÊÉÖÂ†±
                isRecurring: true,
                recurringTemplateId: template.id,
                generatedFor: formatDateForRecurring(now)
            };
            
            return task;
        }
        
        function formatTemplateString(template, date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            return template
                .replace(/\{\{YYYY\}\}/g, year)
                .replace(/\{\{YYYYÂπ¥\}\}/g, `${year}Âπ¥`)
                .replace(/\{\{MM\}\}/g, String(month).padStart(2, '0'))
                .replace(/\{\{MMÊúà\}\}/g, `${month}Êúà`)
                .replace(/\{\{DD\}\}/g, String(day).padStart(2, '0'))
                .replace(/\{\{DDÊó•\}\}/g, `${day}Êó•`);
        }
        
        function calculateDeadline(baseDate, deadlineConfig) {
            const deadline = new Date(baseDate);
            deadline.setDate(deadline.getDate() + deadlineConfig.relativeDays);
            
            const [hours, minutes] = deadlineConfig.timeOfDay.split(':');
            deadline.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            return deadline;
        }
        
        function formatDateForRecurring(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            return `${year}-${String(month).padStart(2, '0')}`;
        }
        
        function checkAndGenerateRecurringTasks() {
            const now = new Date();
            let generatedCount = 0;
            
            recurringTemplates.forEach(template => {
                if (shouldGenerateRecurringTask(template, now)) {
                    const newTask = generateRecurringTask(template);
                    tasks.unshift(newTask);
                    
                    // Ê¨°ÂõûÁîüÊàêÊó•„ÇíÊõ¥Êñ∞
                    updateNextGenerationDate(template, now);
                    generatedCount++;
                    
                    console.log(`üîÑ [RECURRING] Generated task: ${newTask.title} for ${newTask.generatedFor}`);
                }
            });
            
            if (generatedCount > 0) {
                saveTasks();
                saveRecurringTemplates();
                render();
                updateStats();
                console.log(`üîÑ [RECURRING] Generated ${generatedCount} recurring tasks`);
            }
        }
        
        function shouldGenerateRecurringTask(template, now) {
            if (!template.isActive) return false;
            
            const nextGen = template.generationConfig.nextGeneration 
                ? new Date(template.generationConfig.nextGeneration) 
                : now;
            
            return now >= nextGen;
        }
        
        function updateNextGenerationDate(template, currentDate) {
            const config = template.recurringConfig;
            const next = new Date(currentDate);
            
            switch (config.type) {
                case 'daily':
                    next.setDate(next.getDate() + config.interval);
                    break;
                case 'weekly':
                    next.setDate(next.getDate() + (7 * config.interval));
                    break;
                case 'monthly':
                    next.setMonth(next.getMonth() + config.interval);
                    break;
                case 'yearly':
                    next.setFullYear(next.getFullYear() + config.interval);
                    break;
            }
            
            template.generationConfig.lastGenerated = currentDate.toISOString();
            template.generationConfig.nextGeneration = next.toISOString();
        }
        
        function showRecurringTasksInfo() {
            showRecurringTasksManagement();
        }
        
        function showRecurringTasksManagement() {
            const activeTemplates = recurringTemplates.filter(t => t.isActive);
            const recurringTasks = tasks.filter(t => t.isRecurring);
            
            const modal = document.createElement('div');
            modal.id = 'recurring-tasks-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #805ad5 0%, #667eea 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                        <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            üîÑ ÂÆöÊúü„Çø„Çπ„ÇØÁÆ°ÁêÜ
                            <button onclick="document.getElementById('recurring-tasks-modal').remove()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
                        </h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">ÊØéÊúà„ÉªÊØéÈÄ±„ÅÆÁπ∞„ÇäËøî„Åó„Çø„Çπ„ÇØ„ÇíÁÆ°ÁêÜ</p>
                    </div>
                    
                    <div style="padding: 1.5rem; overflow-y: auto; max-height: 60vh;">
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: #2d3748; margin: 0 0 1rem 0;">üìä ÁèæÂú®„ÅÆÁä∂Ê≥Å</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #805ad5;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #805ad5;">${activeTemplates.length}</div>
                                    <div style="color: #4a5568; font-size: 0.9rem;">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÉÜ„É≥„Éó„É¨„Éº„Éà</div>
                                </div>
                                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #38a169;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">${recurringTasks.length}</div>
                                    <div style="color: #4a5568; font-size: 0.9rem;">ÁîüÊàêÊ∏à„Åø„Çø„Çπ„ÇØ</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                            <button onclick="createRecurringTemplate()" style="background: #805ad5; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ‚ûï „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê
                            </button>
                            <button onclick="generatePendingTasks()" style="background: #3182ce; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                üîÑ ‰ªä„Åô„ÅêÁîüÊàê„ÉÅ„Çß„ÉÉ„ÇØ
                            </button>
                            <button onclick="showRecurringTasksInfo_Old()" style="background: #718096; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                üìã Á∞°ÊòìË°®Á§∫
                            </button>
                        </div>
                        
                        ${activeTemplates.length > 0 ? `
                            <div>
                                <h4 style="color: #2d3748; margin: 0 0 1rem 0;">üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${activeTemplates.map(template => {
                                        const nextGen = template.generationConfig?.nextGeneration ? 
                                            new Date(template.generationConfig.nextGeneration).toLocaleDateString('ja-JP') : 'Êú™Ë®≠ÂÆö';
                                        const typeText = getRecurringTypeText(template.recurringConfig?.type || 'monthly');
                                        
                                        return `
                                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                    <div style="font-weight: 600; color: #2d3748;">${template.name || '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêçÊú™Ë®≠ÂÆö'}</div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button onclick="alert('Á∑®ÈõÜÊ©üËÉΩ„ÅØËøëÊó•ÂÆüË£Ö‰∫àÂÆö„Åß„Åô')" style="background: #edf2f7; border: 1px solid #e2e8f0; color: #4a5568; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Á∑®ÈõÜ</button>
                                                        <button onclick="alert('ÂÅúÊ≠¢Ê©üËÉΩ„ÅØËøëÊó•ÂÆüË£Ö‰∫àÂÆö„Åß„Åô')" style="background: #fed7d7; border: 1px solid #feb2b2; color: #c53030; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ÂÅúÊ≠¢</button>
                                                    </div>
                                                </div>
                                                <div style="font-size: 0.85rem; color: #4a5568; line-height: 1.4;">
                                                    <div>üìÖ È†ªÂ∫¶: ${typeText}</div>
                                                    <div>‚è∞ Ê¨°ÂõûÁîüÊàê: ${nextGen}</div>
                                                    <div>üë• ÊãÖÂΩìËÄÖ: ${template.taskTemplate?.assignees ? template.taskTemplate.assignees.join(', ') : 'Êú™Ë®≠ÂÆö'}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 2rem; color: #718096;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                                <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">ÂÆöÊúü„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                                <div style="font-size: 0.9rem;">Êñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„ÄÅÁπ∞„ÇäËøî„Åó„Çø„Çπ„ÇØ„ÇíËá™ÂãïÂåñ„Åó„Åæ„Åó„Çá„ÅÜ</div>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ÂÖÉ„ÅÆÁ∞°ÊòìË°®Á§∫Èñ¢Êï∞Ôºà‰∏ã‰Ωç‰∫íÊèõÁî®Ôºâ
        function showRecurringTasksInfo_Old() {
            const activeTemplates = recurringTemplates.filter(t => t.isActive);
            const recurringTasks = tasks.filter(t => t.isRecurring);
            
            let infoText = `üîÑ ÂÆöÊúü„Çø„Çπ„ÇØÁÆ°ÁêÜ\n\n`;
            infoText += `üìä ÁèæÂú®„ÅÆÁä∂Ê≥Å:\n`;
            infoText += `‚Ä¢ ÂÆöÊúü„ÉÜ„É≥„Éó„É¨„Éº„Éà: ${activeTemplates.length}‰ª∂\n`;
            infoText += `‚Ä¢ ÁîüÊàêÊ∏à„Åø„Çø„Çπ„ÇØ: ${recurringTasks.length}‰ª∂\n\n`;
            
            if (activeTemplates.length > 0) {
                infoText += `üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß:\n`;
                activeTemplates.forEach((template, index) => {
                    const nextGen = template.generationConfig?.nextGeneration 
                        ? new Date(template.generationConfig.nextGeneration).toLocaleDateString('ja-JP')
                        : 'Êú™Ë®≠ÂÆö';
                    infoText += `${index + 1}. ${template.name}\n`;
                    infoText += `   Á®ÆÈ°û: ${getRecurringTypeText(template.recurringConfig?.type || 'monthly')}\n`;
                    infoText += `   Ê¨°ÂõûÁîüÊàê: ${nextGen}\n\n`;
                });
            }
            
            if (recurringTasks.length > 0) {
                infoText += `üìù ÁîüÊàêÊ∏à„Åø„Çø„Çπ„ÇØ:\n`;
                const recentTasks = recurringTasks.slice(0, 5);
                recentTasks.forEach(task => {
                    const status = getColumnTitle(task.columnId);
                    infoText += `‚Ä¢ ${task.title} (${status})\n`;
                });
                if (recurringTasks.length > 5) {
                    infoText += `...‰ªñ${recurringTasks.length - 5}‰ª∂\n`;
                }
            }
            
            infoText += `\nüí° „Éí„É≥„Éà: ÂÆöÊúü„Çø„Çπ„ÇØ„ÅØËá™ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÄÅüîÑ„Ç¢„Ç§„Ç≥„É≥„ÅßË≠òÂà•„Åß„Åç„Åæ„Åô„ÄÇ`;
            
            alert(infoText);
        }
        
        function getRecurringTypeText(type) {
            const typeMap = {
                'daily': 'ÊØéÊó•',
                'weekly': 'ÊØéÈÄ±',
                'monthly': 'ÊØéÊúà',
                'yearly': 'ÊØéÂπ¥'
            };
            return typeMap[type] || type;
        }
        
        // Êó•‰ªò„ÉªÊôÇÈñì„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function getCurrentDateTime() {
            return new Date();
        }
        
        function isOverdue(deadline, columnId) {
            // ÂÆå‰∫Ü„Ç´„É©„É†ÔºàÈÄöÂ∏∏„Çø„Çπ„ÇØ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰∏°ÂØæÂøúÔºâ„ÅØÊúüÈôêÂàá„ÇåÂà§ÂÆö„Åó„Å™„ÅÑ
            if (isDoneColumn(columnId)) return false;
            // „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†ÔºàÈÄöÂ∏∏„Çø„Çπ„ÇØ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰∏°ÂØæÂøúÔºâ„ÅØÊúüÈôêÂàá„ÇåÂà§ÂÆö„Åó„Å™„ÅÑ
            if (isTrashColumn(columnId)) return false;
            return new Date(deadline) < getCurrentDateTime();
        }

        function isToday(deadline, columnId) {
            // ÂÆå‰∫Ü„Ç´„É©„É†ÔºàÈÄöÂ∏∏„Çø„Çπ„ÇØ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰∏°ÂØæÂøúÔºâ„ÅØÊú¨Êó•ÊúüÈôêÂà§ÂÆö„Åó„Å™„ÅÑ
            if (isDoneColumn(columnId)) return false;
            // „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†ÔºàÈÄöÂ∏∏„Çø„Çπ„ÇØ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰∏°ÂØæÂøúÔºâ„ÅØÊú¨Êó•ÊúüÈôêÂà§ÂÆö„Åó„Å™„ÅÑ
            if (isTrashColumn(columnId)) return false;
            const today = new Date();
            const deadlineDate = new Date(deadline);
            return today.toDateString() === deadlineDate.toDateString();
        }
        
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getDefaultDeadlineString() {
            // Êó•‰ªò„ÅØ‰ªäÊó•„ÇíË®≠ÂÆöÔºà„É≠„Éº„Ç´„É´Êó•‰ªòÂü∫Ê∫ñÔºâ
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getDefaultTimeString() {
            // ÁèæÂú®ÊôÇÂàª+3ÊôÇÈñì„Çí„Éá„Éï„Ç©„É´„ÉàÊôÇÂàª„Å®„Åó„Å¶Ë®≠ÂÆö
            const now = new Date();
            const futureDate = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // 3ÊôÇÈñìÂæå
            
            const hours = futureDate.getHours();
            const minutes = futureDate.getMinutes();
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        function getDefaultDateTimeAfter3Hours() {
            // ÁèæÂú®ÊôÇÂàª+3ÊôÇÈñìÂæå„ÅÆÊó•‰ªò„Å®ÊôÇÈñì„ÇíÊ≠£Á¢∫„Å´Ë®àÁÆó
            const now = new Date();
            const futureDate = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // 3ÊôÇÈñìÂæå
            
            const year = futureDate.getFullYear();
            const month = (futureDate.getMonth() + 1).toString().padStart(2, '0');
            const day = futureDate.getDate().toString().padStart(2, '0');
            const hours = futureDate.getHours();
            const minutes = futureDate.getMinutes();
            
            return {
                date: `${year}-${month}-${day}`,
                time: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`
            };
        }
        
        // Áµ±‰∏Ä„Ç´„Éº„Éâ‰ΩúÊàêÈñ¢Êï∞ÔºàÁîªÈù¢‰∏äÈÉ®„ÅÆ„Éú„Çø„É≥Áî®Ôºâ
        async function createTaskUnified() {
            console.log('üìù [CREATE UNIFIED] Starting unified task creation...');
            editingTask = null;
            document.getElementById('modal-title').textContent = 'Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = getDefaultDeadlineString();
            document.getElementById('task-time-input').value = getDefaultTimeString();
            // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§
            document.getElementById('task-memo-input').value = '';
            document.getElementById('task-files-input').value = '';
            document.getElementById('attached-files-list').innerHTML = '';
            
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÇíÂàùÊúüÂåñ
            initializeTemplateSelector();
            
            // „Ç´„É©„É†ÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ„ÇíË°®Á§∫„Åó„ÄÅÂàùÊúüÂåñ
            const columnSelectionGroup = document.getElementById('column-selection-group');
            const columnSelect = document.getElementById('task-column-input');
            columnSelectionGroup.style.display = 'block';
            
            // „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // „Éá„Éï„Ç©„É´„Éà„ÅßÊúÄÂàù„ÅÆ„Ç´„É©„É†„ÇíÈÅ∏Êäû
            if (columns.length > 0) {
                columnSelect.value = columns[0].id;
            }
            
            // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            updateAssigneeOptions();
            clearSelectedAssignees();

            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            await updateProjectOptions();

            // „Ç≥„É°„É≥„ÉàË°®Á§∫„Çí„ÇØ„É™„Ç¢
            displayComments([]);
            
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÇíÁÑ°ÂäπÂåñÔºàÊñ∞Ë¶è„Çø„Çπ„ÇØ„ÅÆÂ†¥ÂêàÔºâ
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÇíÂ∏∏„Å´ÊúâÂäπÂåñ
            document.getElementById('comment-input').disabled = false;
            document.getElementById('comments-section').innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„Åß„Åô„ÄÇ‰øùÂ≠òÂæå„Å´„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ</div>';
            
            // PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï„Åó„Åü„Åü„ÇÅ„ÄÅ„Åì„ÅÆÂá¶ÁêÜ„ÅØ‰∏çË¶Å
            
            // Áµ±‰∏Ä‰ΩúÊàê„É¢„Éº„Éâ„ÇíË®≠ÂÆö
            document.getElementById('task-modal').dataset.unifiedMode = 'true';
            
            // „Éö„Éº„Ç∏„Éà„ÉÉ„Éó„Å´„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åã„Çâ„É¢„Éº„ÉÄ„É´Ë°®Á§∫
            window.scrollTo(0, 0);

            // „É¢„Éº„ÉÄ„É´ÂÜÖÈÉ®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí‰∫ãÂâç„Å´„É™„Çª„ÉÉ„Éà
            const modalElement = document.getElementById('task-modal');
            if (modalElement) {
                modalElement.scrollTop = 0;
                const modalContent = modalElement.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }
                // Â∑¶ÂÅ¥„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç®„É™„Ç¢„ÇÇ„É™„Çª„ÉÉ„Éà
                const modalLeft = modalElement.querySelector('.modal-left');
                if (modalLeft) {
                    modalLeft.scrollTop = 0;
                }
            }

            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');

                // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´ÂÜçÂ∫¶„Éà„ÉÉ„Éó„Çπ„ÇØ„É≠„Éº„É´ÔºàÁ¢∫ÂÆü„Å´Ôºâ
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safari„Å´„ÇÇÂØæÂøú
                    document.documentElement.scrollTop = 0; // IE„Å´„ÇÇÂØæÂøú

                    // „É¢„Éº„ÉÄ„É´Ëá™‰Ωì„ÇÇ‰∏äÈÉ®„Å´ÈÖçÁΩÆ„ÇíÂº∑Âà∂
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                        const modalContent = modalElement.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.scrollTop = 0;
                        }
                        // Â∑¶ÂÅ¥„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç®„É™„Ç¢„ÇÇ„É™„Çª„ÉÉ„Éà
                        const modalLeft = modalElement.querySelector('.modal-left');
                        if (modalLeft) {
                            modalLeft.scrollTop = 0;
                        }
                    }
                }, 10);

                // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        // „Çø„Çπ„ÇØ‰ΩúÊàê„ÉªÁ∑®ÈõÜ
        function createTask(columnId) {
            editingTask = null;
            document.getElementById('modal-title').textContent = 'Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = getDefaultDeadlineString();
            document.getElementById('task-time-input').value = getDefaultTimeString();
            // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§
            document.getElementById('task-memo-input').value = '';
            document.getElementById('task-files-input').value = '';
            document.getElementById('attached-files-list').innerHTML = '';
            
            // „Ç´„É©„É†ÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫
            document.getElementById('column-selection-group').style.display = 'none';
            document.getElementById('task-column-input').removeAttribute('required');
            
            // PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï„Åó„Åü„Åü„ÇÅ„ÄÅ„Åì„ÅÆÂá¶ÁêÜ„ÅØ‰∏çË¶Å
            
            // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            updateAssigneeOptions();
            clearSelectedAssignees();
            
            // „Ç≥„É°„É≥„ÉàË°®Á§∫„Çí„ÇØ„É™„Ç¢
            displayComments([]);
            
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÇíÁÑ°ÂäπÂåñÔºàÊñ∞Ë¶è„Çø„Çπ„ÇØ„ÅÆÂ†¥ÂêàÔºâ
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÇíÂ∏∏„Å´ÊúâÂäπÂåñ
            document.getElementById('comment-input').disabled = false;
            document.getElementById('comments-section').innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„Åß„Åô„ÄÇ‰øùÂ≠òÂæå„Å´„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ</div>';
            
            // „Ç´„É©„É†ÊÉÖÂ†±„Çí‰øùÂ≠ò
            document.getElementById('task-modal').dataset.targetColumn = columnId;
            document.getElementById('task-modal').dataset.unifiedMode = 'false';
            // „Éö„Éº„Ç∏„Éà„ÉÉ„Éó„Å´„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åã„Çâ„É¢„Éº„ÉÄ„É´Ë°®Á§∫
            window.scrollTo(0, 0);

            // „É¢„Éº„ÉÄ„É´ÂÜÖÈÉ®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí‰∫ãÂâç„Å´„É™„Çª„ÉÉ„Éà
            const modalElement = document.getElementById('task-modal');
            if (modalElement) {
                modalElement.scrollTop = 0;
                const modalContent = modalElement.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }
                // Â∑¶ÂÅ¥„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç®„É™„Ç¢„ÇÇ„É™„Çª„ÉÉ„Éà
                const modalLeft = modalElement.querySelector('.modal-left');
                if (modalLeft) {
                    modalLeft.scrollTop = 0;
                }
            }

            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');

                // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´ÂÜçÂ∫¶„Éà„ÉÉ„Éó„Çπ„ÇØ„É≠„Éº„É´ÔºàÁ¢∫ÂÆü„Å´Ôºâ
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safari„Å´„ÇÇÂØæÂøú
                    document.documentElement.scrollTop = 0; // IE„Å´„ÇÇÂØæÂøú

                    // „É¢„Éº„ÉÄ„É´Ëá™‰Ωì„ÇÇ‰∏äÈÉ®„Å´ÈÖçÁΩÆ„ÇíÂº∑Âà∂
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                        const modalContent = modalElement.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.scrollTop = 0;
                        }
                        // Â∑¶ÂÅ¥„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç®„É™„Ç¢„ÇÇ„É™„Çª„ÉÉ„Éà
                        const modalLeft = modalElement.querySelector('.modal-left');
                        if (modalLeft) {
                            modalLeft.scrollTop = 0;
                        }
                    }
                }, 10);

                // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        function updateAssigneeOptions() {
            const container = document.getElementById('assignees-container');
            container.innerHTML = '';

            // assignees„ÅåÊñáÂ≠óÂàóÈÖçÂàó„ÅÆÂ†¥Âêà„ÄÅgetActiveUsers()„Åã„Çâ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó„Åó„Å¶Â§âÊèõ
            const activeUsers = getActiveUsers();
            const emailMap = {};
            activeUsers.forEach(u => {
                if (u.email && u.name) {
                    emailMap[u.name] = u.email;
                }
            });

            // assignees„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„ÅÆÂ†¥Âêà„Å®ÊñáÂ≠óÂàóÈÖçÂàó„ÅÆÂ†¥Âêà„ÅÆ‰∏°Êñπ„Å´ÂØæÂøú
            assignees.forEach(assignee => {
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'assignee-checkbox';

                // „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„ÅÆÂ†¥Âêà: {email, name}
                // ÊñáÂ≠óÂàóÈÖçÂàó„ÅÆÂ†¥Âêà: emailMap„Åã„ÇâÂèñÂæó„ÄÅ„Å™„Åë„Çå„Å∞‰ªÆ„ÅÆ„É°„Éº„É´„ÇíÁîüÊàê
                let email, name;
                if (assignee.email) {
                    email = assignee.email;
                    name = assignee.name;
                } else {
                    name = assignee;
                    email = emailMap[name] || (name.toLowerCase().replace(/\s+/g, '-') + '@temp.local');
                }
                const safeId = email.replace(/[@.]/g, '-'); // ID„Å´‰Ωø„Åà„Å™„ÅÑÊñáÂ≠ó„ÇíÁΩÆÊèõ

                checkboxWrapper.innerHTML = `
                    <input type="checkbox" id="assignee-${safeId}" value="${email}" data-name="${name}" onchange="updateSelectedAssignees()">
                    <label for="assignee-${safeId}">${name}</label>
                `;
                container.appendChild(checkboxWrapper);
            });
            
            // ÈùûË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ≠òÂú®Á¢∫Ë™ç„Å®„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            setTimeout(() => {
                const hiddenCheckbox = document.getElementById('task-hidden-input');
                if (!hiddenCheckbox) {
                    console.error('‚ùå [DEBUG] task-hidden-input „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºÅ');

                    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅÂãïÁöÑ„Å´ËøΩÂä†
                    const memoGroup = document.querySelector('#task-memo-input').parentElement;
                    if (memoGroup) {
                        const hiddenGroup = document.createElement('div');
                        hiddenGroup.className = 'form-group';
                        hiddenGroup.style.marginBottom = '1rem';
                        hiddenGroup.innerHTML = `
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="task-hidden-input" style="margin: 0;">
                                „Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÔºàËá™ÂàÜ„ÅÆ„ÅøÔºâ
                            </label>
                            <small style="color: #666; display: block; margin-top: 0.25rem;">
                                „ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Å®Ëá™ÂàÜ‰ª•Â§ñ„ÅÆ„É¶„Éº„Ç∂„Éº„Åã„Çâ„ÅØË¶ã„Åà„Å™„Åè„Å™„Çä„Åæ„Åô„ÄÇÊãÖÂΩìËÄÖ„ÅØËá™ÂàÜ„ÅÆ„Åø„Å´Âà∂Èôê„Åï„Çå„Åæ„Åô„ÄÇ
                            </small>
                        `;
                        memoGroup.parentElement.insertBefore(hiddenGroup, memoGroup);
                        console.log('‚úÖ [DEBUG] ÈùûË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÂãïÁöÑ„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü');
                    }
                } else {
                    console.log('‚úÖ [DEBUG] task-hidden-input „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåÂ≠òÂú®„Åó„Åæ„Åô');
                }

                // ÈùûË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
                setupHiddenTaskValidation();
            }, 100);
            
            // Êñ∞Ë¶èËøΩÂä†„Éú„Çø„É≥
            const addButton = document.createElement('div');
            addButton.className = 'assignee-checkbox';
            addButton.style.cssText = 'color: #0079bf; font-weight: 500;';
            addButton.innerHTML = '+ Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖ„ÇíËøΩÂä†';
            addButton.onclick = addNewAssignee;
            container.appendChild(addButton);
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
        async function updateProjectOptions() {
            try {
                const projectSelect = document.getElementById('task-project-select');
                if (!projectSelect) return;
                
                // „Éá„Éï„Ç©„É´„Éà„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊÆã„Åó„Å¶„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„Çí„ÇØ„É™„Ç¢
                projectSelect.innerHTML = '<option value="">ÂÄã‰∫∫„Çø„Çπ„ÇØÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„ÅóÔºâ</option>';

                // üî• Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíÂèñÂæó
                let projects = [];
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        projects = result.projects || [];
                    } else {
                        console.error('‚ùå [PROJECT-SELECT] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂèñÂæó„Ç®„É©„Éº:', result.error);
                    }
                } else {
                    console.error('‚ùå [PROJECT-SELECT] FirebaseDB.getProjects„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                }

                const currentUser = getCurrentUser();

                if (projects.length === 0) {
                    return;
                }

                // „É¶„Éº„Ç∂„Éº„Åå„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                const accessibleProjects = projects.filter(project => {
                    // üîß ‰∏ã‰Ωç‰∫íÊèõÊÄß: status„Éï„Ç£„Éº„É´„Éâ„ÅåÁÑ°„ÅÑÂè§„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅØactive„Å®„Åø„Å™„Åô
                    const isActive = project.status === 'active' || !project.status;
                    const isPublic = project.visibility === 'public';
                    const isMember = project.members && project.members.includes(currentUser.email);
                    const isCreator = project.createdBy === currentUser.email;
                    const accessible = isActive && (isPublic || isMember || isCreator);

                    return accessible;
                });
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíËøΩÂä†
                accessibleProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    
                    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„Å®ÂÖ¨ÈñãÁä∂ÊÖã„ÇíË°®Á§∫
                    const visibilityIcon = project.visibility === 'public' ? 'üåê' : 'üîí';
                    const memberCount = project.members.length;
                    option.textContent = `${visibilityIcon} ${project.name} (${memberCount}Âêç)`;
                    
                    projectSelect.appendChild(option);
                });
                
                console.log(`‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞: ${accessibleProjects.length}ÂÄã„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà`);
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÅÆÊõ¥Êñ∞„Ç®„É©„Éº:', error);
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÂ§âÊõ¥ÊôÇ„Å´„Ç´„É©„É†„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
        async function updateColumnOptionsForProject(projectId) {
            const columnSelect = document.getElementById('task-column-input');
            if (!columnSelect) return;

            columnSelect.innerHTML = '';

            if (!projectId) {
                // ÂÄã‰∫∫„Çø„Çπ„ÇØÔºöÊ®ôÊ∫ñ„Ç´„É©„É†„Çí‰ΩøÁî®
                console.log('üìã [COLUMN-UPDATE] Ê®ôÊ∫ñ„Ç´„É©„É†„Å´Âàá„ÇäÊõø„Åà');
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    columnSelect.appendChild(option);
                });
                if (columns.length > 0) {
                    columnSelect.value = columns[0].id;
                }
            } else {
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØÔºö„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂõ∫Êúâ„ÅÆ„Ç´„É©„É†„Çí‰ΩøÁî®
                console.log('üìã [COLUMN-UPDATE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„Å´Âàá„ÇäÊõø„Åà:', projectId);

                // „Ç≠„É£„ÉÉ„Ç∑„É•„Åæ„Åü„ÅØFirebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÇíÂèñÂæó
                let projectColumns = null;

                if (cachedProjectsData && cachedProjectsData[projectId]) {
                    projectColumns = cachedProjectsData[projectId].columns;
                } else if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        const project = result.projects.find(p => p.id === projectId);
                        if (project) {
                            projectColumns = project.columns || DEFAULT_PROJECT_COLUMNS;
                        }
                    }
                }

                // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†
                if (!projectColumns) {
                    projectColumns = DEFAULT_PROJECT_COLUMNS;
                }

                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂõ∫Êúâ„ÅÆ„Ç´„É©„É†ID„ÇíÁîüÊàê
                projectColumns.forEach((columnTitle, index) => {
                    const option = document.createElement('option');
                    option.value = `pj_${projectId}_${index}`;
                    option.textContent = columnTitle;
                    columnSelect.appendChild(option);
                });

                // „Éá„Éï„Ç©„É´„Éà„ÅßÊúÄÂàù„ÅÆ„Ç´„É©„É†„ÇíÈÅ∏Êäû
                if (projectColumns.length > 0) {
                    columnSelect.value = `pj_${projectId}_0`;
                }

                console.log('‚úÖ [COLUMN-UPDATE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†Ë®≠ÂÆöÂÆå‰∫Ü:', projectColumns.length, 'ÂÄã');
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        function setupProjectSelectListener() {
            const projectSelect = document.getElementById('task-project-select');
            if (projectSelect) {
                projectSelect.addEventListener('change', async function() {
                    const selectedProjectId = this.value;
                    console.log('üìÇ [PROJECT-SELECT] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÂ§âÊõ¥:', selectedProjectId || 'ÂÄã‰∫∫„Çø„Çπ„ÇØ');
                    await updateColumnOptionsForProject(selectedProjectId);
                });
                console.log('‚úÖ [SETUP] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');
            }
        }

        function updateSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const wrapper = checkbox.closest('.assignee-checkbox');
                if (checkbox.checked) {
                    wrapper.classList.add('checked');
                } else {
                    wrapper.classList.remove('checked');
                }
            });
        }
        
        function getSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]:checked');
            // data-nameÂ±ûÊÄß„Åã„ÇâÊó•Êú¨Ë™ûÂêç„ÇíÂèñÂæóÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
            return Array.from(checkboxes).map(cb => cb.dataset.name || cb.value);
        }

        // ÈÅ∏Êäû„Åï„Çå„ÅüÊãÖÂΩìËÄÖ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó
        function getSelectedAssigneeEmails() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Å®UIÂà∂Âæ°
        // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function getCurrentUserEmail() {
            const currentUser = getCurrentUser();
            if (currentUser && currentUser.email) {
                return currentUser.email;
            } else if (window.currentFirebaseUser && window.currentFirebaseUser.email) {
                return window.currentFirebaseUser.email;
            }
            console.error('‚ùå [HIDDEN-VALIDATION] „É¶„Éº„Ç∂„Éº„É°„Éº„É´„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
            return null;
        }

        // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂãïÁöÑ„Å´ÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞ÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÁ∂≠ÊåÅÔºâ
        function getCurrentUserDisplayName() {
            // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó
            const userEmail = getCurrentUserEmail();

            if (!userEmail) {
                return null;
            }

            console.log(`üìß [HIDDEN-VALIDATION] „É¶„Éº„Ç∂„Éº„É°„Éº„É´: ${userEmail}`);

            // systemUsers„Åã„Çâ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅßÊó•Êú¨Ë™ûÂêç„ÇíÂèñÂæó
            try {
                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const matchedUser = systemUsers.find(u => u.email === userEmail);

                if (matchedUser && matchedUser.name) {
                    console.log(`‚úÖ [HIDDEN-VALIDATION] systemUsers„Åã„ÇâÂèñÂæó: ${matchedUser.name}`);
                    return matchedUser.name;
                }
            } catch (error) {
                console.error('‚ùå [HIDDEN-VALIDATION] systemUsersÂèñÂæó„Ç®„É©„Éº:', error);
            }

            // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åã„ÇâÊó•Êú¨Ë™ûÂêç„Å∏„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàsystemUsers„Åå‰∏çÂÆåÂÖ®„Å™Â†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            const emailToNameMap = {
                'muranaka-tenma@terracom.co.jp': 'ÈÇ®‰∏≠Â§©Áúü',
                'hashimoto-yumi@terracom.co.jp': 'Ê©ãÊú¨ÂèãÁæé',
                'kato-jun@terracom.co.jp': 'Âä†Ëó§Á¥î',
                'asahi-keiichi@terracom.co.jp': 'ÊúùÊó•Âú≠‰∏Ä',
                'hanzawa-yuka@terracom.co.jp': 'ÂçäÊæ§‰æëÊûú',
                'tamura-wataru@terracom.co.jp': 'Áî∞ÊùëÊ∏â',
                'fukushima-ami@terracom.co.jp': 'Á¶èÂ≥∂ÈòøÁæé'
            };

            if (emailToNameMap[userEmail]) {
                console.log(`‚úÖ [HIDDEN-VALIDATION] „Éû„ÉÉ„Éî„É≥„Ç∞„Åã„ÇâÂèñÂæó: ${emailToNameMap[userEmail]}`);
                return emailToNameMap[userEmail];
            }

            // getCurrentUser()„ÅÆÂêçÂâç„Çí‰ΩøÁî®ÔºàÊúÄÂæå„ÅÆÊâãÊÆµÔºâ
            if (currentUser && currentUser.name) {
                console.warn(`‚ö†Ô∏è [HIDDEN-VALIDATION] „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàgetCurrentUser().nameÔºâ: ${currentUser.name}`);
                return currentUser.name;
            }

            console.error('‚ùå [HIDDEN-VALIDATION] „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
            return null;
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅåË®≠ÂÆöÊ∏à„Åø„Åã„Å©„ÅÜ„Åã„ÅÆ„Éï„É©„Ç∞
        let hiddenValidationSetup = false;

        function setupHiddenTaskValidation() {
            const hiddenCheckbox = document.getElementById('task-hidden-input');
            if (!hiddenCheckbox) return;

            // Êó¢„Å´Ë®≠ÂÆöÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØÈáçË§á„ÇíÈÅø„Åë„Çã
            if (hiddenCheckbox.dataset.validationSetup === 'true') {
                console.log('‚úÖ [HIDDEN-VALIDATION] „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅØÊó¢„Å´Ë®≠ÂÆöÊ∏à„Åø„Åß„Åô');
                return;
            }

            // ÈùûË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ change „Ç§„Éô„É≥„Éà
            hiddenCheckbox.addEventListener('change', function() {
                const isHidden = this.checked;
                console.log(`üîí [HIDDEN-VALIDATION] ÈùûË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØÂ§âÊõ¥: ${isHidden}`);

                // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„É¶„Éº„Ç∂„Éº„ÇíË≠òÂà•ÔºàÊ†πÊú¨Ê≤ªÁôÇÔºâ
                const currentUserEmail = getCurrentUserEmail();
                if (!currentUserEmail) {
                    alert('‚ö†Ô∏è „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    this.checked = false;
                    return;
                }
                console.log(`üë§ [HIDDEN-VALIDATION] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº: ${currentUserEmail}`);

                if (isHidden) {
                    // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÊãÖÂΩìËÄÖ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó
                    const selectedEmails = getSelectedAssigneeEmails();
                    console.log(`üîç [HIDDEN-VALIDATION] ÁèæÂú®„ÅÆÊãÖÂΩìËÄÖ: ${selectedEmails.join(', ')}`);

                    // Ëá™ÂàÜ‰ª•Â§ñ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Ç®„É©„Éº
                    const othersSelected = selectedEmails.filter(email => email !== currentUserEmail);
                    if (othersSelected.length > 0) {
                        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Å´„ÅØÊó•Êú¨Ë™ûÂêç„ÇíË°®Á§∫
                        const otherNames = othersSelected.map(email => {
                            const cb = document.querySelector(`#assignees-container input[value="${email}"]`);
                            return cb ? cb.dataset.name : email;
                        });
                        alert(`‚ö†Ô∏è ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØËá™ÂàÜ„ÅÆ„ÅøÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ\n\n‰ªñ„ÅÆ„É¶„Éº„Ç∂„ÉºÔºà${otherNames.join(', ')}Ôºâ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅÈùûË°®Á§∫„Å´„Åß„Åç„Åæ„Åõ„Çì„ÄÇ`);
                        this.checked = false;
                        return;
                    }

                    // Ëá™ÂàÜ‰ª•Â§ñ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÁÑ°ÂäπÂåñ„Åó„ÄÅËá™ÂàÜ„ÇíËá™Âãï„ÉÅ„Çß„ÉÉ„ÇØ
                    const assigneeCheckboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
                    let selfCheckboxFound = false;
                    assigneeCheckboxes.forEach(checkbox => {
                        if (checkbox.value !== currentUserEmail) {
                            checkbox.disabled = true;
                            checkbox.checked = false; // ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åô
                            const wrapper = checkbox.closest('.assignee-checkbox');
                            if (wrapper) {
                                wrapper.style.opacity = '0.5';
                                wrapper.classList.remove('checked');
                            }
                        } else {
                            // Ëá™ÂàÜ„ÇíËá™Âãï„ÉÅ„Çß„ÉÉ„ÇØ
                            checkbox.checked = true;
                            checkbox.disabled = false;
                            selfCheckboxFound = true;
                            const wrapper = checkbox.closest('.assignee-checkbox');
                            if (wrapper) {
                                wrapper.classList.add('checked');
                                wrapper.style.opacity = '1';
                            }
                            console.log(`‚úÖ [HIDDEN-VALIDATION] Ëá™ÂàÜ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíËá™ÂãïÈÅ∏Êäû: ${currentUserEmail}`);
                        }
                    });

                    if (!selfCheckboxFound) {
                        console.error(`‚ùå [HIDDEN-VALIDATION] Ëá™ÂàÜ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${currentUserEmail}`);
                        console.log(`üìã [HIDDEN-VALIDATION] Âà©Áî®ÂèØËÉΩ„Å™„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ:`,
                            Array.from(assigneeCheckboxes).map(cb => cb.value));
                    }

                    // updateSelectedAssignees„ÇíÂëº„Å≥Âá∫„Åó„Å¶Ë°®Á§∫„ÇíÊõ¥Êñ∞
                    if (typeof updateSelectedAssignees === 'function') {
                        updateSelectedAssignees();
                    }

                    console.log('‚úÖ [HIDDEN-VALIDATION] Ëá™ÂàÜ‰ª•Â§ñ„ÅÆÊãÖÂΩìËÄÖ„ÇíÁÑ°ÂäπÂåñ„Åó„Åæ„Åó„Åü');
                } else {
                    // ÂÖ®„Å¶„ÅÆÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊúâÂäπÂåñ
                    const assigneeCheckboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
                    assigneeCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                        const wrapper = checkbox.closest('.assignee-checkbox');
                        if (wrapper) {
                            wrapper.style.opacity = '1';
                        }
                    });
                    console.log('‚úÖ [HIDDEN-VALIDATION] ÂÖ®„Å¶„ÅÆÊãÖÂΩìËÄÖ„ÇíÊúâÂäπÂåñ„Åó„Åæ„Åó„Åü');
                }
            });

            // „Éï„É©„Ç∞„ÇíË®≠ÂÆö
            hiddenCheckbox.dataset.validationSetup = 'true';
            console.log('‚úÖ [HIDDEN-VALIDATION] „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');

            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å∏„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅØ„ÄÅ„Ç§„Éô„É≥„ÉàÂßîË≠≤„ÅßÂá¶ÁêÜ
            const assigneesContainer = document.getElementById('assignees-container');
            if (assigneesContainer && !assigneesContainer.dataset.hiddenValidation) {
                assigneesContainer.addEventListener('change', function(e) {
                    if (e.target.type !== 'checkbox') return;

                    const isHidden = hiddenCheckbox.checked;
                    if (!isHidden) return; // ÈùûË°®Á§∫„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

                    const currentUserEmail = getCurrentUserEmail();
                    if (!currentUserEmail) return;

                    // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅßËá™ÂàÜ‰ª•Â§ñ„ÇíÈÅ∏Êäû„Åó„Çà„ÅÜ„Å®„Åó„ÅüÂ†¥ÂêàÔºà„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅßÊØîËºÉÔºâ
                    if (e.target.value !== currentUserEmail && e.target.checked) {
                        const displayName = e.target.dataset.name || e.target.value;
                        alert(`‚ö†Ô∏è ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØËá™ÂàÜ„ÅÆ„ÅøÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ\n\n„Äå${displayName}„Äç„ÇíÊãÖÂΩìËÄÖ„Å´ËøΩÂä†„Åß„Åç„Åæ„Åõ„Çì„ÄÇ`);
                        e.target.checked = false;
                    }
                });
                assigneesContainer.dataset.hiddenValidation = 'true';
            }
        }
        
        function setSelectedAssignees(assigneeList) {
            // ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØÈÖçÂàó„Å´Â§âÊèõ
            if (typeof assigneeList === 'string') {
                assigneeList = assigneeList.split(',').map(a => a.trim()).filter(a => a);
            }

            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                // Êó•Êú¨Ë™ûÂêçÔºàdata-nameÔºâ„Åæ„Åü„ÅØ„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºàvalueÔºâ„ÅßÊØîËºÉ
                const name = checkbox.dataset.name || checkbox.value;
                checkbox.checked = assigneeList.includes(name) || assigneeList.includes(checkbox.value);
                const wrapper = checkbox.closest('.assignee-checkbox');
                if (checkbox.checked) {
                    wrapper.classList.add('checked');
                } else {
                    wrapper.classList.remove('checked');
                }
            });
        }
        
        function clearSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.assignee-checkbox').classList.remove('checked');
            });
        }
        
        function addNewAssignee() {
            const newAssignee = prompt('Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (newAssignee && newAssignee.trim()) {
                const trimmedName = newAssignee.trim();
                // „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„ÅßÂêçÂâç„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                const exists = assignees.some(a => (a.name || a) === trimmedName);
                if (!exists) {
                    // ‰ªÆ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÁîüÊàêÔºàÂÆüÈöõ„ÅÆ„É¶„Éº„Ç∂„Éº„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
                    const tempEmail = trimmedName.toLowerCase().replace(/\s+/g, '-') + '@temp.local';
                    assignees.push({email: tempEmail, name: trimmedName});
                    // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅØFirestore„ÅßÁÆ°ÁêÜ„Åï„Çå„Çã
                    updateAssigneeOptions();
                    // Êñ∞„Åó„ÅèËøΩÂä†„Åó„ÅüÊãÖÂΩìËÄÖ„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                    setTimeout(() => {
                        const safeId = tempEmail.replace(/[@.]/g, '-');
                        const newCheckbox = document.getElementById(`assignee-${safeId}`);
                        if (newCheckbox) {
                            newCheckbox.checked = true;
                            updateSelectedAssignees();
                        }
                    }, 100);
                }
            }
        }
        
        async function editTask(taskId) {
            // üîß ÂûãÂ§âÊèõÔºöÊñáÂ≠óÂàó/Êï∞ÂÄ§„Å©„Å°„Çâ„Åß„ÇÇÊ§úÁ¥¢„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
            editingTask = tasks.find(t => t.id == taskId || t.id === String(taskId) || t.id === Number(taskId));
            if (!editingTask) return;

            // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºö‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ
            const currentUser = getCurrentUser();
            if (currentUser.role === 'user') {
                const canEdit = editingTask.assignees && editingTask.assignees.includes(currentUser.name) || 
                               editingTask.assignee === currentUser.name;
                if (!canEdit) {
                    alert('‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Çø„Çπ„ÇØ„ÅØÁ∑®ÈõÜ„Åß„Åç„Åæ„Åõ„Çì„ÄÇËá™ÂàÜ„ÅåÊãÖÂΩìËÄÖ„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ„Åß„Åô„ÄÇ');
                    return;
                }
            }
            
            document.getElementById('modal-title').textContent = '„Çø„Çπ„ÇØÁ∑®ÈõÜ';
            document.getElementById('task-title-input').value = editingTask.title;
            
            console.log('üîç [MODAL DEBUG] Setting up edit modal:');
            console.log('üîç [MODAL DEBUG] Original deadline:', editingTask.deadline);
            console.log('üîç [MODAL DEBUG] Split date part:', editingTask.deadline.split('T')[0]);
            console.log('üîç [MODAL DEBUG] Split time part:', editingTask.deadline.split('T')[1]);
            console.log('üîç [MODAL DEBUG] Time substring:', editingTask.deadline.split('T')[1].substring(0, 5));
            
            // ‚òÖ‚òÖ‚òÖ „Çø„Ç§„É†„Çæ„Éº„É≥ÂïèÈ°å„ÅÆ‰øÆÊ≠£ÔºöJST„ÅßÊ≠£„Åó„ÅèË°®Á§∫ ‚òÖ‚òÖ‚òÖ
            const deadlineDate = new Date(editingTask.deadline);
            const jstOffset = 9 * 60; // JST = UTC+9
            const localDate = new Date(deadlineDate.getTime() + (jstOffset * 60 * 1000));
            
            const dateStr = localDate.toISOString().split('T')[0];
            const timeStr = localDate.toISOString().split('T')[1].substring(0, 5);
            
            console.log('üîç [TIMEZONE FIX] Original deadline:', editingTask.deadline);
            console.log('üîç [TIMEZONE FIX] Deadline as Date object:', deadlineDate);
            console.log('üîç [TIMEZONE FIX] Adjusted for JST:', localDate.toISOString()); 
            console.log('üîç [TIMEZONE FIX] Date string for form:', dateStr);
            console.log('üîç [TIMEZONE FIX] Time string for form:', timeStr);
            
            document.getElementById('task-date-input').value = dateStr;
            document.getElementById('task-time-input').value = timeStr;
            
            console.log('üîç [MODAL DEBUG] After setting form values:');
            console.log('üîç [MODAL DEBUG] Date input now:', document.getElementById('task-date-input').value);
            console.log('üîç [MODAL DEBUG] Time input now:', document.getElementById('task-time-input').value);
            // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§
            document.getElementById('task-memo-input').value = editingTask.memo || '';
            document.getElementById('task-hidden-input').checked = editingTask.isHidden || false;
            
            // „Ç´„É©„É†ÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫ÔºàÁ∑®ÈõÜÊôÇ„ÅØ‰∏çË¶ÅÔºâ
            document.getElementById('column-selection-group').style.display = 'none';
            document.getElementById('task-column-input').removeAttribute('required');
            
            // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞„Åó„Å¶„Åã„ÇâÂÄ§„ÇíË®≠ÂÆö
            updateAssigneeOptions();
            setSelectedAssignees(editingTask.assignees || editingTask.assignee || []);

            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞„Åó„Å¶„Åã„ÇâÂÄ§„ÇíË®≠ÂÆö
            await updateProjectOptions();
            const projectSelect = document.getElementById('task-project-select');
            if (projectSelect && editingTask.projectId) {
                projectSelect.value = editingTask.projectId;
            }
            
            // Phase 2: PJ„Çø„Çπ„ÇØÁ∑®ÈõÜÊôÇ„ÅØPJË®≠ÂÆö„ÇíÈùûË°®Á§∫Ôºà‰ΩúÊàêÊôÇ„ÅÆ„Åø‰ΩøÁî®Ôºâ
            // PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï
            
            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅØ„Çø„Ç§„Éà„É´„Å´Ë°®Á§∫
            const isPJTask = editingTask.projectId && editingTask.projectId !== null;
            if (isPJTask) {
                // ÁÆ°ÁêÜID„ÅØÈùûË°®Á§∫Ôºà„É¶„Éº„Ç∂„Éº„Å´„ÅØ‰∏çË¶Å„Å™ÊÉÖÂ†±Ôºâ
                document.getElementById('modal-title').textContent = `üë• „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØÁ∑®ÈõÜ`;
                console.log(`üéØ [EDIT] Editing project task: ${editingTask.projectId} - ${editingTask.projectName}`);
            } else {
                console.log(`üë§ [EDIT] Editing personal task: ${editingTask.title}`);
            }
            
            // Ê∑ª‰ªò„Éï„Ç°„Ç§„É´Ë°®Á§∫
            displayAttachedFiles(editingTask.attachments || []);
            
            // „Ç≥„É°„É≥„ÉàË°®Á§∫
            displayComments(editingTask.comments || []);
            
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÇíÊúâÂäπÂåñ
            document.getElementById('comment-input').disabled = false;
            
            // „Éö„Éº„Ç∏„Éà„ÉÉ„Éó„Å´„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åã„Çâ„É¢„Éº„ÉÄ„É´Ë°®Á§∫
            window.scrollTo(0, 0);

            // „É¢„Éº„ÉÄ„É´ÂÜÖÈÉ®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí‰∫ãÂâç„Å´„É™„Çª„ÉÉ„Éà
            const modalElement = document.getElementById('task-modal');
            if (modalElement) {
                modalElement.scrollTop = 0;
                const modalContent = modalElement.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }
                // Â∑¶ÂÅ¥„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç®„É™„Ç¢„ÇÇ„É™„Çª„ÉÉ„Éà
                const modalLeft = modalElement.querySelector('.modal-left');
                if (modalLeft) {
                    modalLeft.scrollTop = 0;
                }
            }

            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');

                // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´ÂÜçÂ∫¶„Éà„ÉÉ„Éó„Çπ„ÇØ„É≠„Éº„É´ÔºàÁ¢∫ÂÆü„Å´Ôºâ
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safari„Å´„ÇÇÂØæÂøú
                    document.documentElement.scrollTop = 0; // IE„Å´„ÇÇÂØæÂøú

                    // „É¢„Éº„ÉÄ„É´Ëá™‰Ωì„ÇÇ‰∏äÈÉ®„Å´ÈÖçÁΩÆ„ÇíÂº∑Âà∂
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                        const modalContent = modalElement.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.scrollTop = 0;
                        }
                        // Â∑¶ÂÅ¥„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç®„É™„Ç¢„ÇÇ„É™„Çª„ÉÉ„Éà
                        const modalLeft = modalElement.querySelector('.modal-left');
                        if (modalLeft) {
                            modalLeft.scrollTop = 0;
                        }
                    }
                }, 10);

                // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        function displayAttachedFiles(attachments) {
            const container = document.getElementById('attached-files-list');
            container.innerHTML = '';
            
            if (attachments.length === 0) return;
            
            const previewDiv = document.createElement('div');
            previewDiv.className = 'file-preview';
            
            attachments.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.onclick = () => previewFile(file, index);
                
                // „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Éó„É¨„Éì„É•„Éº
                if (file.type && file.type.startsWith('image/') && file.dataUrl) {
                    fileItem.innerHTML = `
                        <img src="${file.dataUrl}" class="file-preview-thumbnail" alt="${file.name}">
                        <div style="font-size: 0.6rem; margin-top: 0.2rem;">${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}</div>
                        <button type="button" onclick="event.stopPropagation(); removeAttachment(${index})" style="background: #e53e3e; color: white; border: none; padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.6rem; cursor: pointer; margin-top: 0.2rem;">ÂâäÈô§</button>
                    `;
                } else {
                    const fileIcon = getFileIcon(file.type);
                    fileItem.innerHTML = `
                        <div style="font-size: 1.5rem; margin-bottom: 0.2rem;">${fileIcon}</div>
                        <div style="font-size: 0.6rem; margin-bottom: 0.2rem;">${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}</div>
                        <button type="button" onclick="event.stopPropagation(); removeAttachment(${index})" style="background: #e53e3e; color: white; border: none; padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.6rem; cursor: pointer;">ÂâäÈô§</button>
                    `;
                }
                
                previewDiv.appendChild(fileItem);
            });
            
            container.appendChild(previewDiv);
        }
        
        function getFileIcon(fileType) {
            if (!fileType) return 'üìÑ';
            if (fileType.startsWith('image/')) return 'üñºÔ∏è';
            if (fileType.includes('pdf')) return 'üìï';
            if (fileType.includes('word') || fileType.includes('document')) return 'üìù';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìä';
            if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'üìà';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'üóúÔ∏è';
            return 'üìÑ';
        }
        
        function previewFile(file, index) {
            if (file.dataUrl && file.type.startsWith('image/')) {
                // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
                modal.onclick = () => document.body.removeChild(modal);
                
                const img = document.createElement('img');
                img.src = file.dataUrl;
                img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
                
                modal.appendChild(img);
                document.body.appendChild(modal);
            } else {
                alert(`„Éï„Ç°„Ç§„É´: ${file.name}\n„Çµ„Ç§„Ç∫: ${(file.size / 1024).toFixed(1)}KB\n„Çø„Ç§„Éó: ${file.type || '‰∏çÊòé'}`);
            }
        }
        
        function removeAttachment(index) {
            if (editingTask && editingTask.attachments) {
                editingTask.attachments.splice(index, 1);
                // ‚òÖ‚òÖ‚òÖ ÈáçË¶ÅÔºötasksÈÖçÂàóÂÜÖ„ÅÆ„Çø„Çπ„ÇØÂÖ®‰Ωì„ÇíÂêåÊúü ‚òÖ‚òÖ‚òÖ
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('üîç [ATTACHMENT SYNC] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('üîç [ATTACHMENT SYNC] Before sync - Task exists:', !!tasks[taskIndex]);
                    // editingTaskÂÖ®‰Ωì„ÇítasksÈÖçÂàó„Å´ÂêåÊúü
                    tasks[taskIndex] = { ...editingTask };
                    console.log('üîç [ATTACHMENT SYNC] After sync - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        attachmentsCount: tasks[taskIndex].attachments ? tasks[taskIndex].attachments.length : 0
                    });
                    saveTasks();
                } else {
                    console.error('‚ùå [ATTACHMENT SYNC] Task not found in tasks array! EditingTask ID:', editingTask.id);
                }
                displayAttachedFiles(editingTask.attachments);
                
                // ÁîªÈù¢„ÇíÂÜçÊèèÁîª„Åó„Å¶„Ç´„Éº„Éâ„ÅåÊ∂àÂ§±„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
                render();
            }
        }
        
        // „Ç≥„É°„É≥„ÉàÊ©üËÉΩ
        function displayComments(comments) {
            const container = document.getElementById('comments-section');
            if (!comments || comments.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">„Åæ„Å†„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            container.innerHTML = comments.map(comment => {
                const commentDate = new Date(comment.timestamp);
                const timeAgo = getTimeAgo(commentDate);
                const processedText = processMentions(comment.text);
                
                return `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-time">${timeAgo}</span>
                        </div>
                        <div class="comment-body">${processedText}</div>
                    </div>
                `;
            }).join('');
            
            // ÊúÄÊñ∞„Ç≥„É°„É≥„Éà„Å´„Çπ„ÇØ„É≠„Éº„É´
            container.scrollTop = container.scrollHeight;
        }
        
        function processMentions(text) {
            // @„É¶„Éº„Ç∂„ÉºÂêç„Çí„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫„Å´Â§âÊèõ
            return text.replace(/@(\w+[^\s]*)/g, '<span class="mention">@$1</span>');
        }
        
        // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ
        let mentionSuggestionIndex = -1;
        let mentionStartPos = -1;
        let mentionQuery = '';
        
        function setupMentionSystem() {
            // „É¢„Éº„ÉÄ„É´„ÅåÈñã„Åã„Çå„Åü„Å®„Åç„Å´ÂàùÊúüÂåñ„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            // editTask „Å® openTaskModal ÂÜÖ„ÅßÂëº„Å≥Âá∫„Åï„Çå„Çã
        }
        
        function initMentionListeners() {
            const commentInput = document.getElementById('comment-input');
            if (!commentInput) return;
            
            // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂâäÈô§„Åó„Å¶ÈáçË§á„ÇíÈò≤„Åê
            commentInput.removeEventListener('input', handleMentionInput);
            commentInput.removeEventListener('keydown', handleMentionKeydown);
            
            commentInput.addEventListener('input', handleMentionInput);
            commentInput.addEventListener('keydown', handleMentionKeydown);
            
            // „Éï„Ç©„Éº„Ç´„ÇπÂ§ñ„Çå„Åü„Å®„Åç„ÅØÂÄôË£ú„ÇíÈùûË°®Á§∫
            commentInput.addEventListener('blur', () => {
                setTimeout(() => hideMentionSuggestions(), 200);
            });
        }
        
        function handleMentionInput(e) {
            const input = e.target;
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            // @„Éû„Éº„ÇØ„ÅÆ‰ΩçÁΩÆ„ÇíÊé¢„Åô
            let atPos = -1;
            for (let i = cursorPos - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atPos = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }
            
            if (atPos !== -1) {
                mentionStartPos = atPos;
                mentionQuery = text.substring(atPos + 1, cursorPos);
                showMentionSuggestions(mentionQuery, input);
            } else {
                hideMentionSuggestions();
            }
        }
        
        function handleMentionKeydown(e) {
            const suggestions = document.getElementById('mention-suggestions');
            if (suggestions.style.display === 'none') return;
            
            const suggestionItems = suggestions.querySelectorAll('.mention-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                mentionSuggestionIndex = Math.min(mentionSuggestionIndex + 1, suggestionItems.length - 1);
                updateMentionSelection(suggestionItems);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                mentionSuggestionIndex = Math.max(mentionSuggestionIndex - 1, 0);
                updateMentionSelection(suggestionItems);
            } else if (e.key === 'Enter' && mentionSuggestionIndex >= 0) {
                e.preventDefault();
                const selectedItem = suggestionItems[mentionSuggestionIndex];
                if (selectedItem) {
                    insertMention(selectedItem.textContent);
                }
            } else if (e.key === 'Escape') {
                hideMentionSuggestions();
            }
        }
        
        function showMentionSuggestions(query, input) {
            const suggestions = document.getElementById('mention-suggestions');
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº„ÅÆ„Åø„ÇíÂèñÂæóÔºàÁÑ°ÂäπÂåñ„ÉªÈùûË°®Á§∫„É¶„Éº„Ç∂„Éº„ÇíÈô§Â§ñÔºâ
            const activeUsers = getActiveUsers();
            const availableUsers = activeUsers.map(user => user.name).filter(name => name);
            
            const filteredUsers = availableUsers.filter(user => 
                user.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredUsers.length === 0) {
                hideMentionSuggestions();
                return;
            }
            
            suggestions.innerHTML = filteredUsers.map((user, index) => 
                `<div class="mention-suggestion" onclick="insertMention('${user}')">${user}</div>`
            ).join('');
            
            // ‰ΩçÁΩÆ„ÇíË™øÊï¥
            const rect = input.getBoundingClientRect();
            suggestions.style.left = '10px';
            suggestions.style.bottom = '60px';
            suggestions.style.display = 'block';
            
            mentionSuggestionIndex = -1;
        }
        
        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === mentionSuggestionIndex);
            });
        }
        
        function insertMention(userName) {
            const input = document.getElementById('comment-input');
            const text = input.value;
            const beforeMention = text.substring(0, mentionStartPos);
            const afterMention = text.substring(input.selectionStart);
            
            const newText = `${beforeMention}@${userName} ${afterMention}`;
            input.value = newText;
            
            // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíË™øÊï¥
            const newCursorPos = mentionStartPos + userName.length + 2;
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            hideMentionSuggestions();
            input.focus();
        }
        
        function hideMentionSuggestions() {
            const suggestions = document.getElementById('mention-suggestions');
            suggestions.style.display = 'none';
            mentionSuggestionIndex = -1;
            mentionStartPos = -1;
            mentionQuery = '';
        }
        
        function addComment() {
            console.log('üìù [COMMENT] addComment function called');
            console.log('üìù [COMMENT] Function context:', typeof addComment, window.addComment === addComment);
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            
            console.log('üìù [COMMENT] Comment text:', commentText);
            console.log('üìù [COMMENT] editingTask:', editingTask);
            
            if (!commentText) {
                alert('„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „Çø„Çπ„ÇØ‰ΩúÊàêÊôÇ„ÅÆÂá¶ÁêÜ
            if (!editingTask) {
                console.log('üìù [COMMENT] „Çø„Çπ„ÇØ‰ΩúÊàêÊôÇ„ÅÆ„Ç≥„É°„É≥„Éà - ‰∏ÄÊôÇ‰øùÂ≠ò„Åó„Åæ„Åô');
                // „Çø„Çπ„ÇØ‰ΩúÊàêÊôÇ„ÅØ„Ç≥„É°„É≥„Éà„Çí‰∏ÄÊôÇ‰øùÂ≠ò
                window.pendingComment = commentText;
                commentInput.value = ''; // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
                alert('„Ç≥„É°„É≥„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ„Çø„Çπ„ÇØ‰ΩúÊàêÂæå„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ');
                return;
            }
            
            // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂèñÂæóÔºà„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„Åã„ÇâÂÑ™ÂÖàÂèñÂæóÔºâ
            let currentUser = '„É¶„Éº„Ç∂„Éº';
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user && session.user.name) {
                    currentUser = session.user.name;
                    console.log(`üìù [COMMENT] „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº: ${currentUser}`);
                } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Åã„ÇâÂèñÂæó
                    currentUser = document.getElementById('assignee-filter')?.value || '„É¶„Éº„Ç∂„Éº';
                    console.log(`üìù [COMMENT] „Éï„Ç£„É´„Çø„Åã„ÇâÂèñÂæó: ${currentUser}`);
                }
            } catch (error) {
                console.log(`‚ö†Ô∏è [COMMENT] „É¶„Éº„Ç∂„ÉºÂêçÂèñÂæó„Ç®„É©„Éº:`, error);
                currentUser = '„É¶„Éº„Ç∂„Éº';
            }
            
            const newComment = {
                id: Date.now(),
                author: currentUser || '„É¶„Éº„Ç∂„Éº',
                text: commentText,
                timestamp: new Date().toISOString()
            };
            
            // editingTask„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁ∑®ÈõÜ‰∏≠„ÅÆ„Çø„Çπ„ÇØ„Å´„ÄÅ„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰ΩúÊàê
            if (editingTask) {
                // Á∑®ÈõÜ‰∏≠„ÅÆ„Çø„Çπ„ÇØ„Å´„Ç≥„É°„É≥„ÉàËøΩÂä†
                if (!editingTask.comments) editingTask.comments = [];
                editingTask.comments.push(newComment);
                
                // ‚òÖ‚òÖ‚òÖ ÈáçË¶ÅÔºötasksÈÖçÂàóÂÜÖ„ÅÆ„Çø„Çπ„ÇØÂÖ®‰Ωì„ÇíÂêåÊúü ‚òÖ‚òÖ‚òÖ
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('üîç [COMMENT SYNC] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('üîç [COMMENT SYNC] Before sync - Task exists:', !!tasks[taskIndex]);
                    // editingTaskÂÖ®‰Ωì„ÇítasksÈÖçÂàó„Å´ÂêåÊúü
                    tasks[taskIndex] = { ...editingTask };
                    console.log('üîç [COMMENT SYNC] After sync - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        commentsCount: tasks[taskIndex].comments ? tasks[taskIndex].comments.length : 0
                    });
                } else {
                    console.error('‚ùå [COMMENT SYNC] Task not found in tasks array! EditingTask ID:', editingTask.id);
                }
                
                console.log('üìù [COMMENT] About to save tasks and render');
                
                // üîß „Ç≥„É°„É≥„ÉàËøΩÂä†„Å´„Çà„Çã‰øùÂ≠ò„Åß„ÅÇ„Çã„Åì„Å®„Çí„Éû„Éº„ÇØÔºàÈáçË§áÈÄöÁü•Èò≤Ê≠¢Ôºâ
                window.isCommentSaveOperation = true;
                saveTasks();
                // „Éï„É©„Ç∞„ÅØÁü≠ÊôÇÈñìÂæå„Å´„É™„Çª„ÉÉ„ÉàÔºàFirebase onSnapshot„ÅÆÂá¶ÁêÜÂæåÔºâ
                setTimeout(() => {
                    window.isCommentSaveOperation = false;
                }, 1000);
                
                displayComments(editingTask.comments);
                
                console.log('üìù [COMMENT] About to call render()');
                // ÁîªÈù¢„ÇíÂÜçÊèèÁîª„Åó„Å¶„Ç´„Éº„Éâ„ÅåÊ∂àÂ§±„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
                render();
                console.log('üìù [COMMENT] render() completed');
                
                // „É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•„Å®‰∏ÄËà¨„Ç≥„É°„É≥„ÉàÈÄöÁü•„ÇíÁµ±Âêà„Åó„Å¶ÂÆüË°å
                checkUnifiedCommentNotifications(commentText, currentUser, editingTask.id);
            }
            
            // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
            commentInput.value = '';
            
        }
        
        // addCommentÈñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÁôªÈå≤
        window.addComment = addComment;
        
        // Áµ±Âêà„Ç≥„É°„É≥„ÉàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†Ôºà„É°„É≥„Ç∑„Éß„É≥+„Ç≥„É°„É≥„ÉàÈÄöÁü•„ÅÆÈáçË§á„ÇíÊéíÈô§Ôºâ
        function checkUnifiedCommentNotifications(commentText, author, taskId) {
            console.log(`üîç [UNIFIED-NOTIFY] Áµ±ÂêàÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã: "${commentText}" by ${author}`);
            
            // „Çø„Çπ„ÇØ„ÇíÂèñÂæó
            const task = tasks.find(t => t.id === taskId);
            
            // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆÈÄöÁü•ÊäëÂà∂„ÉÅ„Çß„ÉÉ„ÇØ
            if (task && task.isHidden) {
                console.log(`üîí [UNIFIED-NOTIFY] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${task.title}`);
                return;
            }
            
            // üîß ÈáçË§áÈÄöÁü•Èò≤Ê≠¢: Âêå„Åò„Ç≥„É°„É≥„Éà„ÅßÁü≠ÊôÇÈñìÂÜÖ„Å´Ë§áÊï∞ÂõûÂëº„Å∞„Çå„Çã„Åì„Å®„ÇíÈò≤„Åê
            const notificationKey = `${taskId}-${commentText}-${author}`;
            const now = Date.now();
            
            if (!window.lastCommentNotifications) {
                window.lastCommentNotifications = new Map();
            }
            
            const lastNotification = window.lastCommentNotifications.get(notificationKey);
            if (lastNotification && (now - lastNotification < 2000)) { // 2Áßí‰ª•ÂÜÖ„ÅÆÈáçË§á„ÇíÈò≤„Åê
                console.log(`üîï [UNIFIED-NOTIFY] ÈáçË§áÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${notificationKey}`);
                return;
            }
            
            window.lastCommentNotifications.set(notificationKey, now);
            
            // Âè§„ÅÑ„Ç®„É≥„Éà„É™„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºà5Áßí„Çà„ÇäÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§Ôºâ
            for (const [key, timestamp] of window.lastCommentNotifications.entries()) {
                if (now - timestamp > 5000) {
                    window.lastCommentNotifications.delete(key);
                }
            }
            if (!task) {
                console.log(`‚ùå [UNIFIED-NOTIFY] „Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${taskId}`);
                return;
            }
            
            // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇíÂèñÂæó
            const assignees = task.assignees || [];
            const approvers = task.approvers || [];
            
            // ÁèæÂú®„ÅÆ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.isLoggedIn) {
                console.log('‚ö†Ô∏è [UNIFIED-NOTIFY] „É¶„Éº„Ç∂„ÉºÊú™„É≠„Ç∞„Ç§„É≥ - Áµ±ÂêàÈÄöÁü•„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            console.log(`üîç [UNIFIED-NOTIFY] ÁèæÂú®„ÅÆ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº: ${currentUser.name}`);
            console.log(`üîç [UNIFIED-NOTIFY] „Ç≥„É°„É≥„Éà‰ΩúÊàêËÄÖ: ${author}`);
            
            // üîß ‰ΩúÊàêËÄÖ„Ååundefined„ÅÆÂ†¥Âêà„ÅØÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„Çí‰ΩøÁî®
            if (!author || author === 'undefined') {
                author = currentUser.name;
                console.log(`üîß [UNIFIED-NOTIFY] ‰ΩúÊàêËÄÖ„ÇícurrentUser„Å´‰øÆÊ≠£: ${author}`);
            }
            
            // @„É°„É≥„Ç∑„Éß„É≥„ÇíÊ§úÂá∫
            const mentionPattern = /@([^\s@]+)/g;
            const mentions = commentText.match(mentionPattern);
            const mentionedUsers = mentions ? mentions.map(m => m.substring(1)) : [];
            
            console.log(`üîç [UNIFIED-NOTIFY] Ê§úÂá∫„Åï„Çå„Åü„É°„É≥„Ç∑„Éß„É≥:`, mentionedUsers);
            
            // ÈÄöÁü•ÂØæË±°ËÄÖ„ÇíÁµ±Âêà„Åó„Å¶Ê±∫ÂÆö
            const allNotifyTargets = new Set();
            
            // üîß ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÔºà„Ç≥„É°„É≥„Éà‰ΩúÊàêËÄÖÔºâ„ÅÆÊÉÖÂ†±„ÇíÂèñÂæóÔºàÊó¢„Å´‰∏ä„ÅßÂèñÂæóÊ∏à„ÅøÔºâ
            const currentUserIdentifiers = [
                currentUser?.name,
                currentUser?.email,
                currentUser?.id,
                author // „Ç≥„É°„É≥„Éà‰ΩúÊàêËÄÖ
            ].filter(Boolean);
            
            // üîß Ëá™ÂàÜ„Çí„É°„É≥„Ç∑„Éß„É≥„Åó„ÅüÂ†¥Âêà„ÅØÈÄöÁü•ÂØæË±°„Å´Âê´„ÇÅ„Çã
            const selfMentioned = mentionedUsers.some(mentionedUser => 
                currentUserIdentifiers.includes(mentionedUser)
            );
            
            console.log(`üîç [COMMENT-FILTER] Èô§Â§ñÂØæË±°: ${currentUserIdentifiers.join(', ')}`);
            console.log(`üîç [COMMENT-FILTER] Ëá™ÂàÜ„É°„É≥„Ç∑„Éß„É≥: ${selfMentioned}`);
            
            // üîß „É°„É≥„Ç∑„Éß„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„É°„É≥„Ç∑„Éß„É≥ÂØæË±°ËÄÖ„ÅÆ„Åø„Å´ÈÄöÁü•ÔºàËá™ÂàÜ„ÅØÈô§Â§ñÔºâ
            if (mentionedUsers.length > 0) {
                console.log(`üìß [COMMENT-FILTER] „É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•„É¢„Éº„Éâ: ${mentionedUsers.join(', ')}`);
                mentionedUsers.forEach(mentionedUser => {
                    const isCurrentUser = currentUserIdentifiers.includes(mentionedUser);
                    const shouldInclude = !isCurrentUser; // Ëá™ÂàÜ„ÅØÂ∏∏„Å´Èô§Â§ñ
                    console.log(`üîç [COMMENT-FILTER] „É°„É≥„Ç∑„Éß„É≥ ${mentionedUser}: ÁèæÂú®„É¶„Éº„Ç∂„Éº=${isCurrentUser}, Âê´„ÇÅ„Çã=${shouldInclude}`);
                    if (shouldInclude) {
                        allNotifyTargets.add(mentionedUser);
                    }
                });
            } else {
                // „É°„É≥„Ç∑„Éß„É≥„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊãÖÂΩìËÄÖ„ÉªÊâøË™çËÄÖ„Å´ÈÄöÁü•ÔºàËá™ÂàÜ„ÅØÈô§Â§ñÔºâ
                console.log(`üìß [COMMENT-FILTER] ÈÄöÂ∏∏„Ç≥„É°„É≥„ÉàÈÄöÁü•„É¢„Éº„Éâ`);
                assignees.forEach(assignee => {
                    const isNotCurrentUser = !currentUserIdentifiers.includes(assignee);
                    console.log(`üîç [COMMENT-FILTER] ÊãÖÂΩìËÄÖ ${assignee}: ÁèæÂú®„É¶„Éº„Ç∂„Éº„Åß„Å™„ÅÑ=${isNotCurrentUser}, Âê´„ÇÅ„Çã=${isNotCurrentUser}`);
                    if (isNotCurrentUser) {
                        allNotifyTargets.add(assignee);
                    }
                });
                
                approvers.forEach(approver => {
                    const isNotCurrentUser = !currentUserIdentifiers.includes(approver);
                    console.log(`üîç [COMMENT-FILTER] ÊâøË™çËÄÖ ${approver}: ÁèæÂú®„É¶„Éº„Ç∂„Éº„Åß„Å™„ÅÑ=${isNotCurrentUser}, Âê´„ÇÅ„Çã=${isNotCurrentUser}`);
                    if (isNotCurrentUser) {
                        allNotifyTargets.add(approver);
                    }
                });
            }
            
            const targetUsers = Array.from(allNotifyTargets);
            console.log(`üîç [UNIFIED-NOTIFY] Áµ±ÂêàÈÄöÁü•ÂØæË±°ËÄÖ:`, targetUsers);
            
            if (targetUsers.length === 0) {
                // üîß „É°„É≥„Ç∑„Éß„É≥„ÅåÂ≠òÂú®„Åô„Çã„ÅåÂÖ®„Å¶Ëá™ÂàÜ„ÅÆÂ†¥Âêà„ÅØÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Å™„ÅÑ
                if (mentionedUsers.length > 0 && selfMentioned) {
                    console.log('üîï [UNIFIED-NOTIFY] Ëá™ÂàÜ„ÅÆ„Åø„Çí„É°„É≥„Ç∑„Éß„É≥ - ÈÄöÁü•ÈÄÅ‰ø°„Çí„Çπ„Ç≠„ÉÉ„Éó');
                    return;
                }
                
                // „É°„É≥„Ç∑„Éß„É≥„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÂÖ®‰ΩìÈÄöÁü•„ÇíÂÆüË°å
                console.log('üîî [UNIFIED-NOTIFY] ÈÄöÁü•ÂØæË±°ËÄÖ„Å™„Åó - ÂÖ®‰ΩìÈÄöÁü•„ÇíÂÆüË°å');
                
                const generalMessage = `üí¨ ${author}„Åï„Çì„Åå„Äå${task.title}„Äç„Å´„Ç≥„É°„É≥„Éà„Åó„Åæ„Åó„Åü\n\n„Äå${commentText}„Äç\n\nÊãÖÂΩìËÄÖ: ${assignees.join(', ') || 'Êú™Ë®≠ÂÆö'}\nÊúüÈôê: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'Êú™Ë®≠ÂÆö'}`;
                
                showNotification('üí¨ „Ç≥„É°„É≥„ÉàËøΩÂä†', generalMessage, {
                    taskId: taskId,
                    targetUser: 'all',
                    type: 'comment'
                });
                return;
            }
            
            // „É°„É≥„Ç∑„Éß„É≥Êúâ„Çä„ÅÆÂ†¥Âêà„Å®„É°„É≥„Ç∑„Éß„É≥ÁÑ°„Åó„ÅÆÂ†¥Âêà„ÅßÈÄöÁü•ÂÜÖÂÆπ„ÇíË™øÊï¥
            const hasMentions = mentionedUsers.length > 0;
            const notificationTitle = hasMentions ? 'üí¨ „É°„É≥„Ç∑„Éß„É≥„Éª„Ç≥„É°„É≥„ÉàÈÄöÁü•' : 'üí¨ „Ç≥„É°„É≥„ÉàÈÄöÁü•';
            
            // üîß ÁêÜÊÉ≥ÁöÑ„Å™„Ç≥„É°„É≥„ÉàÈÄöÁü•ÂΩ¢Âºè„ÇíÂÆüË£Ö
            function extractMentionMessages(text) {
                // @„É¶„Éº„Ç∂„ÉºÂêç„Å®„Åù„ÅÆÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊäΩÂá∫
                const mentionPairs = [];
                const mentionPattern = /@([^\s@]+)/g;
                let lastIndex = 0;
                let match;
                
                const matches = [];
                while ((match = mentionPattern.exec(text)) !== null) {
                    matches.push({
                        user: match[1],
                        index: match.index,
                        fullMatch: match[0]
                    });
                }
                
                for (let i = 0; i < matches.length; i++) {
                    const currentMatch = matches[i];
                    const nextMatch = matches[i + 1];
                    
                    // „É°„É≥„Ç∑„Éß„É≥Âæå„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫ÔºàÊ¨°„ÅÆ„É°„É≥„Ç∑„Éß„É≥„Åæ„Åß„ÄÅ„Åæ„Åü„ÅØÊú´Â∞æ„Åæ„ÅßÔºâ
                    const startPos = currentMatch.index + currentMatch.fullMatch.length;
                    const endPos = nextMatch ? nextMatch.index : text.length;
                    const message = text.substring(startPos, endPos).trim();
                    
                    if (message) {
                        mentionPairs.push({
                            user: currentMatch.user,
                            message: message
                        });
                    }
                }
                
                return mentionPairs;
            }
            
            let notificationMessage;
            
            if (hasMentions) {
                // „É°„É≥„Ç∑„Éß„É≥Ëß£Êûê
                const mentionPairs = extractMentionMessages(commentText);
                
                // ÊãÖÂΩìËÄÖÂÖ®Âì°„Å∏„ÅÆÊ¶ÇË¶ÅÈÄöÁü•
                const assigneeMentions = assignees.map(name => {
                    const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(name) : `@${name}`;
                    return slackUsername;
                }).join(' ');
                
                notificationMessage = `${assigneeMentions}\n`;
                notificationMessage += `„Çø„Çπ„ÇØ„Äå${task.title}„Äç„Å´${author}„Åï„Çì„Åã„Çâ„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åó„Åü\n\n`;
                
                // ÂÄãÂà•„É°„É≥„Ç∑„Éß„É≥ÈÉ®ÂàÜ„ÇíËøΩÂä†
                mentionPairs.forEach(pair => {
                    const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(pair.user) : `@${pair.user}`;
                    notificationMessage += `${slackUsername}\n${pair.message}\n\n`;
                });
                
                // ‰ΩôÂàÜ„Å™ÊîπË°å„ÇíÂâäÈô§
                notificationMessage = notificationMessage.trim();
                
            } else {
                // ÈÄöÂ∏∏„ÅÆ„Ç≥„É°„É≥„ÉàÔºà„É°„É≥„Ç∑„Éß„É≥„Å™„ÅóÔºâ
                const assigneeMentions = assignees.map(name => {
                    const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(name) : `@${name}`;
                    return slackUsername;
                }).join(' ');
                
                notificationMessage = `${assigneeMentions}\n`;
                notificationMessage += `„Çø„Çπ„ÇØ„Äå${task.title}„Äç„Å´${author}„Åï„Çì„Åã„Çâ„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åó„Åü\n\n`;
                notificationMessage += `${commentText}`;
            }
            
            // üîß „Ç∑„É≥„Éó„É´„Å™Áµ±ÂêàÈÄöÁü•Ôºà‰ΩôË®à„Å™ÊÉÖÂ†±„ÅØÂâäÈô§Ôºâ
            showNotification(notificationTitle, notificationMessage, {
                taskId: taskId,
                targetUser: 'all', // „Ç∑„É≥„Éó„É´„Å´ÂÖ®‰ΩìÈÄöÁü•„Å®„Åó„Å¶ÈÄÅ‰ø°
                type: 'structured_comment',
                hasMentions: hasMentions
            });
            
            console.log(`‚úÖ [UNIFIED-NOTIFY] Áµ±ÂêàÈÄöÁü•ÈÄÅ‰ø°ÂÆå‰∫Ü: ${targetUsers.length}‰∫∫„Å´1„Å§„ÅÆÈÄöÁü•`);
        }
        
        function checkMentionNotifications(text, author, taskId) {
            // ‚ö†Ô∏è [ÂªÉÊ≠¢] „Åì„ÅÆÈñ¢Êï∞„ÅØÁµ±ÂêàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É† (checkUnifiedCommentNotifications) „Å´ÁΩÆ„ÅçÊèõ„Åà„Çâ„Çå„Åæ„Åó„Åü
            // ÈáçË§áÈÄöÁü•„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅ„Åì„ÅÆÈñ¢Êï∞„ÅØÂÆåÂÖ®ÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô
            console.log(`‚ö†Ô∏è [DEPRECATED] checkMentionNotifications „ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Åæ„Åó„Åü - ÈáçË§áÈÄöÁü•Èò≤Ê≠¢`);
            console.log(`üö´ [BLOCKED] Áµ±ÂêàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„ÅåÊó¢„Å´ÂÆüË°åÊ∏à„Åø„ÅÆ„Åü„ÇÅ„ÄÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô`);
            
            // ‰Ωï„ÇÇ„Åó„Å™„ÅÑ - ÈáçË§áÈÄöÁü•„ÇíÂÆåÂÖ®„Å´Èò≤„Åê
            return;
        }
        
        // ‰∏ÄËà¨„Ç≥„É°„É≥„ÉàÈÄöÁü•Èñ¢Êï∞ÔºàÁµ±ÂêàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å´ÁΩÆ„ÅçÊèõ„ÅàÊ∏à„ÅøÔºâ
        // ‰∏ÄËà¨„Ç≥„É°„É≥„ÉàÈÄöÁü•Èñ¢Êï∞Ôºà„É°„É≥„Ç∑„Éß„É≥‰ª•Â§ñÔºâ
        function sendGeneralCommentNotification(commentText, commentAuthor, taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            console.log('üîî [COMMENT-NOTIFY] ‰∏ÄËà¨„Ç≥„É°„É≥„ÉàÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã');
            
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.name) return;
            
            // ÊãÖÂΩìËÄÖ„Å®ÊâøË™çËÄÖ„ÅÆÈÄöÁü•ÂØæË±°„ÇíÊ±∫ÂÆöÔºà‰ΩúÊàêËÄÖ„ÇÇÊãÖÂΩìËÄÖ„Å™„ÇâÂê´„ÇÅ„ÇãÔºâ
            const notifyTargets = new Set();
            
            // „Çø„Çπ„ÇØ„ÅÆÊãÖÂΩìËÄÖ
            if (task.assignees && Array.isArray(task.assignees)) {
                task.assignees.forEach(assignee => {
                    if (assignee !== commentAuthor) {
                        notifyTargets.add(assignee);
                    }
                });
            }
            
            
            const targetUsers = Array.from(notifyTargets);
            
            // ÈÄöÁü•ÂØæË±°ËÄÖ„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇ„ÄÅ„Ç≥„É°„É≥„Éà„Åï„Çå„Åü„Åì„Å®„ÇíÂÖ®‰Ωì„Å´ÈÄöÁü•
            if (targetUsers.length === 0) {
                console.log('üîî [COMMENT-NOTIFY] ÈÄöÁü•ÂØæË±°ËÄÖ„Å™„Åó - ÂÖ®‰ΩìÈÄöÁü•„ÇíÂÆüË°å');
                
                const generalMessage = `üí≠ ${commentAuthor}„Åï„Çì„Åå„Äå${task.title}„Äç„Å´„Ç≥„É°„É≥„Éà„Åó„Åæ„Åó„Åü\n\n„Äå${commentText}„Äç\n\nÊãÖÂΩìËÄÖ: ${task.assignees?.join(', ') || 'Êú™Ë®≠ÂÆö'}\nÊúüÈôê: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'Êú™Ë®≠ÂÆö'}`;
                
                showNotification('üí≠ „Ç≥„É°„É≥„ÉàËøΩÂä†', generalMessage, {
                    taskId: taskId,
                    targetUser: 'all', // ÂÖ®‰ΩìÈÄöÁü•„ÇíÁ§∫„ÅôÁâπÂà•„Å™ÂÄ§
                    type: 'comment'
                });
                return;
            }
            
            console.log('üîî [COMMENT-NOTIFY] ÈÄöÁü•ÂØæË±°:', targetUsers);
            
            // ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Çà„ÇäË©≥Á¥∞„Å´
            const detailedMessage = `üí≠ ${commentAuthor}„Åï„Çì„Åå„Äå${task.title}„Äç„Å´„Ç≥„É°„É≥„Éà„Åó„Åæ„Åó„Åü\n\n„Äå${commentText}„Äç\n\nÊãÖÂΩìËÄÖ: ${task.assignees?.join(', ') || 'Êú™Ë®≠ÂÆö'}\nÊúüÈôê: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'Êú™Ë®≠ÂÆö'}`;
            
            targetUsers.forEach(targetUser => {
                showNotification('üí≠ „Ç≥„É°„É≥„ÉàÈÄöÁü•', detailedMessage, {
                    taskId: taskId,
                    targetUser: targetUser,
                    type: 'comment'
                });
            });
        }
        
        function checkCollaborativeTaskNotifications(task, assignedUsers) {
            // ÁèæÂú®„ÅÆ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
            const currentUser = getCurrentUser();
            console.log('üîç [ASSIGN-NOTIFY-DEBUG] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±:', currentUser);
            console.log('üîç [ASSIGN-NOTIFY-DEBUG] FirebaseË™çË®ºÁä∂ÊÖã:', window.currentFirebaseUser ? '„É≠„Ç∞„Ç§„É≥Ê∏à„Åø' : 'Êú™„É≠„Ç∞„Ç§„É≥');
            console.log('üîç [ASSIGN-NOTIFY-DEBUG] „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±:', JSON.parse(localStorage.getItem('currentSession') || 'null'));
            
            if (!currentUser || !currentUser.isLoggedIn) {
                console.warn('‚ö†Ô∏è [ASSIGN-NOTIFY] „É¶„Éº„Ç∂„ÉºÊú™„É≠„Ç∞„Ç§„É≥ - Ââ≤„ÇäÂΩì„Å¶ÈÄöÁü•„Çπ„Ç≠„ÉÉ„Éó');
                console.warn('‚ö†Ô∏è [ASSIGN-NOTIFY] „Éá„Éê„ÉÉ„Ç∞:', {
                    hasCurrentUser: !!currentUser,
                    isLoggedIn: currentUser ? currentUser.isLoggedIn : 'N/A',
                    hasFirebaseUser: !!window.currentFirebaseUser
                });
                return;
            }
            
            console.log(`üîç [ASSIGN-NOTIFY] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº: ${currentUser.name}`);
            console.log(`üîç [ASSIGN-NOTIFY] Ââ≤„ÇäÂΩì„Å¶ÂØæË±°„É¶„Éº„Ç∂„Éº:`, assignedUsers);
            
            // Ë§áÊï∞„ÅÆÊãÖÂΩìËÄÖ„ÅåÂâ≤„ÇäÂΩì„Å¶„Çâ„Çå„ÅüÂ†¥Âêà„ÄÅÁµ±ÂêàÈÄöÁü•„ÇíÈÄÅ‰ø°
            if (assignedUsers && assignedUsers.length > 0) {
                // üîß ÂÖ®„Å¶„ÅÆÊãÖÂΩìËÄÖ„Å´ÈÄöÁü•ÔºàËá™ÂàÜ„ÇÇÂê´„ÇÅ„Çã - SlackÈÄöÁü•„ÅÆ„Åü„ÇÅÔºâ
                const notifyUsers = assignedUsers.filter(user => {
                    const isValidUser = user && user.trim() !== '';
                    console.log(`üîç [ASSIGN-NOTIFY] ${user}: ÊúâÂäπ„Å™„É¶„Éº„Ç∂„Éº = ${isValidUser} (Ëá™ÂàÜ„ÇÇÈÄöÁü•ÂØæË±°„Å´Âê´„ÇÅ„Çã)`);
                    return isValidUser;
                });
                
                if (notifyUsers.length === 0) {
                    console.log(`‚ùå [ASSIGN-NOTIFY] ÈÄöÁü•ÂØæË±°ËÄÖ„Å™„Åó`);
                    return;
                }
                
                console.log(`üîç [ASSIGN-NOTIFY] Áµ±ÂêàÈÄöÁü•ÂØæË±°ËÄÖ:`, notifyUsers);
                
                if (notifyUsers.length === 1) {
                    // 1‰∫∫„ÅÆÂ†¥Âêà„ÅØÂÄãÂà•ÈÄöÁü•
                    showNotification(
                        'üë• „Çø„Çπ„ÇØÂâ≤„ÇäÂΩì„Å¶ÈÄöÁü•',
                        `${currentUser.name}„Åï„Çì„Åå„ÅÇ„Å™„Åü„Çí„Äå${task.title}„Äç„ÅÆÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü\n\n„Çø„Çπ„ÇØË©≥Á¥∞:\n„Çø„Ç§„Éà„É´: ${task.title}\nÊúüÈôê: ${task.deadline || 'Êú™Ë®≠ÂÆö'}\n‰ΩúÊàêËÄÖ: ${currentUser.name}`,
                        { 
                            taskId: task.id,
                            targetUser: notifyUsers[0],
                            type: 'task_assignment'
                        }
                    );
                    console.log(`‚úÖ [ASSIGN-NOTIFY] ÂÄãÂà•ÈÄöÁü•ÈÄÅ‰ø°: ${currentUser.name} ‚Üí ${notifyUsers[0]}`);
                } else {
                    // Ë§áÊï∞‰∫∫„ÅÆÂ†¥Âêà„ÅØÁµ±ÂêàÈÄöÁü•ÔºàÊ≠£„Åó„ÅÑSlack„É°„É≥„Ç∑„Éß„É≥‰ΩøÁî®Ôºâ
                    const mentionText = notifyUsers.map(user => {
                        const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(user) : `@${user}`;
                        return slackUsername;
                    }).join(' ');
                    const integratedMessage = `„Åï„Çì„ÄÅÊñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÅÆÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åï„Çå„Åæ„Åó„Åü\n\n„Çø„Çπ„ÇØË©≥Á¥∞:\n„Çø„Ç§„Éà„É´: ${task.title}\nÊúüÈôê: ${task.deadline || 'Êú™Ë®≠ÂÆö'}\n‰ΩúÊàêËÄÖ: ${currentUser.name}\n\nÂÖ®ÊãÖÂΩìËÄÖ: ${assignedUsers.join(', ')}`;
                    
                    showNotification(
                        'üë• Ë§áÊï∞ÊãÖÂΩìËÄÖÂâ≤„ÇäÂΩì„Å¶ÈÄöÁü•',
                        integratedMessage,
                        { 
                            taskId: task.id,
                            targetUser: 'multiple',
                            mentionUsers: notifyUsers,
                            type: 'task_assignment_multiple'
                        }
                    );
                    console.log(`‚úÖ [ASSIGN-NOTIFY] Áµ±ÂêàÈÄöÁü•ÈÄÅ‰ø°: ${notifyUsers.length}‰∫∫„Å´1„Å§„ÅÆÈÄöÁü•`);
                }
            }
        }
        
        // „Çø„Çπ„ÇØ‰ΩúÊàêÈÄöÁü•Èñ¢Êï∞
        function sendTaskCreationNotification(task, assignees) {
            console.log('üîî [TASK-CREATE] „Çø„Çπ„ÇØ‰ΩúÊàêÈÄöÁü•ÈñãÂßã:', task.title);
            
            // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆÈÄöÁü•ÊäëÂà∂„ÉÅ„Çß„ÉÉ„ÇØ
            if (task.isHidden) {
                console.log(`üîí [TASK-CREATE] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${task.title}`);
                return;
            }
            
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.name) {
                console.log('‚ùå [TASK-CREATE] „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÂèñÂæóÂ§±Êïó');
                return;
            }
            
            // üîß ÈáçË§áÊéíÈô§ÔºöÊãÖÂΩìËÄÖÈÖçÂàó„ÅÆÈáçË§á„ÇíÊéíÈô§ÔºàËá™ÂàÜ„ÇÇÂê´„ÇÅ„Çã - SlackÈÄöÁü•„ÅÆ„Åü„ÇÅÔºâ
            const uniqueTargetUsers = Array.from(new Set(
                assignees.filter(assignee => {
                    const isValidAssignee = assignee && assignee.trim() !== '';
                    console.log(`üîç [CREATE-FILTER] ${assignee}: ÊúâÂäπ=${isValidAssignee} (Ëá™ÂàÜ„ÇÇÈÄöÁü•ÂØæË±°„Å´Âê´„ÇÅ„Çã)`);
                    return isValidAssignee;
                })
            ));
            
            console.log('üîî [TASK-CREATE] ÂÖÉ„ÅÆÊãÖÂΩìËÄÖ:', assignees);
            console.log('üîî [TASK-CREATE] ÈÄöÁü•ÂØæË±°ÔºàËá™ÂàÜÂê´„ÇÄÔºâ:', uniqueTargetUsers);
            console.log(`üîî [TASK-CREATE] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº: ${currentUser.name} (Ëá™ÂàÜ„Å∏„ÅÆÈÄöÁü•„ÇÇÈÄÅ‰ø°)`);
            
            if (uniqueTargetUsers.length === 0) {
                console.log('üîî [TASK-CREATE] ÈÄöÁü•ÂØæË±°ËÄÖ„Å™„Åó');
                return;
            }
            
            // „É°„ÉÉ„Çª„Éº„Ç∏‰ΩúÊàêÔºàÈáçË§á„É°„É≥„Ç∑„Éß„É≥ÊéíÈô§Ê∏à„ÅøÔºâ
            const message = `Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü: „Äå${task.title}„Äç\n\n‰ΩúÊàêËÄÖ: ${currentUser.name}\nÊãÖÂΩìËÄÖ: ${assignees.join(', ')}\nÊúüÈôê: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'Êú™Ë®≠ÂÆö'}`;
            
            // Áµ±ÂêàÈÄöÁü•„Å®„Åó„Å¶1Âõû„Å†„ÅëÈÄÅ‰ø°ÔºàshowNotificationÂÜÖ„Åß„É°„É≥„Ç∑„Éß„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÁîüÊàêÔºâ
            showNotification('üìù „Çø„Çπ„ÇØ‰ΩúÊàêÈÄöÁü•', message, {
                taskId: task.id,
                targetUser: 'multiple',
                mentionUsers: uniqueTargetUsers
            });
            
            console.log(`‚úÖ [TASK-CREATE] Áµ±ÂêàÈÄöÁü•ÈÄÅ‰ø°ÂÆå‰∫Ü: ${uniqueTargetUsers.length}‰∫∫„Å´1„Å§„ÅÆÈÄöÁü•`);
        }
        
        // „Éï„Ç°„Ç§„É´Ê∑ª‰ªòÈÄöÁü•Èñ¢Êï∞
        async function sendFileAttachmentNotification(task, attachments) {
            console.log('üìé [FILE-ATTACH] „Éï„Ç°„Ç§„É´Ê∑ª‰ªòÈÄöÁü•ÈñãÂßã:', task.title);
            
            // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆÈÄöÁü•ÊäëÂà∂„ÉÅ„Çß„ÉÉ„ÇØ
            if (task.isHidden) {
                console.log(`üîí [FILE-ATTACH] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${task.title}`);
                return;
            }
            
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.name) {
                console.log('‚ùå [FILE-ATTACH] „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÂèñÂæóÂ§±Êïó');
                return;
            }
            
            const fileNames = attachments.map(file => file.name).join(', ');
            const fileCount = attachments.length;
            
            // ÈÄöÁü•ÂØæË±°ËÄÖ„ÇíÁµ±Âêà„Åó„Å¶Ê±∫ÂÆöÔºàÈáçË§áÊéíÈô§Ôºâ
            const allNotifyTargets = new Set();
            
            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅØ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº„ÇíËøΩÂä†
            if (task.projectId && task.projectName) {
                // üî• Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
                let project = null;
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        project = result.projects.find(p => p.id === task.projectId);
                    }
                }

                if (project && project.members) {
                    project.members.forEach(member => {
                        // üîß ÁèæÂú®„É¶„Éº„Ç∂„Éº„ÅÆÈô§Â§ñ„ÇíÂº∑ÂåñÔºàÂêçÂâç„Éª„É°„Éº„É´„ÉªID„ÅÆÂÖ®„Å¶„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                        const isNotCurrentUser = (
                            member !== currentUser.name &&
                            member !== currentUser.email &&
                            member !== currentUser.id
                        );
                        if (isNotCurrentUser) {
                            allNotifyTargets.add(member);
                        }
                        console.log(`üîç [FILE-FILTER] ${member}: ÁèæÂú®„É¶„Éº„Ç∂„Éº„Åß„Å™„ÅÑ=${isNotCurrentUser}`);
                    });
                }
            }
            
            // ÊãÖÂΩìËÄÖ„ÇÇËøΩÂä†Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº„Å®ÈáçË§á„Åô„ÇãÂ†¥Âêà„ÅØËá™ÂãïÁöÑ„Å´ÊéíÈô§„Åï„Çå„ÇãÔºâ
            if (task.assignees && task.assignees.length > 0) {
                task.assignees.forEach(assignee => {
                    // üîß ÁèæÂú®„É¶„Éº„Ç∂„Éº„ÅÆÈô§Â§ñ„ÇíÂº∑ÂåñÔºàÂêçÂâç„Éª„É°„Éº„É´„ÉªID„ÅÆÂÖ®„Å¶„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                    const isNotCurrentUser = (
                        assignee !== currentUser.name &&
                        assignee !== currentUser.email &&
                        assignee !== currentUser.id
                    );
                    if (isNotCurrentUser) {
                        allNotifyTargets.add(assignee);
                    }
                    console.log(`üîç [FILE-FILTER] ${assignee}: ÁèæÂú®„É¶„Éº„Ç∂„Éº„Åß„Å™„ÅÑ=${isNotCurrentUser}`);
                });
            }
            
            const targetUsers = Array.from(allNotifyTargets);
            console.log('üìé [FILE-ATTACH] ÈáçË§áÊéíÈô§Âæå„ÅÆÈÄöÁü•ÂØæË±°ËÄÖ:', targetUsers);
            
            if (targetUsers.length > 0) {
                // üîß showNotificationÂÜÖ„Åß„É°„É≥„Ç∑„Éß„É≥Âá¶ÁêÜ„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØmessage„ÅÆ„Åø‰ΩúÊàê
                let message = `„Äå${task.title}„Äç„Å´${fileCount}ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„ÅåÊ∑ª‰ªò„Åï„Çå„Åæ„Åó„Åü\n\nÊ∑ª‰ªòËÄÖ: ${currentUser.name}\n„Éï„Ç°„Ç§„É´: ${fileNames}`;
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞ËøΩÂä†
                if (task.projectId && task.projectName) {
                    message += `\n„Éó„É≠„Ç∏„Çß„ÇØ„Éà: ${task.projectName}`;
                }
                
                message += `\nÊúüÈôê: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'Êú™Ë®≠ÂÆö'}`;
                
                // Áµ±ÂêàÈÄöÁü•„Å®„Åó„Å¶1Âõû„Å†„ÅëÈÄÅ‰ø°
                showNotification('üìé „Éï„Ç°„Ç§„É´Ê∑ª‰ªòÈÄöÁü•', message, {
                    taskId: task.id,
                    targetUser: 'multiple',
                    projectId: task.projectId,
                    mentionUsers: targetUsers
                });
                
                console.log(`üìé [FILE-ATTACH] Áµ±ÂêàÈÄöÁü•ÈÄÅ‰ø°ÂÆå‰∫Ü: ${targetUsers.length}‰∫∫„Å´1„Å§„ÅÆÈÄöÁü•ÔºàÈáçË§áÊéíÈô§Ê∏à„ÅøÔºâ`);
            }
            
            // ÂÖ®‰ΩìÈÄöÁü•„ÅØÂªÉÊ≠¢ - Èñ¢‰øÇËÄÖ„ÅÆ„Åø„ÅÆÁµ±ÂêàÈÄöÁü•„ÅßÂçÅÂàÜ
            
            console.log('üìé [FILE-ATTACH] „Éï„Ç°„Ç§„É´Ê∑ª‰ªòÈÄöÁü•ÂÆå‰∫Ü');
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return '„Åü„Å£„Åü‰ªä';
            if (diffMins < 60) return `${diffMins}ÂàÜÂâç`;
            if (diffHours < 24) return `${diffHours}ÊôÇÈñìÂâç`;
            if (diffDays < 7) return `${diffDays}Êó•Ââç`;
            
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        async function saveTask(event) {
            try {
                console.log('üöÄ [SAVE TASK] Starting saveTask function...');
                event.preventDefault();

                // ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢: ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
                const saveButton = document.getElementById('save-task-button');
                if (saveButton) {
                    saveButton.disabled = true;
                    console.log('üîí [SAVE] ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñÔºà‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢Ôºâ');
                }
            
            // Á∑®ÈõÜ„É¢„Éº„ÉâÊôÇ„ÅØ task-column-input „ÅÆ required Â±ûÊÄß„Çí‰∏ÄÊôÇÁöÑ„Å´ÂâäÈô§
            const columnInput = document.getElementById('task-column-input');
            const columnSelectionGroup = document.getElementById('column-selection-group');
            const wasRequired = columnInput.hasAttribute('required');
            const isColumnSelectionHidden = columnSelectionGroup.style.display === 'none';
            
            if (isColumnSelectionHidden && wasRequired) {
                columnInput.removeAttribute('required');
                console.log(`üîß [FORM] Temporarily removed required attribute from task-column-input`);
            }
            
            const title = document.getElementById('task-title-input').value.trim();
            const date = document.getElementById('task-date-input').value;
            const time = document.getElementById('task-time-input').value;
            
            console.log('üîç [DEADLINE DEBUG] Form values:');
            console.log('üîç [DEADLINE DEBUG] Date input value:', date);
            console.log('üîç [DEADLINE DEBUG] Time input value:', time);
            console.log('üîç [DEADLINE DEBUG] Original deadline:', editingTask ? editingTask.deadline : 'new task');
            // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§
            const selectedAssignees = getSelectedAssignees();
            const memo = document.getElementById('task-memo-input').value.trim();
            const fileInput = document.getElementById('task-files-input');
            
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÊÉÖÂ†±„ÇíÂèñÂæó
            const selectedProjectId = document.getElementById('task-project-select').value;
            const isProjectTask = selectedProjectId !== '';
            let projectId = '';
            let projectName = '';

            if (isProjectTask) {
                // üî• Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
                let selectedProject = null;
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        selectedProject = result.projects.find(p => p.id === selectedProjectId);
                    }
                }

                if (selectedProject) {
                    projectId = selectedProject.id;
                    projectName = selectedProject.name;
                    console.log(`üìÇ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„Å®„Åó„Å¶‰ΩúÊàê: ${projectName} (${projectId})`);
                } else {
                    console.error('ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', selectedProjectId);
                    alert('ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
            }
            
            if (!title || !date) {
                alert('„Çø„Çπ„ÇØÂêç„Å®ÊúüÈôêÊó•„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }
            
            // Phase 2: PJ„Çø„Çπ„ÇØ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (isProjectTask) {
                console.log(`üîç [PJ VALIDATION] ProjectID: "${projectId}", ProjectName: "${projectName}"`);
                
                if (!projectId || !projectName) {
                    alert('PJ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàID„Å®„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÅØÂøÖÈ†à„Åß„Åô');
                    // requiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª„Åï„Åõ„Å¶„Åã„Çâreturn
                    if (wasRequired && isColumnSelectionHidden) {
                        columnInput.setAttribute('required', '');
                    }
                    return;
                }
                console.log(`üéØ [PJ TASK] Creating project task: ${projectId} - ${projectName}`);
            }
            
            if (selectedAssignees.length === 0) {
                if (!confirm('ÊãÖÂΩìËÄÖ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                    return;
                }
            }

            // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            const isHidden = document.getElementById('task-hidden-input').checked;
            const currentUserDisplayName = getCurrentUserDisplayName(); // Êó•Êú¨Ë™ûÂêç„ÇíÂèñÂæó

            if (isHidden) {
                console.log(`üîí [HIDDEN-VALIDATION] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠òÊôÇ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥`);
                console.log(`üîç [HIDDEN-VALIDATION] ÊãÖÂΩìËÄÖÊï∞: ${selectedAssignees.length}, ÊãÖÂΩìËÄÖ: ${selectedAssignees.join(', ')}`);
                console.log(`üîç [HIDDEN-VALIDATION] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº: ${currentUserDisplayName}`);

                // Ëá™ÂàÜ‰ª•Â§ñ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Ç®„É©„Éº
                const othersSelected = selectedAssignees.filter(name => name !== currentUserDisplayName);
                if (othersSelected.length > 0) {
                    alert(`‚ö†Ô∏è ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØËá™ÂàÜ„ÅÆ„ÅøÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ\n\n‰ªñ„ÅÆ„É¶„Éº„Ç∂„ÉºÔºà${othersSelected.join(', ')}Ôºâ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„ÄÇ`);
                    // requiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª„Åï„Åõ„Å¶„Åã„Çâreturn
                    if (wasRequired && isColumnSelectionHidden) {
                        columnInput.setAttribute('required', '');
                    }
                    return;
                }

                // ÊãÖÂΩìËÄÖ„ÅåË§áÊï∞‰∫∫ÔºàËá™ÂàÜ„ÅåË§áÊï∞ÂõûÈÅ∏Êäû„Åï„Çå„Çã„Åì„Å®„ÅØ„Å™„ÅÑ„ÅåÂøµ„ÅÆ„Åü„ÇÅÔºâ
                if (selectedAssignees.length > 1) {
                    alert('‚ö†Ô∏è ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØËá™ÂàÜ„ÅÆ„ÅøÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ\n\nË§áÊï∞„ÅÆÊãÖÂΩìËÄÖ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
                    // requiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª„Åï„Åõ„Å¶„Åã„Çâreturn
                    if (wasRequired && isColumnSelectionHidden) {
                        columnInput.setAttribute('required', '');
                    }
                    return;
                }

                // Ëá™ÂàÜ„ÅåÊãÖÂΩìËÄÖ„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà
                if (!selectedAssignees.includes(currentUserDisplayName)) {
                    alert('‚ö†Ô∏è ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØËá™ÂàÜ„ÇíÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
                    // requiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª„Åï„Åõ„Å¶„Åã„Çâreturn
                    if (wasRequired && isColumnSelectionHidden) {
                        columnInput.setAttribute('required', '');
                    }
                    return;
                }

                console.log('‚úÖ [HIDDEN-VALIDATION] „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÊàêÂäü');
            }

            // ‚òÖ‚òÖ‚òÖ „Çø„Ç§„É†„Çæ„Éº„É≥ÂïèÈ°å„ÅÆ‰øÆÊ≠£ÔºöÁ∑®ÈõÜÊôÇ„ÅÆ„ÅøJSTË£úÊ≠£ ‚òÖ‚òÖ‚òÖ
            let deadline;
            if (editingTask) {
                // Á∑®ÈõÜÊôÇÔºö„É≠„Éº„Ç´„É´ÊôÇÈñì„Å®„Åó„Å¶Ëß£Èáà„Åó„Å¶UTC„Å´Â§âÊèõ
                const localDateTime = `${date}T${time || '23:59'}`;
                const localDate = new Date(localDateTime);
                console.log('üîç [TIMEZONE SAVE] Edit mode - Local datetime string:', localDateTime);
                console.log('üîç [TIMEZONE SAVE] Edit mode - Local date object:', localDate);
                console.log('üîç [TIMEZONE SAVE] Edit mode - UTC conversion:', localDate.toISOString());
                deadline = localDate;
            } else {
                // Êñ∞Ë¶è‰ΩúÊàêÊôÇÔºöÂæìÊù•ÈÄö„Çä„ÅÆÂá¶ÁêÜÔºàÂ§âÊõ¥„Å™„ÅóÔºâ
                deadline = new Date(`${date}T${time || '23:59'}`);
                console.log('üîç [TIMEZONE SAVE] New task mode - No timezone adjustment');
            }
            
            console.log('üîç [DEADLINE DEBUG] Constructed deadline:');
            console.log('üîç [DEADLINE DEBUG] Date string:', `${date}T${time || '23:59'}`);
            console.log('üîç [DEADLINE DEBUG] Deadline object:', deadline);
            console.log('üîç [DEADLINE DEBUG] Deadline ISO:', deadline.toISOString());
            console.log('üîç [DEADLINE DEBUG] Current time:', new Date().toISOString());
            console.log('üîç [DEADLINE DEBUG] Is future deadline:', deadline > new Date());
            
            // Ê∑ª‰ªò„Éï„Ç°„Ç§„É´Âá¶ÁêÜ
            const attachments = [];
            if (fileInput.files.length > 0) {
                const fileProcessingPromises = Array.from(fileInput.files).map(file => {
                    return new Promise((resolve, reject) => {
                        // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫Âà∂Èôê (5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            reject(`„Éï„Ç°„Ç§„É´ "${file.name}" „ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºà5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ`);
                            return;
                        }
                        
                        const fileInfo = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            lastModified: file.lastModified
                        };
                        
                        // ÁîªÂÉè„ÅÆÂ†¥Âêà„ÅØ„Éó„É¨„Éì„É•„ÉºÁî®„ÅÆ„Éá„Éº„ÇøURL„ÇíÁîüÊàê
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                fileInfo.dataUrl = e.target.result;
                                resolve(fileInfo);
                            };
                            reader.onerror = () => resolve(fileInfo);
                            reader.readAsDataURL(file);
                        } else {
                            resolve(fileInfo);
                        }
                    });
                });
                
                try {
                    const processedFiles = await Promise.all(fileProcessingPromises);
                    attachments.push(...processedFiles);
                } catch (error) {
                    alert(error);
                    return;
                }
            }
            
            if (editingTask) {
                // ÊúüÈôêÂ§âÊõ¥„ÅÆÁ¢∫Ë™çÂá¶ÁêÜ
                const oldDeadline = new Date(editingTask.deadline);
                const newDeadline = deadline;
                const wasOverdue = isOverdue(editingTask.deadline, editingTask.columnId);
                const willBeOverdue = isOverdue(newDeadline.toISOString(), editingTask.columnId);
                
                console.log(`üîç [DEADLINE] Checking deadline change for task ${editingTask.id}`);
                // ÊúüÈôêÂ§âÊõ¥„ÅÆË©≥Á¥∞„É≠„Ç∞ÔºàDEBUGÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ
                if (window.DEBUG_MODE) {
                    console.log(`üîç [DEADLINE] Old deadline: ${editingTask.deadline}, wasOverdue: ${wasOverdue}`);
                    console.log(`üîç [DEADLINE] New deadline: ${newDeadline.toISOString()}, willBeOverdue: ${willBeOverdue}`);
                }
                console.log(`üîç [DEADLINE] Task column: ${editingTask.columnId}`);
                
                // Á∑®ÈõÜ
                console.log('üîç [EDIT] Before updating editingTask:', {
                    id: editingTask.id,
                    title: editingTask.title,
                    projectId: editingTask.projectId,
                    projectName: editingTask.projectName,
                    columnId: editingTask.columnId
                });
                
                editingTask.title = title;
                editingTask.deadline = deadline.toISOString();
                // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§
                editingTask.assignees = selectedAssignees;
                // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÂè§„ÅÑassignee„Éï„Ç£„Éº„É´„Éâ„ÇÇ‰øùÊåÅ
                editingTask.assignee = selectedAssignees.length > 0 ? selectedAssignees[0] : 'Êú™Ë®≠ÂÆö';
                editingTask.memo = memo;
                editingTask.updatedAt = new Date().toISOString(); // Êõ¥Êñ∞ÊôÇÂàª„ÇíË®òÈå≤
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞ÔºàÁ∑®ÈõÜÊôÇ„ÅØÊó¢Â≠òÊÉÖÂ†±„Çí‰øùÊåÅÔºâ
                if (isProjectTask) {
                    editingTask.projectId = projectId;
                    editingTask.projectName = projectName;
                } else if (!editingTask.projectId) {
                    // Êñ∞Ë¶è‰ΩúÊàêÊôÇ„ÅÆ„Åønull„Å´Ë®≠ÂÆö„ÄÅÁ∑®ÈõÜÊôÇ„ÅØÊó¢Â≠ò„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„Çí‰øùÊåÅ
                    editingTask.projectId = null;
                    editingTask.projectName = null;
                }
                
                console.log('üîç [EDIT] After updating editingTask:', {
                    id: editingTask.id,
                    title: editingTask.title,
                    projectId: editingTask.projectId,
                    projectName: editingTask.projectName,
                    columnId: editingTask.columnId
                });
                
                // Phase 2: PJ„Çø„Çπ„ÇØ„ÅÆÁ∑®ÈõÜ„Åß„ÅØPJÊÉÖÂ†±„ÅØÂ§âÊõ¥„Åó„Å™„ÅÑ
                console.log(`üìù [TASK EDIT] Updated task: ${editingTask.title}`);
                
                // Êñ∞„Åó„ÅÑÊ∑ª‰ªò„Éï„Ç°„Ç§„É´„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
                if (attachments.length > 0) {
                    if (!editingTask.attachments) editingTask.attachments = [];
                    editingTask.attachments.push(...attachments);
                    
                    // „Éï„Ç°„Ç§„É´Ê∑ª‰ªòÈÄöÁü•„ÇíÈÄÅ‰ø°Ôºà„Ç≥„É°„É≥„ÉàÈÄöÁü•„ÅÆÈáçË§á„ÇíÈò≤„Åê„Åü„ÇÅÔºâ
                    console.log('üìé [FILE-ATTACH] „Éï„Ç°„Ç§„É´Ê∑ª‰ªòÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô');
                    sendFileAttachmentNotification(editingTask, attachments);
                }
                
                // ‚òÖ‚òÖ‚òÖ ÈáçË¶ÅÔºötasksÈÖçÂàóÂÜÖ„ÅÆÂØæÂøú„Åô„Çã„Çø„Çπ„ÇØ„ÇÇÊõ¥Êñ∞ ‚òÖ‚òÖ‚òÖ
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('üîç [CRITICAL] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('üîç [CRITICAL] Before updating tasks array - Task exists:', !!tasks[taskIndex]);
                    // editingTask„ÅÆÂÖ®„Å¶„ÅÆÂ§âÊõ¥„ÇítasksÈÖçÂàó„Å´ÂèçÊò†
                    tasks[taskIndex] = { ...editingTask };
                    console.log('üîç [CRITICAL] After updating tasks array - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        columnId: tasks[taskIndex].columnId
                    });
                } else {
                    console.error('‚ùå [CRITICAL] Task not found in tasks array! EditingTask ID:', editingTask.id);
                    console.log('üîç [CRITICAL] Current tasks array IDs:', tasks.map(t => t.id));
                }
            } else {
                // Êñ∞Ë¶è‰ΩúÊàê
                const isUnifiedMode = document.getElementById('task-modal').dataset.unifiedMode === 'true';
                const targetColumn = isUnifiedMode 
                    ? document.getElementById('task-column-input').value 
                    : document.getElementById('task-modal').dataset.targetColumn;
                const currentUser = getCurrentUser();
                const newTask = {
                    id: Date.now(),
                    title: title,
                    deadline: deadline.toISOString(),
                    // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§ÔºàÊó¢Â≠ò„Éá„Éº„Çø„ÅÆÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Éï„Ç£„Éº„É´„ÉâÂÆöÁæ©„Å™„ÅóÔºâ
                    assignees: selectedAssignees,
                    // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÂè§„ÅÑassignee„Éï„Ç£„Éº„É´„Éâ„ÇÇ‰øùÊåÅ
                    assignee: selectedAssignees.length > 0 ? selectedAssignees[0] : 'Êú™Ë®≠ÂÆö',
                    memo: memo,
                    attachments: attachments,
                    comments: [],
                    columnId: targetColumn,
                    completed: targetColumn === 'done',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email || 'unknown', // ‰ΩúÊàêËÄÖ„ÅÆemail

                    // „Çø„Çπ„ÇØÈùûË°®Á§∫Ê©üËÉΩ
                    isHidden: document.getElementById('task-hidden-input').checked,

                    // Phase 2: PJ„Çø„Çπ„ÇØÊã°Âºµ„Éï„Ç£„Éº„É´„Éâ
                    projectId: isProjectTask ? projectId : null,
                    projectName: isProjectTask ? projectName : null,
                    personalStatus: targetColumn,
                    projectStatus: targetColumn,
                    pendingMove: null,
                };
                
                if (isProjectTask) {
                    console.log(`üéØ [PJ TASK CREATE] Created new PJ task: ${projectId} - ${projectName}`);
                } else {
                    console.log(`üë§ [PERSONAL TASK CREATE] Created new personal task: ${title}`);
                }
                tasks.unshift(newTask);
                
                // „Çø„Çπ„ÇØ‰ΩúÊàêÊôÇ„ÅÆ‰∏ÄÊôÇ‰øùÂ≠ò„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†
                if (window.pendingComment) {
                    console.log('üìù [COMMENT] ‰∏ÄÊôÇ‰øùÂ≠ò„Åï„Çå„Åü„Ç≥„É°„É≥„Éà„Çí„Çø„Çπ„ÇØ„Å´ËøΩÂä†:', window.pendingComment);
                    
                    // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂèñÂæó
                    let currentUser = '„É¶„Éº„Ç∂„Éº';
                    try {
                        const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                        if (session && session.user && session.user.name) {
                            currentUser = session.user.name;
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è [COMMENT] „Çª„ÉÉ„Ç∑„Éß„É≥ÂèñÂæóÂ§±Êïó:', error);
                    }
                    
                    // „Ç≥„É°„É≥„Éà„Çí„Çø„Çπ„ÇØ„Å´ËøΩÂä†
                    const comment = {
                        text: window.pendingComment,
                        author: currentUser,
                        timestamp: new Date().toISOString(),
                        id: Date.now()
                    };
                    
                    if (!newTask.comments) {
                        newTask.comments = [];
                    }
                    newTask.comments.push(comment);
                    
                    // „É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•Âá¶ÁêÜ
                    checkUnifiedCommentNotifications(window.pendingComment, currentUser.name, newTask.id);
                    
                    // ‰∏ÄÊôÇ‰øùÂ≠ò„Çí„ÇØ„É™„Ç¢
                    window.pendingComment = null;
                    console.log('‚úÖ [COMMENT] „Ç≥„É°„É≥„Éà„Çí„Çø„Çπ„ÇØ„Å´ËøΩÂä†ÂÆå‰∫Ü');
                }
                
                // „Çø„Çπ„ÇØ‰ΩúÊàêÈÄöÁü•ÔºàÁµ±ÂêàÈÄöÁü•ÂØæÂøúÊ∏à„ÅøÔºâ
                sendTaskCreationNotification(newTask, selectedAssignees);
                
                // ‚ö†Ô∏è [ÂªÉÊ≠¢] checkCollaborativeTaskNotifications „ÅØÈáçË§áÈÄöÁü•„ÅÆÂéüÂõ†„Å®„Å™„Çã„Åü„ÇÅÁÑ°ÂäπÂåñ
                // sendTaskCreationNotification „ÅßÁµ±ÂêàÈÄöÁü•„Å®„Åó„Å¶Âá¶ÁêÜÊ∏à„Åø
            }
            
            console.log('üíæ [EDIT SAVE] About to save tasks and render');
            console.log('üîç [EDIT SAVE] Tasks count before save:', tasks.length);
            console.log('üîç [EDIT SAVE] EditingTask details:', editingTask ? {
                id: editingTask.id,
                title: editingTask.title,
                projectId: editingTask.projectId,
                projectName: editingTask.projectName,
                columnId: editingTask.columnId
            } : 'null');

            // üöÄ Ê•ΩË¶≥ÁöÑUIÊõ¥Êñ∞: „Åæ„ÅöUI„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
            console.log('üöÄ [OPTIMISTIC] Rendering UI immediately');
            render();
            updateStats();

            // üîí „Çª„ÉÉ„Ç∑„Éß„É≥‰øùË≠∑Ôºö„Çø„Çπ„ÇØ‰ΩúÊàêÂâç„Å´„Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            const currentUserBackup = localStorage.getItem('currentUser');
            const isEditing = !!editingTask;
            const targetTaskForFirebase = editingTask || tasks[0];

            // üî• „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßFirebase‰øùÂ≠òÔºàawait„Å™„ÅóÔºâ
            (async () => {
                try {
                    await saveTasks();
                    console.log('üîç [EDIT SAVE] Tasks count after save:', tasks.length);

                    // üîß Â¢óÊÆñ„Éê„Ç∞‰øÆÊ≠£: saveTasks()„ÅßÊó¢„Å´Firebase„Å´‰øùÂ≠òÊ∏à„Åø„ÅÆ„Åü„ÇÅ„ÄÅÁ∑®ÈõÜ„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂÄãÂà•Êõ¥Êñ∞
                    // Êñ∞Ë¶è„Çø„Çπ„ÇØ„ÅØsaveTasks()„Åß‰øùÂ≠ò„Åï„Çå„Çã„Åü„ÇÅ„ÄÅcreateTask()„ÇíÂëº„Å∞„Å™„ÅÑ
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser && isEditing) {
                        if (targetTaskForFirebase) {
                            console.log('üî• [FIREBASE] „Çø„Çπ„ÇØÁ∑®ÈõÜ„ÇíFirebase„Å´ÂêåÊúü‰∏≠...', targetTaskForFirebase.title);
                            const result = await window.FirebaseDB.updateTask(targetTaskForFirebase.id, targetTaskForFirebase);
                            if (result.success) {
                                console.log('‚úÖ [FIREBASE] „Çø„Çπ„ÇØÊõ¥Êñ∞ÊàêÂäü:', targetTaskForFirebase.id);
                            } else {
                                console.error('‚ùå [FIREBASE] „Çø„Çπ„ÇØÊõ¥Êñ∞„Ç®„É©„Éº:', result.error);
                            }
                        }
                    } else if (!isEditing) {
                        // üîß Êñ∞Ë¶è„Çø„Çπ„ÇØ„ÅØsaveTasks()„ÅßÊó¢„Å´‰øùÂ≠òÊ∏à„Åø - createTask()„ÇíÂëº„Å∞„Å™„ÅÑÔºàÂ¢óÊÆñ„Éê„Ç∞Èò≤Ê≠¢Ôºâ
                        console.log('‚úÖ [FIREBASE] Êñ∞Ë¶è„Çø„Çπ„ÇØ„ÅØsaveTasks()„Åß‰øùÂ≠òÊ∏à„Åø - ÂÄãÂà•createTask„ÅØ„Çπ„Ç≠„ÉÉ„Éó');
                    }

                    // üîí „Çª„ÉÉ„Ç∑„Éß„É≥‰øùË≠∑ÔºöFirebaseÂêåÊúüÂæå„Å´„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
                    const sessionAfterSync = JSON.parse(localStorage.getItem('currentSession') || 'null');

                    if (currentSession && sessionAfterSync) {
                        if (currentSession.user?.email !== sessionAfterSync.user?.email) {
                            console.warn('‚ö†Ô∏è [SESSION-PROTECT] „Çª„ÉÉ„Ç∑„Éß„É≥Â§âÊõ¥„ÇíÊ§úÂá∫ÔºÅÂæ©ÂÖÉ„Åó„Åæ„Åô');
                            localStorage.setItem('currentSession', JSON.stringify(currentSession));
                            if (currentUserBackup) {
                                localStorage.setItem('currentUser', currentUserBackup);
                            }
                        }
                    }
                    console.log('‚úÖ [OPTIMISTIC] Background Firebase save completed');
                } catch (error) {
                    console.error('‚ùå [OPTIMISTIC] Background save error:', error);
                    // „Ç®„É©„ÉºÊôÇ„ÅØÂÜçÂ∫¶Firebase„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶ÂêåÊúü
                    loadTasks().then(() => render());
                }
            })();

            console.log('üé® [EDIT SAVE] UI updated (optimistic), Firebase saving in background');

            // üîÑ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàêÊôÇ„ÅØ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éì„É•„Éº„Å´Ëá™ÂãïÂàá„ÇäÊõø„Åà
            if (!editingTask && isProjectTask && projectId) {
                console.log('üîÑ [AUTO-SWITCH] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éì„É•„Éº„Å´Ëá™ÂãïÂàá„ÇäÊõø„Åà:', projectId, projectName);
                await selectProject(projectId);
            }

            // Á∑®ÈõÜ‰øùÂ≠òÊôÇ„ÅÆÈÄöÁü•Âá¶ÁêÜÔºà„Éï„Ç°„Ç§„É´Ê∑ª‰ªò„ÅØÊó¢„Å´ÈÄöÁü•Ê∏à„Åø„Å™„ÅÆ„Åß„ÄÅ„Ç≥„É°„É≥„ÉàÈÄöÁü•„ÅÆ„ÅøÔºâ
            // üö´ [ÁÑ°ÂäπÂåñ] Áµ±ÂêàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„ÅåÊó¢„Å´addCommentÂÜÖ„ÅßÂÆüË°å„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅÈáçË§áÈÄöÁü•„ÇíÈò≤„Åê„Åü„ÇÅ„Å´ÁÑ°ÂäπÂåñ
            console.log(`üö´ [SAVE] „Ç≥„É°„É≥„ÉàÈÄöÁü•„ÅØaddComment()ÂÜÖ„ÅßÂÆüË°åÊ∏à„Åø - ÈáçË§áÈò≤Ê≠¢„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó`);
            /*
            if (editingTask && editingTask.comments && editingTask.comments.length > 0 && attachments.length === 0) {
                // ÊúÄÊñ∞„ÅÆ„Ç≥„É°„É≥„Éà„Åß„É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà„Éï„Ç°„Ç§„É´Ê∑ª‰ªò„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÅØÈô§Â§ñÔºâ
                const latestComment = editingTask.comments[editingTask.comments.length - 1];
                const commentTime = new Date(latestComment.timestamp);
                const now = new Date();
                
                // 5Áßí‰ª•ÂÜÖ„Å´‰ΩúÊàê„Åï„Çå„Åü„Ç≥„É°„É≥„Éà„ÅÆ„ÅøÈÄöÁü•Ôºà„Éï„Ç°„Ç§„É´Ê∑ª‰ªòÊôÇ„ÅÆË™§ÈÄöÁü•„ÇíÈò≤„ÅêÔºâ
                if ((now - commentTime) < 5000) {
                    console.log(`üîî [SAVE] ÊúÄÊñ∞„Ç≥„É°„É≥„Éà„ÅÆ„É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ: "${latestComment.text}"`);
                    checkMentionNotifications(latestComment.text, latestComment.author, editingTask.id);
                }
            }
            */
            
            // üö´ „Çø„Çπ„ÇØ‰ΩúÊàê„ÉªÁ∑®ÈõÜÂæå„ÅÆÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁÑ°ÂäπÂåñÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÔºâ
            // setTimeout(() => checkDeadlines(), 100);
            
            // required Â±ûÊÄß„ÇíÂæ©Ê¥ª (Áµ±‰∏Ä‰ΩúÊàê„É¢„Éº„ÉâÁî®)
            if (wasRequired && isColumnSelectionHidden) {
                columnInput.setAttribute('required', '');
                console.log(`üîß [FORM] Restored required attribute to task-column-input`);
            }
            
            closeModal();
            
            } catch (error) {
                console.error('üö® [SAVE TASK ERROR]', error);
                alert('„Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);

                // „Ç®„É©„ÉºÊôÇ„ÇÇrequiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª
                const columnInput = document.getElementById('column-select');
                const wasRequired = columnInput && columnInput.hasAttribute('required');
                if (wasRequired && isColumnSelectionHidden) {
                    columnInput.setAttribute('required', '');
                }
            } finally {
                // ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢: ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
                const saveButton = document.getElementById('save-task-button');
                if (saveButton) {
                    saveButton.disabled = false;
                    console.log('üîì [SAVE] ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ');
                }
            }
        }
        
        function closeModal() {
            document.getElementById('task-modal').classList.remove('show');
            editingTask = null;

            // „Éï„Ç©„Éº„É†ÂÖ®‰Ωì„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = '';
            document.getElementById('task-time-input').value = '';
            document.getElementById('task-memo-input').value = '';

            // ÈùûË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„É™„Çª„ÉÉ„Éà
            const hiddenCheckbox = document.getElementById('task-hidden-input');
            if (hiddenCheckbox) {
                hiddenCheckbox.checked = false;
            }

            // ÊãÖÂΩìËÄÖÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            const assigneeCheckboxes = document.querySelectorAll('.assignee-checkbox');
            assigneeCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
            const fileInput = document.getElementById('task-files-input');
            const dropZone = document.getElementById('file-drop-zone');
            const commentInput = document.getElementById('comment-input');

            if (fileInput) {
                fileInput.value = '';
            }
            if (dropZone) {
                dropZone.innerHTML = 'üìÅ „Åì„Åì„Å´„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó „Åæ„Åü„ÅØ ‰∏äË®ò„Éú„Çø„É≥„ÅßÈÅ∏Êäû';
            }
            if (commentInput) {
                commentInput.value = '';
            }

            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            const projectSelect = document.getElementById('task-project-select');
            if (projectSelect) {
                projectSelect.value = '';
            }

            // Phase 2: PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÇíÈùûË°®Á§∫„Å´Êàª„Åô
            // PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï
            // PJ„Éï„Ç£„Éº„É´„Éâ„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï

        }
        
        // ÈáçË§áÈñ¢Êï∞ÂâäÈô§: deleteTaskÈñ¢Êï∞„ÅØÂæå„ÅßÂÜçÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºà12345Ë°åÁõÆÔºâ
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
        function handleDragStart(e, taskId) {
            console.log(`üü¢ [MAIN] handleDragStart called with taskId: ${taskId}`);
            console.log(`üü¢ [MAIN] All tasks:`, tasks);
            console.log(`üü¢ [MAIN] isBulkMode: ${isBulkMode}`);

            // üîß ÂûãÂ§âÊèõÔºöÊñáÂ≠óÂàó/Êï∞ÂÄ§„Å©„Å°„Çâ„Åß„ÇÇÊ§úÁ¥¢„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
            draggedTask = tasks.find(t => t.id == taskId || t.id === String(taskId) || t.id === Number(taskId));
            console.log(`üü¢ [MAIN] Found draggedTask:`, draggedTask);
            if (!draggedTask) {
                console.error(`‚ùå [MAIN] draggedTask not found for taskId: ${taskId}`);
                console.error(`‚ùå [MAIN] taskId type: ${typeof taskId}, value: ${taskId}`);
                console.error(`‚ùå [MAIN] Available task IDs:`, tasks.map(t => ({id: t.id, type: typeof t.id})));
                return false;
            }
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', taskId);
        }
        
        function handleDragEnd(e) {
            console.log(`üî¥ [MAIN] handleDragEnd called`);
            e.target.classList.remove('dragging');
            draggedTask = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        async function handleDrop(e, columnId) {
            console.log(`üîµ [MAIN] handleDrop called with columnId: ${columnId}`);
            console.log(`üîµ [MAIN] draggedTask:`, draggedTask);
            console.log(`üîµ [MAIN] Event target:`, e.target);
            console.log(`üîµ [MAIN] Event currentTarget:`, e.currentTarget);
            e.preventDefault();
            const dropZone = e.currentTarget;
            dropZone.classList.remove('drag-over');

            // üîß draggedTask„ÅÆID„Çí‰øùÂ≠òÔºàpromptForEvidence„ÅßhandleDragEnd„ÅåÂëº„Å∞„Çå„Å¶null„Å´„Å™„ÇãÂïèÈ°å„Å´ÂØæÂá¶Ôºâ
            const draggedTaskId = draggedTask ? draggedTask.id : null;
            console.log(`üîß [FIX] draggedTaskId‰øùÂ≠ò: ${draggedTaskId}`);

            if (draggedTask || draggedTaskId) {
                // draggedTask„Åånull„ÅÆÂ†¥Âêà„ÄÅID„Åã„ÇâÂÜçÂèñÂæó
                if (!draggedTask && draggedTaskId) {
                    draggedTask = tasks.find(t => t.id === draggedTaskId);
                    console.log(`üîß [FIX] draggedTask„ÇíID„Åã„ÇâÂÜçÂèñÂæó:`, draggedTask);
                }
                console.log(`üîµ [MAIN] Current task column: ${draggedTask.columnId}, Target: ${columnId}`);
                console.log(`üîç [DROP DEBUG] Tasks count BEFORE move: ${tasks.length}`);
                console.log(`üîç [DROP DEBUG] DraggedTask details:`, JSON.stringify({
                    id: draggedTask.id,
                    title: draggedTask.title,
                    projectId: draggedTask.projectId,
                    projectName: draggedTask.projectName,
                    hasComments: draggedTask.comments ? draggedTask.comments.length : 0,
                    hasAttachments: draggedTask.attachments ? draggedTask.attachments.length : 0
                }, null, 2));
                
                if (draggedTask.columnId !== columnId) {

                    // ‚úÖ DONE„Ç´„É©„É†„Å∏„ÅÆÁßªÂãïÊôÇ„ÅØÁ¢∫Ë™ç„Ç¢„É©„Éº„ÉàÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÇÇÂØæÂøúÔºâ
                    if (isDoneColumn(columnId)) {
                        const confirmComplete = confirm(
                            `‚úÖ „Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Å´„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                            `„Äå${draggedTask.title}„Äç`
                        );
                        if (!confirmComplete) {
                            console.log(`‚ùå [DONE] „É¶„Éº„Ç∂„Éº„ÅåÂÆå‰∫Ü„Çí„Ç≠„É£„É≥„Çª„É´: ${draggedTask.title}`);
                            // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                            const draggingElement = document.querySelector('.dragging');
                            if (draggingElement) {
                                draggingElement.classList.remove('dragging');
                            }
                            draggedTask = null;
                            return;
                        }
                    }

                    // üóëÔ∏è „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†„Å∏„ÅÆÁßªÂãïÊôÇ„ÅØÁ¢∫Ë™ç„Ç¢„É©„Éº„ÉàÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÇÇÂØæÂøúÔºâ
                    if (isTrashColumn(columnId)) {
                        const confirmTrash = confirm(
                            `„Çø„Çπ„ÇØ„Çí„Ç¢„Éº„Ç´„Ç§„Éñ„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                            `„Äå${draggedTask.title}„Äç\n\n` +
                            `‚Äª „Ç¢„Éº„Ç´„Ç§„Éñ„Åã„Çâ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÂæ©ÂÖÉÂèØËÉΩ„Åß„Åô\n` +
                            `‚Äª „Ç¢„Éº„Ç´„Ç§„Éñ„Åß180Êó•ÁµåÈÅéÂæå„Å´Ëá™ÂãïÂÆåÂÖ®ÂâäÈô§„Åï„Çå„Åæ„Åô`
                        );
                        if (!confirmTrash) {
                            console.log(`‚ùå [ARCHIVE] „É¶„Éº„Ç∂„Éº„Åå„Ç¢„Éº„Ç´„Ç§„ÉñÁßªÂãï„Çí„Ç≠„É£„É≥„Çª„É´: ${draggedTask.title}`);
                            // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                            const draggingElement = document.querySelector('.dragging');
                            if (draggingElement) {
                                draggingElement.classList.remove('dragging');
                            }
                            draggedTask = null;
                            return;
                        }
                        // „Ç¢„Éº„Ç´„Ç§„ÉñÁßªÂãïÊôÇ„Å´deletedAt„ÇíË®òÈå≤
                        draggedTask.deletedAt = new Date().toISOString();
                    }

                    // üö´ ÊúüÈôêÂàá„Çå„ÉÅ„Çß„ÉÉ„ÇØÔºöÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÅØÁßªÂãï‰∏çÂèØÔºàDONE„Å∏„ÅÆÁßªÂãï„ÅØ‰æãÂ§ñ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÇÇÂØæÂøúÔºâ
                    if (!isDoneColumn(columnId) && draggedTask.deadline) {
                        const now = new Date();
                        const deadline = new Date(draggedTask.deadline);
                        if (deadline < now) {
                            alert('‚ö†Ô∏è „Çø„Çπ„ÇØ„ÅÆÊúüÈôê„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÜçÈñã„Åô„ÇãÂ†¥Âêà„ÅØÁ∑®ÈõÜ„Åã„ÇâÊúüÈôê„ÇíÂÜçË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                            console.log(`‚ùå [DEADLINE] ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÅÆÁßªÂãï„Çí„Éñ„É≠„ÉÉ„ÇØ: ${draggedTask.title}, ÊúüÈôê: ${draggedTask.deadline}`);
                            // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                            const draggingElement = document.querySelector('.dragging');
                            if (draggingElement) {
                                draggingElement.classList.remove('dragging');
                            }
                            draggedTask = null;
                            return;
                        }
                    }

                    // üîß Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºö‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøÁßªÂãïÂèØËÉΩ
                    const currentUser = getCurrentUser();
                    if (currentUser.role === 'user') {
                        const canMove = draggedTask.assignees && draggedTask.assignees.includes(currentUser.name) || 
                                       draggedTask.assignee === currentUser.name;
                        if (!canMove) {
                            alert('‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Çø„Çπ„ÇØ„ÅØÁßªÂãï„Åß„Åç„Åæ„Åõ„Çì„ÄÇËá™ÂàÜ„ÅåÊãÖÂΩìËÄÖ„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅÆ„ÅøÁßªÂãïÂèØËÉΩ„Åß„Åô„ÄÇ');
                            // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                            const draggingElement = document.querySelector('.dragging');
                            if (draggingElement) {
                                draggingElement.classList.remove('dragging');
                            }
                            draggedTask = null;
                            return;
                        }
                    }
                    
                    console.log(`üü° [MAIN] Moving "${draggedTask.title}" from ${draggedTask.columnId} to ${columnId}`);
                    
                    // PJ„Çø„Çπ„ÇØ„ÅÆË®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÔºàÁßªÂãï„ÅÆ„Åü„Å≥„Å´ÂøÖÈ†àÔºâ
                    if (draggedTask.projectId && draggedTask.projectName) {
                        console.log(`üîç [PJ DEBUG] Before evidence check - Tasks count: ${tasks.length}`);
                        const hasEvidence = checkTaskEvidence(draggedTask, true); // ÁßªÂãïÊôÇ„Éï„É©„Ç∞„Çítrue
                        console.log(`üîç [PJ DEBUG] Evidence check result: ${hasEvidence}, Tasks count: ${tasks.length}`);
                        
                        if (!hasEvidence) {
                            console.log(`üîç [PJ DEBUG] Before promptForEvidence - Tasks count: ${tasks.length}`);
                            const evidenceResult = await promptForEvidence(draggedTask);
                            console.log(`üîç [PJ DEBUG] After promptForEvidence - Result: ${evidenceResult}, Tasks count: ${tasks.length}`);
                            
                            if (!evidenceResult) {
                                console.log(`‚ùå [PJ] Ë®ºÊÜë„Å™„Åó„ÅÆ„Åü„ÇÅÁßªÂãï„Ç≠„É£„É≥„Çª„É´: ${draggedTask.title}`);
                                console.log(`üîç [PJ DEBUG] Cancel move - Tasks count: ${tasks.length}`);
                                // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                                const draggingElement = document.querySelector('.dragging');
                                if (draggingElement) {
                                    draggingElement.classList.remove('dragging');
                                }
                                draggedTask = null;
                                return; // ÁßªÂãï„Çí„Ç≠„É£„É≥„Çª„É´
                            }
                        }
                        console.log(`üîç [PJ DEBUG] After all evidence checks - Tasks count: ${tasks.length}`);

                        // üîß promptForEvidenceÂæå„Å´draggedTask„Åånull„Å´„Å™„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅID„Åã„ÇâÂÜçÂèñÂæó
                        if (!draggedTask && draggedTaskId) {
                            draggedTask = tasks.find(t => t.id === draggedTaskId);
                            console.log(`üîß [FIX] Ë®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÂæå„Å´draggedTask„ÇíID„Åã„ÇâÂÜçÂèñÂæó:`, draggedTask);
                        }
                    }

                    // üîß Ë®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÂ§ñ„Åß„ÇÇdraggedTask„Åånull„Å´„Å™„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅID„Åã„ÇâÂÜçÂèñÂæó
                    if (!draggedTask && draggedTaskId) {
                        draggedTask = tasks.find(t => t.id === draggedTaskId);
                        console.log(`üîß [FIX] Ë®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÂ§ñ„ÅßdraggedTask„ÇíID„Åã„ÇâÂÜçÂèñÂæó:`, draggedTask);
                    }

                    // Done„Ç´„É©„É†„Å´ÁßªÂãï„Åô„ÇãÂ†¥Âêà„ÄÅcompletedAt„ÇíË®òÈå≤Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÇÇÂØæÂøúÔºâ
                    if (isDoneColumn(columnId) && !draggedTask.completedAt) {
                        draggedTask.completedAt = new Date().toISOString();
                        // üîß tasksÈÖçÂàóÂÜÖ„ÇÇÊõ¥Êñ∞
                        const taskIndex = tasks.findIndex(t => t.id === draggedTask.id);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].completedAt = draggedTask.completedAt;
                        }
                    }
                    // Done„Ç´„É©„É†„Åã„Çâ‰ªñ„Å´ÁßªÂãï„Åô„ÇãÂ†¥Âêà„ÄÅcompletedAt„Çí„ÇØ„É™„Ç¢Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÇÇÂØæÂøúÔºâ
                    else if (isDoneColumn(draggedTask.columnId) && !isDoneColumn(columnId)) {
                        draggedTask.completedAt = null;
                        // üîß tasksÈÖçÂàóÂÜÖ„ÇÇÊõ¥Êñ∞
                        const taskIndex = tasks.findIndex(t => t.id === draggedTask.id);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].completedAt = null;
                        }
                    }

                    // „Ç¢„Éº„Ç´„Ç§„Éñ„Åã„ÇâÂæ©ÂÖÉ„Åô„ÇãÂ†¥Âêà„ÄÅdeletedAt„Çí„ÇØ„É™„Ç¢Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÇÇÂØæÂøúÔºâ
                    if (isTrashColumn(draggedTask.columnId) && !isTrashColumn(columnId)) {
                        draggedTask.deletedAt = null;
                        // üîß tasksÈÖçÂàóÂÜÖ„ÇÇÊõ¥Êñ∞
                        const taskIndex = tasks.findIndex(t => t.id === draggedTask.id);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].deletedAt = null;
                        }
                        console.log(`‚ôªÔ∏è [RESTORE] „Ç¢„Éº„Ç´„Ç§„Éñ„Åã„ÇâÂæ©ÂÖÉ: ${draggedTask.title}`);
                    }

                    console.log(`üîç [DROP DEBUG] Before column change - Tasks count: ${tasks.length}`);
                    draggedTask.columnId = columnId;
                    draggedTask.completed = isDoneColumn(columnId);

                    // üîß tasksÈÖçÂàóÂÜÖ„ÅÆÂÖÉ„ÅÆ„Çø„Çπ„ÇØ„ÇÇÁ¢∫ÂÆü„Å´Êõ¥Êñ∞ÔºàÂèÇÁÖß„ÅåÂàá„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„Å´ÂÇô„Åà„Å¶Ôºâ
                    const taskIndex = tasks.findIndex(t => t.id === draggedTask.id);
                    if (taskIndex !== -1) {
                        tasks[taskIndex].columnId = columnId;
                        tasks[taskIndex].completed = isDoneColumn(columnId);
                        console.log(`üîß [FIX] tasksÈÖçÂàóÂÜÖ„ÅÆ„Çø„Çπ„ÇØ„ÇÇÊõ¥Êñ∞: index=${taskIndex}, columnId=${columnId}`);
                    } else {
                        console.error(`‚ùå [FIX] tasksÈÖçÂàóÂÜÖ„Å´„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: id=${draggedTask.id}`);
                    }

                    console.log(`üîç [DROP DEBUG] After column change - Tasks count: ${tasks.length}`);
                    
                    // „Çø„Çπ„ÇØÁßªÂãïÊôÇÂàª„ÇíË®òÈå≤„Åó„ÄÅÈÄöÁü•„ÇíÈÄÅ‰ø°ÔºàÂÖ®„Çø„Çπ„ÇØÂØæË±°Ôºâ
                    draggedTask.lastMovedAt = new Date().toISOString();
                    // üîß tasksÈÖçÂàóÂÜÖ„ÇÇÊõ¥Êñ∞
                    if (taskIndex !== -1) {
                        tasks[taskIndex].lastMovedAt = draggedTask.lastMovedAt;
                    }
                    console.log(`üìÖ [TASK MOVE] Recorded move time: ${draggedTask.lastMovedAt}`);
                    
                    // „Çø„Çπ„ÇØÁßªÂãïÊôÇ„Å´ÊúüÈôêÈÄöÁü•„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„ÉàÔºàÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÇÇÂÜçÁ∑®ÈõÜÂèØËÉΩ„Å´Ôºâ
                    if (draggedTask.overdueNotified || draggedTask.oneDayNotified || draggedTask.threeHourNotified || draggedTask.fiveMinNotified) {
                        console.log(`üîÑ [TASK MOVE] ÊúüÈôêÈÄöÁü•„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà: ${draggedTask.title}`);
                        draggedTask.overdueNotified = false;
                        draggedTask.oneDayNotified = false;
                        draggedTask.threeHourNotified = false;
                        draggedTask.fiveMinNotified = false;
                        // üîß tasksÈÖçÂàóÂÜÖ„ÇÇÊõ¥Êñ∞
                        if (taskIndex !== -1) {
                            tasks[taskIndex].overdueNotified = false;
                            tasks[taskIndex].oneDayNotified = false;
                            tasks[taskIndex].threeHourNotified = false;
                            tasks[taskIndex].fiveMinNotified = false;
                        }
                    }
                    
                    // ÊãÖÂΩìËÄÖ„Å∏„ÅÆÁßªÂãïÈÄöÁü•Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÉªÈÄöÂ∏∏„Çø„Çπ„ÇØ‰∏°ÊñπÂØæÂøúÔºâ
                    console.log(`üîç [DROP DEBUG] Before notification - Tasks count: ${tasks.length}`);
                    sendPJMoveNotification(draggedTask, columnId);
                    console.log(`üîç [DROP DEBUG] After notification - Tasks count: ${tasks.length}`);

                    // üöÄ Ê•ΩË¶≥ÁöÑUIÊõ¥Êñ∞: „Åæ„ÅöUI„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                    console.log(`üöÄ [OPTIMISTIC] Before render() - Tasks count: ${tasks.length}`);
                    render();
                    updateStats();
                    console.log(`üöÄ [OPTIMISTIC] UI updated immediately`);

                    // üî• „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßFirebase‰øùÂ≠òÔºàawait„Å™„ÅóÔºâ
                    saveTasks().then(success => {
                        if (success) {
                            console.log(`‚úÖ [OPTIMISTIC] Firebase save completed in background`);
                        } else {
                            console.error(`‚ùå [OPTIMISTIC] Firebase save failed - UI may be out of sync`);
                            // „Ç®„É©„ÉºÊôÇ„ÅØÂÜçÂ∫¶Firebase„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶ÂêåÊúü
                            loadTasks().then(() => render());
                        }
                    }).catch(error => {
                        console.error(`‚ùå [OPTIMISTIC] Firebase save error:`, error);
                        loadTasks().then(() => render());
                    });

                    console.log(`‚úÖ [MAIN] Task moved successfully to ${columnId} (optimistic update)`);
                } else {
                    console.log(`‚ö†Ô∏è [MAIN] Same column, no move needed`);
                }
            } else {
                console.log(`‚ùå [MAIN] No draggedTask found`);
            }
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        
        function getColumnTitle(columnId) {
            const column = columns.find(c => c.id === columnId);
            return column ? column.title : columnId;
        }
        
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
        let cachedProjectsData = null;
        let cacheTimestamp = 0;
        const CACHE_DURATION = 60000; // 60Áßí

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†ÂèñÂæóÔºàÂêåÊúüÈñ¢Êï∞„ÄÅ„Ç≠„É£„ÉÉ„Ç∑„É•‰ΩøÁî®Ôºâ
        function getProjectColumns(projectId) {
            if (!projectId) return columns;

            // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
            if (cachedProjectsData && (Date.now() - cacheTimestamp < CACHE_DURATION)) {
                const project = cachedProjectsData[projectId];
                if (project && project.columns && project.columns.length > 0) {
                    console.log('‚úÖ [GET-COLUMNS] „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†ÂèñÂæó:', projectId, '‚Üí', project.columns);
                    return project.columns.map((columnTitle, index) => ({
                        id: `pj_${projectId}_${index}`,
                        title: columnTitle,
                        color: ['#667eea', '#f59e0b', '#8b5cf6', '#10b981', '#6c757d'][index % 5]
                    }));
                } else {
                    console.warn('‚ö†Ô∏è [GET-COLUMNS] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„Åå‰∏çÂÆåÂÖ®:', projectId, project);
                }
            } else {
                console.warn('‚ö†Ô∏è [GET-COLUMNS] „Ç≠„É£„ÉÉ„Ç∑„É•ÁÑ°Âäπ„Åæ„Åü„ÅØÊúüÈôêÂàá„Çå:', {
                    hasCachedData: !!cachedProjectsData,
                    cacheAge: Date.now() - cacheTimestamp,
                    cacheDuration: CACHE_DURATION
                });
            }

            console.log('‚ö†Ô∏è [GET-COLUMNS] „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„ÇíËøî„Åô:', projectId);
            return columns; // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„Çí‰ΩøÁî®
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
        async function updateProjectsCache() {
            if (!window.FirebaseDB) return;

            const result = await window.FirebaseDB.getProjects();
            if (result.success && result.projects) {
                cachedProjectsData = {};
                result.projects.forEach(project => {
                    cachedProjectsData[project.id] = {
                        name: project.name,
                        description: project.description || '',
                        columns: project.columns || DEFAULT_PROJECT_COLUMNS
                    };
                });
                cacheTimestamp = Date.now();
                console.log('‚úÖ [CACHE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞:', Object.keys(cachedProjectsData).length, '‰ª∂');
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÁµ±‰∏ÄÁöÑ„Å´ÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        async function getAllProjects() {
            // üî• Firebase„Åã„ÇâÂÖ®„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæóÔºàLocalStorage‰∏ç‰ΩøÁî®Ôºâ
            if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                try {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success && result.projects) {
                        return result.projects.map(project => ({
                            id: project.id,
                            name: project.name || '„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêçÊú™Ë®≠ÂÆö',
                            description: project.description || '',
                            isPublic: project.visibility === 'public',
                            createdAt: project.createdAt || new Date().toISOString(),
                            createdBy: project.createdBy || 'Unknown',
                            columns: project.columns || DEFAULT_PROJECT_COLUMNS
                        }));
                    }
                } catch (error) {
                    console.error('‚ùå [GET-PROJECTS] FirebaseÂèñÂæó„Ç®„É©„Éº:', error);
                }
            }

            console.warn('‚ö†Ô∏è [GET-PROJECTS] FirebaseÊú™Êé•Á∂ö');
            return [];
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Çµ„Ç§„Éâ„Éê„Éº„ÇíÊèèÁîª
        async function renderProjectsList() {
            const projectsList = document.getElementById('projects-list');
            if (!projectsList) {
                console.error('‚ùå [PROJECTS] projects-list element not found!');
                return;
            }

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂèñÂæóÔºàÁµ±‰∏ÄÈñ¢Êï∞„Çí‰ΩøÁî®Ôºâ
            const projects = await getAllProjects();
            
            // ÂêÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØÊï∞„ÇíË®àÁÆóÔºà„É°„É≥„Éê„Éº„Éï„Ç£„É´„Çø„ÉºËÄÉÊÖÆÔºâ
            const projectTaskCounts = {};
            const currentUser = getCurrentUser();
            const filteredByMember = selectedAssigneeFilters.length > 0 ?
                tasks.filter(t => {
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(selectedAssigneeFilters[0]);
                    }
                    return t.assignee === selectedAssigneeFilters[0];
                }) : tasks;

            filteredByMember.forEach(task => {
                // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØ‰ΩúÊàêËÄÖ+ÊãÖÂΩìËÄÖ‰ª•Â§ñ„ÅØ„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑ
                if (task.isHidden && task.createdBy !== currentUser.email) {
                    const isAssignee = task.assignees?.includes(currentUser.name) || task.assignee === currentUser.name;
                    if (!isAssignee) {
                        return;
                    }
                }
                if (task.projectId) {
                    projectTaskCounts[task.projectId] = (projectTaskCounts[task.projectId] || 0) + 1;
                }
            });

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÅÆHTMLÁîüÊàê
            let projectsHTML = '';

            // ÈÄöÂ∏∏„Çø„Çπ„ÇØË°®Á§∫„Éú„Çø„É≥
            const isNormalTasksSelected = selectedProjectFilters.length === 0;
            const normalTasksCount = filteredByMember.filter(t => {
                if (t.projectId) return false;
                // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØ‰ΩúÊàêËÄÖ+ÊãÖÂΩìËÄÖ‰ª•Â§ñ„ÅØ„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑ
                if (t.isHidden && t.createdBy !== currentUser.email) {
                    const isAssignee = t.assignees?.includes(currentUser.name) || t.assignee === currentUser.name;
                    if (!isAssignee) {
                        return false;
                    }
                }
                return true;
            }).length;
            projectsHTML += `
                <div class="project-card ${isNormalTasksSelected ? 'active' : ''}" onclick="showNormalTasks()">
                    <div class="project-card-name">üìã ÈÄöÂ∏∏„Çø„Çπ„ÇØ</div>
                    <div class="project-card-meta">
                        <span>ÂÄã‰∫∫„ÉªÂÖ±ÈÄö„Çø„Çπ„ÇØ</span>
                        <span class="project-card-count">${normalTasksCount}</span>
                    </div>
                </div>
            `;
            
            // ÂêÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí„Ç´„Éº„Éâ„Å®„Åó„Å¶ËøΩÂä†
            projects.forEach(project => {
                const taskCount = projectTaskCounts[project.id] || 0;
                const isSelected = selectedProjectFilters.includes(project.id);
                projectsHTML += `
                    <div class="project-card ${isSelected ? 'active' : ''}" onclick="selectProject('${project.id}')">
                        <div class="project-card-name">${project.name}</div>
                        <div class="project-card-meta">
                            <span>${project.isPublic ? 'üåê ÂÖ¨Èñã' : 'üîí ÈùûÂÖ¨Èñã'}</span>
                            <span class="project-card-count">${taskCount}</span>
                        </div>
                    </div>
                `;
            });
            
            if (projects.length === 0) {
                projectsHTML = `
                    <div style="text-align: center; color: #6b778c; padding: 2rem 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÅ</div>
                        <div>„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">Ë®≠ÂÆö„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
            }
            
            projectsList.innerHTML = projectsHTML;
            console.log('üé® [PROJECTS] Project list sidebar rendered with', projects.length, 'projects');
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÊ©üËÉΩ
        async function selectProject(projectId) {
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàID„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            selectedProjectFilters = [projectId];
            console.log('üìã [FILTER] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®:', projectId);

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞„Åó„Å¶„Åã„ÇâÂÜçÊèèÁîª
            await updateProjectsCache();

            // Ë°®Á§∫ÂØæË±°„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
            updateAssigneeFilterText();

            // ÂÜçÊèèÁîª„Åó„Å¶„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
            render();

            // üîí „Ç´„É©„É†ËøΩÂä†„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateColumnAddButtonState();
        }
        
        // ÈÄöÂ∏∏„Çø„Çπ„ÇØË°®Á§∫Ê©üËÉΩ
        function showNormalTasks() {
            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢
            selectedProjectFilters = [];
            console.log('üìã [FILTER] ÈÄöÂ∏∏„Çø„Çπ„ÇØË°®Á§∫„Å´Âàá„ÇäÊõø„Åà');

            // Ë°®Á§∫ÂØæË±°„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
            updateAssigneeFilterText();

            // ÂÜçÊèèÁîª
            render();

            // üîí „Ç´„É©„É†ËøΩÂä†„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateColumnAddButtonState();
        }

        // „É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function render() {
            // üîß ‰øÆÊ≠£: „Çø„Çπ„ÇØ„ÅåÊú™ÂÆöÁæ©„ÅÆÂ†¥Âêà„ÅØÁ©∫ÈÖçÂàó„ÅßÂàùÊúüÂåñ
            if (!tasks || tasks === undefined) {
                console.log('‚ö†Ô∏è [RENDER] „Çø„Çπ„ÇØ„Éá„Éº„ÇøÊú™ÂÆöÁæ© - Á©∫ÈÖçÂàó„ÅßÂàùÊúüÂåñ„Åó„Å¶ÊèèÁîªÁ∂öË°å');
                tasks = [];
                window.tasks = [];
            }
            
            console.log('üé® [RENDER] Starting render, total tasks:', tasks.length);
            const board = document.getElementById('kanban-board');
            if (!board) {
                console.error('‚ùå [RENDER] kanban-board element not found!');
                return;
            }
            board.innerHTML = '';
            console.log('üé® [RENDER] Board cleared successfully');
            
            // Áµ±Âêà„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            let filteredTasks = tasks;
            let currentColumns = columns; // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†

            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„ÅØÂâäÈô§Ê∏à„Åø

            // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæóÔºàÈùûË°®Á§∫„Çø„Çπ„ÇØ„Éï„Ç£„É´„Çø„ÉºÁî®Ôºâ
            const currentUser = getCurrentUser();

            if (selectedProjectFilters.length > 0) {
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº: ÁâπÂÆö„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫
                filteredTasks = tasks.filter(t => {
                    // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØ‰ΩúÊàêËÄÖ+ÊãÖÂΩìËÄÖ„ÅÆ„ÅøË°®Á§∫
                    if (t.isHidden) {
                        console.log(`üîí [HIDDEN-FILTER] Task "${t.title}":`, {
                            createdBy: t.createdBy,
                            currentEmail: currentUser.email,
                            isCreator: t.createdBy === currentUser.email,
                            assignees: t.assignees,
                            assignee: t.assignee,
                            currentName: currentUser.name
                        });

                        if (t.createdBy === currentUser.email) {
                            console.log(`‚úÖ [HIDDEN-FILTER] ‰ΩúÊàêËÄÖ„Å™„ÅÆ„ÅßË°®Á§∫: ${t.title}`);
                            return t.projectId && selectedProjectFilters.includes(t.projectId);
                        }

                        const isAssignee = t.assignees?.includes(currentUser.name) || t.assignee === currentUser.name;
                        console.log(`üîç [HIDDEN-FILTER] ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ: ${isAssignee}`);

                        if (!isAssignee) {
                            console.log(`‚ùå [HIDDEN-FILTER] ‰ΩúÊàêËÄÖ„Åß„ÇÇÊãÖÂΩìËÄÖ„Åß„ÇÇ„Å™„ÅÑ„ÅÆ„ÅßÈùûË°®Á§∫: ${t.title}`);
                            return false;
                        }
                        console.log(`‚úÖ [HIDDEN-FILTER] ÊãÖÂΩìËÄÖ„Å™„ÅÆ„ÅßË°®Á§∫: ${t.title}`);
                    }
                    return t.projectId && selectedProjectFilters.includes(t.projectId);
                });

                // „É°„É≥„Éê„Éº„Éï„Ç£„É´„Çø„Éº„Å®„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ
                if (selectedAssigneeFilters.length > 0) {
                    filteredTasks = filteredTasks.filter(t => {
                        if (t.assignees && Array.isArray(t.assignees)) {
                            return t.assignees.some(a => selectedAssigneeFilters.includes(a));
                        }
                        return selectedAssigneeFilters.includes(t.assignee);
                    });
                    console.log(`üë• [RENDER] Project + Assignee filter: showing ${filteredTasks.length} tasks for project ${selectedProjectFilters[0]} and assignee ${selectedAssigneeFilters[0]}`);
                } else {
                    console.log(`üë• [RENDER] Project filter: showing ${filteredTasks.length} tasks for project ${selectedProjectFilters[0]}`);
                }

                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†„ÇíÂèñÂæó
                currentColumns = getProjectColumns(selectedProjectFilters[0]);
                console.log('üé® [RENDER] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†ÂèñÂæó:', selectedProjectFilters[0], '‚Üí', currentColumns.length, 'ÂÄã');
            } else if (selectedAssigneeFilters.length > 0) {
                // ÂÄã‰∫∫„ÉªÂÖ±ÈÄö„Çø„Çπ„ÇØ„ÅÆÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„ÉºÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅØÈô§Â§ñÔºâ
                filteredTasks = tasks.filter(t => {
                    // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØ‰ΩúÊàêËÄÖ+ÊãÖÂΩìËÄÖ„ÅÆ„ÅøË°®Á§∫
                    if (t.isHidden) {
                        console.log(`üîí [HIDDEN-FILTER-ASSIGNEE] Task "${t.title}":`, {
                            createdBy: t.createdBy,
                            currentEmail: currentUser.email,
                            isCreator: t.createdBy === currentUser.email,
                            assignees: t.assignees,
                            assignee: t.assignee,
                            currentName: currentUser.name
                        });

                        if (t.createdBy === currentUser.email) {
                            console.log(`‚úÖ [HIDDEN-FILTER-ASSIGNEE] ‰ΩúÊàêËÄÖ„Å™„ÅÆ„ÅßË°®Á§∫: ${t.title}`);
                        } else {
                            const isAssignee = t.assignees?.includes(currentUser.name) || t.assignee === currentUser.name;
                            console.log(`üîç [HIDDEN-FILTER-ASSIGNEE] ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ: ${isAssignee}`);

                            if (!isAssignee) {
                                console.log(`‚ùå [HIDDEN-FILTER-ASSIGNEE] ‰ΩúÊàêËÄÖ„Åß„ÇÇÊãÖÂΩìËÄÖ„Åß„ÇÇ„Å™„ÅÑ„ÅÆ„ÅßÈùûË°®Á§∫: ${t.title}`);
                                return false;
                            }
                            console.log(`‚úÖ [HIDDEN-FILTER-ASSIGNEE] ÊãÖÂΩìËÄÖ„Å™„ÅÆ„ÅßË°®Á§∫: ${t.title}`);
                        }
                    }
                    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅØÈô§Â§ñ
                    if (t.projectId) return false;

                    // „É°„É≥„Éê„Éº„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.some(a => selectedAssigneeFilters.includes(a));
                    }
                    return selectedAssigneeFilters.includes(t.assignee);
                });
                console.log(`üë§ [RENDER] Assignee filter (normal tasks only): showing ${filteredTasks.length} tasks for ${selectedAssigneeFilters[0]}`);
            } else {
                // ÂÄã‰∫∫„ÉªÂÖ±ÈÄö„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅØÈô§Â§ñÔºâ
                filteredTasks = tasks.filter(t => {
                    // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅØ‰ΩúÊàêËÄÖ+ÊãÖÂΩìËÄÖ„ÅÆ„ÅøË°®Á§∫
                    if (t.isHidden) {
                        console.log(`üîí [HIDDEN-FILTER-NORMAL] Task "${t.title}":`, {
                            createdBy: t.createdBy,
                            currentEmail: currentUser.email,
                            isCreator: t.createdBy === currentUser.email,
                            assignees: t.assignees,
                            assignee: t.assignee,
                            currentName: currentUser.name
                        });

                        if (t.createdBy === currentUser.email) {
                            console.log(`‚úÖ [HIDDEN-FILTER-NORMAL] ‰ΩúÊàêËÄÖ„Å™„ÅÆ„ÅßË°®Á§∫: ${t.title}`);
                        } else {
                            const isAssignee = t.assignees?.includes(currentUser.name) || t.assignee === currentUser.name;
                            console.log(`üîç [HIDDEN-FILTER-NORMAL] ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ: ${isAssignee}`);

                            if (!isAssignee) {
                                console.log(`‚ùå [HIDDEN-FILTER-NORMAL] ‰ΩúÊàêËÄÖ„Åß„ÇÇÊãÖÂΩìËÄÖ„Åß„ÇÇ„Å™„ÅÑ„ÅÆ„ÅßÈùûË°®Á§∫: ${t.title}`);
                                return false;
                            }
                            console.log(`‚úÖ [HIDDEN-FILTER-NORMAL] ÊãÖÂΩìËÄÖ„Å™„ÅÆ„ÅßË°®Á§∫: ${t.title}`);
                        }
                    }
                    return !t.projectId;
                });
                console.log('üìã [RENDER] ÂÄã‰∫∫„ÉªÂÖ±ÈÄö„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫:', filteredTasks.length, '‰ª∂');
            }
            
            // „Éï„Ç£„É´„ÇøÈÅ©Áî®Âæå: ${filteredTasks.length}‰ª∂

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Çµ„Ç§„Éâ„Éê„Éº„ÇíÊèèÁîªÔºàÈùûÂêåÊúüÔºâ
            renderProjectsList().catch(err => console.error('‚ùå [RENDER] „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ßÊèèÁîª„Ç®„É©„Éº:', err));
            
            // ÈÄöÂ∏∏„ÅÆ„Ç´„É©„É†„ÇíË°®Á§∫Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†„Åæ„Åü„ÅØ„Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†Ôºâ
            currentColumns.forEach(column => {
                let columnTasks = filteredTasks.filter(t => {
                    
                    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†„ÅÆÂ†¥Âêà„ÄÅ„Ç´„É©„É†„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åß„Éû„ÉÉ„Éî„É≥„Ç∞
                    if (selectedProjectFilters.length > 0 && column.id.startsWith('pj_')) {
                        const columnIndex = parseInt(column.id.split('_')[2]);
                        // üî• ‰øÆÊ≠£: LocalStorage„Åß„ÅØ„Å™„ÅècachedProjectsData„Çí‰ΩøÁî®ÔºàFirebase„ÅÆÊúÄÊñ∞„Éá„Éº„ÇøÔºâ
                        const project = cachedProjectsData[selectedProjectFilters[0]];

                        if (project && project.columns) {
                            // „Çø„Çπ„ÇØ„ÅÆcolumnId„ÅåÊ®ôÊ∫ñ„Ç´„É©„É†„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
                            const defaultColumns = ['todo', 'inprogress', 'waiting', 'done', 'trash'];
                            const taskColumnIndex = defaultColumns.indexOf(t.columnId);
                            
                            if (taskColumnIndex !== -1 && taskColumnIndex < project.columns.length) {
                                return taskColumnIndex === columnIndex;
                            }
                            
                            // Êó¢„Å´„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†ID„ÅÆÂ†¥Âêà
                            return t.columnId === column.id;
                        }
                    }
                    
                    return t.columnId === column.id;
                });
                
                // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÇíÂÖàÈ†≠„Å´„ÄÅ„Åù„ÅÆÂæåÊúüÈôêÈ†Ü„Åß„ÇΩ„Éº„Éà
                columnTasks.sort((a, b) => {
                    const aOverdue = a.deadline && isOverdue(a.deadline, a.columnId);
                    const bOverdue = b.deadline && isOverdue(b.deadline, b.columnId);
                    
                    // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÇíÂÖàÈ†≠„Å´
                    if (aOverdue && !bOverdue) return -1;
                    if (!aOverdue && bOverdue) return 1;
                    
                    // Âêå„ÅòÁä∂ÊÖã„ÅÆÂ†¥Âêà„ÅØÊúüÈôêÈ†Ü
                    if (a.deadline && b.deadline) {
                        return new Date(a.deadline) - new Date(b.deadline);
                    }
                    return 0;
                });
                
                const columnEl = document.createElement('div');
                columnEl.className = 'column';
                columnEl.setAttribute('data-column-id', column.id); // „Ç¢„Éº„Ç´„Ç§„Éñ„Çπ„Çø„Ç§„É´Áî®
                columnEl.innerHTML = `
                    <div class="column-header" style="background: ${column.color}; color: white;">
                        <div class="column-title">${column.title}</div>
                        <div class="column-count">${columnTasks.length}</div>
                    </div>
                    <div class="column-content" 
                         ondragover="handleDragOver(event)"
                         ondrop="handleDrop(event, '${column.id}')"
                         ondragenter="handleDragEnter(event)"
                         ondragleave="handleDragLeave(event)">
                        ${columnTasks.map(task => createTaskCard(task)).join('')}
                    </div>
                `;
                
                board.appendChild(columnEl);
            });
            
            updateStats();
        }
        
        function createTaskCard(task, isFromOverdueColumn = false) {
            // „Çø„Çπ„ÇØ„Ç´„Éº„Éâ‰ΩúÊàêÔºàË©≥Á¥∞„É≠„Ç∞ÂâäÊ∏õÔºâ
            const deadline = new Date(task.deadline);
            const isOverdueTask = isOverdue(task.deadline, task.columnId);
            const isTodayTask = isToday(task.deadline, task.columnId);
            
            // ÁµåÈÅéÊôÇÈñì„ÇíË®àÁÆó
            let daysSinceCreated = 0;
            let elapsedText = '';
            let isStale = false; // 3Êó•‰ª•‰∏äÂÅúÊªû„Éï„É©„Ç∞
            
            if (task.createdAt) {
                const createdDate = new Date(task.createdAt);
                const now = new Date();
                const timeDiff = now - createdDate;
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                daysSinceCreated = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                
                if (hoursDiff < 24) {
                    // 24ÊôÇÈñì‰ª•ÂÜÖ„ÅØÊôÇÈñìË°®Á§∫
                    elapsedText = `${String(hoursDiff).padStart(2, '0')}h`;
                } else {
                    // 24ÊôÇÈñì‰ª•‰∏ä„ÅØÊó•Êï∞Ë°®Á§∫
                    elapsedText = `${daysSinceCreated}d`;
                }
                
                // 3Êó•‰ª•‰∏ä„ÅßÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Å™„ÅÑ„Çø„Çπ„ÇØ„ÅØÂÅúÊªû„Éï„É©„Ç∞ÔºàÂÆå‰∫Ü„Ç´„É©„É†„Éª„Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†„ÅØÈô§Â§ñÔºâ
                if (daysSinceCreated >= 3 && !isDoneColumn(task.columnId) && !isTrashColumn(task.columnId)) {
                    isStale = true;
                }
            }
            
            let cardClass = `task-card priority-${task.priority}`;
            if (isOverdueTask) cardClass += ' overdue';
            else if (isTodayTask) cardClass += ' today';
            
            let deadlineClass = 'task-deadline';
            let deadlineIcon = 'üìÖ';
            if (isOverdueTask) {
                deadlineClass += ' overdue';
                deadlineIcon = 'üö®';
            } else if (isTodayTask) {
                deadlineClass += ' today';
                deadlineIcon = '‚è∞';
            }

            // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§

            const checkboxHtml = isBulkMode ? `
                <div style="position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10;">
                    <input type="checkbox"
                           onchange="toggleTaskSelection('${task.id}')"
                           onclick="event.stopPropagation()"
                           ${selectedTasks.has(task.id) ? 'checked' : ''}
                           style="width: 16px; height: 16px; cursor: pointer;">
                </div>
            ` : '';
            
            return `
                <div class="${cardClass}"
                     draggable="${!isBulkMode}"
                     ${!isBulkMode ? `ondragstart="handleDragStart(event, '${task.id}')" ondragend="handleDragEnd(event)"` : ''}
                     onclick="${isBulkMode ? `toggleTaskSelection('${task.id}')` : `editTask('${task.id}')`}"
                     style="position: relative; cursor: ${isBulkMode ? 'pointer' : 'move'}; ${isOverdueTask ? 'border-left: 4px solid #dc2626 !important; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3) !important;' : ''}${isStale && !isOverdueTask ? 'border: 2px solid #e53e3e; box-shadow: 0 0 8px rgba(229, 62, 62, 0.3);' : ''}"
                     title="${isOverdueTask ? 'üö® ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„Åß„Åô' : ''}${isStale ? ' ‚ö†Ô∏è 3Êó•‰ª•‰∏äÂÅúÊªû‰∏≠' : ''}">
                    ${checkboxHtml}
                    <div class="task-title">
                        <span>
                            ${task.isRecurring ? '<span style="color: #2d3748; margin-right: 0.25rem;" title="ÂÆöÊúü„Çø„Çπ„ÇØ">üîÑ</span>' : ''}
                            ${task.projectId ? '<span style="color: #2b6cb0; margin-right: 0.25rem;" title="PJ„Çø„Çπ„ÇØ">üë•</span>' : ''}
                            ${task.title}
                        </span>
                    </div>
                    <div class="task-meta">
                        <div style="margin-bottom: 0.25rem;">
                            <span class="${deadlineClass}">
                                ${deadlineIcon} ${deadline.toLocaleDateString('ja-JP')} ${deadline.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                            </span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            ${elapsedText ? `<span style="font-size: 0.75rem; color: ${isStale ? '#e53e3e' : '#718096'}; font-weight: ${isStale ? '600' : '400'};">‚è±Ô∏è ${elapsedText}</span>` : ''}
                            ${isStale ? '<span style="font-size: 0.75rem; color: #e53e3e;">üö® ÂÅúÊªû‰∏≠</span>' : ''}
                        </div>
                    </div>
                    ${task.memo ? `<div class="task-memo">${task.memo}</div>` : ''}
                    <div class="task-badges">
                        ${task.memo ? '<span class="attachment-icon">üìù</span>' : ''}
                        ${task.attachments && task.attachments.length > 0 ? `<span class="attachment-badge">${task.attachments.length}</span>` : ''}
                        <span style="font-size: 0.7rem; color: #5e6c84;">üë§ ${getAssigneeDisplayText(task)}</span>
                    </div>
                </div>
            `;
        }
        
        function getAssigneeDisplayText(task) {
            if (task.assignees && Array.isArray(task.assignees) && task.assignees.length > 0) {
                if (task.assignees.length === 1) {
                    return task.assignees[0];
                } else if (task.assignees.length <= 3) {
                    return task.assignees.join(', ');
                } else {
                    return `${task.assignees[0]} ‰ªñ${task.assignees.length - 1}Âêç`;
                }
            }
            // ÂæåÊñπ‰∫íÊèõÊÄß
            return task.assignee || 'Êú™Ë®≠ÂÆö';
        }
        
        function updateStats() {
            // FirebaseË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂâç„ÅÆÁµ±Ë®àÊõ¥Êñ∞Èò≤Ê≠¢
            if (!tasks || tasks === undefined) {
                console.log('‚è≥ [STATS] „Çø„Çπ„ÇØ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠ - Áµ±Ë®àÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
            let filteredTasks = tasks;
            
            // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
            if (assigneeFilter) {
                filteredTasks = tasks.filter(t => {
                    // Êñ∞„Åó„ÅÑassignees„Éï„Ç£„Éº„É´„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(assigneeFilter);
                    }
                    // Êóß„ÅÑassignee„Éï„Ç£„Éº„É´„Éâ„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
                    return t.assignee === assigneeFilter;
                });
            }
            
            const overdueCount = filteredTasks.filter(t => !isDoneColumn(t.columnId) && isOverdue(t.deadline, t.columnId)).length;
            const todayCount = filteredTasks.filter(t => !isDoneColumn(t.columnId) && isToday(t.deadline, t.columnId)).length;
            const completedCount = filteredTasks.filter(t => isDoneColumn(t.columnId)).length;

            // 3Êó•‰ª•‰∏äÂÅúÊªû„Åó„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÇíÊ§úÂá∫
            const now = new Date();
            const staleTasks = filteredTasks.filter(t => {
                if (isDoneColumn(t.columnId)) return false;
                
                // createdAt„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ªäÊó•‰ΩúÊàê„Åï„Çå„Åü„ÇÇ„ÅÆ„Å®„Åó„Å¶Êâ±„ÅÜÔºàÂÅúÊªûÂà§ÂÆö„Åã„ÇâÈô§Â§ñÔºâ
                if (!t.createdAt) return false;
                
                const createdDate = new Date(t.createdAt);
                const daysDiff = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                return daysDiff >= 3;
            });
            
            // „ÉÅ„Éº„É†Âπ≥Âùá„ÅÆ1.2ÂÄç‰ª•‰∏ä„ÅÆ„Çø„Çπ„ÇØ„ÇíÊåÅ„Å§ÊãÖÂΩìËÄÖ„ÇíÊ§úÂá∫
            const assigneeCounts = {};
            let totalAssignedTasks = 0;
            let assigneeCount = 0;
            
            // ÂÖ®„Çø„Çπ„ÇØ„ÅßÊãÖÂΩìËÄÖÂà•„Ç´„Ç¶„É≥„ÉàÔºà„Éï„Ç£„É´„ÇøÂâç„ÅÆÂÖ®‰Ωì„Åã„ÇâË®àÁÆó„ÄÅÂÆå‰∫Ü„Éª„Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„Åø„ÇíÈô§„ÅèÔºâ
            tasks.forEach(task => {
                if (!isDoneColumn(task.columnId) && !isTrashColumn(task.columnId)) {
                    // Êñ∞„Åó„ÅÑassignees„Éï„Ç£„Éº„É´„Éâ„ÅÆÂá¶ÁêÜ
                    if (task.assignees && Array.isArray(task.assignees)) {
                        task.assignees.forEach(assignee => {
                            if (!assigneeCounts[assignee]) {
                                assigneeCounts[assignee] = 0;
                                assigneeCount++;
                            }
                            assigneeCounts[assignee]++;
                            totalAssignedTasks++;
                        });
                    } else if (task.assignee && task.assignee !== 'Êú™Ë®≠ÂÆö') {
                        // Êóßassignee„Éï„Ç£„Éº„É´„Éâ„ÅÆÂá¶ÁêÜ
                        if (!assigneeCounts[task.assignee]) {
                            assigneeCounts[task.assignee] = 0;
                            assigneeCount++;
                        }
                        assigneeCounts[task.assignee]++;
                        totalAssignedTasks++;
                    }
                }
            });
            
            // „ÉÅ„Éº„É†Âπ≥Âùá„ÇíË®àÁÆó
            const avgTasksPerPerson = assigneeCount > 0 ? totalAssignedTasks / assigneeCount : 0;
            const overloadThreshold = avgTasksPerPerson * 1.2;
            
            // ÈÅéË≤†Ëç∑„ÅÆÊãÖÂΩìËÄÖÊï∞„Çí„Ç´„Ç¶„É≥„Éà
            const overloadedAssignees = Object.entries(assigneeCounts)
                .filter(([assignee, count]) => count > overloadThreshold)
                .map(([assignee, count]) => ({ assignee, count }));
            
            document.getElementById('overdue-count').textContent = overdueCount;
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('stale-count').textContent = staleTasks.length;

            // ÂÆå‰∫ÜÁéá„ÇíË®àÁÆóÔºà„Ç¢„Éº„Ç´„Ç§„ÉñÈô§„ÅèÔºâ
            const activeTasks = filteredTasks.filter(t => !isTrashColumn(t.columnId));
            const totalActiveTasks = activeTasks.length;
            const completionRate = totalActiveTasks > 0 ? Math.round((completedCount / totalActiveTasks) * 100) : 0;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;

            // ÊúüÈôêÈÅµÂÆàÁéá„ÇíË®àÁÆóÔºàÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÅÆ„ÅÜ„Å°ÊúüÈôêÂÜÖ„Å´ÂÆå‰∫Ü„Åó„ÅüÂâ≤ÂêàÔºâ
            const completedTasks = filteredTasks.filter(t => isDoneColumn(t.columnId));
            const onTimeCompletedTasks = completedTasks.filter(t => {
                if (!t.completedAt || !t.deadline) return true; // ÊÉÖÂ†±‰∏çË∂≥„ÅÆÂ†¥Âêà„ÅØÊúüÈôêÂÜÖ„Å®„Åø„Å™„Åô
                const completedDate = new Date(t.completedAt);
                const deadlineDate = new Date(t.deadline);
                return completedDate <= deadlineDate;
            });
            const complianceRate = completedTasks.length > 0 ? Math.round((onTimeCompletedTasks.length / completedTasks.length) * 100) : 0;
            document.getElementById('compliance-rate').textContent = completedTasks.length > 0 ? `${complianceRate}%` : '-';

            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠òÔºàË©≥Á¥∞Ë°®Á§∫Áî®Ôºâ
            window.staleTasks = staleTasks;
            window.overloadedAssignees = overloadedAssignees;
            window.avgTasksPerPerson = avgTasksPerPerson;

            // ÂàÜÊûê„Çµ„Éû„É™„Éº„ÇÇÊõ¥Êñ∞
            updateAnalyticsSummary();
        }
        
        function updateWorkflowStats(filteredTasks) {
            const workflowContainer = document.getElementById('workflow-status');
            if (!workflowContainer) return;
            
            // „Çπ„ÉÜ„Éº„Çø„ÇπÂà•Áµ±Ë®à„ÇíË®àÁÆó
            const statusStats = {};
            const now = new Date();
            
            columns.forEach(column => {
                const columnTasks = filteredTasks.filter(t => t.columnId === column.id);
                
                // Âπ≥ÂùáÊªûÁïôÊôÇÈñì„ÇíË®àÁÆó
                let avgDays = 0;
                if (columnTasks.length > 0) {
                    const totalDays = columnTasks.reduce((sum, task) => {
                        if (task.createdAt) {
                            const createdDate = new Date(task.createdAt);
                            const days = Math.max(0, (now - createdDate) / (1000 * 60 * 60 * 24));
                            return sum + days;
                        }
                        return sum;
                    }, 0);
                    avgDays = Math.round((totalDays / columnTasks.length) * 10) / 10; // Â∞èÊï∞ÁÇπ1Ê°Å
                }
                
                statusStats[column.id] = {
                    title: column.title,
                    count: columnTasks.length,
                    avgDays: avgDays,
                    color: column.color || '#0097A7'
                };
            });
            
            // „ÉØ„Éº„ÇØ„Éï„É≠„ÉºË°®Á§∫„ÇíÁîüÊàê
            const workflowHtml = columns.map((column, index) => {
                const stats = statusStats[column.id];
                const isBottleneck = stats.avgDays > 2.0; // 2Êó•‰ª•‰∏ä„Åß„Éú„Éà„É´„Éç„ÉÉ„ÇØÂà§ÂÆö
                const statusClass = isBottleneck ? 'bottleneck' : 'normal';
                const statusIcon = isBottleneck ? 'üö®' : '';
                
                const arrow = index < columns.length - 1 ? '<span style="margin: 0 0.25rem; color: #5e6c84;">‚Üí</span>' : '';
                
                return `
                    <div class="workflow-status-item ${statusClass}" 
                         onclick="showStatusDetails('${column.id}')"
                         style="
                            display: flex; 
                            align-items: center; 
                            gap: 0.25rem; 
                            padding: 0.25rem 0.5rem; 
                            border-radius: 4px; 
                            cursor: pointer;
                            background: ${isBottleneck ? '#fee2e2' : '#f1f5f9'};
                            border: 1px solid ${isBottleneck ? '#fca5a5' : '#cbd5e1'};
                            transition: all 0.2s;
                         "
                         onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                         title="${stats.title}: ${stats.count}‰ª∂„ÄÅÂπ≥Âùá${stats.avgDays}Êó•">
                        ${statusIcon}
                        <span style="font-weight: 600; color: ${isBottleneck ? '#dc2626' : '#374151'};">${stats.title}</span>
                        <span style="color: ${isBottleneck ? '#dc2626' : '#6b7280'};">(${stats.count}‰ª∂)</span>
                        ${stats.avgDays > 0 ? `<span style="font-size: 0.75rem; color: ${isBottleneck ? '#dc2626' : '#9ca3af'};">${stats.avgDays}Êó•</span>` : ''}
                    </div>
                    ${arrow}
                `;
            }).join('');
            
            workflowContainer.innerHTML = workflowHtml;
        }
        
        // 3Êó•‰ª•‰∏äÂÅúÊªû„Åó„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅÆË©≥Á¥∞Ë°®Á§∫
        function showStaleTasksDetail() {
            if (!window.staleTasks || window.staleTasks.length === 0) {
                alert('ÁèæÂú®„ÄÅ3Êó•‰ª•‰∏äÂÅúÊªû„Åó„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const now = new Date();
            const taskListHtml = window.staleTasks.map(task => {
                const createdDate = task.createdAt ? new Date(task.createdAt) : now;
                const daysDiff = task.createdAt ? Math.floor((now - createdDate) / (1000 * 60 * 60 * 24)) : 0;
                const column = columns.find(c => c.id === task.columnId);
                const assigneesText = task.assignees?.join(', ') || task.assignee || 'Êú™Ë®≠ÂÆö';
                
                // ÁµåÈÅéÊó•Êï∞„ÅÆË°®Á§∫ÔºàcreatedAt„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Äå‰ΩúÊàêÊó•‰∏çÊòé„Äç„Å®Ë°®Á§∫Ôºâ
                const elapsedText = task.createdAt ? `‚è±Ô∏è ${daysDiff}Êó•ÁµåÈÅé` : `‚è±Ô∏è ‰ΩúÊàêÊó•‰∏çÊòé`;
                
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${task.title}</div>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #5e6c84;">
                            <span>üë§ ${assigneesText}</span>
                            <span>üìç ${column?.title || '„Éº'}</span>
                            <span>${elapsedText}</span>
                            ${task.deadline ? `<span>üìÖ ÊúüÈôê: ${new Date(task.deadline).toLocaleDateString('ja-JP')}</span>` : ''}
                        </div>
                        ${task.memo ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">üìù ${task.memo.substring(0, 50)}...</div>` : ''}
                        <button onclick="editTask('${task.id}')" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            Á¢∫Ë™ç„ÉªÁ∑®ÈõÜ
                        </button>
                    </div>
                `;
            }).join('');
            
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modalOverlay.id = 'stale-tasks-modal';
            
            modalOverlay.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h2 style="margin: 0; font-size: 1.25rem;">üö® 3Êó•‰ª•‰∏äÂÅúÊªû„Åó„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØÔºà${window.staleTasks.length}‰ª∂Ôºâ</h2>
                        <p style="margin: 0.5rem 0 0; color: #5e6c84; font-size: 0.9rem;">ÈÄ≤ÊçóÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Å™„Çø„Çπ„ÇØ„Åß„Åô</p>
                    </div>
                    <div>${taskListHtml}</div>
                    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button onclick="document.getElementById('stale-tasks-modal').remove()" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                </div>
            `;
            
            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }
        
        // „ÉÅ„Éº„É†Âπ≥Âùá1.2ÂÄç‰ª•‰∏ä„ÅÆË≤†Ëç∑ÊãÖÂΩìËÄÖ„ÅÆË©≥Á¥∞Ë°®Á§∫
        function showWorkloadDetail() {
            if (!window.overloadedAssignees || window.overloadedAssignees.length === 0) {
                alert('ÁèæÂú®„ÄÅÈÅéË≤†Ëç∑„ÅÆÊãÖÂΩìËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const avgTasks = Math.round(window.avgTasksPerPerson * 10) / 10;
            const threshold = Math.round(avgTasks * 1.2 * 10) / 10;
            
            const assigneeListHtml = window.overloadedAssignees.map(({ assignee, count }) => {
                const overloadPercentage = Math.round((count / avgTasks - 1) * 100);
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${assignee}</div>
                                <div style="font-size: 0.85rem; color: #5e6c84;">
                                    ÊãÖÂΩì„Çø„Çπ„ÇØÊï∞: ${count}‰ª∂ÔºàÂπ≥Âùá„ÅÆ${100 + overloadPercentage}%Ôºâ
                                </div>
                            </div>
                            <button onclick="document.getElementById('assignee-filter').value='${assignee}'; filterTasks(); this.closest('div[style*=\\"position: fixed\\"]').remove();" 
                                    style="padding: 0.25rem 0.75rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                „Çø„Çπ„ÇØÁ¢∫Ë™ç
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modalOverlay.id = 'workload-modal';
            
            modalOverlay.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h2 style="margin: 0; font-size: 1.25rem;">üë• Ë≤†Ëç∑Ë™øÊï¥„ÅåÂøÖË¶Å„Å™ÊãÖÂΩìËÄÖÔºà${window.overloadedAssignees.length}ÂêçÔºâ</h2>
                        <p style="margin: 0.5rem 0 0; color: #5e6c84; font-size: 0.9rem;">
                            „ÉÅ„Éº„É†Âπ≥Âùá: ${avgTasks}‰ª∂ / ‰∫∫„ÄÄÔΩú„ÄÄË¶ÅË™øÊï¥Âü∫Ê∫ñ: ${threshold}‰ª∂‰ª•‰∏ä
                        </p>
                    </div>
                    <div>${assigneeListHtml}</div>
                    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button onclick="document.getElementById('workload-modal').remove()" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                </div>
            `;
            
            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }
        
        function showStatusDetails(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (!column) return;
            
            const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
            let filteredTasks = tasks;
            
            // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
            if (assigneeFilter) {
                filteredTasks = tasks.filter(t => {
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(assigneeFilter);
                    }
                    return t.assignee === assigneeFilter;
                });
            }
            
            // Ë©≤ÂΩì„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Çø„Çπ„ÇØ„ÇíÂèñÂæó
            const statusTasks = filteredTasks.filter(t => t.columnId === columnId);
            
            if (statusTasks.length === 0) {
                alert(`${column.title}„Çπ„ÉÜ„Éº„Çø„Çπ„Å´„ÅØ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`);
                return;
            }
            
            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const now = new Date();
            const taskListHtml = statusTasks.map(task => {
                const createdDate = new Date(task.createdAt);
                const daysOld = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                const deadline = new Date(task.deadline);
                const isOverdueTask = deadline < now;
                const assigneeList = Array.isArray(task.assignees) ? task.assignees.join(', ') : (task.assignee || 'Êú™Ë®≠ÂÆö');
                
                return `
                    <div style="
                        padding: 0.75rem; 
                        margin-bottom: 0.5rem; 
                        background: white; 
                        border: 1px solid #e5e7eb; 
                        border-radius: 6px;
                        ${isOverdueTask ? 'border-left: 4px solid #dc2626;' : ''}
                    ">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem; ${isOverdueTask ? 'color: #dc2626;' : ''}">${task.title}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    üë§ ${assigneeList} | üìÖ ${deadline.toLocaleDateString('ja-JP')} | ‚è∞ ${daysOld}Êó•ÁµåÈÅé
                                </div>
                            </div>
                            <button onclick="editTask('${task.id}'); closeStatusModal();"
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Á∑®ÈõÜ
                            </button>
                        </div>
                        ${task.memo ? `<div style="font-size: 0.85rem; color: #4b5563; margin-top: 0.5rem;">${task.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // „É¢„Éº„ÉÄ„É´HTMLÁîüÊàê
            const modalHtml = `
                <div id="status-detail-modal" style="
                    position: fixed; 
                    top: 0; left: 0; 
                    width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 1000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                " onclick="closeStatusModal()">
                    <div style="
                        background: white; 
                        border-radius: 8px; 
                        padding: 1.5rem; 
                        max-width: 600px; 
                        max-height: 80vh; 
                        overflow-y: auto;
                        margin: 1rem;
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem;">
                            <h3 style="margin: 0; color: #111827;">üìã ${column.title} (${statusTasks.length}‰ª∂)</h3>
                            <button onclick="closeStatusModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
                        </div>
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-size: 0.9rem; color: #374151;">
                                Âπ≥ÂùáÊªûÁïôÊôÇÈñì: <strong>${Math.round((statusTasks.reduce((sum, t) => sum + Math.floor((now - new Date(t.createdAt)) / (1000 * 60 * 60 * 24)), 0) / statusTasks.length) * 10) / 10}Êó•</strong>
                            </div>
                        </div>
                        <div>${taskListHtml}</div>
                    </div>
                </div>
            `;
            
            // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§„Åó„Å¶„Åã„ÇâÊñ∞„Åó„ÅÑ„É¢„Éº„ÉÄ„É´„ÇíËøΩÂä†
            const existingModal = document.getElementById('status-detail-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            console.log('üé® [RENDER] Render completed successfully');
        }
        
        function closeStatusModal() {
            const modal = document.getElementById('status-detail-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        
        
        // üî• ÂÆåÂÖ®FirebaseÂåñ: „Çø„Çπ„ÇØ‰øùÂ≠òÊ©üËÉΩ
        async function saveTasks() {
            try {
                console.log('üíæ [SAVE-TASKS] FirebaseÂ∞ÇÁî®„É¢„Éº„Éâ - „Çø„Çπ„ÇØ‰øùÂ≠òÈñãÂßã:', tasks.length, '‰ª∂');

                // üî• FirebaseË™çË®ºÁ¢∫Ë™ç
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (!currentUser) {
                    console.error('‚ùå [SAVE-TASKS] FirebaseÊú™Ë™çË®º - ‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì');
                    return false;
                }

                // Firebase„Å∏‰øùÂ≠ò
                if (!window.FirebaseDB?.saveTasks) {
                    console.error('‚ùå [SAVE-TASKS] FirebaseDB.saveTasksÊú™ÂÆöÁæ©');
                    return false;
                }

                const result = await window.FirebaseDB.saveTasks(tasks);
                if (result.success) {
                    console.log('‚úÖ [SAVE-TASKS] Firebase‰øùÂ≠òÂÆå‰∫Ü');
                    return true;
                } else {
                    console.error('‚ùå [SAVE-TASKS] Firebase‰øùÂ≠ò„Ç®„É©„Éº:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå [SAVE-TASKS] ‰∫àÊúü„Åõ„Å¨„Ç®„É©„Éº:', error);
                return false;
            }
        }
        
        // „É¶„Éº„Ç∂„ÉºÂêç„Åã„Çâ„É¶„Éº„Ç∂„ÉºID„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        async function getUserIdByName(userName) {
            try {
                // Firebase„Åã„Çâ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
                if (window.FirebaseDB && window.FirebaseDB.getUsers) {
                    const result = await window.FirebaseDB.getUsers();
                    if (result.success) {
                        const user = result.users.find(u => 
                            u.name === userName || 
                            u.email === userName || 
                            u.email?.split('@')[0] === userName
                        );
                        if (user) {
                            return user.id || user.uid;
                        }
                    }
                }
                
                // „É¶„Éº„Ç∂„Éº„Éû„ÉÉ„Éî„É≥„Ç∞„Åã„ÇâID„ÇíÁîüÊàêÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                const emailMap = {
                    'muranaka-tenma': 'muranaka-tenma@terracom.co.jp',
                    'kato-jun': 'kato-jun@terracom.co.jp',
                    'asahi-keiichi': 'asahi-keiichi@terracom.co.jp',
                    'hanzawa-yuka': 'hanzawa-yuka@terracom.co.jp',
                    'tamura-wataru': 'tamura-wataru@terracom.co.jp',
                    'hashimoto-yumi': 'hashimoto-yumi@terracom.co.jp',
                    'fukushima-ami': 'fukushima-ami@terracom.co.jp'
                };
                
                const email = emailMap[userName] || userName;
                return email.replace('@', '-').replace('.', '-'); // „Ç∑„É≥„Éó„É´„Å™IDÁîüÊàê
            } catch (error) {
                console.error('‚ùå [USER-ID] „É¶„Éº„Ç∂„ÉºIDÂèñÂæó„Ç®„É©„Éº:', error);
                return null;
            }
        }
        
        // SlackÈÄöÁü•Ê©üËÉΩÂàùÊúüÂåñ
        function initializeSlackNotification() {
            // üîî „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•Ë®±ÂèØ„Çí„É™„ÇØ„Ç®„Çπ„Éà
            if ('Notification' in window && Notification.permission === 'default') {
                console.log('üîî [INIT] „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•Ë®±ÂèØ„Çí„É™„ÇØ„Ç®„Çπ„Éà‰∏≠...');
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('‚úÖ [INIT] „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•Ë®±ÂèØ„ÅåÊâøË™ç„Åï„Çå„Åæ„Åó„Åü');
                    } else {
                        console.log('‚ùå [INIT] „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•Ë®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü');
                    }
                });
            } else if ('Notification' in window && Notification.permission === 'granted') {
                console.log('‚úÖ [INIT] „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•„ÅØÊó¢„Å´Ë®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
            } else if (!('Notification' in window)) {
                console.log('‚ùå [INIT] „Éñ„É©„Ç¶„Ç∂„ÅåÈÄöÁü•API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        }
        
        // FCMÂâäÈô§: Firebase Cloud MessagingÊ©üËÉΩ„ÇíÂÆåÂÖ®ÂâäÈô§
        // SlackÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å´Áµ±‰∏Ä
        
        // „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•„ÉÜ„Çπ„ÉàÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
        function testDesktopNotification() {
            console.log('üß™ [DESKTOP-TEST] „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•„ÉÜ„Çπ„ÉàÈñãÂßã');
            console.log('üß™ [DESKTOP-TEST] Notification support:', 'Notification' in window);
            console.log('üß™ [DESKTOP-TEST] Notification.permission:', Notification.permission);

            if (!('Notification' in window)) {
                alert('‚ùå „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈÄöÁü•API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            if (Notification.permission === 'denied') {
                alert('‚ùå ÈÄöÁü•„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åã„ÇâÈÄöÁü•„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            if (Notification.permission === 'default') {
                console.log('üß™ [DESKTOP-TEST] ÈÄöÁü•Ë®±ÂèØ„Çí„É™„ÇØ„Ç®„Çπ„Éà‰∏≠...');
                Notification.requestPermission().then(permission => {
                    console.log('üß™ [DESKTOP-TEST] Ë®±ÂèØÁµêÊûú:', permission);
                    if (permission === 'granted') {
                        testDesktopNotification(); // ÂÜçÂÆüË°å
                    } else {
                        alert('‚ùå ÈÄöÁü•Ë®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü');
                    }
                });
                return;
            }

            // ÈÄöÁü•„ÇíÈÄÅ‰ø°
            try {
                console.log('üß™ [DESKTOP-TEST] ÈÄöÁü•„ÇíÈÄÅ‰ø°‰∏≠...');
                const notification = new Notification('üß™ „ÉÜ„Çπ„ÉàÈÄöÁü•', {
                    body: '„Åì„Çå„ÅØ„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üîî</text></svg>',
                    requireInteraction: false
                });

                notification.onclick = function() {
                    console.log('üß™ [DESKTOP-TEST] ÈÄöÁü•„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
                    window.focus();
                    notification.close();
                };

                setTimeout(() => {
                    notification.close();
                }, 5000);

                console.log('‚úÖ [DESKTOP-TEST] ÈÄöÁü•ÈÄÅ‰ø°ÊàêÂäü');
                alert('‚úÖ „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•„ÉÜ„Çπ„Éà„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ\nÈÄöÁü•„ÅåË°®Á§∫„Åï„Çå„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } catch (error) {
                console.error('‚ùå [DESKTOP-TEST] ÈÄöÁü•ÈÄÅ‰ø°Â§±Êïó:', error);
                alert('‚ùå ÈÄöÁü•ÈÄÅ‰ø°‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÂÖ¨ÈñãÔºà„Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÂëº„Å≥Âá∫„Åõ„Çã„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
        window.testDesktopNotification = testDesktopNotification;

        // Slack„ÉÜ„Çπ„ÉàÈÄöÁü•Ôºà„ÉÜ„É©„ÉÅ„É£„É≥„Éç„É´„Å´ÈÄÅ‰ø°Ôºâ
        async function testSlackNotification() {
            console.log('üß™ [SLACK-TEST] „ÉÜ„Çπ„ÉàÈÄöÁü•ÈÄÅ‰ø°ÈñãÂßã');

            try {
                const currentUser = getCurrentUser();
                const testTime = new Date().toLocaleString('ja-JP');

                // „ÉÜ„Çπ„ÉàÈÄöÁü•„ÇíÈÄÅ‰ø°
                const result = await sendSlackNotification(
                    currentUser.email,
                    'üß™ SlackÈÄöÁü•„ÉÜ„Çπ„Éà',
                    `„Åì„Çå„ÅØSlackÈÄöÁü•„ÅÆ„ÉÜ„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åß„Åô„ÄÇ\nÈÄÅ‰ø°ËÄÖ: ${currentUser.name}\nÈÄÅ‰ø°ÊôÇÂàª: ${testTime}`,
                    {
                        targetUser: currentUser.name,
                        targetEmail: currentUser.email
                    }
                );

                // ÁµêÊûú„Çí„É¶„Éº„Ç∂„Éº„Å´Ë°®Á§∫
                if (window.SlackNotificationService && window.SlackNotificationService.webhookUrl) {
                    alert('‚úÖ SlackÈÄöÁü•„ÉÜ„Çπ„Éà„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ\n#„ÉÜ„É©„ÉÅ„É£„É≥„Éç„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    alert('‚ùå SlackÈÄöÁü•„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n„Ç≥„É≥„ÇΩ„Éº„É´„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            } catch (error) {
                console.error('‚ùå [SLACK-TEST] „Ç®„É©„Éº:', error);
                alert('‚ùå SlackÈÄöÁü•„ÉÜ„Çπ„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        function testNotification() {
            // SlackÈÄöÁü•„ÉÜ„Çπ„Éà„ÇíÂÆüË°å
            testSlackNotification();
        }
        
        // SlackÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†ÔºàCORSÂØæÂøúÁâàÔºâ
        async function sendSlackNotification(recipientEmail, subject, body, options = {}) {
            try {
                // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆÈÄöÁü•ÊäëÂà∂„ÉÅ„Çß„ÉÉ„ÇØ
                if (options.taskId && options.isHiddenTask) {
                    console.log(`üîí [SLACK] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${subject} („Çø„Çπ„ÇØID: ${options.taskId})`);
                    return;
                }
                
                // „Çø„Çπ„ÇØ„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÄÅisHidden„Éï„Ç£„Éº„É´„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                if (options.taskId && window.tasks) {
                    const task = window.tasks.find(t => t.id === options.taskId);
                    if (task && task.isHidden) {
                        console.log(`üîí [SLACK] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${subject} („Çø„Çπ„ÇØ: ${task.title})`);
                        return;
                    }
                }
                
                console.log(`üîî [SLACK] ÈÄöÁü•ÈÄÅ‰ø°ÈñãÂßã: ${subject}`);
                
                // SlackNotificationService„Çí‰ΩøÁî®„Åó„Å¶CORSÂà∂Èôê„ÇíÂõûÈÅø
                if (window.SlackNotificationService) {
                    const result = await window.SlackNotificationService.sendNotification(subject, body, options);
                    
                    if (result) {
                        console.log(`‚úÖ [SLACK] ÈÄöÁü•ÈÄÅ‰ø°ÊàêÂäü: ${subject}`);
                    } else {
                        console.error(`‚ùå [SLACK] ÈÄöÁü•ÈÄÅ‰ø°Â§±Êïó: ${subject}`);
                    }
                } else {
                    console.error('‚ùå [SLACK] SlackNotificationService„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                }
                
            } catch (error) {
                console.error(`‚ùå [SLACK] ÈÄöÁü•ÈÄÅ‰ø°„Ç®„É©„Éº:`, error);
            }
        }

        // „É°„Éº„É´ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†ÂâäÈô§Ê∏à„Åø - SlackÈÄöÁü•„Å´Áµ±‰∏Ä

        // „É¶„Éº„Ç∂„ÉºÂêç„Åã„Çâ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæóÔºàSlackÈÄöÁü•Áî®Ôºâ
        function getEmailByUserName(userName) {
            try {
                console.log(`üîç [EMAIL-LOOKUP] „É¶„Éº„Ç∂„ÉºÂêç„Åã„Çâ„É°„Éº„É´Ê§úÁ¥¢: ${userName}`);

                // 1. „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞activeUsers„Åã„ÇâÊ§úÁ¥¢ÔºàÊúÄÂÑ™ÂÖàÔºâ
                if (window.activeUsers && Array.isArray(window.activeUsers)) {
                    const user = window.activeUsers.find(u => u.name === userName);
                    if (user && user.email) {
                        console.log(`‚úÖ [EMAIL-LOOKUP] activeUsers„Åã„ÇâÂèñÂæó: ${user.email}`);
                        return user.email;
                    }
                }

                // 2. LocalStorage„Åã„ÇâÊ§úÁ¥¢Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const user = systemUsers.find(u => u.name === userName);
                if (user && user.email) {
                    console.log(`‚úÖ [EMAIL-LOOKUP] LocalStorage„Åã„ÇâÂèñÂæó: ${user.email}`);
                    return user.email;
                }

                console.error(`‚ùå [EMAIL-LOOKUP] „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${userName}`);
                console.log(`üîç [EMAIL-LOOKUP] activeUsers:`, window.activeUsers);
                console.log(`üîç [EMAIL-LOOKUP] systemUsers:`, systemUsers);
                return null;
            } catch (error) {
                console.error('‚ùå [EMAIL-LOOKUP] „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', error);
                return null;
            }
        }

        // „ÉÜ„Çπ„ÉàÈñ¢Êï∞„ÅØÂâäÈô§Ê∏à„ÅøÔºàSlackÈÄöÁü•„ÉÜ„Çπ„Éà„Éö„Éº„Ç∏„Çí‰ΩøÁî®Ôºâ

        // üîî „Éà„Éº„Çπ„ÉàÈÄöÁü•„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞Ôºà„Éö„Éº„Ç∏ÂÜÖÈÄöÁü•Ôºâ
        function showToastNotification(title, body, options = {}) {
            const container = document.getElementById('toast-container');
            if (!container) {
                console.error('‚ùå [TOAST] „Éà„Éº„Çπ„Éà„Ç≥„É≥„ÉÜ„Éä„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            // „Éà„Éº„Çπ„ÉàË¶ÅÁ¥†„Çí‰ΩúÊàê
            const toast = document.createElement('div');
            toast.className = 'toast';

            // „Ç¢„Ç§„Ç≥„É≥„ÇíÊ±∫ÂÆö
            let icon = 'üîî';
            if (title.includes('üì¶') || title.includes('ÁßªÂãï')) icon = 'üì¶';
            else if (title.includes('üìù') || title.includes('‰ΩúÊàê')) icon = 'üìù';
            else if (title.includes('‚úÖ') || title.includes('ÂÆå‰∫Ü')) icon = '‚úÖ';
            else if (title.includes('üóëÔ∏è') || title.includes('ÂâäÈô§')) icon = 'üóëÔ∏è';
            else if (title.includes('üí¨') || title.includes('„Ç≥„É°„É≥„Éà')) icon = 'üí¨';

            // „Çø„Ç§„Éà„É´„Åã„Çâ„Ç¢„Ç§„Ç≥„É≥„ÇíÈô§Âéª
            const cleanTitle = title.replace(/[üì¶üìù‚úÖüóëÔ∏èüí¨üîî]/g, '').trim();

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${cleanTitle}</div>
                    <div class="toast-body">${body}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            // „Çø„Çπ„ÇØID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åß„Çø„Çπ„ÇØ„ÇíÈñã„Åè
            if (options.taskId) {
                toast.addEventListener('click', (e) => {
                    if (e.target.classList.contains('toast-close')) return;
                    editTask(options.taskId);
                    toast.remove();
                });
            }

            // „Ç≥„É≥„ÉÜ„Éä„Å´ËøΩÂä†
            container.appendChild(toast);

            // 5ÁßíÂæå„Å´Ëá™Âãï„ÅßÂâäÈô§
            setTimeout(() => {
                toast.classList.add('toast-hiding');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊôÇÈñì
            }, 5000);

            console.log(`‚úÖ [TOAST] „Éà„Éº„Çπ„ÉàÈÄöÁü•Ë°®Á§∫: ${title}`);
        }

        async function showNotification(title, body, options = {}) {
            // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆÈÄöÁü•ÊäëÂà∂„ÉÅ„Çß„ÉÉ„ÇØ
            if (options.taskId && options.isHiddenTask) {
                console.log(`üîí [NOTIFICATION] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${title} („Çø„Çπ„ÇØID: ${options.taskId})`);
                return;
            }
            
            // „Çø„Çπ„ÇØ„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÄÅisHidden„Éï„Ç£„Éº„É´„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (options.taskId && window.tasks) {
                const task = window.tasks.find(t => t.id === options.taskId);
                if (task && task.isHidden) {
                    console.log(`üîí [NOTIFICATION] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${title} („Çø„Çπ„ÇØ: ${task.title})`);
                    return;
                }
            }

            console.log(`üîî [NOTIFICATION] ${title}: ${body}`);

            // üîî „Éà„Éº„Çπ„ÉàÈÄöÁü•„ÇíÂ∏∏„Å´Ë°®Á§∫Ôºà„Éö„Éº„Ç∏ÂÜÖÈÄöÁü• - „Éï„Ç©„Ç¢„Ç∞„É©„Ç¶„É≥„Éâ„Åß„ÇÇÁ¢∫ÂÆü„Å´Ë°®Á§∫Ôºâ
            showToastNotification(title, body, options);

            // üîß „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•„ÇíÈÄÅ‰ø°Ôºà„Éñ„É©„Ç¶„Ç∂„ÅÆNotification APIÔºâ
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üîî</text></svg>',
                        requireInteraction: false,
                        tag: options.tag || `notification-${Date.now()}`,
                        ...options
                    });

                    // 5ÁßíÂæå„Å´Ëá™Âãï„ÅßÈÄöÁü•„ÇíÈñâ„Åò„Çã
                    setTimeout(() => {
                        notification.close();
                    }, 5000);

                    // „Çø„Çπ„ÇØID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åß„Åù„ÅÆ„Çø„Çπ„ÇØ„ÇíÈñã„Åè
                    if (options.taskId) {
                        notification.onclick = function() {
                            window.focus();
                            editTask(options.taskId);
                            notification.close();
                        };
                    }

                    console.log(`‚úÖ [DESKTOP-NOTIFICATION] „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•ÈÄÅ‰ø°ÊàêÂäü: ${title}`);
                } catch (error) {
                    console.error('‚ùå [DESKTOP-NOTIFICATION] „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•ÈÄÅ‰ø°Â§±Êïó:', error);
                }
            } else if ('Notification' in window && Notification.permission === 'default') {
                console.log(`‚ö†Ô∏è [DESKTOP-NOTIFICATION] ÈÄöÁü•Ë®±ÂèØ„ÅåÊú™Ë®≠ÂÆö - Ë®±ÂèØ„ÇíË¶ÅÊ±Ç„Åó„Åæ„Åô`);
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log(`‚úÖ [DESKTOP-NOTIFICATION] ÈÄöÁü•Ë®±ÂèØ„ÅåÊâøË™ç„Åï„Çå„Åæ„Åó„Åü`);
                        // ÂÜçÂ∏∞ÁöÑ„Å´ÈÄöÁü•„ÇíË°®Á§∫
                        showNotification(title, body, options);
                    } else {
                        console.log(`‚ùå [DESKTOP-NOTIFICATION] ÈÄöÁü•Ë®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü`);
                    }
                });
            } else if (!('Notification' in window)) {
                console.log(`‚ùå [DESKTOP-NOTIFICATION] „Éñ„É©„Ç¶„Ç∂„ÅåÈÄöÁü•API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì`);
            } else {
                console.log(`‚ùå [DESKTOP-NOTIFICATION] ÈÄöÁü•Ë®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô (permission: ${Notification.permission})`);
            }

            // „ÄêSlackÈÄöÁü•„ÄëÂØæË±°„É¶„Éº„Ç∂„Éº„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØËá™ÂãïÁöÑ„Å´SlackÈÄöÁü•„ÇíÈÄÅ‰ø°
            if (options.targetUser || options.targetEmail) {
                console.log(`üîî [SLACK-AUTO] SlackÈÄöÁü•Ëá™ÂãïÂÆüË°å: ${title}`);
                console.log(`üîî [SLACK-AUTO] ÂØæË±°„É¶„Éº„Ç∂„Éº: ${options.targetUser}, ÂØæË±°„É°„Éº„É´: ${options.targetEmail}`);
                
                // 'all'„ÅÆÂ†¥Âêà„ÅØÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰ΩøÁî®„Åó„Å¶ÈÄöÁü•ÈÄÅ‰ø°
                if (options.targetUser === 'all') {
                    const currentUser = getCurrentUser();
                    const senderEmail = currentUser?.email || 'muranaka-tenma@terracom.co.jp';
                    console.log(`üîî [SLACK-AUTO] ÂÖ®‰ΩìÈÄöÁü• - ÈÄÅ‰ø°ËÄÖ„É°„Éº„É´„Çí‰ΩøÁî®: ${senderEmail}`);
                    await sendSlackNotification(senderEmail, title, body, options);
                    return;
                }
                
                // 'multiple'„ÅÆÂ†¥Âêà„ÅØË§áÊï∞„É¶„Éº„Ç∂„Éº„Å´Áµ±ÂêàÈÄöÁü•„ÇíÈÄÅ‰ø°
                if (options.targetUser === 'multiple' && options.mentionUsers && Array.isArray(options.mentionUsers)) {
                    console.log(`üîî [SLACK-AUTO] Ë§áÊï∞„É¶„Éº„Ç∂„ÉºÁµ±ÂêàÈÄöÁü•ÈñãÂßã: ${options.mentionUsers.join(', ')}`);
                    
                    // üîß „Çø„Çπ„ÇØÁßªÂãïÈÄöÁü•„ÅÆÂ†¥Âêà„ÅØÁèæÂú®„É¶„Éº„Ç∂„Éº„ÇÇÂê´„ÇÅ„Çã
                    const isTaskMoveNotification = options.type === 'task_move';
                    const currentUser = getCurrentUser();
                    
                    // üîß ÂÖ®„Å¶„ÅÆÈÄöÁü•„ÅßËá™ÂàÜ„ÇÇÂê´„ÇÅ„ÇãÔºàSlackÈÄöÁü•„ÅÆ„Åü„ÇÅÔºâ
                    const filteredMentionUsers = options.mentionUsers.filter(user => {
                        const isValidUser = user && user.trim() !== '';
                        console.log(`üîç [MENTION-FILTER] ${user}: ÊúâÂäπ„Å™„É¶„Éº„Ç∂„Éº = ${isValidUser} (Ëá™ÂàÜ„ÇÇÈÄöÁü•ÂØæË±°„Å´Âê´„ÇÅ„Çã)`);
                        return isValidUser;
                    });
                    
                    if (filteredMentionUsers.length === 0) {
                        console.log(`‚ùå [SLACK-AUTO] ÈÄöÁü•ÂØæË±°ËÄÖ„Å™„Åó - ÈÄöÁü•„Çπ„Ç≠„ÉÉ„Éó`);
                        return;
                    }
                    
                    console.log(`üîî [SLACK-AUTO] ÈÄöÁü•ÂØæË±°ÔºàËá™ÂàÜÂê´„ÇÄÔºâ: ${filteredMentionUsers.join(', ')}`);
                    console.log(`üîî [SLACK-AUTO] ÈÄöÁü•„Çø„Ç§„Éó: ${options.type}`);
                    
                    // Ë§áÊï∞„É°„É≥„Ç∑„Éß„É≥ÂΩ¢Âºè„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàêÔºàÊ≠£„Åó„ÅÑSlack„É°„É≥„Ç∑„Éß„É≥‰ΩøÁî®Ôºâ
                    const mentionText = filteredMentionUsers.map(user => {
                        const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(user) : `@${user}`;
                        return slackUsername;
                    }).join(' ');
                    
                    // üîß „É°„É≥„Ç∑„Éß„É≥ÈáçË§á„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅbody„Åã„Çâ„É°„É≥„Ç∑„Éß„É≥ÊñáÂ≠óÂàó„ÇíÈô§Âéª„Åó„Å¶Áµ±Âêà
                    let cleanedBody = body;
                    // bodyÂÜÖ„ÅÆÊó¢Â≠ò„É°„É≥„Ç∑„Éß„É≥Ôºà@„É¶„Éº„Ç∂„ÉºÂêçÂΩ¢ÂºèÔºâ„ÇíÈô§Âéª
                    filteredMentionUsers.forEach(user => {
                        const patterns = [
                            new RegExp(`@${user.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*`, 'g'),
                            new RegExp(`@${user.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}$`, 'g')
                        ];
                        patterns.forEach(pattern => {
                            cleanedBody = cleanedBody.replace(pattern, '');
                        });
                    });
                    
                    // ÂÖàÈ†≠„Å®Êú´Â∞æ„ÅÆ‰ΩôÂàÜ„Å™„Çπ„Éö„Éº„Çπ„ÇíÂâäÈô§
                    cleanedBody = cleanedBody.trim().replace(/^\s+/, '');
                    
                    const integratedBody = `${mentionText}\n${cleanedBody}`;
                    
                    console.log(`üîß [MENTION-FIX] ÂÖÉ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏: "${body}"`);
                    console.log(`üîß [MENTION-FIX] „ÇØ„É™„Éº„É≥Âæå: "${cleanedBody}"`);
                    console.log(`üîß [MENTION-FIX] Áµ±Âêà„É°„ÉÉ„Çª„Éº„Ç∏: "${integratedBody}"`);
                    
                    // ‰ª£Ë°®„Åó„Å¶ÊúÄÂàù„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰ΩøÁî®„Åó„Å¶SlackÈÄÅ‰ø°
                    const representativeEmail = getEmailByUserName(filteredMentionUsers[0]);
                    
                    if (representativeEmail) {
                        console.log(`üîî [SLACK-AUTO] Áµ±ÂêàÈÄöÁü•ÈÄÅ‰ø°: ${representativeEmail} (‰ª£Ë°®)`);
                        await sendSlackNotification(representativeEmail, title, integratedBody, {
                            ...options,
                            targetUser: filteredMentionUsers[0],
                            targetEmail: representativeEmail,
                            isIntegratedNotification: true,
                            allTargetUsers: filteredMentionUsers
                        });
                    } else {
                        console.error(`‚ùå [SLACK-AUTO] ‰ª£Ë°®„É¶„Éº„Ç∂„Éº„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì: ${filteredMentionUsers[0]}`);
                    }
                    return;
                }
                
                const targetEmail = options.targetEmail || getEmailByUserName(options.targetUser);
                console.log(`üîî [SLACK-AUTO] ÂèñÂæó„Åó„Åü„É°„Éº„É´: ${targetEmail}`);
                
                if (targetEmail) {
                    await sendSlackNotification(targetEmail, title, body, options);
                } else {
                    console.error(`‚ùå [SLACK-AUTO] „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì: ${options.targetUser}`);
                }
            } else {
                console.log(`‚ö†Ô∏è [SLACK-AUTO] ÂØæË±°„É¶„Éº„Ç∂„Éº„Éª„É°„Éº„É´Êú™ÊåáÂÆö„ÅÆ„Åü„ÇÅÈÄöÁü•„Çπ„Ç≠„ÉÉ„Éó`);
            }
            
            return;
        }
        
        function checkDeadlines() {
            const now = new Date();
            
            // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.isLoggedIn) {
                console.log('‚ö†Ô∏è [DEADLINE] „É¶„Éº„Ç∂„ÉºÊú™„É≠„Ç∞„Ç§„É≥ - ÈÄöÁü•„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }
            
            tasks.forEach(task => {
                if (isDoneColumn(task.columnId) || isTrashColumn(task.columnId)) return; // ÂÆå‰∫ÜÊ∏à„Åø„Éª„Ç¢„Éº„Ç´„Ç§„Éñ„ÅØÈô§Â§ñ
                
                // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ: ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåÊãÖÂΩìËÄÖ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÁü•„Åó„Å™„ÅÑ
                if (task.assignees && task.assignees.length > 0) {
                    const isAssignedToCurrentUser = task.assignees.includes(currentUser.name) || 
                                                  task.assignees.includes(currentUser.email) ||
                                                  task.assignees.includes(currentUser.id);
                    if (!isAssignedToCurrentUser) {
                        console.log(`üîá [DEADLINE] „Çø„Çπ„ÇØ„Äå${task.title}„Äç- ÊãÖÂΩìËÄÖ„Åß„ÅØ„Å™„ÅÑ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó (ÊãÖÂΩìËÄÖ: ${task.assignees.join(', ')}, ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº: ${currentUser.name})`);
                        return;
                    }
                }
                
                const deadline = new Date(task.deadline);
                
                // üîß ÊúüÈôêÂàá„ÇåÈÄöÁü•„ÇíÂÆüÈöõ„ÅÆÊúüÈôêÂàá„ÇåÊôÇ„ÅÆ„Åø„Å´ÈôêÂÆöÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÔºâ
                // Êó¢„Å´ÊúüÈôê„ÅåÂàá„Çå„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅÆÂàùÂõûÈÄöÁü•„ÅØÁÑ°ÂäπÂåñ
                if (deadline < now && !task.overdueNotified) {
                    // üö´ ÂàùÊúüÂåñÊôÇ„ÇÑ„Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Êó¢„Å´ÊúüÈôêÂàá„Çå„ÅÆ„Çø„Çπ„ÇØ„ÅØÈÄöÁü•„Åó„Å™„ÅÑ
                    // „Çø„Çπ„ÇØ„Åå‰ΩúÊàê„Åï„Çå„ÅüÊôÇÂàª„Å®ÊúüÈôêÂàá„ÇåÊôÇÂàª„ÅÆÂ∑Æ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const taskCreatedAt = task.createdAt ? new Date(task.createdAt) : now;
                    const wasOverdueAtCreation = deadline < taskCreatedAt;
                    
                    if (wasOverdueAtCreation) {
                        console.log(`üîá [DEADLINE] „Çø„Çπ„ÇØ„Äå${task.title}„Äç- ‰ΩúÊàêÊôÇÁÇπ„ÅßÊó¢„Å´ÊúüÈôêÂàá„Çå„ÅÆ„Åü„ÇÅÈÄöÁü•„Çπ„Ç≠„ÉÉ„Éó`);
                        task.overdueNotified = true; // „Éï„É©„Ç∞„ÅØË®≠ÂÆö„Åó„Å¶ÈáçË§áÈò≤Ê≠¢
                        return;
                    }
                    
                    // üîß ÊúÄËøë1ÂàÜ‰ª•ÂÜÖ„Å´ÊúüÈôêÂàá„Çå„Å´„Å™„Å£„Åü„Çø„Çπ„ÇØ„ÅÆ„ÅøÈÄöÁü•
                    const oneMinuteAgo = new Date(now.getTime() - 60 * 1000);
                    if (deadline > oneMinuteAgo) {
                        console.log(`üîî [DEADLINE] ÊúüÈôêÂàá„ÇåÈÄöÁü•ÈÄÅ‰ø°: ${task.title} (ÊãÖÂΩìËÄÖ: ${task.assignees?.join(', ') || 'Êú™Ë®≠ÂÆö'})`);
                        showNotification(
                            'üö® ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ',
                            `„Äå${task.title}„Äç„ÅÆÊúüÈôê„ÅåÈÅé„Åé„Åæ„Åó„ÅüÔºÅ`,
                            { 
                                tag: `overdue-${task.id}`, 
                                taskId: task.id,
                                targetUser: currentUser.name,
                                type: 'deadline_overdue'
                            }
                        );
                    } else {
                        console.log(`üîá [DEADLINE] „Çø„Çπ„ÇØ„Äå${task.title}„Äç- ÊúüÈôêÂàá„Çå„Åã„Çâ1ÂàÜ‰ª•‰∏äÁµåÈÅé„ÅÆ„Åü„ÇÅÈÄöÁü•„Çπ„Ç≠„ÉÉ„Éó`);
                    }
                    task.overdueNotified = true;
                }
            });
            
            // FirebaseÁµ±Âêà: ÈÄöÁü•„Éï„É©„Ç∞„ÅØFirestoreÂÜÖ„ÅßËá™Âãï‰øùÂ≠ò„Åï„Çå„Çã
        }
        
        // Ë®≠ÂÆöÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            loadAlertSettings();
            loadColumnManager();
            loadImportDefaults();
        }
        
        // „Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö„ÅÆÂàùÊúüÂåñ
        function loadImportDefaults() {
            // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            const assigneeSelect = document.getElementById('default-assignee');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
                assignees.forEach(assignee => {
                    const option = document.createElement('option');
                    option.value = assignee;
                    option.textContent = assignee;
                    assigneeSelect.appendChild(option);
                });
            }
            
            // „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            const columnSelect = document.getElementById('default-column');
            if (columnSelect) {
                columnSelect.innerHTML = '';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    columnSelect.appendChild(option);
                });
            }
            
            // „Éá„Éï„Ç©„É´„ÉàÊúüÈôê„Çí‰ªäÊó•„Å´Ë®≠ÂÆö
            document.getElementById('default-deadline').value = new Date().toISOString().split('T')[0];
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
            saveAlertSettings();
        }
        
        // „Ç´„É©„É†ÁÆ°ÁêÜÊ©üËÉΩ
        function loadColumnManager() {
            // üîí Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºödeveloperÊ®©Èôê„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈùûË°®Á§∫
            const currentUser = getCurrentUser();
            const columnManagerSection = document.querySelector('.setting-section:has(#column-manager)');

            if (currentUser.role !== 'developer') {
                if (columnManagerSection) {
                    columnManagerSection.style.display = 'none';
                }
                console.log('üîí [PERMISSION] „Ç´„É©„É†ÁÆ°ÁêÜ„ÅØdeveloperÊ®©Èôê„ÅÆ„Åø„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ');
                return;
            }

            // developerÊ®©Èôê„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË°®Á§∫
            if (columnManagerSection) {
                columnManagerSection.style.display = 'block';
            }

            const columnList = document.getElementById('column-list');
            columnList.innerHTML = columns.map((column, index) => `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                    <span style="flex: 1;">${column.title}</span>
                    <input type="color" value="${column.color}" onchange="updateColumnColor(${index}, this.value)" style="width: 40px; height: 30px; border: none; border-radius: 4px;">
                    <button onclick="editColumnName(${index})" style="padding: 0.25rem 0.5rem; background: #0097A7; color: white; border: none; border-radius: 4px; cursor: pointer;">Á∑®ÈõÜ</button>
                    ${columns.length > 2 ? `<button onclick="deleteColumn(${index})" style="padding: 0.25rem 0.5rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">ÂâäÈô§</button>` : ''}
                </div>
            `).join('');
        }
        
        function addColumn() {
            const newColumnName = document.getElementById('new-column-name').value.trim();
            if (!newColumnName) {
                alert('„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // üîí Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÄã‰∫∫Áî®„Ç´„É©„É†„ÇÇdeveloperÊ®©ÈôêÂøÖË¶ÅÔºâ
            const currentUser = getCurrentUser();
            if (selectedProjectFilters.length > 0) {
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÅÆÂ†¥ÂêàÔºöadminÊ®©ÈôêÂøÖË¶Å
                if (currentUser.role !== 'admin') {
                    alert('‚ö†Ô∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç´„É©„É†Á∑®ÈõÜ„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô');
                    return;
                }
            } else {
                // ÂÄã‰∫∫Áî®„Ç´„É©„É†„ÅÆÂ†¥ÂêàÔºödeveloperÊ®©ÈôêÂøÖË¶Å
                if (currentUser.role !== 'developer') {
                    alert('‚ö†Ô∏è ÂÄã‰∫∫Áî®„Ç´„É©„É†„ÅÆÁ∑®ÈõÜ„ÅØdeveloperÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }
            }

            const newColumn = {
                id: 'custom_' + Date.now(),
                title: newColumnName,
                color: '#0097A7'
            };

            columns.push(newColumn);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            saveColumnsToFirestore(); // 2025-12-16Âæ©Êóß: FirestoreÂêåÊúü
            document.getElementById('new-column-name').value = '';
            loadColumnManager();
            renderBoard();
        }

        function editColumnName(index) {
            // üîí Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºàdeveloperÊ®©ÈôêÂøÖË¶ÅÔºâ
            const currentUser = getCurrentUser();
            if (currentUser.role !== 'developer') {
                alert('‚ö†Ô∏è ÂÄã‰∫∫Áî®„Ç´„É©„É†„ÅÆÁ∑®ÈõÜ„ÅØdeveloperÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }

            const newName = prompt('Êñ∞„Åó„ÅÑ„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', columns[index].title);
            if (newName && newName.trim()) {
                columns[index].title = newName.trim();
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                saveColumnsToFirestore(); // 2025-12-16Âæ©Êóß: FirestoreÂêåÊúü
                loadColumnManager();
                renderBoard();
            }
        }

        function updateColumnColor(index, color) {
            // üîí Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºàdeveloperÊ®©ÈôêÂøÖË¶ÅÔºâ
            const currentUser = getCurrentUser();
            if (currentUser.role !== 'developer') {
                alert('‚ö†Ô∏è ÂÄã‰∫∫Áî®„Ç´„É©„É†„ÅÆÁ∑®ÈõÜ„ÅØdeveloperÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }

            columns[index].color = color;
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            saveColumnsToFirestore(); // 2025-12-16Âæ©Êóß: FirestoreÂêåÊúü
            render(); // Âç≥Â∫ß„Å´ÂèçÊò†
        }

        function deleteColumn(index) {
            if (columns.length <= 2) {
                alert('ÊúÄ‰Ωé2„Å§„ÅÆ„Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }

            // üîí Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÄã‰∫∫Áî®„Ç´„É©„É†„ÇÇdeveloperÊ®©ÈôêÂøÖË¶ÅÔºâ
            const currentUser = getCurrentUser();
            if (selectedProjectFilters.length > 0) {
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÅÆÂ†¥ÂêàÔºöadminÊ®©ÈôêÂøÖË¶Å
                if (currentUser.role !== 'admin') {
                    alert('‚ö†Ô∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç´„É©„É†ÂâäÈô§„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô');
                    return;
                }
            } else {
                // ÂÄã‰∫∫Áî®„Ç´„É©„É†„ÅÆÂ†¥ÂêàÔºödeveloperÊ®©ÈôêÂøÖË¶Å
                if (currentUser.role !== 'developer') {
                    alert('‚ö†Ô∏è ÂÄã‰∫∫Áî®„Ç´„É©„É†„ÅÆÂâäÈô§„ÅØdeveloperÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }
            }

            const columnToDelete = columns[index];

            // üîí ÂÆå‰∫Ü„Ç´„É©„É†ÔºàdoneÔºâ„ÅØÂâäÈô§‰∏çÂèØ
            if (columnToDelete.id === 'done') {
                alert('‚ö†Ô∏è ÂÆå‰∫Ü„Ç´„É©„É†„ÅØ„Ç∑„Çπ„ÉÜ„É†„Åß‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            const tasksInColumn = tasks.filter(task => task.columnId === columnToDelete.id);
            
            if (tasksInColumn.length > 0) {
                const moveToColumn = prompt(`„Åì„ÅÆ„Ç´„É©„É†„Å´„ÅØ${tasksInColumn.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÁßªÂãïÂÖà„ÅÆ„Ç´„É©„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (${columns.filter((_, i) => i !== index).map(c => c.id).join(', ')}):`);
                if (!moveToColumn) return;
                
                // „Çø„Çπ„ÇØ„ÇíÁßªÂãï
                tasksInColumn.forEach(task => {
                    task.columnId = moveToColumn;
                });
            }
            
            columns.splice(index, 1);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            saveColumnsToFirestore(); // 2025-12-16Âæ©Êóß: FirestoreÂêåÊúü
            saveTasks();
            loadColumnManager();
            render();
        }

        // „Ç´„É©„É†ËøΩÂä†„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateColumnAddButtonState() {
            const btn = document.getElementById('quick-add-column-btn');
            if (!btn) return;

            const currentUser = getCurrentUser();

            if (selectedProjectFilters.length > 0) {
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÊôÇ
                if (currentUser.role === 'admin') {
                    btn.disabled = false;
                    btn.title = 'ÁÆ°ÁêÜËÄÖÊ®©Èôê„Åß„Ç´„É©„É†„ÇíËøΩÂä†';
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = false; // „ÇØ„É™„ÉÉ„ÇØ„ÅØÂèØËÉΩÔºàË≠¶Âëä„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅÔºâ
                    btn.title = '‚ö†Ô∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç´„É©„É†ËøΩÂä†„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô';
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            } else {
                // ÂÄã‰∫∫„Çø„Çπ„ÇØ„Éì„É•„Éº
                btn.disabled = false;
                btn.title = 'ÂÄã‰∫∫Áî®„Ç´„É©„É†„ÇíËøΩÂä†';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        }

        // „Ç§„É≥„É©„Ç§„É≥ „Ç´„É©„É†ÁÆ°ÁêÜÊ©üËÉΩ
        async function quickAddColumn() {
            const newColumnName = document.getElementById('quick-column-name').value.trim();
            if (!newColumnName) {
                alert('„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË°®Á§∫‰∏≠„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (selectedProjectFilters.length > 0) {
                // üîí „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÊôÇ„ÅÆÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ
                const currentUser = getCurrentUser();
                if (currentUser.role !== 'admin') {
                    alert('‚ö†Ô∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç´„É©„É†ËøΩÂä†„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô\n\nÂÄã‰∫∫„Çø„Çπ„ÇØ„Éì„É•„ÉºÔºà„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊú™ÈÅ∏ÊäûÔºâ„Åß„ÅØËá™Áî±„Å´„Ç´„É©„É†„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ');
                    return;
                }
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„Å´ËøΩÂä†
                const projectId = selectedProjectFilters[0];

                // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
                if (!cachedProjectsData || !cachedProjectsData[projectId]) {
                    console.error('‚ùå [COLUMN-ADD] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', projectId);
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    return;
                }

                const project = cachedProjectsData[projectId];
                const projectColumns = project.columns || [];

                // Êñ∞„Åó„ÅÑ„Ç´„É©„É†„ÇíËøΩÂä†
                projectColumns.push(newColumnName);

                // Firebase„Å´‰øùÂ≠ò
                if (window.FirebaseDB && window.FirebaseDB.saveProject) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success && result.projects) {
                        const fullProject = result.projects.find(p => p.id === projectId);
                        if (fullProject) {
                            fullProject.columns = projectColumns;
                            const saveResult = await window.FirebaseDB.saveProject(fullProject);

                            if (saveResult.success) {
                                console.log('‚úÖ [COLUMN-ADD] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†ËøΩÂä†ÊàêÂäü:', projectId);
                                // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                                await updateProjectsCache();
                                document.getElementById('quick-column-name').value = '';
                                render();
                            } else {
                                console.error('‚ùå [COLUMN-ADD] „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰øùÂ≠òÂ§±Êïó:', saveResult.error);
                                alert('„Ç´„É©„É†„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + saveResult.error);
                            }
                        }
                    }
                } else {
                    console.error('‚ùå [COLUMN-ADD] FirebaseÊú™Êé•Á∂ö');
                    alert('FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„ÄÅ„Ç´„É©„É†„ÇíËøΩÂä†„Åß„Åç„Åæ„Åõ„Çì');
                }
            } else {
                // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„Å´ËøΩÂä†
                const newColumn = {
                    id: 'custom_' + Date.now(),
                    title: newColumnName,
                    color: '#0097A7'
                };

                columns.push(newColumn);
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                document.getElementById('quick-column-name').value = '';
                render();
            }
        }
        
        async function editColumnNameInline(columnId) {
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË°®Á§∫‰∏≠„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (selectedProjectFilters.length > 0) {
                // üîí „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÊôÇ„ÅÆÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ
                const currentUser = getCurrentUser();
                if (currentUser.role !== 'admin') {
                    alert('‚ö†Ô∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç´„É©„É†Á∑®ÈõÜ„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô');
                    return;
                }

                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÅÆÁ∑®ÈõÜ
                const projectId = selectedProjectFilters[0];

                // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
                if (!cachedProjectsData || !cachedProjectsData[projectId]) {
                    console.error('‚ùå [COLUMN-EDIT] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', projectId);
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    return;
                }

                const project = cachedProjectsData[projectId];
                const projectColumns = project.columns || [];

                // „Ç´„É©„É†ID„Åã„Çâ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊäΩÂá∫ (pj_ProjectName_0 ‚Üí 0)
                const columnIndex = parseInt(columnId.split('_')[2]);

                if (columnIndex >= 0 && columnIndex < projectColumns.length) {
                    const currentName = projectColumns[columnIndex];
                    const newName = prompt('Êñ∞„Åó„ÅÑ„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', currentName);

                    if (newName && newName.trim()) {
                        // „Ç´„É©„É†Âêç„ÇíÊõ¥Êñ∞
                        projectColumns[columnIndex] = newName.trim();

                        // Firebase„Å´‰øùÂ≠ò
                        if (window.FirebaseDB && window.FirebaseDB.saveProject) {
                            const result = await window.FirebaseDB.getProjects();
                            if (result.success && result.projects) {
                                const fullProject = result.projects.find(p => p.id === projectId);
                                if (fullProject) {
                                    fullProject.columns = projectColumns;
                                    const saveResult = await window.FirebaseDB.saveProject(fullProject);

                                    if (saveResult.success) {
                                        console.log('‚úÖ [COLUMN-EDIT] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†Êõ¥Êñ∞ÊàêÂäü:', projectId);
                                        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                                        await updateProjectsCache();
                                        render();
                                    } else {
                                        console.error('‚ùå [COLUMN-EDIT] „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰øùÂ≠òÂ§±Êïó:', saveResult.error);
                                        alert('„Ç´„É©„É†„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + saveResult.error);
                                    }
                                }
                            }
                        } else {
                            console.error('‚ùå [COLUMN-EDIT] FirebaseÊú™Êé•Á∂ö');
                            alert('FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„ÄÅ„Ç´„É©„É†„Çí‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì');
                        }
                    }
                } else {
                    console.error('‚ùå [COLUMN-EDIT] ÁÑ°Âäπ„Å™„Ç´„É©„É†„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ:', columnIndex);
                }
            } else {
                // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„ÅÆÁ∑®ÈõÜ
                const column = columns.find(c => c.id === columnId);
                if (!column) return;

                const newName = prompt('Êñ∞„Åó„ÅÑ„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', column.title);
                if (newName && newName.trim()) {
                    column.title = newName.trim();
                    localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                    saveColumnsToFirestore(); // 2025-12-16Âæ©Êóß: FirestoreÂêåÊúü
                    render();
                }
            }
        }


        async function deleteColumnInline(columnId) {
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË°®Á§∫‰∏≠„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (selectedProjectFilters.length > 0) {
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„ÅÆÂâäÈô§
                const projectId = selectedProjectFilters[0];

                // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
                if (!cachedProjectsData || !cachedProjectsData[projectId]) {
                    console.error('‚ùå [COLUMN-DELETE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', projectId);
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    return;
                }

                const project = cachedProjectsData[projectId];
                const projectColumns = project.columns || [];

                if (projectColumns.length <= 2) {
                    alert('ÊúÄ‰Ωé2„Å§„ÅÆ„Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }

                // „Ç´„É©„É†ID„Åã„Çâ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊäΩÂá∫
                const columnIndex = parseInt(columnId.split('_')[2]);

                if (columnIndex >= 0 && columnIndex < projectColumns.length) {
                    const columnName = projectColumns[columnIndex];

                    // „Åì„ÅÆ„Ç´„É©„É†„Å´„ÅÇ„Çã„Çø„Çπ„ÇØ„ÇíÁ¢∫Ë™ç
                    const tasksInColumn = tasks.filter(task =>
                        task.projectId === projectId && task.columnId === columnId
                    );

                    // „Çø„Çπ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁßªÂãïÂÖà„ÇíÈÅ∏Êäû
                    if (tasksInColumn.length > 0) {
                        const availableColumns = projectColumns
                            .map((name, idx) => ({ idx, name, id: `pj_${projectId}_${idx}` }))
                            .filter((c) => c.idx !== columnIndex);

                        const moveToColumn = prompt(
                            `„Åì„ÅÆ„Ç´„É©„É†„Å´„ÅØ${tasksInColumn.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÁßªÂãïÂÖà„ÅÆ„Ç´„É©„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n\n${availableColumns.map((c, i) => `${i+1}. ${c.name}`).join('\n')}\n\nÁßªÂãïÂÖà„ÅÆÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:`
                        );

                        if (!moveToColumn) return;

                        const selectedIndex = parseInt(moveToColumn) - 1;
                        if (selectedIndex >= 0 && selectedIndex < availableColumns.length) {
                            const targetColumnId = availableColumns[selectedIndex].id;

                            // „Çø„Çπ„ÇØ„ÇíÁßªÂãïÔºàFirebase„Å´‰øùÂ≠òÔºâ
                            for (const task of tasksInColumn) {
                                task.columnId = targetColumnId;
                                if (window.FirebaseDB && task.id) {
                                    await window.FirebaseDB.updateTask(task.id, { columnId: targetColumnId });
                                }
                            }
                        } else {
                            alert('ÁÑ°Âäπ„Å™ÈÅ∏Êäû„Åß„Åô');
                            return;
                        }
                    }

                    if (confirm(`„Ç´„É©„É†„Äå${columnName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                        // „Ç´„É©„É†„ÇíÂâäÈô§
                        projectColumns.splice(columnIndex, 1);

                        // Firebase„Å´‰øùÂ≠ò
                        if (window.FirebaseDB && window.FirebaseDB.saveProject) {
                            const result = await window.FirebaseDB.getProjects();
                            if (result.success && result.projects) {
                                const fullProject = result.projects.find(p => p.id === projectId);
                                if (fullProject) {
                                    fullProject.columns = projectColumns;
                                    const saveResult = await window.FirebaseDB.saveProject(fullProject);

                                    if (saveResult.success) {
                                        console.log('‚úÖ [COLUMN-DELETE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†ÂâäÈô§ÊàêÂäü:', projectId);
                                        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                                        await updateProjectsCache();
                                        render();
                                    } else {
                                        console.error('‚ùå [COLUMN-DELETE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰øùÂ≠òÂ§±Êïó:', saveResult.error);
                                        alert('„Ç´„É©„É†„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + saveResult.error);
                                    }
                                }
                            }
                        } else {
                            console.error('‚ùå [COLUMN-DELETE] FirebaseÊú™Êé•Á∂ö');
                            alert('FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„ÄÅ„Ç´„É©„É†„ÇíÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì');
                        }
                    }
                } else {
                    console.error('‚ùå [COLUMN-DELETE] ÁÑ°Âäπ„Å™„Ç´„É©„É†„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ:', columnIndex);
                }
            } else {
                // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„ÅÆÂâäÈô§
                if (columns.length <= 2) {
                    alert('ÊúÄ‰Ωé2„Å§„ÅÆ„Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }

                const columnIndex = columns.findIndex(c => c.id === columnId);
                const columnToDelete = columns[columnIndex];
                const tasksInColumn = tasks.filter(task => task.columnId === columnId);

                if (tasksInColumn.length > 0) {
                    const availableColumns = columns.filter(c => c.id !== columnId);
                    const moveToColumn = prompt(`„Åì„ÅÆ„Ç´„É©„É†„Å´„ÅØ${tasksInColumn.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÁßªÂãïÂÖà„ÅÆ„Ç´„É©„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n\n${availableColumns.map((c, i) => `${i+1}. ${c.title} (${c.id})`).join('\n')}\n\nÁßªÂãïÂÖà„ÅÆÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:`);

                    if (!moveToColumn) return;

                    const selectedIndex = parseInt(moveToColumn) - 1;
                    if (selectedIndex >= 0 && selectedIndex < availableColumns.length) {
                        // „Çø„Çπ„ÇØ„ÇíÁßªÂãï
                        tasksInColumn.forEach(task => {
                            task.columnId = availableColumns[selectedIndex].id;
                        });
                    } else {
                        alert('ÁÑ°Âäπ„Å™ÈÅ∏Êäû„Åß„Åô');
                        return;
                    }
                }

                if (confirm(`„Ç´„É©„É†„Äå${columnToDelete.title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    columns.splice(columnIndex, 1);
                    localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                    saveColumnsToFirestore(); // 2025-12-16Âæ©Êóß: FirestoreÂêåÊúü
                    saveTasks();
                    render();
                }
            }
        }

        function loadAlertSettings() {
            const settings = JSON.parse(localStorage.getItem('alertSettings') || '{"3hours": true, "1day": false, "overdue": true}');
            document.getElementById('alert-3hours').checked = settings['3hours'];
            document.getElementById('alert-1day').checked = settings['1day'];
            document.getElementById('alert-overdue').checked = settings.overdue;
        }
        
        function saveAlertSettings() {
            const settings = {
                '3hours': document.getElementById('alert-3hours').checked,
                '1day': document.getElementById('alert-1day').checked,
                'overdue': document.getElementById('alert-overdue').checked
            };
            localStorage.setItem('alertSettings', JSON.stringify(settings));
        }
        
        // ÁÆ°ÁêÜËÄÖÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„Åø„Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„ÉûÂà©Áî®ÂèØËÉΩÔºâ
        function isAdmin() {
            // üî• FirebaseË™çË®º„Éô„Éº„Çπ„ÅÆÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºàLocalStorageÊîπ„Åñ„ÇìÈò≤Ê≠¢Ôºâ
            const currentUser = getCurrentUser();
            return currentUser.isLoggedIn &&
                   (currentUser.role === 'admin' || currentUser.role === 'developer');
        }
        
        function setTheme(themeName, color, secondaryColor, darkColor, lightColor) {
            // „Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„Éû„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„Åø
            if (themeName === 'black' && !isAdmin()) {
                alert('„Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„Éû„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂà©Áî®ÂèØËÉΩ„Åß„Åô');
                return;
            }
            
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-color-secondary', secondaryColor);
            document.documentElement.style.setProperty('--theme-color-dark', darkColor);
            document.documentElement.style.setProperty('--theme-color-light', lightColor);
            
            // „Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„Éû„ÅÆÂ†¥Âêà„ÄÅËøΩÂä†„ÅÆ„Çπ„Çø„Ç§„É´Â§âÊõ¥
            if (themeName === 'black') {
                document.documentElement.style.setProperty('--body-bg', '#0d1117');
                document.documentElement.style.setProperty('--text-color', '#c9d1d9');
                document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #161b22 0%, #0d1117 100%)');
                document.documentElement.style.setProperty('--border-color', '#30363d');
                document.body.classList.add('dark-theme');
            } else {
                document.documentElement.style.setProperty('--body-bg', '#f4f5f7');
                document.documentElement.style.setProperty('--text-color', '#172b4d');
                document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)');
                document.documentElement.style.setProperty('--border-color', '#dfe1e6');
                document.body.classList.remove('dark-theme');
            }
            
            localStorage.setItem('selectedTheme', themeName);
            localStorage.setItem('themeColors', JSON.stringify({
                primary: color,
                secondary: secondaryColor,
                dark: darkColor,
                light: lightColor,
                themeName: themeName
            }));
            
            closeSettingsModal();
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            const savedColors = localStorage.getItem('themeColors');
            
            if (savedTheme && savedColors) {
                const colors = JSON.parse(savedColors);
                document.documentElement.style.setProperty('--theme-color', colors.primary);
                document.documentElement.style.setProperty('--theme-color-secondary', colors.secondary);
                document.documentElement.style.setProperty('--theme-color-dark', colors.dark);
                document.documentElement.style.setProperty('--theme-color-light', colors.light);
                
                // „Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„Éû„ÅÆÂ†¥Âêà„ÄÅËøΩÂä†„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
                if (colors.themeName === 'black' || savedTheme === 'black') {
                    document.documentElement.style.setProperty('--body-bg', '#0d1117');
                    document.documentElement.style.setProperty('--text-color', '#c9d1d9');
                    document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #161b22 0%, #0d1117 100%)');
                    document.documentElement.style.setProperty('--border-color', '#30363d');
                    document.body.classList.add('dark-theme');
                }
            }
        }
        
        // ÂàùÊúüÂåñ
        async function init() {
            // „ÉÜ„Éº„Éû„ÇíË™≠„ÅøËæº„Åø
            loadTheme();
            
            // ÈÄöÁü•Ë®±ÂèØ„ÇíË¶ÅÊ±Ç
            initializeSlackNotification();
            
            // FCMÂàùÊúüÂåñ
            // FCMÂâäÈô§: initializeFCM(); - SlackÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å´Áµ±‰∏Ä
            
            // „É°„É≥„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ
            setupMentionSystem();
            
            // üÜò Ëµ∑ÂãïÊôÇ„Å´ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„Å®Ëá™ÂãïÂâäÈô§
            setTimeout(async () => {
                await checkAndRemoveDuplicates();
            }, 5000); // Ëµ∑Âãï5ÁßíÂæå„Å´ÂÆüË°å
            
            // FirebaseÁµ±Âêà - Ë™çË®º„ÇíÂæÖ„Å£„Å¶„Åã„Çâ„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            try {
                console.log('üî• [INIT] FirebaseÁµ±ÂêàÊ∫ñÂÇô‰∏≠...');
                
                // FirebaseË™çË®ºÁä∂ÊÖã„ÇíÂæÖ„Å§ÔºàÊúÄÂ§ß1Áßí„Å´Áü≠Á∏ÆÔºâ
                let waitTime = 0;
                const checkInterval = 50; // „ÉÅ„Çß„ÉÉ„ÇØÈñìÈöî„ÇÇÁü≠Á∏Æ
                while (waitTime < 1000) { // 1Áßí„Å´Áü≠Á∏Æ
                    if (window.FirebaseAuth && window.FirebaseDB) {
                        console.log('‚úÖ [INIT] FirebaseÊ∫ñÂÇôÂÆå‰∫Ü (', waitTime, 'ms)');
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                    waitTime += checkInterval;
                }
                
                if (window.FirebaseAuth && window.FirebaseDB) {
                    // Firebase Auth„ÅÆ„É≠„Ç∞„Ç§„É≥„ÇíË©¶Ë°å
                    const localSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
                    if (localSession && localSession.user) {
                        
                        // „É≠„Éº„Ç´„É´„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„É¶„Éº„Ç∂„Éº„ÅßFirebase„É≠„Ç∞„Ç§„É≥
                        // „Éë„Çπ„ÉØ„Éº„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàÂÆüÈöõ„ÅÆÈÅãÁî®„Åß„ÅØÂÆâÂÖ®„Å™ÊñπÊ≥ï„ÅßÁÆ°ÁêÜÔºâ
                        const passwordMap = {
                            'muranaka-tenma@terracom.co.jp': 'Tenma7041',
                            'kato-jun@terracom.co.jp': 'aikakumei',
                            'asahi-keiichi@terracom.co.jp': 'aikakumei',
                            'hanzawa-yuka@terracom.co.jp': 'aikakumei',
                            'tamura-wataru@terracom.co.jp': 'aikakumei',
                            'hashimoto-yumi@terracom.co.jp': 'aikakumei',
                            'fukushima-ami@terracom.co.jp': 'aikakumei'
                        };
                        
                        const password = passwordMap[localSession.user.email] || 'aikakumei';
                        const signInResult = await window.FirebaseAuth.signIn(
                            localSession.user.email,
                            password
                        );
                        
                        if (signInResult.success) {
                            console.log('‚úÖ [INIT] Firebase„É≠„Ç∞„Ç§„É≥ÊàêÂäü');
                            // „Çª„ÉÉ„Ç∑„Éß„É≥ÁÆ°ÁêÜÔºàÁúÅÁï•Ôºâ
                        } else {
                            console.warn('‚ö†Ô∏è [INIT] Firebase„É≠„Ç∞„Ç§„É≥Â§±Êïó:', signInResult.error);
                            // „É≠„Ç∞„Ç§„É≥Â§±Êïó„Åó„Å¶„ÇÇ„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø„ÅØË©¶Ë°å„Åô„Çã
                        }
                    } else {
                        console.warn('‚ö†Ô∏è [INIT] „É≠„Éº„Ç´„É´„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó');
                        // „Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó„Åß„ÇÇ„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø„ÅØË©¶Ë°å„Åô„Çã
                    }
                    
                    // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Å´Èñ¢„Çè„Çâ„Åö„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø„ÇíÂÆüË°å
                    console.log('üìã [INIT] „Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÈñãÂßã...');
                    await loadTasks();

                    // üîß „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆcolumnIDÁßªË°åÂá¶ÁêÜ
                    await migrateProjectTaskColumnIds();

                    // üîß ‰øÆÊ≠£: Ë™≠„ÅøËæº„ÅøÂæå„Å´Á¢∫ÂÆü„Å´ÊèèÁîªÂÆüË°å
                    console.log('üìã [INIT] „Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', tasks.length, '‰ª∂');
                    console.log('üé® [INIT] Âç≥Â∫ß„Å´ÊèèÁîªÂÆüË°å...');
                    render();
                    updateStats();
                    
                } else {
                    console.warn('‚ö†Ô∏è [INIT] FirebaseÊú™Êé•Á∂ö - Âæå„Åß„É™„Éà„É©„Ç§');
                    // FirebaseÊú™Êé•Á∂ö„Åß„ÇÇÁ∂öË°åÔºàÂæå„Åß„É™„Éà„É©„Ç§Ôºâ
                }
            } catch (error) {
                console.error('‚ùå [INIT] FirebaseÁµ±Âêà„Ç®„É©„Éº:', error);
                // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇtasksÈÖçÂàó„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑ
            }
            
            // FirebaseÁµ±Âêà - „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            try {
                taskTemplates = await loadTemplates();
            } catch (error) {
                console.error('‚ùå [INIT] „ÉÜ„É≥„Éó„É¨„Éº„ÉàFirebaseÁµ±Âêà„Ç®„É©„Éº - LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ:', error);
                taskTemplates = JSON.parse(localStorage.getItem('taskTemplates') || '[]');
            }
            
            // ÂÆöÊúü„Çø„Çπ„ÇØ„ÅÆËá™ÂãïÁîüÊàê„ÉÅ„Çß„ÉÉ„ÇØ
            checkAndGenerateRecurringTasks();
            
            // Phase 2ÂØæÂøú: Êó¢Â≠ò„Çø„Çπ„ÇØ„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥
            tasks = tasks.map(task => {
                // PJÈñ¢ÈÄ£„Éï„Ç£„Éº„É´„Éâ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
                if (task.projectId === undefined) {
                    return {
                        ...task,
                        // PJ„Çø„Çπ„ÇØÊã°Âºµ„Éï„Ç£„Éº„É´„Éâ
                        projectId: null,           // PJ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅÆ„ÅøË®≠ÂÆö
                        projectName: null,         // PJË°®Á§∫Âêç
                        
                        // „Çπ„ÉÜ„Éº„Çø„ÇπÁÆ°ÁêÜÔºà„Éá„É•„Ç¢„É´ÁÆ°ÁêÜÔºâ
                        personalStatus: task.columnId || 'todo', // ÂÄã‰∫∫ÂÅ¥„Åß„ÅÆÈÄ≤ÊçóÁä∂ÊÖã
                        projectStatus: task.columnId || 'todo',  // PJÂÅ¥„Åß„ÅÆÊâøË™çÁä∂ÊÖã
                        
                        // ÁßªÂãïÁî≥Ë´ãÁÆ°ÁêÜ
                        pendingMove: null,
                        
                        // ÊâøË™çËÄÖË®≠ÂÆö
                        approvers: [],             // „Åì„ÅÆPJ„ÅÆÊâøË™çËÄÖ„É™„Çπ„Éà
                        lastApprovedBy: null,      // ÊúÄÂæå„Å´ÊâøË™ç„Åó„Åü‰∫∫
                        approvedAt: null,          // ÊâøË™çÊó•ÊôÇ
                        
                        // ÁßªÂãïÊôÇÂàªË®òÈå≤ÔºàË®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÁî®Ôºâ
                        lastMovedAt: null          // ÊúÄÂæå„ÅÆÁßªÂãïÊôÇÂàª
                    };
                }
                return task;
            });

            // Êó¢Â≠ò„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫ÈÖçÂàó
            if (tasks.length === 0) {
                tasks = [];
                saveTasks();
            }
            
            // ÁîªÈù¢Êõ¥Êñ∞
            if (!window.FirebaseAuth || !window.FirebaseDB) {
                render();
                updateStats();
            } else {
                updateStats();
            }
            
            // UIÊõ¥Êñ∞
            setTimeout(() => {
                updateHamburgerMenu();
                
                // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇísystemUsers„Åã„ÇâËá™ÂãïÊõ¥Êñ∞ÔºàÊúâÂäπ„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÔºâ
                const activeUsers = getActiveUsers();
                if (activeUsers.length > 0) {
                    assignees = activeUsers.map(u => u.name);
                    window.assignees = assignees;
                    // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅØFirestore„ÅßÁÆ°ÁêÜ„Åï„Çå„Çã
                    console.log(`üë• [RENDER] ÊúâÂäπ„Å™ÊãÖÂΩìËÄÖÊõ¥Êñ∞: ${assignees.join(', ')}`);
                }
                
                // ÁîªÈù¢‰∏äÈÉ®„ÅÆ„É¶„Éº„Ç∂„ÉºË°®Á§∫Êõ¥Êñ∞ÔºàÊ®©ÈôêË°®Á§∫„Å™„ÅóÔºâ
                const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (currentSession?.user) {
                    const headerTitle = document.querySelector('.header-title');
                    if (headerTitle) {
                        headerTitle.innerHTML = `
                            Kanban Work
                            <span style="font-size: 0.8rem; font-weight: normal; margin-left: 1rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">
                                ${currentSession.user.name}
                            </span>
                        `;
                    }
                }
            }, 200);
            
            // üö´ ÂàùÊúüÂåñÊôÇ„ÅÆÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁÑ°ÂäπÂåñÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÔºâ
            // checkDeadlines();
            // üîÑ ÂÆöÊúüÁöÑ„Å™ÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ„ÅØÁ∂≠ÊåÅÔºàÂÆüÈöõ„ÅÆÊúüÈôêÂàá„ÇåÊôÇ„ÅÆ„ÅøÈÄöÁü•Ôºâ
            setInterval(checkDeadlines, 1 * 60 * 1000);
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // „ÇØ„É™„ÉÉ„ÇØ„Åß„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            const filterContainer = document.getElementById('assignee-filter-container');
            const dropdown = document.getElementById('assignee-filter-dropdown');
            
            if (filterContainer && !filterContainer.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // „Éï„Ç°„Ç§„É´„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ
        function setupFileDropZone() {
            const dropZone = document.getElementById('file-drop-zone');
            const fileInput = document.getElementById('task-files-input');
            
            if (!dropZone || !fileInput) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    // FileList„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
                    const dt = new DataTransfer();
                    // Êó¢Â≠ò„ÅÆ„Éï„Ç°„Ç§„É´„ÇÇËøΩÂä†
                    Array.from(fileInput.files).forEach(file => dt.items.add(file));
                    // Êñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´„ÇíËøΩÂä†
                    files.forEach(file => dt.items.add(file));
                    
                    fileInput.files = dt.files;
                    
                    // „Éï„Ç°„Ç§„É´Êï∞„ÇíË°®Á§∫
                    dropZone.innerHTML = `üìÅ ${dt.files.length}ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`;
                    
                    }
            });
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆË°®Á§∫Êõ¥Êñ∞
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    dropZone.innerHTML = `üìÅ ${fileInput.files.length}ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`;
                } else {
                    dropZone.innerHTML = 'üìÅ „Åì„Åì„Å´„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó „Åæ„Åü„ÅØ ‰∏äË®ò„Éú„Çø„É≥„ÅßÈÅ∏Êäû';
                }
            });
        }
        
        

        // ÊãÖÂΩìËÄÖÈÅ∏Êäû„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà
        // FirebaseÂÆåÂÖ®ÁßªË°å: „Éá„Éº„Çø„ÅØFirestore„Åã„ÇâË™≠„ÅøËæº„Åæ„Çå„Çã

        document.addEventListener('DOMContentLoaded', async () => {
            // „Ç¢„Éó„É™„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ - Âè§„ÅÑ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂº∑Âà∂„ÇØ„É™„Ç¢
            const APP_VERSION = '2025-12-16-v5-columns-firestore';
            const storedVersion = localStorage.getItem('appVersion');
            if (storedVersion !== APP_VERSION) {
                console.log('üßπ [VERSION] Âè§„ÅÑ„Éê„Éº„Ç∏„Éß„É≥Ê§úÂá∫ - LocalStorageÂÆåÂÖ®„ÇØ„É™„Ç¢');
                console.log(`üßπ [VERSION] Êóß: ${storedVersion || '„Å™„Åó'} ‚Üí Êñ∞: ${APP_VERSION}`);

                // ÈáçË¶Å„Å™„Éá„Éº„Çø„Çí‰øùÊåÅ„Åô„Çã„Ç≠„Éº„ÅÆ„É™„Çπ„Éà
                const preserveKeys = ['currentSession']; // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅØ‰øùÊåÅ
                const preserved = {};
                preserveKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) preserved[key] = value;
                });

                // LocalStorageÂÆåÂÖ®„ÇØ„É™„Ç¢
                localStorage.clear();

                // ‰øùÊåÅ„Åô„Çã„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
                Object.entries(preserved).forEach(([key, value]) => {
                    localStorage.setItem(key, value);
                });

                // Êñ∞„Éê„Éº„Ç∏„Éß„É≥„ÇíË®òÈå≤
                localStorage.setItem('appVersion', APP_VERSION);
                localStorage.setItem('projectsMigratedToFirebase', 'true');
                console.log('‚úÖ [VERSION] LocalStorage„ÇØ„É™„Ç¢ÂÆå‰∫Ü - ÊúÄÊñ∞„Éê„Éº„Ç∏„Éß„É≥„Å´Êõ¥Êñ∞');
            }

            // üî• LocalStorage„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢ÔºàFirebaseÂÆåÂÖ®ÁßªË°å„ÅÆ„Åü„ÇÅÔºâ
            if (!localStorage.getItem('projectsMigratedToFirebase')) {
                console.log('üßπ [INIT] LocalStorage„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢‰∏≠...');
                localStorage.removeItem('projects');
                localStorage.removeItem('projectSettings');
                localStorage.setItem('projectsMigratedToFirebase', 'true');
                console.log('‚úÖ [INIT] LocalStorage„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
            }

            // üîß „ÄêÊúÄÂÑ™ÂÖà„Äë„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„ÇπÂàùÊúüÂåñ
            try {
                // üîç ÊúÄÂÑ™ÂÖà: LocalStorageÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†ÈñãÂßãÔºà„Éá„Éº„ÇøÂ§âÊõ¥„ÇíÂÖ®„Å¶Ë®òÈå≤Ôºâ
                setupLocalStorageMonitoring();

                // üî• FirebaseÁµ±Âêà: Firebase„Åã„Çâ„É¶„Éº„Ç∂„Éº„ÇíË™≠„ÅøËæº„Åø
                console.log('üî• [INIT] Firebase„Åã„Çâ„É¶„Éº„Ç∂„ÉºË™≠„ÅøËæº„ÅøÈñãÂßã...');
                await loadActiveUsersFromFirebase();
                console.log('‚úÖ [INIT] „É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');

                // üîß „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´activeUsers„ÇíË®≠ÂÆöÔºàSlackÈÄöÁü•„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÊ§úÁ¥¢Áî®Ôºâ
                window.activeUsers = cachedActiveUsers;
                console.log(`‚úÖ [INIT] window.activeUsersË®≠ÂÆöÂÆå‰∫Ü: ${window.activeUsers.length}‰∫∫`);

                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: localStorageÂàùÊúüÂåñÔºàFirebase„Ç®„É©„ÉºÊôÇ„ÅÆ„ÅøÂÆüË°åÔºâ
                if (!usersCacheLoaded) {
                    console.warn('‚ö†Ô∏è [INIT] FirebaseË™≠„ÅøËæº„ÅøÂ§±Êïó - localStorageÂàùÊúüÂåñÂÆüË°å');
                    initializeUserDatabase();
                    // üîß „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊôÇ„ÇÇ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíË®≠ÂÆö
                    window.activeUsers = cachedActiveUsers;
                    console.log(`‚úÖ [INIT] window.activeUsersË®≠ÂÆöÂÆå‰∫ÜÔºàfallbackÔºâ: ${window.activeUsers.length}‰∫∫`);
                }

                // Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆFirebaseÁßªË°å„ÉÅ„Çß„ÉÉ„ÇØ
                setTimeout(() => {
                    migrateProjectsToFirebase();
                }, 3000); // FirebaseË™çË®ºÂÆå‰∫ÜÂæå„Å´ÂÆüË°å
                
                // üîê „ÄêÈáçË¶Å„ÄëÊ®©ÈôêÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„Éª‰øÆÊ≠£„ÇíÂÆüË°å
                const permissionFixed = ensureUserPermissionsIntegrity();
                console.log('‚úÖ [INIT] Ê®©ÈôêÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü', permissionFixed ? '(‰øÆÊ≠£„ÅÇ„Çä)' : '(ÂïèÈ°å„Å™„Åó)');
                
                // üîç Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°åÔºàUIÂà∂Âæ°Âê´„ÇÄÔºâ
                setTimeout(() => {
                    checkUserPermission();
                    console.log('‚úÖ [INIT] Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü');

                    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆÂàùÊúüÂåñ
                    updateProjectsCache().then(() => {
                        console.log('‚úÖ [INIT] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≠„É£„ÉÉ„Ç∑„É•ÂàùÊúüÂåñÂÆå‰∫Ü');
                    });
                }, 500); // 0.5ÁßíÂæå„Å´ÂÆüË°å
                
                // ÂÆöÊúüÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã
                startPeriodicPermissionCheck();
                console.log('üîÑ [INIT] ÂÆöÊúüÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßãÔºà5ÂàÜÈñìÈöîÔºâ');
            } catch (error) {
                console.error('‚ùå [INIT] „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„ÇπÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
            
            // FirebaseÂàùÊúüÂåñÁä∂Ê≥Å„Çí„Éá„Éê„ÉÉ„Ç∞
            console.log('üöÄ [INIT-DEBUG] DOMContentLoadedÁô∫ÁÅ´:', {
                timestamp: new Date().toISOString(),
                cacheVersion: APP_VERSION,
                device: navigator.platform,
                userAgent: navigator.userAgent.substring(0, 50) + '...',
                firebaseModules: {
                    hasFirebaseAuth: !!window.FirebaseAuth,
                    hasFirebaseDB: !!window.FirebaseDB,
                    hasFirebaseApp: !!window.firebaseApp,
                    hasFirebaseAuthObject: !!window.firebaseAuth
                },
                debugFunctions: {
                    hasTestFirebaseSync: typeof window.testFirebaseSync === 'function'
                }
            });


            // FirebaseË™çË®ºÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç
            setTimeout(() => {
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                console.log('üîê [INIT-DEBUG] FirebaseË™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç:', {
                    hasCurrentUser: !!currentUser,
                    userEmail: currentUser?.email || '„Å™„Åó',
                    userUID: currentUser?.uid || '„Å™„Åó',
                    timestamp: new Date().toISOString()
                });
            }, 1000);
            
            // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÇíÂàùÊúüÂåñÔºàÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶Á¢∫ÂÆü„Å´ÂÆüË°åÔºâ
            setTimeout(() => {
                updateHamburgerMenu();
                console.log('üçî „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÊõ¥Êñ∞ÂÆå‰∫Ü');
            }, 100);

            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÂ§âÊõ¥„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupProjectSelectListener();

            // üîß ‰øÆÊ≠£: FirebaseË™çË®ºÁä∂ÊÖã„ÅÆÂæ©ÂÖÉ„ÇíÂæÖ„Å£„Å¶„Åã„ÇâÂàùÊúüÂåñ
            console.log('‚è≥ [INIT] FirebaseË™çË®ºÁä∂ÊÖã„ÅÆÂæ©ÂÖÉ„ÇíÂæÖÊ©ü‰∏≠...');
            
            // FirebaseË™çË®º„ÅÆËá™ÂãïÂæ©ÂÖÉ„ÇíÂæÖ„Å§ÔºàÊúÄÂ§ß3ÁßíÔºâ
            let authRestored = false;
            const maxWaitTime = 3000;
            const checkInterval = 100;
            let waited = 0;
            
            // onAuthStateChanged„ÅßË™çË®ºÁä∂ÊÖã„ÇíÁõ£Ë¶ñ
            const authPromise = new Promise((resolve) => {
                let unsubscribe = null;
                
                if (window.firebaseAuth?.onAuthStateChanged) {
                    unsubscribe = window.firebaseAuth.onAuthStateChanged(async (user) => {
                        if (user) {
                            console.log('[INIT] FirebaseË™çË®ºÂæ©ÂÖÉÂÆå‰∫Ü:', user.email);
                            authRestored = true;
                            if (unsubscribe) unsubscribe();

                            // 2025-12-16Âæ©Êóß: Firestore„Åã„Çâ„Ç´„É©„É†Ë®≠ÂÆö„ÇíÂàùÊúüÂåñ
                            await initColumnsFromFirestore();

                            resolve();
                        }
                    });
                } else {
                    console.log('‚ö†Ô∏è [INIT] Firebase AuthÊú™ÂàùÊúüÂåñ - Ë™çË®º„Å™„Åó„ÅßÁ∂öË°å');
                    resolve();
                }
                
                // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
                setTimeout(() => {
                    if (!authRestored) {
                        console.log('üö´ [INIT] Ë™çË®ºÂæÖÊ©ü„Çø„Ç§„É†„Ç¢„Ç¶„Éà - „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà');
                        if (unsubscribe) unsubscribe();

                        // üîí „ÄêÊúÄÈáçË¶Å„ÄëÊú™Ë™çË®ºÊôÇ„ÅØÂº∑Âà∂ÁöÑ„Å´„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                        // „Åì„Çå„Å´„Çà„ÇäÂè§„ÅÑ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇÑÊú™Ë™çË®ºÁä∂ÊÖã„Åß„ÅÆË°®Á§∫„ÇíÈò≤Ê≠¢
                        const currentPath = window.location.pathname;
                        if (currentPath.includes('index-kanban.html') || currentPath.endsWith('/') || currentPath.endsWith('/sales-task-core/')) {
                            console.log('üîÑ [INIT] „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å∏Âº∑Âà∂„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂÆüË°å');
                            window.location.href = 'login.html';
                            return;
                        }
                        resolve();
                    }
                }, maxWaitTime);
            });
            
            // Ë™çË®ºÂæ©ÂÖÉ„ÇíÂæÖ„Å§
            await authPromise;
            
            // ‰∏ªË¶ÅÂàùÊúüÂåñ„ÇíÂÆüË°å
            try {
                await init();
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆËá™ÂãïÂêåÊúüÔºàÁßªË°å„Éï„É©„Ç∞„Å´‰æùÂ≠ò„Åó„Å™„ÅÑÔºâ
                console.log('üîÑ [AUTO-SYNC] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆËá™ÂãïÂêåÊúü„ÇíÈñãÂßã');
                try {
                    // FirebaseË™çË®ºÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂÆüË°å
                    if (window.getCurrentUser()?.isLoggedIn && window.FirebaseDB?.saveProject) {
                        await migrateProjectsToFirebase();
                        console.log('‚úÖ [AUTO-SYNC] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêåÊúüÂÆå‰∫Ü');
                    } else {
                        console.log('üìÅ [AUTO-SYNC] FirebaseÊú™ÂØæÂøú„Åæ„Åü„ÅØ„É≠„Ç∞„Ç¢„Ç¶„ÉàÁä∂ÊÖã - „Çπ„Ç≠„ÉÉ„Éó');
                    }
                } catch (syncError) {
                    console.error('‚ö†Ô∏è [AUTO-SYNC] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêåÊúü„Ç®„É©„Éº:', syncError);
                }
            } catch (error) {
                console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }

            const assigneeSelect = document.getElementById('task-assignee-input');
            if (assigneeSelect) {
                assigneeSelect.addEventListener('change', function() {
                    if (this.value === '__ADD_NEW__') {
                        const newAssignee = prompt('Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                        if (newAssignee && newAssignee.trim()) {
                            const trimmedName = newAssignee.trim();
                            if (!assignees.includes(trimmedName)) {
                                assignees.push(trimmedName);
                                // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅØFirestore„ÅßÁÆ°ÁêÜ„Åï„Çå„Çã
                            }
                            // ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞„Åó„Å¶Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû
                            updateAssigneeOptions();
                            this.value = trimmedName;
                        } else {
                            this.value = '';
                        }
                    }
                });
            }
            
            // „Ç´„É©„É†ËøΩÂä†„ÅßEnter„Ç≠„ÉºÂØæÂøú
            const quickColumnInput = document.getElementById('quick-column-name');
            if (quickColumnInput) {
                quickColumnInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        quickAddColumn();
                    }
                });
            }
            
            // „Éï„Ç°„Ç§„É´„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÇíË®≠ÂÆö
            setupFileDropZone();
        });


        // GoogleTODOÂΩ¢Âºè„ÅÆ„Çø„Çπ„ÇØËß£ÊûêÔºàÊúüÈôê‰ªò„Åç„Çø„Çπ„ÇØ„ÇíÂàÜÈõ¢Ôºâ
        function parseGoogleTodoText(text) {
            // GoogleTODO„ÅÆÊúüÈôêÂΩ¢Âºè„Éë„Çø„Éº„É≥: mmÊúàddÊó•(ÊõúÊó•), hh:mm
            // ‰æã: "12Êúà15Êó•(Êúà), 14:30" „Åæ„Åü„ÅØ "12Êúà15Êó• 14:30" „Å™„Å©
            const dateTimePatterns = [
                // Âü∫Êú¨ÂΩ¢Âºè: mmÊúàddÊó•(ÊõúÊó•), hh:mm
                /(\d{1,2})Êúà(\d{1,2})Êó•\s*\([ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•]\)\s*,?\s*(\d{1,2}):(\d{2})/g,
                // ÊõúÊó•„Å™„Åó: mmÊúàddÊó•, hh:mm
                /(\d{1,2})Êúà(\d{1,2})Êó•\s*,?\s*(\d{1,2}):(\d{2})/g,
                // ÊôÇÂàª„Å™„Åó: mmÊúàddÊó•(ÊõúÊó•)
                /(\d{1,2})Êúà(\d{1,2})Êó•\s*\([ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•]\)/g,
                // ÊôÇÂàª„Å™„ÅóÊõúÊó•„Å™„Åó: mmÊúàddÊó•
                /(\d{1,2})Êúà(\d{1,2})Êó•/g,
                // Ë•øÊö¶‰ªò„Åç: yyyyÂπ¥mmÊúàddÊó•
                /(\d{4})Âπ¥(\d{1,2})Êúà(\d{1,2})Êó•/g
            ];
            
            const results = [];
            const lines = text.split('\n');
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                let taskTitle = trimmedLine;
                let deadline = null;
                let foundDate = false;
                
                // ÂêÑ„Éë„Çø„Éº„É≥„Åß„Éû„ÉÉ„ÉÅ„ÇíË©¶Ë°å
                for (const pattern of dateTimePatterns) {
                    const matches = [...trimmedLine.matchAll(pattern)];
                    if (matches.length > 0) {
                        const match = matches[0];
                        foundDate = true;
                        
                        // ÊúüÈôêÊÉÖÂ†±„ÇíÊäΩÂá∫
                        if (pattern.source.includes('Âπ¥')) {
                            // yyyyÂπ¥mmÊúàddÊó•ÂΩ¢Âºè
                            const year = match[1];
                            const month = match[2].padStart(2, '0');
                            const day = match[3].padStart(2, '0');
                            deadline = `${year}-${month}-${day}`;
                        } else if (match[3] && match[4]) {
                            // ÊôÇÂàª‰ªò„Åç
                            const month = match[1].padStart(2, '0');
                            const day = match[2].padStart(2, '0');
                            const hour = match[3].padStart(2, '0');
                            const minute = match[4].padStart(2, '0');
                            const currentYear = new Date().getFullYear();
                            deadline = `${currentYear}-${month}-${day}T${hour}:${minute}`;
                        } else {
                            // Êó•‰ªò„ÅÆ„Åø
                            const month = match[1].padStart(2, '0');
                            const day = match[2].padStart(2, '0');
                            const currentYear = new Date().getFullYear();
                            deadline = `${currentYear}-${month}-${day}`;
                        }
                        
                        // ÊúüÈôêÈÉ®ÂàÜ„Çí„Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´„Åã„ÇâÈô§Âéª
                        taskTitle = trimmedLine.replace(match[0], '').trim();
                        
                        // ÂâçÂæå„ÅÆ‰∏çË¶Å„Å™Ë®òÂè∑„ÇíÈô§Âéª
                        taskTitle = taskTitle.replace(/^[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+|[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+$/g, '');
                        
                        break;
                    }
                }
                
                // ÊúüÈôê„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅÆÁ∞°Êòì„Éë„Çø„Éº„É≥ÔºàÊï∞Â≠ó„ÅÆ„Åø„ÅÆÊôÇÂàª„Å™„Å©Ôºâ
                if (!foundDate) {
                    // ÂçòÁ¥î„Å™ÊôÇÂàª„Éë„Çø„Éº„É≥: hh:mm
                    const timeMatch = taskTitle.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                        const hour = timeMatch[1].padStart(2, '0');
                        const minute = timeMatch[2].padStart(2, '0');
                        const today = new Date();
                        deadline = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T${hour}:${minute}`;
                        taskTitle = taskTitle.replace(timeMatch[0], '').trim();
                    }
                }
                
                // Á©∫„ÅÆ„Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´„ÇíÈÅø„Åë„Çã
                if (taskTitle && taskTitle.length > 1) {
                    results.push({
                        title: taskTitle,
                        deadline: deadline,
                        hasDeadline: !!deadline,
                        originalLine: trimmedLine
                    });
                }
            });
            
            return results;
        }

        // üî• OCRÊ©üËÉΩ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„ÅüÔºà2025-12-16Ôºâ
        // OCRÈñ¢ÈÄ£„ÅÆÁ¥Ñ1,200Ë°å„ÅÆ„Ç≥„Éº„Éâ„ÇíÂâäÈô§

        // ÂàÜÊûê„Éª„É¨„Éù„Éº„ÉàÊ©üËÉΩ
        function showAnalytics() {
            const modal = document.getElementById('analyticsModal');
            modal.style.display = 'block';
            
            // „Éá„Éï„Ç©„É´„Éà„ÅØ‰ªäÈÄ±„ÅÆÁµ±Ë®à„Éá„Éº„Çø„ÇíË®àÁÆó
            calculateAnalytics('week');
            
            // „Ç∞„É©„Éï„ÇíÊèèÁîª
            drawCompletionChart();
            drawDeadlineChart();
            
            // ÊãÖÂΩìËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇíË°®Á§∫
            displayAssigneePerformance();
        }
        
        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }
        
        // ÊúüÈñìÈÅ∏Êäû„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜ
        function showAnalyticsForPeriod(period) {
            // „Åô„Åπ„Å¶„ÅÆ„Éú„Çø„É≥„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('#analyticsModal .period-btn').forEach(btn => {
                btn.style.background = '#e2e8f0';
                btn.style.color = '#333';
            });
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Éú„Çø„É≥„Å´active„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
            event.target.style.background = '#0052cc';
            event.target.style.color = 'white';
            
            // ÊúüÈñì„Å´Âøú„Åò„Å¶ÂàÜÊûê„ÇíÂÜçË®àÁÆó
            calculateAnalytics(period);
        }
        
        function calculateAnalytics(period = 'all') {
            // ÊúüÈñì„Éï„Ç£„É´„Çø„Éº
            let filteredTasks = tasks;
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            if (period === 'today') {
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfToday;
                    }
                    return false;
                });
            } else if (period === 'week') {
                const startOfWeek = new Date(startOfToday);
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfWeek;
                    }
                    return false;
                });
            } else if (period === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfMonth;
                    }
                    return false;
                });
            }
            
            // Á∑è„Çø„Çπ„ÇØÊï∞
            const totalTasks = filteredTasks.length;
            document.getElementById('total-tasks').textContent = totalTasks;
            
            // ÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞„Å®ÂÆå‰∫ÜÁéáÔºàisDoneColumnÈñ¢Êï∞„ÅßÂà§ÂÆöÔºâ
            const completedTasks = filteredTasks.filter(task => isDoneColumn(task.columnId)).length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('completion-rate').textContent = completionRate + '%';
            
            // ÊúüÈôêÈÅµÂÆàÁéá„ÇíË®àÁÆóÔºà„Éï„Ç£„É´„Çø„ÉºÊ∏à„Åø„Çø„Çπ„ÇØ„ÅÆ„ÅÜ„Å°„ÄÅÊúüÈôêÂÜÖ„Å´ÂÆå‰∫Ü„Åó„Åü„Çø„Çπ„ÇØ„ÅÆÂâ≤ÂêàÔºâ
            const completedOnTime = filteredTasks.filter(task => {
                if (isDoneColumn(task.columnId) && task.deadline && task.completedAt) {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }
                return false;
            }).length;
            
            const deadlineCompliance = totalTasks > 0 
                ? Math.round((completedOnTime / totalTasks) * 100) 
                : 100;
                
            console.log(`üìä [COMPLIANCE] Period: ${period}, Total tasks: ${totalTasks}`);
            console.log(`üìä [COMPLIANCE] Completed on time: ${completedOnTime}`);
            console.log(`üìä [COMPLIANCE] Compliance rate: ${deadlineCompliance}%`);
            
            document.getElementById('deadline-compliance').textContent = deadlineCompliance + '%';
            
            // Âπ≥ÂùáÂÆå‰∫ÜÊôÇÈñì„ÇíË®àÁÆó
            const completedWithTime = tasks.filter(task =>
                isDoneColumn(task.columnId) && task.createdAt && task.completedAt
            );
            
            if (completedWithTime.length > 0) {
                const totalTime = completedWithTime.reduce((sum, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created);
                }, 0);
                
                const avgTime = totalTime / completedWithTime.length;
                const days = Math.floor(avgTime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((avgTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                document.getElementById('avg-completion-time').textContent = 
                    days > 0 ? `${days}Êó•${hours}ÊôÇÈñì` : `${hours}ÊôÇÈñì`;
            } else {
                document.getElementById('avg-completion-time').textContent = '-';
            }
        }
        
        function drawCompletionChart() {
            const chartContainer = document.getElementById('completion-chart');
            
            // „Ç´„É©„É†Âà•„Çø„Çπ„ÇØÊï∞„ÇíÈõÜË®à
            const columnCounts = {};
            columns.forEach(column => {
                columnCounts[column.id] = tasks.filter(task => task.columnId === column.id).length;
            });
            
            // ÊúÄÂ§ßÂÄ§„ÇíÊ±Ç„ÇÅ„Çã
            const maxCount = Math.max(...Object.values(columnCounts), 1);
            
            // Ê£í„Ç∞„É©„Éï„ÇíHTML„Åß‰ΩúÊàê
            let chartHTML = '<div style="display: flex; height: 100%; align-items: flex-end; justify-content: space-around; padding: 1rem;">';
            
            columns.forEach(column => {
                const count = columnCounts[column.id];
                const percentage = (count / maxCount) * 100;
                
                chartHTML += `
                    <div style="flex: 1; text-align: center; margin: 0 0.5rem;">
                        <div style="position: relative; height: 150px; display: flex; align-items: flex-end;">
                            <div style="background: ${column.color}; width: 100%; height: ${percentage}%; border-radius: 4px 4px 0 0; position: relative;">
                                <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-weight: bold; color: #333;">
                                    ${count}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            ${column.title.replace(/[^\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\w\s]/g, '')}
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        function drawDeadlineChart() {
            const chartContainer = document.getElementById('deadline-chart');
            
            // ÊúüÈôêÁä∂Ê≥Å„ÇíÈõÜË®àÔºàDone„Ç´„É©„É†„ÉªTrash„Ç´„É©„É†„ÇíÈô§„ÅèÔºâ
            const activeTasks = tasks.filter(task => !isDoneColumn(task.columnId) && !isTrashColumn(task.columnId));
            const now = new Date();
            
            const deadlineStatus = {
                overdue: 0,
                today: 0,
                thisWeek: 0,
                later: 0,
                noDeadline: 0
            };
            
            activeTasks.forEach(task => {
                if (!task.deadline) {
                    deadlineStatus.noDeadline++;
                    return;
                }
                
                const deadline = new Date(task.deadline);
                const daysUntil = Math.floor((deadline - now) / (1000 * 60 * 60 * 24));
                
                if (deadline < now) {
                    deadlineStatus.overdue++;
                } else if (daysUntil === 0) {
                    deadlineStatus.today++;
                } else if (daysUntil <= 7) {
                    deadlineStatus.thisWeek++;
                } else {
                    deadlineStatus.later++;
                }
            });
            
            // ÂÜÜ„Ç∞„É©„ÉïÈ¢®„ÅÆË°®Á§∫„Çí‰ΩúÊàê
            const total = activeTasks.length || 1;
            const statusConfig = [
                { key: 'overdue', label: 'ÊúüÈôêÂàá„Çå', color: '#e53e3e' },
                { key: 'today', label: '‰ªäÊó•', color: '#d69e2e' },
                { key: 'thisWeek', label: '‰ªäÈÄ±', color: '#3182ce' },
                { key: 'later', label: '„Åù„Çå‰ª•Èôç', color: '#38a169' },
                { key: 'noDeadline', label: 'ÊúüÈôê„Å™„Åó', color: '#a0aec0' }
            ];
            
            let chartHTML = '<div style="display: flex; flex-direction: column; height: 100%; padding: 1rem;">';
            
            statusConfig.forEach(config => {
                const count = deadlineStatus[config.key];
                const percentage = Math.round((count / total) * 100);
                
                if (count > 0) {
                    chartHTML += `
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.9rem; color: #666;">${config.label}</span>
                                <span style="font-size: 0.9rem; font-weight: bold;">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: ${config.color}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        function displayAssigneePerformance() {
            const performanceContainer = document.getElementById('assignee-performance');
            
            // ÊãÖÂΩìËÄÖÂà•„ÅÆÁµ±Ë®à„ÇíÈõÜË®à
            const assigneeStats = {};
            
            assignees.forEach(assignee => {
                const assigneeTasks = tasks.filter(task => task.assignee === assignee);
                const completed = assigneeTasks.filter(task => isDoneColumn(task.columnId)).length;
                const total = assigneeTasks.length;

                // ÊúüÈôêÈÅµÂÆàÁéá
                const completedWithDeadline = assigneeTasks.filter(task =>
                    isDoneColumn(task.columnId) && task.deadline && task.completedAt
                );
                const onTime = completedWithDeadline.filter(task => {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }).length;
                
                assigneeStats[assignee] = {
                    total: total,
                    completed: completed,
                    completionRate: total > 0 ? Math.round((completed / total) * 100) : 0,
                    onTimeRate: completedWithDeadline.length > 0 
                        ? Math.round((onTime / completedWithDeadline.length) * 100) 
                        : 100
                };
            });
            
            // „ÉÜ„Éº„Éñ„É´ÂΩ¢Âºè„ÅßË°®Á§∫
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 0.75rem; text-align: left;">ÊãÖÂΩìËÄÖ</th>
                            <th style="padding: 0.75rem; text-align: center;">Á∑è„Çø„Çπ„ÇØ</th>
                            <th style="padding: 0.75rem; text-align: center;">ÂÆå‰∫Ü</th>
                            <th style="padding: 0.75rem; text-align: center;">ÂÆå‰∫ÜÁéá</th>
                            <th style="padding: 0.75rem; text-align: center;">ÊúüÈôêÈÅµÂÆàÁéá</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(assigneeStats).forEach(([assignee, stats]) => {
                if (stats.total > 0) {
                    tableHTML += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 0.75rem; font-weight: 500;">${assignee}</td>
                            <td style="padding: 0.75rem; text-align: center;">${stats.total}</td>
                            <td style="padding: 0.75rem; text-align: center;">${stats.completed}</td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span style="color: ${stats.completionRate >= 80 ? '#38a169' : stats.completionRate >= 50 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${stats.completionRate}%
                                </span>
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span style="color: ${stats.onTimeRate >= 90 ? '#38a169' : stats.onTimeRate >= 70 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${stats.onTimeRate}%
                                </span>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            performanceContainer.innerHTML = tableHTML;
        }
        
        // ÂàÜÊûê„Çµ„Éû„É™„ÉºÊõ¥Êñ∞
        function updateAnalyticsSummary() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => isDoneColumn(task.columnId)).length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            // ÊúüÈôêÈÅµÂÆàÁéáÔºàÂÖ®„Çø„Çπ„ÇØ„ÅÆ„ÅÜ„Å°ÊúüÈôêÂÜÖ„Å´ÂÆå‰∫Ü„Åó„Åü„Çø„Çπ„ÇØ„ÅÆÂâ≤ÂêàÔºâ
            const completedOnTime = tasks.filter(task => {
                if (isDoneColumn(task.columnId) && task.deadline && task.completedAt) {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }
                return false;
            }).length;

            const deadlineCompliance = totalTasks > 0
                ? Math.round((completedOnTime / totalTasks) * 100)
                : 100;

            // Âπ≥ÂùáÂÆå‰∫ÜÊôÇÈñì
            const completedWithTime = tasks.filter(task =>
                isDoneColumn(task.columnId) && task.createdAt && task.completedAt
            );
            let avgTimeText = '-';
            if (completedWithTime.length > 0) {
                const totalTime = completedWithTime.reduce((sum, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created);
                }, 0);
                const avgTime = totalTime / completedWithTime.length;
                const days = Math.floor(avgTime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((avgTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                avgTimeText = days > 0 ? `${days}Êó•${hours}h` : `${hours}h`;
            }
            
            // Ë°®Á§∫Êõ¥Êñ∞
            document.getElementById('summary-completion-rate').textContent = completionRate + '%';
            document.getElementById('summary-deadline-compliance').textContent = deadlineCompliance + '%';
            document.getElementById('summary-avg-time').textContent = avgTimeText;
        }
        
        // ÊúüÈñì„É¨„Éù„Éº„ÉàÊ©üËÉΩ
        function showPeriodReport(period) {
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const now = new Date();
            let startDate, endDate, periodName;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    periodName = '‰ªäÊó•';
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    startDate = weekStart;
                    endDate = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
                    periodName = '‰ªäÈÄ±';
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    periodName = '‰ªäÊúà';
                    break;
            }
            
            // ÊúüÈñìÂÜÖ„ÅÆ„Çø„Çπ„ÇØ„ÇíÊäΩÂá∫
            const periodTasks = tasks.filter(task => {
                if (!task.createdAt) return false;
                const createdDate = new Date(task.createdAt);
                return createdDate >= startDate && createdDate < endDate;
            });
            
            const completedInPeriod = periodTasks.filter(task => {
                if (!isDoneColumn(task.columnId) || !task.completedAt) return false;
                const completedDate = new Date(task.completedAt);
                return completedDate >= startDate && completedDate < endDate;
            });
            
            // ÊúüÈôêÈÅµÂÆàÔºàÊúüÈñìÂÜÖ„Å´ÂÆå‰∫Ü„Åó„Åü„Çø„Çπ„ÇØ„ÅÆ„ÅÜ„Å°Ôºâ
            const onTimeInPeriod = completedInPeriod.filter(task => {
                if (!task.deadline) return true;
                const deadline = new Date(task.deadline);
                const completed = new Date(task.completedAt);
                return completed <= deadline;
            });
            
            // „É¨„Éù„Éº„ÉàË°®Á§∫
            const modalId = 'period-report-' + Date.now();
            const reportHTML = `
                <div id="${modalId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) document.getElementById('${modalId}').remove()">
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748;">üìä ${periodName}„ÅÆ„É¨„Éù„Éº„Éà</h3>
                            <button onclick="document.getElementById('${modalId}').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #a0aec0; padding: 0.5rem; z-index: 2001; position: relative;">&times;</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${periodTasks.length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">‰ΩúÊàê„Çø„Çπ„ÇØ</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${completedInPeriod.length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); color: #2d3748; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${periodTasks.length > 0 ? Math.round((completedInPeriod.length / periodTasks.length) * 100) : 0}%</div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">ÂÆå‰∫ÜÁéá</div>
                            </div>
                        </div>
                        
                        <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #2d3748;">ÊúüÈôêÈÅµÂÆàÁä∂Ê≥Å</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ÊúüÈôêÂÜÖÂÆå‰∫Ü: ${onTimeInPeriod.length}‰ª∂</span>
                                <span>ÈÅµÂÆàÁéá: ${completedInPeriod.length > 0 ? Math.round((onTimeInPeriod.length / completedInPeriod.length) * 100) : 100}%</span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                                <div style="background: #38a169; height: 100%; width: ${completedInPeriod.length > 0 ? (onTimeInPeriod.length / completedInPeriod.length) * 100 : 100}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; color: #718096; font-size: 0.9rem;">
                            ÊúüÈñì: ${startDate.toLocaleDateString()} „Äú ${endDate.toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reportHTML);
        }
        
        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜÊ©üËÉΩ
        function showCreateTemplateModal() {
            // „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            const columnSelect = document.getElementById('template-column');
            if (columnSelect) {
                columnSelect.innerHTML = '';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    columnSelect.appendChild(option);
                });
            }
            
            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
            const assigneesContainer = document.getElementById('template-assignees');
            assigneesContainer.innerHTML = '';
            assignees.forEach(assignee => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.9rem;';
                label.innerHTML = `
                    <input type="checkbox" value="${assignee}" style="margin: 0;">
                    <span>${assignee}</span>
                `;
                assigneesContainer.appendChild(label);
            });
            
            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const templateModal = document.getElementById('templateModal');
            templateModal.style.display = 'flex';
        }
        
        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('template-name').value = '';
            document.getElementById('template-task-title').value = '';
            document.getElementById('template-memo').value = '';
            document.getElementById('template-category').value = 'Âñ∂Ê•≠';
            document.getElementById('template-priority').value = 'medium';
            
            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„É™„Çª„ÉÉ„Éà
            const checkboxes = document.querySelectorAll('#template-assignees input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('template-modal-title').textContent = 'üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê';
            document.getElementById('save-template-btn').textContent = '‰øùÂ≠ò';
            editingTemplateId = null;
        }
        
        async function saveTemplate(event) {
            event.preventDefault();

            const name = document.getElementById('template-name').value.trim();
            // „Ç´„ÉÜ„Ç¥„É™Ê©üËÉΩÂâäÈô§
            const taskTitle = document.getElementById('template-task-title').value.trim();
            const priority = document.getElementById('template-priority').value;
            const columnId = document.getElementById('template-column').value;
            const memo = document.getElementById('template-memo').value.trim();

            // ÈÅ∏Êäû„Åï„Çå„ÅüÊãÖÂΩìËÄÖ„ÇíÂèñÂæó
            const selectedAssignees = Array.from(document.querySelectorAll('#template-assignees input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            if (!name || !taskTitle) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„Å®„Çø„Çπ„ÇØÂêç„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }

            try {
                if (editingTemplateId) {
                    // Á∑®ÈõÜ„É¢„Éº„Éâ - FirebaseÁµ±Âêà
                    const templateData = {
                        name: name,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo
                    };
                    
                    // FirebaseÊõ¥Êñ∞
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('üî• [TEMPLATE] Firebase„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞‰∏≠...', name);
                        const result = await window.FirebaseDB.updateTemplate(editingTemplateId, templateData);
                        
                        if (result.success) {
                            console.log('‚úÖ [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞ÊàêÂäü:', editingTemplateId);
                            
                            // „É≠„Éº„Ç´„É´ÈÖçÂàó„ÇÇÊõ¥Êñ∞
                            const templateIndex = taskTemplates.findIndex(t => t.id === editingTemplateId);
                            if (templateIndex !== -1) {
                                taskTemplates[templateIndex] = {
                                    ...taskTemplates[templateIndex],
                                    ...templateData,
                                    updatedAt: new Date().toISOString()
                                };
                            }
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                        } else {
                            console.error('‚ùå [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', result.error);
                            alert(`„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        const templateIndex = taskTemplates.findIndex(t => t.id === editingTemplateId);
                        if (templateIndex !== -1) {
                            taskTemplates[templateIndex] = {
                                ...taskTemplates[templateIndex],
                                ...templateData,
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅÔºàLocalStorageÔºâ');
                        }
                    }
                } else {
                    // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ - FirebaseÁµ±Âêà
                    const templateData = {
                        id: Date.now(),
                        name: name,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Firebase‰ΩúÊàê
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('üî• [TEMPLATE] Firebase„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê‰∏≠...', name);
                        const result = await window.FirebaseDB.createTemplate(templateData);
                        
                        if (result.success) {
                            console.log('‚úÖ [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàêÊàêÂäü:', result.id);
                            
                            // Firebase ID„ÇíË®≠ÂÆö„Åó„Å¶„É≠„Éº„Ç´„É´ÈÖçÂàó„Å´ËøΩÂä†
                            templateData.id = result.id;
                            taskTemplates.push(templateData);
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                        } else {
                            console.error('‚ùå [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Ç®„É©„Éº:', result.error);
                            alert(`„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Ç®„É©„Éº: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        taskTemplates.push(templateData);
                        localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                        alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅÔºàLocalStorageÔºâ');
                    }
                }
                
                // LocalStorage„Å´„ÇÇ‰øùÂ≠òÔºàÂêåÊúüÁî®Ôºâ
                localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                
                // „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                loadTemplateList();
                
                closeTemplateModal();
                
            } catch (error) {
                console.error('‚ùå [TEMPLATE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert(`„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
            }
        }
        
        function loadTemplateList() {
            const container = document.getElementById('template-list');
            
            // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàÂà•„ÅÆ„É¢„Éº„ÉÄ„É´ÁîªÈù¢„Å™„Å©Ôºâ
            if (!container) {
                // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÊ≠£Â∏∏ - Ë≠¶Âëä„Å™„Åó„Åß„Çπ„Ç≠„ÉÉ„Éó
                return;
            }
            
            if (taskTemplates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            // „Ç∑„É≥„Éó„É´„Å™„É™„Çπ„ÉàË°®Á§∫Ôºà„Ç´„ÉÜ„Ç¥„É™Ê©üËÉΩÂâäÈô§Ôºâ
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem;">';

            taskTemplates.forEach(template => {
                html += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; width: 220px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <h6 style="margin: 0; font-size: 1rem; font-weight: 600; color: #172b4d; line-height: 1.2;">${template.name}</h6>
                            <div style="display: flex; gap: 0.25rem;">
                                <button onclick="editTemplate(${template.id})" style="background: none; border: none; color: #6c757d; cursor: pointer; font-size: 0.9rem; padding: 0.2rem;" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                                <button onclick="deleteTemplate(${template.id})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1rem; padding: 0.2rem;" title="ÂâäÈô§">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.75rem; line-height: 1.3;">${template.taskTitle}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0.75rem;">
                            <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">${template.priority === 'high' ? 'üî¥ ÊúÄÈáçË¶Å' : template.priority === 'medium' ? 'üü° ÈáçË¶Å' : 'üü¢ ÈÄöÂ∏∏'}</span>
                            <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">${columns.find(c => c.id === template.columnId)?.title || template.columnId}</span>
                        </div>
                        <button onclick="applyTemplate(${template.id})" style="width: 100%; padding: 0.6rem; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            ‚ö° ÈÅ©Áî®
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }
        
        function editTemplate(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíË®≠ÂÆö
            editingTemplateId = templateId;
            document.getElementById('template-modal-title').textContent = '‚úèÔ∏è „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ';
            document.getElementById('save-template-btn').textContent = 'Êõ¥Êñ∞';
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            showCreateTemplateModal();
            
            // „Éï„Ç©„Éº„É†„Å´„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂÄ§„ÇíË®≠ÂÆö
            setTimeout(() => {
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-category').value = template.category;
                document.getElementById('template-task-title').value = template.taskTitle;
                document.getElementById('template-priority').value = template.priority;
                document.getElementById('template-column').value = template.columnId;
                document.getElementById('template-memo').value = template.memo || '';
                
                // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíË®≠ÂÆö
                const checkboxes = document.querySelectorAll('#template-assignees input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = template.assignees && template.assignees.includes(cb.value);
                });
            }, 100);
        }
        
        function deleteTemplate(templateId) {
            if (!confirm('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            taskTemplates = taskTemplates.filter(t => t.id !== templateId);
            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
            loadTemplateList();
        }
        
        function applyTemplate(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // Êñ∞Ë¶è„Çø„Çπ„ÇØ‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅÑ„Å¶„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂÄ§„ÇíÈÅ©Áî®
            createTaskUnified();
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂÄ§„ÇíË®≠ÂÆö
            setTimeout(() => {
                document.getElementById('task-title-input').value = template.taskTitle;
                // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§
                document.getElementById('task-column-input').value = template.columnId;
                document.getElementById('task-memo-input').value = template.memo || '';
                
                // ÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö
                if (template.assignees && template.assignees.length > 0) {
                    setSelectedAssignees(template.assignees);
                }
            }, 100);
            
            // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSettingsModal();
        }
        
        // ============ „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´Èñ¢Êï∞Áæ§ ============
        let currentEditingTemplateId = null;
        
        function openTemplateManagementModal() {
            document.getElementById('templateManagementModal').style.display = 'flex';
            loadTemplateManagementList();
            showTemplateWelcomeScreen();
        }
        
        function closeTemplateManagementModal() {
            document.getElementById('templateManagementModal').style.display = 'none';
            currentEditingTemplateId = null;
            showTemplateWelcomeScreen();
        }
        
        function showTemplateWelcomeScreen() {
            document.getElementById('template-welcome-screen').style.display = 'flex';
            document.getElementById('template-form-container').style.display = 'none';
            currentEditingTemplateId = null;
        }
        
        function showTemplateCreateForm() {
            document.getElementById('template-welcome-screen').style.display = 'none';
            document.getElementById('template-form-container').style.display = 'flex';
            
            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('template-management-form').reset();
            document.getElementById('mgmt-save-template-btn').textContent = 'üíæ ‰øùÂ≠ò';
            document.getElementById('mgmt-delete-template-btn').style.display = 'none';
            currentEditingTemplateId = null;
            
            // „Ç´„É©„É†„Å®ÊãÖÂΩìËÄÖ„ÇíÊõ¥Êñ∞
            updateTemplateManagementFormOptions();
        }
        
        function loadTemplateManagementList() {
            const container = document.getElementById('template-management-list');
            
            if (taskTemplates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
                        <p>„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">„ÄåÊñ∞Ë¶è„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Äç„Åß<br>ÊúÄÂàù„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ</p>
                    </div>
                `;
                return;
            }
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                const category = template.category || '„Åù„ÅÆ‰ªñ';
                if (!groupedTemplates[category]) {
                    groupedTemplates[category] = [];
                }
                groupedTemplates[category].push(template);
            });
            
            let html = '';
            Object.keys(groupedTemplates).forEach(category => {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #374151; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">${category}</h5>
                `;
                
                groupedTemplates[category].forEach(template => {
                    const isSelected = currentEditingTemplateId === template.id;
                    html += `
                        <div onclick="selectTemplateInManagement(${template.id})" 
                             style="background: ${isSelected ? '#eff6ff' : 'white'}; 
                                    border: 1px solid ${isSelected ? '#3b82f6' : '#e5e7eb'}; 
                                    border-radius: 8px; 
                                    padding: 0.75rem; 
                                    margin-bottom: 0.5rem; 
                                    cursor: pointer; 
                                    transition: all 0.2s;"
                             onmouseover="if(!${isSelected}) { this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'; }"
                             onmouseout="if(!${isSelected}) { this.style.background='white'; this.style.borderColor='#e5e7eb'; }">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${template.name}</div>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">${template.taskTitle}</div>
                            <div style="display: flex; gap: 0.25rem;">
                                <span style="background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 12px; font-size: 0.7rem; color: #374151;">
                                    ${template.priority === 'high' ? 'üî¥' : template.priority === 'medium' ? 'üü°' : 'üü¢'} ${template.priority === 'high' ? 'ÊúÄÈáçË¶Å' : template.priority === 'medium' ? 'ÈáçË¶Å' : 'ÈÄöÂ∏∏'}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function selectTemplateInManagement(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            currentEditingTemplateId = templateId;
            
            // „Éï„Ç©„Éº„É†„ÇíË°®Á§∫
            document.getElementById('template-welcome-screen').style.display = 'none';
            document.getElementById('template-form-container').style.display = 'flex';
            
            // „Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('mgmt-template-name').value = template.name;
            // „Ç´„ÉÜ„Ç¥„É™Ê©üËÉΩÂâäÈô§
            document.getElementById('mgmt-template-task-title').value = template.taskTitle;
            document.getElementById('mgmt-template-priority').value = template.priority;
            document.getElementById('mgmt-template-column').value = template.columnId;
            document.getElementById('mgmt-template-memo').value = template.memo || '';
            
            // „Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            document.getElementById('mgmt-save-template-btn').textContent = 'üíæ Êõ¥Êñ∞';
            document.getElementById('mgmt-delete-template-btn').style.display = 'block';
            
            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
            updateTemplateManagementFormOptions();
            setTimeout(() => {
                const checkboxes = document.querySelectorAll('#mgmt-template-assignees input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = template.assignees && template.assignees.includes(cb.value);
                });
            }, 100);
            
            // ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞ÔºàÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂèçÊò†Ôºâ
            loadTemplateManagementList();
        }
        
        function updateTemplateManagementFormOptions() {
            // „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            const columnSelect = document.getElementById('mgmt-template-column');
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
            const assigneesContainer = document.getElementById('mgmt-template-assignees');
            assigneesContainer.innerHTML = '';
            assignees.forEach(assignee => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.5rem; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-size: 0.9rem;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = assignee;
                checkbox.name = 'mgmt-assignees';
                
                const span = document.createElement('span');
                span.textContent = assignee;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                assigneesContainer.appendChild(label);
                
                // „Éõ„Éê„ÉºÂäπÊûú
                label.addEventListener('mouseenter', () => {
                    label.style.background = '#f3f4f6';
                });
                label.addEventListener('mouseleave', () => {
                    label.style.background = 'white';
                });
            });
        }
        
        async function saveTemplateFromManagement(event) {
            event.preventDefault();

            const name = document.getElementById('mgmt-template-name').value.trim();
            // „Ç´„ÉÜ„Ç¥„É™Ê©üËÉΩÂâäÈô§
            const taskTitle = document.getElementById('mgmt-template-task-title').value.trim();
            const priority = document.getElementById('mgmt-template-priority').value;
            const columnId = document.getElementById('mgmt-template-column').value;
            const memo = document.getElementById('mgmt-template-memo').value.trim();

            // ÈÅ∏Êäû„Åï„Çå„ÅüÊãÖÂΩìËÄÖ„ÇíÂèñÂæó
            const selectedAssignees = Array.from(document.querySelectorAll('#mgmt-template-assignees input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            if (!name || !taskTitle) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„Å®„Çø„Çπ„ÇØÂêç„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }
            
            try {
                if (currentEditingTemplateId) {
                    // Êõ¥Êñ∞„É¢„Éº„Éâ - FirebaseÁµ±Âêà
                    const templateData = {
                        name: name,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo
                    };
                    
                    // FirebaseÊõ¥Êñ∞
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('üî• [TEMPLATE-MGMT] Firebase„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞‰∏≠...', name);
                        const result = await window.FirebaseDB.updateTemplate(currentEditingTemplateId, templateData);
                        
                        if (result.success) {
                            console.log('‚úÖ [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞ÊàêÂäü:', currentEditingTemplateId);
                            
                            // „É≠„Éº„Ç´„É´ÈÖçÂàó„ÇÇÊõ¥Êñ∞
                            const index = taskTemplates.findIndex(t => t.id === currentEditingTemplateId);
                            if (index !== -1) {
                                taskTemplates[index] = {
                                    ...taskTemplates[index],
                                    ...templateData,
                                    updatedAt: new Date().toISOString()
                                };
                            }
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                        } else {
                            console.error('‚ùå [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', result.error);
                            alert(`„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        const index = taskTemplates.findIndex(t => t.id === currentEditingTemplateId);
                        if (index !== -1) {
                            taskTemplates[index] = {
                                ...taskTemplates[index],
                                ...templateData,
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅÔºàLocalStorageÔºâ');
                        }
                    }
                } else {
                    // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ - FirebaseÁµ±Âêà
                    const templateData = {
                        id: Date.now(),
                        name: name,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Firebase‰ΩúÊàê
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('üî• [TEMPLATE-MGMT] Firebase„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê‰∏≠...', name);
                        const result = await window.FirebaseDB.createTemplate(templateData);
                        
                        if (result.success) {
                            console.log('‚úÖ [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàêÊàêÂäü:', result.id);
                            
                            // Firebase ID„ÇíË®≠ÂÆö„Åó„Å¶„É≠„Éº„Ç´„É´ÈÖçÂàó„Å´ËøΩÂä†
                            templateData.id = result.id;
                            taskTemplates.push(templateData);
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ');
                        } else {
                            console.error('‚ùå [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Ç®„É©„Éº:', result.error);
                            alert(`„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Ç®„É©„Éº: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        taskTemplates.push(templateData);
                        localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                        alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅÔºàLocalStorageÔºâ');
                    }
                }
                
                // LocalStorage„Å´„ÇÇ‰øùÂ≠òÔºàÂêåÊúüÁî®Ôºâ
                localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                
                // ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                loadTemplateManagementList();
                if (window.loadTemplateList) {
                    loadTemplateList(); // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆ‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞ÔºàË¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
                }
                
            } catch (error) {
                console.error('‚ùå [TEMPLATE-MGMT] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert(`„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
            }
            
            // „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢„Å´Êàª„Çã
            showTemplateWelcomeScreen();
        }
        
        function cancelTemplateForm() {
            showTemplateWelcomeScreen();
        }
        
        function deleteCurrentTemplate() {
            if (!currentEditingTemplateId) return;
            
            const template = taskTemplates.find(t => t.id === currentEditingTemplateId);
            if (!template) return;
            
            if (!confirm(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                return;
            }
            
            taskTemplates = taskTemplates.filter(t => t.id !== currentEditingTemplateId);
            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
            
            // ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
            loadTemplateManagementList();
            loadTemplateList(); // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆ‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞
            
            // „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢„Å´Êàª„Çã
            showTemplateWelcomeScreen();
            
            alert('üóëÔ∏è „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }
        
        // ============ „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´Èñ¢Êï∞Áæ§ ÁµÇ‰∫Ü ============
        
        // ============ „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´Èñ¢Êï∞Áæ§ ============
        let previewTasksModal = [];
        
        function openTaskImportModal() {
            document.getElementById('taskImportModal').style.display = 'flex';
            hidePreviewModal();
            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
            document.getElementById('import-text-modal').value = '';
        }

        function closeTaskImportModal() {
            document.getElementById('taskImportModal').style.display = 'none';
            hidePreviewModal();
            previewTasksModal = [];
        }

        function hidePreviewModal() {
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            if (previewDiv) previewDiv.style.display = 'none';
            if (contentDiv) contentDiv.innerHTML = '';
            previewTasksModal = [];
        }

        function processImportText(showPreview) {
            const importText = document.getElementById('import-text-modal').value.trim();
            if (!importText) {
                alert('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÂÖÉ„ÅÆ previewImport Ê©üËÉΩ„ÇíÂæ©ÂÖÉ
            const currentUser = getCurrentUser();
            const defaultAssignee = currentUser ? currentUser.name : '„É¶„Éº„Ç∂„Éº';
            const defaultDeadline = new Date().toISOString().split('T')[0];
            const defaultPriority = 'medium';
            const defaultColumn = 'todo';
            
            const lines = importText.split('\n');
            previewTasksModal = [];
            let lastMainTaskIndex = -1;
            
            lines.forEach((line, index) => {
                if (!line.trim()) return;
                
                const trimmedLine = line.trim();
                let taskText = trimmedLine;
                
                // Êï∞Â≠óË®òÂè∑„ÅÆ‰øÆÊ≠£ÔºàÂÖÉ„ÅÆÊ©üËÉΩÔºâ
                taskText = taskText
                    .replace(/‚ë†/g, '1').replace(/‚ë°/g, '2').replace(/‚ë¢/g, '3').replace(/‚ë£/g, '4').replace(/‚ë§/g, '5')
                    .replace(/‚ë•/g, '6').replace(/‚ë¶/g, '7').replace(/‚ëß/g, '8').replace(/‚ë®/g, '9').replace(/‚ë©/g, '10')
                    .replace(/‚óã/g, '0').replace(/‚óè/g, '1');
                
                // „Ç§„É≥„Éá„É≥„ÉàÂà§ÂÆöÔºàÂçäËßí„Çπ„Éö„Éº„Çπ2ÂÄã„ÉªÂÖ®Ëßí„Çπ„Éö„Éº„Çπ1ÂÄã„Éª„Çø„ÉñÔºâ
                const hasIndent = line.match(/^(\s{2,}|„ÄÄ|\t+)/);
                const isMainTask = !hasIndent;
                
                // ÊãÖÂΩìËÄÖÊäΩÂá∫
                const assigneeMatch = taskText.match(/@([^\s@]+)/g);
                let assignee = defaultAssignee;
                if (assigneeMatch && assigneeMatch.length > 0) {
                    assignee = assigneeMatch[0].replace('@', '');
                    taskText = taskText.replace(/@[^\s@]+/g, '').trim();
                }
                
                // Êó•‰ªòÊäΩÂá∫
                const dateMatches = taskText.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}Êúà\d{1,2}Êó•)/g);
                let deadline = defaultDeadline;
                if (dateMatches && dateMatches.length > 0) {
                    let dateStr = dateMatches[0];
                    if (dateStr.includes('Êúà') && dateStr.includes('Êó•')) {
                        const year = new Date().getFullYear();
                        const month = dateStr.match(/(\d{1,2})Êúà/)[1].padStart(2, '0');
                        const day = dateStr.match(/(\d{1,2})Êó•/)[1].padStart(2, '0');
                        deadline = `${year}-${month}-${day}`;
                    } else {
                        const parts = dateStr.split(/[-\/]/);
                        if (parts[0].length === 4) {
                            deadline = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                        } else {
                            const year = parts[2].length === 4 ? parts[2] : new Date().getFullYear();
                            deadline = `${year}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                        }
                    }
                    taskText = taskText.replace(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}Êúà\d{1,2}Êó•)/g, '').trim();
                }
                
                // ÂÑ™ÂÖàÂ∫¶ÊäΩÂá∫
                let priority = defaultPriority;
                if (taskText.match(/[!ÔºÅ]{2,}|È´ò|Á∑äÊÄ•|urgent|URGENT|ÊÄ•/)) {
                    priority = 'high';
                    taskText = taskText.replace(/[!ÔºÅ]+|È´ò|Á∑äÊÄ•|urgent|URGENT|ÊÄ•/g, '').trim();
                } else if (taskText.match(/‰Ωé|later|LATER|Âæå„Åß/)) {
                    priority = 'low';
                    taskText = taskText.replace(/‰Ωé|later|LATER|Âæå„Åß/g, '').trim();
                }
                
                taskText = taskText.replace(/\s+/g, ' ').trim();
                
                if (taskText && taskText.length > 1) {
                    const task = {
                        id: `preview_${index}`,
                        title: taskText,
                        assignee: assignee,
                        deadline: deadline,
                        priority: priority,
                        columnId: defaultColumn,
                        originalLine: line,
                        lineIndex: index,
                        isMainTask: isMainTask,
                        parentIndex: isMainTask ? null : lastMainTaskIndex,
                        isSkip: false,
                        autoDetected: !isMainTask && hasIndent
                    };
                    
                    if (isMainTask) {
                        lastMainTaskIndex = previewTasksModal.length;
                    }
                    
                    previewTasksModal.push(task);
                }
            });
            
            if (showPreview) {
                displayLineByLinePreviewModal();
            } else {
                executeImportFromModal();
            }
        }

        // üî• OCR„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£Ê©üËÉΩ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„ÅüÔºà2025-12-16Ôºâ

        // „ÄêÂÖÉ„ÅÆÂÆåÂÖ®„Å™Ê©üËÉΩ„ÇíÂæ©ÂÖÉ„Äë„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Éª3ÂàóË°®Á§∫„ÉªÊúüÈôêÁ∑®ÈõÜ
        
        function displayLineByLinePreviewModal() {
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            
            if (previewTasksModal.length === 0) {
                alert('ÊúâÂäπ„Å™„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const activeTaskCount = previewTasksModal.filter(t => !t.isSkip).length;
            const mainTaskCount = previewTasksModal.filter(t => !t.isSkip && t.isMainTask).length;
            const commentCount = previewTasksModal.filter(t => !t.isSkip && !t.isMainTask).length;
            
            const modeInfo = `<div style="font-size: 0.9rem; margin-top: 0.5rem;">‚ú® „Ç§„É≥„Éá„É≥„ÉàË°å„ÅØËá™Âãï„Åß„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆöÊ∏à„ÅøÔºàÂçäËßí„Çπ„Éö„Éº„Çπ2ÂÄã„ÉªÂÖ®Ëßí„Çπ„Éö„Éº„Çπ1ÂÄã„Éª„Çø„ÉñÔºâ„ÄÇ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßË¶™Â≠êÈñ¢‰øÇ„ÇíÂ§âÊõ¥ÂèØËÉΩ</div>`;
            
            let content = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f5e8; border-radius: 4px; color: #2f7d2f;">
                    <strong>üìù ${activeTaskCount}ÂÄã„ÅÆ„Ç¢„Ç§„ÉÜ„É† (üìã „É°„Ç§„É≥: ${mainTaskCount}, üí¨ „Ç≥„É°„É≥„Éà: ${commentCount})</strong>
                    ${modeInfo}
                </div>
                
                <!-- 3ÂàóË°®Á§∫„É¨„Ç§„Ç¢„Ç¶„Éà -->
                <div style="padding: 1rem; background: #f0f2f5; border-radius: 12px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;" id="preview-container-modal">
            `;
            
            previewTasksModal.forEach((task, index) => {
                if (task.isSkip) return;
                
                const mainTaskOptions = previewTasksModal.map((t, i) => 
                    i < index && t.isMainTask ? `<option value="${i}" ${task.parentIndex === i ? 'selected' : ''}>üìã ${t.title.substring(0, 30)}${t.title.length > 30 ? '...' : ''}</option>` : ''
                ).join('');
                
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                const borderColor = isAutoComment ? '#28a745' : '#ddd';
                const bgColor = isAutoComment ? '#f8fff9' : 'white';
                const headerText = isAutoComment ? '‚ú® Ëá™Âãï„Ç≥„É°„É≥„Éà' : '„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ';
                
                content += `
                    <div style="border: 2px solid ${borderColor}; border-radius: 8px; background: ${bgColor}; transition: all 0.2s; cursor: move; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); height: fit-content;" 
                         draggable="true" 
                         ondragstart="handlePreviewDragStartModal(event, ${index})" 
                         ondragend="handleDragEndModal(event)"
                         ondragover="handleDragOverModal(event)" 
                         ondrop="handlePreviewDropModal(event, ${index})"
                         ondragenter="handleDragEnterModal(event)"
                         ondragleave="handleDragLeaveModal(event)"
                         id="preview-item-modal-${index}">
                        
                        <!-- „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´ -->
                        <div style="background: ${borderColor}; padding: 0.4rem 0.8rem; text-align: center; color: white; font-weight: bold; cursor: grab; user-select: none; font-size: 0.85rem;">
                            ‚ãÆ‚ãÆ ${headerText} ‚ãÆ‚ãÆ
                        </div>
                        
                        <!-- „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫„Ç®„É™„Ç¢ -->
                        <div style="padding: 0.75rem; background: white;">
                            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                <input type="text" 
                                       value="${task.title.replace(/"/g, '&quot;')}" 
                                       onchange="updateTaskTitleModal(${index}, this.value)" 
                                       style="flex: 1; font-family: monospace; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; border: 1px solid ${borderColor}; border-left: 3px solid ${borderColor};"
                                       id="title-input-modal-${index}">
                                <button onclick="deletePreviewTaskModal(${index})" 
                                        style="background: #e53e3e; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                                        title="„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§">
                                    üóëÔ∏è
                                </button>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                                ÂÖÉ: "${task.originalLine}"
                            </div>
                        </div>
                        
                        <!-- Ë®≠ÂÆö„Ç®„É™„Ç¢ -->
                        <div style="padding: 0.75rem; background: #fafafa; border-top: 1px solid #eee;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">Á®ÆÈ°û:</label>
                                    <select onchange="updateTaskTypeModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;">
                                        <option value="main" ${task.isMainTask ? 'selected' : ''}>üìã „É°„Ç§„É≥</option>
                                        <option value="comment" ${!task.isMainTask ? 'selected' : ''}>üí¨ „Ç≥„É°„É≥„Éà</option>
                                        <option value="skip">‚è≠Ô∏è „Çπ„Ç≠„ÉÉ„Éó</option>
                                    </select>
                                </div>
                                
                                ${!task.isMainTask ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">Ë¶™:</label>
                                    <select onchange="updateTaskParentModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="parent-select-modal-${index}">
                                        <option value="">Ôºç</option>
                                        ${mainTaskOptions}
                                    </select>
                                </div>
                                ` : `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">Âàó:</label>
                                    <select onchange="updateTaskColumnModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="column-select-modal-${index}">
                                        ${columns.map(c => `<option value="${c.id}" ${task.columnId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <!-- ÊãÖÂΩìËÄÖË®≠ÂÆö -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">ÊãÖÂΩì:</label>
                                    <input type="text" onchange="updateTaskAssigneeModal(${index}, this.value)" value="${task.assignee}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" placeholder="ÊãÖÂΩìËÄÖÂêç" id="assignee-input-modal-${index}">
                                </div>
                                
                                <!-- ÊúüÈôêË®≠ÂÆö -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">ÊúüÈôê:</label>
                                    <input type="date" onchange="updateTaskDeadlineModal(${index}, this.value)" value="${task.deadline}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="deadline-input-modal-${index}">
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += `
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 0.9rem;">
                    <strong>üí° ‰Ωø„ÅÑÊñπÔºö</strong><br>
                    ‚Ä¢ <strong>‚ú® Ëá™ÂãïÂà§ÂÆö</strong>ÔºöÁ©∫ÁôΩ„Åå„ÅÇ„ÇãË°å„ÅØËá™Âãï„Åß„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆö„Åï„Çå„ÄÅÁõ¥Ââç„ÅÆ„É°„Ç§„É≥„Çø„Çπ„ÇØ„ÅåË¶™„Å´Ë®≠ÂÆö„Åï„Çå„Åæ„Åô<br>
                    ‚Ä¢ <strong>üñ±Ô∏è „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</strong>Ôºö‰ªªÊÑè„ÅÆË°å„Çí„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Ç≥„É°„É≥„Éà„Å´Â§âÊõ¥<br>
                    ‚Ä¢ <strong>üìã „É°„Ç§„É≥„Çø„Çπ„ÇØ</strong>ÔºöÁã¨Á´ã„Åó„Åü„Çø„Çπ„ÇØ„Ç´„Éº„Éâ„Å®„Åó„Å¶‰ΩúÊàê<br>
                    ‚Ä¢ <strong>üí¨ „Ç≥„É°„É≥„Éà</strong>ÔºöÊåáÂÆö„Åó„Åü„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ËøΩÂä†<br>
                    ‚Ä¢ <strong>‚è≠Ô∏è „Çπ„Ç≠„ÉÉ„Éó</strong>Ôºö„Ç§„É≥„Éù„Éº„ÉàÊôÇ„Å´ÁÑ°Ë¶ñ
                </div>
            `;
            
            contentDiv.innerHTML = content;
            previewDiv.style.display = 'block';
        }
        
        // „ÄêÂÖÉ„ÅÆÂÆåÂÖ®„Å™updateÈñ¢Êï∞Áæ§„ÇíÂæ©ÂÖÉ„Äë
        function updateTaskTitleModal(index, title) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].title = title.trim();
            }
        }
        
        function updateTaskTypeModal(index, type) {
            if (previewTasksModal[index]) {
                // „Ç≥„É°„É≥„ÉàÂåñ„Åó„Çà„ÅÜ„Å®„Åô„Çã„Çø„Çπ„ÇØ„Åå‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (type === 'comment' && previewTasksModal[index].isMainTask) {
                    const hasChildComments = previewTasksModal.some((task, i) => 
                        i !== index && !task.isMainTask && task.parentIndex === index
                    );
                    
                    if (hasChildComments) {
                        alert('‚ö†Ô∏è „Åì„ÅÆ„Çø„Çπ„ÇØ„ÅØ‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Ç≥„É°„É≥„ÉàÂåñ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nÂÖà„Å´Â≠ê„Ç≥„É°„É≥„Éà„Çí‰ªñ„ÅÆ„Çø„Çπ„ÇØ„Å´ÁßªÂãï„Åô„Çã„Åã„ÄÅ„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        document.querySelector(`#preview-item-modal-${index} select`).value = 'main';
                        return;
                    }
                }
                
                previewTasksModal[index].isMainTask = (type === 'main');
                previewTasksModal[index].isSkip = (type === 'skip');
                
                displayLineByLinePreviewModal();
            }
        }
        
        function updateTaskParentModal(index, parentIndex) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].parentIndex = parentIndex === '' ? null : parseInt(parentIndex);
                displayLineByLinePreviewModal();
            }
        }
        
        function updateTaskColumnModal(index, columnId) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].columnId = columnId;
            }
        }
        
        function updateTaskAssigneeModal(index, assignee) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].assignee = assignee.trim();
            }
        }
        
        function updateTaskDeadlineModal(index, deadline) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].deadline = deadline;
            }
        }
        
        function deletePreviewTaskModal(index) {
            const task = previewTasksModal[index];
            
            // „Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíË¶™„Å´„Åó„Å¶„ÅÑ„Çã„Ç≥„É°„É≥„Éà„ÇíÁ¢∫Ë™ç
            const childComments = previewTasksModal.filter((t, i) => 
                i !== index && !t.isMainTask && t.parentIndex === index
            );
            
            if (childComments.length > 0) {
                if (!confirm(`‚ö†Ô∏è „Åì„ÅÆ„Çø„Çπ„ÇØ„Å´„ÅØ${childComments.length}ÂÄã„ÅÆÂ≠ê„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÂ≠ê„Ç≥„É°„É≥„Éà„ÇÇ‰∏ÄÁ∑í„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }
                
                // Â≠ê„Ç≥„É°„É≥„Éà„ÇÇÂâäÈô§
                childComments.forEach(childTask => {
                    const childIndex = previewTasksModal.findIndex(t => t === childTask);
                    if (childIndex !== -1) {
                        previewTasksModal.splice(childIndex, 1);
                    }
                });
            }
            
            previewTasksModal.splice(index, 1);
            displayLineByLinePreviewModal();
        }
        
        // „Äê„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ„ÇíÂæ©ÂÖÉ„Äë
        function handlePreviewDragStartModal(event, index) {
            draggedIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.6';
        }
        
        function handleDragEndModal(event) {
            event.target.style.opacity = '1';
            draggedIndex = -1;
        }
        
        function handleDragOverModal(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnterModal(event) {
            event.preventDefault();
            if (event.target.closest('[id^="preview-item-modal-"]')) {
                event.target.closest('[id^="preview-item-modal-"]').style.backgroundColor = '#e0f7f6';
            }
        }
        
        function handleDragLeaveModal(event) {
            if (event.target.closest('[id^="preview-item-modal-"]')) {
                const item = event.target.closest('[id^="preview-item-modal-"]');
                const itemIndex = parseInt(item.id.split('-')[3]);
                const task = previewTasksModal[itemIndex];
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                item.style.backgroundColor = isAutoComment ? '#f8fff9' : 'white';
            }
        }
        
        function handlePreviewDropModal(event, targetIndex) {
            event.preventDefault();
            
            if (draggedIndex === targetIndex || draggedIndex === -1) {
                event.target.closest('[id^="preview-item-modal-"]').style.opacity = '1';
                return;
            }
            
            const draggedTask = previewTasksModal[draggedIndex];
            const targetTask = previewTasksModal[targetIndex];
            
            // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Çø„Çπ„ÇØ„Çí„Ç≥„É°„É≥„Éà„Å´Â§âÊõ¥„Åó„ÄÅ„Çø„Éº„Ç≤„ÉÉ„Éà„Çø„Çπ„ÇØ„ÇíË¶™„Å´Ë®≠ÂÆö
            if (targetTask.isMainTask) {
                // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Çø„Çπ„ÇØ„Åå‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (draggedTask.isMainTask) {
                    const childComments = previewTasksModal.filter((task, i) => 
                        i !== draggedIndex && !task.isMainTask && task.parentIndex === draggedIndex
                    );
                    
                    if (childComments.length > 0) {
                        // Â≠ê„Ç≥„É°„É≥„Éà„ÇÇ‰∏ÄÁ∑í„Å´ÁßªÂãï
                        childComments.forEach(childTask => {
                            childTask.parentIndex = targetIndex;
                        });
                    }
                }
                
                draggedTask.isMainTask = false;
                draggedTask.parentIndex = targetIndex;
                
                displayLineByLinePreviewModal();
                
                const movedCount = draggedTask.isMainTask ? 0 : previewTasksModal.filter(t => !t.isMainTask && t.parentIndex === targetIndex).length;
                alert(`üí¨ "${draggedTask.title}"„Çí"${targetTask.title}"„ÅÆ„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü${movedCount > 1 ? `ÔºàÂ≠ê„Ç≥„É°„É≥„Éà${movedCount-1}ÂÄã„ÇÇÁßªÂãïÔºâ` : ''}`);
            } else {
                alert('‚ö†Ô∏è „Ç≥„É°„É≥„Éà„ÇíÂà•„ÅÆ„Ç≥„É°„É≥„Éà„Å´„Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            
            draggedIndex = -1;
        }
        
        function executeImportFromModal() {
            if (previewTasksModal.length === 0) {
                alert('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const activeTasksModal = previewTasksModal.filter(t => !t.isSkip);
            if (activeTasksModal.length === 0) {
                alert('ÊúâÂäπ„Å™„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Çø„Çπ„ÇØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const importedCount = importTasksModal(activeTasksModal);
            const mainCount = activeTasksModal.filter(t => t.isMainTask).length;
            const commentCount = activeTasksModal.filter(t => !t.isMainTask).length;
            
            alert(`üéâ „Çø„Çπ„ÇØËøΩÂä†„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\nüìã ${mainCount}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„ÇíËøΩÂä†\nüí¨ ${commentCount}ÂÄã„ÅÆ„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†\n\nÂêàË®à: ${importedCount}‰ª∂`);
            
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶„É°„Ç§„É≥ÁîªÈù¢„ÇíÊõ¥Êñ∞
            closeTaskImportModal();
            render();
            
            // üö´ „Ç§„É≥„Éù„Éº„ÉàÂæå„ÅÆÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁÑ°ÂäπÂåñÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÔºâ
            // setTimeout(() => checkDeadlines(), 100);
        }
        
        // ============ „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´Èñ¢Êï∞Áæ§ ÁµÇ‰∫Ü ============

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÈñ¢ÈÄ£Èñ¢Êï∞
        function initializeTemplateSelector() {
            const templateSelect = document.getElementById('template-select');
            templateSelect.innerHTML = '<option value="">-- „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû --</option>';
            
            if (taskTemplates.length === 0) {
                return;
            }
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                if (!groupedTemplates[template.category]) {
                    groupedTemplates[template.category] = [];
                }
                groupedTemplates[template.category].push(template);
            });
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Ç™„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†
            Object.keys(groupedTemplates).forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                groupedTemplates[category].forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    optgroup.appendChild(option);
                });
                
                templateSelect.appendChild(optgroup);
            });
        }
        
        function handleTemplateSelection(templateId) {
            if (!templateId) {
                return;
            }
            
            const template = taskTemplates.find(t => t.id == templateId);
            if (!template) {
                return;
            }
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('task-title-input').value = template.taskTitle;
            // ÂÑ™ÂÖàÂ∫¶Ê©üËÉΩÂâäÈô§
            document.getElementById('task-column-input').value = template.columnId;
            document.getElementById('task-memo-input').value = template.memo || '';
            
            // ÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö
            if (template.assignees && template.assignees.length > 0) {
                setSelectedAssignees(template.assignees);
            }
            
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('template-select').value = '';
        }
        
        // „Éê„É´„ÇØÊìç‰ΩúÈñ¢Êï∞Áæ§
        function toggleBulkMode() {
            isBulkMode = !isBulkMode;
            console.log(`üîÑ [BULK] toggleBulkMode called, new state: ${isBulkMode}`);
            const bulkBar = document.getElementById('bulk-actions-bar');
            const toggleBtn = document.querySelector('button[onclick="toggleBulkMode()"]');
            
            if (isBulkMode) {
                bulkBar.style.display = 'block';
                toggleBtn.textContent = '‚òëÔ∏è ÈÅ∏Êäû‰∏≠';
                toggleBtn.style.background = 'linear-gradient(135deg, #e53e3e 0%, #c53030 100%)';
                
                // ÁßªÂãïÂÖà„Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
                const moveSelect = document.getElementById('bulk-move-column');
                moveSelect.innerHTML = '<option value="">ÁßªÂãïÂÖà„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû</option>';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    moveSelect.appendChild(option);
                });
            } else {
                bulkBar.style.display = 'none';
                toggleBtn.textContent = '‚òëÔ∏è Ë§áÊï∞ÈÅ∏Êäû';
                toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                clearSelection();
            }
            
            render(); // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπË°®Á§∫/ÈùûË°®Á§∫„ÇíÂèçÊò†
        }
        
        function selectAllTasks() {
            selectedTasks.clear();
            tasks.forEach(task => {
                selectedTasks.add(task.id);
            });
            updateSelectedCount();
            render();
        }
        
        function clearSelection() {
            selectedTasks.clear();
            updateSelectedCount();
            render();
        }
        
        function toggleTaskSelection(taskId) {
            console.log(`Toggle selection for task ${taskId}, current size: ${selectedTasks.size}`);
            
            if (selectedTasks.has(taskId)) {
                selectedTasks.delete(taskId);
                console.log(`Removed task ${taskId}, new size: ${selectedTasks.size}`);
            } else {
                selectedTasks.add(taskId);
                console.log(`Added task ${taskId}, new size: ${selectedTasks.size}`);
            }
            updateSelectedCount();

            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            const checkbox = document.querySelector(`input[onchange="toggleTaskSelection('${taskId}')"]`);
            if (checkbox) {
                checkbox.checked = selectedTasks.has(taskId);
            }
            
            console.log(`Selected tasks:`, Array.from(selectedTasks));
        }
        
        function updateSelectedCount() {
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = `${selectedTasks.size}‰ª∂ÈÅ∏Êäû`;
            }
        }
        
        function bulkMoveSelected() {
            const targetColumn = document.getElementById('bulk-move-column').value;
            if (!targetColumn) {
                alert('ÁßªÂãïÂÖà„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (selectedTasks.size === 0) {
                alert('ÁßªÂãï„Åô„Çã„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const selectedTaskIds = Array.from(selectedTasks);
            let movedCount = 0;
            
            selectedTaskIds.forEach(taskId => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    console.log(`Moving task ${task.title} from ${task.columnId} to ${targetColumn}`);
                    task.columnId = targetColumn;
                    movedCount++;
                }
            });
            
            if (movedCount > 0) {
                saveTasks();
                render();
                updateStats();
                clearSelection();
                
                const targetColumnTitle = columns.find(c => c.id === targetColumn)?.title || targetColumn;
                alert(`${movedCount}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„Çí„Äå${targetColumnTitle}„Äç„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü`);
            } else {
                alert('ÁßªÂãï„Åß„Åç„Çã„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
            }
        }
        
        function bulkDeleteSelected() {
            if (selectedTasks.size === 0) {
                alert('ÂâäÈô§„Åô„Çã„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const selectedTaskIds = Array.from(selectedTasks);
            const confirmMessage = `ÈÅ∏Êäû„Åó„Åü${selectedTaskIds.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            tasks = tasks.filter(task => !selectedTasks.has(task.id));
            
            saveTasks();
            clearSelection();
            render();
            updateStats();
            
            alert(`${selectedTaskIds.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
        }
        
        
        
        // Phase 2: „Éû„Ç§„Éö„Éº„Ç∏„Éú„Çø„É≥ÂâäÈô§ÂÆüË°å
        setTimeout(() => {
            removeMyProfileButton();
        }, 1500); // 1.5ÁßíÂæå„Å´ÂÆâÂÖ®„Å´ÂÆüË°å
        
        // Phase 3: „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥Âà∂Âæ°ÂÆüË°åÔºà„Éû„Ç§„Éö„Éº„Ç∏ÁßªÊ§ç„ÅÆ„Åü„ÇÅ‰∏çË¶ÅÔºâ
        // setTimeout(() => {
        //     hideUserManagementForUsers();
        // }, 300); // 0.3ÁßíÂæå„Å´È´òÈÄüÂÆüË°å
        
        // „ÉÜ„Çπ„ÉàÁî®: ÂÅúÊªû„Çø„Çπ„ÇØ„Çí‰ΩúÊàêÔºà„Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÂÆüË°åÂèØËÉΩÔºâ
        function createTestStaleTask() {
            const staleDate = new Date();
            staleDate.setDate(staleDate.getDate() - 5); // 5Êó•Ââç
            
            const testTask = {
                id: Date.now(),
                title: '„Äê„ÉÜ„Çπ„Éà„Äë5Êó•Ââç„Å´‰ΩúÊàê„Åï„Çå„Åü„Çø„Çπ„ÇØ',
                deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7Êó•Âæå„ÅÆÊúüÈôê
                priority: 'medium',
                columnId: 'todo',
                assignee: 'Áî∞‰∏≠ÈÉ®Èï∑',
                assignees: ['Áî∞‰∏≠ÈÉ®Èï∑'],
                memo: '„Åì„Çå„ÅØÂÅúÊªû„Çø„Çπ„ÇØ„ÅÆ„ÉÜ„Çπ„ÉàÁî®„Åß„Åô„ÄÇ3Êó•‰ª•‰∏äÁµåÈÅé„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅËµ§Êû†Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ',
                createdAt: staleDate.toISOString(),
                isMainTask: false
            };
            
            tasks.push(testTask);
            taskCounter++;
            
            saveTasks();
            renderKanban();
            updateStats();
            
            alert('5Êó•Ââç„Å´‰ΩúÊàê„Åï„Çå„Åü„ÉÜ„Çπ„Éà„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ\nËµ§Êû†„ÅßË°®Á§∫„Åï„Çå„ÄÅÂÅúÊªû‰∏≠„Ç´„Ç¶„É≥„Éà„Å´Âê´„Åæ„Çå„Åæ„Åô„ÄÇ');
        }
        
        // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºà„Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÂëº„Å≥Âá∫„ÅóÂèØËÉΩÔºâ
        window.createTestStaleTask = createTestStaleTask;
        
        // „ÉÜ„Çπ„ÉàÁî®PJ„Çø„Çπ„ÇØ‰ΩúÊàê
        function createTestPJTask() {
            const testPJTask = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                title: '„Äê„ÉÜ„Çπ„ÉàPJ„ÄëÊñ∞Ë¶è„Ç∑„Çπ„ÉÜ„É†Â∞éÂÖ• - Ë¶Å‰ª∂ÂÆöÁæ©Êõ∏‰ΩúÊàê',
                deadline: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString(), // 10Êó•Âæå„ÅÆÊúüÈôê
                priority: 'high',
                columnId: 'todo',
                assignee: 'Áî∞‰∏≠ÈÉ®Èï∑',
                assignees: ['Áî∞‰∏≠ÈÉ®Èï∑', '‰ΩêËó§Ë™≤Èï∑'],
                memo: '„Åì„Çå„ÅØPJ„Çø„Çπ„ÇØ„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô„ÄÇW„ÉÅ„Çß„ÉÉ„ÇØ‰ΩìÂà∂„ÅÆÁ¢∫Ë™çÁî®„ÄÇ',
                createdAt: new Date().toISOString(),
                completed: false,
                
                // PJ„Çø„Çπ„ÇØÂ∞ÇÁî®„Éï„Ç£„Éº„É´„Éâ
                projectId: 'PJ001',
                projectName: 'Êñ∞Ë¶è„Ç∑„Çπ„ÉÜ„É†Â∞éÂÖ•„Éó„É≠„Ç∏„Çß„ÇØ„Éà',
                personalStatus: 'todo',
                projectStatus: 'todo',
                pendingMove: null,
                approvers: ['‰ΩêËó§Ë™≤Èï∑', 'Èà¥Êú®‰∏ª‰ªª'],
                lastApprovedBy: null,
                approvedAt: null
            };
            
            tasks.push(testPJTask);
            saveTasks();
            render();
            updateStats();
            
            alert('„ÉÜ„Çπ„ÉàÁî®PJ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ\n\nPJ„Éï„Ç£„É´„Çø„Éº„Åã„Çâ„ÄåPJ001„Äç„ÇíÈÅ∏Êäû„Åô„Çã„Å®Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ\n\n„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç: Êñ∞Ë¶è„Ç∑„Çπ„ÉÜ„É†Â∞éÂÖ•„Éó„É≠„Ç∏„Çß„ÇØ„Éà\n„Éó„É≠„Ç∏„Çß„ÇØ„ÉàID: PJ001');
        }
        
        window.createTestPJTask = createTestPJTask;
        
        // ÂÆöÊúü„Çø„Çπ„ÇØÁÆ°ÁêÜ„ÅÆÂü∫Êú¨Èñ¢Êï∞
        function createRecurringTemplate() {
            alert('ÂÆöÊúü„Çø„Çπ„ÇØ„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàêÊ©üËÉΩ„ÅØÂÆüË£Ö‰∏≠„Åß„Åô„ÄÇ\n\n‰∫àÂÆöÊ©üËÉΩ:\n‚Ä¢ ÊØéÊúà„ÉªÊØéÈÄ±„ÅÆÁπ∞„ÇäËøî„ÅóË®≠ÂÆö\n‚Ä¢ ÊãÖÂΩìËÄÖ„ÉªÊúüÈôê„ÅÆËá™ÂãïË®≠ÂÆö\n‚Ä¢ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ„ÅÆËá™ÂãïÁîüÊàê');
        }
        
        function generatePendingTasks() {
            // ÁèæÂú®ÂÆöÊúü„Çø„Çπ„ÇØ„Åå0‰ª∂„Å™„ÅÆ„Åß„ÄÅ„Éá„É¢Áî®„ÅÆË™¨Êòé„ÇíË°®Á§∫
            alert('ÂÆöÊúü„Çø„Çπ„ÇØÁîüÊàê„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü\n\nÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åô„Çã„Å®„ÄÅÊåáÂÆö„Åï„Çå„ÅüÈñìÈöî„Åß„Çø„Çπ„ÇØ„ÅåËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„Åô„ÄÇ');
        }
        
        window.createRecurringTemplate = createRecurringTemplate;
        window.generatePendingTasks = generatePendingTasks;
        
        // PJ„Çø„Çπ„ÇØË®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩÔºàÁßªÂãï„ÅÆ„Åü„Å≥„Å´Êñ∞„Åó„ÅÑË®ºÊÜë„ÅåÂøÖË¶ÅÔºâ
        function checkTaskEvidence(task, isMoving = false) {
            // Ë®ºÊÜë„ÅÆÂ≠òÂú®Á¢∫Ë™ç
            const hasComments = task.comments && task.comments.length > 0;
            const hasAttachments = task.attachments && task.attachments.length > 0;
            const hasDetailedMemo = task.memo && task.memo.trim().length > 10; // 10ÊñáÂ≠ó‰ª•‰∏ä„ÅÆË©≥Á¥∞„É°„É¢
            
            // ÁßªÂãïÊôÇ„ÅØ„ÄÅÂâçÂõûÁßªÂãïÂæå„Å´Êñ∞„Åó„ÅÑË®ºÊÜë„ÅåËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (isMoving && task.lastMovedAt) {
                const lastMoveTime = new Date(task.lastMovedAt).getTime();
                
                // ÂâçÂõûÁßªÂãïÂæå„ÅÆ„Ç≥„É°„É≥„ÉàÁ¢∫Ë™ç
                const recentComments = task.comments ? task.comments.filter(comment => 
                    new Date(comment.timestamp).getTime() > lastMoveTime
                ).length > 0 : false;
                
                // ÂâçÂõûÁßªÂãïÂæå„ÅÆÊ∑ª‰ªò„Éï„Ç°„Ç§„É´Á¢∫Ë™ç
                const recentAttachments = task.attachments ? task.attachments.filter(file =>
                    new Date(file.uploadedAt || file.timestamp || 0).getTime() > lastMoveTime
                ).length > 0 : false;
                
                // „É°„É¢„ÅÆÊõ¥Êñ∞Á¢∫Ë™çÔºàupdatedAt„ÅålastMovedAt„Çà„ÇäÊñ∞„Åó„ÅÑÔºâ
                const recentMemoUpdate = task.updatedAt && 
                    new Date(task.updatedAt).getTime() > lastMoveTime &&
                    task.memo && task.memo.trim().length > 10;
                
                const hasRecentEvidence = recentComments || recentAttachments || recentMemoUpdate;
                
                console.log(`üîç [EVIDENCE CHECK] Task: ${task.title}`);
                console.log(`üîç [EVIDENCE CHECK] Last moved: ${task.lastMovedAt}`);
                console.log(`üîç [EVIDENCE CHECK] Recent comments: ${recentComments}`);
                console.log(`üîç [EVIDENCE CHECK] Recent attachments: ${recentAttachments}`);
                console.log(`üîç [EVIDENCE CHECK] Recent memo update: ${recentMemoUpdate}`);
                console.log(`üîç [EVIDENCE CHECK] Has recent evidence: ${hasRecentEvidence}`);
                
                return hasRecentEvidence;
            }
            
            // ÂàùÂõûÁßªÂãïÊôÇ„ÅØÊó¢Â≠ò„ÅÆË®ºÊÜë„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            return hasComments || hasAttachments || hasDetailedMemo;
        }
        
        function promptForEvidence(task) {
            return new Promise((resolve) => {
                // „Ç´„Çπ„Çø„É†„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Çí‰ΩúÊàê
                const dialogHTML = `
                    <div id="evidenceDialog" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    ">
                        <div style="
                            background: white;
                            padding: 2rem;
                            border-radius: 8px;
                            max-width: 500px;
                            margin: 1rem;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        ">
                            <h3 style="color: #e67e22; margin-bottom: 1rem;">‚ö†Ô∏è PJ„Çø„Çπ„ÇØ„ÅÆÁßªÂãï„Å´„ÅØË®ºÊÜë„ÅåÂøÖË¶Å„Åß„Åô</h3>
                            <p style="margin-bottom: 1rem;"><strong>„Çø„Çπ„ÇØ:</strong> ${task.title}</p>
                            <p style="margin-bottom: 1rem;"><strong>„Éó„É≠„Ç∏„Çß„ÇØ„Éà:</strong> ${task.projectName}</p>
                            <p style="margin-bottom: 1rem;">‰ª•‰∏ã„ÅÆ„ÅÑ„Åö„Çå„Åã„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ:</p>
                            <ul style="margin-bottom: 1.5rem; padding-left: 1.5rem;">
                                <li>„Ç≥„É°„É≥„ÉàÔºàÈÄ≤ÊçóÂ†±Âëä„ÉªÈÄ£Áµ°ÂÜÖÂÆπÁ≠âÔºâ</li>
                                <li>„Éï„Ç°„Ç§„É´Ê∑ª‰ªòÔºàË≥áÊñô„Éª„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÁ≠âÔºâ</li>
                                <li>Ë©≥Á¥∞„É°„É¢Ôºà„É°„Éº„É´ÂÜÖÂÆπ„ÉªÊâì„Å°Âêà„Çè„ÅõÁµêÊûúÁ≠âÔºâ</li>
                            </ul>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button id="evidenceCancel" style="
                                    padding: 0.5rem 1rem;
                                    border: 1px solid #ddd;
                                    background: white;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">Ë®ºÊÜë„ÇíËøΩÂä†„Åô„Çã</button>
                                <button id="evidenceConfirm" style="
                                    padding: 0.5rem 1rem;
                                    border: none;
                                    background: #e74c3c;
                                    color: white;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">Ë®ºÊÜë„Å™„Åó„ÅßÁßªÂãï„Åô„Çã</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', dialogHTML);
                
                const dialog = document.getElementById('evidenceDialog');
                const cancelBtn = document.getElementById('evidenceCancel');
                const confirmBtn = document.getElementById('evidenceConfirm');
                
                function cleanup() {
                    if (dialog && dialog.parentNode) {
                        dialog.parentNode.removeChild(dialog);
                    }
                }
                
                cancelBtn.onclick = () => {
                    cleanup();
                    // Ë®ºÊÜëËøΩÂä†„ÅÆ„Åü„ÇÅ„Çø„Çπ„ÇØÁ∑®ÈõÜÁîªÈù¢„ÇíÈñã„Åè
                    editTask(task.id);
                    resolve(false);
                };
                
                confirmBtn.onclick = () => {
                    cleanup();
                    resolve(true); // Ë®ºÊÜë„Å™„Åó„ÅßÂº∑Âà∂ÁßªÂãï
                };
            });
        }
        
        // PJ„Çø„Çπ„ÇØÁßªÂãïÊôÇ„ÅÆÈÄöÁü•Ê©üËÉΩÔºàSlackÂØæÂøúÂº∑ÂåñÁâàÔºâ
        async function sendPJMoveNotification(task, newColumnId) {
            try {
                // ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆÈÄöÁü•ÊäëÂà∂„ÉÅ„Çß„ÉÉ„ÇØ
                if (task.isHidden) {
                    console.log(`üîí [SLACK-MOVE] ÈùûË°®Á§∫„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó: ${task.title}`);
                    return;
                }
                
                const currentUser = getCurrentUser();

                // „Ç´„É©„É†ID„Åã„Çâ„Ç´„É©„É†Âêç„ÇíÂèñÂæóÔºà„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†ÂØæÂøúÔºâ
                let columnTitle = newColumnId; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                if (task.projectId) {
                    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†„Åã„ÇâÊ§úÁ¥¢
                    const projectColumns = getProjectColumns(task.projectId);
                    const column = projectColumns.find(c => c.id === newColumnId);
                    columnTitle = column ? column.title : newColumnId;
                    console.log(`üîç [SLACK-MOVE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†Ê§úÁ¥¢: ${newColumnId} ‚Üí ${columnTitle}`);
                } else {
                    // ÂÄã‰∫∫„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÄÅ„Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„Åã„ÇâÊ§úÁ¥¢
                    const column = columns.find(c => c.id === newColumnId);
                    columnTitle = column ? column.title : newColumnId;
                    console.log(`üîç [SLACK-MOVE] ÂÄã‰∫∫„Ç´„É©„É†Ê§úÁ¥¢: ${newColumnId} ‚Üí ${columnTitle}`);
                }
                
                console.log(`üîî [SLACK-MOVE] „Çø„Çπ„ÇØÁßªÂãïÈÄöÁü•ÈñãÂßã: ${task.title} ‚Üí ${columnTitle}`);
                console.log(`üîî [SLACK-MOVE] „Çø„Çπ„ÇØÊÉÖÂ†±:`, {
                    id: task.id,
                    title: task.title,
                    assignees: task.assignees,
                    assignee: task.assignee,
                    approvers: task.approvers
                });
                
                // ÈÄöÁü•ÂØæË±°ËÄÖ„ÇíÈõÜ„ÇÅ„ÇãÔºàÊâøË™çËÄÖ + ÊãÖÂΩìËÄÖ + „Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„ÉºÔºâ
                const notifyUsers = new Set();
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅØ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº„ÇíËøΩÂä†
                if (task.projectId && task.projectName) {
                    console.log(`üîî [SLACK-MOVE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØÊ§úÂá∫: ${task.projectName} (${task.projectId})`);

                    // üî• Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
                    let project = null;
                    if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                        const result = await window.FirebaseDB.getProjects();
                        if (result.success) {
                            project = result.projects.find(p => p.id === task.projectId);
                        }
                    }

                    if (project && project.members) {
                        project.members.forEach(member => {
                            notifyUsers.add(member);
                            console.log(`üîî [SLACK-MOVE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„ÉºËøΩÂä†: ${member}`);
                        });
                        console.log(`üîî [SLACK-MOVE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„ÉºÂêàË®à: ${project.members.length}‰∫∫`);
                    } else {
                        console.log(`‚ö†Ô∏è [SLACK-MOVE] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åã„ÄÅ„É°„É≥„Éê„ÉºÊÉÖÂ†±„Å™„Åó`);
                    }
                }
                
                
                // ÊãÖÂΩìËÄÖ„ÇíËøΩÂä†
                if (task.assignees && task.assignees.length > 0) {
                    task.assignees.forEach(assignee => {
                        notifyUsers.add(assignee);
                        console.log(`üîî [SLACK-MOVE] ÊãÖÂΩìËÄÖËøΩÂä†: ${assignee}`);
                    });
                } else if (task.assignee) {
                    notifyUsers.add(task.assignee);
                    console.log(`üîî [SLACK-MOVE] ÊãÖÂΩìËÄÖËøΩÂä†ÔºàÊóßÂΩ¢ÂºèÔºâ: ${task.assignee}`);
                }
                
                // üîß „Çø„Çπ„ÇØÁßªÂãïÈÄöÁü•„ÅÆÂ†¥Âêà„ÄÅËá™ÂàÜ„ÇÇÂê´„ÇÅ„Å¶ÂÖ®Âì°„Å´ÈÄöÁü•ÔºàÊÉÖÂ†±ÂÖ±Êúâ„ÅÆ„Åü„ÇÅÔºâ
                const includeCurrentUserInNotification = true;  // „Çø„Çπ„ÇØÁßªÂãïÊôÇ„ÅØËá™ÂàÜ„ÇÇÈÄöÁü•ÂØæË±°„Å´Âê´„ÇÅ„Çã
                
                const filteredNotifyUsers = Array.from(notifyUsers).filter(user => {
                    if (includeCurrentUserInNotification) {
                        // „Çø„Çπ„ÇØÁßªÂãïÈÄöÁü•„Åß„ÅØÂÖ®Âì°„Å´ÈÄöÁü•
                        console.log(`üîç [MOVE-FILTER] ${user}: „Çø„Çπ„ÇØÁßªÂãï„ÅÆ„Åü„ÇÅÂÖ®Âì°„Å´ÈÄöÁü•`);
                        return true;
                    } else {
                        // „Åù„ÅÆ‰ªñ„ÅÆÈÄöÁü•„Çø„Ç§„Éó„Åß„ÅØÁèæÂú®„É¶„Éº„Ç∂„Éº„ÇíÈô§Â§ñ
                        const isNotCurrentUser = (
                            user !== currentUser.name &&
                            user !== currentUser.email &&
                            user !== currentUser.id
                        );
                        console.log(`üîç [MOVE-FILTER] ${user}: ÁèæÂú®„É¶„Éº„Ç∂„Éº„Åß„Å™„ÅÑ = ${isNotCurrentUser}`);
                        return isNotCurrentUser;
                    }
                });
                
                const notifyUsersList = filteredNotifyUsers;
                
                console.log(`üîî [SLACK-MOVE] ÂÖÉ„ÅÆÈÄöÁü•ÂØæË±°ËÄÖ:`, Array.from(notifyUsers));
                console.log(`üîî [SLACK-MOVE] „Éï„Ç£„É´„Çø„ÉºÂæåÈÄöÁü•ÂØæË±°„É¶„Éº„Ç∂„Éº:`, notifyUsersList);
                console.log(`üîî [SLACK-MOVE] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº: ${currentUser.name} (Ê≠£„Åó„ÅèÈô§Â§ñ)`);
                
                // ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏‰ΩúÊàê
                const notificationTitle = `üì¶ „Çø„Çπ„ÇØÁßªÂãïÈÄöÁü•`;
                const notificationBody = 
                    `„Çø„Çπ„ÇØ„Äå${task.title}„Äç„Åå${columnTitle}„Å´ÁßªÂãï„Åï„Çå„Åæ„Åó„Åü\n\n` +
                    `ÁßªÂãïÂÖà: ${columnTitle}`;
                
                // ÈÄöÁü•ÂØæË±°ËÄÖ„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇ„ÄÅ„ÉÜ„Çπ„ÉàÁî®„Å´SlackÈÄöÁü•„ÇíÈÄÅ‰ø°
                if (notifyUsersList.length === 0) {
                    console.log(`üîî [SLACK-MOVE] ÈÄöÁü•ÂØæË±°ËÄÖ„Å™„Åó - „ÉÜ„Çπ„ÉàÁî®SlackÈÄöÁü•„ÇíÈÄÅ‰ø°`);
                    console.log(`üîî [SLACK-MOVE] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±:`, currentUser);
                    
                    // „ÉÜ„Çπ„ÉàÁî®„ÅÆËá™ÂàÜ„Å∏„ÅÆÈÄöÁü•Ôºà„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÁõ¥Êé•ÊåáÂÆöÔºâ
                    showNotification(
                        notificationTitle,
                        `${notificationBody}\n\n‚Äª „ÉÜ„Çπ„ÉàÁî®ÈÄöÁü•ÔºàÂØæË±°ËÄÖ„Å™„ÅóÔºâ`,
                        {
                            tag: `move-test-${task.id}-${Date.now()}`,
                            taskId: task.id,
                            targetUser: currentUser.name,
                            targetEmail: currentUser.email || 'muranaka-tenma@terracom.co.jp',  // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÁõ¥Êé•ÊåáÂÆö
                            type: 'task_move_test'
                        }
                    );
                    return;
                }
                
                // Áµ±ÂêàÈÄöÁü•„Å®„Åó„Å¶1Âõû„Å†„ÅëÈÄÅ‰ø°ÔºàÂÄãÂà•ÈÄÅ‰ø°„ÇíÂªÉÊ≠¢Ôºâ
                if (notifyUsersList.length > 0) {
                    console.log(`üîî [SLACK-MOVE] Áµ±ÂêàÈÄöÁü•ÈÄÅ‰ø°ÈñãÂßã: ${notifyUsersList.length}‰∫∫„Å∏„ÅÆÁµ±ÂêàÈÄöÁü•`);
                    
                    // „É°„É≥„Ç∑„Éß„É≥„ÅØshowNotification„ÅÆ'multiple'Âá¶ÁêÜ„Å´‰ªª„Åõ„ÇãÔºàÈáçË§áÂõûÈÅø„ÅÆ„Åü„ÇÅÔºâ
                    showNotification(
                        notificationTitle,
                        notificationBody,
                        {
                            tag: `move-${task.id}-${Date.now()}`,
                            taskId: task.id,
                            targetUser: 'multiple',
                            mentionUsers: notifyUsersList,
                            type: 'task_move'
                        }
                    );
                    
                    console.log(`‚úÖ [SLACK-MOVE] Áµ±ÂêàÈÄöÁü•ÈÄÅ‰ø°ÂÆå‰∫Ü: ${notifyUsersList.length}‰∫∫„Å´1„Å§„ÅÆÈÄöÁü•`);
                } else {
                    console.log('üìù [SLACK-MOVE] ÈÄöÁü•ÂØæË±°ËÄÖ„Å™„Åó„ÄÅÈÄöÁü•ÈÄÅ‰ø°„Çí„Çπ„Ç≠„ÉÉ„Éó');
                }
                
            } catch (error) {
                console.error('‚ùå [SLACK-MOVE] SlackÈÄöÁü•„Ç®„É©„Éº:', error);
            }
        }
        
        // „Çø„Çπ„ÇØÂâäÈô§Ê©üËÉΩÔºà„Ç¢„Éº„Ç´„Ç§„ÉñÁßªÂãïÔºâ
        async function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºö‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøÂâäÈô§ÂèØËÉΩ
            const currentUser = getCurrentUser();
            if (currentUser.role === 'user') {
                const canDelete = task.assignees && task.assignees.includes(currentUser.name) || 
                                 task.assignee === currentUser.name;
                if (!canDelete) {
                    alert('‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Çø„Çπ„ÇØ„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇËá™ÂàÜ„ÅåÊãÖÂΩìËÄÖ„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅÆ„ÅøÂâäÈô§ÂèØËÉΩ„Åß„Åô„ÄÇ');
                    return;
                }
            }
            
            const result = confirm(
                `„Çø„Çπ„ÇØ„Çí„Ç¢„Éº„Ç´„Ç§„Éñ„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                `„Çø„Çπ„ÇØ: ${task.title}\n\n` +
                `‚Äª „Ç¢„Éº„Ç´„Ç§„Éñ„Åã„Çâ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÂæ©ÂÖÉÂèØËÉΩ„Åß„Åô\n` +
                `‚Äª „Ç¢„Éº„Ç´„Ç§„Éñ„Åß180Êó•ÁµåÈÅéÂæå„Å´Ëá™ÂãïÂÆåÂÖ®ÂâäÈô§„Åï„Çå„Åæ„Åô`
            );
            
            if (result) {
                // „Ç¢„Éº„Ç´„Ç§„Éñ„Å´ÁßªÂãï
                const previousColumn = task.columnId;
                task.columnId = 'trash';
                task.deletedAt = new Date().toISOString();
                task.previousColumn = previousColumn; // Âæ©ÂÖÉÁî®
                
                saveTasks();
                render();
                updateStats();
                
                // „Ç¢„Éº„Ç´„Ç§„Éñ„ÅÆËá™ÂãïÂâäÈô§„ÉÅ„Çß„ÉÉ„ÇØ
                cleanupTrash();
                
                console.log(`üóëÔ∏è „Çø„Çπ„ÇØ„Äå${task.title}„Äç„Çí„Ç¢„Éº„Ç´„Ç§„Éñ„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü`);

                // ÂâäÈô§ÈÄöÁü•
                showNotification(
                    '„Çø„Çπ„ÇØ„Ç¢„Éº„Ç´„Ç§„Éñ',
                    `„Äå${task.title}„Äç„Çí„Ç¢„Éº„Ç´„Ç§„Éñ„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü`,
                    { tag: `delete-${Date.now()}` }
                );
            }
        }
        
        // „Ç¢„Éº„Ç´„Ç§„Éñ„ÅÆËá™Âãï„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÊ©üËÉΩ
        function cleanupTrash() {
            const now = new Date();
            const oneEightyDaysAgo = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);

            // ÈÄöÂ∏∏„Çø„Çπ„ÇØ„ÅÆ„Ç¢„Éº„Ç´„Ç§„Éñ„Å®„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆ„Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†„ÅÆ‰∏°Êñπ„ÇíÂØæË±°
            const trashTasks = tasks.filter(t => isTrashColumn(t.columnId));
            const expiredTasks = trashTasks.filter(t => {
                if (!t.deletedAt) return false;
                return new Date(t.deletedAt) < oneEightyDaysAgo;
            });

            if (expiredTasks.length > 0) {
                // 180Êó•ÁµåÈÅé„Åó„Åü„Çø„Çπ„ÇØ„ÇíÂÆåÂÖ®ÂâäÈô§
                tasks = tasks.filter(t => !expiredTasks.includes(t));
                saveTasks();

                console.log(`üßπ „Ç¢„Éº„Ç´„Ç§„Éñ„Åã„Çâ${expiredTasks.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíËá™ÂãïÂâäÈô§„Åó„Åæ„Åó„Åü`);

                // ÂâäÈô§ÈÄöÁü•
                if (expiredTasks.length > 0) {
                    showNotification(
                        'Ëá™Âãï„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó',
                        `„Ç¢„Éº„Ç´„Ç§„Éñ„Åã„Çâ${expiredTasks.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíËá™ÂãïÂâäÈô§„Åó„Åæ„Åó„ÅüÔºà180Êó•ÁµåÈÅéÔºâ`,
                        { tag: `cleanup-${Date.now()}` }
                    );
                }
            }
            
            // „Ç¢„Éº„Ç´„Ç§„Éñ„Åå20‰ª∂„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅÆË≠¶ÂëäÔºàÈÄöÂ∏∏„Çø„Çπ„ÇØ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰∏°ÂØæÂøúÔºâ
            const remainingTrashTasks = tasks.filter(t => isTrashColumn(t.columnId));
            if (remainingTrashTasks.length > 20) {
                console.log(`‚ö†Ô∏è „Ç¢„Éº„Ç´„Ç§„Éñ„Å´${remainingTrashTasks.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô`);
            }
        }
        
        // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆÂàá„ÇäÊõø„Åà
        function toggleHamburgerMenu() {
            console.log('üçî „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÂàá„ÇäÊõø„ÅàÈñãÂßã...');
            
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            
            if (!hamburgerMenu) {
                console.error('‚ùå hamburger-menuË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            if (!menuOverlay) {
                console.error('‚ùå menu-overlayË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const isActive = hamburgerMenu.classList.contains('active');
            
            if (isActive) {
                hamburgerMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                console.log('üçî „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Åæ„Åó„Åü');
            } else {
                hamburgerMenu.classList.add('active');
                menuOverlay.classList.add('active');
                console.log('üçî „É°„Éã„É•„Éº„ÇíÈñã„Åç„Åæ„Åó„Åü');
            }
        }
        
        // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆÊõ¥Êñ∞
        function updateHamburgerMenu() {
            const currentUser = getCurrentUser();
            console.log('üçî „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÊõ¥Êñ∞‰∏≠:', currentUser);
            
            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
            const avatar = document.getElementById('user-menu-avatar');
            const name = document.getElementById('user-menu-name');
            const role = document.getElementById('user-menu-role');
            
            if (avatar) avatar.textContent = currentUser.name ? currentUser.name.charAt(0) : '-';
            if (name) name.textContent = currentUser.name || '„Ç≤„Çπ„Éà';
            
            let roleText = '„É¶„Éº„Ç∂„Éº';
            if (currentUser.role === 'developer') roleText = 'ÈñãÁô∫ËÄÖ';
            else if (currentUser.role === 'admin') roleText = 'ÁÆ°ÁêÜËÄÖ';
            else if (currentUser.role === 'guest') roleText = 'Êú™„É≠„Ç∞„Ç§„É≥';
            if (role) role.textContent = roleText;
            
            // ÈñãÁô∫ËÄÖÊ©üËÉΩ„ÅÆË°®Á§∫Âà∂Âæ°
            const developerSection = document.getElementById('developer-menu-section');
            if (developerSection) {
                if (currentUser.role === 'developer') {
                    developerSection.style.display = 'block';
                } else {
                    developerSection.style.display = 'none';
                }
            }
            
            // Ë®∫Êñ≠„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°ÔºàÂÆåÂÖ®ÁÑ°ÂäπÂåñÔºâ
            const diagnosisBtn = document.getElementById('emergency-diagnosis-btn');
            if (diagnosisBtn) {
                diagnosisBtn.style.display = 'none';
                console.log('üîß [MENU] Ë®∫Êñ≠„Éú„Çø„É≥„ÇíÂÆåÂÖ®ÈùûË°®Á§∫');
            }
            
            // ÁÆ°ÁêÜÊ©üËÉΩ„ÅÆË°®Á§∫Âà∂Âæ°Ôºà„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Å´Èñ¢‰øÇ„Å™„ÅèÔºâ
            const adminSection = document.getElementById('admin-menu-section');
            console.log('üçî [DEBUG] adminSection found:', !!adminSection);
            if (adminSection) {
                // „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Å®ÁÆ°ÁêÜ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÅØadmin‰ª•‰∏ä„ÅÆ„ÅøÔºàID„ÅßÂèñÂæóÔºâ
                const userManagementLink = document.getElementById('user-management-link');
                const adminDashboardLink = document.getElementById('admin-dashboard-link');

                console.log('üçî [DEBUG] Links found:', {
                    userManagement: !!userManagementLink,
                    adminDashboard: !!adminDashboardLink,
                    userRole: currentUser.role
                });

                if (currentUser.role === 'developer' || currentUser.role === 'admin') {
                    adminSection.style.display = 'block';
                    if (userManagementLink) userManagementLink.style.display = 'block';
                    if (adminDashboardLink) adminDashboardLink.style.display = 'block';
                    console.log('üçî ÁÆ°ÁêÜÊ©üËÉΩ„ÇíË°®Á§∫:', currentUser.role);
                } else {
                    adminSection.style.display = 'none';
                    console.log('üçî ÁÆ°ÁêÜÊ©üËÉΩ„ÇíÈùûË°®Á§∫:', currentUser.role);
                }
            } else {
                console.error('üçî [ERROR] admin-menu-section not found in DOM');
            }
        }
        
        // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÊõ¥Êñ∞Èñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.updateHamburgerMenu = updateHamburgerMenu;
        
        
        
        
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÈñ¢Êï∞
        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem('currentSession');
                window.location.href = 'login.html';
            }
        }

        // „Éò„É´„Éó„É¢„Éº„ÉÄ„É´
        function openHelpModal() {
            const modal = document.createElement('div');
            modal.id = 'help-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: #1a202c;">Kanban Work „Éò„É´„Éó</h2>
                        <button onclick="document.getElementById('help-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #718096;">&times;</button>
                    </div>
                    <div style="color: #4a5568; line-height: 1.8;">
                        <h3 style="color: #2d3748; margin-top: 0;">Âü∫Êú¨Êìç‰Ωú</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li><strong>„Çø„Çπ„ÇØ‰ΩúÊàê:</strong> Âè≥„Éë„Éç„É´„ÅÆ„ÄåÊñ∞Ë¶è„Çø„Çπ„ÇØ„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ</li>
                            <li><strong>„Çø„Çπ„ÇØÁßªÂãï:</strong> „Ç´„Éº„Éâ„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÁßªÂãï</li>
                            <li><strong>„Çø„Çπ„ÇØÁ∑®ÈõÜ:</strong> „Ç´„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë©≥Á¥∞Ë°®Á§∫</li>
                            <li><strong>Ë§áÊï∞ÈÅ∏Êäû:</strong> Âè≥„Éë„Éç„É´„ÅÆ„ÄåË§áÊï∞ÈÅ∏Êäû„Äç„É¢„Éº„Éâ„Åß‰∏ÄÊã¨Êìç‰Ωú</li>
                        </ul>
                        <h3 style="color: #2d3748;">„Ç´„É©„É†„Å´„Å§„ÅÑ„Å¶</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li><strong>TODO:</strong> Êú™ÁùÄÊâã„ÅÆ„Çø„Çπ„ÇØ</li>
                            <li><strong>Phase 1-3:</strong> ÈÄ≤Ë°å‰∏≠„ÅÆ„Éï„Çß„Éº„Ç∫</li>
                            <li><strong>Done:</strong> ÂÆå‰∫Ü„Çø„Çπ„ÇØÔºàÁµ±Ë®à„Å´ÂèçÊò†Ôºâ</li>
                            <li><strong>Archive:</strong> „Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„ÅøÔºàÁµ±Ë®àÂØæË±°Â§ñÔºâ</li>
                        </ul>
                        <h3 style="color: #2d3748;">Áµ±Ë®à„Ç´„Éº„Éâ</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li><strong>ÊúüÈôêÂàá„Çå:</strong> ÊúüÈôê„ÇíÈÅé„Åé„Åü„Çø„Çπ„ÇØÊï∞</li>
                            <li><strong>‰ªäÊó•ÊúüÈôê:</strong> Êú¨Êó•„ÅåÊúüÈôê„ÅÆ„Çø„Çπ„ÇØÊï∞</li>
                            <li><strong>ÂÅúÊªû‰∏≠:</strong> 3Êó•‰ª•‰∏äÂêå„Åò„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Çø„Çπ„ÇØ</li>
                        </ul>
                        <h3 style="color: #2d3748;">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊ©üËÉΩ</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>Â∑¶„Éë„Éç„É´„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû</li>
                            <li>„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åî„Å®„Å´„Ç´„É©„É†„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÂèØËÉΩ</li>
                            <li>ÊãÖÂΩìËÄÖ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÂèØËÉΩ</li>
                        </ul>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button onclick="document.getElementById('help-modal').remove()" style="background: #00C9B7; color: white; border: none; padding: 0.75rem 2rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            `;
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        // üî• Ê©üËÉΩÊîπÂñÑÊõ∏„ÅØÂâäÈô§Ê∏à„Åø

        // „Éï„Ç°„Ç§„É´„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
        function handleFileImport(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            console.log(`üìÅ [IMPORT] ${files.length} files selected`);
            
            for (let file of files) {
                const fileType = file.type;
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
                    // CSV„Éï„Ç°„Ç§„É´Âá¶ÁêÜ
                    importCSV(file);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    // Excel„Éï„Ç°„Ç§„É´Âá¶ÁêÜ
                    alert('ExcelÂΩ¢Âºè„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅØÁèæÂú®ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇCSVÂΩ¢Âºè„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    alert(`„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô: ${file.name}\nÂØæÂøúÂΩ¢Âºè: CSV, TXT`);
                }
            }
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            event.target.value = '';
        }
        
        // CSV „Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
        function importCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV„Éï„Ç°„Ç§„É´„Å´„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
                        return;
                    }
                    
                    // Á∞°Âçò„Å™CSVËß£ÊûêÔºà„Çø„Çπ„ÇØÂêç, ÊúüÈôê, ÊãÖÂΩìËÄÖ, ÂÑ™ÂÖàÂ∫¶, „É°„É¢„ÅÆÈ†ÜÔºâ
                    let importedCount = 0;
                    const currentTime = new Date();
                    
                    for (let i = 1; i < lines.length; i++) {
                        const columns = lines[i].split(',').map(col => col.trim().replace(/"/g, ''));
                        
                        if (columns.length >= 1 && columns[0]) {
                            const taskTitle = columns[0];
                            const deadline = columns[1] || new Date(currentTime.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                            const assignee = columns[2] || getCurrentUser().name;
                            const priority = columns[3] || 'medium';
                            const memo = columns[4] || '';
                            
                            const newTask = {
                                id: Date.now() + i,
                                title: taskTitle,
                                deadline: new Date(deadline + 'T23:59:59').toISOString(),
                                priority: ['high', 'medium', 'low'].includes(priority) ? priority : 'medium',
                                assignees: [assignee],
                                assignee: assignee,
                                memo: memo,
                                columnId: 'todo',
                                completed: false,
                                createdAt: new Date().toISOString(),
                                comments: [],
                                attachments: [],
                                // „Çø„Çπ„ÇØÈùûË°®Á§∫Ê©üËÉΩ
                                isHidden: false
                            };
                            
                            tasks.unshift(newTask);
                            importedCount++;
                        }
                    }
                    
                    if (importedCount > 0) {
                        saveTasks();
                        render();
                        alert(`${importedCount}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
                    } else {
                        alert('„Ç§„É≥„Éù„Éº„ÉàÂèØËÉΩ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    }
                    
                } catch (error) {
                    console.error('CSV import error:', error);
                    alert('CSV„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            };
            reader.readAsText(file);
        }

        // üî• importImageWithOCRÈñ¢Êï∞„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„ÅüÔºà2025-12-16Ôºâ

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨Èñã
        window.checkTaskEvidence = checkTaskEvidence;
        window.promptForEvidence = promptForEvidence;
        window.testSlackNotification = testSlackNotification;
        window.testNotification = testNotification;

        // üî• [DELETED] toggleTaskSkipModal - Âè§„ÅÑpreviewTasksÂÆüË£Ö„ÅÆÊÆãÈ™∏„ÇíÂâäÈô§
        // ÔºàÊñ∞„Åó„ÅÑpreviewTasksModalÂÆüË£Ö„Åß„ÅØ‰∏çË¶ÅÔºâ

        // üî• [DELETED] executeImportFromModal „É©„ÉÉ„Éë„ÉºÈñ¢Êï∞„ÇíÂâäÈô§ÔºàL13136„ÅÆÊ≠£Ë¶èÂÆüË£Ö„Çí‰ΩøÁî®Ôºâ

        // ===== „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜÊ©üËÉΩ =====
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openProjectManagementModal() {
            const modal = document.getElementById('projectManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                loadNewProjectColumns(); // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„Çí„É≠„Éº„Éâ
                loadProjectsList();
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeProjectManagementModal() {
            const modal = document.getElementById('projectManagementModal');
            if (modal) {
                modal.style.display = 'none';
                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                document.getElementById('newProjectName').value = '';
                document.getElementById('newProjectDescription').value = '';
                document.getElementById('newProjectVisibility').value = 'public';
            }
        }

        // ===== ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊ©üËÉΩ =====

        // ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openAdminDashboardModal() {
            const modal = document.getElementById('adminDashboardModal');
            if (modal) {
                modal.style.display = 'flex';
                loadDashboardData();
            }
        }

        // ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeAdminDashboardModal() {
            const modal = document.getElementById('adminDashboardModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        async function loadDashboardData() {
            try {
                // „Çø„Çπ„ÇØ„ÇíÂèñÂæó
                let tasks = [];
                if (window.FirebaseDB?.getTasks) {
                    const result = await window.FirebaseDB.getTasks();
                    if (result.success) {
                        tasks = result.tasks;
                    }
                }

                // „É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');

                // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØÔºàÂÆå‰∫Ü„Éª„Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„Åø„ÇíÈô§„ÅèÔºâ
                const now = new Date();
                const overdueTasks = tasks.filter(task =>
                    task.deadline && new Date(task.deadline) < now && !isDoneColumn(task.columnId) && !isTrashColumn(task.columnId)
                );

                // ÂÅúÊªû„Çø„Çπ„ÇØÔºà3Êó•‰ª•‰∏äÂêå„Åò„Çπ„ÉÜ„Éº„Çø„Çπ„ÄÅÂÆå‰∫Ü„Éª„Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„Åø„ÇíÈô§„ÅèÔºâ
                const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
                const staleTasks = tasks.filter(task =>
                    task.lastMovedAt && new Date(task.lastMovedAt) < threeDaysAgo && !isDoneColumn(task.columnId) && !isTrashColumn(task.columnId)
                );

                // UIÊõ¥Êñ∞
                document.getElementById('dashboard-overdue-count').textContent = overdueTasks.length;
                document.getElementById('dashboard-stale-count').textContent = staleTasks.length;
                document.getElementById('dashboard-total-tasks').textContent = tasks.length;
                document.getElementById('dashboard-active-users').textContent = users.length;

                // FirebaseÁä∂ÊÖãÁ¢∫Ë™ç
                const firebaseStatus = window.firebaseAuth?.currentUser ? 'üü¢ Êé•Á∂ö‰∏≠' : 'üî¥ Êú™Êé•Á∂ö';
                document.getElementById('dashboard-firebase-status').textContent = firebaseStatus;

                // „É°„É≥„Éê„ÉºÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
                const performanceContent = document.getElementById('dashboard-performance-content');
                const userStats = {};

                tasks.forEach(task => {
                    if (task.assignee && task.assignee !== 'Êú™Ë®≠ÂÆö') {
                        if (!userStats[task.assignee]) {
                            userStats[task.assignee] = { total: 0, completed: 0 };
                        }
                        userStats[task.assignee].total++;
                        if (isDoneColumn(task.columnId)) {
                            userStats[task.assignee].completed++;
                        }
                    }
                });

                performanceContent.innerHTML = Object.entries(userStats)
                    .map(([user, stats]) => {
                        const completion = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
                                <span>${user}:</span>
                                <span style="font-weight: 600; font-size: 1.1rem; color: #0097A7;">${completion}% (${stats.completed}/${stats.total})</span>
                            </div>
                        `;
                    }).join('');

            } catch (error) {
                console.error('„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        // ===== „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜÊ©üËÉΩ =====

        // „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openUserManagementModal() {
            const modal = document.getElementById('userManagementModal');
            const iframe = document.getElementById('userManagementFrame');
            if (modal && iframe) {
                iframe.src = 'user-management.html';
                modal.style.display = 'flex';
            }
        }

        // „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeUserManagementModal() {
            const modal = document.getElementById('userManagementModal');
            const iframe = document.getElementById('userManagementFrame');
            if (modal) {
                modal.style.display = 'none';
                if (iframe) {
                    iframe.src = ''; // iframe„Çí„ÇØ„É™„Ç¢
                }
            }
        }

        // ===== „Éû„Ç§„Éö„Éº„Ç∏Ê©üËÉΩ =====

        // „Éû„Ç§„Éö„Éº„Ç∏„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openMyProfileModal() {
            const modal = document.getElementById('myProfileModal');
            const iframe = document.getElementById('myProfileFrame');
            if (modal && iframe) {
                iframe.src = 'my-profile.html';
                modal.style.display = 'flex';
            }
        }

        // „Éû„Ç§„Éö„Éº„Ç∏„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeMyProfileModal() {
            const modal = document.getElementById('myProfileModal');
            const iframe = document.getElementById('myProfileFrame');
            if (modal) {
                modal.style.display = 'none';
                if (iframe) {
                    iframe.src = ''; // iframe„Çí„ÇØ„É™„Ç¢
                }
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÅøÔºàFirebaseÂØæÂøúÔºâ
        async function loadProjectsList(forceRefresh = false) {
            try {
                const projectsList = document.getElementById('projectsList');
                if (!projectsList) return;

                // üî• FirebaseÁµ±Âêà: Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæóÔºàLocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂâäÈô§Ôºâ
                let projects = [];
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    console.log('üìÇ [PROJECTS] Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂèñÂæóÈñãÂßã...', forceRefresh ? '(Âº∑Âà∂„É™„Éï„É¨„ÉÉ„Ç∑„É•)' : '');
                    const result = await window.FirebaseDB.getProjects(forceRefresh);
                    if (result.success) {
                        projects = result.projects || [];
                        console.log(`‚úÖ [PROJECTS] FirebaseÂèñÂæóÊàêÂäü: ${projects.length}‰ª∂`);

                        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                        updateProjectsCache();
                    } else {
                        console.error('‚ùå [PROJECTS] FirebaseÂèñÂæóÂ§±Êïó:', result.error);
                        // üî• LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂâäÈô§ - „Ç®„É©„ÉºË°®Á§∫„ÅÆ„Åø
                        projects = [];
                        console.warn('‚ö†Ô∏è [PROJECTS] FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì');
                    }
                } else {
                    // üî• LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂâäÈô§ - „Ç®„É©„ÉºË°®Á§∫„ÅÆ„Åø
                    projects = [];
                    console.error('‚ùå [PROJECTS] FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì');
                }

                const currentUser = getCurrentUser();

                if (projects.length === 0) {
                    projectsList.innerHTML = `
                        <div style="text-align: center; color: #6b7280; padding: 2rem; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb;">
                            üìÇ „Åæ„Å†„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>
                            <span style="font-size: 0.9rem;">Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Å¶„ÉÅ„Éº„É†‰ΩúÊ•≠„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</span>
                        </div>
                    `;
                    return;
                }
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíË°®Á§∫
                projectsList.innerHTML = projects.map(project => {
                    const isOwner = project.createdBy === currentUser.email;
                    // üî• members„ÅåÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØÈÖçÂàó„Å´Â§âÊèõ
                    const membersArray = Array.isArray(project.members) ? project.members : [project.members];
                    const isMember = membersArray.includes(currentUser.email);
                    const canView = project.visibility === 'public' || isMember || isOwner;
                    
                    if (!canView) return '';
                    
                    const visibilityIcon = project.visibility === 'public' ? 'üåê' : 'üîí';
                    const statusIcon = project.status === 'active' ? 'üü¢' : project.status === 'completed' ? '‚úÖ' : 'üìÅ';
                    
                    return `
                        <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        ${statusIcon} ${project.name}
                                        ${visibilityIcon}
                                        ${isOwner ? '<span style="background: #fbbf24; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">‰ΩúÊàêËÄÖ</span>' : ''}
                                    </h5>
                                    <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.9rem;">${project.description || '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™¨Êòé„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'}</p>
                                    <div style="font-size: 0.8rem; color: #9ca3af;">
                                        „É°„É≥„Éê„Éº: ${membersArray.length}Âêç | ‰ΩúÊàê: ${new Date(project.createdAt).toLocaleDateString('ja-JP')}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                    <button onclick="viewProjectTasks('${project.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                        üìã „Çø„Çπ„ÇØË°®Á§∫
                                    </button>
                                    ${(isOwner || currentUser.role === 'developer') ? `
                                        <button onclick="editProject('${project.id}')" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                            ‚úèÔ∏è Á∑®ÈõÜ
                                        </button>
                                        <button onclick="deleteProject('${project.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                            ÂâäÈô§
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº:</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${membersArray.map(email => {
                                        const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                                        const user = systemUsers.find(u => u.email === email);
                                        const userName = user ? user.name : email;
                                        return `<span style="background: #f3f4f6; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${userName}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).filter(html => html).join('');
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                document.getElementById('projectsList').innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 1rem;">
                        „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}
                    </div>
                `;
            }
        }

        // üîß „Éá„Éï„Ç©„É´„Éà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†
        const DEFAULT_PROJECT_COLUMNS = ["TODO", "Phase1", "Phase2", "Phase3", "Done", "Archive"];

        // üîí „ÄêÂøÖÈ†à„Ç´„É©„É†Âà§ÂÆö„ÄëÂÆå‰∫Ü„Å®„Ç¢„Éº„Ç´„Ç§„Éñ„ÅØÂâäÈô§‰∏çÂèØ
        function isRequiredColumn(columnName) {
            if (!columnName) return false;
            const lower = columnName.toLowerCase();
            return /ÂÆå‰∫Ü|done|ÂÆåÊàê/i.test(columnName) || /„Ç¢„Éº„Ç´„Ç§„Éñ|„Ç¥„ÉüÁÆ±|trash|ÂâäÈô§/i.test(columnName);
        }

        // üîß Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç´„É©„É†ÁÆ°ÁêÜÈñ¢Êï∞
        function loadNewProjectColumns(columns = DEFAULT_PROJECT_COLUMNS) {
            const container = document.getElementById('newProjectColumnsContainer');
            if (!container) return;

            container.innerHTML = columns.map((column, index) => {
                const isRequired = isRequiredColumn(column);
                return `
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span style="cursor: move; color: #9ca3af; font-size: 1.2rem;" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà">‚ãÆ‚ãÆ</span>
                    <input type="text" value="${column}"
                           style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;"
                           ${isRequired ? 'readonly' : ''}>
                    ${isRequired ?
                        `<span style="color: #666; font-size: 0.8rem; padding: 0.25rem 0.5rem; white-space: nowrap;">üîí ÂøÖÈ†à</span>` :
                        `<button type="button" onclick="removeNewProjectColumn(${index})"
                                style="background: #ef4444; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                                ${columns.length <= 1 ? 'disabled' : ''}>
                            ‚úï
                        </button>`
                    }
                </div>
                `;
            }).join('');
        }

        function addNewProjectColumn() {
            const currentColumns = getNewProjectColumns();
            currentColumns.push('Êñ∞„Åó„ÅÑ„Ç´„É©„É†');
            loadNewProjectColumns(currentColumns);
        }

        function removeNewProjectColumn(index) {
            const currentColumns = getNewProjectColumns();
            if (currentColumns.length <= 1) {
                alert('ÊúÄ‰Ωé1„Å§„ÅÆ„Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }

            // üîí ÂøÖÈ†à„Ç´„É©„É†„ÅØÂâäÈô§‰∏çÂèØ
            const columnToRemove = currentColumns[index];
            if (isRequiredColumn(columnToRemove)) {
                alert('„ÄåÂÆå‰∫Ü„Äç„Å®„Äå„Ç¢„Éº„Ç´„Ç§„Éñ„Äç„Ç´„É©„É†„ÅØÂøÖÈ†à„ÅÆ„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            currentColumns.splice(index, 1);
            loadNewProjectColumns(currentColumns);
        }

        function getNewProjectColumns() {
            const container = document.getElementById('newProjectColumnsContainer');
            if (!container) return DEFAULT_PROJECT_COLUMNS;

            const inputs = container.querySelectorAll('input[type="text"]');
            return Array.from(inputs).map(input => input.value.trim()).filter(val => val);
        }

        // üîß Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´Áî®„ÅÆ„Ç´„É©„É†ÁÆ°ÁêÜÈñ¢Êï∞
        function loadEditProjectColumns(columns = DEFAULT_PROJECT_COLUMNS) {
            const container = document.getElementById('editProjectColumnsContainer');
            if (!container) return;

            container.innerHTML = columns.map((column, index) => {
                const isRequired = isRequiredColumn(column);
                return `
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span style="cursor: move; color: #9ca3af; font-size: 1.2rem;" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà">‚ãÆ‚ãÆ</span>
                    <input type="text" value="${column}"
                           style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;"
                           ${isRequired ? 'readonly' : ''}>
                    ${isRequired ?
                        `<span style="color: #666; font-size: 0.8rem; padding: 0.25rem 0.5rem; white-space: nowrap;">üîí ÂøÖÈ†à</span>` :
                        `<button type="button" onclick="removeEditProjectColumn(${index})"
                                style="background: #ef4444; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                                ${columns.length <= 1 ? 'disabled' : ''}>
                            ‚úï
                        </button>`
                    }
                </div>
                `;
            }).join('');
        }

        function addEditProjectColumn() {
            const currentColumns = getEditProjectColumns();
            currentColumns.push('Êñ∞„Åó„ÅÑ„Ç´„É©„É†');
            loadEditProjectColumns(currentColumns);
        }

        function removeEditProjectColumn(index) {
            const currentColumns = getEditProjectColumns();
            if (currentColumns.length <= 1) {
                alert('ÊúÄ‰Ωé1„Å§„ÅÆ„Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }

            // üîí ÂøÖÈ†à„Ç´„É©„É†„ÅØÂâäÈô§‰∏çÂèØ
            const columnToRemove = currentColumns[index];
            if (isRequiredColumn(columnToRemove)) {
                alert('„ÄåÂÆå‰∫Ü„Äç„Å®„Äå„Ç¢„Éº„Ç´„Ç§„Éñ„Äç„Ç´„É©„É†„ÅØÂøÖÈ†à„ÅÆ„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            currentColumns.splice(index, 1);
            loadEditProjectColumns(currentColumns);
        }

        function getEditProjectColumns() {
            const container = document.getElementById('editProjectColumnsContainer');
            if (!container) return DEFAULT_PROJECT_COLUMNS;

            const inputs = container.querySelectorAll('input[type="text"]');
            return Array.from(inputs).map(input => input.value.trim()).filter(val => val);
        }

        // Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
        async function createNewProject() {
            try {
                const name = document.getElementById('newProjectName').value.trim();
                const description = document.getElementById('newProjectDescription').value.trim();
                const visibility = document.getElementById('newProjectVisibility').value;
                const columns = getNewProjectColumns();
                const currentUser = getCurrentUser();

                if (!name) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                if (columns.length === 0) {
                    alert('ÊúÄ‰Ωé1„Å§„ÅÆ„Ç´„É©„É†„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                if (!currentUser.isLoggedIn) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }

                // üî• ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÂº∑Âåñ: Firebase„Åã„ÇâÊó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæó
                console.log('üîç [PROJECT CREATE] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêçÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã:', name);
                let existingProjects = [];

                if (window.FirebaseDB?.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        existingProjects = result.projects;
                        console.log(`üîç [PROJECT CREATE] Firebase: ${existingProjects.length}‰ª∂„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÁ¢∫Ë™ç`);
                    }
                }

                // üî• [REMOVED] LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂâäÈô§ÔºàFirebaseÂ∞ÇÁî®„É¢„Éº„ÉâÔºâ

                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºàÂ§ßÊñáÂ≠óÂ∞èÊñáÂ≠óÂå∫Âà•„Å™„ÅóÔºâ
                const duplicateProject = existingProjects.find(p => p.name.toLowerCase() === name.toLowerCase());
                if (duplicateProject) {
                    console.warn('‚ö†Ô∏è [PROJECT CREATE] ÈáçË§á„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊ§úÂá∫:', duplicateProject.name, `(ID: ${duplicateProject.id})`);
                    alert(`‚ùå Âêå„ÅòÂêçÂâç„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô\n\n„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç: ${duplicateProject.name}\n\nÂà•„ÅÆÂêçÂâç„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    return;
                }

                console.log('‚úÖ [PROJECT CREATE] ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü: ÂïèÈ°å„Å™„Åó');

                // üîí „ÄêÂøÖÈ†à„Ç´„É©„É†Ëá™ÂãïËøΩÂä†„ÄëÂÆå‰∫Ü„Éª„Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†„Åå„Å™„Åë„Çå„Å∞ËøΩÂä†
                const hasDone = columns.some(col => /ÂÆå‰∫Ü|done|ÂÆåÊàê/i.test(col));
                const hasTrash = columns.some(col => /„Ç¢„Éº„Ç´„Ç§„Éñ|„Ç¥„ÉüÁÆ±|trash|ÂâäÈô§/i.test(col));

                if (!hasDone) {
                    columns.push("Done");
                    console.log('üîß [PROJECT CREATE] ÂÆå‰∫Ü„Ç´„É©„É†„ÇíËá™ÂãïËøΩÂä†');
                }
                if (!hasTrash) {
                    columns.push("Archive");
                    console.log('üîß [PROJECT CREATE] „Ç¢„Éº„Ç´„Ç§„Éñ„Ç´„É©„É†„ÇíËá™ÂãïËøΩÂä†');
                }

                console.log('‚úÖ [PROJECT CREATE] „Ç´„É©„É†Á¢∫ÂÆö:', columns);

                const newProject = {
                    id: 'project_' + Date.now(),
                    name: name,
                    description: description,
                    visibility: visibility,
                    columns: columns,
                    members: [currentUser.email], // ‰ΩúÊàêËÄÖ„ÅØËá™ÂãïÁöÑ„Å´„É°„É≥„Éê„Éº„Å´„Å™„Çã
                    createdBy: currentUser.email,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                };

                // Firebase„Å´‰øùÂ≠òÔºà„Éó„É©„Ç§„Éû„É™Ôºâ
                if (window.FirebaseDB?.saveProject && window.getCurrentUser()?.isLoggedIn) {
                    console.log('üî• [PROJECT SAVE] Firebase„Å´Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰øùÂ≠ò‰∏≠...');
                    const saveResult = await window.FirebaseDB.saveProject(newProject);
                    if (saveResult.success) {
                        console.log('‚úÖ [PROJECT SAVE] Firebase‰øùÂ≠òÊàêÂäü:', saveResult.id);
                    } else {
                        console.error('‚ùå [PROJECT SAVE] Firebase‰øùÂ≠ò„Ç®„É©„Éº:', saveResult.error);
                        alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + saveResult.error);
                        return;
                    }
                } else {
                    // üî• LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅØÂâäÈô§ÔºàFirebase„ÅÆ„Åø‰ΩøÁî®Ôºâ
                    console.error('‚ùå [PROJECT SAVE] FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì');
                    alert('FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }

                console.log('‚úÖ Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê:', newProject.name, `(ID: ${newProject.id})`);

                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢„Åó„Å¶‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
                document.getElementById('newProjectName').value = '';
                document.getElementById('newProjectDescription').value = '';
                document.getElementById('newProjectVisibility').value = 'public';
                loadNewProjectColumns(); // „Ç´„É©„É†„Çí„Éá„Éï„Ç©„É´„Éà„Å´„É™„Çª„ÉÉ„Éà

                await loadProjectsList();

                // üîÑ „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº„ÇÇÊõ¥Êñ∞
                console.log('üîÑ [PROJECT CREATE] „Çµ„Ç§„Éâ„Éê„ÉºÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞ÈñãÂßã');
                render();
                console.log('‚úÖ [PROJECT CREATE] „Çµ„Ç§„Éâ„Éê„ÉºÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞ÂÆå‰∫Ü');

                alert(`‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ`);

            } catch (error) {
                console.error('‚ùå „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫
        async function viewProjectTasks(projectId) {
            try {
                closeProjectManagementModal();

                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
                const filterDropdown = document.getElementById('project-filter');
                if (filterDropdown) {
                    filterDropdown.value = projectId;
                    applyProjectFilter();
                } else {
                    // „Éï„Ç£„É´„Çø„Éº„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„Åø„ÇíË°®Á§∫
                    await filterTasksByProject(projectId);
                }

                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
                await showProjectInfo(projectId);

            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØË°®Á§∫„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åß„Çø„Çπ„ÇØ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        async function filterTasksByProject(projectId) {
            try {
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (!window.FirebaseDB || !currentUser) {
                    console.warn('‚ö†Ô∏è [FILTER] FirebaseÊú™Êé•Á∂ö - „Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Çπ„Ç≠„ÉÉ„Éó');
                    return;
                }

                // üî• selectedProjectFiltersÈÖçÂàó„ÇíÊõ¥Êñ∞Ôºàrender()„ÅåÂèÇÁÖßÔºâ
                selectedProjectFilters = [projectId];
                localStorage.setItem('currentProject', projectId);
                console.log('üìã [FILTER] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®:', projectId);

                // „Çø„Çπ„ÇØ„ÇíË™≠„ÅøËæº„Çì„ÅßÂÜçÊèèÁîª
                await loadTasks();
                render();
            } catch (error) {
                console.error('‚ùå [FILTER] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Ç®„É©„Éº:', error);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
        async function showProjectInfo(projectId) {
            // üî• Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæó
            if (!window.FirebaseDB) {
                console.warn('‚ö†Ô∏è FirebaseÊú™Êé•Á∂ö');
                return;
            }

            const result = await window.FirebaseDB.getProjects();
            if (!result.success) {
                console.error('‚ùå „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂèñÂæóÂ§±Êïó:', result.error);
                return;
            }

            const project = result.projects.find(p => p.id === projectId);

            if (project) {
                // „Éò„ÉÉ„ÉÄ„Éº„Å´„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
                const header = document.querySelector('.header h1');
                if (header) {
                    header.innerHTML = `üìÇ ${project.name} - „Çø„Çπ„ÇØÁÆ°ÁêÜ`;
                }

                console.log(`üìÇ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${project.name}„Äç„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫‰∏≠`);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ
        async function editProject(projectId) {
            try {
                // üî• Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæó
                if (!window.FirebaseDB) {
                    alert('FirebaseÊú™Êé•Á∂ö');
                    return;
                }

                const result = await window.FirebaseDB.getProjects();
                if (!result.success) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    return;
                }

                const project = result.projects.find(p => p.id === projectId);

                if (!project) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }

                const currentUser = getCurrentUser();
                const isOwner = project.createdBy === currentUser.email;
                const isDeveloper = currentUser.role === 'developer';

                if (!isOwner && !isDeveloper) {
                    alert('„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÁ∑®ÈõÜ„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }

                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                showProjectEditModal(project);

            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÁ∑®ÈõÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showProjectEditModal(project) {
            const modal = document.createElement('div');
            modal.id = 'projectEditModal';  // üîß „É¢„Éº„ÉÄ„É´„Å´ID„Çí‰ªò‰∏é
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 2100;
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;
            
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const memberOptions = systemUsers.map(user => {
                const isSelected = project.members.includes(user.email);
                return `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${isSelected ? '#dbeafe' : '#f9fafb'}; border-radius: 6px; margin-bottom: 0.5rem;">
                        <input type="checkbox" value="${user.email}" ${isSelected ? 'checked' : ''} style="margin: 0;">
                        <span>${user.name} (${user.email})</span>
                    </label>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 80vh; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.25rem;">‚úèÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ</h3>
                        <button onclick="document.getElementById('projectEditModal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>
                    
                    <div style="padding: 1.5rem; overflow-y: auto; max-height: 60vh;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç</label>
                            <input type="text" id="editProjectName" value="${project.name}" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Ë™¨Êòé</label>
                            <textarea id="editProjectDescription" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; height: 80px; resize: vertical;">${project.description}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ÂÖ¨ÈñãË®≠ÂÆö</label>
                            <select id="editProjectVisibility" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="public" ${project.visibility === 'public' ? 'selected' : ''}>üåê ÂÖ®Âì°„Å´ÂÖ¨Èñã</option>
                                <option value="private" ${project.visibility === 'private' ? 'selected' : ''}>üîí „É°„É≥„Éê„Éº„ÅÆ„Åø</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                            <select id="editProjectStatus" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="active" ${project.status === 'active' ? 'selected' : ''}>üü¢ „Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>‚úÖ ÂÆå‰∫Ü</option>
                                <option value="archived" ${project.status === 'archived' ? 'selected' : ''}>üìÅ „Ç¢„Éº„Ç´„Ç§„Éñ</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº</label>
                            <div id="membersList" style="max-height: 200px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                                ${memberOptions}
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Ç´„É©„É†Ë®≠ÂÆö</label>
                            <div id="editProjectColumnsContainer" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <!-- „Ç´„É©„É†„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ÊåøÂÖ•„Åï„Çå„Çã -->
                            </div>
                            <button type="button" onclick="addEditProjectColumn()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 500;">
                                „Ç´„É©„É†ËøΩÂä†
                            </button>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="document.getElementById('projectEditModal').remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                            <button onclick="saveProjectChanges('${project.id}', this.closest('div'))" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;">
                                ‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // „Ç´„É©„É†„ÇíË™≠„ÅøËæº„ÇÄ
            const projectColumns = project.columns || DEFAULT_PROJECT_COLUMNS;
            loadEditProjectColumns(projectColumns);
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò
        async function saveProjectChanges(projectId, modalElement) {
            try {
                const name = document.getElementById('editProjectName').value.trim();
                const description = document.getElementById('editProjectDescription').value.trim();
                const visibility = document.getElementById('editProjectVisibility').value;
                const status = document.getElementById('editProjectStatus').value;
                const columns = getEditProjectColumns();

                // „É°„É≥„Éê„Éº„É™„Çπ„Éà„ÇíÂèñÂæó
                const memberCheckboxes = modalElement.querySelectorAll('#membersList input[type="checkbox"]');
                const members = Array.from(memberCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);

                if (!name) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                if (columns.length === 0) {
                    alert('ÊúÄ‰Ωé1„Å§„ÅÆ„Ç´„É©„É†„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                if (members.length === 0) {
                    alert('Â∞ë„Å™„Åè„Å®„ÇÇ1‰∫∫„ÅÆ„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                // üî• Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
                let existingProject = null;
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        existingProject = result.projects.find(p => p.id === projectId);
                    }
                }

                if (!existingProject) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }

                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                const updatedProject = {
                    ...existingProject,
                    name: name,
                    description: description,
                    visibility: visibility,
                    status: status,
                    columns: columns,
                    members: members,
                    updatedAt: new Date().toISOString()
                };

                // üî• Firebase„Å´‰øùÂ≠ò
                if (window.FirebaseDB && window.FirebaseDB.saveProject) {
                    console.log('üî• [PROJECT UPDATE] Firebase„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞‰∏≠...');
                    const result = await window.FirebaseDB.saveProject(updatedProject);
                    if (result.success) {
                        console.log('‚úÖ [PROJECT UPDATE] FirebaseÊõ¥Êñ∞ÊàêÂäü:', result.id);
                        modalElement.remove();
                        await loadProjectsList();
                        alert(`‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${name}„Äç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ`);
                    } else {
                        console.error('‚ùå [PROJECT UPDATE] FirebaseÊõ¥Êñ∞„Ç®„É©„Éº:', result.error);
                        alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error);
                    }
                } else {
                    alert('FirebaseÊé•Á∂ö„Ç®„É©„Éº: „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÊõ¥Êñ∞„Åå„Åß„Åç„Åæ„Åõ„Çì');
                }
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§
        async function deleteProject(projectId) {
            try {
                // üî• Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæó
                if (!window.FirebaseDB || !window.FirebaseDB.getProjects) {
                    alert('FirebaseÊú™Êé•Á∂ö„ÅÆ„Åü„ÇÅ„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì');
                    return;
                }

                const result = await window.FirebaseDB.getProjects();
                if (!result.success) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    return;
                }

                const project = result.projects.find(p => p.id === projectId);
                if (!project) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const currentUser = getCurrentUser();
                const isOwner = project.createdBy === currentUser.email;
                const isDeveloper = currentUser.role === 'developer';
                
                if (!isOwner && !isDeveloper) {
                    alert('„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                if (!confirm(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${project.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n‚ö†Ô∏è „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ\n„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Èñ¢ÈÄ£„Åô„Çã„Çø„Çπ„ÇØ„ÇÇÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ`)) {
                    return;
                }
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Èñ¢ÈÄ£„Åô„Çã„Çø„Çπ„ÇØ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const tasksResult = await window.FirebaseDB.getTasks();
                const allTasks = tasksResult.success ? tasksResult.tasks : [];
                const projectTasks = allTasks.filter(task => task.projectId === projectId);

                if (projectTasks.length > 0) {
                    const action = confirm(`„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´„ÅØ${projectTasks.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„ÅåÈñ¢ÈÄ£‰ªò„Åë„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n\n„ÄåOK„Äç: „Çø„Çπ„ÇØ„ÇÇ‰∏ÄÁ∑í„Å´ÂâäÈô§\n„Äå„Ç≠„É£„É≥„Çª„É´„Äç: „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„ÅøÂâäÈô§Ôºà„Çø„Çπ„ÇØ„ÅØÂÄã‰∫∫„Çø„Çπ„ÇØ„Å´Â§âÊõ¥Ôºâ`);

                    if (action) {
                        // „Çø„Çπ„ÇØ„ÇÇ‰∏ÄÁ∑í„Å´ÂâäÈô§
                        for (const task of projectTasks) {
                            const taskId = task.firebaseId || task.id;
                            await window.FirebaseDB.deleteTask(taskId);
                        }
                        console.log(`üóëÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ${projectTasks.length}ÂÄã„ÇíÂâäÈô§`);
                    } else {
                        // „Çø„Çπ„ÇØ„ÇíÂÄã‰∫∫„Çø„Çπ„ÇØ„Å´Â§âÊõ¥
                        for (const task of projectTasks) {
                            const taskId = task.firebaseId || task.id;
                            delete task.projectId;
                            task.visibility = 'personal';
                            task.columnId = 'todo'; // ÂÄã‰∫∫„Çø„Çπ„ÇØ„ÅÆ„Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†
                            await window.FirebaseDB.updateTask(taskId, {
                                projectId: null,
                                visibility: 'personal',
                                columnId: 'todo',
                                updatedAt: new Date().toISOString()
                            });
                        }
                        console.log(`üîÑ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ${projectTasks.length}ÂÄã„ÇíÂÄã‰∫∫„Çø„Çπ„ÇØ„Å´Â§âÊõ¥`);
                    }
                }

                // üî• Firebase„Åã„ÇâÂâäÈô§
                if (window.FirebaseDB && window.FirebaseDB.deleteProject) {
                    const result = await window.FirebaseDB.deleteProject(projectId);
                    if (result.success) {
                        console.log('üóëÔ∏è [DELETE] FirebaseÂâäÈô§ÊàêÂäü:', projectId);
                    } else {
                        console.error('‚ùå [DELETE] FirebaseÂâäÈô§„Ç®„É©„Éº:', result.error);
                        throw new Error(result.error);
                    }
                } else {
                    throw new Error('FirebaseDB.deleteProject„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                }
                
                console.log('üóëÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§:', project.name);

                loadProjectsList(true); // Âº∑Âà∂„É™„Éï„É¨„ÉÉ„Ç∑„É•Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•„Çí‰ΩøÁî®„Åó„Å™„ÅÑÔºâ
                loadTasks(); // „Çø„Çπ„ÇØ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                
                alert(`üóëÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${project.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // ========================================
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£Ê©üËÉΩ
        // ========================================

        // „É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openProjectTaskCreateModal() {
            console.log('üë• [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè');
            const modal = document.getElementById('project-task-create-modal');
            modal.style.display = 'flex';

            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('pj-task-form').reset();
            setPJDefaultDeadline();

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Å®ÊãÖÂΩìËÄÖ„ÇíË™≠„ÅøËæº„Åø
            loadPJExistingProjects();
            loadPJAssignees();
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeProjectTaskCreateModal() {
            console.log('üë• [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã');
            const modal = document.getElementById('project-task-create-modal');
            modal.style.display = 'none';

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈùûË°®Á§∫
            document.getElementById('pj-task-success-message').style.display = 'none';
        }

        // „Éá„Éï„Ç©„É´„Éà„ÅÆÊúüÈôê„ÇíË®≠ÂÆö
        function setPJDefaultDeadline() {
            const now = new Date();

            // Êó•‰ªòÔºö„É≠„Éº„Ç´„É´Êó•‰ªòÂü∫Ê∫ñ„Åß‰ªäÊó•„ÇíË®≠ÂÆö
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            document.getElementById('pj-deadline-date').value = `${year}-${month}-${day}`;

            // ÊôÇÂàªÔºöÁèæÂú®ÊôÇÂàª+3ÊôÇÈñì„ÇíË®≠ÂÆö
            let hours = now.getHours() + 3;
            let minutes = now.getMinutes();

            // 24ÊôÇÈñì„ÇíË∂Ö„Åà„ÇãÂ†¥Âêà„ÅØ23:59„Å´Âà∂Èôê
            if (hours >= 24) {
                hours = 23;
                minutes = 59;
            }

            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            document.getElementById('pj-deadline-time').value = timeString;
        }

        // ÊãÖÂΩìËÄÖ‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
        async function loadPJAssignees() {
            console.log('üë• [PJ-MODAL] ÊãÖÂΩìËÄÖ‰∏ÄË¶ß„ÅÆÂãïÁöÑË™≠„ÅøËæº„ÅøÈñãÂßã');

            let assignees = [];

            // FirebaseÁµ±Âêà„É¢„Éº„Éâ: „Ç∑„Çπ„ÉÜ„É†„É¶„Éº„Ç∂„Éº„Åã„ÇâÂèñÂæó
            if (window.FirebaseDB && window.getCurrentUser()?.isLoggedIn) {
                console.log('üî• [PJ-MODAL] FirebaseÁµ±Âêà„É¢„Éº„Éâ');
                try {
                    if (window.FirebaseDB.getActiveUsers) {
                        const firebaseUsers = await window.FirebaseDB.getActiveUsers();
                        if (firebaseUsers.success && firebaseUsers.users.length > 0) {
                            // LocalStorage„ÅÆsystemUsers„ÇíÊõ¥Êñ∞
                            localStorage.setItem('systemUsers', JSON.stringify(firebaseUsers.users));
                            console.log('üîÑ [PJ-MODAL] systemUsersÊõ¥Êñ∞ÂÆå‰∫Ü');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [PJ-MODAL] FirebaseÂèñÂæó„Ç®„É©„Éº:', error);
                }
            }

            // getActiveUsersÈñ¢Êï∞„Çí‰ΩøÁî®„Åó„Å¶ÁÑ°ÂäπÂåñ„ÉªÈùûË°®Á§∫„É¶„Éº„Ç∂„Éº„ÇíÈô§Â§ñ
            const activeUserNames = getActiveUserNames();

            if (activeUserNames.length > 0) {
                assignees = activeUserNames;
                console.log('‚úÖ [PJ-MODAL] getActiveUsers „Åã„ÇâÂèñÂæó:', assignees.length, 'Âêç');
            } else {
                console.log('‚ö†Ô∏è [PJ-MODAL] „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                assignees = [];
            }

            console.log('üë• [PJ-MODAL] ÊúÄÁµÇÊãÖÂΩìËÄÖ„É™„Çπ„Éà:', assignees);

            const assigneesDiv = document.getElementById('pj-assignees');

            // Êó¢Â≠ò„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Ç¢
            assigneesDiv.innerHTML = '';

            if (assignees.length === 0) {
                assigneesDiv.innerHTML = '<p style="color: #718096;">ÊúâÂäπ„Å™„É¶„Éº„Ç∂„Éº„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜÁîªÈù¢„Åß„É¶„Éº„Ç∂„Éº„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
            } else {
                assignees.forEach(assignee => {
                    const assigneeItem = createPJCheckboxItem(assignee, 'pj-assignee');
                    assigneesDiv.appendChild(assigneeItem);
                });
            }

            console.log('‚úÖ [PJ-MODAL] ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÁîüÊàêÂÆå‰∫Ü');
        }

        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπË¶ÅÁ¥†„Çí‰ΩúÊàê
        function createPJCheckboxItem(name, type) {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            div.style.cssText = 'display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #f0f2f5; border-radius: 4px;';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `${type}-${name}`;
            input.name = type;
            input.value = name;

            const label = document.createElement('label');
            label.htmlFor = `${type}-${name}`;
            label.textContent = name;
            label.style.cursor = 'pointer';

            div.appendChild(input);
            div.appendChild(label);

            return div;
        }

        // Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
        async function loadPJExistingProjects() {
            console.log('üîç [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÈñãÂßã');

            try {
                const currentUser = window.getCurrentUser ? window.getCurrentUser() : null;
                console.log('üîç [PJ-MODAL] Current user:', currentUser);

                let projectSettings = {};
                let tasks = [];

                // FirebaseÁµ±Âêà„É¢„Éº„Éâ: Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
                if (window.FirebaseDB) {
                    console.log('üî• [PJ-MODAL] FirebaseÁµ±Âêà„É¢„Éº„Éâ - Firestore„Åã„Çâ„Éá„Éº„ÇøÂèñÂæó');

                    // Firebase„Åã„Çâ„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÇíÂèñÂæó
                    const firebaseTasks = await window.FirebaseDB.getTasks();
                    if (firebaseTasks.success) {
                        tasks = firebaseTasks.tasks;
                        console.log('üî• [PJ-MODAL] Firebase tasks loaded:', tasks.length);
                    }

                    // Ë™çË®ºÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åã„ÇâFirebase„Ç¢„ÇØ„Çª„Çπ
                    if (currentUser && currentUser.isLoggedIn && window.FirebaseDB.getProjects) {
                        console.log('üî• [PJ-MODAL] Ë™çË®ºÊ∏à„Åø - Firebase„Åã„Çâ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂèñÂæó‰∏≠...');
                        try {
                            const firebaseProjects = await window.FirebaseDB.getProjects();
                            if (firebaseProjects.success && firebaseProjects.projects.length > 0) {
                                projectSettings = {};
                                firebaseProjects.projects.forEach(project => {
                                    projectSettings[project.id] = {
                                        name: project.name,
                                        description: project.description || '',
                                        createdAt: project.createdAt,
                                        createdBy: project.createdBy || (currentUser ? currentUser.name : 'Unknown'),
                                        columns: project.columns || DEFAULT_PROJECT_COLUMNS
                                    };
                                });
                                console.log('üî• [PJ-MODAL] Firebase projects converted:', Object.keys(projectSettings).length);
                            } else {
                                console.log('üìÅ [PJ-MODAL] Firebase„Å´„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„Åó');
                            }
                        } catch (firebaseError) {
                            console.error('‚ùå [PJ-MODAL] FirebaseÂèñÂæó„Ç®„É©„Éº:', firebaseError);
                        }
                    }

                    // üî• [REMOVED] LocalStorage„Éû„Éº„Ç∏Âá¶ÁêÜ„Å®„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ„ÇíÂâäÈô§ÔºàFirebaseÂ∞ÇÁî®„É¢„Éº„ÉâÔºâ
                }

                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíÊßãÁØâ
                const existingProjects = Object.keys(projectSettings)
                    .filter(projectId => {
                        const project = projectSettings[projectId];
                        if (!project || !project.name || project.name.trim() === '') {
                            console.warn(`‚ö†Ô∏è [PJ-MODAL] ÁÑ°Âäπ„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„Çí„Çπ„Ç≠„ÉÉ„Éó: ${projectId}`);
                            return false;
                        }
                        return true;
                    })
                    .map(projectId => {
                        const project = projectSettings[projectId];
                        const projectTasks = tasks.filter(task => task.projectId === projectId);
                        const taskCount = projectTasks.length;

                        return {
                            id: projectId,
                            name: project.name.trim(),
                            description: project.description || '',
                            taskCount: taskCount,
                            createdAt: project.createdAt || new Date().toISOString(),
                            createdBy: project.createdBy || 'Unknown'
                        };
                    })
                    .filter(project => project.name && project.name !== 'undefined' && project.name !== 'null')
                    .sort((a, b) => a.name.localeCompare(b.name));

                const selectElement = document.getElementById('pj-existing-project-select');
                selectElement.innerHTML = '<option value="">-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>';

                existingProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = `${project.id}|${project.name}`;
                    option.textContent = `${project.name} (${project.taskCount}‰ª∂)`;
                    selectElement.appendChild(option);
                });

                console.log('‚úÖ [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', existingProjects.length, '‰ª∂');

                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅÆË≠¶Âëä
                if (existingProjects.length === 0) {
                    console.warn('‚ö†Ô∏è [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }

            } catch (error) {
                console.error('‚ùå [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        // Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû
        function selectExistingProjectInModal() {
            const selectElement = document.getElementById('pj-existing-project-select');
            const selectedValue = selectElement.value;

            if (selectedValue) {
                const [projectId, projectName] = selectedValue.split('|');
                document.getElementById('pj-project-id').value = projectId;
                document.getElementById('pj-project-name').value = projectName;
                console.log(`üìÇ [PJ-MODAL] Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû: ${projectId} - ${projectName}`);
            } else {
                document.getElementById('pj-project-id').value = '';
                document.getElementById('pj-project-name').value = '';
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„Çí‰ΩúÊàê
        async function createPJTask(event) {
            event.preventDefault();
            console.log('üë• [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàêÈñãÂßã...');

            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû„ÅÆÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ
            const projectId = document.getElementById('pj-project-id').value.trim();
            const projectName = document.getElementById('pj-project-name').value.trim();
            const selectedProject = document.getElementById('pj-existing-project-select').value;

            console.log('üîç [PJ-MODAL] Project validation:');
            console.log('üîç [PJ-MODAL] Selected project:', selectedProject);
            console.log('üîç [PJ-MODAL] Project ID:', projectId);
            console.log('üîç [PJ-MODAL] Project name:', projectName);

            if (!selectedProject || !projectId || !projectName) {
                alert('‚ùå „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÈÅ∏Êäû„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ\n\n„Äå„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Äç„Åß‰∫ãÂâç„Å´„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åã„Çâ„ÄÅ„Åì„Åì„Åß„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Å®„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºàFirebaseÂØæÂøúÔºâ
            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„ÄÅFirebase„Åæ„Åü„ÅØ„É≠„Éº„Ç´„É´„Å´Â≠òÂú®„Åô„Çã
            console.log('‚úÖ [PJ-MODAL] Project exists in dropdown - validation passed');

            // üî• FirebaseÂØæÂøú: „Ç∞„É≠„Éº„Éê„É´„ÅÆtasksÈÖçÂàó„Åã„ÇâÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            const taskTitle = document.getElementById('pj-task-title').value.trim();
            const duplicateTask = tasks.find(task =>
                task.projectId === projectId &&
                task.title === taskTitle
            );

            if (duplicateTask) {
                if (!confirm(`‚ö†Ô∏è Âêå„Åò„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´ÂêåÂêç„ÅÆ„Çø„Çπ„ÇØ„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„ÅôÔºö\n\n„Äå${duplicateTask.title}„Äç\n\n„Åù„Çå„Åß„ÇÇ‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }
            }

            console.log('‚úÖ [PJ-MODAL] All validations passed');

            // ÈÅ∏Êäû„Åï„Çå„ÅüÊãÖÂΩìËÄÖ„ÇíÂèñÂæó
            const selectedAssignees = Array.from(document.querySelectorAll('input[name="pj-assignee"]:checked'))
                .map(cb => cb.value);

            if (selectedAssignees.length === 0) {
                alert('ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // üî• „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂõ∫Êúâ„ÅÆ„Ç´„É©„É†ID„ÇíÂèñÂæóÔºàÊúÄÂàù„ÅÆ„Ç´„É©„É†Ôºâ
            const projectColumnId = `pj_${projectId}_0`;
            console.log('üìç [PJ-MODAL] ‰ΩøÁî®„Åô„Çã„Ç´„É©„É†ID:', projectColumnId);

            // „Çø„Çπ„ÇØ„Éá„Éº„Çø„Çí‰ΩúÊàê
            const task = {
                id: Date.now(),
                title: document.getElementById('pj-task-title').value.trim(),
                projectId: projectId,
                projectName: projectName,
                deadline: `${document.getElementById('pj-deadline-date').value}T${document.getElementById('pj-deadline-time').value}`,
                priority: document.getElementById('pj-priority').value,
                assignees: selectedAssignees,
                memo: document.getElementById('pj-memo').value,
                columnId: projectColumnId,  // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂõ∫Êúâ„ÅÆ„Ç´„É©„É†ID„Çí‰ΩøÁî®
                createdAt: new Date().toISOString(),
                comments: [],
                attachments: [],
                isProjectTask: true
            };

            console.log('üë• [PJ-MODAL] Êó¢Â≠ò„Çø„Çπ„ÇØÊï∞:', tasks.length);

            // üî• Firebase‰øùÂ≠ò
            if (!window.FirebaseDB || !window.firebaseAuth?.currentUser) {
                alert('‚ùå FirebaseÊú™Êé•Á∂ö„Åæ„Åü„ÅØ„É≠„Ç∞„Ç¢„Ç¶„ÉàÁä∂ÊÖã„Åß„Åô');
                return;
            }

            try {
                console.log('üî• [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÇíFirebase„Å´‰øùÂ≠ò‰∏≠...', task.title);
                const result = await window.FirebaseDB.createTask(task);
                if (result.success) {
                    console.log('‚úÖ [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàêÊàêÂäü:', result.id);
                    task.firebaseId = result.id;

                    // „Ç∞„É≠„Éº„Éê„É´„ÅÆtasksÈÖçÂàó„Å´ËøΩÂä†
                    tasks.push(task);
                    window.tasks = tasks;
                    console.log('üë• [PJ-MODAL] ‰øùÂ≠òÂæå„Çø„Çπ„ÇØÊï∞:', tasks.length);

                    // ÁîªÈù¢„ÇíÊõ¥Êñ∞
                    render();
                    updateStats();
                } else {
                    console.error('‚ùå [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê„Ç®„É©„Éº:', result.error);
                    alert('‚ùå „Çø„Çπ„ÇØ‰ΩúÊàê„Ç®„É©„Éº: ' + result.error);
                    return;
                }
            } catch (error) {
                console.error('‚ùå [PJ-MODAL] „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('‚ùå „Çø„Çπ„ÇØ‰øùÂ≠ò„Ç®„É©„Éº: ' + error.message);
                return;
            }

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            document.getElementById('pj-task-success-message').style.display = 'block';

            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('pj-task-form').reset();
            setPJDefaultDeadline();
            loadPJExistingProjects();

            // 2ÁßíÂæå„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            setTimeout(() => {
                closeProjectTaskCreateModal();
            }, 2000);
        }


        window.deleteTask = deleteTask;
        window.toggleHamburgerMenu = toggleHamburgerMenu;
        window.updateHamburgerMenu = updateHamburgerMenu;
        window.logout = logout;
        window.openHelpModal = openHelpModal;
        window.handleFileImport = handleFileImport;
        window.processImportText = processImportText;
        window.executeImportFromModal = executeImportFromModal;
        window.openProjectTaskCreateModal = openProjectTaskCreateModal;
        window.closeProjectTaskCreateModal = closeProjectTaskCreateModal;
        window.createPJTask = createPJTask;
        window.selectExistingProjectInModal = selectExistingProjectInModal;
        window.migrateProjectTaskColumnIds = migrateProjectTaskColumnIds; // „Éá„Éê„ÉÉ„Ç∞Áî®„Å´ÂÖ¨Èñã
    </script>
    
    <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº -->
    <div class="hamburger-menu" id="hamburger-menu">
        <div class="user-menu-info">
            <div class="user-menu-avatar" id="user-menu-avatar">-</div>
            <div class="user-menu-name" id="user-menu-name">„Ç≤„Çπ„Éà</div>
            <div class="user-menu-role" id="user-menu-role">Êú™„É≠„Ç∞„Ç§„É≥</div>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">ÂÄã‰∫∫Ë®≠ÂÆö</div>
            <a href="javascript:void(0);" class="menu-item" onclick="toggleHamburgerMenu(); openMyProfileModal();">
                <span>üë§</span>
                <span>„Éû„Ç§„Éö„Éº„Ç∏</span>
            </a>
            <a href="#" class="menu-item" onclick="openSettingsModal(); toggleHamburgerMenu(); return false;">
                <span>‚öôÔ∏è</span>
                <span>Âü∫Êú¨Ë®≠ÂÆö</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„Ç´„É©„É†„ÉªÈÄöÁü•„Éª„ÉÜ„Éº„ÉûË®≠ÂÆö</div>
            </a>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">„Çø„Çπ„ÇØÁÆ°ÁêÜ</div>
            <a href="#" class="menu-item" onclick="openTemplateManagementModal(); toggleHamburgerMenu(); return false;">
                <span>üìã</span>
                <span>„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàË°®Á§∫„Éª‰ΩúÊàê„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§</div>
            </a>
            <a href="#" class="menu-item" onclick="openTaskImportModal(); toggleHamburgerMenu(); return false;">
                <span>[+]</span>
                <span>„ÉÜ„Ç≠„Çπ„Éà„Ç§„É≥„Éù„Éº„Éà</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„ÉÜ„Ç≠„Çπ„Éà„ÉªCSV„Åã„Çâ„Çø„Çπ„ÇØ‰∏ÄÊã¨‰ΩúÊàê</div>
            </a>
        </div>
        
        <!-- Ê©üËÉΩÊîπÂñÑÊõ∏„ÅØÂâäÈô§Ê∏à„Åø -->
        
        <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„ÅØÂÖ®„É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ -->
        <div class="menu-section">
            <div class="menu-section-title">„Éó„É≠„Ç∏„Çß„ÇØ„Éà</div>
            <a href="javascript:void(0);" class="menu-item" onclick="toggleHamburgerMenu(); openProjectManagementModal();">
                <span>üèóÔ∏è</span>
                <span>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„ÉªÁÆ°ÁêÜ</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Éª„Ç´„É©„É†Ë®≠ÂÆö„Éª„É°„É≥„Éê„ÉºÁÆ°ÁêÜ</div>
            </a>
        </div>

        <div class="menu-section" id="admin-menu-section" style="display: none;">
            <div class="menu-section-title">ÁÆ°ÁêÜÊ©üËÉΩ</div>
            <a href="javascript:void(0);" id="user-management-link" class="menu-item" onclick="toggleHamburgerMenu(); openUserManagementModal();">
                <span></span>
                <span>„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</span>
            </a>
            <a href="javascript:void(0);" id="admin-dashboard-link" class="menu-item" onclick="toggleHamburgerMenu(); openAdminDashboardModal();">
                <span>üìä</span>
                <span>ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
            </a>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">„Åù„ÅÆ‰ªñ</div>
            <a href="#" class="menu-item" onclick="logout(); toggleHamburgerMenu(); return false;">
                <span>üö™</span>
                <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
            </a>
        </div>
    </div>
    
    <!-- „É°„Éã„É•„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleHamburgerMenu()"></div>
    
    <!-- Èö†„Åó„Éï„Ç°„Ç§„É´ÂÖ•Âäõ -->
    <input type="file" id="file-import" accept=".csv,.xlsx,.xls,.txt,.png,.jpg,.jpeg" multiple style="display: none;" onchange="handleFileImport(event)">

    <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="project-task-create-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üë• Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ‰ΩúÊàê</h3>
                <button class="close-btn" onclick="closeProjectTaskCreateModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="modal-left" style="width: 100%;">
                    <div id="pj-task-success-message" style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none;">
                        ‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅåÊ≠£Â∏∏„Å´‰ΩúÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ
                    </div>

                    <form id="pj-task-form" onsubmit="createPJTask(event)">
                        <div class="form-group">
                            <label class="form-label">üìù „Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´ *</label>
                            <input type="text" class="form-input" id="pj-task-title" required>
                        </div>

                        <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû -->
                        <div class="form-group">
                            <label class="form-label">üìÇ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû *</label>
                            <div style="background: #e0f7f6; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; border-left: 4px solid #0097A7;">
                                <div style="font-size: 0.9rem; color: #00796B;">
                                    üí° <strong>Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Å´„Å§„ÅÑ„Å¶</strong><br>
                                    Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅÂÖà„Å´„Äå<strong>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö</strong>„Äç„Éö„Éº„Ç∏„Åß„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
                                    ‰ΩúÊàêÂæå„ÄÅ„Åì„ÅÆ„Éö„Éº„Ç∏„Åß„Åù„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ
                                </div>
                            </div>

                            <!-- Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû -->
                            <div id="pj-existing-project-section" style="display: block;">
                                <label class="form-label">Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû:</label>
                                <select class="form-select" id="pj-existing-project-select" onchange="selectExistingProjectInModal()">
                                    <option value="">-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>
                                </select>
                            </div>

                            <!-- Èö†„Åó„Éï„Ç£„Éº„É´„ÉâÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±Ôºâ -->
                            <input type="hidden" id="pj-project-id">
                            <input type="hidden" id="pj-project-name">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">üìÖ ÊúüÈôêÊó• *</label>
                                <input type="date" class="form-input" id="pj-deadline-date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">‚è∞ ÊúüÈôêÊôÇÂàª</label>
                                <input type="time" class="form-input" id="pj-deadline-time" value="17:00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üéØ ÂÑ™ÂÖàÂ∫¶</label>
                            <select class="form-select" id="pj-priority">
                                <option value="low">‰Ωé</option>
                                <option value="medium" selected>‰∏≠</option>
                                <option value="high">È´ò</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üë• ÊãÖÂΩìËÄÖÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ*</label>
                            <div id="pj-assignees" class="checkbox-group" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üìÑ „É°„É¢</label>
                            <textarea class="form-input" id="pj-memo" rows="3"></textarea>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeProjectTaskCreateModal()">„Ç≠„É£„É≥„Çª„É´</button>
                            <button type="submit" class="btn btn-primary">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„Çí‰ΩúÊàê</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html><!-- Cache bust: 20250820-debug-buttons-removed -->
<!-- UI Update: 20250820-debug-buttons-removed -->
<!-- DEBUG BUTTONS COMPLETELY REMOVED: All Firebase debug buttons eliminated -->
