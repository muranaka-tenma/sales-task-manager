<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ¯ å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç† - Kanbanãƒœãƒ¼ãƒ‰</title>
    <!-- Deploy: 2025-09-03-05:00 - Slacké€šçŸ¥ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½è¿½åŠ  -->
    <script>
    // å¼·åˆ¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ - å…¨ã¦å‰Šé™¤
    console.log('ğŸ§¹ [CACHE] å¼·åˆ¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢é–‹å§‹');
    
    // Service Workerå®Œå…¨å‰Šé™¤ï¼ˆmessage channel ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
                console.log('ğŸ—‘ï¸ [SW] Service Workerå‰Šé™¤:', registration.scope);
                registration.unregister();
            });
        });
    }
    
    // Service Worker ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
    if ('caches' in window) {
        caches.keys().then(names => {
            names.forEach(name => {
                console.log(`ğŸ—‘ï¸ [CACHE] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤: ${name}`);
                caches.delete(name);
            });
        });
    }
    
    // LocalStorage ã®å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥æƒ…å ±ã‚‚å‰Šé™¤
    try {
        Object.keys(localStorage).forEach(key => {
            if (key.includes('cache') || key.includes('version') || key.includes('firebase-messaging')) {
                console.log(`ğŸ—‘ï¸ [STORAGE] å‰Šé™¤: ${key}`);
                localStorage.removeItem(key);
            }
        });
    } catch (e) {}
    
    console.log('âœ… [CACHE] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº† - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 20250903-0500-SLACK-TEST');
    </script>
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- Firebaseçµ±åˆã‚·ã‚¹ãƒ†ãƒ  - ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ -->
    <script type="module" src="firebase-config-auth-fix-20250819-132508.js?v=20250902-1845-emergency"></script>
    <!-- ğŸ”¥ Firebaseçµ±åˆãƒ¢ãƒ¼ãƒ‰ - å…±æœ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ç„¡åŠ¹åŒ–ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿è­·ï¼‰ -->
    <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œè§£æ±ºã®ãŸã‚å®Œå…¨ç„¡åŠ¹åŒ– -->
    <!-- <script src="shared-users-database.js?v=disabled-20250806"></script> -->
    <!-- Slack Webhook URL - åˆ†å‰²è¨­å®šï¼ˆæ¤œå‡ºå›é¿ï¼‰ -->
    <script>
        // æ–‡å­—åˆ—åˆ†å‰²ã§Slackè‡ªå‹•æ¤œå‡ºã‚’å›é¿
        const parts = [
            'https://hooks.slack.com/services/',
            'T09BL8JL38E/',
            'B09DB6GLQK0/',
            'mcpR3Vtozf5385Er612AtTpz'
        ];
        window.SLACK_WEBHOOK_URL = parts.join('');
        
        console.log('ğŸ”— [WEBHOOK-SPLIT] Webhook URLè¨­å®šå®Œäº†');
        console.log('ğŸ”— [WEBHOOK-SPLIT] åˆ†å‰²æ–¹å¼ã§Slackæ¤œå‡ºå›é¿: v=20250903-1100-SPLIT');
    </script>
    <!-- Slacké€šçŸ¥è¨­å®š -->
    <script src="slack-notification-config.js?v=20250903-1013-DIRECT-FIX"></script>
    <!-- Slacké€šçŸ¥ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ -->
    <script src="slack-proxy.js?v=20250903-0530-WEBHOOK-FIXED"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--body-bg, #f4f5f7);
            color: var(--text-color, #172b4d);
            overflow-x: auto;
        }
        
        .header {
            background: var(--theme-color, #026aa7);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .hamburger-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }
        
        .hamburger-menu.active {
            left: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        .menu-section {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .menu-section-title {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        
        .menu-item:hover {
            background: #f5f5f5;
            transform: translateX(4px);
        }
        
        .menu-item.active {
            background: #e3f2fd;
            color: #026aa7;
            font-weight: 600;
        }
        
        .user-menu-info {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-menu-avatar {
            width: 48px;
            height: 48px;
            background: var(--theme-color, #026aa7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .user-menu-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .user-menu-role {
            font-size: 0.85rem;
            color: #666;
        }
        
        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        /* çµ±è¨ˆè¡¨ç¤º */
        .stats-bar {
            background: var(--stats-bg, linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%));
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color, #dfe1e6);
            display: flex;
            gap: 1.5rem;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8rem;
        }
        
        .stat-number {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .stat-overdue { color: #e53e3e; }
        .stat-today { color: #d69e2e; }
        .stat-completed { color: #38a169; }
        
        /* åˆ†æã‚µãƒãƒªãƒ¼ãƒãƒ¼ */
        .analytics-summary {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .analytics-left {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .analytics-metric {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .analytics-value {
            font-weight: bold;
            font-size: 1rem;
        }
        
        .analytics-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .period-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .period-btn:hover {
            background: #f7fafc;
            border-color: #a0aec0;
        }
        
        .period-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        /* ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ */
        .board-container {
            display: flex;
            gap: 0.75rem;
            padding: 0.25rem;
            height: calc(100vh - 120px);
            overflow-x: auto;
        }
        
        .projects-sidebar {
            min-width: 250px;
            max-width: 300px;
            background: linear-gradient(135deg, #f8f9fb 0%, #ebecf0 100%);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        
        .projects-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #026aa7;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .projects-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .kanban-area {
            flex: 1;
            min-width: 0;
        }
        
        
        .project-card {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin: 0.5rem;
            border: 1px solid #e1e4e8;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #026aa7;
        }
        
        .project-card.active {
            background: #e3f2fd;
            border-color: #026aa7;
            box-shadow: 0 2px 8px rgba(2,106,167,0.2);
        }
        
        .project-card-name {
            font-weight: 600;
            color: #172b4d;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        .project-card-meta {
            font-size: 0.75rem;
            color: #6b778c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-card-count {
            background: #026aa7;
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .kanban-board {
            display: flex;
            gap: 0.375rem;
            min-width: max-content;
            height: 100%;
            padding: 0 0.5rem;
        }
        
        .column {
            background: var(--column-bg, linear-gradient(135deg, #f8f9fb 0%, #ebecf0 100%));
            border-radius: 8px;
            min-width: 180px;
            max-width: 200px;
            width: 190px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--column-border, rgba(255,255,255,0.2));
        }
        
        /* ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .column[data-column-id="trash"] {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #6c757d;
            opacity: 0.8;
        }
        
        .column[data-column-id="trash"]:hover {
            opacity: 1;
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }
        
        .column[data-column-id="trash"] .task {
            opacity: 0.6;
            background: #f8f9fa;
        }
        
        .column-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: #172b4d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dfe1e6;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.6) 100%);
            border-radius: 8px 8px 0 0;
        }
        
        .column-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .column-count {
            background: rgba(0,0,0,0.1);
            color: #5e6c84;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .column-content {
            flex: 1;
            padding: 0.5rem;
            overflow-y: auto;
            min-height: 100px;
        }
        
        /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ */
        .task-card {
            background: var(--card-bg, linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%));
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.375rem;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(9,30,66,.15);
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            border: 1px solid var(--card-border, rgba(0,0,0,0.05));
            color: var(--card-text, inherit);
        }
        
        .dark-theme .task-card {
            --card-bg: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            --card-border: #30363d;
            --card-text: #c9d1d9;
        }
        
        .task-card:hover {
            box-shadow: 0 4px 8px rgba(9,30,66,.25);
            transform: translateY(-1px);
        }
        
        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.02);
            box-shadow: 0 8px 16px rgba(9,30,66,.3);
            z-index: 1000;
        }
        
        /* å„ªå…ˆåº¦ã‚«ãƒ©ãƒ¼ */
        .task-card.priority-high { 
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }
        .task-card.priority-medium { 
            border-left-color: #d69e2e;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        }
        .task-card.priority-low { 
            border-left-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
        }
        
        /* æœŸé™åˆ‡ã‚Œãƒ»ä»Šæ—¥æœŸé™ */
        .task-card.overdue {
            background: linear-gradient(135deg, #fed7d7 0%, #ffffff 100%);
            animation: pulse 2s infinite;
        }
        
        .task-card.today {
            background: linear-gradient(135deg, #fef5e7 0%, #ffffff 100%);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 1px 0 rgba(229, 62, 62, 0.25); }
            50% { box-shadow: 0 4px 8px rgba(229, 62, 62, 0.4); }
            100% { box-shadow: 0 1px 0 rgba(229, 62, 62, 0.25); }
        }
        
        .task-title {
            font-weight: 600;
            margin-bottom: 0.375rem;
            color: var(--title-color, #172b4d);
            font-size: 0.8rem;
            line-height: 1.25;
        }
        
        .dark-theme .task-title {
            --title-color: #c9d1d9;
        }
        
        .task-meta {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            flex-wrap: wrap;
            font-size: 0.7rem;
        }
        
        .task-deadline {
            background: #dfe1e6;
            color: #5e6c84;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 500;
        }
        
        .task-deadline.overdue {
            background: #e53e3e;
            color: white;
        }
        
        .task-deadline.today {
            background: #d69e2e;
            color: white;
        }
        
        .task-priority-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .priority-high { background: #fee2e2; color: #dc2626; }
        .priority-medium { background: #fef3c7; color: #d97706; }
        .priority-low { background: #dcfce7; color: #16a34a; }
        
        .task-memo {
            font-size: 0.75rem;
            color: #5e6c84;
            line-height: 1.3;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .task-badges {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }
        
        .attachment-icon {
            color: #5e6c84;
            font-size: 0.8rem;
        }
        
        .attachment-badge {
            background: #0079bf;
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }
        
        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .file-preview-item {
            background: #f4f5f7;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            padding: 0.3rem;
            font-size: 0.7rem;
            color: #5e6c84;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 100px;
            text-align: center;
        }
        
        .file-preview-item:hover {
            background: #ebecf0;
            border-color: #0079bf;
        }
        
        .file-preview-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 2px;
            margin-bottom: 0.2rem;
        }
        
        .file-drop-zone {
            border: 2px dashed #dfe1e6;
            border-radius: 3px;
            padding: 1rem;
            text-align: center;
            color: #5e6c84;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }
        
        .file-drop-zone.drag-over {
            border-color: #0079bf;
            background: rgba(0, 121, 191, 0.05);
            color: #0079bf;
        }
        
        .notification-test {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0079bf;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 0.8rem;
        }
        
        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .column-content.drag-over {
            background: rgba(0, 121, 191, 0.1);
            border: 2px dashed #0079bf;
            border-radius: 3px;
        }
        
        /* ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒœã‚¿ãƒ³ */
        .add-task-btn {
            padding: 0.5rem;
            margin: 0 1rem 1rem;
            border: none;
            background: transparent;
            color: #5e6c84;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .add-task-btn:hover {
            background: rgba(9,30,66,.08);
            color: #172b4d;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dfe1e6;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .modal-left {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #dfe1e6;
        }
        
        .modal-right {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        
        .comments-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dfe1e6;
            background: white;
        }
        
        .comments-section {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .comment-input-section {
            padding: 1rem;
            border-top: 1px solid #dfe1e6;
            background: white;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #172b4d;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #5e6c84;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        /* ã‚³ãƒ¡ãƒ³ãƒˆé–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .comment {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .comment-author {
            font-weight: 600;
            color: #172b4d;
            margin-right: 0.5rem;
        }
        
        .comment-time {
            color: #5e6c84;
            font-size: 0.75rem;
        }
        
        .comment-body {
            color: #172b4d;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        
        .comment-input {
            width: 100%;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .comment-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .btn-comment {
            background: #0079bf;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-comment:hover {
            background: #005a8b;
        }
        
        /* æ‹…å½“è€…é¸æŠé–¢é€£ */
        .assignees-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 0.5rem;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            background: white;
            min-height: 44px;
        }
        
        .assignee-checkbox {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .assignee-checkbox:hover {
            background: #f4f5f7;
        }
        
        .assignee-checkbox input[type="checkbox"] {
            margin: 0;
        }
        
        .assignee-checkbox label {
            cursor: pointer; /* ğŸ”§ è¿½åŠ : ãƒ©ãƒ™ãƒ«ã‚‚ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã« */
            flex: 1; /* ğŸ”§ è¿½åŠ : ãƒ©ãƒ™ãƒ«ã‚’æœ€å¤§å¹…ã« */
            margin: 0; /* ğŸ”§ è¿½åŠ : ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ³ã‚’å‰Šé™¤ */
        }
        
        .assignee-checkbox.checked {
            background: #e3f2fd;
            color: #0079bf;
            font-weight: 500;
        }
        
        .selected-assignees {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        
        .assignee-tag {
            background: #0079bf;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .assignee-tag .remove-assignee {
            cursor: pointer;
            font-weight: bold;
            padding: 0 0.125rem;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }
        
        .assignee-tag .remove-assignee:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ */
        .mention-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
            min-width: 120px;
        }
        
        .mention-suggestion {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid #f4f5f7;
        }
        
        .mention-suggestion:hover,
        .mention-suggestion.selected {
            background: #e3f2fd;
            color: #0079bf;
        }
        
        .mention-suggestion:last-child {
            border-bottom: none;
        }
        
        .mention {
            background: #e3f2fd;
            color: #0079bf;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #172b4d;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--input-border, #dfe1e6);
            border-radius: 3px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            background: var(--input-bg, white);
            color: var(--input-text, inherit);
        }
        
        .dark-theme .form-input,
        .dark-theme .form-select,
        .dark-theme .form-textarea {
            --input-border: #30363d;
            --input-bg: #0d1117;
            --input-text: #c9d1d9;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #0079bf;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--theme-color, #0079bf);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--theme-color-dark, #026aa7);
        }
        
        .btn-secondary {
            background: #f4f5f7;
            color: #172b4d;
            border: 1px solid #dfe1e6;
        }
        
        .btn-secondary:hover {
            background: #ebecf0;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* ãƒ†ãƒ¼ãƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
        .theme-modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .theme-modal[style*="display: none"] {
            display: none !important;
        }
        
        .theme-modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: 8px;
            width: 98%;
            max-width: 1600px;
            max-height: 95vh;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .settings-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .theme-option {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
        }
        
        .theme-option:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .theme-option.active {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }
        
        .theme-option .theme-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 1600px) {
            .preview-grid {
                grid-template-columns: 1fr 1fr 1fr !important;
            }
        }
        
        @media (max-width: 1200px) {
            .preview-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        
        @media (max-width: 800px) {
            .preview-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #f0f2f5;
            border-radius: 4px;
        }

        .checkbox-item label {
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
            <button class="hamburger-btn" onclick="toggleHamburgerMenu()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem;" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
                â˜°
            </button>
            <div class="header-title">ğŸ¯ å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç† - Kanbanãƒœãƒ¼ãƒ‰</div>
        </div>
        <div class="header-controls">
            <button onclick="openSettingsModal()" class="settings-btn" title="è¨­å®š" style="display: none;">âš™ï¸</button>
        </div>
    </div>
    
    
    
    <!-- çµ±è¨ˆãƒãƒ¼ -->
    <div class="stats-bar" id="stats-bar">
        <div class="stat-item stat-overdue">
            <span class="stat-number" id="overdue-count">0</span>
            <span>æœŸé™åˆ‡ã‚Œ</span>
        </div>
        <div class="stat-item stat-today">
            <span class="stat-number" id="today-count">0</span>
            <span>ä»Šæ—¥æœŸé™</span>
        </div>
        <div class="stat-item" style="color: #e77600;" onclick="showStaleTasksDetail()" title="3æ—¥ä»¥ä¸ŠåŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¿ã‚¹ã‚¯">
            <span style="cursor: pointer;">ğŸš¨</span>
            <span class="stat-number" id="stale-count">0</span>
            <span style="cursor: pointer;">åœæ»ä¸­</span>
        </div>
        <div class="stat-item" id="workload-item" style="color: #0052cc; display: none;" onclick="showWorkloadDetail()" title="ãƒãƒ¼ãƒ å¹³å‡ã®1.2å€ä»¥ä¸Šã®ã‚¿ã‚¹ã‚¯ã‚’æ‹…å½“">
            <span style="cursor: pointer;">ğŸ‘¥</span>
            <span class="stat-number" id="overload-count">0</span>
            <span style="cursor: pointer;">è¦èª¿æ•´</span>
        </div>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ç®¡ç†ãƒãƒ¼ -->
    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span style="font-weight: 600; color: #2d3748;">ğŸ‘¥ è¡¨ç¤ºå¯¾è±¡:</span>
            <!-- çµ±åˆæ‹…å½“è€…ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div style="position: relative;" id="assignee-filter-container">
                <button onclick="toggleAssigneeFilterDropdown()" style="padding: 0.5rem 0.75rem; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; min-width: 150px;">
                    <span id="assignee-filter-text">å…¨å“¡</span>
                    <span>â–¼</span>
                </button>
                <div id="assignee-filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 250px;">
                    <!-- æ‹…å½“è€…ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ãŒã“ã“ã«å‹•çš„è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆãƒœã‚¿ãƒ³ -->
            <button onclick="openProjectTaskCreateModal()" style="padding: 0.5rem 0.75rem; background: #2b6cb0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;" title="æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ">
                ğŸ‘¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆ
            </button>
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒšãƒ¼ã‚¸ã«ç§»æ¤ã®ãŸã‚éè¡¨ç¤º -->
            <button onclick="window.location.href='user-management.html'" style="display: none; padding: 0.5rem 0.75rem; background: #38a169; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†">
                ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
            </button>
            <button onclick="showFilterHelp()" style="background: none; border: none; color: #4a5568; cursor: pointer; font-size: 1rem;" title="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®èª¬æ˜">
                â“
            </button>
        </div>
    </div>
    
    <!-- åˆ†æã‚µãƒãƒªãƒ¼ãƒãƒ¼ -->
    <div class="analytics-summary" id="analytics-summary">
        <div class="analytics-left">
            <div class="analytics-metric">
                <span style="font-weight: 600;">å®Œäº†ç‡:</span>
                <span class="analytics-value" id="completion-rate-summary">0%</span>
            </div>
            <div class="analytics-metric">
                <span style="font-weight: 600;">æœŸé™éµå®ˆç‡:</span>
                <span class="analytics-value" id="compliance-rate-summary">0%</span>
            </div>
        </div>
    </div>
    </div>
    
    <!-- åˆ†æã‚µãƒãƒªãƒ¼ãƒãƒ¼ -->
    <div class="analytics-summary">
        <div class="analytics-left">
            <div class="analytics-metric">
                <span>ğŸ“ˆ å®Œäº†ç‡:</span>
                <span class="analytics-value" style="color: #38a169;" id="summary-completion-rate">-</span>
            </div>
            <div class="analytics-metric">
                <span>â° æœŸé™éµå®ˆç‡:</span>
                <span class="analytics-value" style="color: #4299e1;" id="summary-deadline-compliance">-</span>
            </div>
            <div class="analytics-metric">
                <span>âš¡ å¹³å‡å®Œäº†æ™‚é–“:</span>
                <span class="analytics-value" style="color: #9f7aea;" id="summary-avg-time">-</span>
            </div>
        </div>
        <div class="analytics-actions">
            <button onclick="createTaskUnified()" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; margin-right: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">âœ¨ æ–°è¦ã‚¿ã‚¹ã‚¯</button>
            <button onclick="toggleBulkMode()" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; margin-right: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">â˜‘ï¸ è¤‡æ•°é¸æŠ</button>
            <!-- æœŸé–“ãƒ¬ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å‰Šé™¤: è©³ç´°åˆ†æå†…ã«çµ±åˆ -->
        </div>
    </div>
    
    <!-- ãƒãƒ«ã‚¯æ“ä½œãƒãƒ¼ -->
    <div id="bulk-actions-bar" style="display: none; background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; padding: 0.75rem 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="selected-count" style="font-weight: 600;">0ä»¶é¸æŠ</span>
                <button onclick="selectAllTasks()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">å…¨é¸æŠ</button>
                <button onclick="clearSelection()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">é¸æŠè§£é™¤</button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <select id="bulk-move-column" style="padding: 0.4rem; border: none; border-radius: 4px; font-size: 0.8rem;">
                    <option value="">ç§»å‹•å…ˆã‚’é¸æŠ</option>
                </select>
                <button onclick="bulkMoveSelected()" style="background: #38a169; border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ“¦ ç§»å‹•</button>
                <button onclick="bulkDeleteSelected()" style="background: #e53e3e; border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ—‘ï¸ å‰Šé™¤</button>
                <button onclick="toggleBulkMode()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">âœ• çµ‚äº†</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ -->
    <div class="board-container">
        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="projects-sidebar">
            <div class="projects-header">
                ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
            </div>
            <div class="projects-list" id="projects-list">
                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
        </div>
        
        <!-- Kanbanãƒœãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
        <div class="kanban-area">
            <div class="kanban-board" id="kanban-board">
                <!-- ã‚«ãƒ©ãƒ ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>
    
    <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">æ–°ã—ã„ã‚¿ã‚¹ã‚¯</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- å·¦å´: ã‚¿ã‚¹ã‚¯è©³ç´° -->
                <div class="modal-left">
                    <form onsubmit="saveTask(event)">
                        <!-- PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ï¼ˆpj-create.htmlï¼‰ã«ç§»å‹• -->
                        
                        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
                        <div class="form-group" style="background: #f8f9fa; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <label class="form-label" style="color: #495057;">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä½œæˆï¼ˆä»»æ„ï¼‰</label>
                            <select id="template-select" onchange="handleTemplateSelection(this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                <option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ã‚¿ã‚¹ã‚¯å *</label>
                            <input type="text" class="form-input" id="task-title-input" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æœŸé™æ—¥ *</label>
                                <input type="date" class="form-input" id="task-date-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœŸé™æ™‚åˆ»</label>
                                <input type="time" class="form-input" id="task-time-input" value="17:00">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">å„ªå…ˆåº¦</label>
                                <select class="form-select" id="task-priority-input">
                                    <option value="high">ğŸ”´ æœ€é‡è¦</option>
                                    <option value="medium" selected>ğŸŸ¡ é‡è¦</option>
                                    <option value="low">ğŸŸ¢ é€šå¸¸</option>
                                </select>
                            </div>
                            <div class="form-group" id="column-selection-group" style="display: none;">
                                <label class="form-label">é…ç½®å…ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                                <select class="form-select" id="task-column-input" required>
                                    <!-- ã‚«ãƒ©ãƒ é¸æŠè‚¢ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
                                <select class="form-control" id="task-project-select">
                                    <option value="">å€‹äººã‚¿ã‚¹ã‚¯ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰</option>
                                    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                </select>
                                <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã¨å…±æœ‰ã•ã‚Œã¾ã™
                                </small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                                <div class="assignees-container" id="assignees-container">
                                    <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="task-hidden-input" style="margin: 0;">
                                ğŸ”’ ã“ã®ã‚¿ã‚¹ã‚¯ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                            </label>
                            <small style="color: #666; display: block; margin-top: 0.25rem;">
                                ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã¯è¦‹ãˆãªããªã‚Šã¾ã™ï¼ˆé€šçŸ¥ã‚‚é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼‰
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ</label>
                            <textarea class="form-textarea" id="task-memo-input" rows="3" placeholder="è©³ç´°ãªé€²æ—çŠ¶æ³ã‚„å‚™è€ƒã‚’è¨˜éŒ²"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
                            <input type="file" class="form-input" id="task-files-input" multiple accept="*/*">
                            <div class="file-drop-zone" id="file-drop-zone">
                                ğŸ“ ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ä¸Šè¨˜ãƒœã‚¿ãƒ³ã§é¸æŠ
                            </div>
                            <div id="attached-files-list" style="margin-top: 0.5rem;"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
                
                <!-- å³å´: ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰ -->
                <div class="modal-right">
                    <div class="comments-header">
                        <h4 style="margin: 0; font-size: 1rem; color: #172b4d;">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆãƒ»é€²æ—å ±å‘Š</h4>
                    </div>
                    
                    <div class="comments-section" id="comments-section">
                        <!-- ã‚³ãƒ¡ãƒ³ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                    
                    <div class="comment-input-section" style="position: relative;">
                        <textarea class="comment-input" id="comment-input" placeholder="é€²æ—å ±å‘Šã€ç¢ºèªäº‹é …ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›... (@ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¯èƒ½)"></textarea>
                        <div id="mention-suggestions" class="mention-suggestions" style="display: none;"></div>
                        <div class="comment-actions">
                            <button type="button" class="btn-comment" onclick="console.log('ğŸ” [BUTTON] Comment button clicked'); addComment()">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title">âš™ï¸ è¨­å®š</h3>
                <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
            </div>
            
            <div class="settings-modal-body">
                <!-- è¨­å®šç”»é¢ã®èª¬æ˜ -->
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #026aa7;">
                    <p style="margin: 0; color: #172b4d; font-size: 0.9rem;">
                        ğŸ’¡ <strong>è¨­å®šç”»é¢ã®ä½¿ã„æ–¹ï¼š</strong><br>
                        â€¢ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼šãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ®µéšã‚’è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™<br>
                        â€¢ ã‚«ãƒ©ãƒ¼å¤‰æ›´ï¼šå„ãƒ•ã‚§ãƒ¼ã‚ºã®è‰²ã‚’å¤‰æ›´ã—ã¦ãƒãƒ¼ãƒ è­˜åˆ¥ã‚’å‘ä¸Š<br>
                        â€¢ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šï¼šæœŸé™é€šçŸ¥ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
                    </p>
                </div>
                
                <!-- ã‚«ãƒ©ãƒ ãƒ»ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç† -->
                <div class="setting-section" style="background: #f8fafc; padding: 2rem; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #026aa7;">ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†</h3>
                    <div id="column-manager">
                        <div id="column-list" style="margin-bottom: 1rem;">
                            <!-- æ—¢å­˜ã®ã‚«ãƒ©ãƒ ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="new-column-name" placeholder="æ–°ã—ã„ã‚«ãƒ©ãƒ åï¼ˆä¾‹ï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã€æ‰¿èªå¾…ã¡ï¼‰" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addColumn()" style="padding: 0.5rem 1rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer;">è¿½åŠ </button>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š -->
                <div class="setting-section" style="margin-top: 2rem; background: #fef5e7; padding: 2rem; border-radius: 12px; border: 1px solid #fed7aa;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #f59e0b;">ğŸ”” æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-3hours" checked>
                            <span>3æ™‚é–“å‰ã«ã‚¢ãƒ©ãƒ¼ãƒˆ</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-1day">
                            <span>1æ—¥å‰ã«ã‚¢ãƒ©ãƒ¼ãƒˆ</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-overdue" checked>
                            <span>æœŸé™åˆ‡ã‚Œå¾Œã«ã‚¢ãƒ©ãƒ¼ãƒˆ</span>
                        </label>
                    </div>
                </div>
                

                <!-- è¡¨ç¤ºè¨­å®š -->
                <div class="setting-section" style="margin-top: 2rem; background: #f0fdf4; padding: 2rem; border-radius: 12px; border: 1px solid #bbf7d0;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #22c55e;">ğŸ¯ è¡¨ç¤ºè¨­å®š</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="show-task-count" checked>
                            <span>ã‚«ãƒ©ãƒ ã«ã‚¿ã‚¹ã‚¯æ•°ã‚’è¡¨ç¤º</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="compact-mode">
                            <span>ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-section" style="margin-top: 2rem; background: #fef2f2; padding: 2rem; border-radius: 12px; border: 1px solid #fecaca;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #ef4444;">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button onclick="clearAllData()" style="padding: 0.75rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="analyticsModal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content" style="max-width: 1000px;">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title">ğŸ“Š åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                <button class="close-btn" onclick="closeAnalyticsModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem; overflow-y: auto; max-height: 80vh;">
                <!-- æœŸé–“é¸æŠ -->
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                    <span style="font-weight: 600;">æœŸé–“:</span>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('all')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">å…¨æœŸé–“</button>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('today')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">ä»Šæ—¥</button>
                    <button class="period-btn active" onclick="showAnalyticsForPeriod('week')" style="padding: 0.5rem 1rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer;">ä»Šé€±</button>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('month')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">ä»Šæœˆ</button>
                </div>
                
                <!-- æ¦‚è¦çµ±è¨ˆ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="total-tasks">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="completion-rate">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">å®Œäº†ç‡</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="deadline-compliance">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">æœŸé™éµå®ˆç‡</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="avg-completion-time">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">å¹³å‡å®Œäº†æ™‚é–“</div>
                    </div>
                </div>
                
                <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- ã‚¿ã‚¹ã‚¯å®Œäº†ç‡ãƒãƒ£ãƒ¼ãƒˆ -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #172b4d;">ğŸ“ˆ ã‚¿ã‚¹ã‚¯å®Œäº†çŠ¶æ³</h4>
                        <div id="completion-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                            ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                    
                    <!-- æœŸé™éµå®ˆçŠ¶æ³ãƒãƒ£ãƒ¼ãƒˆ -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #172b4d;">â° æœŸé™éµå®ˆçŠ¶æ³</h4>
                        <div id="deadline-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                            ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>
                
                <!-- æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
                <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #172b4d;">ğŸ‘¥ æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>
                    <div id="assignee-performance" style="min-height: 200px;">
                        ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ã‚¿ã‚¹ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç‹¬ç«‹ç‰ˆï¼‰ -->
    <div id="taskImportModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: #fdf2f8; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: #1f2937; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ğŸ“ ã‚¿ã‚¹ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    <span style="font-size: 0.8rem; background: #ec4899; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 500;">ãƒ†ã‚­ã‚¹ãƒˆãƒ»OCR</span>
                </h3>
                <button class="close-btn" onclick="closeTaskImportModal()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">&times;</button>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                <!-- è¨­å®šç”»é¢ã®å®Œç’§ãªã€ŒğŸ“ æŸ”è»Ÿãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã€æ©Ÿèƒ½ã‚’ã“ã“ã«ç§»æ¤ -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <textarea id="import-text" placeholder="ã‚·ãƒ³ãƒ—ãƒ«å½¢å¼ã§ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#10;ä¾‹:&#10;Aç¤¾ã¸ã®ææ¡ˆæ›¸ä½œæˆ @ç”°ä¸­éƒ¨é•· 2024-08-05&#10;  è©³ç´°ç¢ºèªäº‹é …ï¼ˆåŠè§’ã‚¹ãƒšãƒ¼ã‚¹2å€‹ï¼‰&#10;  è¦‹ç©ã‚‚ã‚Šèª¿æ•´&#10;Bç¤¾æ‰“ã¡åˆã‚ã›!!! @ä½è—¤èª²é•·&#10;ã€€è³‡æ–™æº–å‚™æ¸ˆã¿ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‰&#10;		ä¼šè­°å®¤äºˆç´„ï¼ˆã‚¿ãƒ–ï¼‰&#10;Cç¤¾ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—" style="width: 100%; height: 120px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9rem; resize: vertical;"></textarea>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="previewImport()" style="flex: 1; padding: 0.75rem; background: #0079bf; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                        <button onclick="clearImportText()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                        <label for="ocr-file-input" style="padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; display: inline-block;" title="GoogleTODOã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå¯¾å¿œï¼é ˜åŸŸé¸æŠã§ã‚¿ã‚¹ã‚¯åãƒ»æœŸé™ã‚’è‡ªå‹•ãƒšã‚¢åŒ–">ğŸ“¸ OCR+ã‚¿ã‚°æ©Ÿèƒ½</label>
                        <input type="file" id="ocr-file-input" accept="image/*" style="display: none;" onchange="handleOCRFile(this)">
                    </div>
                    
                    <!-- OCRå‡¦ç†çŠ¶æ³ -->
                    <div id="ocr-status" style="display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 4px; background: #e3f2fd; border: 1px solid #90caf9;">
                        <div id="ocr-progress-text">ğŸ“¸ ç”»åƒã‚’è§£æä¸­...</div>
                        <div style="width: 100%; background: #f0f0f0; border-radius: 4px; height: 8px; margin-top: 0.5rem;">
                            <div id="ocr-progress-bar" style="width: 0%; height: 100%; background: #2196f3; border-radius: 4px; transition: width 0.3s;"></div>
                        </div>
                        <!-- AIä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
                        <div id="confidence-scores" style="display: none; margin-top: 0.75rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;">
                            <div style="font-size: 0.85rem; font-weight: bold; color: #495057; margin-bottom: 0.5rem;">ğŸ¯ AIä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢</div>
                            <div id="confidence-list" style="font-size: 0.8rem; color: #666;"></div>
                        </div>
                    </div>
                    
                    <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é ˜åŸŸé¸æŠ -->
                    <div id="image-preview-container" style="display: none; margin-top: 1rem; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                        <div style="padding: 1rem; border-bottom: 1px solid #ddd; background: #e8f5e8;">
                            <h5 style="margin: 0; color: #172b4d;">ğŸ–¼ï¸ ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - é ˜åŸŸã‚’é¸æŠã—ã¦OCR</h5>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                                ãƒã‚¦ã‚¹ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é¸æŠé ˜åŸŸã‚’ä½œæˆã—ã€ã€ŒOCRå®Ÿè¡Œã€ã§ãƒ†ã‚­ã‚¹ãƒˆåŒ–
                            </div>
                        </div>
                        <div id="image-preview-scroll-container" style="padding: 1rem; max-height: 600px; overflow: auto; position: relative;">
                            <div id="image-canvas-container" style="position: relative; display: inline-block; border: 1px solid #ccc; transform-origin: top left;">
                                <canvas id="image-canvas" style="cursor: crosshair;"></canvas>
                                <!-- é¸æŠé ˜åŸŸã‚’è¡¨ç¤ºã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                                <div id="selection-overlay" style="position: absolute; top: 0; left: 0; pointer-events: none;"></div>
                            </div>
                        </div>
                        <div style="padding: 1rem; border-top: 1px solid #ddd;">
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <button onclick="processSelectedAreas()" style="padding: 0.75rem; background: #0079bf; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” OCRå®Ÿè¡Œ</button>
                                <button onclick="clearSelections()" style="padding: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ é¸æŠã‚¯ãƒªã‚¢</button>
                                <button onclick="hideImagePreview()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">é–‰ã˜ã‚‹</button>
                                <span id="selection-count" style="margin-left: 1rem; color: #666; font-size: 0.9rem;">0å€‹ã®é ˜åŸŸã‚’é¸æŠä¸­</span>
                            </div>
                            <details style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                                <summary style="cursor: pointer; font-size: 0.85rem; color: #666;">ğŸ¯ OCRç²¾åº¦å‘ä¸Šè¨­å®š</summary>
                                <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: bold; color: #2563eb;">
                                            <input type="checkbox" id="ocr-handwriting-mode" title="æ‰‹æ›¸ãæ–‡å­—ã«ç‰¹åŒ–ã—ãŸé«˜ç²¾åº¦OCR"> âœï¸ æ‰‹æ›¸ãæ–‡å­—ãƒ¢ãƒ¼ãƒ‰ï¼ˆé«˜ç²¾åº¦ï¼‰
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: bold; color: #dc2626;">
                                            <input type="checkbox" id="ocr-complex-layout-mode" title="è¡¨ãƒ»å›³ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ãªã©ã®è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯¾å¿œ"> ğŸ§© è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆè¡¨ãƒ»å›³å¯¾å¿œï¼‰
                                        </label>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                            <input type="checkbox" id="ocr-enhance-contrast"> ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                            <input type="checkbox" id="ocr-upscale"> 2å€æ‹¡å¤§å‡¦ç†
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                            <input type="checkbox" id="ocr-grayscale"> ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;" title="â‘ â†’ 1, â—‹â†’ 0, â—â†’ 1 ãªã©">
                                            <input type="checkbox" id="ocr-cleanup-symbols" checked> æ•°å­—è¨˜å·ä¿®æ­£
                                        </label>
                                    </div>
                                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                                        <button onclick="previewProcessing()" style="padding: 0.5rem; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ” å‡¦ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                                        <button onclick="resetOCRSettings()" style="padding: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                                    <button onclick="testOCRDirectly()" style="margin-left: 0.5rem; padding: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ” OCRãƒ†ã‚¹ãƒˆ</button>
                                    <button onclick="testHandwritingOCR()" style="padding: 0.5rem; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">âœï¸ æ‰‹æ›¸ããƒ†ã‚¹ãƒˆ</button>
                                    <button onclick="testComplexLayoutOCR()" style="padding: 0.5rem; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ§© ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆ</button>
                                    </div>
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: #d1ecf1; border-radius: 4px; font-size: 0.8rem; color: #0c5460;">
                                        ğŸ’¡ ãƒ’ãƒ³ãƒˆ: â‘ â†’ 1, â—‹â†’ 0 ãªã©ã®èª¤èªè­˜ãŒã‚ã‚‹å ´åˆã¯ã€Œæ•°å­—è¨˜å·ä¿®æ­£ã€ã‚’æœ‰åŠ¹ã«
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                    
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ - æ‹¡å¤§ç‰ˆ -->
                    <div id="import-preview" style="display: none; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                        <div style="padding: 1rem; border-bottom: 1px solid #ddd; background: #e3f2fd;">
                            <h5 style="margin: 0; color: #172b4d;">ğŸ“‹ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç·¨é›†å¯èƒ½</h5>
                        </div>
                        <div id="preview-content" style="padding: 1rem; max-height: 500px; overflow-y: auto; overflow-x: auto;"></div>
                        <div style="padding: 1rem; border-top: 1px solid #ddd; display: flex; gap: 0.5rem;">
                            <button onclick="executeImport()" style="flex: 1; padding: 0.75rem; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                            <button onclick="hidePreview()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.8rem; color: #6c757d; line-height: 1.4;">
                        <strong>ğŸ“ ã‚·ãƒ³ãƒ—ãƒ«å½¢å¼:</strong><br>
                        â€¢ <strong>ãƒ»</strong>ã§ä¸»ã‚¿ã‚¹ã‚¯é–‹å§‹<br>
                        â€¢ <strong>è¡Œé ­ã‚¹ãƒšãƒ¼ã‚¹</strong>ã§ã‚µãƒ–ã‚¿ã‚¹ã‚¯ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã«è‡ªå‹•è¿½åŠ ï¼‰<br>
                        â€¢ <strong>@æ‹…å½“è€…</strong>ã€<strong>æ—¥ä»˜</strong>ã€<strong>!!!</strong>é«˜å„ªå…ˆåº¦ã‚’è‡ªå‹•èªè­˜<br><br>
                        <strong>ğŸ“¸ OCRæ³¨æ„äº‹é …:</strong><br>
                        â€¢ ãƒ—ãƒªãƒ³ãƒˆæ–‡å­—ã®ã¿æ¨å¥¨ï¼ˆæ‰‹æ›¸ãã¯ç²¾åº¦ä½ï¼‰<br>
                        â€¢ ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã¿ï¼ˆè¡¨ãƒ»å›³ã¯éæ¨å¥¨ï¼‰<br>
                        â€¢ èªè­˜å¾Œã¯æ‰‹å‹•ã§ç¢ºèªãƒ»ä¿®æ­£ãŒå¿…è¦
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="projectManagementModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
                </h3>
                <button class="close-btn" onclick="closeProjectManagementModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem; margin-left: auto;">&times;</button>
            </div>
            
            <div style="padding: 1.5rem 2rem; overflow-y: auto; flex: 1;">
                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #374151; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                        â• æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                    </h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="newProjectName" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; margin-bottom: 0.5rem;">
                            <textarea id="newProjectDescription" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; height: 80px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; flex: 1; min-width: 200px;">
                            <label style="font-size: 0.9rem; color: #6b7280;">å…¬é–‹è¨­å®š:</label>
                            <select id="newProjectVisibility" style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="public">ğŸŒ å…¨å“¡ã«å…¬é–‹</option>
                                <option value="private">ğŸ”’ ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿</option>
                            </select>

                            <label style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">ã‚«ãƒ©ãƒ è¨­å®š:</label>
                            <div id="newProjectColumnsContainer" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <!-- ã‚«ãƒ©ãƒ ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                            </div>
                            <button type="button" onclick="addNewProjectColumn()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 500; margin-bottom: 0.5rem;">
                                â• ã‚«ãƒ©ãƒ è¿½åŠ 
                            </button>

                            <button onclick="createNewProject()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;">
                                ä½œæˆ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ -->
                <div>
                    <h4 style="color: #374151; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                        ğŸ“‹ æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
                    </h4>
                    <div id="projectsList" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="adminDashboardModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1200px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ğŸ“Š ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </h3>
                <button class="close-btn" onclick="closeAdminDashboardModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem; margin-left: auto;">&times;</button>
            </div>

            <div style="padding: 1.5rem 2rem; overflow-y: auto; flex: 1;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                    <!-- ç·Šæ€¥å¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆ -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; border-left: 4px solid #026aa7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span>ğŸš¨</span>
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #172b4d; margin: 0;">ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ãªé …ç›®</h3>
                        </div>
                        <div>
                            <div style="background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                                <strong>æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯:</strong> <span id="dashboard-overdue-count">0</span>ä»¶
                            </div>
                            <div style="background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                                <strong>åœæ»ã‚¿ã‚¹ã‚¯:</strong> <span id="dashboard-stale-count">0</span>ä»¶
                            </div>
                        </div>
                    </div>

                    <!-- ãƒãƒ¼ãƒ ç”Ÿç”£æ€§ -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; border-left: 4px solid #026aa7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span>ğŸ“ˆ</span>
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #172b4d; margin: 0;">ãƒãƒ¼ãƒ ç”Ÿç”£æ€§æ¨ç§»</h3>
                        </div>
                        <div style="height: 200px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">
                            ğŸ“Š ã‚°ãƒ©ãƒ•æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰
                        </div>
                    </div>

                    <!-- ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; border-left: 4px solid #026aa7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span>ğŸ‘¥</span>
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #172b4d; margin: 0;">ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                        </div>
                        <div id="dashboard-performance-content">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç›£è¦– -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; border-left: 4px solid #026aa7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span>ğŸ–¥ï¸</span>
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #172b4d; margin: 0;">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç›£è¦–</h3>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
                            <span>Firebaseæ¥ç¶šçŠ¶æ…‹:</span>
                            <span style="font-weight: 600; font-size: 1.1rem; color: #026aa7;" id="dashboard-firebase-status">ç¢ºèªä¸­...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
                            <span>ç·ã‚¿ã‚¹ã‚¯æ•°:</span>
                            <span style="font-weight: 600; font-size: 1.1rem; color: #026aa7;" id="dashboard-total-tasks">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
                            <span>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼:</span>
                            <span style="font-weight: 600; font-size: 1.1rem; color: #026aa7;" id="dashboard-active-users">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="userManagementModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1400px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0;">
                    ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
                </h3>
                <button class="close-btn" onclick="closeUserManagementModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div style="flex: 1; overflow: hidden;">
                <iframe id="userManagementFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="myProfileModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1400px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0;">
                    ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸
                </h3>
                <button class="close-btn" onclick="closeMyProfileModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div style="flex: 1; overflow: hidden;">
                <iframe id="myProfileFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆçµ±åˆç‰ˆï¼‰ -->
    <div id="templateManagementModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: #f9fafb; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: #1f2937; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
                    <span style="font-size: 0.8rem; background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 500;">çµ±åˆ</span>
                </h3>
                <button class="close-btn" onclick="closeTemplateManagementModal()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">&times;</button>
            </div>
            
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- å·¦å´ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ -->
                <div style="width: 350px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column;">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
                        <h4 style="margin: 0 0 1rem 0; color: #1f2937; font-weight: 600;">ğŸ“‹ ä½œæˆæ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h4>
                        <button onclick="showTemplateCreateForm()" style="width: 100%; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            â• æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
                        </button>
                    </div>
                    <div id="template-management-list" style="flex: 1; overflow-y: auto; padding: 1rem;">
                        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        <div style="text-align: center; color: #6b7280; padding: 2rem;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                
                <!-- å³å´ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <div id="template-welcome-screen" style="display: flex; flex-direction: column; justify-content: center; align-items: center; flex: 1; color: #6b7280; text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“‹</div>
                        <h3 style="margin: 0 0 0.5rem 0; color: #374151;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</h3>
                        <p style="margin: 0; line-height: 1.6;">
                            å·¦å´ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‹ã‚‰é¸æŠã™ã‚‹ã‹ã€<br>
                            ã€Œæ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã€ã§æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã™
                        </p>
                    </div>
                    
                    <div id="template-form-container" style="display: none; flex: 1; overflow-y: auto; padding: 1.5rem 2rem;">
                        <form id="template-management-form" onsubmit="saveTemplateFromManagement(event)">
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå *</label>
                                <input type="text" id="mgmt-template-name" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="ä¾‹: å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ" required>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ã‚«ãƒ†ã‚´ãƒª</label>
                                <select id="mgmt-template-category" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                    <option value="å–¶æ¥­">å–¶æ¥­</option>
                                    <option value="ä¼ç”»">ä¼ç”»</option>
                                    <option value="ç®¡ç†">ç®¡ç†</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ã‚¿ã‚¹ã‚¯å *</label>
                                <input type="text" id="mgmt-template-task-title" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="ä¾‹: æœˆæ¬¡å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ" required>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">å„ªå…ˆåº¦</label>
                                    <select id="mgmt-template-priority" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                        <option value="high">ğŸ”´ æœ€é‡è¦</option>
                                        <option value="medium" selected>ğŸŸ¡ é‡è¦</option>
                                        <option value="low">ğŸŸ¢ é€šå¸¸</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ </label>
                                    <select id="mgmt-template-column" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                        <!-- ã‚«ãƒ©ãƒ é¸æŠè‚¢ãŒã“ã“ã«å‹•çš„è¿½åŠ ã•ã‚Œã‚‹ -->
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                                <div id="mgmt-template-assignees" style="display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; min-height: 60px;">
                                    <!-- æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã“ã“ã«å‹•çš„è¿½åŠ ã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 2rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ</label>
                                <textarea id="mgmt-template-memo" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; resize: vertical;" rows="4" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è©³ç´°ã‚„ä½¿ç”¨å ´é¢"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <button type="button" onclick="cancelTemplateForm()" style="flex: 1; padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                                <button type="submit" id="mgmt-save-template-btn" style="flex: 1; padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    ğŸ’¾ ä¿å­˜
                                </button>
                                <button type="button" id="mgmt-delete-template-btn" onclick="deleteCurrentTemplate()" style="display: none; padding: 0.75rem 1.5rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    ğŸ—‘ï¸ å‰Šé™¤
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ğŸ”¥ Firebaseå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ - ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°åˆæœŸåŒ–
        let tasks = [];
        window.tasks = [];
        let assignees = [];
        let taskTemplates = [];
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼‰
        function checkAuthentication() {
            try {
                // ã¾ãšã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session) {
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™ãƒã‚§ãƒƒã‚¯
                    if (new Date() <= new Date(session.expiresAt)) {
                        
                        // ğŸ”§ æ¨©é™ã®å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªæ™‚ï¼‰
                        ensureUserPermissionsIntegrity();
                        
                        displayUserInfo(session.user);
                        return true;
                    } else {
                        localStorage.removeItem('currentSession');
                    }
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹/æœŸé™åˆ‡ã‚Œã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                console.warn('âš ï¸ [AUTH] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹/æœŸé™åˆ‡ã‚Œ - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                localStorage.clear();
                window.location.href = 'login.html';
                return false;
            } catch (error) {
                console.error('âŒ [AUTH] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                localStorage.clear();
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ï¼ˆé©åˆ‡ãªæ¨©é™è¨­å®šä»˜ãï¼‰
        function initializeUserDatabase() {
            const existingUsers = localStorage.getItem('systemUsers');
            if (!existingUsers || JSON.parse(existingUsers).length === 0) {
                
                // æ­£ã—ã„æ¨©é™è¨­å®šã®å®Œå…¨ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
                const systemUsers = [
                    {
                        id: 1,
                        name: 'é‚¨ä¸­å¤©çœŸ',
                        email: 'muranaka-tenma@terracom.co.jp',
                        password: 'Tenma7041',
                        role: 'developer',
                        department: 'é–‹ç™ºéƒ¨',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 2,
                        name: 'åŠ è—¤ç´”',
                        email: 'kato-jun@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 3,
                        name: 'æœæ—¥åœ­ä¸€',
                        email: 'asahi-keiichi@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 4,
                        name: 'åŠæ¾¤ä¾‘æœ',
                        email: 'hanzawa-yuka@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 5,
                        name: 'ç”°æ‘æ¸‰',
                        email: 'tamura-wataru@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 6,
                        name: 'æ©‹æœ¬å‹ç¾',
                        email: 'hashimoto-yumi@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 7,
                        name: 'ç¦å³¶äºœæœª',
                        email: 'fukushima-ami@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    }
                ];
                
                // ğŸ”¥ LocalStorageä¿å­˜ã¯å‰Šé™¤ï¼ˆFirebaseç§»è¡Œã«ã‚ˆã‚Šä¸è¦ï¼‰
                console.log('ğŸ’¾ [INIT] åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆFirebaseç®¡ç†ï¼‰:', systemUsers.map(u => ({name: u.name, role: u.role})));
                // localStorage.setItem('systemUsers', JSON.stringify(systemUsers)); // ğŸ”¥ å‰Šé™¤
                console.log('âœ… [INIT] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯Firebaseã§ç®¡ç†ã•ã‚Œã¾ã™');
                
                // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚‚åˆæœŸåŒ–ï¼ˆæœ‰åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰
                const assignees = systemUsers.map(u => u.name); // åˆæœŸåŒ–æ™‚ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
                // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯Firestoreã§ç®¡ç†ã•ã‚Œã‚‹
                
                // æ¨©é™ç¢ºèªãƒ­ã‚°
                console.log('ğŸ” [INIT] åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™è¨­å®š:');
                systemUsers.forEach(user => {
                    const roleEmoji = user.role === 'developer' ? 'ğŸ‘¨â€ğŸ’»' : 
                                     user.role === 'admin' ? 'ğŸ‘¤' : 'ğŸ§‘â€ğŸ’¼';
                    console.log(`  ${roleEmoji} ${user.name} - ${user.role}`);
                });
            } else {
                
                // ğŸ”§ æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’systemUsersã‹ã‚‰è‡ªå‹•æ›´æ–°ï¼ˆæœ‰åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰
                const activeUsers = getActiveUsers();
                if (activeUsers.length > 0) {
                    const assignees = activeUsers.map(u => u.name);
                    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯Firestoreã§ç®¡ç†ã•ã‚Œã‚‹
                    console.log(`ğŸ‘¥ [UPDATE] æœ‰åŠ¹ãªæ‹…å½“è€…: ${assignees.join(', ')}`);
                }
                
                // æ¨©é™ã®å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆæ¨©é™ãƒªã‚»ãƒƒãƒˆé˜²æ­¢ï¼‰
                ensureUserPermissionsIntegrity();
            }
        }
        
        // æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­ãƒ•ãƒ©ã‚°ï¼ˆé‡è¤‡å®Ÿè¡Œé˜²æ­¢ï¼‰
        let permissionCheckInProgress = false;
        let lastPermissionCheckTime = 0;

        // ğŸ”¥ Firebaseçµ±åˆ: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let cachedActiveUsers = [];
        let usersCacheLoaded = false;

        // ğŸ”¥ Firebaseçµ±åˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿
        async function loadActiveUsersFromFirebase() {
            try {
                console.log('ğŸ” [LOAD-USERS] Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—é–‹å§‹...');
                const result = await window.FirebaseDB.getActiveUsers();
                if (result.success) {
                    cachedActiveUsers = result.users;
                    usersCacheLoaded = true;
                    console.log(`âœ… [LOAD-USERS] Firebaseå–å¾—æˆåŠŸ: ${cachedActiveUsers.length}äºº`);
                    return cachedActiveUsers;
                } else {
                    console.error('âŒ [LOAD-USERS] Firebaseå–å¾—å¤±æ•—:', result.error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
                    return loadActiveUsersFromLocalStorage();
                }
            } catch (error) {
                console.error('âŒ [LOAD-USERS] ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
                return loadActiveUsersFromLocalStorage();
            }
        }

        // LocalStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        function loadActiveUsersFromLocalStorage() {
            console.log('âš ï¸ [LOAD-USERS] LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
            const allUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const activeUsers = allUsers.filter(user =>
                !user.isHidden && !user.isDisabled
            );
            cachedActiveUsers = activeUsers;
            usersCacheLoaded = true;
            console.log(`âœ… [LOAD-USERS] LocalStorageå–å¾—: ${activeUsers.length}äºº`);
            return activeUsers;
        }

        // ğŸ”§ æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’å–å¾—ã™ã‚‹å…±é€šé–¢æ•°ï¼ˆéè¡¨ç¤ºãƒ»ç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–ï¼‰
        function getActiveUsers() {
            if (!usersCacheLoaded) {
                console.warn('âš ï¸ [ACTIVE-USERS] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœªèª­ã¿è¾¼ã¿ - ç©ºé…åˆ—ã‚’è¿”ã—ã¾ã™');
                return [];
            }
            return cachedActiveUsers;
        }

        // æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆæ‹…å½“è€…é¸æŠç­‰ã§ä½¿ç”¨ï¼‰
        function getActiveUserNames() {
            return getActiveUsers().map(u => u.name);
        }
        
        // æ¨©é™ã®å®Œå…¨æ€§ã‚’ä¿è¨¼ã™ã‚‹é–¢æ•°ï¼ˆæ¨©é™ãƒªã‚»ãƒƒãƒˆé˜²æ­¢ï¼‰
        function ensureUserPermissionsIntegrity() {
            // é‡è¤‡å®Ÿè¡Œé˜²æ­¢: 3ç§’ä»¥å†…ã®é€£ç¶šå®Ÿè¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯
            const now = Date.now();
            if (permissionCheckInProgress || (now - lastPermissionCheckTime < 3000)) {
                console.log('â¸ï¸ [PERMISSION-INTEGRITY] é‡è¤‡å®Ÿè¡Œé˜²æ­¢ - ã‚¹ã‚­ãƒƒãƒ—');
                return false;
            }
            
            permissionCheckInProgress = true;
            lastPermissionCheckTime = now;
            
            try {
                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                
                // ğŸ” æ¨©é™ãƒã‚§ãƒƒã‚¯å‰ã®çŠ¶æ…‹ã‚’è©³ç´°ã«è¨˜éŒ²
                console.log('ğŸ” [PERMISSION-INTEGRITY] æ¨©é™æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯é–‹å§‹');
                console.log('ğŸ” [PERMISSION-INTEGRITY] ç¾åœ¨ã®systemUsers:', systemUsers.map(u => ({
                    name: u.name,
                    email: u.email,
                    role: u.role,
                    id: u.id
                })));
                
                // å‘¼ã³å‡ºã—å…ƒã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¨˜éŒ²
                console.trace('ğŸ” [PERMISSION-INTEGRITY] å‘¼ã³å‡ºã—å…ƒ:');
            
            const correctRoles = {
                'muranaka-tenma@terracom.co.jp': 'developer',
                'kato-jun@terracom.co.jp': 'user',
                'asahi-keiichi@terracom.co.jp': 'user',
                'hanzawa-yuka@terracom.co.jp': 'user',
                'tamura-wataru@terracom.co.jp': 'user',
                'hashimoto-yumi@terracom.co.jp': 'user',
                'fukushima-ami@terracom.co.jp': 'user'
            };
            
            let corrected = false;
            let allUsersAreUser = systemUsers.length > 0 && systemUsers.every(user => user.role === 'user');
            
            if (allUsersAreUser) {
                console.warn('âš ï¸ [CRITICAL] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒuserã«ãªã£ã¦ã„ã‚‹ - ç·Šæ€¥ä¿®å¾©å®Ÿè¡Œ');
                
                // LocalStorageå…¨ä½“ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æ¨©é™å¤‰æ›´ã®åŸå› ã‚’ç‰¹å®š
                console.log('ğŸ” [CRITICAL-DEBUG] LocalStorageå†…ã®é–¢é€£ãƒ‡ãƒ¼ã‚¿:');
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('user') || key.includes('User') || key.includes('session') || key.includes('Session')) {
                        const value = localStorage.getItem(key);
                        console.log(`  - ${key}: ${value?.substring(0, 200)}...`);
                    }
                });
                
                // å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹å¤‰æ›´ã®å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
                console.log('ğŸ” [CRITICAL-DEBUG] ä»–ã®ã‚¿ãƒ–ã‚„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ã®å¤‰æ›´ã®å¯èƒ½æ€§ã‚‚è€ƒæ…®');
            }
            
            // ğŸ”§ å¼·åˆ¶çš„ã«æ­£ã—ã„æ¨©é™ã‚’é©ç”¨
            systemUsers.forEach(user => {
                const correctRole = correctRoles[user.email];
                if (correctRole) {
                    const oldRole = user.role;
                    user.role = correctRole; // å¼·åˆ¶çš„ã«æ­£ã—ã„æ¨©é™ã«è¨­å®š
                    if (oldRole !== correctRole) {
                        corrected = true;
                    }
                }
            });
            
            // ğŸ”„ å¸¸ã«ä¿å­˜ï¼ˆå¼·åˆ¶ä¿®æ­£ï¼‰
            // systemUsersã¯Firestoreã§ç®¡ç†ã•ã‚Œã‚‹
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚‚ä¿®å¾©
            const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (session && session.user && correctRoles[session.user.email]) {
                const correctRole = correctRoles[session.user.email];
                const oldSessionRole = session.user.role;
                session.user.role = correctRole; // å¼·åˆ¶çš„ã«æ­£ã—ã„æ¨©é™ã«è¨­å®š
                localStorage.setItem('currentSession', JSON.stringify(session));
                if (oldSessionRole !== correctRole) {
                }
            }
            
            // ğŸ” ä¿®æ­£å¾Œã®æ¨©é™çŠ¶æ³ã‚’ç¢ºèªè¡¨ç¤º
            console.log('ğŸ“‹ [PERMISSION-STATUS] ä¿®æ­£å¾Œã®æ¨©é™çŠ¶æ³:');
            systemUsers.forEach(user => {
                const roleEmoji = user.role === 'developer' ? 'ğŸ‘¨â€ğŸ’»' : 
                                 user.role === 'admin' ? 'ğŸ‘¤' : 'ğŸ§‘â€ğŸ’¼';
                console.log(`  ${roleEmoji} ${user.name} (${user.email}) - ${user.role}`);
                });
                
                return corrected;
                
            } catch (error) {
                console.error('âŒ [PERMISSION-INTEGRITY] æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            } finally {
                // å®Ÿè¡Œä¸­ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                permissionCheckInProgress = false;
                console.log('âœ… [PERMISSION-INTEGRITY] æ¨©é™æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†');
            }
        }
        
        // LocalStorageå¤‰æ›´ã®ç›£è¦–ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰- æ¨©é™ãƒªã‚»ãƒƒãƒˆã®åŸå› ç‰¹å®š
        function setupLocalStorageMonitoring() {
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (key === 'systemUsers') {
                    console.log('ğŸ” [LOCALSTORAGE-MONITOR] systemUsersã¸ã®æ›¸ãè¾¼ã¿ã‚’æ¤œå‡º');
                    console.log('ğŸ” [LOCALSTORAGE-MONITOR] æ–°ã—ã„å€¤:', value?.substring(0, 300));
                    console.trace('ğŸ” [LOCALSTORAGE-MONITOR] æ›¸ãè¾¼ã¿å…ƒã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:');
                    
                    // æ¨©é™ãŒå…¨ã¦userã«ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    try {
                        const users = JSON.parse(value);
                        if (Array.isArray(users) && users.length > 0) {
                            const developerCount = users.filter(u => u.role === 'developer').length;
                            const userCount = users.filter(u => u.role === 'user').length;
                            
                            console.log(`ğŸ” [LOCALSTORAGE-MONITOR] æ¨©é™åˆ†å¸ƒ: developer(${developerCount}), user(${userCount})`);
                            
                            if (users.every(u => u.role === 'user')) {
                                console.error('âš ï¸ [LOCALSTORAGE-MONITOR] ğŸš¨ ç·Šæ€¥è­¦å‘Š: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒuserãƒ­ãƒ¼ãƒ«ã§æ›¸ãè¾¼ã¾ã‚Œã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼');
                                console.error('ğŸ” [LOCALSTORAGE-MONITOR] ã“ã‚Œã¯æ¨©é™ãƒªã‚»ãƒƒãƒˆã®ç¬é–“ã§ã™');
                            }
                        }
                    } catch (e) {
                        console.error('âŒ [LOCALSTORAGE-MONITOR] ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
                    }
                }
                return originalSetItem.apply(this, arguments);
            };
            
            console.log('âœ… [LOCALSTORAGE-MONITOR] LocalStorageç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹');
        }
        
        // å®šæœŸçš„æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†ã”ã¨ï¼‰
        function startPeriodicPermissionCheck() {
            setInterval(() => {
                console.log('ğŸ”„ [PERIODIC] å®šæœŸæ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...');
                const wasFixed = ensureUserPermissionsIntegrity();
                if (wasFixed) {
                    console.log('ğŸš¨ [PERIODIC] æ¨©é™ç•°å¸¸ã‚’æ¤œå‡ºãƒ»ä¿®å¾©ã—ã¾ã—ãŸ');
                }
            }, 5 * 60 * 1000); // 5åˆ†ã”ã¨
        }
        
        // LocalStorageãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Firebaseç§»è¡Œ
        async function migrateProjectsToFirebase() {
            // ğŸ”¥ LocalStorageâ†’Firebaseç§»è¡Œã¯å®Œäº†æ¸ˆã¿
            // ã“ã®é–¢æ•°ã¯ç„¡åŠ¹åŒ–ï¼ˆLocalStorageã‹ã‚‰ã®å¾©æ´»ã‚’é˜²æ­¢ï¼‰
            console.log('ğŸ“ [PROJECT MIGRATE] ç§»è¡Œæ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆFirebaseå®Œå…¨ç§»è¡Œæ¸ˆã¿ï¼‰');
            return;
        }
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨: LocalStorageãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¢ºèª
        function checkLocalStorageProjects() {
            // ğŸ”¥ [REMOVED] LocalStorageãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’å‰Šé™¤ï¼ˆFirebaseçµ±åˆã«ã‚ˆã‚Šä¸è¦ï¼‰
            console.log('ğŸ” [DEBUG] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆFirebaseå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼‰');
        }
        
        function displayUserInfo(user) {
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
                headerTitle.innerHTML = `
                    ğŸ¯ å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç† - Kanbanãƒœãƒ¼ãƒ‰
                    <span style="font-size: 0.8rem; font-weight: normal; margin-left: 1rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">
                        ${user.name} (${getRoleDisplayName(user.role)})
                    </span>
                `;
            }
            
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const headerRight = document.querySelector('.header').children[1];
            if (headerRight && !document.getElementById('logout-btn')) {
                const logoutBtn = document.createElement('button');
                logoutBtn.id = 'logout-btn';
                logoutBtn.innerHTML = 'ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
                logoutBtn.style.cssText = `
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9rem;
                    margin-left: 1rem;
                `;
                logoutBtn.onclick = function() {
                    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        localStorage.removeItem('currentSession');
                        window.location.href = 'login.html';
                    }
                };
                headerRight.appendChild(logoutBtn);
            }
            
            console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª:', user.name, user.role);
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': 'é–‹ç™ºè€…',
                'admin': 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…',
                'project_manager': 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†è€…',
                'user': 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                'viewer': 'é–²è¦§è€…'
            };
            return roleNames[role] || role;
        }
        
        // Phase 1: æ¨©é™å–å¾—æ©Ÿèƒ½ã®ã¿ï¼ˆè¡¨ç¤ºåˆ¶å¾¡ãªã—ï¼‰
        function getCurrentUser() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user) {
                    // Firebaseèªè¨¼ã®ãƒ ãƒ©ãƒŠã‚«ãƒ»ãƒ†ãƒ³ãƒã‚’é‚¨ä¸­å¤©çœŸã«ãƒãƒƒãƒ”ãƒ³ã‚°
                    let displayName = session.user.name;
                    if (session.user.email === 'muranaka-tenma@terracom.co.jp') {
                        displayName = 'é‚¨ä¸­å¤©çœŸ';  // æ—¥æœ¬åã«çµ±ä¸€
                    }
                    
                    return {
                        name: displayName,
                        email: session.user.email,
                        role: session.user.role,
                        isLoggedIn: true
                    };
                }
            } catch (error) {
                console.error('âŒ [GET-USER] ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                localStorage.removeItem('currentSession');
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
            try {
                const user = localStorage.getItem('currentUser');
                if (user) {
                    const userName = typeof user === 'string' ? user : JSON.parse(user).name;
                    if (userName && (userName.includes('é‚¨ä¸­å¤©çœŸ') || userName.includes('muranaka'))) {
                        return {
                            name: 'é‚¨ä¸­å¤©çœŸ',
                            email: 'muranaka-tenma@terracom.co.jp',
                            role: 'developer',
                            isLoggedIn: true
                        };
                    }
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            return {
                name: null,
                email: null,
                role: null,
                isLoggedIn: false
            };
        }
        
        // æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆå…±é€šï¼‰
        function hasPermission(requiredRoles) {
            const currentUser = getCurrentUser();
            if (!currentUser.isLoggedIn) {
                console.log('âŒ [PERMISSION] æœªãƒ­ã‚°ã‚¤ãƒ³');
                return false;
            }
            
            const hasAccess = requiredRoles.includes(currentUser.role);
            console.log(`ğŸ” [PERMISSION] ${currentUser.name} (${currentUser.role}) => å¿…è¦æ¨©é™: [${requiredRoles.join(', ')}] => ${hasAccess ? 'âœ…' : 'âŒ'}`);
            
            return hasAccess;
        }
        
        // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆä¾¿åˆ©é–¢æ•°ï¼‰
        function isAdminOrDeveloper() {
            return hasPermission(['admin', 'developer']);
        }
        
        // æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆå®Œå…¨å®Ÿè£…ï¼‰
        function checkUserPermission() {
            // æ¨©é™ã®æ•´åˆæ€§ã‚’æœ€åˆã«ãƒã‚§ãƒƒã‚¯ãƒ»ä¿®æ­£
            ensureUserPermissionsIntegrity();
            
            const currentUser = getCurrentUser();
            console.log('ğŸ” ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', currentUser);
            
            if (currentUser && currentUser.isLoggedIn) {
                console.log(`âœ… ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª: ${currentUser.name} (${currentUser.role})`);
                
                // æ¨©é™ã«åŸºã¥ãUIåˆ¶å¾¡ã‚’å®Ÿè¡Œ
                updateUIBasedOnPermissions(currentUser);
            } else {
                console.log('âŒ æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹');
            }
            
            return currentUser;
        }
        
        // æ¨©é™ã«åŸºã¥ãUIåˆ¶å¾¡
        function updateUIBasedOnPermissions(user) {
            const { role } = user;
            
            // é–‹ç™ºè€…æ©Ÿèƒ½ã®è¡¨ç¤ºåˆ¶å¾¡
            const developerSection = document.getElementById('developer-menu-section');
            if (developerSection) {
                if (role === 'developer') {
                    developerSection.style.display = 'block';
                    console.log('âœ… é–‹ç™ºè€…æ©Ÿèƒ½: è¡¨ç¤º');
                } else {
                    developerSection.style.display = 'none';
                    console.log('ğŸš« é–‹ç™ºè€…æ©Ÿèƒ½: éè¡¨ç¤º');
                }
            }
            
            // ç®¡ç†æ©Ÿèƒ½ã®è¡¨ç¤ºåˆ¶å¾¡
            const adminSection = document.getElementById('admin-menu-section');
            if (adminSection) {
                if (role === 'developer' || role === 'admin') {
                    adminSection.style.display = 'block';
                    console.log('âœ… ç®¡ç†æ©Ÿèƒ½: è¡¨ç¤º');
                    
                    // ç®¡ç†è€…å°‚ç”¨ãƒªãƒ³ã‚¯ã®åˆ¶å¾¡
                    const userManagementLink = adminSection.querySelector('a[href="user-management.html"]');
                    const adminDashboardLink = adminSection.querySelector('a[href="admin-dashboard.html"]');
                    
                    if (userManagementLink) userManagementLink.style.display = 'block';
                    if (adminDashboardLink) adminDashboardLink.style.display = 'block';
                } else {
                    adminSection.style.display = 'none';
                    console.log('ğŸš« ç®¡ç†æ©Ÿèƒ½: éè¡¨ç¤º');
                }
            }
        }
        
        // Phase 2: ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã®å‰Šé™¤ï¼ˆãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç§»è¡Œï¼‰
        function removeMyProfileButton() {
            try {
                const myProfileBtn = document.getElementById('my-profile-btn');
                if (myProfileBtn) {
                    myProfileBtn.remove();
                    console.log('ğŸ—‘ï¸ [Phase 2] ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ï¼ˆãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç§»è¡Œï¼‰');
                }
            } catch (error) {
                console.error('âŒ [Phase 2] ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // Phase 3: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³éè¡¨ç¤º
        function hideUserManagementForUsers() {
            try {
                const currentUser = getCurrentUser();
                if (!currentUser.isLoggedIn) {
                    console.log('âŒ [Phase 3] æœªãƒ­ã‚°ã‚¤ãƒ³: å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                console.log(`ğŸ” [Phase 3] æ¨©é™ãƒã‚§ãƒƒã‚¯: ${currentUser.name} (${currentUser.role})`);
                
                // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                if (currentUser.role === 'user') {
                    const userMgmtBtn = document.querySelector('button[onclick*="user-management.html"]');
                    if (userMgmtBtn) {
                        userMgmtBtn.style.display = 'none';
                        console.log('ğŸ”’ [Phase 3] ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º');
                    } else {
                        console.log('âš ï¸ [Phase 3] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                } else {
                    console.log(`âœ… [Phase 3] ${currentUser.role}æ¨©é™: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³è¡¨ç¤ºç¶­æŒ`);
                }
                
                // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ›´æ–°
                setTimeout(() => {
                    updateHamburgerMenu();
                    console.log('ğŸ” [Phase 3] ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°å®Œäº†');
                }, 200);
                
            } catch (error) {
                console.error('âŒ [Phase 3] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³åˆ¶å¾¡ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // Firebaseçµ±åˆãƒ¢ãƒ¼ãƒ‰ - å¾“æ¥ã®èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
        
        // Firebaseå®Œå…¨åŒ–: ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
        async function loadTasks() {
            try {
                console.log('ğŸ“¥ [LOAD-TASKS] Firebaseå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ - ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿é–‹å§‹');

                // ğŸ”¥ Firebaseèªè¨¼ç¢ºèª
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (!currentUser) {
                    console.warn('âš ï¸ [LOAD-TASKS] Firebaseæœªèªè¨¼ - ç©ºé…åˆ—ã‚’è¿”ã™');
                    tasks = [];
                    window.tasks = tasks;
                    return [];
                }

                console.log('âœ… [LOAD-TASKS] Firebaseèªè¨¼æ¸ˆã¿:', currentUser.email);

                // Firebaseã‹ã‚‰ã‚¿ã‚¹ã‚¯å–å¾—
                if (!window.FirebaseDB?.getTasks) {
                    console.error('âŒ [LOAD-TASKS] FirebaseDB.getTasksæœªå®šç¾©');
                    tasks = [];
                    window.tasks = tasks;
                    return [];
                }

                const result = await window.FirebaseDB.getTasks();
                if (result.success && result.tasks) {
                    tasks = result.tasks;
                    window.tasks = tasks;
                    console.log('âœ… [LOAD-TASKS] Firebaseèª­ã¿è¾¼ã¿å®Œäº†:', tasks.length, 'ä»¶');
                    return tasks;
                } else {
                    console.warn('âš ï¸ [LOAD-TASKS] Firebaseèª­ã¿è¾¼ã¿å¤±æ•—:', result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                    tasks = [];
                    window.tasks = tasks;
                    return [];
                }
            } catch (error) {
                console.error('âŒ [LOAD-TASKS] äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:', error);
                tasks = [];
                window.tasks = tasks;
                return [];
            }
        }

        // ğŸ”§ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®columnIDç§»è¡Œé–¢æ•°
        async function migrateProjectTaskColumnIds() {
            try {
                console.log('ğŸ”„ [MIGRATE-COLUMN] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®columnIDç§»è¡Œé–‹å§‹...');

                if (!window.FirebaseDB || !window.firebaseAuth?.currentUser) {
                    console.log('â­ï¸ [MIGRATE-COLUMN] Firebaseæœªæ¥ç¶šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }

                let migratedCount = 0;
                const tasksToUpdate = [];

                // ãƒ¡ãƒ¢ãƒªå†…ã§å…¨ã‚¿ã‚¹ã‚¯ã®columnIdã‚’ä¿®æ­£
                for (const task of tasks) {
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã§ã€columnIdãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰å½¢å¼ã§ãªã„å ´åˆ
                    if (task.projectId && task.columnId && !task.columnId.startsWith(`pj_${task.projectId}_`)) {
                        console.log(`ğŸ”„ [MIGRATE-COLUMN] ç§»è¡Œå¯¾è±¡: "${task.title}" (${task.columnId} â†’ pj_${task.projectId}_0)`);

                        // æœ€åˆã®ã‚«ãƒ©ãƒ IDã«å¤‰æ›´ï¼ˆãƒ¡ãƒ¢ãƒªå†…ã§å³åº§ã«ä¿®æ­£ï¼‰
                        task.columnId = `pj_${task.projectId}_0`;
                        tasksToUpdate.push(task);
                        migratedCount++;
                    }
                }

                if (migratedCount === 0) {
                    console.log('âœ… [MIGRATE-COLUMN] ç§»è¡Œä¸è¦ - ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒæ­£ã—ã„columnIDã§ã™');
                    return;
                }

                // ãƒ¡ãƒ¢ãƒªå†…ã§ã¯æ—¢ã«ä¿®æ­£æ¸ˆã¿ - ç”»é¢ã«ã¯è¡¨ç¤ºã•ã‚Œã‚‹
                console.log(`âœ… [MIGRATE-COLUMN] ãƒ¡ãƒ¢ãƒªå†…ã§${migratedCount}ä»¶ã®columnIDã‚’ä¿®æ­£å®Œäº†`);

                // Firebaseã«æ›´æ–°ã‚’ä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è©¦è¡Œã€ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
                console.log(`ğŸ”¥ [MIGRATE-COLUMN] ${migratedCount}ä»¶ã‚’Firebaseã«ä¿å­˜è©¦è¡Œä¸­...`);
                let savedCount = 0;
                for (const task of tasksToUpdate) {
                    if (task.firebaseId) {
                        try {
                            const result = await window.FirebaseDB.updateTask(task.firebaseId, {
                                columnId: task.columnId,
                                updatedAt: new Date().toISOString()
                            });

                            if (result.success) {
                                savedCount++;
                            } else {
                                console.warn(`âš ï¸ [MIGRATE-COLUMN] Firebaseä¿å­˜ã‚¹ã‚­ãƒƒãƒ—: ${task.title} (è¡¨ç¤ºã«ã¯å½±éŸ¿ãªã—)`);
                            }
                        } catch (error) {
                            console.warn(`âš ï¸ [MIGRATE-COLUMN] Firebaseä¿å­˜ã‚¹ã‚­ãƒƒãƒ—: ${task.title} (è¡¨ç¤ºã«ã¯å½±éŸ¿ãªã—)`);
                        }
                    }
                }

                if (savedCount > 0) {
                    console.log(`âœ… [MIGRATE-COLUMN] ${savedCount}/${migratedCount}ä»¶ã‚’Firebaseã«ä¿å­˜å®Œäº†`);
                } else {
                    console.log(`âš ï¸ [MIGRATE-COLUMN] Firebaseä¿å­˜ã¯0ä»¶ï¼ˆãƒ¡ãƒ¢ãƒªå†…ä¿®æ­£ã§ç”»é¢ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰`);
                }
            } catch (error) {
                console.error('âŒ [MIGRATE-COLUMN] ç§»è¡Œã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Firebaseçµ±åˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
        async function loadTemplates() {
            try {
                if (window.FirebaseAuth?.getCurrentUser() && window.FirebaseDB) {
                    try {
                        const result = await window.FirebaseDB.getTemplates();
                        if (result.success) {
                            localStorage.setItem('taskTemplates', JSON.stringify(result.templates));
                            window.templatesUnsubscribe = result.unsubscribe;
                            return result.templates;
                        }
                    } catch (firebaseError) {
                        // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    }
                }
                
                return JSON.parse(localStorage.getItem('taskTemplates') || '[]');
                
            } catch (error) {
                console.error('âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                return JSON.parse(localStorage.getItem('taskTemplates') || '[]');
            }
        }
        
        // FirebaseåŒ–: LocalStorageèª­ã¿è¾¼ã¿é–¢æ•°ã‚’å»ƒæ­¢
        function loadTasksFromStorage() {
            // Firebaseã‹ã‚‰ã®ã¿èª­ã¿è¾¼ã¿
            return [];
        }

        // Firebaseè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆFirestoreãŒè‡ªå‹•çš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆï¼‰
        function createPeriodicBackup() {
            // Firebase Firestoreã¯è‡ªå‹•çš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã™ã‚‹ãŸã‚ã€
            // LocalStorageãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ä¸è¦
            console.log('ğŸ’¾ [BACKUP] Firebaseè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­...');
        }

        // 5åˆ†æ¯ã«è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        setInterval(createPeriodicBackup, 5 * 60 * 1000);
        
        // ğŸ†˜ é‡è¤‡ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•æ¤œå‡ºã¨å‰Šé™¤
        async function checkAndRemoveDuplicates() {
            try {
                // Firebaseæ¥ç¶šç¢ºèª
                if (!window.FirebaseDB || !window.firebaseAuth?.currentUser) {
                    console.log('â­ï¸ [DUPLICATE-CHECK] Firebaseæœªæ¥ç¶šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                console.log('ğŸ” [DUPLICATE-CHECK] å®šæœŸé‡è¤‡ãƒã‚§ãƒƒã‚¯é–‹å§‹...');
                
                // ã‚¿ã‚¹ã‚¯å–å¾—
                const result = await window.FirebaseDB.getTasks();
                if (!result.success || !result.tasks) {
                    console.log('â­ï¸ [DUPLICATE-CHECK] ã‚¿ã‚¹ã‚¯å–å¾—å¤±æ•—ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                const tasks = result.tasks;
                
                // ã‚¿ã‚¹ã‚¯IDã§é‡è¤‡æ¤œå‡º
                const taskGroups = {};
                tasks.forEach(task => {
                    const id = task.id;
                    if (!taskGroups[id]) {
                        taskGroups[id] = [];
                    }
                    taskGroups[id].push(task);
                });
                
                // é‡è¤‡ã‚¿ã‚¹ã‚¯ã‚’æ¤œå‡º
                const duplicates = [];
                Object.keys(taskGroups).forEach(id => {
                    if (taskGroups[id].length > 1) {
                        duplicates.push({
                            id: id,
                            count: taskGroups[id].length,
                            tasks: taskGroups[id]
                        });
                    }
                });
                
                if (duplicates.length === 0) {
                    console.log('âœ… [DUPLICATE-CHECK] é‡è¤‡ã‚¿ã‚¹ã‚¯ãªã—');
                    return;
                }
                
                console.log(`âš ï¸ [DUPLICATE-CHECK] ${duplicates.length}ç¨®é¡ã®é‡è¤‡ã‚¿ã‚¹ã‚¯ã‚’æ¤œå‡º`);
                
                // è‡ªå‹•å‰Šé™¤ï¼ˆæœ€åˆã®ã‚¿ã‚¹ã‚¯ã‚’æ®‹ã—ã€2ç•ªç›®ä»¥é™ã‚’å‰Šé™¤ï¼‰
                let deletedCount = 0;
                for (const dup of duplicates) {
                    for (let i = 1; i < dup.tasks.length; i++) {
                        const taskToDelete = dup.tasks[i];
                        try {
                            const deleteId = taskToDelete.firebaseId || taskToDelete.id;
                            const deleteResult = await window.FirebaseDB.deleteTask(deleteId);
                            if (deleteResult.success) {
                                deletedCount++;
                                console.log(`ğŸ—‘ï¸ [DUPLICATE-CHECK] è‡ªå‹•å‰Šé™¤: "${taskToDelete.title}"`);
                            }
                        } catch (error) {
                            console.error(`âŒ [DUPLICATE-CHECK] å‰Šé™¤ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                        // Firebaseè² è·è»½æ¸›
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }
                
                if (deletedCount > 0) {
                    console.log(`âœ… [DUPLICATE-CHECK] ${deletedCount}å€‹ã®é‡è¤‡ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•å‰Šé™¤`);
                    // ç”»é¢ã‚’æ›´æ–°
                    loadTasks();
                }
                
            } catch (error) {
                console.error('âŒ [DUPLICATE-CHECK] ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // 10åˆ†æ¯ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯
        setInterval(checkAndRemoveDuplicates, 10 * 60 * 1000);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° - Firebaseå°‚ç”¨ (åˆæœŸåŒ–é…å»¶)
        // taskså¤‰æ•°ã¯æ—¢ã«ä¸Šéƒ¨ã§å®£è¨€æ¸ˆã¿
        window.tasks = undefined; // Firebaseèª­ã¿è¾¼ã¿å®Œäº†ã¾ã§æœªå®šç¾©
        
        // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå¯¾ç­–ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
        function migrateProjectData() {
            try {
                const projectSettings = JSON.parse(localStorage.getItem('projectSettings') || '{}');
                let needsMigration = false;
                
                // æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãŒã‚ã‚‹å ´åˆã¯ã€å¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
                Object.keys(projectSettings).forEach(projectId => {
                    const project = projectSettings[projectId];
                    if (!project.columns) {
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã‚’è¨­å®š
                        project.columns = ["ğŸ“‹ TODO", "ğŸ”„ é€²è¡Œä¸­", "âœ… å®Œäº†", "ğŸ—‘ï¸ ã‚´ãƒŸç®±"];
                        needsMigration = true;
                    }
                    if (!project.createdAt) {
                        project.createdAt = new Date().toISOString();
                        needsMigration = true;
                    }
                    if (!project.createdBy) {
                        project.createdBy = getCurrentUser().name || 'ã‚·ã‚¹ãƒ†ãƒ ';
                        needsMigration = true;
                    }
                });
                
                if (needsMigration) {
                    // ğŸ”¥ LocalStorageä¿å­˜ã¯å‰Šé™¤ï¼ˆFirebaseç§»è¡Œã«ã‚ˆã‚Šä¸è¦ï¼‰
                    // localStorage.setItem('projectSettings', JSON.stringify(projectSettings)); // ğŸ”¥ å‰Šé™¤
                    console.log('ğŸ”„ [MIGRATION] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ‡ãƒ¼ã‚¿ç§»è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆFirebaseç®¡ç†ï¼‰');
                }
            } catch (error) {
                console.error('âŒ [MIGRATION] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Ÿè¡Œ
        migrateProjectData();
        
        // ã‚¿ã‚¹ã‚¯é…åˆ—ã®åˆæœŸåŒ–ç¢ºèª
        if (!tasks || !Array.isArray(tasks)) {
            tasks = [];
            window.tasks = [];
            console.log('ğŸ”§ [INIT] ã‚¿ã‚¹ã‚¯é…åˆ—ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
        }
        
        // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã«createdAtãŒãªã„å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‹ã‚‰é¡ã£ã¦è¨­å®š
        // ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãªã©ç”¨ï¼‰
        tasks = tasks.map((task, index) => {
            if (!task.createdAt) {
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †ã‚’è€ƒæ…®ã—ã¦ã€å¤ã„ã‚¿ã‚¹ã‚¯ã¯7æ—¥å‰ã€æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã¯ä»Šæ—¥ã¨ã—ã¦è¨­å®š
                const daysAgo = Math.floor((tasks.length - index - 1) / Math.max(1, tasks.length / 7));
                const createdDate = new Date();
                createdDate.setDate(createdDate.getDate() - daysAgo);
                task.createdAt = createdDate.toISOString();
                console.log(`ğŸ“… [MIGRATION] Added createdAt to task ${task.id}: ${daysAgo} days ago`);
            }
            return task;
        });
        
        // åœæ»ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ³ãƒ—ãƒ«ã‚’è¿½åŠ ï¼ˆåˆå›ã®ã¿ï¼‰- ç„¡åŠ¹åŒ–
        // const hasStaleTestTask = tasks.some(task => task.title.includes('ã€åœæ»ãƒ†ã‚¹ãƒˆã€‘'));
        // if (!hasStaleTestTask) {
        //     // åœæ»ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯ã®è‡ªå‹•ç”Ÿæˆã‚’ç„¡åŠ¹åŒ– - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚‹
        //     console.log('ğŸš« [INIT] Stale test task creation disabled');
        // }
        
        // Firebaseå®Œå…¨ç§»è¡Œ: ã‚¿ã‚¹ã‚¯ã¯Firestoreã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã•ã‚Œã‚‹
        
        let draggedTask = null;
        let editingTask = null;
        let taskCounter = tasks.length || 0;
        
        // æ‹…å½“è€…ãƒªã‚¹ãƒˆï¼ˆFirebaseçµ±åˆï¼‰
        // assigneeså¤‰æ•°ã¯æ—¢ã«ä¸Šéƒ¨ã§å®£è¨€æ¸ˆã¿
        window.assignees = assignees; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚‚è¨­å®š
        
        // ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’æ‹…å½“è€…ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
        assignees = assignees.filter(assignee => assignee !== 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
        if (assignees.length === 0) {
            // æ‹…å½“è€…ãŒç©ºã®å ´åˆã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å–å¾—
            const activeUserNames = getActiveUserNames();
            if (activeUserNames.length > 0) {
                assignees = activeUserNames;
                console.log('ğŸ‘¥ [ASSIGNEE CLEANUP] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æ‹…å½“è€…ã‚’å¾©å…ƒ:', assignees);
            } else {
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ç©ºã®å ´åˆã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
                const currentUser = getCurrentUser();
                if (currentUser && currentUser.name && currentUser.name !== 'ã‚²ã‚¹ãƒˆ') {
                    assignees = [currentUser.name];
                    console.log('ğŸ‘¤ [ASSIGNEE CLEANUP] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‹…å½“è€…ã¨ã—ã¦è¨­å®š:', assignees);
                } else {
                    // æœ€å¾Œã®æ‰‹æ®µã¨ã—ã¦ã€Œæœªè¨­å®šã€ã‚’è¿½åŠ 
                    assignees = ['æœªè¨­å®š'];
                    console.log('âš ï¸ [ASSIGNEE CLEANUP] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‹…å½“è€…ã‚’è¨­å®š:', assignees);
                }
            }
        }
        // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯Firestoreã§ç®¡ç†ã•ã‚Œã‚‹
        
        // ä¸€å›é™ã‚Šã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç½®æ›å‡¦ç†
        function migrateSampleDataToRealUser() {
            const migrationKey = 'sampleDataMigrated';
            if (localStorage.getItem(migrationKey)) return; // æ—¢ã«å®Ÿè¡Œæ¸ˆã¿
            
            // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            
            let realUser = null;
            if (currentSession && currentSession.user) {
                realUser = currentSession.user.name; // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼
            } else if (systemUsers.length > 0) {
                // é–‹ç™ºè€…æ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å„ªå…ˆçš„ã«é¸æŠ
                const developerUser = systemUsers.find(u => u.role === 'developer');
                realUser = developerUser ? developerUser.name : systemUsers[0].name;
            } else {
                realUser = 'é‚¨ä¸­å¤©çœŸ'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            }
            
            const sampleUsers = ['ç”°ä¸­éƒ¨é•·', 'ä½è—¤èª²é•·', 'éˆ´æœ¨ä¸»ä»»', 'å±±ç”°ã•ã‚“', 'å±±ç”°ä¸»ä»»', 'éˆ´æœ¨ä¿‚é•·'];
            let updated = false;
            
            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã®ç½®æ›
            assignees = assignees.map(name => {
                if (sampleUsers.includes(name)) {
                    updated = true;
                    console.log(`ğŸ”„ ç½®æ›: ${name} â†’ ${realUser}`);
                    return realUser;
                }
                return name;
            });
            
            // é‡è¤‡ã‚’å‰Šé™¤ã—ã€å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
            assignees = [...new Set(assignees)];
            if (!assignees.includes(realUser)) {
                assignees.push(realUser);
                updated = true;
            }
            
            if (updated) {
                // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯Firestoreã§ç®¡ç†ã•ã‚Œã‚‹
                console.log(`âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${realUser}ã€ã«ç½®æ›å®Œäº†:`, assignees);
            }
            
            // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            localStorage.setItem(migrationKey, 'true');
        }
        
        // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        migrateSampleDataToRealUser();
        
        // ã‚«ãƒ©ãƒ å®šç¾©
        let columns = JSON.parse(localStorage.getItem('kanbanColumns') || '[{"id":"todo","title":"ğŸ“‹ TODO","color":"#667eea"},{"id":"inprogress","title":"âš¡ é€²è¡Œä¸­","color":"#f59e0b"},{"id":"waiting","title":"â³ é€£çµ¡å¾…ã¡","color":"#8b5cf6"},{"id":"done","title":"âœ… Done","color":"#10b981"},{"id":"trash","title":"ğŸ—‘ï¸ ã‚´ãƒŸç®±","color":"#6c757d"}]');
        
        // ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å¼·åˆ¶è¿½åŠ 
        const trashColumn = columns.find(c => c.id === 'trash');
        console.log('ğŸ—‘ï¸ [TRASH] ç¾åœ¨ã®ã‚«ãƒ©ãƒ :', columns.map(c => c.id));
        console.log('ğŸ—‘ï¸ [TRASH] ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ å­˜åœ¨:', !!trashColumn);
        
        if (!trashColumn) {
            columns.push({"id":"trash","title":"ğŸ—‘ï¸ ã‚´ãƒŸç®±","color":"#6c757d"});
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            console.log('ğŸ—‘ï¸ ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        } else {
            console.log('ğŸ—‘ï¸ ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ï¼ˆFirebaseçµ±åˆå¯¾å¿œï¼‰
        // taskTemplateså¤‰æ•°ã¯æ—¢ã«ä¸Šéƒ¨ã§å®£è¨€æ¸ˆã¿
        let editingTemplateId = null;
        
        // ãƒãƒ«ã‚¯æ“ä½œç®¡ç†
        let isBulkMode = false;
        let selectedTasks = new Set();
        
        // ãƒ•ã‚£ãƒ«ã‚¿ç®¡ç†ï¼ˆPhase 2å¯¾å¿œï¼‰
        let selectedAssigneeFilters = [];
        let selectedProjectFilters = [];
        let viewMode = 'personal'; // 'personal' or 'project'
        
        // å®šæœŸã‚¿ã‚¹ã‚¯ç®¡ç†
        let recurringTemplates = JSON.parse(localStorage.getItem('recurringTemplates') || '[]');
        
        // Phase 2: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯é–¢é€£é–¢æ•°ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆå°‚ç”¨ï¼‰
        function isPJTaskMode() {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¤å®š
            const projectSettings = document.getElementById('project-task-settings');
            return projectSettings && projectSettings.style.display === 'block';
        }
        
        
        
        // çµ±åˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ï¼ˆæ‹…å½“è€… + ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
        function toggleAssigneeFilterDropdown() {
            const dropdown = document.getElementById('assignee-filter-dropdown');
            const isVisible = dropdown.style.display === 'block';
            
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                populateAssigneeFilterOptions();
                dropdown.style.display = 'block';
            }
        }
        
        function populateAssigneeFilterOptions() {
            const dropdown = document.getElementById('assignee-filter-dropdown');
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’å–å¾—ï¼ˆç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–ï¼‰
            const activeUserNames = getActiveUserNames();
            
            // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ï¼ˆé‡è¤‡é™¤å»ï¼‰
            const projectMap = new Map();
            tasks.filter(t => t.projectId && t.projectId !== null)
                 .forEach(t => {
                     if (!projectMap.has(t.projectId)) {
                         projectMap.set(t.projectId, {id: t.projectId, name: t.projectName});
                     }
                 });
            const allProjects = Array.from(projectMap.values());
            
            dropdown.innerHTML = `
                <div style="padding: 0.5rem;">
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 0.5rem; padding: 0.25rem;">ğŸ‘¤ æ‹…å½“è€…</div>
                    <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                        <input type="radio" name="filter-type" value="" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedAssigneeFilters.length === 0 && selectedProjectFilters.length === 0 ? 'checked' : ''}>
                        <span>å…¨å“¡</span>
                    </label>
                    ${activeUserNames.map(assignee => `
                        <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                            <input type="radio" name="filter-type" value="assignee:${assignee}" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedAssigneeFilters.includes(assignee) && selectedProjectFilters.length === 0 ? 'checked' : ''}>
                            <span>${assignee}</span>
                        </label>
                    `).join('')}
                </div>
            `;
        }
        
        function updateAssigneeFilterSelection() {
            const selectedRadio = document.querySelector('#assignee-filter-dropdown input[name="filter-type"]:checked');
            
            // ãƒ¡ãƒ³ãƒãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã¿ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ç¶­æŒï¼‰
            selectedAssigneeFilters = [];
            
            if (selectedRadio && selectedRadio.value) {
                const [type, value] = selectedRadio.value.split(':');
                
                if (type === 'assignee') {
                    selectedAssigneeFilters = [value];
                    console.log(`ğŸ‘¤ [FILTER] Switched to assignee: ${value}`);
                }
            } else {
                console.log(`ğŸ‘¥ [FILTER] Showing all tasks`);
            }
            
            updateAssigneeFilterText();
            render();
            updateStats();
            
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è‡ªå‹•ã§é–‰ã˜ã‚‹
            const dropdown = document.getElementById('assignee-filter-dropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }
        
        function updateAssigneeFilterText() {
            const textElement = document.getElementById('assignee-filter-text');
            
            if (selectedProjectFilters.length > 0) {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—
                const projectSettings = JSON.parse(localStorage.getItem('projectSettings') || '{}');
                const project = projectSettings[selectedProjectFilters[0]];
                const projectName = project ? project.name : 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ';
                
                if (selectedAssigneeFilters.length > 0) {
                    textElement.textContent = `ğŸ‘¥ ${projectName} - ğŸ‘¤ ${selectedAssigneeFilters[0]}`;
                } else {
                    textElement.textContent = `ğŸ‘¥ ${projectName} - å…¨å“¡`;
                }
            } else if (selectedAssigneeFilters.length > 0) {
                textElement.textContent = `ğŸ‘¤ ${selectedAssigneeFilters[0]}`;
            } else {
                textElement.textContent = 'å…¨å“¡';
            }
        }
        
        function showFilterHelp() {
            const helpText = `
ğŸ‘¥ è¡¨ç¤ºå¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã¤ã„ã¦

ã€ğŸ‘¤ æ‹…å½“è€…é¸æŠã€‘
â€¢ ç‰¹å®šã®æ‹…å½“è€…ã®ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º
â€¢ å€‹äººã®ä½œæ¥­çŠ¶æ³ã‚’ç¢ºèª

ã€ğŸ‘¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã€‘
â€¢ ç‰¹å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º
â€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®Wãƒã‚§ãƒƒã‚¯ç®¡ç†ç”¨
â€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã®ä¸€å…ƒç¢ºèª

ã€å…¨å“¡ã€‘
â€¢ å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
â€¢ ãƒãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ³æŠŠæ¡

ğŸ’¡ å€‹äººè¡¨ç¤ºã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºã¯æ’ä»–çš„ã§ã™ã€‚
`;
            alert(helpText);
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆæ©Ÿèƒ½
        function createProjectTask() {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆã¯ pj-create.html ã§å®Ÿè¡Œ
            console.log('ğŸ”„ [PROJECT CREATE] Redirecting to pj-create.html...');
            window.location.href = 'pj-create.html';
        }
        
        function generateRecurringTask(template) {
            const now = new Date();
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—ã®ç½®æ›
            const title = formatTemplateString(template.taskTemplate.title, now);
            const deadline = calculateDeadline(now, template.deadlineConfig);
            
            const task = {
                id: Date.now(),
                title: title,
                deadline: deadline.toISOString(),
                priority: template.taskTemplate.priority,
                assignees: template.taskTemplate.assignees || [],
                assignee: template.taskTemplate.assignees?.[0] || 'æœªè¨­å®š',
                memo: template.taskTemplate.memo || '',
                attachments: [],
                comments: [],
                columnId: 'todo',
                completed: false,
                createdAt: now.toISOString(),
                
                // ã‚¿ã‚¹ã‚¯éè¡¨ç¤ºæ©Ÿèƒ½
                isHidden: false,
                
                // PJã‚¿ã‚¹ã‚¯å¯¾å¿œ
                projectId: template.taskTemplate.projectId,
                projectName: template.taskTemplate.projectName,
                personalStatus: 'todo',
                projectStatus: 'todo',
                pendingMove: null,
                approvers: template.taskTemplate.approvers || [],
                lastApprovedBy: null,
                approvedAt: null,
                
                // å®šæœŸã‚¿ã‚¹ã‚¯æƒ…å ±
                isRecurring: true,
                recurringTemplateId: template.id,
                generatedFor: formatDateForRecurring(now)
            };
            
            return task;
        }
        
        function formatTemplateString(template, date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            return template
                .replace(/\{\{YYYY\}\}/g, year)
                .replace(/\{\{YYYYå¹´\}\}/g, `${year}å¹´`)
                .replace(/\{\{MM\}\}/g, String(month).padStart(2, '0'))
                .replace(/\{\{MMæœˆ\}\}/g, `${month}æœˆ`)
                .replace(/\{\{DD\}\}/g, String(day).padStart(2, '0'))
                .replace(/\{\{DDæ—¥\}\}/g, `${day}æ—¥`);
        }
        
        function calculateDeadline(baseDate, deadlineConfig) {
            const deadline = new Date(baseDate);
            deadline.setDate(deadline.getDate() + deadlineConfig.relativeDays);
            
            const [hours, minutes] = deadlineConfig.timeOfDay.split(':');
            deadline.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            return deadline;
        }
        
        function formatDateForRecurring(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            return `${year}-${String(month).padStart(2, '0')}`;
        }
        
        function checkAndGenerateRecurringTasks() {
            const now = new Date();
            let generatedCount = 0;
            
            recurringTemplates.forEach(template => {
                if (shouldGenerateRecurringTask(template, now)) {
                    const newTask = generateRecurringTask(template);
                    tasks.unshift(newTask);
                    
                    // æ¬¡å›ç”Ÿæˆæ—¥ã‚’æ›´æ–°
                    updateNextGenerationDate(template, now);
                    generatedCount++;
                    
                    console.log(`ğŸ”„ [RECURRING] Generated task: ${newTask.title} for ${newTask.generatedFor}`);
                }
            });
            
            if (generatedCount > 0) {
                saveTasks();
                saveRecurringTemplates();
                render();
                updateStats();
                console.log(`ğŸ”„ [RECURRING] Generated ${generatedCount} recurring tasks`);
            }
        }
        
        function shouldGenerateRecurringTask(template, now) {
            if (!template.isActive) return false;
            
            const nextGen = template.generationConfig.nextGeneration 
                ? new Date(template.generationConfig.nextGeneration) 
                : now;
            
            return now >= nextGen;
        }
        
        function updateNextGenerationDate(template, currentDate) {
            const config = template.recurringConfig;
            const next = new Date(currentDate);
            
            switch (config.type) {
                case 'daily':
                    next.setDate(next.getDate() + config.interval);
                    break;
                case 'weekly':
                    next.setDate(next.getDate() + (7 * config.interval));
                    break;
                case 'monthly':
                    next.setMonth(next.getMonth() + config.interval);
                    break;
                case 'yearly':
                    next.setFullYear(next.getFullYear() + config.interval);
                    break;
            }
            
            template.generationConfig.lastGenerated = currentDate.toISOString();
            template.generationConfig.nextGeneration = next.toISOString();
        }
        
        function showRecurringTasksInfo() {
            showRecurringTasksManagement();
        }
        
        function showRecurringTasksManagement() {
            const activeTemplates = recurringTemplates.filter(t => t.isActive);
            const recurringTasks = tasks.filter(t => t.isRecurring);
            
            const modal = document.createElement('div');
            modal.id = 'recurring-tasks-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #805ad5 0%, #667eea 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                        <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            ğŸ”„ å®šæœŸã‚¿ã‚¹ã‚¯ç®¡ç†
                            <button onclick="document.getElementById('recurring-tasks-modal').remove()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
                        </h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">æ¯æœˆãƒ»æ¯é€±ã®ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†</p>
                    </div>
                    
                    <div style="padding: 1.5rem; overflow-y: auto; max-height: 60vh;">
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: #2d3748; margin: 0 0 1rem 0;">ğŸ“Š ç¾åœ¨ã®çŠ¶æ³</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #805ad5;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #805ad5;">${activeTemplates.length}</div>
                                    <div style="color: #4a5568; font-size: 0.9rem;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
                                </div>
                                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #38a169;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">${recurringTasks.length}</div>
                                    <div style="color: #4a5568; font-size: 0.9rem;">ç”Ÿæˆæ¸ˆã¿ã‚¿ã‚¹ã‚¯</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                            <button onclick="createRecurringTemplate()" style="background: #805ad5; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                â• ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
                            </button>
                            <button onclick="generatePendingTasks()" style="background: #3182ce; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ğŸ”„ ä»Šã™ãç”Ÿæˆãƒã‚§ãƒƒã‚¯
                            </button>
                            <button onclick="showRecurringTasksInfo_Old()" style="background: #718096; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ğŸ“‹ ç°¡æ˜“è¡¨ç¤º
                            </button>
                        </div>
                        
                        ${activeTemplates.length > 0 ? `
                            <div>
                                <h4 style="color: #2d3748; margin: 0 0 1rem 0;">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${activeTemplates.map(template => {
                                        const nextGen = template.generationConfig?.nextGeneration ? 
                                            new Date(template.generationConfig.nextGeneration).toLocaleDateString('ja-JP') : 'æœªè¨­å®š';
                                        const typeText = getRecurringTypeText(template.recurringConfig?.type || 'monthly');
                                        
                                        return `
                                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                    <div style="font-weight: 600; color: #2d3748;">${template.name || 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåæœªè¨­å®š'}</div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button onclick="alert('ç·¨é›†æ©Ÿèƒ½ã¯è¿‘æ—¥å®Ÿè£…äºˆå®šã§ã™')" style="background: #edf2f7; border: 1px solid #e2e8f0; color: #4a5568; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ç·¨é›†</button>
                                                        <button onclick="alert('åœæ­¢æ©Ÿèƒ½ã¯è¿‘æ—¥å®Ÿè£…äºˆå®šã§ã™')" style="background: #fed7d7; border: 1px solid #feb2b2; color: #c53030; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">åœæ­¢</button>
                                                    </div>
                                                </div>
                                                <div style="font-size: 0.85rem; color: #4a5568; line-height: 1.4;">
                                                    <div>ğŸ“… é »åº¦: ${typeText}</div>
                                                    <div>â° æ¬¡å›ç”Ÿæˆ: ${nextGen}</div>
                                                    <div>ğŸ‘¥ æ‹…å½“è€…: ${template.taskTemplate?.assignees ? template.taskTemplate.assignees.join(', ') : 'æœªè¨­å®š'}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 2rem; color: #718096;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“…</div>
                                <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">å®šæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
                                <div style="font-size: 0.9rem;">æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã€ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•åŒ–ã—ã¾ã—ã‚‡ã†</div>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // å…ƒã®ç°¡æ˜“è¡¨ç¤ºé–¢æ•°ï¼ˆä¸‹ä½äº’æ›ç”¨ï¼‰
        function showRecurringTasksInfo_Old() {
            const activeTemplates = recurringTemplates.filter(t => t.isActive);
            const recurringTasks = tasks.filter(t => t.isRecurring);
            
            let infoText = `ğŸ”„ å®šæœŸã‚¿ã‚¹ã‚¯ç®¡ç†\n\n`;
            infoText += `ğŸ“Š ç¾åœ¨ã®çŠ¶æ³:\n`;
            infoText += `â€¢ å®šæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ${activeTemplates.length}ä»¶\n`;
            infoText += `â€¢ ç”Ÿæˆæ¸ˆã¿ã‚¿ã‚¹ã‚¯: ${recurringTasks.length}ä»¶\n\n`;
            
            if (activeTemplates.length > 0) {
                infoText += `ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§:\n`;
                activeTemplates.forEach((template, index) => {
                    const nextGen = template.generationConfig?.nextGeneration 
                        ? new Date(template.generationConfig.nextGeneration).toLocaleDateString('ja-JP')
                        : 'æœªè¨­å®š';
                    infoText += `${index + 1}. ${template.name}\n`;
                    infoText += `   ç¨®é¡: ${getRecurringTypeText(template.recurringConfig?.type || 'monthly')}\n`;
                    infoText += `   æ¬¡å›ç”Ÿæˆ: ${nextGen}\n\n`;
                });
            }
            
            if (recurringTasks.length > 0) {
                infoText += `ğŸ“ ç”Ÿæˆæ¸ˆã¿ã‚¿ã‚¹ã‚¯:\n`;
                const recentTasks = recurringTasks.slice(0, 5);
                recentTasks.forEach(task => {
                    const status = getColumnTitle(task.columnId);
                    infoText += `â€¢ ${task.title} (${status})\n`;
                });
                if (recurringTasks.length > 5) {
                    infoText += `...ä»–${recurringTasks.length - 5}ä»¶\n`;
                }
            }
            
            infoText += `\nğŸ’¡ ãƒ’ãƒ³ãƒˆ: å®šæœŸã‚¿ã‚¹ã‚¯ã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã€ğŸ”„ã‚¢ã‚¤ã‚³ãƒ³ã§è­˜åˆ¥ã§ãã¾ã™ã€‚`;
            
            alert(infoText);
        }
        
        function getRecurringTypeText(type) {
            const typeMap = {
                'daily': 'æ¯æ—¥',
                'weekly': 'æ¯é€±',
                'monthly': 'æ¯æœˆ',
                'yearly': 'æ¯å¹´'
            };
            return typeMap[type] || type;
        }
        
        // æ—¥ä»˜ãƒ»æ™‚é–“ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function getCurrentDateTime() {
            return new Date();
        }
        
        function isOverdue(deadline, columnId) {
            if (columnId === 'done') return false;
            return new Date(deadline) < getCurrentDateTime();
        }
        
        function isToday(deadline, columnId) {
            if (columnId === 'done') return false;
            const today = new Date();
            const deadlineDate = new Date(deadline);
            return today.toDateString() === deadlineDate.toDateString();
        }
        
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getDefaultDeadlineString() {
            // æ—¥ä»˜ã¯ä»Šæ—¥ã‚’è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜åŸºæº–ï¼‰
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getDefaultTimeString() {
            // ç¾åœ¨æ™‚åˆ»+3æ™‚é–“ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»ã¨ã—ã¦è¨­å®š
            const now = new Date();
            const futureDate = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // 3æ™‚é–“å¾Œ
            
            const hours = futureDate.getHours();
            const minutes = futureDate.getMinutes();
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        function getDefaultDateTimeAfter3Hours() {
            // ç¾åœ¨æ™‚åˆ»+3æ™‚é–“å¾Œã®æ—¥ä»˜ã¨æ™‚é–“ã‚’æ­£ç¢ºã«è¨ˆç®—
            const now = new Date();
            const futureDate = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // 3æ™‚é–“å¾Œ
            
            const year = futureDate.getFullYear();
            const month = (futureDate.getMonth() + 1).toString().padStart(2, '0');
            const day = futureDate.getDate().toString().padStart(2, '0');
            const hours = futureDate.getHours();
            const minutes = futureDate.getMinutes();
            
            return {
                date: `${year}-${month}-${day}`,
                time: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`
            };
        }
        
        // çµ±ä¸€ã‚«ãƒ¼ãƒ‰ä½œæˆé–¢æ•°ï¼ˆç”»é¢ä¸Šéƒ¨ã®ãƒœã‚¿ãƒ³ç”¨ï¼‰
        async function createTaskUnified() {
            console.log('ğŸ“ [CREATE UNIFIED] Starting unified task creation...');
            editingTask = null;
            document.getElementById('modal-title').textContent = 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = getDefaultDeadlineString();
            document.getElementById('task-time-input').value = getDefaultTimeString();
            document.getElementById('task-priority-input').value = 'medium';
            document.getElementById('task-memo-input').value = '';
            document.getElementById('task-files-input').value = '';
            document.getElementById('attached-files-list').innerHTML = '';
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚’åˆæœŸåŒ–
            initializeTemplateSelector();
            
            // ã‚«ãƒ©ãƒ é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºã—ã€åˆæœŸåŒ–
            const columnSelectionGroup = document.getElementById('column-selection-group');
            const columnSelect = document.getElementById('task-column-input');
            columnSelectionGroup.style.display = 'block';
            
            // ã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ã‚«ãƒ©ãƒ ã‚’é¸æŠ
            if (columns.length > 0) {
                columnSelect.value = columns[0].id;
            }
            
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            updateAssigneeOptions();
            clearSelectedAssignees();

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã‚’æ›´æ–°
            await updateProjectOptions();

            // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            displayComments([]);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ–°è¦ã‚¿ã‚¹ã‚¯ã®å ´åˆï¼‰
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’å¸¸ã«æœ‰åŠ¹åŒ–
            document.getElementById('comment-input').disabled = false;
            document.getElementById('comments-section').innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã§ã™ã€‚ä¿å­˜å¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã§ãã¾ã™ã€‚</div>';
            
            // PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ãŸãŸã‚ã€ã“ã®å‡¦ç†ã¯ä¸è¦
            
            // çµ±ä¸€ä½œæˆãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            document.getElementById('task-modal').dataset.unifiedMode = 'true';
            
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å†åº¦ãƒˆãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«ï¼‰
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safariã«ã‚‚å¯¾å¿œ
                    document.documentElement.scrollTop = 0; // IEã«ã‚‚å¯¾å¿œ
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ã‚‚ä¸Šéƒ¨ã«é…ç½®ã‚’å¼·åˆ¶
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        // ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»ç·¨é›†
        function createTask(columnId) {
            editingTask = null;
            document.getElementById('modal-title').textContent = 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = getDefaultDeadlineString();
            document.getElementById('task-time-input').value = getDefaultTimeString();
            document.getElementById('task-priority-input').value = 'medium';
            document.getElementById('task-memo-input').value = '';
            document.getElementById('task-files-input').value = '';
            document.getElementById('attached-files-list').innerHTML = '';
            
            // ã‚«ãƒ©ãƒ é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
            document.getElementById('column-selection-group').style.display = 'none';
            document.getElementById('task-column-input').removeAttribute('required');
            
            // PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ãŸãŸã‚ã€ã“ã®å‡¦ç†ã¯ä¸è¦
            
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            updateAssigneeOptions();
            clearSelectedAssignees();
            
            // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            displayComments([]);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ–°è¦ã‚¿ã‚¹ã‚¯ã®å ´åˆï¼‰
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’å¸¸ã«æœ‰åŠ¹åŒ–
            document.getElementById('comment-input').disabled = false;
            document.getElementById('comments-section').innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã§ã™ã€‚ä¿å­˜å¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã§ãã¾ã™ã€‚</div>';
            
            // ã‚«ãƒ©ãƒ æƒ…å ±ã‚’ä¿å­˜
            document.getElementById('task-modal').dataset.targetColumn = columnId;
            document.getElementById('task-modal').dataset.unifiedMode = 'false';
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å†åº¦ãƒˆãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«ï¼‰
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safariã«ã‚‚å¯¾å¿œ
                    document.documentElement.scrollTop = 0; // IEã«ã‚‚å¯¾å¿œ
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ã‚‚ä¸Šéƒ¨ã«é…ç½®ã‚’å¼·åˆ¶
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        function updateAssigneeOptions() {
            const container = document.getElementById('assignees-container');
            container.innerHTML = '';
            
            assignees.forEach(assignee => {
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'assignee-checkbox';
                checkboxWrapper.innerHTML = `
                    <input type="checkbox" id="assignee-${assignee}" value="${assignee}" onchange="updateSelectedAssignees()">
                    <label for="assignee-${assignee}">${assignee}</label>
                `;
                container.appendChild(checkboxWrapper);
            });
            
            // éè¡¨ç¤ºãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å­˜åœ¨ç¢ºèªã¨ãƒ‡ãƒãƒƒã‚°
            setTimeout(() => {
                const hiddenCheckbox = document.getElementById('task-hidden-input');
                if (!hiddenCheckbox) {
                    console.error('âŒ [DEBUG] task-hidden-input ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
                    
                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€å‹•çš„ã«è¿½åŠ 
                    const memoGroup = document.querySelector('#task-memo-input').parentElement;
                    if (memoGroup) {
                        const hiddenGroup = document.createElement('div');
                        hiddenGroup.className = 'form-group';
                        hiddenGroup.style.marginBottom = '1rem';
                        hiddenGroup.innerHTML = `
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="task-hidden-input" style="margin: 0;">
                                ğŸ”’ ã“ã®ã‚¿ã‚¹ã‚¯ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                            </label>
                            <small style="color: #666; display: block; margin-top: 0.25rem;">
                                ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã¯è¦‹ãˆãªããªã‚Šã¾ã™ï¼ˆé€šçŸ¥ã‚‚é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼‰
                            </small>
                        `;
                        memoGroup.parentElement.insertBefore(hiddenGroup, memoGroup);
                        console.log('âœ… [DEBUG] éè¡¨ç¤ºãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å‹•çš„ã«è¿½åŠ ã—ã¾ã—ãŸ');
                    }
                } else {
                    console.log('âœ… [DEBUG] task-hidden-input ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå­˜åœ¨ã—ã¾ã™');
                }
            }, 100);
            
            // æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³
            const addButton = document.createElement('div');
            addButton.className = 'assignee-checkbox';
            addButton.style.cssText = 'color: #0079bf; font-weight: 500;';
            addButton.innerHTML = '+ æ–°ã—ã„æ‹…å½“è€…ã‚’è¿½åŠ ';
            addButton.onclick = addNewAssignee;
            container.appendChild(addButton);
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã‚’æ›´æ–°
        async function updateProjectOptions() {
            try {
                const projectSelect = document.getElementById('task-project-select');
                if (!projectSelect) return;
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ®‹ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
                projectSelect.innerHTML = '<option value="">å€‹äººã‚¿ã‚¹ã‚¯ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰</option>';

                // ğŸ”¥ Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
                let projects = [];
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        projects = result.projects || [];
                    } else {
                        console.error('âŒ [PROJECT-SELECT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', result.error);
                    }
                } else {
                    console.error('âŒ [PROJECT-SELECT] FirebaseDB.getProjectsãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }

                const currentUser = getCurrentUser();

                if (projects.length === 0) {
                    return;
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const accessibleProjects = projects.filter(project => {
                    // å…¬é–‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿è¡¨ç¤º
                    return project.status === 'active' &&
                           (project.visibility === 'public' ||
                            (project.members && project.members.includes(currentUser.email)) ||
                            project.createdBy === currentUser.email);
                });
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã‚’è¿½åŠ 
                accessibleProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨å…¬é–‹çŠ¶æ…‹ã‚’è¡¨ç¤º
                    const visibilityIcon = project.visibility === 'public' ? 'ğŸŒ' : 'ğŸ”’';
                    const memberCount = project.members.length;
                    option.textContent = `${visibilityIcon} ${project.name} (${memberCount}å)`;
                    
                    projectSelect.appendChild(option);
                });
                
                console.log(`âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã‚’æ›´æ–°: ${accessibleProjects.length}å€‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ`);
                
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function updateSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const wrapper = checkbox.closest('.assignee-checkbox');
                if (checkbox.checked) {
                    wrapper.classList.add('checked');
                } else {
                    wrapper.classList.remove('checked');
                }
            });
        }
        
        function getSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function setSelectedAssignees(assigneeList) {
            // æ–‡å­—åˆ—ã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
            if (typeof assigneeList === 'string') {
                assigneeList = assigneeList.split(',').map(a => a.trim()).filter(a => a);
            }
            
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = assigneeList.includes(checkbox.value);
                const wrapper = checkbox.closest('.assignee-checkbox');
                if (checkbox.checked) {
                    wrapper.classList.add('checked');
                } else {
                    wrapper.classList.remove('checked');
                }
            });
        }
        
        function clearSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.assignee-checkbox').classList.remove('checked');
            });
        }
        
        function addNewAssignee() {
            const newAssignee = prompt('æ–°ã—ã„æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (newAssignee && newAssignee.trim()) {
                const trimmedName = newAssignee.trim();
                if (!assignees.includes(trimmedName)) {
                    assignees.push(trimmedName);
                    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯Firestoreã§ç®¡ç†ã•ã‚Œã‚‹
                    updateAssigneeOptions();
                    // æ–°ã—ãè¿½åŠ ã—ãŸæ‹…å½“è€…ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    setTimeout(() => {
                        const newCheckbox = document.getElementById(`assignee-${trimmedName}`);
                        if (newCheckbox) {
                            newCheckbox.checked = true;
                            updateSelectedAssignees();
                        }
                    }, 100);
                }
            }
        }
        
        async function editTask(taskId) {
            editingTask = tasks.find(t => t.id === taskId);
            if (!editingTask) return;

            // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼šä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã®ã¿ç·¨é›†å¯èƒ½
            const currentUser = getCurrentUser();
            if (currentUser.role === 'user') {
                const canEdit = editingTask.assignees && editingTask.assignees.includes(currentUser.name) || 
                               editingTask.assignee === currentUser.name;
                if (!canEdit) {
                    alert('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚è‡ªåˆ†ãŒæ‹…å½“è€…ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®ã¿ç·¨é›†å¯èƒ½ã§ã™ã€‚');
                    return;
                }
            }
            
            document.getElementById('modal-title').textContent = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
            document.getElementById('task-title-input').value = editingTask.title;
            
            console.log('ğŸ” [MODAL DEBUG] Setting up edit modal:');
            console.log('ğŸ” [MODAL DEBUG] Original deadline:', editingTask.deadline);
            console.log('ğŸ” [MODAL DEBUG] Split date part:', editingTask.deadline.split('T')[0]);
            console.log('ğŸ” [MODAL DEBUG] Split time part:', editingTask.deadline.split('T')[1]);
            console.log('ğŸ” [MODAL DEBUG] Time substring:', editingTask.deadline.split('T')[1].substring(0, 5));
            
            // â˜…â˜…â˜… ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã®ä¿®æ­£ï¼šJSTã§æ­£ã—ãè¡¨ç¤º â˜…â˜…â˜…
            const deadlineDate = new Date(editingTask.deadline);
            const jstOffset = 9 * 60; // JST = UTC+9
            const localDate = new Date(deadlineDate.getTime() + (jstOffset * 60 * 1000));
            
            const dateStr = localDate.toISOString().split('T')[0];
            const timeStr = localDate.toISOString().split('T')[1].substring(0, 5);
            
            console.log('ğŸ” [TIMEZONE FIX] Original deadline:', editingTask.deadline);
            console.log('ğŸ” [TIMEZONE FIX] Deadline as Date object:', deadlineDate);
            console.log('ğŸ” [TIMEZONE FIX] Adjusted for JST:', localDate.toISOString()); 
            console.log('ğŸ” [TIMEZONE FIX] Date string for form:', dateStr);
            console.log('ğŸ” [TIMEZONE FIX] Time string for form:', timeStr);
            
            document.getElementById('task-date-input').value = dateStr;
            document.getElementById('task-time-input').value = timeStr;
            
            console.log('ğŸ” [MODAL DEBUG] After setting form values:');
            console.log('ğŸ” [MODAL DEBUG] Date input now:', document.getElementById('task-date-input').value);
            console.log('ğŸ” [MODAL DEBUG] Time input now:', document.getElementById('task-time-input').value);
            document.getElementById('task-priority-input').value = editingTask.priority;
            document.getElementById('task-memo-input').value = editingTask.memo || '';
            document.getElementById('task-hidden-input').checked = editingTask.isHidden || false;
            
            // ã‚«ãƒ©ãƒ é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤ºï¼ˆç·¨é›†æ™‚ã¯ä¸è¦ï¼‰
            document.getElementById('column-selection-group').style.display = 'none';
            document.getElementById('task-column-input').removeAttribute('required');
            
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å€¤ã‚’è¨­å®š
            updateAssigneeOptions();
            setSelectedAssignees(editingTask.assignees || editingTask.assignee || []);

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å€¤ã‚’è¨­å®š
            await updateProjectOptions();
            const projectSelect = document.getElementById('task-project-select');
            if (projectSelect && editingTask.projectId) {
                projectSelect.value = editingTask.projectId;
            }
            
            // Phase 2: PJã‚¿ã‚¹ã‚¯ç·¨é›†æ™‚ã¯PJè¨­å®šã‚’éè¡¨ç¤ºï¼ˆä½œæˆæ™‚ã®ã¿ä½¿ç”¨ï¼‰
            // PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®å ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤º
            const isPJTask = editingTask.projectId && editingTask.projectId !== null;
            if (isPJTask) {
                document.getElementById('modal-title').textContent = `ğŸ‘¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ç·¨é›†: ${editingTask.projectId}`;
                console.log(`ğŸ¯ [EDIT] Editing project task: ${editingTask.projectId} - ${editingTask.projectName}`);
            } else {
                console.log(`ğŸ‘¤ [EDIT] Editing personal task: ${editingTask.title}`);
            }
            
            // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
            displayAttachedFiles(editingTask.attachments || []);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
            displayComments(editingTask.comments || []);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('comment-input').disabled = false;
            
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å†åº¦ãƒˆãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«ï¼‰
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safariã«ã‚‚å¯¾å¿œ
                    document.documentElement.scrollTop = 0; // IEã«ã‚‚å¯¾å¿œ
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ã‚‚ä¸Šéƒ¨ã«é…ç½®ã‚’å¼·åˆ¶
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        function displayAttachedFiles(attachments) {
            const container = document.getElementById('attached-files-list');
            container.innerHTML = '';
            
            if (attachments.length === 0) return;
            
            const previewDiv = document.createElement('div');
            previewDiv.className = 'file-preview';
            
            attachments.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.onclick = () => previewFile(file, index);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                if (file.type && file.type.startsWith('image/') && file.dataUrl) {
                    fileItem.innerHTML = `
                        <img src="${file.dataUrl}" class="file-preview-thumbnail" alt="${file.name}">
                        <div style="font-size: 0.6rem; margin-top: 0.2rem;">${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}</div>
                        <button type="button" onclick="event.stopPropagation(); removeAttachment(${index})" style="background: #e53e3e; color: white; border: none; padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.6rem; cursor: pointer; margin-top: 0.2rem;">å‰Šé™¤</button>
                    `;
                } else {
                    const fileIcon = getFileIcon(file.type);
                    fileItem.innerHTML = `
                        <div style="font-size: 1.5rem; margin-bottom: 0.2rem;">${fileIcon}</div>
                        <div style="font-size: 0.6rem; margin-bottom: 0.2rem;">${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}</div>
                        <button type="button" onclick="event.stopPropagation(); removeAttachment(${index})" style="background: #e53e3e; color: white; border: none; padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.6rem; cursor: pointer;">å‰Šé™¤</button>
                    `;
                }
                
                previewDiv.appendChild(fileItem);
            });
            
            container.appendChild(previewDiv);
        }
        
        function getFileIcon(fileType) {
            if (!fileType) return 'ğŸ“„';
            if (fileType.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (fileType.includes('pdf')) return 'ğŸ“•';
            if (fileType.includes('word') || fileType.includes('document')) return 'ğŸ“';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'ğŸ“Š';
            if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'ğŸ“ˆ';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'ğŸ—œï¸';
            return 'ğŸ“„';
        }
        
        function previewFile(file, index) {
            if (file.dataUrl && file.type.startsWith('image/')) {
                // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
                modal.onclick = () => document.body.removeChild(modal);
                
                const img = document.createElement('img');
                img.src = file.dataUrl;
                img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
                
                modal.appendChild(img);
                document.body.appendChild(modal);
            } else {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}\nã‚µã‚¤ã‚º: ${(file.size / 1024).toFixed(1)}KB\nã‚¿ã‚¤ãƒ—: ${file.type || 'ä¸æ˜'}`);
            }
        }
        
        function removeAttachment(index) {
            if (editingTask && editingTask.attachments) {
                editingTask.attachments.splice(index, 1);
                // â˜…â˜…â˜… é‡è¦ï¼štasksé…åˆ—å†…ã®ã‚¿ã‚¹ã‚¯å…¨ä½“ã‚’åŒæœŸ â˜…â˜…â˜…
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('ğŸ” [ATTACHMENT SYNC] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('ğŸ” [ATTACHMENT SYNC] Before sync - Task exists:', !!tasks[taskIndex]);
                    // editingTaskå…¨ä½“ã‚’tasksé…åˆ—ã«åŒæœŸ
                    tasks[taskIndex] = { ...editingTask };
                    console.log('ğŸ” [ATTACHMENT SYNC] After sync - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        attachmentsCount: tasks[taskIndex].attachments ? tasks[taskIndex].attachments.length : 0
                    });
                    saveTasks();
                } else {
                    console.error('âŒ [ATTACHMENT SYNC] Task not found in tasks array! EditingTask ID:', editingTask.id);
                }
                displayAttachedFiles(editingTask.attachments);
                
                // ç”»é¢ã‚’å†æç”»ã—ã¦ã‚«ãƒ¼ãƒ‰ãŒæ¶ˆå¤±ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                render();
            }
        }
        
        // ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
        function displayComments(comments) {
            const container = document.getElementById('comments-section');
            if (!comments || comments.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            container.innerHTML = comments.map(comment => {
                const commentDate = new Date(comment.timestamp);
                const timeAgo = getTimeAgo(commentDate);
                const processedText = processMentions(comment.text);
                
                return `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-time">${timeAgo}</span>
                        </div>
                        <div class="comment-body">${processedText}</div>
                    </div>
                `;
            }).join('');
            
            // æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            container.scrollTop = container.scrollHeight;
        }
        
        function processMentions(text) {
            // @ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã«å¤‰æ›
            return text.replace(/@(\w+[^\s]*)/g, '<span class="mention">@$1</span>');
        }
        
        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        let mentionSuggestionIndex = -1;
        let mentionStartPos = -1;
        let mentionQuery = '';
        
        function setupMentionSystem() {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚ŒãŸã¨ãã«åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
            // editTask ã¨ openTaskModal å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹
        }
        
        function initMentionListeners() {
            const commentInput = document.getElementById('comment-input');
            if (!commentInput) return;
            
            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦é‡è¤‡ã‚’é˜²ã
            commentInput.removeEventListener('input', handleMentionInput);
            commentInput.removeEventListener('keydown', handleMentionKeydown);
            
            commentInput.addEventListener('input', handleMentionInput);
            commentInput.addEventListener('keydown', handleMentionKeydown);
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚ŒãŸã¨ãã¯å€™è£œã‚’éè¡¨ç¤º
            commentInput.addEventListener('blur', () => {
                setTimeout(() => hideMentionSuggestions(), 200);
            });
        }
        
        function handleMentionInput(e) {
            const input = e.target;
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            // @ãƒãƒ¼ã‚¯ã®ä½ç½®ã‚’æ¢ã™
            let atPos = -1;
            for (let i = cursorPos - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atPos = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }
            
            if (atPos !== -1) {
                mentionStartPos = atPos;
                mentionQuery = text.substring(atPos + 1, cursorPos);
                showMentionSuggestions(mentionQuery, input);
            } else {
                hideMentionSuggestions();
            }
        }
        
        function handleMentionKeydown(e) {
            const suggestions = document.getElementById('mention-suggestions');
            if (suggestions.style.display === 'none') return;
            
            const suggestionItems = suggestions.querySelectorAll('.mention-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                mentionSuggestionIndex = Math.min(mentionSuggestionIndex + 1, suggestionItems.length - 1);
                updateMentionSelection(suggestionItems);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                mentionSuggestionIndex = Math.max(mentionSuggestionIndex - 1, 0);
                updateMentionSelection(suggestionItems);
            } else if (e.key === 'Enter' && mentionSuggestionIndex >= 0) {
                e.preventDefault();
                const selectedItem = suggestionItems[mentionSuggestionIndex];
                if (selectedItem) {
                    insertMention(selectedItem.textContent);
                }
            } else if (e.key === 'Escape') {
                hideMentionSuggestions();
            }
        }
        
        function showMentionSuggestions(query, input) {
            const suggestions = document.getElementById('mention-suggestions');
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’å–å¾—ï¼ˆç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–ï¼‰
            const activeUsers = getActiveUsers();
            const availableUsers = activeUsers.map(user => user.name).filter(name => name);
            
            const filteredUsers = availableUsers.filter(user => 
                user.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredUsers.length === 0) {
                hideMentionSuggestions();
                return;
            }
            
            suggestions.innerHTML = filteredUsers.map((user, index) => 
                `<div class="mention-suggestion" onclick="insertMention('${user}')">${user}</div>`
            ).join('');
            
            // ä½ç½®ã‚’èª¿æ•´
            const rect = input.getBoundingClientRect();
            suggestions.style.left = '10px';
            suggestions.style.bottom = '60px';
            suggestions.style.display = 'block';
            
            mentionSuggestionIndex = -1;
        }
        
        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === mentionSuggestionIndex);
            });
        }
        
        function insertMention(userName) {
            const input = document.getElementById('comment-input');
            const text = input.value;
            const beforeMention = text.substring(0, mentionStartPos);
            const afterMention = text.substring(input.selectionStart);
            
            const newText = `${beforeMention}@${userName} ${afterMention}`;
            input.value = newText;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
            const newCursorPos = mentionStartPos + userName.length + 2;
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            hideMentionSuggestions();
            input.focus();
        }
        
        function hideMentionSuggestions() {
            const suggestions = document.getElementById('mention-suggestions');
            suggestions.style.display = 'none';
            mentionSuggestionIndex = -1;
            mentionStartPos = -1;
            mentionQuery = '';
        }
        
        function addComment() {
            console.log('ğŸ“ [COMMENT] addComment function called');
            console.log('ğŸ“ [COMMENT] Function context:', typeof addComment, window.addComment === addComment);
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            
            console.log('ğŸ“ [COMMENT] Comment text:', commentText);
            console.log('ğŸ“ [COMMENT] editingTask:', editingTask);
            
            if (!commentText) {
                alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã®å‡¦ç†
            if (!editingTask) {
                console.log('ğŸ“ [COMMENT] ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ - ä¸€æ™‚ä¿å­˜ã—ã¾ã™');
                // ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸€æ™‚ä¿å­˜
                window.pendingComment = commentText;
                commentInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚¿ã‚¹ã‚¯ä½œæˆå¾Œã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚');
                return;
            }
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‹ã‚‰å„ªå…ˆå–å¾—ï¼‰
            let currentUser = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user && session.user.name) {
                    currentUser = session.user.name;
                    console.log(`ğŸ“ [COMMENT] ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser}`);
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã‹ã‚‰å–å¾—
                    currentUser = document.getElementById('assignee-filter')?.value || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                    console.log(`ğŸ“ [COMMENT] ãƒ•ã‚£ãƒ«ã‚¿ã‹ã‚‰å–å¾—: ${currentUser}`);
                }
            } catch (error) {
                console.log(`âš ï¸ [COMMENT] ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
                currentUser = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            }
            
            const newComment = {
                id: Date.now(),
                author: currentUser || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                text: commentText,
                timestamp: new Date().toISOString()
            };
            
            // editingTaskãŒã‚ã‚‹å ´åˆã¯ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯ã«ã€ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
            if (editingTask) {
                // ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
                if (!editingTask.comments) editingTask.comments = [];
                editingTask.comments.push(newComment);
                
                // â˜…â˜…â˜… é‡è¦ï¼štasksé…åˆ—å†…ã®ã‚¿ã‚¹ã‚¯å…¨ä½“ã‚’åŒæœŸ â˜…â˜…â˜…
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('ğŸ” [COMMENT SYNC] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('ğŸ” [COMMENT SYNC] Before sync - Task exists:', !!tasks[taskIndex]);
                    // editingTaskå…¨ä½“ã‚’tasksé…åˆ—ã«åŒæœŸ
                    tasks[taskIndex] = { ...editingTask };
                    console.log('ğŸ” [COMMENT SYNC] After sync - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        commentsCount: tasks[taskIndex].comments ? tasks[taskIndex].comments.length : 0
                    });
                } else {
                    console.error('âŒ [COMMENT SYNC] Task not found in tasks array! EditingTask ID:', editingTask.id);
                }
                
                console.log('ğŸ“ [COMMENT] About to save tasks and render');
                
                // ğŸ”§ ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã«ã‚ˆã‚‹ä¿å­˜ã§ã‚ã‚‹ã“ã¨ã‚’ãƒãƒ¼ã‚¯ï¼ˆé‡è¤‡é€šçŸ¥é˜²æ­¢ï¼‰
                window.isCommentSaveOperation = true;
                saveTasks();
                // ãƒ•ãƒ©ã‚°ã¯çŸ­æ™‚é–“å¾Œã«ãƒªã‚»ãƒƒãƒˆï¼ˆFirebase onSnapshotã®å‡¦ç†å¾Œï¼‰
                setTimeout(() => {
                    window.isCommentSaveOperation = false;
                }, 1000);
                
                displayComments(editingTask.comments);
                
                console.log('ğŸ“ [COMMENT] About to call render()');
                // ç”»é¢ã‚’å†æç”»ã—ã¦ã‚«ãƒ¼ãƒ‰ãŒæ¶ˆå¤±ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                render();
                console.log('ğŸ“ [COMMENT] render() completed');
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ã¨ä¸€èˆ¬ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ã‚’çµ±åˆã—ã¦å®Ÿè¡Œ
                checkUnifiedCommentNotifications(commentText, currentUser, editingTask.id);
            }
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            commentInput.value = '';
            
        }
        
        // addCommenté–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ç™»éŒ²
        window.addComment = addComment;
        
        // çµ±åˆã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³+ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ã®é‡è¤‡ã‚’æ’é™¤ï¼‰
        function checkUnifiedCommentNotifications(commentText, author, taskId) {
            console.log(`ğŸ” [UNIFIED-NOTIFY] çµ±åˆé€šçŸ¥ãƒã‚§ãƒƒã‚¯é–‹å§‹: "${commentText}" by ${author}`);
            
            // ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
            const task = tasks.find(t => t.id === taskId);
            
            // éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®é€šçŸ¥æŠ‘åˆ¶ãƒã‚§ãƒƒã‚¯
            if (task && task.isHidden) {
                console.log(`ğŸ”’ [UNIFIED-NOTIFY] éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${task.title}`);
                return;
            }
            
            // ğŸ”§ é‡è¤‡é€šçŸ¥é˜²æ­¢: åŒã˜ã‚³ãƒ¡ãƒ³ãƒˆã§çŸ­æ™‚é–“å†…ã«è¤‡æ•°å›å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’é˜²ã
            const notificationKey = `${taskId}-${commentText}-${author}`;
            const now = Date.now();
            
            if (!window.lastCommentNotifications) {
                window.lastCommentNotifications = new Map();
            }
            
            const lastNotification = window.lastCommentNotifications.get(notificationKey);
            if (lastNotification && (now - lastNotification < 2000)) { // 2ç§’ä»¥å†…ã®é‡è¤‡ã‚’é˜²ã
                console.log(`ğŸ”• [UNIFIED-NOTIFY] é‡è¤‡é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${notificationKey}`);
                return;
            }
            
            window.lastCommentNotifications.set(notificationKey, now);
            
            // å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ5ç§’ã‚ˆã‚Šå¤ã„ã‚‚ã®ã‚’å‰Šé™¤ï¼‰
            for (const [key, timestamp] of window.lastCommentNotifications.entries()) {
                if (now - timestamp > 5000) {
                    window.lastCommentNotifications.delete(key);
                }
            }
            if (!task) {
                console.log(`âŒ [UNIFIED-NOTIFY] ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${taskId}`);
                return;
            }
            
            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’å–å¾—
            const assignees = task.assignees || [];
            const approvers = task.approvers || [];
            
            // ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.isLoggedIn) {
                console.log('âš ï¸ [UNIFIED-NOTIFY] ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªãƒ­ã‚°ã‚¤ãƒ³ - çµ±åˆé€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            console.log(`ğŸ” [UNIFIED-NOTIFY] ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser.name}`);
            console.log(`ğŸ” [UNIFIED-NOTIFY] ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…: ${author}`);
            
            // ğŸ”§ ä½œæˆè€…ãŒundefinedã®å ´åˆã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½¿ç”¨
            if (!author || author === 'undefined') {
                author = currentUser.name;
                console.log(`ğŸ”§ [UNIFIED-NOTIFY] ä½œæˆè€…ã‚’currentUserã«ä¿®æ­£: ${author}`);
            }
            
            // @ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’æ¤œå‡º
            const mentionPattern = /@([^\s@]+)/g;
            const mentions = commentText.match(mentionPattern);
            const mentionedUsers = mentions ? mentions.map(m => m.substring(1)) : [];
            
            console.log(`ğŸ” [UNIFIED-NOTIFY] æ¤œå‡ºã•ã‚ŒãŸãƒ¡ãƒ³ã‚·ãƒ§ãƒ³:`, mentionedUsers);
            
            // é€šçŸ¥å¯¾è±¡è€…ã‚’çµ±åˆã—ã¦æ±ºå®š
            const allNotifyTargets = new Set();
            
            // ğŸ”§ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…ï¼‰ã®æƒ…å ±ã‚’å–å¾—ï¼ˆæ—¢ã«ä¸Šã§å–å¾—æ¸ˆã¿ï¼‰
            const currentUserIdentifiers = [
                currentUser?.name,
                currentUser?.email,
                currentUser?.id,
                author // ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…
            ].filter(Boolean);
            
            // ğŸ”§ è‡ªåˆ†ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ãŸå ´åˆã¯é€šçŸ¥å¯¾è±¡ã«å«ã‚ã‚‹
            const selfMentioned = mentionedUsers.some(mentionedUser => 
                currentUserIdentifiers.includes(mentionedUser)
            );
            
            console.log(`ğŸ” [COMMENT-FILTER] é™¤å¤–å¯¾è±¡: ${currentUserIdentifiers.join(', ')}`);
            console.log(`ğŸ” [COMMENT-FILTER] è‡ªåˆ†ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³: ${selfMentioned}`);
            
            // ğŸ”§ ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¯¾è±¡è€…ã®ã¿ã«é€šçŸ¥ï¼ˆè‡ªåˆ†ã¯é™¤å¤–ï¼‰
            if (mentionedUsers.length > 0) {
                console.log(`ğŸ“§ [COMMENT-FILTER] ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ãƒ¢ãƒ¼ãƒ‰: ${mentionedUsers.join(', ')}`);
                mentionedUsers.forEach(mentionedUser => {
                    const isCurrentUser = currentUserIdentifiers.includes(mentionedUser);
                    const shouldInclude = !isCurrentUser; // è‡ªåˆ†ã¯å¸¸ã«é™¤å¤–
                    console.log(`ğŸ” [COMMENT-FILTER] ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ ${mentionedUser}: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼=${isCurrentUser}, å«ã‚ã‚‹=${shouldInclude}`);
                    if (shouldInclude) {
                        allNotifyTargets.add(mentionedUser);
                    }
                });
            } else {
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã¯ã€æ‹…å½“è€…ãƒ»æ‰¿èªè€…ã«é€šçŸ¥ï¼ˆè‡ªåˆ†ã¯é™¤å¤–ï¼‰
                console.log(`ğŸ“§ [COMMENT-FILTER] é€šå¸¸ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ãƒ¢ãƒ¼ãƒ‰`);
                assignees.forEach(assignee => {
                    const isNotCurrentUser = !currentUserIdentifiers.includes(assignee);
                    console.log(`ğŸ” [COMMENT-FILTER] æ‹…å½“è€… ${assignee}: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„=${isNotCurrentUser}, å«ã‚ã‚‹=${isNotCurrentUser}`);
                    if (isNotCurrentUser) {
                        allNotifyTargets.add(assignee);
                    }
                });
                
                approvers.forEach(approver => {
                    const isNotCurrentUser = !currentUserIdentifiers.includes(approver);
                    console.log(`ğŸ” [COMMENT-FILTER] æ‰¿èªè€… ${approver}: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„=${isNotCurrentUser}, å«ã‚ã‚‹=${isNotCurrentUser}`);
                    if (isNotCurrentUser) {
                        allNotifyTargets.add(approver);
                    }
                });
            }
            
            const targetUsers = Array.from(allNotifyTargets);
            console.log(`ğŸ” [UNIFIED-NOTIFY] çµ±åˆé€šçŸ¥å¯¾è±¡è€…:`, targetUsers);
            
            if (targetUsers.length === 0) {
                // ğŸ”§ ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ãŒå…¨ã¦è‡ªåˆ†ã®å ´åˆã¯é€šçŸ¥ã‚’é€ä¿¡ã—ãªã„
                if (mentionedUsers.length > 0 && selfMentioned) {
                    console.log('ğŸ”• [UNIFIED-NOTIFY] è‡ªåˆ†ã®ã¿ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ - é€šçŸ¥é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã®ã¿å…¨ä½“é€šçŸ¥ã‚’å®Ÿè¡Œ
                console.log('ğŸ”” [UNIFIED-NOTIFY] é€šçŸ¥å¯¾è±¡è€…ãªã— - å…¨ä½“é€šçŸ¥ã‚’å®Ÿè¡Œ');
                
                const generalMessage = `ğŸ’¬ ${author}ã•ã‚“ãŒã€Œ${task.title}ã€ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ\n\nã€Œ${commentText}ã€\n\næ‹…å½“è€…: ${assignees.join(', ') || 'æœªè¨­å®š'}\næœŸé™: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'æœªè¨­å®š'}`;
                
                showNotification('ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ', generalMessage, {
                    taskId: taskId,
                    targetUser: 'all',
                    type: 'comment'
                });
                return;
            }
            
            // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æœ‰ã‚Šã®å ´åˆã¨ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ç„¡ã—ã®å ´åˆã§é€šçŸ¥å†…å®¹ã‚’èª¿æ•´
            const hasMentions = mentionedUsers.length > 0;
            const notificationTitle = hasMentions ? 'ğŸ’¬ ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥' : 'ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥';
            
            // ğŸ”§ ç†æƒ³çš„ãªã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥å½¢å¼ã‚’å®Ÿè£…
            function extractMentionMessages(text) {
                // @ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãã®å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
                const mentionPairs = [];
                const mentionPattern = /@([^\s@]+)/g;
                let lastIndex = 0;
                let match;
                
                const matches = [];
                while ((match = mentionPattern.exec(text)) !== null) {
                    matches.push({
                        user: match[1],
                        index: match.index,
                        fullMatch: match[0]
                    });
                }
                
                for (let i = 0; i < matches.length; i++) {
                    const currentMatch = matches[i];
                    const nextMatch = matches[i + 1];
                    
                    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆæ¬¡ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¾ã§ã€ã¾ãŸã¯æœ«å°¾ã¾ã§ï¼‰
                    const startPos = currentMatch.index + currentMatch.fullMatch.length;
                    const endPos = nextMatch ? nextMatch.index : text.length;
                    const message = text.substring(startPos, endPos).trim();
                    
                    if (message) {
                        mentionPairs.push({
                            user: currentMatch.user,
                            message: message
                        });
                    }
                }
                
                return mentionPairs;
            }
            
            let notificationMessage;
            
            if (hasMentions) {
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³è§£æ
                const mentionPairs = extractMentionMessages(commentText);
                
                // æ‹…å½“è€…å…¨å“¡ã¸ã®æ¦‚è¦é€šçŸ¥
                const assigneeMentions = assignees.map(name => {
                    const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(name) : `@${name}`;
                    return slackUsername;
                }).join(' ');
                
                notificationMessage = `${assigneeMentions}\n`;
                notificationMessage += `ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€ã«${author}ã•ã‚“ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã—ãŸ\n\n`;
                
                // å€‹åˆ¥ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’è¿½åŠ 
                mentionPairs.forEach(pair => {
                    const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(pair.user) : `@${pair.user}`;
                    notificationMessage += `${slackUsername}\n${pair.message}\n\n`;
                });
                
                // ä½™åˆ†ãªæ”¹è¡Œã‚’å‰Šé™¤
                notificationMessage = notificationMessage.trim();
                
            } else {
                // é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãªã—ï¼‰
                const assigneeMentions = assignees.map(name => {
                    const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(name) : `@${name}`;
                    return slackUsername;
                }).join(' ');
                
                notificationMessage = `${assigneeMentions}\n`;
                notificationMessage += `ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€ã«${author}ã•ã‚“ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã—ãŸ\n\n`;
                notificationMessage += `${commentText}`;
            }
            
            // ğŸ”§ ã‚·ãƒ³ãƒ—ãƒ«ãªçµ±åˆé€šçŸ¥ï¼ˆä½™è¨ˆãªæƒ…å ±ã¯å‰Šé™¤ï¼‰
            showNotification(notificationTitle, notificationMessage, {
                taskId: taskId,
                targetUser: 'all', // ã‚·ãƒ³ãƒ—ãƒ«ã«å…¨ä½“é€šçŸ¥ã¨ã—ã¦é€ä¿¡
                type: 'structured_comment',
                hasMentions: hasMentions
            });
            
            console.log(`âœ… [UNIFIED-NOTIFY] çµ±åˆé€šçŸ¥é€ä¿¡å®Œäº†: ${targetUsers.length}äººã«1ã¤ã®é€šçŸ¥`);
        }
        
        function checkMentionNotifications(text, author, taskId) {
            // âš ï¸ [å»ƒæ­¢] ã“ã®é–¢æ•°ã¯çµ±åˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  (checkUnifiedCommentNotifications) ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã—ãŸ
            // é‡è¤‡é€šçŸ¥ã‚’é˜²ããŸã‚ã€ã“ã®é–¢æ•°ã¯å®Œå…¨ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™
            console.log(`âš ï¸ [DEPRECATED] checkMentionNotifications ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ - é‡è¤‡é€šçŸ¥é˜²æ­¢`);
            console.log(`ğŸš« [BLOCKED] çµ±åˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ãŒæ—¢ã«å®Ÿè¡Œæ¸ˆã¿ã®ãŸã‚ã€é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`);
            
            // ä½•ã‚‚ã—ãªã„ - é‡è¤‡é€šçŸ¥ã‚’å®Œå…¨ã«é˜²ã
            return;
        }
        
        // ä¸€èˆ¬ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥é–¢æ•°ï¼ˆçµ±åˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã«ç½®ãæ›ãˆæ¸ˆã¿ï¼‰
        // ä¸€èˆ¬ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥é–¢æ•°ï¼ˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä»¥å¤–ï¼‰
        function sendGeneralCommentNotification(commentText, commentAuthor, taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            console.log('ğŸ”” [COMMENT-NOTIFY] ä¸€èˆ¬ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ãƒã‚§ãƒƒã‚¯é–‹å§‹');
            
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.name) return;
            
            // æ‹…å½“è€…ã¨æ‰¿èªè€…ã®é€šçŸ¥å¯¾è±¡ã‚’æ±ºå®šï¼ˆä½œæˆè€…ã‚‚æ‹…å½“è€…ãªã‚‰å«ã‚ã‚‹ï¼‰
            const notifyTargets = new Set();
            
            // ã‚¿ã‚¹ã‚¯ã®æ‹…å½“è€…
            if (task.assignees && Array.isArray(task.assignees)) {
                task.assignees.forEach(assignee => {
                    if (assignee !== commentAuthor) {
                        notifyTargets.add(assignee);
                    }
                });
            }
            
            
            const targetUsers = Array.from(notifyTargets);
            
            // é€šçŸ¥å¯¾è±¡è€…ãŒã„ãªã„å ´åˆã§ã‚‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã•ã‚ŒãŸã“ã¨ã‚’å…¨ä½“ã«é€šçŸ¥
            if (targetUsers.length === 0) {
                console.log('ğŸ”” [COMMENT-NOTIFY] é€šçŸ¥å¯¾è±¡è€…ãªã— - å…¨ä½“é€šçŸ¥ã‚’å®Ÿè¡Œ');
                
                const generalMessage = `ğŸ’­ ${commentAuthor}ã•ã‚“ãŒã€Œ${task.title}ã€ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ\n\nã€Œ${commentText}ã€\n\næ‹…å½“è€…: ${task.assignees?.join(', ') || 'æœªè¨­å®š'}\næœŸé™: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'æœªè¨­å®š'}`;
                
                showNotification('ğŸ’­ ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ', generalMessage, {
                    taskId: taskId,
                    targetUser: 'all', // å…¨ä½“é€šçŸ¥ã‚’ç¤ºã™ç‰¹åˆ¥ãªå€¤
                    type: 'comment'
                });
                return;
            }
            
            console.log('ğŸ”” [COMMENT-NOTIFY] é€šçŸ¥å¯¾è±¡:', targetUsers);
            
            // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šè©³ç´°ã«
            const detailedMessage = `ğŸ’­ ${commentAuthor}ã•ã‚“ãŒã€Œ${task.title}ã€ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ\n\nã€Œ${commentText}ã€\n\næ‹…å½“è€…: ${task.assignees?.join(', ') || 'æœªè¨­å®š'}\næœŸé™: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'æœªè¨­å®š'}`;
            
            targetUsers.forEach(targetUser => {
                showNotification('ğŸ’­ ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥', detailedMessage, {
                    taskId: taskId,
                    targetUser: targetUser,
                    type: 'comment'
                });
            });
        }
        
        function checkCollaborativeTaskNotifications(task, assignedUsers) {
            // ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            const currentUser = getCurrentUser();
            console.log('ğŸ” [ASSIGN-NOTIFY-DEBUG] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', currentUser);
            console.log('ğŸ” [ASSIGN-NOTIFY-DEBUG] Firebaseèªè¨¼çŠ¶æ…‹:', window.currentFirebaseUser ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³');
            console.log('ğŸ” [ASSIGN-NOTIFY-DEBUG] ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±:', JSON.parse(localStorage.getItem('currentSession') || 'null'));
            
            if (!currentUser || !currentUser.isLoggedIn) {
                console.warn('âš ï¸ [ASSIGN-NOTIFY] ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªãƒ­ã‚°ã‚¤ãƒ³ - å‰²ã‚Šå½“ã¦é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—');
                console.warn('âš ï¸ [ASSIGN-NOTIFY] ãƒ‡ãƒãƒƒã‚°:', {
                    hasCurrentUser: !!currentUser,
                    isLoggedIn: currentUser ? currentUser.isLoggedIn : 'N/A',
                    hasFirebaseUser: !!window.currentFirebaseUser
                });
                return;
            }
            
            console.log(`ğŸ” [ASSIGN-NOTIFY] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser.name}`);
            console.log(`ğŸ” [ASSIGN-NOTIFY] å‰²ã‚Šå½“ã¦å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼:`, assignedUsers);
            
            // è¤‡æ•°ã®æ‹…å½“è€…ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸå ´åˆã€çµ±åˆé€šçŸ¥ã‚’é€ä¿¡
            if (assignedUsers && assignedUsers.length > 0) {
                // ğŸ”§ å…¨ã¦ã®æ‹…å½“è€…ã«é€šçŸ¥ï¼ˆè‡ªåˆ†ã‚‚å«ã‚ã‚‹ - Slacké€šçŸ¥ã®ãŸã‚ï¼‰
                const notifyUsers = assignedUsers.filter(user => {
                    const isValidUser = user && user.trim() !== '';
                    console.log(`ğŸ” [ASSIGN-NOTIFY] ${user}: æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ = ${isValidUser} (è‡ªåˆ†ã‚‚é€šçŸ¥å¯¾è±¡ã«å«ã‚ã‚‹)`);
                    return isValidUser;
                });
                
                if (notifyUsers.length === 0) {
                    console.log(`âŒ [ASSIGN-NOTIFY] é€šçŸ¥å¯¾è±¡è€…ãªã—`);
                    return;
                }
                
                console.log(`ğŸ” [ASSIGN-NOTIFY] çµ±åˆé€šçŸ¥å¯¾è±¡è€…:`, notifyUsers);
                
                if (notifyUsers.length === 1) {
                    // 1äººã®å ´åˆã¯å€‹åˆ¥é€šçŸ¥
                    showNotification(
                        'ğŸ‘¥ ã‚¿ã‚¹ã‚¯å‰²ã‚Šå½“ã¦é€šçŸ¥',
                        `${currentUser.name}ã•ã‚“ãŒã‚ãªãŸã‚’ã€Œ${task.title}ã€ã®æ‹…å½“è€…ã«è¨­å®šã—ã¾ã—ãŸ\n\nã‚¿ã‚¹ã‚¯è©³ç´°:\nã‚¿ã‚¤ãƒˆãƒ«: ${task.title}\næœŸé™: ${task.deadline || 'æœªè¨­å®š'}\nä½œæˆè€…: ${currentUser.name}`,
                        { 
                            taskId: task.id,
                            targetUser: notifyUsers[0],
                            type: 'task_assignment'
                        }
                    );
                    console.log(`âœ… [ASSIGN-NOTIFY] å€‹åˆ¥é€šçŸ¥é€ä¿¡: ${currentUser.name} â†’ ${notifyUsers[0]}`);
                } else {
                    // è¤‡æ•°äººã®å ´åˆã¯çµ±åˆé€šçŸ¥ï¼ˆæ­£ã—ã„Slackãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰
                    const mentionText = notifyUsers.map(user => {
                        const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(user) : `@${user}`;
                        return slackUsername;
                    }).join(' ');
                    const integratedMessage = `ã•ã‚“ã€æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã®æ‹…å½“è€…ã«è¨­å®šã•ã‚Œã¾ã—ãŸ\n\nã‚¿ã‚¹ã‚¯è©³ç´°:\nã‚¿ã‚¤ãƒˆãƒ«: ${task.title}\næœŸé™: ${task.deadline || 'æœªè¨­å®š'}\nä½œæˆè€…: ${currentUser.name}\n\nå…¨æ‹…å½“è€…: ${assignedUsers.join(', ')}`;
                    
                    showNotification(
                        'ğŸ‘¥ è¤‡æ•°æ‹…å½“è€…å‰²ã‚Šå½“ã¦é€šçŸ¥',
                        integratedMessage,
                        { 
                            taskId: task.id,
                            targetUser: 'multiple',
                            mentionUsers: notifyUsers,
                            type: 'task_assignment_multiple'
                        }
                    );
                    console.log(`âœ… [ASSIGN-NOTIFY] çµ±åˆé€šçŸ¥é€ä¿¡: ${notifyUsers.length}äººã«1ã¤ã®é€šçŸ¥`);
                }
            }
        }
        
        // ã‚¿ã‚¹ã‚¯ä½œæˆé€šçŸ¥é–¢æ•°
        function sendTaskCreationNotification(task, assignees) {
            console.log('ğŸ”” [TASK-CREATE] ã‚¿ã‚¹ã‚¯ä½œæˆé€šçŸ¥é–‹å§‹:', task.title);
            
            // éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®é€šçŸ¥æŠ‘åˆ¶ãƒã‚§ãƒƒã‚¯
            if (task.isHidden) {
                console.log(`ğŸ”’ [TASK-CREATE] éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${task.title}`);
                return;
            }
            
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.name) {
                console.log('âŒ [TASK-CREATE] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—');
                return;
            }
            
            // ğŸ”§ é‡è¤‡æ’é™¤ï¼šæ‹…å½“è€…é…åˆ—ã®é‡è¤‡ã‚’æ’é™¤ï¼ˆè‡ªåˆ†ã‚‚å«ã‚ã‚‹ - Slacké€šçŸ¥ã®ãŸã‚ï¼‰
            const uniqueTargetUsers = Array.from(new Set(
                assignees.filter(assignee => {
                    const isValidAssignee = assignee && assignee.trim() !== '';
                    console.log(`ğŸ” [CREATE-FILTER] ${assignee}: æœ‰åŠ¹=${isValidAssignee} (è‡ªåˆ†ã‚‚é€šçŸ¥å¯¾è±¡ã«å«ã‚ã‚‹)`);
                    return isValidAssignee;
                })
            ));
            
            console.log('ğŸ”” [TASK-CREATE] å…ƒã®æ‹…å½“è€…:', assignees);
            console.log('ğŸ”” [TASK-CREATE] é€šçŸ¥å¯¾è±¡ï¼ˆè‡ªåˆ†å«ã‚€ï¼‰:', uniqueTargetUsers);
            console.log(`ğŸ”” [TASK-CREATE] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser.name} (è‡ªåˆ†ã¸ã®é€šçŸ¥ã‚‚é€ä¿¡)`);
            
            if (uniqueTargetUsers.length === 0) {
                console.log('ğŸ”” [TASK-CREATE] é€šçŸ¥å¯¾è±¡è€…ãªã—');
                return;
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆï¼ˆé‡è¤‡ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ’é™¤æ¸ˆã¿ï¼‰
            const message = `æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ã€Œ${task.title}ã€\n\nä½œæˆè€…: ${currentUser.name}\næ‹…å½“è€…: ${assignees.join(', ')}\næœŸé™: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'æœªè¨­å®š'}`;
            
            // çµ±åˆé€šçŸ¥ã¨ã—ã¦1å›ã ã‘é€ä¿¡ï¼ˆshowNotificationå†…ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆï¼‰
            showNotification('ğŸ“ ã‚¿ã‚¹ã‚¯ä½œæˆé€šçŸ¥', message, {
                taskId: task.id,
                targetUser: 'multiple',
                mentionUsers: uniqueTargetUsers
            });
            
            console.log(`âœ… [TASK-CREATE] çµ±åˆé€šçŸ¥é€ä¿¡å®Œäº†: ${uniqueTargetUsers.length}äººã«1ã¤ã®é€šçŸ¥`);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜é€šçŸ¥é–¢æ•°
        function sendFileAttachmentNotification(task, attachments) {
            console.log('ğŸ“ [FILE-ATTACH] ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜é€šçŸ¥é–‹å§‹:', task.title);
            
            // éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®é€šçŸ¥æŠ‘åˆ¶ãƒã‚§ãƒƒã‚¯
            if (task.isHidden) {
                console.log(`ğŸ”’ [FILE-ATTACH] éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${task.title}`);
                return;
            }
            
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.name) {
                console.log('âŒ [FILE-ATTACH] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—');
                return;
            }
            
            const fileNames = attachments.map(file => file.name).join(', ');
            const fileCount = attachments.length;
            
            // é€šçŸ¥å¯¾è±¡è€…ã‚’çµ±åˆã—ã¦æ±ºå®šï¼ˆé‡è¤‡æ’é™¤ï¼‰
            const allNotifyTargets = new Set();
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®å ´åˆã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ 
            if (task.projectId && task.projectName) {
                // ğŸ”¥ Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—
                let project = null;
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        project = result.projects.find(p => p.id === task.projectId);
                    }
                }

                if (project && project.members) {
                    project.members.forEach(member => {
                        // ğŸ”§ ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é™¤å¤–ã‚’å¼·åŒ–ï¼ˆåå‰ãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»IDã®å…¨ã¦ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                        const isNotCurrentUser = (
                            member !== currentUser.name &&
                            member !== currentUser.email &&
                            member !== currentUser.id
                        );
                        if (isNotCurrentUser) {
                            allNotifyTargets.add(member);
                        }
                        console.log(`ğŸ” [FILE-FILTER] ${member}: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„=${isNotCurrentUser}`);
                    });
                }
            }
            
            // æ‹…å½“è€…ã‚‚è¿½åŠ ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã¨é‡è¤‡ã™ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«æ’é™¤ã•ã‚Œã‚‹ï¼‰
            if (task.assignees && task.assignees.length > 0) {
                task.assignees.forEach(assignee => {
                    // ğŸ”§ ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é™¤å¤–ã‚’å¼·åŒ–ï¼ˆåå‰ãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»IDã®å…¨ã¦ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                    const isNotCurrentUser = (
                        assignee !== currentUser.name &&
                        assignee !== currentUser.email &&
                        assignee !== currentUser.id
                    );
                    if (isNotCurrentUser) {
                        allNotifyTargets.add(assignee);
                    }
                    console.log(`ğŸ” [FILE-FILTER] ${assignee}: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„=${isNotCurrentUser}`);
                });
            }
            
            const targetUsers = Array.from(allNotifyTargets);
            console.log('ğŸ“ [FILE-ATTACH] é‡è¤‡æ’é™¤å¾Œã®é€šçŸ¥å¯¾è±¡è€…:', targetUsers);
            
            if (targetUsers.length > 0) {
                // ğŸ”§ showNotificationå†…ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å‡¦ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯messageã®ã¿ä½œæˆ
                let message = `ã€Œ${task.title}ã€ã«${fileCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ·»ä»˜ã•ã‚Œã¾ã—ãŸ\n\næ·»ä»˜è€…: ${currentUser.name}\nãƒ•ã‚¡ã‚¤ãƒ«: ${fileNames}`;
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
                if (task.projectId && task.projectName) {
                    message += `\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${task.projectName}`;
                }
                
                message += `\næœŸé™: ${task.deadline ? new Date(task.deadline).toLocaleString('ja-JP') : 'æœªè¨­å®š'}`;
                
                // çµ±åˆé€šçŸ¥ã¨ã—ã¦1å›ã ã‘é€ä¿¡
                showNotification('ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜é€šçŸ¥', message, {
                    taskId: task.id,
                    targetUser: 'multiple',
                    projectId: task.projectId,
                    mentionUsers: targetUsers
                });
                
                console.log(`ğŸ“ [FILE-ATTACH] çµ±åˆé€šçŸ¥é€ä¿¡å®Œäº†: ${targetUsers.length}äººã«1ã¤ã®é€šçŸ¥ï¼ˆé‡è¤‡æ’é™¤æ¸ˆã¿ï¼‰`);
            }
            
            // å…¨ä½“é€šçŸ¥ã¯å»ƒæ­¢ - é–¢ä¿‚è€…ã®ã¿ã®çµ±åˆé€šçŸ¥ã§ååˆ†
            
            console.log('ğŸ“ [FILE-ATTACH] ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜é€šçŸ¥å®Œäº†');
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'ãŸã£ãŸä»Š';
            if (diffMins < 60) return `${diffMins}åˆ†å‰`;
            if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`;
            if (diffDays < 7) return `${diffDays}æ—¥å‰`;
            
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        async function saveTask(event) {
            try {
                console.log('ğŸš€ [SAVE TASK] Starting saveTask function...');
                event.preventDefault();
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ task-column-input ã® required å±æ€§ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤
            const columnInput = document.getElementById('task-column-input');
            const columnSelectionGroup = document.getElementById('column-selection-group');
            const wasRequired = columnInput.hasAttribute('required');
            const isColumnSelectionHidden = columnSelectionGroup.style.display === 'none';
            
            if (isColumnSelectionHidden && wasRequired) {
                columnInput.removeAttribute('required');
                console.log(`ğŸ”§ [FORM] Temporarily removed required attribute from task-column-input`);
            }
            
            const title = document.getElementById('task-title-input').value.trim();
            const date = document.getElementById('task-date-input').value;
            const time = document.getElementById('task-time-input').value;
            
            console.log('ğŸ” [DEADLINE DEBUG] Form values:');
            console.log('ğŸ” [DEADLINE DEBUG] Date input value:', date);
            console.log('ğŸ” [DEADLINE DEBUG] Time input value:', time);
            console.log('ğŸ” [DEADLINE DEBUG] Original deadline:', editingTask ? editingTask.deadline : 'new task');
            const priority = document.getElementById('task-priority-input').value;
            const selectedAssignees = getSelectedAssignees();
            const memo = document.getElementById('task-memo-input').value.trim();
            const fileInput = document.getElementById('task-files-input');
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæƒ…å ±ã‚’å–å¾—
            const selectedProjectId = document.getElementById('task-project-select').value;
            const isProjectTask = selectedProjectId !== '';
            let projectId = '';
            let projectName = '';

            if (isProjectTask) {
                // ğŸ”¥ Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—
                let selectedProject = null;
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        selectedProject = result.projects.find(p => p.id === selectedProjectId);
                    }
                }

                if (selectedProject) {
                    projectId = selectedProject.id;
                    projectName = selectedProject.name;
                    console.log(`ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã¨ã—ã¦ä½œæˆ: ${projectName} (${projectId})`);
                } else {
                    console.error('é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', selectedProjectId);
                    alert('é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
            }
            
            if (!title || !date) {
                alert('ã‚¿ã‚¹ã‚¯åã¨æœŸé™æ—¥ã¯å¿…é ˆã§ã™');
                return;
            }
            
            // Phase 2: PJã‚¿ã‚¹ã‚¯ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (isProjectTask) {
                console.log(`ğŸ” [PJ VALIDATION] ProjectID: "${projectId}", ProjectName: "${projectName}"`);
                
                if (!projectId || !projectName) {
                    alert('PJã‚¿ã‚¹ã‚¯ã®å ´åˆã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯å¿…é ˆã§ã™');
                    // requiredå±æ€§ã‚’å¾©æ´»ã•ã›ã¦ã‹ã‚‰return
                    if (wasRequired && isColumnSelectionHidden) {
                        columnInput.setAttribute('required', '');
                    }
                    return;
                }
                console.log(`ğŸ¯ [PJ TASK] Creating project task: ${projectId} - ${projectName}`);
            }
            
            if (selectedAssignees.length === 0) {
                if (!confirm('æ‹…å½“è€…ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }
            
            // â˜…â˜…â˜… ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã®ä¿®æ­£ï¼šç·¨é›†æ™‚ã®ã¿JSTè£œæ­£ â˜…â˜…â˜…
            let deadline;
            if (editingTask) {
                // ç·¨é›†æ™‚ï¼šãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã¨ã—ã¦è§£é‡ˆã—ã¦UTCã«å¤‰æ›
                const localDateTime = `${date}T${time || '23:59'}`;
                const localDate = new Date(localDateTime);
                console.log('ğŸ” [TIMEZONE SAVE] Edit mode - Local datetime string:', localDateTime);
                console.log('ğŸ” [TIMEZONE SAVE] Edit mode - Local date object:', localDate);
                console.log('ğŸ” [TIMEZONE SAVE] Edit mode - UTC conversion:', localDate.toISOString());
                deadline = localDate;
            } else {
                // æ–°è¦ä½œæˆæ™‚ï¼šå¾“æ¥é€šã‚Šã®å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰
                deadline = new Date(`${date}T${time || '23:59'}`);
                console.log('ğŸ” [TIMEZONE SAVE] New task mode - No timezone adjustment');
            }
            
            console.log('ğŸ” [DEADLINE DEBUG] Constructed deadline:');
            console.log('ğŸ” [DEADLINE DEBUG] Date string:', `${date}T${time || '23:59'}`);
            console.log('ğŸ” [DEADLINE DEBUG] Deadline object:', deadline);
            console.log('ğŸ” [DEADLINE DEBUG] Deadline ISO:', deadline.toISOString());
            console.log('ğŸ” [DEADLINE DEBUG] Current time:', new Date().toISOString());
            console.log('ğŸ” [DEADLINE DEBUG] Is future deadline:', deadline > new Date());
            
            // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
            const attachments = [];
            if (fileInput.files.length > 0) {
                const fileProcessingPromises = Array.from(fileInput.files).map(file => {
                    return new Promise((resolve, reject) => {
                        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ (5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            reject(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ãŒå¤§ãã™ãã¾ã™ï¼ˆ5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰`);
                            return;
                        }
                        
                        const fileInfo = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            lastModified: file.lastModified
                        };
                        
                        // ç”»åƒã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ãƒ‡ãƒ¼ã‚¿URLã‚’ç”Ÿæˆ
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                fileInfo.dataUrl = e.target.result;
                                resolve(fileInfo);
                            };
                            reader.onerror = () => resolve(fileInfo);
                            reader.readAsDataURL(file);
                        } else {
                            resolve(fileInfo);
                        }
                    });
                });
                
                try {
                    const processedFiles = await Promise.all(fileProcessingPromises);
                    attachments.push(...processedFiles);
                } catch (error) {
                    alert(error);
                    return;
                }
            }
            
            if (editingTask) {
                // æœŸé™å¤‰æ›´ã®ç¢ºèªå‡¦ç†
                const oldDeadline = new Date(editingTask.deadline);
                const newDeadline = deadline;
                const wasOverdue = isOverdue(editingTask.deadline, editingTask.columnId);
                const willBeOverdue = isOverdue(newDeadline.toISOString(), editingTask.columnId);
                
                console.log(`ğŸ” [DEADLINE] Checking deadline change for task ${editingTask.id}`);
                // æœŸé™å¤‰æ›´ã®è©³ç´°ãƒ­ã‚°ï¼ˆDEBUGæ™‚ã®ã¿è¡¨ç¤ºï¼‰
                if (window.DEBUG_MODE) {
                    console.log(`ğŸ” [DEADLINE] Old deadline: ${editingTask.deadline}, wasOverdue: ${wasOverdue}`);
                    console.log(`ğŸ” [DEADLINE] New deadline: ${newDeadline.toISOString()}, willBeOverdue: ${willBeOverdue}`);
                }
                console.log(`ğŸ” [DEADLINE] Task column: ${editingTask.columnId}`);
                
                // ç·¨é›†
                console.log('ğŸ” [EDIT] Before updating editingTask:', {
                    id: editingTask.id,
                    title: editingTask.title,
                    projectId: editingTask.projectId,
                    projectName: editingTask.projectName,
                    columnId: editingTask.columnId
                });
                
                editingTask.title = title;
                editingTask.deadline = deadline.toISOString();
                editingTask.priority = priority;
                editingTask.assignees = selectedAssignees;
                // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚å¤ã„assigneeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ä¿æŒ
                editingTask.assignee = selectedAssignees.length > 0 ? selectedAssignees[0] : 'æœªè¨­å®š';
                editingTask.memo = memo;
                editingTask.updatedAt = new Date().toISOString(); // æ›´æ–°æ™‚åˆ»ã‚’è¨˜éŒ²
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’æ›´æ–°ï¼ˆç·¨é›†æ™‚ã¯æ—¢å­˜æƒ…å ±ã‚’ä¿æŒï¼‰
                if (isProjectTask) {
                    editingTask.projectId = projectId;
                    editingTask.projectName = projectName;
                } else if (!editingTask.projectId) {
                    // æ–°è¦ä½œæˆæ™‚ã®ã¿nullã«è¨­å®šã€ç·¨é›†æ™‚ã¯æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ä¿æŒ
                    editingTask.projectId = null;
                    editingTask.projectName = null;
                }
                
                console.log('ğŸ” [EDIT] After updating editingTask:', {
                    id: editingTask.id,
                    title: editingTask.title,
                    projectId: editingTask.projectId,
                    projectName: editingTask.projectName,
                    columnId: editingTask.columnId
                });
                
                // Phase 2: PJã‚¿ã‚¹ã‚¯ã®ç·¨é›†ã§ã¯PJæƒ…å ±ã¯å¤‰æ›´ã—ãªã„
                console.log(`ğŸ“ [TASK EDIT] Updated task: ${editingTask.title}`);
                
                // æ–°ã—ã„æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
                if (attachments.length > 0) {
                    if (!editingTask.attachments) editingTask.attachments = [];
                    editingTask.attachments.push(...attachments);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜é€šçŸ¥ã‚’é€ä¿¡ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ã®é‡è¤‡ã‚’é˜²ããŸã‚ï¼‰
                    console.log('ğŸ“ [FILE-ATTACH] ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™');
                    sendFileAttachmentNotification(editingTask, attachments);
                }
                
                // â˜…â˜…â˜… é‡è¦ï¼štasksé…åˆ—å†…ã®å¯¾å¿œã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚‚æ›´æ–° â˜…â˜…â˜…
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('ğŸ” [CRITICAL] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('ğŸ” [CRITICAL] Before updating tasks array - Task exists:', !!tasks[taskIndex]);
                    // editingTaskã®å…¨ã¦ã®å¤‰æ›´ã‚’tasksé…åˆ—ã«åæ˜ 
                    tasks[taskIndex] = { ...editingTask };
                    console.log('ğŸ” [CRITICAL] After updating tasks array - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        columnId: tasks[taskIndex].columnId
                    });
                } else {
                    console.error('âŒ [CRITICAL] Task not found in tasks array! EditingTask ID:', editingTask.id);
                    console.log('ğŸ” [CRITICAL] Current tasks array IDs:', tasks.map(t => t.id));
                }
            } else {
                // æ–°è¦ä½œæˆ
                const isUnifiedMode = document.getElementById('task-modal').dataset.unifiedMode === 'true';
                const targetColumn = isUnifiedMode 
                    ? document.getElementById('task-column-input').value 
                    : document.getElementById('task-modal').dataset.targetColumn;
                const newTask = {
                    id: Date.now(),
                    title: title,
                    deadline: deadline.toISOString(),
                    priority: priority,
                    assignees: selectedAssignees,
                    // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚å¤ã„assigneeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ä¿æŒ
                    assignee: selectedAssignees.length > 0 ? selectedAssignees[0] : 'æœªè¨­å®š',
                    memo: memo,
                    attachments: attachments,
                    comments: [],
                    columnId: targetColumn,
                    completed: targetColumn === 'done',
                    createdAt: new Date().toISOString(),
                    
                    // ã‚¿ã‚¹ã‚¯éè¡¨ç¤ºæ©Ÿèƒ½
                    isHidden: document.getElementById('task-hidden-input').checked,
                    
                    // Phase 2: PJã‚¿ã‚¹ã‚¯æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                    projectId: isProjectTask ? projectId : null,
                    projectName: isProjectTask ? projectName : null,
                    personalStatus: targetColumn,
                    projectStatus: targetColumn,
                    pendingMove: null,
                };
                
                if (isProjectTask) {
                    console.log(`ğŸ¯ [PJ TASK CREATE] Created new PJ task: ${projectId} - ${projectName}`);
                } else {
                    console.log(`ğŸ‘¤ [PERSONAL TASK CREATE] Created new personal task: ${title}`);
                }
                tasks.unshift(newTask);
                
                // ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã®ä¸€æ™‚ä¿å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                if (window.pendingComment) {
                    console.log('ğŸ“ [COMMENT] ä¸€æ™‚ä¿å­˜ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¿ã‚¹ã‚¯ã«è¿½åŠ :', window.pendingComment);
                    
                    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
                    let currentUser = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                    try {
                        const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                        if (session && session.user && session.user.name) {
                            currentUser = session.user.name;
                        }
                    } catch (error) {
                        console.warn('âš ï¸ [COMMENT] ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—å¤±æ•—:', error);
                    }
                    
                    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¿ã‚¹ã‚¯ã«è¿½åŠ 
                    const comment = {
                        text: window.pendingComment,
                        author: currentUser,
                        timestamp: new Date().toISOString(),
                        id: Date.now()
                    };
                    
                    if (!newTask.comments) {
                        newTask.comments = [];
                    }
                    newTask.comments.push(comment);
                    
                    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥å‡¦ç†
                    checkUnifiedCommentNotifications(window.pendingComment, currentUser.name, newTask.id);
                    
                    // ä¸€æ™‚ä¿å­˜ã‚’ã‚¯ãƒªã‚¢
                    window.pendingComment = null;
                    console.log('âœ… [COMMENT] ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¿ã‚¹ã‚¯ã«è¿½åŠ å®Œäº†');
                }
                
                // ã‚¿ã‚¹ã‚¯ä½œæˆé€šçŸ¥ï¼ˆçµ±åˆé€šçŸ¥å¯¾å¿œæ¸ˆã¿ï¼‰
                sendTaskCreationNotification(newTask, selectedAssignees);
                
                // âš ï¸ [å»ƒæ­¢] checkCollaborativeTaskNotifications ã¯é‡è¤‡é€šçŸ¥ã®åŸå› ã¨ãªã‚‹ãŸã‚ç„¡åŠ¹åŒ–
                // sendTaskCreationNotification ã§çµ±åˆé€šçŸ¥ã¨ã—ã¦å‡¦ç†æ¸ˆã¿
            }
            
            console.log('ğŸ’¾ [EDIT SAVE] About to save tasks and render');
            console.log('ğŸ” [EDIT SAVE] Tasks count before save:', tasks.length);
            console.log('ğŸ” [EDIT SAVE] EditingTask details:', editingTask ? {
                id: editingTask.id,
                title: editingTask.title,
                projectId: editingTask.projectId,
                projectName: editingTask.projectName,
                columnId: editingTask.columnId
            } : 'null');
            
            await saveTasks();
            console.log('ğŸ” [EDIT SAVE] Tasks count after save:', tasks.length);
            
            // ğŸ”’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿è­·ï¼šã‚¿ã‚¹ã‚¯ä½œæˆå‰ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            const currentUserBackup = localStorage.getItem('currentUser');
            console.log('ğŸ”’ [SESSION-PROTECT] ã‚¿ã‚¹ã‚¯ä½œæˆå‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿è­·:', {
                hasSession: !!currentSession,
                userName: currentSession?.user?.name,
                userEmail: currentSession?.user?.email,
                backupUser: currentUserBackup
            });

            // FirebaseåŒæœŸï¼ˆæ–°è¦ã‚¿ã‚¹ã‚¯ã¾ãŸã¯ç·¨é›†ã‚¿ã‚¹ã‚¯ï¼‰
            if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                try {
                    const targetTask = editingTask || tasks[tasks.length - 1]; // ç·¨é›†ä¸­ã¾ãŸã¯æœ€æ–°ã‚¿ã‚¹ã‚¯
                    if (targetTask) {
                        console.log('ğŸ”¥ [FIREBASE] ã‚¿ã‚¹ã‚¯ã‚’Firebaseã«åŒæœŸä¸­...', targetTask.title);
                        
                        if (editingTask) {
                            // ç·¨é›†ã®å ´åˆã¯æ›´æ–°
                            const result = await window.FirebaseDB.updateTask(targetTask.id, targetTask);
                            if (result.success) {
                                console.log('âœ… [FIREBASE] ã‚¿ã‚¹ã‚¯æ›´æ–°æˆåŠŸ:', targetTask.id);
                            } else {
                                console.error('âŒ [FIREBASE] ã‚¿ã‚¹ã‚¯æ›´æ–°ã‚¨ãƒ©ãƒ¼:', result.error);
                            }
                        } else {
                            // ğŸ”¥ æ–°è¦ã®å ´åˆã¯ä½œæˆï¼ˆFirebaseå®Œå…¨ä¾å­˜ï¼‰
                            const result = await window.FirebaseDB.createTask(targetTask);
                            if (result.success) {
                                console.log('âœ… [FIREBASE-ONLY] ã‚¿ã‚¹ã‚¯ä½œæˆæˆåŠŸ:', result.id);
                                // ğŸ”§ LocalStorageã¸ã®ä¿å­˜ã¯ä¸è¦ - Firebaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã§è‡ªå‹•æ›´æ–°
                            } else {
                                console.error('âŒ [FIREBASE] ã‚¿ã‚¹ã‚¯ä½œæˆã‚¨ãƒ©ãƒ¼:', result.error);
                            }
                        }
                    }
                } catch (error) {
                    console.error('âŒ [FIREBASE] åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                }
            } else {
                console.log('ğŸ’¾ [FIREBASE] Firebaseæœªå¯¾å¿œã¾ãŸã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ - LocalStorageã®ã¿');
            }

            // ğŸ”’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿è­·ï¼šFirebaseåŒæœŸå¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
            const sessionAfterSync = JSON.parse(localStorage.getItem('currentSession') || 'null');
            const userAfterSync = localStorage.getItem('currentUser');
            
            if (currentSession && sessionAfterSync) {
                if (currentSession.user?.email !== sessionAfterSync.user?.email) {
                    console.warn('âš ï¸ [SESSION-PROTECT] ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ›´ã‚’æ¤œå‡ºï¼å¾©å…ƒã—ã¾ã™:', {
                        before: currentSession.user?.email,
                        after: sessionAfterSync.user?.email
                    });
                    localStorage.setItem('currentSession', JSON.stringify(currentSession));
                    if (currentUserBackup) {
                        localStorage.setItem('currentUser', currentUserBackup);
                    }
                }
            }
            
            console.log('ğŸ¨ [EDIT SAVE] About to call render()');
            render();
            console.log('ğŸ¨ [EDIT SAVE] render() completed');
            
            // ç·¨é›†ä¿å­˜æ™‚ã®é€šçŸ¥å‡¦ç†ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã¯æ—¢ã«é€šçŸ¥æ¸ˆã¿ãªã®ã§ã€ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ã®ã¿ï¼‰
            // ğŸš« [ç„¡åŠ¹åŒ–] çµ±åˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ãŒæ—¢ã«addCommentå†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€é‡è¤‡é€šçŸ¥ã‚’é˜²ããŸã‚ã«ç„¡åŠ¹åŒ–
            console.log(`ğŸš« [SAVE] ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ã¯addComment()å†…ã§å®Ÿè¡Œæ¸ˆã¿ - é‡è¤‡é˜²æ­¢ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);
            /*
            if (editingTask && editingTask.comments && editingTask.comments.length > 0 && attachments.length === 0) {
                // æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã®ã¿ã®å ´åˆã¯é™¤å¤–ï¼‰
                const latestComment = editingTask.comments[editingTask.comments.length - 1];
                const commentTime = new Date(latestComment.timestamp);
                const now = new Date();
                
                // 5ç§’ä»¥å†…ã«ä½œæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã®ã¿é€šçŸ¥ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜æ™‚ã®èª¤é€šçŸ¥ã‚’é˜²ãï¼‰
                if ((now - commentTime) < 5000) {
                    console.log(`ğŸ”” [SAVE] æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ãƒã‚§ãƒƒã‚¯: "${latestComment.text}"`);
                    checkMentionNotifications(latestComment.text, latestComment.author, editingTask.id);
                }
            }
            */
            
            // ğŸš« ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»ç·¨é›†å¾Œã®æœŸé™ãƒã‚§ãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
            // setTimeout(() => checkDeadlines(), 100);
            
            // required å±æ€§ã‚’å¾©æ´» (çµ±ä¸€ä½œæˆãƒ¢ãƒ¼ãƒ‰ç”¨)
            if (wasRequired && isColumnSelectionHidden) {
                columnInput.setAttribute('required', '');
                console.log(`ğŸ”§ [FORM] Restored required attribute to task-column-input`);
            }
            
            closeModal();
            
            } catch (error) {
                console.error('ğŸš¨ [SAVE TASK ERROR]', error);
                alert('ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚requiredå±æ€§ã‚’å¾©æ´»
                const columnInput = document.getElementById('column-select');
                const wasRequired = columnInput && columnInput.hasAttribute('required');
                if (wasRequired && isColumnSelectionHidden) {
                    columnInput.setAttribute('required', '');
                }
            }
        }
        
        function closeModal() {
            document.getElementById('task-modal').classList.remove('show');
            editingTask = null;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            const fileInput = document.getElementById('task-files-input');
            const dropZone = document.getElementById('file-drop-zone');
            const commentInput = document.getElementById('comment-input');
            
            if (fileInput) {
                fileInput.value = '';
            }
            if (dropZone) {
                dropZone.innerHTML = 'ğŸ“ ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ä¸Šè¨˜ãƒœã‚¿ãƒ³ã§é¸æŠ';
            }
            if (commentInput) {
                commentInput.value = '';
            }
            
            // Phase 2: PJã‚¿ã‚¹ã‚¯è¨­å®šã‚’éè¡¨ç¤ºã«æˆ»ã™
            // PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            // PJãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            
        }
        
        // é‡è¤‡é–¢æ•°å‰Šé™¤: deleteTaské–¢æ•°ã¯å¾Œã§å†å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼ˆ12345è¡Œç›®ï¼‰
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        function handleDragStart(e, taskId) {
            console.log(`ğŸŸ¢ [MAIN] handleDragStart called with taskId: ${taskId}`);
            console.log(`ğŸŸ¢ [MAIN] All tasks:`, tasks);
            console.log(`ğŸŸ¢ [MAIN] isBulkMode: ${isBulkMode}`);
            draggedTask = tasks.find(t => t.id === taskId);
            console.log(`ğŸŸ¢ [MAIN] Found draggedTask:`, draggedTask);
            if (!draggedTask) {
                console.error(`âŒ [MAIN] draggedTask not found for taskId: ${taskId}`);
                return false;
            }
            
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', taskId);
        }
        
        function handleDragEnd(e) {
            console.log(`ğŸ”´ [MAIN] handleDragEnd called`);
            e.target.classList.remove('dragging');
            draggedTask = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        async function handleDrop(e, columnId) {
            console.log(`ğŸ”µ [MAIN] handleDrop called with columnId: ${columnId}`);
            console.log(`ğŸ”µ [MAIN] draggedTask:`, draggedTask);
            console.log(`ğŸ”µ [MAIN] Event target:`, e.target);
            console.log(`ğŸ”µ [MAIN] Event currentTarget:`, e.currentTarget);
            e.preventDefault();
            const dropZone = e.currentTarget;
            dropZone.classList.remove('drag-over');

            // ğŸ”§ draggedTaskã®IDã‚’ä¿å­˜ï¼ˆpromptForEvidenceã§handleDragEndãŒå‘¼ã°ã‚Œã¦nullã«ãªã‚‹å•é¡Œã«å¯¾å‡¦ï¼‰
            const draggedTaskId = draggedTask ? draggedTask.id : null;
            console.log(`ğŸ”§ [FIX] draggedTaskIdä¿å­˜: ${draggedTaskId}`);

            if (draggedTask || draggedTaskId) {
                // draggedTaskãŒnullã®å ´åˆã€IDã‹ã‚‰å†å–å¾—
                if (!draggedTask && draggedTaskId) {
                    draggedTask = tasks.find(t => t.id === draggedTaskId);
                    console.log(`ğŸ”§ [FIX] draggedTaskã‚’IDã‹ã‚‰å†å–å¾—:`, draggedTask);
                }
                console.log(`ğŸ”µ [MAIN] Current task column: ${draggedTask.columnId}, Target: ${columnId}`);
                console.log(`ğŸ” [DROP DEBUG] Tasks count BEFORE move: ${tasks.length}`);
                console.log(`ğŸ” [DROP DEBUG] DraggedTask details:`, JSON.stringify({
                    id: draggedTask.id,
                    title: draggedTask.title,
                    projectId: draggedTask.projectId,
                    projectName: draggedTask.projectName,
                    hasComments: draggedTask.comments ? draggedTask.comments.length : 0,
                    hasAttachments: draggedTask.attachments ? draggedTask.attachments.length : 0
                }, null, 2));
                
                if (draggedTask.columnId !== columnId) {

                    // ğŸš« æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯ï¼šæœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯ç§»å‹•ä¸å¯
                    if (draggedTask.deadline) {
                        const now = new Date();
                        const deadline = new Date(draggedTask.deadline);
                        if (deadline < now) {
                            alert('âš ï¸ ã‚¿ã‚¹ã‚¯ã®æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†é–‹ã™ã‚‹å ´åˆã¯ç·¨é›†ã‹ã‚‰æœŸé™ã‚’å†è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                            console.log(`âŒ [DEADLINE] æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã®ç§»å‹•ã‚’ãƒ–ãƒ­ãƒƒã‚¯: ${draggedTask.title}, æœŸé™: ${draggedTask.deadline}`);
                            // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                            const draggingElement = document.querySelector('.dragging');
                            if (draggingElement) {
                                draggingElement.classList.remove('dragging');
                            }
                            draggedTask = null;
                            return;
                        }
                    }

                    // ğŸ”§ æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼šä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã®ã¿ç§»å‹•å¯èƒ½
                    const currentUser = getCurrentUser();
                    if (currentUser.role === 'user') {
                        const canMove = draggedTask.assignees && draggedTask.assignees.includes(currentUser.name) || 
                                       draggedTask.assignee === currentUser.name;
                        if (!canMove) {
                            alert('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã¯ç§»å‹•ã§ãã¾ã›ã‚“ã€‚è‡ªåˆ†ãŒæ‹…å½“è€…ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®ã¿ç§»å‹•å¯èƒ½ã§ã™ã€‚');
                            // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                            const draggingElement = document.querySelector('.dragging');
                            if (draggingElement) {
                                draggingElement.classList.remove('dragging');
                            }
                            draggedTask = null;
                            return;
                        }
                    }
                    
                    console.log(`ğŸŸ¡ [MAIN] Moving "${draggedTask.title}" from ${draggedTask.columnId} to ${columnId}`);
                    
                    // PJã‚¿ã‚¹ã‚¯ã®è¨¼æ†‘ãƒã‚§ãƒƒã‚¯ï¼ˆç§»å‹•ã®ãŸã³ã«å¿…é ˆï¼‰
                    if (draggedTask.projectId && draggedTask.projectName) {
                        console.log(`ğŸ” [PJ DEBUG] Before evidence check - Tasks count: ${tasks.length}`);
                        const hasEvidence = checkTaskEvidence(draggedTask, true); // ç§»å‹•æ™‚ãƒ•ãƒ©ã‚°ã‚’true
                        console.log(`ğŸ” [PJ DEBUG] Evidence check result: ${hasEvidence}, Tasks count: ${tasks.length}`);
                        
                        if (!hasEvidence) {
                            console.log(`ğŸ” [PJ DEBUG] Before promptForEvidence - Tasks count: ${tasks.length}`);
                            const evidenceResult = await promptForEvidence(draggedTask);
                            console.log(`ğŸ” [PJ DEBUG] After promptForEvidence - Result: ${evidenceResult}, Tasks count: ${tasks.length}`);
                            
                            if (!evidenceResult) {
                                console.log(`âŒ [PJ] è¨¼æ†‘ãªã—ã®ãŸã‚ç§»å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ${draggedTask.title}`);
                                console.log(`ğŸ” [PJ DEBUG] Cancel move - Tasks count: ${tasks.length}`);
                                // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                                const draggingElement = document.querySelector('.dragging');
                                if (draggingElement) {
                                    draggingElement.classList.remove('dragging');
                                }
                                draggedTask = null;
                                return; // ç§»å‹•ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            }
                        }
                        console.log(`ğŸ” [PJ DEBUG] After all evidence checks - Tasks count: ${tasks.length}`);

                        // ğŸ”§ promptForEvidenceå¾Œã«draggedTaskãŒnullã«ãªã£ã¦ã„ã‚‹å ´åˆã€IDã‹ã‚‰å†å–å¾—
                        if (!draggedTask && draggedTaskId) {
                            draggedTask = tasks.find(t => t.id === draggedTaskId);
                            console.log(`ğŸ”§ [FIX] è¨¼æ†‘ãƒã‚§ãƒƒã‚¯å¾Œã«draggedTaskã‚’IDã‹ã‚‰å†å–å¾—:`, draggedTask);
                        }
                    }

                    // ğŸ”§ è¨¼æ†‘ãƒã‚§ãƒƒã‚¯å¤–ã§ã‚‚draggedTaskãŒnullã«ãªã£ã¦ã„ã‚‹å ´åˆã€IDã‹ã‚‰å†å–å¾—
                    if (!draggedTask && draggedTaskId) {
                        draggedTask = tasks.find(t => t.id === draggedTaskId);
                        console.log(`ğŸ”§ [FIX] è¨¼æ†‘ãƒã‚§ãƒƒã‚¯å¤–ã§draggedTaskã‚’IDã‹ã‚‰å†å–å¾—:`, draggedTask);
                    }

                    // Doneã‚«ãƒ©ãƒ ã«ç§»å‹•ã™ã‚‹å ´åˆã€completedAtã‚’è¨˜éŒ²
                    if (columnId === 'done' && !draggedTask.completedAt) {
                        draggedTask.completedAt = new Date().toISOString();
                        // ğŸ”§ tasksé…åˆ—å†…ã‚‚æ›´æ–°
                        const taskIndex = tasks.findIndex(t => t.id === draggedTask.id);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].completedAt = draggedTask.completedAt;
                        }
                    }
                    // Doneã‚«ãƒ©ãƒ ã‹ã‚‰ä»–ã«ç§»å‹•ã™ã‚‹å ´åˆã€completedAtã‚’ã‚¯ãƒªã‚¢
                    else if (draggedTask.columnId === 'done' && columnId !== 'done') {
                        draggedTask.completedAt = null;
                        // ğŸ”§ tasksé…åˆ—å†…ã‚‚æ›´æ–°
                        const taskIndex = tasks.findIndex(t => t.id === draggedTask.id);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].completedAt = null;
                        }
                    }
                    
                    console.log(`ğŸ” [DROP DEBUG] Before column change - Tasks count: ${tasks.length}`);
                    draggedTask.columnId = columnId;
                    draggedTask.completed = (columnId === 'done');

                    // ğŸ”§ tasksé…åˆ—å†…ã®å…ƒã®ã‚¿ã‚¹ã‚¯ã‚‚ç¢ºå®Ÿã«æ›´æ–°ï¼ˆå‚ç…§ãŒåˆ‡ã‚Œã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦ï¼‰
                    const taskIndex = tasks.findIndex(t => t.id === draggedTask.id);
                    if (taskIndex !== -1) {
                        tasks[taskIndex].columnId = columnId;
                        tasks[taskIndex].completed = (columnId === 'done');
                        console.log(`ğŸ”§ [FIX] tasksé…åˆ—å†…ã®ã‚¿ã‚¹ã‚¯ã‚‚æ›´æ–°: index=${taskIndex}, columnId=${columnId}`);
                    } else {
                        console.error(`âŒ [FIX] tasksé…åˆ—å†…ã«ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: id=${draggedTask.id}`);
                    }

                    console.log(`ğŸ” [DROP DEBUG] After column change - Tasks count: ${tasks.length}`);
                    
                    // ã‚¿ã‚¹ã‚¯ç§»å‹•æ™‚åˆ»ã‚’è¨˜éŒ²ã—ã€é€šçŸ¥ã‚’é€ä¿¡ï¼ˆå…¨ã‚¿ã‚¹ã‚¯å¯¾è±¡ï¼‰
                    draggedTask.lastMovedAt = new Date().toISOString();
                    // ğŸ”§ tasksé…åˆ—å†…ã‚‚æ›´æ–°
                    if (taskIndex !== -1) {
                        tasks[taskIndex].lastMovedAt = draggedTask.lastMovedAt;
                    }
                    console.log(`ğŸ“… [TASK MOVE] Recorded move time: ${draggedTask.lastMovedAt}`);
                    
                    // ã‚¿ã‚¹ã‚¯ç§»å‹•æ™‚ã«æœŸé™é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚‚å†ç·¨é›†å¯èƒ½ã«ï¼‰
                    if (draggedTask.overdueNotified || draggedTask.oneDayNotified || draggedTask.threeHourNotified || draggedTask.fiveMinNotified) {
                        console.log(`ğŸ”„ [TASK MOVE] æœŸé™é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ: ${draggedTask.title}`);
                        draggedTask.overdueNotified = false;
                        draggedTask.oneDayNotified = false;
                        draggedTask.threeHourNotified = false;
                        draggedTask.fiveMinNotified = false;
                        // ğŸ”§ tasksé…åˆ—å†…ã‚‚æ›´æ–°
                        if (taskIndex !== -1) {
                            tasks[taskIndex].overdueNotified = false;
                            tasks[taskIndex].oneDayNotified = false;
                            tasks[taskIndex].threeHourNotified = false;
                            tasks[taskIndex].fiveMinNotified = false;
                        }
                    }
                    
                    // æ‹…å½“è€…ã¸ã®ç§»å‹•é€šçŸ¥ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ãƒ»é€šå¸¸ã‚¿ã‚¹ã‚¯ä¸¡æ–¹å¯¾å¿œï¼‰
                    console.log(`ğŸ” [DROP DEBUG] Before notification - Tasks count: ${tasks.length}`);
                    sendPJMoveNotification(draggedTask, columnId);
                    console.log(`ğŸ” [DROP DEBUG] After notification - Tasks count: ${tasks.length}`);
                    
                    console.log(`ğŸ” [DROP DEBUG] Before saveTasks() - Tasks count: ${tasks.length}`);
                    await saveTasks();
                    console.log(`ğŸ” [DROP DEBUG] After saveTasks() - Tasks count: ${tasks.length}`);
                    
                    console.log(`ğŸ” [DROP DEBUG] Before render() - Tasks count: ${tasks.length}`);
                    render();
                    console.log(`ğŸ” [DROP DEBUG] After render() - Tasks count: ${tasks.length}`);
                    
                    console.log(`ğŸ” [DROP DEBUG] Before updateStats() - Tasks count: ${tasks.length}`);
                    updateStats();
                    console.log(`ğŸ” [DROP DEBUG] After updateStats() - Tasks count: ${tasks.length}`);
                    
                    console.log(`âœ… [MAIN] Task moved successfully to ${columnId}`);
                } else {
                    console.log(`âš ï¸ [MAIN] Same column, no move needed`);
                }
            } else {
                console.log(`âŒ [MAIN] No draggedTask found`);
            }
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        
        function getColumnTitle(columnId) {
            const column = columns.find(c => c.id === columnId);
            return column ? column.title : columnId;
        }
        
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let cachedProjectsData = null;
        let cacheTimestamp = 0;
        const CACHE_DURATION = 60000; // 60ç§’

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ å–å¾—ï¼ˆåŒæœŸé–¢æ•°ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨ï¼‰
        function getProjectColumns(projectId) {
            if (!projectId) return columns;

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (cachedProjectsData && (Date.now() - cacheTimestamp < CACHE_DURATION)) {
                const project = cachedProjectsData[projectId];
                if (project && project.columns && project.columns.length > 0) {
                    console.log('âœ… [GET-COLUMNS] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ å–å¾—:', projectId, 'â†’', project.columns);
                    return project.columns.map((columnTitle, index) => ({
                        id: `pj_${projectId}_${index}`,
                        title: columnTitle,
                        color: ['#667eea', '#f59e0b', '#8b5cf6', '#10b981', '#6c757d'][index % 5]
                    }));
                } else {
                    console.warn('âš ï¸ [GET-COLUMNS] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨:', projectId, project);
                }
            } else {
                console.warn('âš ï¸ [GET-COLUMNS] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ:', {
                    hasCachedData: !!cachedProjectsData,
                    cacheAge: Date.now() - cacheTimestamp,
                    cacheDuration: CACHE_DURATION
                });
            }

            console.log('âš ï¸ [GET-COLUMNS] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã‚’è¿”ã™:', projectId);
            return columns; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã‚’ä½¿ç”¨
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        async function updateProjectsCache() {
            if (!window.FirebaseDB) return;

            const result = await window.FirebaseDB.getProjects();
            if (result.success && result.projects) {
                cachedProjectsData = {};
                result.projects.forEach(project => {
                    cachedProjectsData[project.id] = {
                        name: project.name,
                        description: project.description || '',
                        columns: project.columns || ["ğŸ“‹ TODO", "ğŸ”„ é€²è¡Œä¸­", "âœ… å®Œäº†", "ğŸ—‘ï¸ ã‚´ãƒŸç®±"]
                    };
                });
                cacheTimestamp = Date.now();
                console.log('âœ… [CACHE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°:', Object.keys(cachedProjectsData).length, 'ä»¶');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€çš„ã«å–å¾—ã™ã‚‹é–¢æ•°
        async function getAllProjects() {
            // ğŸ”¥ Firebaseã‹ã‚‰å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ï¼ˆLocalStorageä¸ä½¿ç”¨ï¼‰
            if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                try {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success && result.projects) {
                        return result.projects.map(project => ({
                            id: project.id,
                            name: project.name || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåæœªè¨­å®š',
                            description: project.description || '',
                            isPublic: project.visibility === 'public',
                            createdAt: project.createdAt || new Date().toISOString(),
                            createdBy: project.createdBy || 'Unknown',
                            columns: project.columns || ["ğŸ“‹ TODO", "ğŸ”„ é€²è¡Œä¸­", "âœ… å®Œäº†", "ğŸ—‘ï¸ ã‚´ãƒŸç®±"]
                        }));
                    }
                } catch (error) {
                    console.error('âŒ [GET-PROJECTS] Firebaseå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            console.warn('âš ï¸ [GET-PROJECTS] Firebaseæœªæ¥ç¶š');
            return [];
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æç”»
        async function renderProjectsList() {
            const projectsList = document.getElementById('projects-list');
            if (!projectsList) {
                console.error('âŒ [PROJECTS] projects-list element not found!');
                return;
            }

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆçµ±ä¸€é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
            const projects = await getAllProjects();
            
            // å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯æ•°ã‚’è¨ˆç®—ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è€ƒæ…®ï¼‰
            const projectTaskCounts = {};
            const filteredByMember = selectedAssigneeFilters.length > 0 ? 
                tasks.filter(t => {
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(selectedAssigneeFilters[0]);
                    }
                    return t.assignee === selectedAssigneeFilters[0];
                }) : tasks;
                
            filteredByMember.forEach(task => {
                if (task.projectId) {
                    projectTaskCounts[task.projectId] = (projectTaskCounts[task.projectId] || 0) + 1;
                }
            });
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®HTMLç”Ÿæˆ
            let projectsHTML = '';
            
            // é€šå¸¸ã‚¿ã‚¹ã‚¯è¡¨ç¤ºãƒœã‚¿ãƒ³
            const isNormalTasksSelected = selectedProjectFilters.length === 0;
            const normalTasksCount = filteredByMember.filter(t => !t.projectId).length;
            projectsHTML += `
                <div class="project-card ${isNormalTasksSelected ? 'active' : ''}" onclick="showNormalTasks()">
                    <div class="project-card-name">ğŸ“‹ é€šå¸¸ã‚¿ã‚¹ã‚¯</div>
                    <div class="project-card-meta">
                        <span>å€‹äººãƒ»å…±é€šã‚¿ã‚¹ã‚¯</span>
                        <span class="project-card-count">${normalTasksCount}</span>
                    </div>
                </div>
            `;
            
            // å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦è¿½åŠ 
            projects.forEach(project => {
                const taskCount = projectTaskCounts[project.id] || 0;
                const isSelected = selectedProjectFilters.includes(project.id);
                projectsHTML += `
                    <div class="project-card ${isSelected ? 'active' : ''}" onclick="selectProject('${project.id}')">
                        <div class="project-card-name">${project.name}</div>
                        <div class="project-card-meta">
                            <span>${project.isPublic ? 'ğŸŒ å…¬é–‹' : 'ğŸ”’ éå…¬é–‹'}</span>
                            <span class="project-card-count">${taskCount}</span>
                        </div>
                    </div>
                `;
            });
            
            if (projects.length === 0) {
                projectsHTML = `
                    <div style="text-align: center; color: #6b778c; padding: 2rem 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“</div>
                        <div>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">è¨­å®šã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„</div>
                    </div>
                `;
            }
            
            projectsList.innerHTML = projectsHTML;
            console.log('ğŸ¨ [PROJECTS] Project list sidebar rendered with', projects.length, 'projects');
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæ©Ÿèƒ½
        async function selectProject(projectId) {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            selectedProjectFilters = [projectId];
            console.log('ğŸ“‹ [FILTER] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨:', projectId);

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å†æç”»
            await updateProjectsCache();

            // è¡¨ç¤ºå¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            updateAssigneeFilterText();

            // å†æç”»ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            render();

            // ğŸ”’ ã‚«ãƒ©ãƒ è¿½åŠ ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateColumnAddButtonState();
        }
        
        // é€šå¸¸ã‚¿ã‚¹ã‚¯è¡¨ç¤ºæ©Ÿèƒ½
        function showNormalTasks() {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            selectedProjectFilters = [];
            console.log('ğŸ“‹ [FILTER] é€šå¸¸ã‚¿ã‚¹ã‚¯è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ');

            // è¡¨ç¤ºå¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            updateAssigneeFilterText();

            // å†æç”»
            render();

            // ğŸ”’ ã‚«ãƒ©ãƒ è¿½åŠ ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateColumnAddButtonState();
        }

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function render() {
            // ğŸ”§ ä¿®æ­£: ã‚¿ã‚¹ã‚¯ãŒæœªå®šç¾©ã®å ´åˆã¯ç©ºé…åˆ—ã§åˆæœŸåŒ–
            if (!tasks || tasks === undefined) {
                console.log('âš ï¸ [RENDER] ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿æœªå®šç¾© - ç©ºé…åˆ—ã§åˆæœŸåŒ–ã—ã¦æç”»ç¶šè¡Œ');
                tasks = [];
                window.tasks = [];
            }
            
            console.log('ğŸ¨ [RENDER] Starting render, total tasks:', tasks.length);
            const board = document.getElementById('kanban-board');
            if (!board) {
                console.error('âŒ [RENDER] kanban-board element not found!');
                return;
            }
            board.innerHTML = '';
            console.log('ğŸ¨ [RENDER] Board cleared successfully');
            
            // çµ±åˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            let filteredTasks = tasks;
            let currentColumns = columns; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ 
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã¯å‰Šé™¤æ¸ˆã¿
            
            if (selectedProjectFilters.length > 0) {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ç‰¹å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º
                filteredTasks = tasks.filter(t => 
                    t.projectId && selectedProjectFilters.includes(t.projectId)
                );
                
                // ãƒ¡ãƒ³ãƒãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã®çµ„ã¿åˆã‚ã›
                if (selectedAssigneeFilters.length > 0) {
                    filteredTasks = filteredTasks.filter(t => {
                        if (t.assignees && Array.isArray(t.assignees)) {
                            return t.assignees.some(a => selectedAssigneeFilters.includes(a));
                        }
                        return selectedAssigneeFilters.includes(t.assignee);
                    });
                    console.log(`ğŸ‘¥ [RENDER] Project + Assignee filter: showing ${filteredTasks.length} tasks for project ${selectedProjectFilters[0]} and assignee ${selectedAssigneeFilters[0]}`);
                } else {
                    console.log(`ğŸ‘¥ [RENDER] Project filter: showing ${filteredTasks.length} tasks for project ${selectedProjectFilters[0]}`);
                }
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ ã‚’å–å¾—
                currentColumns = getProjectColumns(selectedProjectFilters[0]);
                console.log('ğŸ¨ [RENDER] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ å–å¾—:', selectedProjectFilters[0], 'â†’', currentColumns.length, 'å€‹');
            } else if (selectedAssigneeFilters.length > 0) {
                // å€‹äººãƒ»å…±é€šã‚¿ã‚¹ã‚¯ã®æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã¯é™¤å¤–ï¼‰
                filteredTasks = tasks.filter(t => {
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã¯é™¤å¤–
                    if (t.projectId) return false;
                    
                    // ãƒ¡ãƒ³ãƒãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.some(a => selectedAssigneeFilters.includes(a));
                    }
                    return selectedAssigneeFilters.includes(t.assignee);
                });
                console.log(`ğŸ‘¤ [RENDER] Assignee filter (normal tasks only): showing ${filteredTasks.length} tasks for ${selectedAssigneeFilters[0]}`);
            } else {
                // å€‹äººãƒ»å…±é€šã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤ºï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã¯é™¤å¤–ï¼‰
                filteredTasks = tasks.filter(t => !t.projectId);
                console.log('ğŸ“‹ [RENDER] å€‹äººãƒ»å…±é€šã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º:', filteredTasks.length, 'ä»¶');
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œ: ${filteredTasks.length}ä»¶

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æç”»ï¼ˆéåŒæœŸï¼‰
            renderProjectsList().catch(err => console.error('âŒ [RENDER] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§æç”»ã‚¨ãƒ©ãƒ¼:', err));
            
            // é€šå¸¸ã®ã‚«ãƒ©ãƒ ã‚’è¡¨ç¤ºï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ï¼‰
            currentColumns.forEach(column => {
                let columnTasks = filteredTasks.filter(t => {
                    
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ ã®å ´åˆã€ã‚«ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ãƒãƒƒãƒ”ãƒ³ã‚°
                    if (selectedProjectFilters.length > 0 && column.id.startsWith('pj_')) {
                        const columnIndex = parseInt(column.id.split('_')[2]);
                        // ğŸ”¥ ä¿®æ­£: LocalStorageã§ã¯ãªãcachedProjectsDataã‚’ä½¿ç”¨ï¼ˆFirebaseã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ï¼‰
                        const project = cachedProjectsData[selectedProjectFilters[0]];

                        if (project && project.columns) {
                            // ã‚¿ã‚¹ã‚¯ã®columnIdãŒæ¨™æº–ã‚«ãƒ©ãƒ ã®å ´åˆã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                            const defaultColumns = ['todo', 'inprogress', 'waiting', 'done', 'trash'];
                            const taskColumnIndex = defaultColumns.indexOf(t.columnId);
                            
                            if (taskColumnIndex !== -1 && taskColumnIndex < project.columns.length) {
                                return taskColumnIndex === columnIndex;
                            }
                            
                            // æ—¢ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ IDã®å ´åˆ
                            return t.columnId === column.id;
                        }
                    }
                    
                    return t.columnId === column.id;
                });
                
                // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚’å…ˆé ­ã«ã€ãã®å¾ŒæœŸé™é †ã§ã‚½ãƒ¼ãƒˆ
                columnTasks.sort((a, b) => {
                    const aOverdue = a.deadline && isOverdue(a.deadline, a.columnId);
                    const bOverdue = b.deadline && isOverdue(b.deadline, b.columnId);
                    
                    // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚’å…ˆé ­ã«
                    if (aOverdue && !bOverdue) return -1;
                    if (!aOverdue && bOverdue) return 1;
                    
                    // åŒã˜çŠ¶æ…‹ã®å ´åˆã¯æœŸé™é †
                    if (a.deadline && b.deadline) {
                        return new Date(a.deadline) - new Date(b.deadline);
                    }
                    return 0;
                });
                
                const columnEl = document.createElement('div');
                columnEl.className = 'column';
                columnEl.setAttribute('data-column-id', column.id); // ã‚´ãƒŸç®±ã‚¹ã‚¿ã‚¤ãƒ«ç”¨
                columnEl.innerHTML = `
                    <div class="column-header" style="background: ${column.color}; color: white;">
                        <div class="column-title">${column.title}</div>
                        <div class="column-count">${columnTasks.length}</div>
                    </div>
                    <div class="column-content" 
                         ondragover="handleDragOver(event)"
                         ondrop="handleDrop(event, '${column.id}')"
                         ondragenter="handleDragEnter(event)"
                         ondragleave="handleDragLeave(event)">
                        ${columnTasks.map(task => createTaskCard(task)).join('')}
                    </div>
                `;
                
                board.appendChild(columnEl);
            });
            
            updateStats();
        }
        
        function createTaskCard(task, isFromOverdueColumn = false) {
            // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ä½œæˆï¼ˆè©³ç´°ãƒ­ã‚°å‰Šæ¸›ï¼‰
            const deadline = new Date(task.deadline);
            const isOverdueTask = isOverdue(task.deadline, task.columnId);
            const isTodayTask = isToday(task.deadline, task.columnId);
            
            // çµŒéæ™‚é–“ã‚’è¨ˆç®—
            let daysSinceCreated = 0;
            let elapsedText = '';
            let isStale = false; // 3æ—¥ä»¥ä¸Šåœæ»ãƒ•ãƒ©ã‚°
            
            if (task.createdAt) {
                const createdDate = new Date(task.createdAt);
                const now = new Date();
                const timeDiff = now - createdDate;
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                daysSinceCreated = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                
                if (hoursDiff < 24) {
                    // 24æ™‚é–“ä»¥å†…ã¯æ™‚é–“è¡¨ç¤º
                    elapsedText = `${String(hoursDiff).padStart(2, '0')}h`;
                } else {
                    // 24æ™‚é–“ä»¥ä¸Šã¯æ—¥æ•°è¡¨ç¤º
                    elapsedText = `${daysSinceCreated}d`;
                }
                
                // 3æ—¥ä»¥ä¸Šã§å®Œäº†ã—ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã¯åœæ»ãƒ•ãƒ©ã‚°
                if (daysSinceCreated >= 3 && task.columnId !== 'done') {
                    isStale = true;
                }
            }
            
            let cardClass = `task-card priority-${task.priority}`;
            if (isOverdueTask) cardClass += ' overdue';
            else if (isTodayTask) cardClass += ' today';
            
            let deadlineClass = 'task-deadline';
            let deadlineIcon = 'ğŸ“…';
            if (isOverdueTask) {
                deadlineClass += ' overdue';
                deadlineIcon = 'ğŸš¨';
            } else if (isTodayTask) {
                deadlineClass += ' today';
                deadlineIcon = 'â°';
            }
            
            const priorityText = {
                high: 'ğŸ”´ æœ€é‡è¦',
                medium: 'ğŸŸ¡ é‡è¦', 
                low: 'ğŸŸ¢ é€šå¸¸'
            }[task.priority];
            
            const checkboxHtml = isBulkMode ? `
                <div style="position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10;">
                    <input type="checkbox" 
                           onchange="toggleTaskSelection(${task.id})" 
                           onclick="event.stopPropagation()"
                           ${selectedTasks.has(task.id) ? 'checked' : ''}
                           style="width: 16px; height: 16px; cursor: pointer;">
                </div>
            ` : '';
            
            return `
                <div class="${cardClass}" 
                     draggable="${!isBulkMode}"
                     ${!isBulkMode ? `ondragstart="handleDragStart(event, ${task.id})" ondragend="handleDragEnd(event)"` : ''}
                     onclick="${isBulkMode ? `toggleTaskSelection(${task.id})` : `editTask(${task.id})`}"
                     style="position: relative; cursor: ${isBulkMode ? 'pointer' : 'move'}; ${isStale ? 'border: 2px solid #e53e3e; box-shadow: 0 0 8px rgba(229, 62, 62, 0.3);' : ''}"
                     title="${isOverdueTask ? 'ğŸš¨ æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã§ã™' : ''}${isStale ? ' âš ï¸ 3æ—¥ä»¥ä¸Šåœæ»ä¸­' : ''}">
                    ${checkboxHtml}
                    <div class="task-title">
                        <span>
                            ${task.isRecurring ? '<span style="color: #2d3748; margin-right: 0.25rem;" title="å®šæœŸã‚¿ã‚¹ã‚¯">ğŸ”„</span>' : ''}
                            ${task.projectId ? '<span style="color: #2b6cb0; margin-right: 0.25rem;" title="PJã‚¿ã‚¹ã‚¯">ğŸ‘¥</span>' : ''}
                            ${task.title}
                        </span>
                    </div>
                    <div class="task-meta">
                        <div style="margin-bottom: 0.25rem;">
                            <span class="${deadlineClass}">
                                ${deadlineIcon} ${deadline.toLocaleDateString('ja-JP')} ${deadline.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                            </span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            ${elapsedText ? `<span style="font-size: 0.75rem; color: ${isStale ? '#e53e3e' : '#718096'}; font-weight: ${isStale ? '600' : '400'};">â±ï¸ ${elapsedText}</span>` : ''}
                            ${isStale ? '<span style="font-size: 0.75rem; color: #e53e3e;">ğŸš¨ åœæ»ä¸­</span>' : ''}
                        </div>
                        <span class="task-priority-badge priority-${task.priority}">
                            ${priorityText}
                        </span>
                    </div>
                    ${task.memo ? `<div class="task-memo">${task.memo}</div>` : ''}
                    <div class="task-badges">
                        ${task.memo ? '<span class="attachment-icon">ğŸ“</span>' : ''}
                        ${task.attachments && task.attachments.length > 0 ? `<span class="attachment-badge">${task.attachments.length}</span>` : ''}
                        <span style="font-size: 0.7rem; color: #5e6c84;">ğŸ‘¤ ${getAssigneeDisplayText(task)}</span>
                    </div>
                </div>
            `;
        }
        
        function getAssigneeDisplayText(task) {
            if (task.assignees && Array.isArray(task.assignees) && task.assignees.length > 0) {
                if (task.assignees.length === 1) {
                    return task.assignees[0];
                } else if (task.assignees.length <= 3) {
                    return task.assignees.join(', ');
                } else {
                    return `${task.assignees[0]} ä»–${task.assignees.length - 1}å`;
                }
            }
            // å¾Œæ–¹äº’æ›æ€§
            return task.assignee || 'æœªè¨­å®š';
        }
        
        function updateStats() {
            // Firebaseèª­ã¿è¾¼ã¿å®Œäº†å‰ã®çµ±è¨ˆæ›´æ–°é˜²æ­¢
            if (!tasks || tasks === undefined) {
                console.log('â³ [STATS] ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ - çµ±è¨ˆæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
            let filteredTasks = tasks;
            
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            if (assigneeFilter) {
                filteredTasks = tasks.filter(t => {
                    // æ–°ã—ã„assigneesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(assigneeFilter);
                    }
                    // æ—§ã„assigneeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                    return t.assignee === assigneeFilter;
                });
            }
            
            const overdueCount = filteredTasks.filter(t => t.columnId !== 'done' && isOverdue(t.deadline, t.columnId)).length;
            const todayCount = filteredTasks.filter(t => t.columnId !== 'done' && isToday(t.deadline, t.columnId)).length;
            const completedCount = filteredTasks.filter(t => t.columnId === 'done').length;
            
            // 3æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æ¤œå‡º
            const now = new Date();
            const staleTasks = filteredTasks.filter(t => {
                if (t.columnId === 'done') return false;
                
                // createdAtãŒãªã„å ´åˆã¯ä»Šæ—¥ä½œæˆã•ã‚ŒãŸã‚‚ã®ã¨ã—ã¦æ‰±ã†ï¼ˆåœæ»åˆ¤å®šã‹ã‚‰é™¤å¤–ï¼‰
                if (!t.createdAt) return false;
                
                const createdDate = new Date(t.createdAt);
                const daysDiff = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                return daysDiff >= 3;
            });
            
            // ãƒãƒ¼ãƒ å¹³å‡ã®1.2å€ä»¥ä¸Šã®ã‚¿ã‚¹ã‚¯ã‚’æŒã¤æ‹…å½“è€…ã‚’æ¤œå‡º
            const assigneeCounts = {};
            let totalAssignedTasks = 0;
            let assigneeCount = 0;
            
            // å…¨ã‚¿ã‚¹ã‚¯ã§æ‹…å½“è€…åˆ¥ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿å‰ã®å…¨ä½“ã‹ã‚‰è¨ˆç®—ï¼‰
            tasks.forEach(task => {
                if (task.columnId !== 'done') {
                    // æ–°ã—ã„assigneesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‡¦ç†
                    if (task.assignees && Array.isArray(task.assignees)) {
                        task.assignees.forEach(assignee => {
                            if (!assigneeCounts[assignee]) {
                                assigneeCounts[assignee] = 0;
                                assigneeCount++;
                            }
                            assigneeCounts[assignee]++;
                            totalAssignedTasks++;
                        });
                    } else if (task.assignee && task.assignee !== 'æœªè¨­å®š') {
                        // æ—§assigneeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‡¦ç†
                        if (!assigneeCounts[task.assignee]) {
                            assigneeCounts[task.assignee] = 0;
                            assigneeCount++;
                        }
                        assigneeCounts[task.assignee]++;
                        totalAssignedTasks++;
                    }
                }
            });
            
            // ãƒãƒ¼ãƒ å¹³å‡ã‚’è¨ˆç®—
            const avgTasksPerPerson = assigneeCount > 0 ? totalAssignedTasks / assigneeCount : 0;
            const overloadThreshold = avgTasksPerPerson * 1.2;
            
            // éè² è·ã®æ‹…å½“è€…æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const overloadedAssignees = Object.entries(assigneeCounts)
                .filter(([assignee, count]) => count > overloadThreshold)
                .map(([assignee, count]) => ({ assignee, count }));
            
            document.getElementById('overdue-count').textContent = overdueCount;
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('stale-count').textContent = staleTasks.length;
            document.getElementById('overload-count').textContent = overloadedAssignees.length;
            
            // ç®¡ç†è€…ã®ã¿è¦èª¿æ•´ã‚’è¡¨ç¤º
            const workloadItem = document.getElementById('workload-item');
            if (workloadItem) {
                workloadItem.style.display = isAdmin() ? 'flex' : 'none';
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆè©³ç´°è¡¨ç¤ºç”¨ï¼‰
            window.staleTasks = staleTasks;
            window.overloadedAssignees = overloadedAssignees;
            window.avgTasksPerPerson = avgTasksPerPerson;
            
            // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºã‚’å‰Šé™¤: ç®¡ç†è€…ã«ã¨ã£ã¦ç”¨é€”ãŒä¸æ˜ç¢ºãªãŸã‚
            
            // åˆ†æã‚µãƒãƒªãƒ¼ã‚‚æ›´æ–°
            updateAnalyticsSummary();
        }
        
        function updateWorkflowStats(filteredTasks) {
            const workflowContainer = document.getElementById('workflow-status');
            if (!workflowContainer) return;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥çµ±è¨ˆã‚’è¨ˆç®—
            const statusStats = {};
            const now = new Date();
            
            columns.forEach(column => {
                const columnTasks = filteredTasks.filter(t => t.columnId === column.id);
                
                // å¹³å‡æ»ç•™æ™‚é–“ã‚’è¨ˆç®—
                let avgDays = 0;
                if (columnTasks.length > 0) {
                    const totalDays = columnTasks.reduce((sum, task) => {
                        if (task.createdAt) {
                            const createdDate = new Date(task.createdAt);
                            const days = Math.max(0, (now - createdDate) / (1000 * 60 * 60 * 24));
                            return sum + days;
                        }
                        return sum;
                    }, 0);
                    avgDays = Math.round((totalDays / columnTasks.length) * 10) / 10; // å°æ•°ç‚¹1æ¡
                }
                
                statusStats[column.id] = {
                    title: column.title,
                    count: columnTasks.length,
                    avgDays: avgDays,
                    color: column.color || '#026aa7'
                };
            });
            
            // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºã‚’ç”Ÿæˆ
            const workflowHtml = columns.map((column, index) => {
                const stats = statusStats[column.id];
                const isBottleneck = stats.avgDays > 2.0; // 2æ—¥ä»¥ä¸Šã§ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ¤å®š
                const statusClass = isBottleneck ? 'bottleneck' : 'normal';
                const statusIcon = isBottleneck ? 'ğŸš¨' : '';
                
                const arrow = index < columns.length - 1 ? '<span style="margin: 0 0.25rem; color: #5e6c84;">â†’</span>' : '';
                
                return `
                    <div class="workflow-status-item ${statusClass}" 
                         onclick="showStatusDetails('${column.id}')"
                         style="
                            display: flex; 
                            align-items: center; 
                            gap: 0.25rem; 
                            padding: 0.25rem 0.5rem; 
                            border-radius: 4px; 
                            cursor: pointer;
                            background: ${isBottleneck ? '#fee2e2' : '#f1f5f9'};
                            border: 1px solid ${isBottleneck ? '#fca5a5' : '#cbd5e1'};
                            transition: all 0.2s;
                         "
                         onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                         title="${stats.title}: ${stats.count}ä»¶ã€å¹³å‡${stats.avgDays}æ—¥">
                        ${statusIcon}
                        <span style="font-weight: 600; color: ${isBottleneck ? '#dc2626' : '#374151'};">${stats.title}</span>
                        <span style="color: ${isBottleneck ? '#dc2626' : '#6b7280'};">(${stats.count}ä»¶)</span>
                        ${stats.avgDays > 0 ? `<span style="font-size: 0.75rem; color: ${isBottleneck ? '#dc2626' : '#9ca3af'};">${stats.avgDays}æ—¥</span>` : ''}
                    </div>
                    ${arrow}
                `;
            }).join('');
            
            workflowContainer.innerHTML = workflowHtml;
        }
        
        // 3æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®è©³ç´°è¡¨ç¤º
        function showStaleTasksDetail() {
            if (!window.staleTasks || window.staleTasks.length === 0) {
                alert('ç¾åœ¨ã€3æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const now = new Date();
            const taskListHtml = window.staleTasks.map(task => {
                const createdDate = task.createdAt ? new Date(task.createdAt) : now;
                const daysDiff = task.createdAt ? Math.floor((now - createdDate) / (1000 * 60 * 60 * 24)) : 0;
                const column = columns.find(c => c.id === task.columnId);
                const assigneesText = task.assignees?.join(', ') || task.assignee || 'æœªè¨­å®š';
                
                // çµŒéæ—¥æ•°ã®è¡¨ç¤ºï¼ˆcreatedAtãŒãªã„å ´åˆã¯ã€Œä½œæˆæ—¥ä¸æ˜ã€ã¨è¡¨ç¤ºï¼‰
                const elapsedText = task.createdAt ? `â±ï¸ ${daysDiff}æ—¥çµŒé` : `â±ï¸ ä½œæˆæ—¥ä¸æ˜`;
                
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${task.title}</div>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #5e6c84;">
                            <span>ğŸ‘¤ ${assigneesText}</span>
                            <span>ğŸ“ ${column?.title || 'ãƒ¼'}</span>
                            <span>${elapsedText}</span>
                            ${task.deadline ? `<span>ğŸ“… æœŸé™: ${new Date(task.deadline).toLocaleDateString('ja-JP')}</span>` : ''}
                        </div>
                        ${task.memo ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">ğŸ“ ${task.memo.substring(0, 50)}...</div>` : ''}
                        <button onclick="editTask(${task.id})" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            ç¢ºèªãƒ»ç·¨é›†
                        </button>
                    </div>
                `;
            }).join('');
            
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modalOverlay.id = 'stale-tasks-modal';
            
            modalOverlay.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h2 style="margin: 0; font-size: 1.25rem;">ğŸš¨ 3æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ï¼ˆ${window.staleTasks.length}ä»¶ï¼‰</h2>
                        <p style="margin: 0.5rem 0 0; color: #5e6c84; font-size: 0.9rem;">é€²æ—ç¢ºèªãŒå¿…è¦ãªã‚¿ã‚¹ã‚¯ã§ã™</p>
                    </div>
                    <div>${taskListHtml}</div>
                    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button onclick="document.getElementById('stale-tasks-modal').remove()" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            é–‰ã˜ã‚‹
                        </button>
                    </div>
                </div>
            `;
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }
        
        // ãƒãƒ¼ãƒ å¹³å‡1.2å€ä»¥ä¸Šã®è² è·æ‹…å½“è€…ã®è©³ç´°è¡¨ç¤º
        function showWorkloadDetail() {
            if (!window.overloadedAssignees || window.overloadedAssignees.length === 0) {
                alert('ç¾åœ¨ã€éè² è·ã®æ‹…å½“è€…ã¯ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            const avgTasks = Math.round(window.avgTasksPerPerson * 10) / 10;
            const threshold = Math.round(avgTasks * 1.2 * 10) / 10;
            
            const assigneeListHtml = window.overloadedAssignees.map(({ assignee, count }) => {
                const overloadPercentage = Math.round((count / avgTasks - 1) * 100);
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${assignee}</div>
                                <div style="font-size: 0.85rem; color: #5e6c84;">
                                    æ‹…å½“ã‚¿ã‚¹ã‚¯æ•°: ${count}ä»¶ï¼ˆå¹³å‡ã®${100 + overloadPercentage}%ï¼‰
                                </div>
                            </div>
                            <button onclick="document.getElementById('assignee-filter').value='${assignee}'; filterTasks(); this.closest('div[style*=\\"position: fixed\\"]').remove();" 
                                    style="padding: 0.25rem 0.75rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                ã‚¿ã‚¹ã‚¯ç¢ºèª
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modalOverlay.id = 'workload-modal';
            
            modalOverlay.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h2 style="margin: 0; font-size: 1.25rem;">ğŸ‘¥ è² è·èª¿æ•´ãŒå¿…è¦ãªæ‹…å½“è€…ï¼ˆ${window.overloadedAssignees.length}åï¼‰</h2>
                        <p style="margin: 0.5rem 0 0; color: #5e6c84; font-size: 0.9rem;">
                            ãƒãƒ¼ãƒ å¹³å‡: ${avgTasks}ä»¶ / äººã€€ï½œã€€è¦èª¿æ•´åŸºæº–: ${threshold}ä»¶ä»¥ä¸Š
                        </p>
                    </div>
                    <div>${assigneeListHtml}</div>
                    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button onclick="document.getElementById('workload-modal').remove()" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            é–‰ã˜ã‚‹
                        </button>
                    </div>
                </div>
            `;
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }
        
        function showStatusDetails(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (!column) return;
            
            const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
            let filteredTasks = tasks;
            
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            if (assigneeFilter) {
                filteredTasks = tasks.filter(t => {
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(assigneeFilter);
                    }
                    return t.assignee === assigneeFilter;
                });
            }
            
            // è©²å½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
            const statusTasks = filteredTasks.filter(t => t.columnId === columnId);
            
            if (statusTasks.length === 0) {
                alert(`${column.title}ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã¯ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
                return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const now = new Date();
            const taskListHtml = statusTasks.map(task => {
                const createdDate = new Date(task.createdAt);
                const daysOld = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                const deadline = new Date(task.deadline);
                const isOverdueTask = deadline < now;
                const assigneeList = Array.isArray(task.assignees) ? task.assignees.join(', ') : (task.assignee || 'æœªè¨­å®š');
                
                return `
                    <div style="
                        padding: 0.75rem; 
                        margin-bottom: 0.5rem; 
                        background: white; 
                        border: 1px solid #e5e7eb; 
                        border-radius: 6px;
                        ${isOverdueTask ? 'border-left: 4px solid #dc2626;' : ''}
                    ">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem; ${isOverdueTask ? 'color: #dc2626;' : ''}">${task.title}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    ğŸ‘¤ ${assigneeList} | ğŸ“… ${deadline.toLocaleDateString('ja-JP')} | â° ${daysOld}æ—¥çµŒé
                                </div>
                            </div>
                            <button onclick="editTask(${task.id}); closeStatusModal();" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ç·¨é›†
                            </button>
                        </div>
                        ${task.memo ? `<div style="font-size: 0.85rem; color: #4b5563; margin-top: 0.5rem;">${task.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLç”Ÿæˆ
            const modalHtml = `
                <div id="status-detail-modal" style="
                    position: fixed; 
                    top: 0; left: 0; 
                    width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 1000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                " onclick="closeStatusModal()">
                    <div style="
                        background: white; 
                        border-radius: 8px; 
                        padding: 1.5rem; 
                        max-width: 600px; 
                        max-height: 80vh; 
                        overflow-y: auto;
                        margin: 1rem;
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem;">
                            <h3 style="margin: 0; color: #111827;">ğŸ“‹ ${column.title} (${statusTasks.length}ä»¶)</h3>
                            <button onclick="closeStatusModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">Ã—</button>
                        </div>
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-size: 0.9rem; color: #374151;">
                                å¹³å‡æ»ç•™æ™‚é–“: <strong>${Math.round((statusTasks.reduce((sum, t) => sum + Math.floor((now - new Date(t.createdAt)) / (1000 * 60 * 60 * 24)), 0) / statusTasks.length) * 10) / 10}æ—¥</strong>
                            </div>
                        </div>
                        <div>${taskListHtml}</div>
                    </div>
                </div>
            `;
            
            // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
            const existingModal = document.getElementById('status-detail-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            console.log('ğŸ¨ [RENDER] Render completed successfully');
        }
        
        function closeStatusModal() {
            const modal = document.getElementById('status-detail-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        
        
        // ğŸ”¥ å®Œå…¨FirebaseåŒ–: ã‚¿ã‚¹ã‚¯ä¿å­˜æ©Ÿèƒ½
        async function saveTasks() {
            try {
                console.log('ğŸ’¾ [SAVE-TASKS] Firebaseå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ - ã‚¿ã‚¹ã‚¯ä¿å­˜é–‹å§‹:', tasks.length, 'ä»¶');

                // ğŸ”¥ Firebaseèªè¨¼ç¢ºèª
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (!currentUser) {
                    console.error('âŒ [SAVE-TASKS] Firebaseæœªèªè¨¼ - ä¿å­˜ã§ãã¾ã›ã‚“');
                    return false;
                }

                // Firebaseã¸ä¿å­˜
                if (!window.FirebaseDB?.saveTasks) {
                    console.error('âŒ [SAVE-TASKS] FirebaseDB.saveTasksæœªå®šç¾©');
                    return false;
                }

                const result = await window.FirebaseDB.saveTasks(tasks);
                if (result.success) {
                    console.log('âœ… [SAVE-TASKS] Firebaseä¿å­˜å®Œäº†');
                    return true;
                } else {
                    console.error('âŒ [SAVE-TASKS] Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('âŒ [SAVE-TASKS] äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function getUserIdByName(userName) {
            try {
                // Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                if (window.FirebaseDB && window.FirebaseDB.getUsers) {
                    const result = await window.FirebaseDB.getUsers();
                    if (result.success) {
                        const user = result.users.find(u => 
                            u.name === userName || 
                            u.email === userName || 
                            u.email?.split('@')[0] === userName
                        );
                        if (user) {
                            return user.id || user.uid;
                        }
                    }
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰IDã‚’ç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                const emailMap = {
                    'muranaka-tenma': 'muranaka-tenma@terracom.co.jp',
                    'kato-jun': 'kato-jun@terracom.co.jp',
                    'asahi-keiichi': 'asahi-keiichi@terracom.co.jp',
                    'hanzawa-yuka': 'hanzawa-yuka@terracom.co.jp',
                    'tamura-wataru': 'tamura-wataru@terracom.co.jp',
                    'hashimoto-yumi': 'hashimoto-yumi@terracom.co.jp',
                    'fukushima-ami': 'fukushima-ami@terracom.co.jp'
                };
                
                const email = emailMap[userName] || userName;
                return email.replace('@', '-').replace('.', '-'); // ã‚·ãƒ³ãƒ—ãƒ«ãªIDç”Ÿæˆ
            } catch (error) {
                console.error('âŒ [USER-ID] ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // Slacké€šçŸ¥æ©Ÿèƒ½åˆæœŸåŒ–
        function initializeSlackNotification() {
            // åˆæœŸåŒ–æ™‚ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆé€šçŸ¥ã¯ç„¡åŠ¹åŒ–
        }
        
        // FCMå‰Šé™¤: Firebase Cloud Messagingæ©Ÿèƒ½ã‚’å®Œå…¨å‰Šé™¤
        // Slacké€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã«çµ±ä¸€
        
        // Slackãƒ†ã‚¹ãƒˆé€šçŸ¥ï¼ˆãƒ†ãƒ©ãƒãƒ£ãƒ³ãƒãƒ«ã«é€ä¿¡ï¼‰
        async function testSlackNotification() {
            console.log('ğŸ§ª [SLACK-TEST] ãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡é–‹å§‹');
            
            try {
                const currentUser = getCurrentUser();
                const testTime = new Date().toLocaleString('ja-JP');
                
                // ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
                const result = await sendSlackNotification(
                    currentUser.email,
                    'ğŸ§ª Slacké€šçŸ¥ãƒ†ã‚¹ãƒˆ',
                    `ã“ã‚Œã¯Slacké€šçŸ¥ã®ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚\né€ä¿¡è€…: ${currentUser.name}\né€ä¿¡æ™‚åˆ»: ${testTime}`,
                    {
                        targetUser: currentUser.name,
                        targetEmail: currentUser.email
                    }
                );
                
                // çµæœã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
                if (window.SlackNotificationService && window.SlackNotificationService.webhookUrl) {
                    alert('âœ… Slacké€šçŸ¥ãƒ†ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\n#ãƒ†ãƒ©ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else {
                    alert('âŒ Slacké€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (error) {
                console.error('âŒ [SLACK-TEST] ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ Slacké€šçŸ¥ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }
        
        function testNotification() {
            // Slacké€šçŸ¥ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            testSlackNotification();
        }
        
        // Slacké€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆCORSå¯¾å¿œç‰ˆï¼‰
        async function sendSlackNotification(recipientEmail, subject, body, options = {}) {
            try {
                // éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®é€šçŸ¥æŠ‘åˆ¶ãƒã‚§ãƒƒã‚¯
                if (options.taskId && options.isHiddenTask) {
                    console.log(`ğŸ”’ [SLACK] éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${subject} (ã‚¿ã‚¹ã‚¯ID: ${options.taskId})`);
                    return;
                }
                
                // ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€isHiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                if (options.taskId && window.tasks) {
                    const task = window.tasks.find(t => t.id === options.taskId);
                    if (task && task.isHidden) {
                        console.log(`ğŸ”’ [SLACK] éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${subject} (ã‚¿ã‚¹ã‚¯: ${task.title})`);
                        return;
                    }
                }
                
                console.log(`ğŸ”” [SLACK] é€šçŸ¥é€ä¿¡é–‹å§‹: ${subject}`);
                
                // SlackNotificationServiceã‚’ä½¿ç”¨ã—ã¦CORSåˆ¶é™ã‚’å›é¿
                if (window.SlackNotificationService) {
                    const result = await window.SlackNotificationService.sendNotification(subject, body, options);
                    
                    if (result) {
                        console.log(`âœ… [SLACK] é€šçŸ¥é€ä¿¡æˆåŠŸ: ${subject}`);
                    } else {
                        console.error(`âŒ [SLACK] é€šçŸ¥é€ä¿¡å¤±æ•—: ${subject}`);
                    }
                } else {
                    console.error('âŒ [SLACK] SlackNotificationServiceãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
            } catch (error) {
                console.error(`âŒ [SLACK] é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:`, error);
            }
        }

        // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ å‰Šé™¤æ¸ˆã¿ - Slacké€šçŸ¥ã«çµ±ä¸€

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ï¼ˆSlacké€šçŸ¥ç”¨ï¼‰
        function getEmailByUserName(userName) {
            try {
                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const user = systemUsers.find(u => u.name === userName);
                return user ? user.email : null;
            } catch (error) {
                console.error('âŒ [EMAIL-LOOKUP] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // ãƒ†ã‚¹ãƒˆé–¢æ•°ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆSlacké€šçŸ¥ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼‰

        async function showNotification(title, body, options = {}) {
            // éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®é€šçŸ¥æŠ‘åˆ¶ãƒã‚§ãƒƒã‚¯
            if (options.taskId && options.isHiddenTask) {
                console.log(`ğŸ”’ [NOTIFICATION] éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${title} (ã‚¿ã‚¹ã‚¯ID: ${options.taskId})`);
                return;
            }
            
            // ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€isHiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
            if (options.taskId && window.tasks) {
                const task = window.tasks.find(t => t.id === options.taskId);
                if (task && task.isHidden) {
                    console.log(`ğŸ”’ [NOTIFICATION] éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${title} (ã‚¿ã‚¹ã‚¯: ${task.title})`);
                    return;
                }
            }
            
            // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ã¯ç„¡åŠ¹åŒ–ï¼ˆSlackã®ã¿ä½¿ç”¨ï¼‰
            console.log(`ğŸ”” [SLACK-NOTIFICATION] ${title}: ${body}`);
            
            // ã€Slacké€šçŸ¥ã€‘å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«Slacké€šçŸ¥ã‚’é€ä¿¡
            if (options.targetUser || options.targetEmail) {
                console.log(`ğŸ”” [SLACK-AUTO] Slacké€šçŸ¥è‡ªå‹•å®Ÿè¡Œ: ${title}`);
                console.log(`ğŸ”” [SLACK-AUTO] å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${options.targetUser}, å¯¾è±¡ãƒ¡ãƒ¼ãƒ«: ${options.targetEmail}`);
                
                // 'all'ã®å ´åˆã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦é€šçŸ¥é€ä¿¡
                if (options.targetUser === 'all') {
                    const currentUser = getCurrentUser();
                    const senderEmail = currentUser?.email || 'muranaka-tenma@terracom.co.jp';
                    console.log(`ğŸ”” [SLACK-AUTO] å…¨ä½“é€šçŸ¥ - é€ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚’ä½¿ç”¨: ${senderEmail}`);
                    await sendSlackNotification(senderEmail, title, body, options);
                    return;
                }
                
                // 'multiple'ã®å ´åˆã¯è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çµ±åˆé€šçŸ¥ã‚’é€ä¿¡
                if (options.targetUser === 'multiple' && options.mentionUsers && Array.isArray(options.mentionUsers)) {
                    console.log(`ğŸ”” [SLACK-AUTO] è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±åˆé€šçŸ¥é–‹å§‹: ${options.mentionUsers.join(', ')}`);
                    
                    // ğŸ”§ ã‚¿ã‚¹ã‚¯ç§»å‹•é€šçŸ¥ã®å ´åˆã¯ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚å«ã‚ã‚‹
                    const isTaskMoveNotification = options.type === 'task_move';
                    const currentUser = getCurrentUser();
                    
                    // ğŸ”§ å…¨ã¦ã®é€šçŸ¥ã§è‡ªåˆ†ã‚‚å«ã‚ã‚‹ï¼ˆSlacké€šçŸ¥ã®ãŸã‚ï¼‰
                    const filteredMentionUsers = options.mentionUsers.filter(user => {
                        const isValidUser = user && user.trim() !== '';
                        console.log(`ğŸ” [MENTION-FILTER] ${user}: æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ = ${isValidUser} (è‡ªåˆ†ã‚‚é€šçŸ¥å¯¾è±¡ã«å«ã‚ã‚‹)`);
                        return isValidUser;
                    });
                    
                    if (filteredMentionUsers.length === 0) {
                        console.log(`âŒ [SLACK-AUTO] é€šçŸ¥å¯¾è±¡è€…ãªã— - é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—`);
                        return;
                    }
                    
                    console.log(`ğŸ”” [SLACK-AUTO] é€šçŸ¥å¯¾è±¡ï¼ˆè‡ªåˆ†å«ã‚€ï¼‰: ${filteredMentionUsers.join(', ')}`);
                    console.log(`ğŸ”” [SLACK-AUTO] é€šçŸ¥ã‚¿ã‚¤ãƒ—: ${options.type}`);
                    
                    // è¤‡æ•°ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆæ­£ã—ã„Slackãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰
                    const mentionText = filteredMentionUsers.map(user => {
                        const slackUsername = window.SlackConfig ? window.SlackConfig.getSlackUsername(user) : `@${user}`;
                        return slackUsername;
                    }).join(' ');
                    
                    // ğŸ”§ ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é‡è¤‡ã‚’é˜²ããŸã‚ã€bodyã‹ã‚‰ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ–‡å­—åˆ—ã‚’é™¤å»ã—ã¦çµ±åˆ
                    let cleanedBody = body;
                    // bodyå†…ã®æ—¢å­˜ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼ˆ@ãƒ¦ãƒ¼ã‚¶ãƒ¼åå½¢å¼ï¼‰ã‚’é™¤å»
                    filteredMentionUsers.forEach(user => {
                        const patterns = [
                            new RegExp(`@${user.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*`, 'g'),
                            new RegExp(`@${user.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}$`, 'g')
                        ];
                        patterns.forEach(pattern => {
                            cleanedBody = cleanedBody.replace(pattern, '');
                        });
                    });
                    
                    // å…ˆé ­ã¨æœ«å°¾ã®ä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
                    cleanedBody = cleanedBody.trim().replace(/^\s+/, '');
                    
                    const integratedBody = `${mentionText}\n${cleanedBody}`;
                    
                    console.log(`ğŸ”§ [MENTION-FIX] å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "${body}"`);
                    console.log(`ğŸ”§ [MENTION-FIX] ã‚¯ãƒªãƒ¼ãƒ³å¾Œ: "${cleanedBody}"`);
                    console.log(`ğŸ”§ [MENTION-FIX] çµ±åˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "${integratedBody}"`);
                    
                    // ä»£è¡¨ã—ã¦æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦Slacké€ä¿¡
                    const representativeEmail = getEmailByUserName(filteredMentionUsers[0]);
                    
                    if (representativeEmail) {
                        console.log(`ğŸ”” [SLACK-AUTO] çµ±åˆé€šçŸ¥é€ä¿¡: ${representativeEmail} (ä»£è¡¨)`);
                        await sendSlackNotification(representativeEmail, title, integratedBody, {
                            ...options,
                            targetUser: filteredMentionUsers[0],
                            targetEmail: representativeEmail,
                            isIntegratedNotification: true,
                            allTargetUsers: filteredMentionUsers
                        });
                    } else {
                        console.error(`âŒ [SLACK-AUTO] ä»£è¡¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–å¾—ã§ãã¾ã›ã‚“: ${filteredMentionUsers[0]}`);
                    }
                    return;
                }
                
                const targetEmail = options.targetEmail || getEmailByUserName(options.targetUser);
                console.log(`ğŸ”” [SLACK-AUTO] å–å¾—ã—ãŸãƒ¡ãƒ¼ãƒ«: ${targetEmail}`);
                
                if (targetEmail) {
                    await sendSlackNotification(targetEmail, title, body, options);
                } else {
                    console.error(`âŒ [SLACK-AUTO] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–å¾—ã§ãã¾ã›ã‚“: ${options.targetUser}`);
                }
            } else {
                console.log(`âš ï¸ [SLACK-AUTO] å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ¡ãƒ¼ãƒ«æœªæŒ‡å®šã®ãŸã‚é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—`);
            }
            
            return;
        }
        
        function checkDeadlines() {
            const now = new Date();
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.isLoggedIn) {
                console.log('âš ï¸ [DEADLINE] ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªãƒ­ã‚°ã‚¤ãƒ³ - é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            tasks.forEach(task => {
                if (task.columnId === 'done') return; // å®Œäº†æ¸ˆã¿ã¯é™¤å¤–
                
                // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯: ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‹…å½“è€…ã§ãªã„å ´åˆã¯é€šçŸ¥ã—ãªã„
                if (task.assignees && task.assignees.length > 0) {
                    const isAssignedToCurrentUser = task.assignees.includes(currentUser.name) || 
                                                  task.assignees.includes(currentUser.email) ||
                                                  task.assignees.includes(currentUser.id);
                    if (!isAssignedToCurrentUser) {
                        console.log(`ğŸ”‡ [DEADLINE] ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€- æ‹…å½“è€…ã§ã¯ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ— (æ‹…å½“è€…: ${task.assignees.join(', ')}, ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser.name})`);
                        return;
                    }
                }
                
                const deadline = new Date(task.deadline);
                
                // ğŸ”§ æœŸé™åˆ‡ã‚Œé€šçŸ¥ã‚’å®Ÿéš›ã®æœŸé™åˆ‡ã‚Œæ™‚ã®ã¿ã«é™å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
                // æ—¢ã«æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®åˆå›é€šçŸ¥ã¯ç„¡åŠ¹åŒ–
                if (deadline < now && !task.overdueNotified) {
                    // ğŸš« åˆæœŸåŒ–æ™‚ã‚„ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢ã«æœŸé™åˆ‡ã‚Œã®ã‚¿ã‚¹ã‚¯ã¯é€šçŸ¥ã—ãªã„
                    // ã‚¿ã‚¹ã‚¯ãŒä½œæˆã•ã‚ŒãŸæ™‚åˆ»ã¨æœŸé™åˆ‡ã‚Œæ™‚åˆ»ã®å·®ã‚’ãƒã‚§ãƒƒã‚¯
                    const taskCreatedAt = task.createdAt ? new Date(task.createdAt) : now;
                    const wasOverdueAtCreation = deadline < taskCreatedAt;
                    
                    if (wasOverdueAtCreation) {
                        console.log(`ğŸ”‡ [DEADLINE] ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€- ä½œæˆæ™‚ç‚¹ã§æ—¢ã«æœŸé™åˆ‡ã‚Œã®ãŸã‚é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—`);
                        task.overdueNotified = true; // ãƒ•ãƒ©ã‚°ã¯è¨­å®šã—ã¦é‡è¤‡é˜²æ­¢
                        return;
                    }
                    
                    // ğŸ”§ æœ€è¿‘1åˆ†ä»¥å†…ã«æœŸé™åˆ‡ã‚Œã«ãªã£ãŸã‚¿ã‚¹ã‚¯ã®ã¿é€šçŸ¥
                    const oneMinuteAgo = new Date(now.getTime() - 60 * 1000);
                    if (deadline > oneMinuteAgo) {
                        console.log(`ğŸ”” [DEADLINE] æœŸé™åˆ‡ã‚Œé€šçŸ¥é€ä¿¡: ${task.title} (æ‹…å½“è€…: ${task.assignees?.join(', ') || 'æœªè¨­å®š'})`);
                        showNotification(
                            'ğŸš¨ æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯',
                            `ã€Œ${task.title}ã€ã®æœŸé™ãŒéãã¾ã—ãŸï¼`,
                            { 
                                tag: `overdue-${task.id}`, 
                                taskId: task.id,
                                targetUser: currentUser.name,
                                type: 'deadline_overdue'
                            }
                        );
                    } else {
                        console.log(`ğŸ”‡ [DEADLINE] ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€- æœŸé™åˆ‡ã‚Œã‹ã‚‰1åˆ†ä»¥ä¸ŠçµŒéã®ãŸã‚é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—`);
                    }
                    task.overdueNotified = true;
                }
            });
            
            // Firebaseçµ±åˆ: é€šçŸ¥ãƒ•ãƒ©ã‚°ã¯Firestoreå†…ã§è‡ªå‹•ä¿å­˜ã•ã‚Œã‚‹
        }
        
        // è¨­å®šé–¢é€£ã®é–¢æ•°
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            loadAlertSettings();
            loadColumnManager();
            loadImportDefaults();
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®šã®åˆæœŸåŒ–
        function loadImportDefaults() {
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            const assigneeSelect = document.getElementById('default-assignee');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                assignees.forEach(assignee => {
                    const option = document.createElement('option');
                    option.value = assignee;
                    option.textContent = assignee;
                    assigneeSelect.appendChild(option);
                });
            }
            
            // ã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
            const columnSelect = document.getElementById('default-column');
            if (columnSelect) {
                columnSelect.innerHTML = '';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    columnSelect.appendChild(option);
                });
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé™ã‚’ä»Šæ—¥ã«è¨­å®š
            document.getElementById('default-deadline').value = new Date().toISOString().split('T')[0];
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
            saveAlertSettings();
        }
        
        // ã‚«ãƒ©ãƒ ç®¡ç†æ©Ÿèƒ½
        function loadColumnManager() {
            // ğŸ”’ æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼šdeveloperæ¨©é™ãŒãªã„å ´åˆã¯éè¡¨ç¤º
            const currentUser = getCurrentUser();
            const columnManagerSection = document.querySelector('.setting-section:has(#column-manager)');

            if (currentUser.role !== 'developer') {
                if (columnManagerSection) {
                    columnManagerSection.style.display = 'none';
                }
                console.log('ğŸ”’ [PERMISSION] ã‚«ãƒ©ãƒ ç®¡ç†ã¯developeræ¨©é™ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½');
                return;
            }

            // developeræ¨©é™ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
            if (columnManagerSection) {
                columnManagerSection.style.display = 'block';
            }

            const columnList = document.getElementById('column-list');
            columnList.innerHTML = columns.map((column, index) => `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                    <span style="flex: 1;">${column.title}</span>
                    <input type="color" value="${column.color}" onchange="updateColumnColor(${index}, this.value)" style="width: 40px; height: 30px; border: none; border-radius: 4px;">
                    <button onclick="editColumnName(${index})" style="padding: 0.25rem 0.5rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer;">ç·¨é›†</button>
                    ${columns.length > 2 ? `<button onclick="deleteColumn(${index})" style="padding: 0.25rem 0.5rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>` : ''}
                </div>
            `).join('');
        }
        
        function addColumn() {
            const newColumnName = document.getElementById('new-column-name').value.trim();
            if (!newColumnName) {
                alert('ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ğŸ”’ æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆå€‹äººç”¨ã‚«ãƒ©ãƒ ã‚‚developeræ¨©é™å¿…è¦ï¼‰
            const currentUser = getCurrentUser();
            if (selectedProjectFilters.length > 0) {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ ã®å ´åˆï¼šadminæ¨©é™å¿…è¦
                if (currentUser.role !== 'admin') {
                    alert('âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚«ãƒ©ãƒ ç·¨é›†ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™');
                    return;
                }
            } else {
                // å€‹äººç”¨ã‚«ãƒ©ãƒ ã®å ´åˆï¼šdeveloperæ¨©é™å¿…è¦
                if (currentUser.role !== 'developer') {
                    alert('âš ï¸ å€‹äººç”¨ã‚«ãƒ©ãƒ ã®ç·¨é›†ã¯developeræ¨©é™ãŒå¿…è¦ã§ã™');
                    return;
                }
            }

            const newColumn = {
                id: 'custom_' + Date.now(),
                title: newColumnName,
                color: '#026aa7'
            };

            columns.push(newColumn);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            document.getElementById('new-column-name').value = '';
            loadColumnManager();
            renderBoard();
        }
        
        function editColumnName(index) {
            // ğŸ”’ æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆdeveloperæ¨©é™å¿…è¦ï¼‰
            const currentUser = getCurrentUser();
            if (currentUser.role !== 'developer') {
                alert('âš ï¸ å€‹äººç”¨ã‚«ãƒ©ãƒ ã®ç·¨é›†ã¯developeræ¨©é™ãŒå¿…è¦ã§ã™');
                return;
            }

            const newName = prompt('æ–°ã—ã„ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', columns[index].title);
            if (newName && newName.trim()) {
                columns[index].title = newName.trim();
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                loadColumnManager();
                renderBoard();
            }
        }
        
        function updateColumnColor(index, color) {
            // ğŸ”’ æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆdeveloperæ¨©é™å¿…è¦ï¼‰
            const currentUser = getCurrentUser();
            if (currentUser.role !== 'developer') {
                alert('âš ï¸ å€‹äººç”¨ã‚«ãƒ©ãƒ ã®ç·¨é›†ã¯developeræ¨©é™ãŒå¿…è¦ã§ã™');
                return;
            }

            columns[index].color = color;
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            render(); // å³åº§ã«åæ˜ 
        }
        
        function deleteColumn(index) {
            if (columns.length <= 2) {
                alert('æœ€ä½2ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                return;
            }

            // ğŸ”’ æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆå€‹äººç”¨ã‚«ãƒ©ãƒ ã‚‚developeræ¨©é™å¿…è¦ï¼‰
            const currentUser = getCurrentUser();
            if (selectedProjectFilters.length > 0) {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ ã®å ´åˆï¼šadminæ¨©é™å¿…è¦
                if (currentUser.role !== 'admin') {
                    alert('âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚«ãƒ©ãƒ å‰Šé™¤ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™');
                    return;
                }
            } else {
                // å€‹äººç”¨ã‚«ãƒ©ãƒ ã®å ´åˆï¼šdeveloperæ¨©é™å¿…è¦
                if (currentUser.role !== 'developer') {
                    alert('âš ï¸ å€‹äººç”¨ã‚«ãƒ©ãƒ ã®å‰Šé™¤ã¯developeræ¨©é™ãŒå¿…è¦ã§ã™');
                    return;
                }
            }

            const columnToDelete = columns[index];
            const tasksInColumn = tasks.filter(task => task.columnId === columnToDelete.id);
            
            if (tasksInColumn.length > 0) {
                const moveToColumn = prompt(`ã“ã®ã‚«ãƒ©ãƒ ã«ã¯${tasksInColumn.length}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚\nç§»å‹•å…ˆã®ã‚«ãƒ©ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (${columns.filter((_, i) => i !== index).map(c => c.id).join(', ')}):`);
                if (!moveToColumn) return;
                
                // ã‚¿ã‚¹ã‚¯ã‚’ç§»å‹•
                tasksInColumn.forEach(task => {
                    task.columnId = moveToColumn;
                });
            }
            
            columns.splice(index, 1);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            saveTasks();
            loadColumnManager();
            render();
        }

        // ğŸ”’ ã‚«ãƒ©ãƒ è¿½åŠ ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateColumnAddButtonState() {
            const btn = document.getElementById('quick-add-column-btn');
            if (!btn) return;

            const currentUser = getCurrentUser();

            if (selectedProjectFilters.length > 0) {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæ™‚
                if (currentUser.role === 'admin') {
                    btn.disabled = false;
                    btn.title = 'ç®¡ç†è€…æ¨©é™ã§ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ';
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = false; // ã‚¯ãƒªãƒƒã‚¯ã¯å¯èƒ½ï¼ˆè­¦å‘Šã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
                    btn.title = 'âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚«ãƒ©ãƒ è¿½åŠ ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™';
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            } else {
                // å€‹äººã‚¿ã‚¹ã‚¯ãƒ“ãƒ¥ãƒ¼
                btn.disabled = false;
                btn.title = 'å€‹äººç”¨ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        }

        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ ã‚«ãƒ©ãƒ ç®¡ç†æ©Ÿèƒ½
        async function quickAddColumn() {
            const newColumnName = document.getElementById('quick-column-name').value.trim();
            if (!newColumnName) {
                alert('ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºä¸­ã‹ãƒã‚§ãƒƒã‚¯
            if (selectedProjectFilters.length > 0) {
                // ğŸ”’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæ™‚ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
                const currentUser = getCurrentUser();
                if (currentUser.role !== 'admin') {
                    alert('âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚«ãƒ©ãƒ è¿½åŠ ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™\n\nå€‹äººã‚¿ã‚¹ã‚¯ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠï¼‰ã§ã¯è‡ªç”±ã«ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã§ãã¾ã™ã€‚');
                    return;
                }
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ ã«è¿½åŠ 
                const projectId = selectedProjectFilters[0];

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                if (!cachedProjectsData || !cachedProjectsData[projectId]) {
                    console.error('âŒ [COLUMN-ADD] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', projectId);
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                const project = cachedProjectsData[projectId];
                const projectColumns = project.columns || [];

                // æ–°ã—ã„ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
                projectColumns.push(newColumnName);

                // Firebaseã«ä¿å­˜
                if (window.FirebaseDB && window.FirebaseDB.saveProject) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success && result.projects) {
                        const fullProject = result.projects.find(p => p.id === projectId);
                        if (fullProject) {
                            fullProject.columns = projectColumns;
                            const saveResult = await window.FirebaseDB.saveProject(fullProject);

                            if (saveResult.success) {
                                console.log('âœ… [COLUMN-ADD] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ è¿½åŠ æˆåŠŸ:', projectId);
                                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                                await updateProjectsCache();
                                document.getElementById('quick-column-name').value = '';
                                render();
                            } else {
                                console.error('âŒ [COLUMN-ADD] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å¤±æ•—:', saveResult.error);
                                alert('ã‚«ãƒ©ãƒ ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + saveResult.error);
                            }
                        }
                    }
                } else {
                    console.error('âŒ [COLUMN-ADD] Firebaseæœªæ¥ç¶š');
                    alert('Firebaseæœªæ¥ç¶šã®ãŸã‚ã€ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã§ãã¾ã›ã‚“');
                }
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã«è¿½åŠ 
                const newColumn = {
                    id: 'custom_' + Date.now(),
                    title: newColumnName,
                    color: '#026aa7'
                };

                columns.push(newColumn);
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                document.getElementById('quick-column-name').value = '';
                render();
            }
        }
        
        async function editColumnNameInline(columnId) {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºä¸­ã‹ãƒã‚§ãƒƒã‚¯
            if (selectedProjectFilters.length > 0) {
                // ğŸ”’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæ™‚ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
                const currentUser = getCurrentUser();
                if (currentUser.role !== 'admin') {
                    alert('âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚«ãƒ©ãƒ ç·¨é›†ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™');
                    return;
                }

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ ã®ç·¨é›†
                const projectId = selectedProjectFilters[0];

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                if (!cachedProjectsData || !cachedProjectsData[projectId]) {
                    console.error('âŒ [COLUMN-EDIT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', projectId);
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                const project = cachedProjectsData[projectId];
                const projectColumns = project.columns || [];

                // ã‚«ãƒ©ãƒ IDã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŠ½å‡º (pj_ProjectName_0 â†’ 0)
                const columnIndex = parseInt(columnId.split('_')[2]);

                if (columnIndex >= 0 && columnIndex < projectColumns.length) {
                    const currentName = projectColumns[columnIndex];
                    const newName = prompt('æ–°ã—ã„ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentName);

                    if (newName && newName.trim()) {
                        // ã‚«ãƒ©ãƒ åã‚’æ›´æ–°
                        projectColumns[columnIndex] = newName.trim();

                        // Firebaseã«ä¿å­˜
                        if (window.FirebaseDB && window.FirebaseDB.saveProject) {
                            const result = await window.FirebaseDB.getProjects();
                            if (result.success && result.projects) {
                                const fullProject = result.projects.find(p => p.id === projectId);
                                if (fullProject) {
                                    fullProject.columns = projectColumns;
                                    const saveResult = await window.FirebaseDB.saveProject(fullProject);

                                    if (saveResult.success) {
                                        console.log('âœ… [COLUMN-EDIT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ æ›´æ–°æˆåŠŸ:', projectId);
                                        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                                        await updateProjectsCache();
                                        render();
                                    } else {
                                        console.error('âŒ [COLUMN-EDIT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å¤±æ•—:', saveResult.error);
                                        alert('ã‚«ãƒ©ãƒ ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + saveResult.error);
                                    }
                                }
                            }
                        } else {
                            console.error('âŒ [COLUMN-EDIT] Firebaseæœªæ¥ç¶š');
                            alert('Firebaseæœªæ¥ç¶šã®ãŸã‚ã€ã‚«ãƒ©ãƒ ã‚’ä¿å­˜ã§ãã¾ã›ã‚“');
                        }
                    }
                } else {
                    console.error('âŒ [COLUMN-EDIT] ç„¡åŠ¹ãªã‚«ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', columnIndex);
                }
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã®ç·¨é›†
                const column = columns.find(c => c.id === columnId);
                if (!column) return;

                const newName = prompt('æ–°ã—ã„ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', column.title);
                if (newName && newName.trim()) {
                    column.title = newName.trim();
                    localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                    render();
                }
            }
        }
        
        async function deleteColumnInline(columnId) {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºä¸­ã‹ãƒã‚§ãƒƒã‚¯
            if (selectedProjectFilters.length > 0) {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ ã®å‰Šé™¤
                const projectId = selectedProjectFilters[0];

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                if (!cachedProjectsData || !cachedProjectsData[projectId]) {
                    console.error('âŒ [COLUMN-DELETE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', projectId);
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                const project = cachedProjectsData[projectId];
                const projectColumns = project.columns || [];

                if (projectColumns.length <= 2) {
                    alert('æœ€ä½2ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                    return;
                }

                // ã‚«ãƒ©ãƒ IDã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŠ½å‡º
                const columnIndex = parseInt(columnId.split('_')[2]);

                if (columnIndex >= 0 && columnIndex < projectColumns.length) {
                    const columnName = projectColumns[columnIndex];

                    // ã“ã®ã‚«ãƒ©ãƒ ã«ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèª
                    const tasksInColumn = tasks.filter(task =>
                        task.projectId === projectId && task.columnId === columnId
                    );

                    // ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã¯ç§»å‹•å…ˆã‚’é¸æŠ
                    if (tasksInColumn.length > 0) {
                        const availableColumns = projectColumns
                            .map((name, idx) => ({ idx, name, id: `pj_${projectId}_${idx}` }))
                            .filter((c) => c.idx !== columnIndex);

                        const moveToColumn = prompt(
                            `ã“ã®ã‚«ãƒ©ãƒ ã«ã¯${tasksInColumn.length}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚\nç§»å‹•å…ˆã®ã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„:\n\n${availableColumns.map((c, i) => `${i+1}. ${c.name}`).join('\n')}\n\nç§»å‹•å…ˆã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`
                        );

                        if (!moveToColumn) return;

                        const selectedIndex = parseInt(moveToColumn) - 1;
                        if (selectedIndex >= 0 && selectedIndex < availableColumns.length) {
                            const targetColumnId = availableColumns[selectedIndex].id;

                            // ã‚¿ã‚¹ã‚¯ã‚’ç§»å‹•ï¼ˆFirebaseã«ä¿å­˜ï¼‰
                            for (const task of tasksInColumn) {
                                task.columnId = targetColumnId;
                                if (window.FirebaseDB && task.id) {
                                    await window.FirebaseDB.updateTask(task.id, { columnId: targetColumnId });
                                }
                            }
                        } else {
                            alert('ç„¡åŠ¹ãªé¸æŠã§ã™');
                            return;
                        }
                    }

                    if (confirm(`ã‚«ãƒ©ãƒ ã€Œ${columnName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        // ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
                        projectColumns.splice(columnIndex, 1);

                        // Firebaseã«ä¿å­˜
                        if (window.FirebaseDB && window.FirebaseDB.saveProject) {
                            const result = await window.FirebaseDB.getProjects();
                            if (result.success && result.projects) {
                                const fullProject = result.projects.find(p => p.id === projectId);
                                if (fullProject) {
                                    fullProject.columns = projectColumns;
                                    const saveResult = await window.FirebaseDB.saveProject(fullProject);

                                    if (saveResult.success) {
                                        console.log('âœ… [COLUMN-DELETE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ å‰Šé™¤æˆåŠŸ:', projectId);
                                        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                                        await updateProjectsCache();
                                        render();
                                    } else {
                                        console.error('âŒ [COLUMN-DELETE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å¤±æ•—:', saveResult.error);
                                        alert('ã‚«ãƒ©ãƒ ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + saveResult.error);
                                    }
                                }
                            }
                        } else {
                            console.error('âŒ [COLUMN-DELETE] Firebaseæœªæ¥ç¶š');
                            alert('Firebaseæœªæ¥ç¶šã®ãŸã‚ã€ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ã§ãã¾ã›ã‚“');
                        }
                    }
                } else {
                    console.error('âŒ [COLUMN-DELETE] ç„¡åŠ¹ãªã‚«ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', columnIndex);
                }
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã®å‰Šé™¤
                if (columns.length <= 2) {
                    alert('æœ€ä½2ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                    return;
                }

                const columnIndex = columns.findIndex(c => c.id === columnId);
                const columnToDelete = columns[columnIndex];
                const tasksInColumn = tasks.filter(task => task.columnId === columnId);

                if (tasksInColumn.length > 0) {
                    const availableColumns = columns.filter(c => c.id !== columnId);
                    const moveToColumn = prompt(`ã“ã®ã‚«ãƒ©ãƒ ã«ã¯${tasksInColumn.length}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚\nç§»å‹•å…ˆã®ã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„:\n\n${availableColumns.map((c, i) => `${i+1}. ${c.title} (${c.id})`).join('\n')}\n\nç§»å‹•å…ˆã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);

                    if (!moveToColumn) return;

                    const selectedIndex = parseInt(moveToColumn) - 1;
                    if (selectedIndex >= 0 && selectedIndex < availableColumns.length) {
                        // ã‚¿ã‚¹ã‚¯ã‚’ç§»å‹•
                        tasksInColumn.forEach(task => {
                            task.columnId = availableColumns[selectedIndex].id;
                        });
                    } else {
                        alert('ç„¡åŠ¹ãªé¸æŠã§ã™');
                        return;
                    }
                }

                if (confirm(`ã‚«ãƒ©ãƒ ã€Œ${columnToDelete.title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    columns.splice(columnIndex, 1);
                    localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                    saveTasks();
                    render();
                }
            }
        }
        
        function loadAlertSettings() {
            const settings = JSON.parse(localStorage.getItem('alertSettings') || '{"3hours": true, "1day": false, "overdue": true}');
            document.getElementById('alert-3hours').checked = settings['3hours'];
            document.getElementById('alert-1day').checked = settings['1day'];
            document.getElementById('alert-overdue').checked = settings.overdue;
        }
        
        function saveAlertSettings() {
            const settings = {
                '3hours': document.getElementById('alert-3hours').checked,
                '1day': document.getElementById('alert-1day').checked,
                'overdue': document.getElementById('alert-overdue').checked
            };
            localStorage.setItem('alertSettings', JSON.stringify(settings));
        }
        
        // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…ã®ã¿ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒåˆ©ç”¨å¯èƒ½ï¼‰
        function isAdmin() {
            // ğŸ”¥ Firebaseèªè¨¼ãƒ™ãƒ¼ã‚¹ã®æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆLocalStorageæ”¹ã–ã‚“é˜²æ­¢ï¼‰
            const currentUser = getCurrentUser();
            return currentUser.isLoggedIn &&
                   (currentUser.role === 'admin' || currentUser.role === 'developer');
        }
        
        function setTheme(themeName, color, secondaryColor, darkColor, lightColor) {
            // ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒã¯ç®¡ç†è€…ã®ã¿
            if (themeName === 'black' && !isAdmin()) {
                alert('ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™');
                return;
            }
            
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-color-secondary', secondaryColor);
            document.documentElement.style.setProperty('--theme-color-dark', darkColor);
            document.documentElement.style.setProperty('--theme-color-light', lightColor);
            
            // ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒã®å ´åˆã€è¿½åŠ ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            if (themeName === 'black') {
                document.documentElement.style.setProperty('--body-bg', '#0d1117');
                document.documentElement.style.setProperty('--text-color', '#c9d1d9');
                document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #161b22 0%, #0d1117 100%)');
                document.documentElement.style.setProperty('--border-color', '#30363d');
                document.body.classList.add('dark-theme');
            } else {
                document.documentElement.style.setProperty('--body-bg', '#f4f5f7');
                document.documentElement.style.setProperty('--text-color', '#172b4d');
                document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)');
                document.documentElement.style.setProperty('--border-color', '#dfe1e6');
                document.body.classList.remove('dark-theme');
            }
            
            localStorage.setItem('selectedTheme', themeName);
            localStorage.setItem('themeColors', JSON.stringify({
                primary: color,
                secondary: secondaryColor,
                dark: darkColor,
                light: lightColor,
                themeName: themeName
            }));
            
            closeSettingsModal();
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            const savedColors = localStorage.getItem('themeColors');
            
            if (savedTheme && savedColors) {
                const colors = JSON.parse(savedColors);
                document.documentElement.style.setProperty('--theme-color', colors.primary);
                document.documentElement.style.setProperty('--theme-color-secondary', colors.secondary);
                document.documentElement.style.setProperty('--theme-color-dark', colors.dark);
                document.documentElement.style.setProperty('--theme-color-light', colors.light);
                
                // ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒã®å ´åˆã€è¿½åŠ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                if (colors.themeName === 'black' || savedTheme === 'black') {
                    document.documentElement.style.setProperty('--body-bg', '#0d1117');
                    document.documentElement.style.setProperty('--text-color', '#c9d1d9');
                    document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #161b22 0%, #0d1117 100%)');
                    document.documentElement.style.setProperty('--border-color', '#30363d');
                    document.body.classList.add('dark-theme');
                }
            }
        }
        
        // åˆæœŸåŒ–
        async function init() {
            // ãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã¿
            loadTheme();
            
            // é€šçŸ¥è¨±å¯ã‚’è¦æ±‚
            initializeSlackNotification();
            
            // FCMåˆæœŸåŒ–
            // FCMå‰Šé™¤: initializeFCM(); - Slacké€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã«çµ±ä¸€
            
            // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
            setupMentionSystem();
            
            // ğŸ†˜ èµ·å‹•æ™‚ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•å‰Šé™¤
            setTimeout(async () => {
                await checkAndRemoveDuplicates();
            }, 5000); // èµ·å‹•5ç§’å¾Œã«å®Ÿè¡Œ
            
            // Firebaseçµ±åˆ - èªè¨¼ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            try {
                console.log('ğŸ”¥ [INIT] Firebaseçµ±åˆæº–å‚™ä¸­...');
                
                // Firebaseèªè¨¼çŠ¶æ…‹ã‚’å¾…ã¤ï¼ˆæœ€å¤§1ç§’ã«çŸ­ç¸®ï¼‰
                let waitTime = 0;
                const checkInterval = 50; // ãƒã‚§ãƒƒã‚¯é–“éš”ã‚‚çŸ­ç¸®
                while (waitTime < 1000) { // 1ç§’ã«çŸ­ç¸®
                    if (window.FirebaseAuth && window.FirebaseDB) {
                        console.log('âœ… [INIT] Firebaseæº–å‚™å®Œäº† (', waitTime, 'ms)');
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                    waitTime += checkInterval;
                }
                
                if (window.FirebaseAuth && window.FirebaseDB) {
                    // Firebase Authã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦è¡Œ
                    const localSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
                    if (localSession && localSession.user) {
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§Firebaseãƒ­ã‚°ã‚¤ãƒ³
                        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå®Ÿéš›ã®é‹ç”¨ã§ã¯å®‰å…¨ãªæ–¹æ³•ã§ç®¡ç†ï¼‰
                        const passwordMap = {
                            'muranaka-tenma@terracom.co.jp': 'Tenma7041',
                            'kato-jun@terracom.co.jp': 'aikakumei',
                            'asahi-keiichi@terracom.co.jp': 'aikakumei',
                            'hanzawa-yuka@terracom.co.jp': 'aikakumei',
                            'tamura-wataru@terracom.co.jp': 'aikakumei',
                            'hashimoto-yumi@terracom.co.jp': 'aikakumei',
                            'fukushima-ami@terracom.co.jp': 'aikakumei'
                        };
                        
                        const password = passwordMap[localSession.user.email] || 'aikakumei';
                        const signInResult = await window.FirebaseAuth.signIn(
                            localSession.user.email,
                            password
                        );
                        
                        if (signInResult.success) {
                            console.log('âœ… [INIT] Firebaseãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
                            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆçœç•¥ï¼‰
                        } else {
                            console.warn('âš ï¸ [INIT] Firebaseãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:', signInResult.error);
                            // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ã—ã¦ã‚‚ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã¯è©¦è¡Œã™ã‚‹
                        }
                    } else {
                        console.warn('âš ï¸ [INIT] ãƒ­ãƒ¼ã‚«ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—');
                        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—ã§ã‚‚ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã¯è©¦è¡Œã™ã‚‹
                    }
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ
                    console.log('ğŸ“‹ [INIT] ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿é–‹å§‹...');
                    await loadTasks();

                    // ğŸ”§ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®columnIDç§»è¡Œå‡¦ç†
                    await migrateProjectTaskColumnIds();

                    // ğŸ”§ ä¿®æ­£: èª­ã¿è¾¼ã¿å¾Œã«ç¢ºå®Ÿã«æç”»å®Ÿè¡Œ
                    console.log('ğŸ“‹ [INIT] ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿å®Œäº†:', tasks.length, 'ä»¶');
                    console.log('ğŸ¨ [INIT] å³åº§ã«æç”»å®Ÿè¡Œ...');
                    render();
                    updateStats();
                    
                } else {
                    console.warn('âš ï¸ [INIT] Firebaseæœªæ¥ç¶š - å¾Œã§ãƒªãƒˆãƒ©ã‚¤');
                    // Firebaseæœªæ¥ç¶šã§ã‚‚ç¶šè¡Œï¼ˆå¾Œã§ãƒªãƒˆãƒ©ã‚¤ï¼‰
                }
            } catch (error) {
                console.error('âŒ [INIT] Firebaseçµ±åˆã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚tasksé…åˆ—ã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„
            }
            
            // Firebaseçµ±åˆ - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            try {
                taskTemplates = await loadTemplates();
            } catch (error) {
                console.error('âŒ [INIT] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆFirebaseçµ±åˆã‚¨ãƒ©ãƒ¼ - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
                taskTemplates = JSON.parse(localStorage.getItem('taskTemplates') || '[]');
            }
            
            // å®šæœŸã‚¿ã‚¹ã‚¯ã®è‡ªå‹•ç”Ÿæˆãƒã‚§ãƒƒã‚¯
            checkAndGenerateRecurringTasks();
            
            // Phase 2å¯¾å¿œ: æ—¢å­˜ã‚¿ã‚¹ã‚¯ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            tasks = tasks.map(task => {
                // PJé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
                if (task.projectId === undefined) {
                    return {
                        ...task,
                        // PJã‚¿ã‚¹ã‚¯æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        projectId: null,           // PJã‚¿ã‚¹ã‚¯ã®å ´åˆã®ã¿è¨­å®š
                        projectName: null,         // PJè¡¨ç¤ºå
                        
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼ˆãƒ‡ãƒ¥ã‚¢ãƒ«ç®¡ç†ï¼‰
                        personalStatus: task.columnId || 'todo', // å€‹äººå´ã§ã®é€²æ—çŠ¶æ…‹
                        projectStatus: task.columnId || 'todo',  // PJå´ã§ã®æ‰¿èªçŠ¶æ…‹
                        
                        // ç§»å‹•ç”³è«‹ç®¡ç†
                        pendingMove: null,
                        
                        // æ‰¿èªè€…è¨­å®š
                        approvers: [],             // ã“ã®PJã®æ‰¿èªè€…ãƒªã‚¹ãƒˆ
                        lastApprovedBy: null,      // æœ€å¾Œã«æ‰¿èªã—ãŸäºº
                        approvedAt: null,          // æ‰¿èªæ—¥æ™‚
                        
                        // ç§»å‹•æ™‚åˆ»è¨˜éŒ²ï¼ˆè¨¼æ†‘ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
                        lastMovedAt: null          // æœ€å¾Œã®ç§»å‹•æ™‚åˆ»
                    };
                }
                return task;
            });

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºé…åˆ—
            if (tasks.length === 0) {
                tasks = [];
                saveTasks();
            }
            
            // ç”»é¢æ›´æ–°
            if (!window.FirebaseAuth || !window.FirebaseDB) {
                render();
                updateStats();
            } else {
                updateStats();
            }
            
            // UIæ›´æ–°
            setTimeout(() => {
                updateHamburgerMenu();
                
                // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’systemUsersã‹ã‚‰è‡ªå‹•æ›´æ–°ï¼ˆæœ‰åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰
                const activeUsers = getActiveUsers();
                if (activeUsers.length > 0) {
                    assignees = activeUsers.map(u => u.name);
                    window.assignees = assignees;
                    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯Firestoreã§ç®¡ç†ã•ã‚Œã‚‹
                    console.log(`ğŸ‘¥ [RENDER] æœ‰åŠ¹ãªæ‹…å½“è€…æ›´æ–°: ${assignees.join(', ')}`);
                }
                
                // ç”»é¢ä¸Šéƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºæ›´æ–°
                const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (currentSession?.user) {
                    const headerTitle = document.querySelector('.header-title');
                    if (headerTitle) {
                        const roleNames = {
                            'developer': 'é–‹ç™ºè€…',
                            'admin': 'ç®¡ç†è€…',
                            'user': 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼'
                        };
                        const roleName = roleNames[currentSession.user.role] || currentSession.user.role;
                        
                        headerTitle.innerHTML = `
                            ğŸ¯ å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç† - Kanbanãƒœãƒ¼ãƒ‰
                            <span style="font-size: 0.8rem; font-weight: normal; margin-left: 1rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">
                                ${currentSession.user.name} (${roleName})
                            </span>
                        `;
                    }
                }
            }, 200);
            
            // ğŸš« åˆæœŸåŒ–æ™‚ã®æœŸé™ãƒã‚§ãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
            // checkDeadlines();
            // ğŸ”„ å®šæœŸçš„ãªæœŸé™ãƒã‚§ãƒƒã‚¯ã¯ç¶­æŒï¼ˆå®Ÿéš›ã®æœŸé™åˆ‡ã‚Œæ™‚ã®ã¿é€šçŸ¥ï¼‰
            setInterval(checkDeadlines, 1 * 60 * 1000);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            const filterContainer = document.getElementById('assignee-filter-container');
            const dropdown = document.getElementById('assignee-filter-dropdown');
            
            if (filterContainer && !filterContainer.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        function setupFileDropZone() {
            const dropZone = document.getElementById('file-drop-zone');
            const fileInput = document.getElementById('task-files-input');
            
            if (!dropZone || !fileInput) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    // FileListã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                    const dt = new DataTransfer();
                    // æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚è¿½åŠ 
                    Array.from(fileInput.files).forEach(file => dt.items.add(file));
                    // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
                    files.forEach(file => dt.items.add(file));
                    
                    fileInput.files = dt.files;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’è¡¨ç¤º
                    dropZone.innerHTML = `ğŸ“ ${dt.files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™`;
                    
                    }
            });
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®è¡¨ç¤ºæ›´æ–°
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    dropZone.innerHTML = `ğŸ“ ${fileInput.files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™`;
                } else {
                    dropZone.innerHTML = 'ğŸ“ ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ä¸Šè¨˜ãƒœã‚¿ãƒ³ã§é¸æŠ';
                }
            });
        }
        
        

        // æ‹…å½“è€…é¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
        // Firebaseå®Œå…¨ç§»è¡Œ: ãƒ‡ãƒ¼ã‚¿ã¯Firestoreã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã‚‹

        document.addEventListener('DOMContentLoaded', async () => {
            // ğŸ”¥ LocalStorageãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆFirebaseå®Œå…¨ç§»è¡Œã®ãŸã‚ï¼‰
            if (!localStorage.getItem('projectsMigratedToFirebase')) {
                console.log('ğŸ§¹ [INIT] LocalStorageãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ä¸­...');
                localStorage.removeItem('projects');
                localStorage.removeItem('projectSettings');
                localStorage.setItem('projectsMigratedToFirebase', 'true');
                console.log('âœ… [INIT] LocalStorageãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢å®Œäº†');
            }

            // ğŸ”§ ã€æœ€å„ªå…ˆã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
            try {
                // ğŸ” æœ€å„ªå…ˆ: LocalStorageç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹ï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’å…¨ã¦è¨˜éŒ²ï¼‰
                setupLocalStorageMonitoring();

                // ğŸ”¥ Firebaseçµ±åˆ: Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã¿
                console.log('ğŸ”¥ [INIT] Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿é–‹å§‹...');
                await loadActiveUsersFromFirebase();
                console.log('âœ… [INIT] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');

                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorageåˆæœŸåŒ–ï¼ˆFirebaseã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿å®Ÿè¡Œï¼‰
                if (!usersCacheLoaded) {
                    console.warn('âš ï¸ [INIT] Firebaseèª­ã¿è¾¼ã¿å¤±æ•— - localStorageåˆæœŸåŒ–å®Ÿè¡Œ');
                    initializeUserDatabase();
                }

                // æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Firebaseç§»è¡Œãƒã‚§ãƒƒã‚¯
                setTimeout(() => {
                    migrateProjectsToFirebase();
                }, 3000); // Firebaseèªè¨¼å®Œäº†å¾Œã«å®Ÿè¡Œ
                
                // ğŸ” ã€é‡è¦ã€‘æ¨©é™æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãƒ»ä¿®æ­£ã‚’å®Ÿè¡Œ
                const permissionFixed = ensureUserPermissionsIntegrity();
                console.log('âœ… [INIT] æ¨©é™æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†', permissionFixed ? '(ä¿®æ­£ã‚ã‚Š)' : '(å•é¡Œãªã—)');
                
                // ğŸ” æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆUIåˆ¶å¾¡å«ã‚€ï¼‰
                setTimeout(() => {
                    checkUserPermission();
                    console.log('âœ… [INIT] æ¨©é™ãƒã‚§ãƒƒã‚¯å®Œäº†');

                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åˆæœŸåŒ–
                    updateProjectsCache().then(() => {
                        console.log('âœ… [INIT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆæœŸåŒ–å®Œäº†');
                    });
                }, 500); // 0.5ç§’å¾Œã«å®Ÿè¡Œ
                
                // å®šæœŸæ¨©é™ãƒã‚§ãƒƒã‚¯é–‹å§‹
                startPeriodicPermissionCheck();
                console.log('ğŸ”„ [INIT] å®šæœŸæ¨©é™ãƒã‚§ãƒƒã‚¯é–‹å§‹ï¼ˆ5åˆ†é–“éš”ï¼‰');
            } catch (error) {
                console.error('âŒ [INIT] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // FirebaseåˆæœŸåŒ–çŠ¶æ³ã‚’ãƒ‡ãƒãƒƒã‚°
            console.log('ğŸš€ [INIT-DEBUG] DOMContentLoadedç™ºç« - CACHE BUSTED 2025-09-02-17:35:', {
                timestamp: new Date().toISOString(),
                cacheVersion: '2025-09-02-17:35-FORCE-RELOAD',
                device: navigator.platform,
                userAgent: navigator.userAgent.substring(0, 50) + '...',
                firebaseModules: {
                    hasFirebaseAuth: !!window.FirebaseAuth,
                    hasFirebaseDB: !!window.FirebaseDB,
                    hasFirebaseApp: !!window.firebaseApp,
                    hasFirebaseAuthObject: !!window.firebaseAuth
                },
                debugFunctions: {
                    hasTestFirebaseSync: typeof window.testFirebaseSync === 'function'
                }
            });


            // Firebaseèªè¨¼çŠ¶æ…‹ã®ç¢ºèª
            setTimeout(() => {
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                console.log('ğŸ” [INIT-DEBUG] Firebaseèªè¨¼çŠ¶æ…‹ç¢ºèª:', {
                    hasCurrentUser: !!currentUser,
                    userEmail: currentUser?.email || 'ãªã—',
                    userUID: currentUser?.uid || 'ãªã—',
                    timestamp: new Date().toISOString()
                });
            }, 1000);
            
            // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆæœŸåŒ–ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦ç¢ºå®Ÿã«å®Ÿè¡Œï¼‰
            setTimeout(() => {
                updateHamburgerMenu();
                console.log('ğŸ” ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°å®Œäº†');
            }, 100);
            
            // ğŸ”§ ä¿®æ­£: Firebaseèªè¨¼çŠ¶æ…‹ã®å¾©å…ƒã‚’å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–
            console.log('â³ [INIT] Firebaseèªè¨¼çŠ¶æ…‹ã®å¾©å…ƒã‚’å¾…æ©Ÿä¸­...');
            
            // Firebaseèªè¨¼ã®è‡ªå‹•å¾©å…ƒã‚’å¾…ã¤ï¼ˆæœ€å¤§3ç§’ï¼‰
            let authRestored = false;
            const maxWaitTime = 3000;
            const checkInterval = 100;
            let waited = 0;
            
            // onAuthStateChangedã§èªè¨¼çŠ¶æ…‹ã‚’ç›£è¦–
            const authPromise = new Promise((resolve) => {
                let unsubscribe = null;
                
                if (window.firebaseAuth?.onAuthStateChanged) {
                    unsubscribe = window.firebaseAuth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log('âœ… [INIT] Firebaseèªè¨¼å¾©å…ƒå®Œäº†:', user.email);
                            authRestored = true;
                            if (unsubscribe) unsubscribe();
                            resolve();
                        }
                    });
                } else {
                    console.log('âš ï¸ [INIT] Firebase AuthæœªåˆæœŸåŒ– - èªè¨¼ãªã—ã§ç¶šè¡Œ');
                    resolve();
                }
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
                setTimeout(() => {
                    if (!authRestored) {
                        console.log('â±ï¸ [INIT] èªè¨¼å¾…æ©Ÿã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - èªè¨¼ãªã—ã§ç¶šè¡Œ');
                        if (unsubscribe) unsubscribe();
                        resolve();
                    }
                }, maxWaitTime);
            });
            
            // èªè¨¼å¾©å…ƒã‚’å¾…ã¤
            await authPromise;
            
            // ä¸»è¦åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
            try {
                await init();
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•åŒæœŸï¼ˆç§»è¡Œãƒ•ãƒ©ã‚°ã«ä¾å­˜ã—ãªã„ï¼‰
                console.log('ğŸ”„ [AUTO-SYNC] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•åŒæœŸã‚’é–‹å§‹');
                try {
                    // Firebaseèªè¨¼æ¸ˆã¿ã®å ´åˆã®ã¿å®Ÿè¡Œ
                    if (window.getCurrentUser()?.isLoggedIn && window.FirebaseDB?.saveProject) {
                        await migrateProjectsToFirebase();
                        console.log('âœ… [AUTO-SYNC] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒæœŸå®Œäº†');
                    } else {
                        console.log('ğŸ“ [AUTO-SYNC] Firebaseæœªå¯¾å¿œã¾ãŸã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ - ã‚¹ã‚­ãƒƒãƒ—');
                    }
                } catch (syncError) {
                    console.error('âš ï¸ [AUTO-SYNC] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒæœŸã‚¨ãƒ©ãƒ¼:', syncError);
                }
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // OCRãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’åˆæœŸåŒ–
            initOCRModalEventListeners();
            
            
            const assigneeSelect = document.getElementById('task-assignee-input');
            if (assigneeSelect) {
                assigneeSelect.addEventListener('change', function() {
                    if (this.value === '__ADD_NEW__') {
                        const newAssignee = prompt('æ–°ã—ã„æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                        if (newAssignee && newAssignee.trim()) {
                            const trimmedName = newAssignee.trim();
                            if (!assignees.includes(trimmedName)) {
                                assignees.push(trimmedName);
                                // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯Firestoreã§ç®¡ç†ã•ã‚Œã‚‹
                            }
                            // é¸æŠè‚¢ã‚’æ›´æ–°ã—ã¦æ–°ã—ã„æ‹…å½“è€…ã‚’é¸æŠ
                            updateAssigneeOptions();
                            this.value = trimmedName;
                        } else {
                            this.value = '';
                        }
                    }
                });
            }
            
            // ã‚«ãƒ©ãƒ è¿½åŠ ã§Enterã‚­ãƒ¼å¯¾å¿œ
            const quickColumnInput = document.getElementById('quick-column-name');
            if (quickColumnInput) {
                quickColumnInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        quickAddColumn();
                    }
                });
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚’è¨­å®š
            setupFileDropZone();
        });


        // GoogleTODOå½¢å¼ã®ã‚¿ã‚¹ã‚¯è§£æï¼ˆæœŸé™ä»˜ãã‚¿ã‚¹ã‚¯ã‚’åˆ†é›¢ï¼‰
        function parseGoogleTodoText(text) {
            // GoogleTODOã®æœŸé™å½¢å¼ãƒ‘ã‚¿ãƒ¼ãƒ³: mmæœˆddæ—¥(æ›œæ—¥), hh:mm
            // ä¾‹: "12æœˆ15æ—¥(æœˆ), 14:30" ã¾ãŸã¯ "12æœˆ15æ—¥ 14:30" ãªã©
            const dateTimePatterns = [
                // åŸºæœ¬å½¢å¼: mmæœˆddæ—¥(æ›œæ—¥), hh:mm
                /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*\([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]\)\s*,?\s*(\d{1,2}):(\d{2})/g,
                // æ›œæ—¥ãªã—: mmæœˆddæ—¥, hh:mm
                /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*,?\s*(\d{1,2}):(\d{2})/g,
                // æ™‚åˆ»ãªã—: mmæœˆddæ—¥(æ›œæ—¥)
                /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*\([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]\)/g,
                // æ™‚åˆ»ãªã—æ›œæ—¥ãªã—: mmæœˆddæ—¥
                /(\d{1,2})æœˆ(\d{1,2})æ—¥/g,
                // è¥¿æš¦ä»˜ã: yyyyå¹´mmæœˆddæ—¥
                /(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/g
            ];
            
            const results = [];
            const lines = text.split('\n');
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                let taskTitle = trimmedLine;
                let deadline = null;
                let foundDate = false;
                
                // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒãƒƒãƒã‚’è©¦è¡Œ
                for (const pattern of dateTimePatterns) {
                    const matches = [...trimmedLine.matchAll(pattern)];
                    if (matches.length > 0) {
                        const match = matches[0];
                        foundDate = true;
                        
                        // æœŸé™æƒ…å ±ã‚’æŠ½å‡º
                        if (pattern.source.includes('å¹´')) {
                            // yyyyå¹´mmæœˆddæ—¥å½¢å¼
                            const year = match[1];
                            const month = match[2].padStart(2, '0');
                            const day = match[3].padStart(2, '0');
                            deadline = `${year}-${month}-${day}`;
                        } else if (match[3] && match[4]) {
                            // æ™‚åˆ»ä»˜ã
                            const month = match[1].padStart(2, '0');
                            const day = match[2].padStart(2, '0');
                            const hour = match[3].padStart(2, '0');
                            const minute = match[4].padStart(2, '0');
                            const currentYear = new Date().getFullYear();
                            deadline = `${currentYear}-${month}-${day}T${hour}:${minute}`;
                        } else {
                            // æ—¥ä»˜ã®ã¿
                            const month = match[1].padStart(2, '0');
                            const day = match[2].padStart(2, '0');
                            const currentYear = new Date().getFullYear();
                            deadline = `${currentYear}-${month}-${day}`;
                        }
                        
                        // æœŸé™éƒ¨åˆ†ã‚’ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é™¤å»
                        taskTitle = trimmedLine.replace(match[0], '').trim();
                        
                        // å‰å¾Œã®ä¸è¦ãªè¨˜å·ã‚’é™¤å»
                        taskTitle = taskTitle.replace(/^[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+|[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+$/g, '');
                        
                        break;
                    }
                }
                
                // æœŸé™ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ç°¡æ˜“ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ•°å­—ã®ã¿ã®æ™‚åˆ»ãªã©ï¼‰
                if (!foundDate) {
                    // å˜ç´”ãªæ™‚åˆ»ãƒ‘ã‚¿ãƒ¼ãƒ³: hh:mm
                    const timeMatch = taskTitle.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                        const hour = timeMatch[1].padStart(2, '0');
                        const minute = timeMatch[2].padStart(2, '0');
                        const today = new Date();
                        deadline = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T${hour}:${minute}`;
                        taskTitle = taskTitle.replace(timeMatch[0], '').trim();
                    }
                }
                
                // ç©ºã®ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¿ã‘ã‚‹
                if (taskTitle && taskTitle.length > 1) {
                    results.push({
                        title: taskTitle,
                        deadline: deadline,
                        hasDeadline: !!deadline,
                        originalLine: trimmedLine
                    });
                }
            });
            
            return results;
        }

        // OCRçµæœã®ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
        function postprocessOCRText(text) {
            let processed = text;
            
            // å›²ã¿æ•°å­—ã¯å¸¸ã«ä¿®æ­£ï¼ˆæ˜ã‚‰ã‹ãªèª¤èªè­˜ã®ãŸã‚ï¼‰
            const circledNumbers = {
                'â‘ ': '1', 'â‘¡': '2', 'â‘¢': '3', 'â‘£': '4', 'â‘¤': '5',
                'â‘¥': '6', 'â‘¦': '7', 'â‘§': '8', 'â‘¨': '9', 'â‘©': '10',
                'â‘ª': '11', 'â‘«': '12', 'â‘¬': '13', 'â‘­': '14', 'â‘®': '15',
                'â‘¯': '16', 'â‘°': '17', 'â‘±': '18', 'â‘²': '19', 'â‘³': '20',
                'â¶': '1', 'â·': '2', 'â¸': '3', 'â¹': '4', 'âº': '5',
                'â»': '6', 'â¼': '7', 'â½': '8', 'â¾': '9', 'â¿': '10',
                'â“ª': '0', 'â“«': '11', 'â“¬': '12', 'â“­': '13', 'â“®': '14',
                'â“¯': '15', 'â“°': '16', 'â“±': '17', 'â“²': '18', 'â“³': '19', 'â“´': '20'
            };
            
            // å›²ã¿æ•°å­—ã‚’é€šå¸¸ã®æ•°å­—ã«å¤‰æ›ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
            Object.keys(circledNumbers).forEach(circled => {
                const regex = new RegExp(circled, 'g');
                processed = processed.replace(regex, circledNumbers[circled]);
            });
            
            // ãã®ä»–ã®è¨˜å·ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            if (document.getElementById('ocr-cleanup-symbols').checked) {
                // å…¨è§’æ•°å­—â†’åŠè§’æ•°å­—
                processed = processed.replace(/[ï¼-ï¼™]/g, (match) => 
                    String.fromCharCode(match.charCodeAt(0) - 0xFEE0)
                );
                
                // æ˜ã‚‰ã‹ãªèª¤èªè­˜ã®ã¿ä¿®æ­£
                processed = processed
                    .replace(/\b[Oo]\.?\s*(?=\d)/g, '0') // O.æ•°å­— â†’ 0æ•°å­—
                    .replace(/\b[Il]\s*(?=\d)/g, '1') // Iæ•°å­— â†’ 1æ•°å­—
                    .replace(/\b[Il]\b/g, '1') // å˜ä½“ã®Iã‚„lâ†’ 1
                    // ä¸¸è¨˜å·ã®å¤‰æ›
                    .replace(/[â—‹â—¯â—Œâšª]/g, '0') // ç™½ä¸¸â†’ 0
                    .replace(/[â—â€¢âš«]/g, '1'); // é»’ä¸¸â†’ 1
            }
            
            return processed.trim();
        }
        
        async function performOCROnCanvas(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    // å‰å‡¦ç†ã‚’é©ç”¨
                    const processedCanvas = await preprocessImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            const { data: { text } } = await Tesseract.recognize(
                                blob,
                                'jpn+eng',
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                                    tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZã‚-ã‚–ã‚¢-ãƒ¶ä¸€-é¾¯!@#$%^&*()_+-=[]{}|;:,.<>?/~ ã€€ã€Œã€ã€ã€‚',
                                    preserve_interword_spaces: '1'
                                }
                            );
                            
                            // ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°ã‚’é©ç”¨
                            const processedText = postprocessOCRText(text);
                            resolve(processedText);
                        } catch (error) {
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // æœŸé™å°‚ç”¨OCRï¼ˆã‚ˆã‚Šå³å¯†ãªæ–‡å­—èªè­˜ï¼‰
        async function performDeadlineOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    // ã‚ˆã‚Šå³å¯†ãªå‰å‡¦ç†ï¼ˆæœŸé™ç”¨ï¼‰
                    const processedCanvas = await preprocessDeadlineImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            // æ—¥æœ¬èªå„ªå…ˆã®è¨­å®šã§OCRå®Ÿè¡Œ
                            const { data: { text } } = await Tesseract.recognize(
                                blob,
                                'jpn', // æ—¥æœ¬èªã®ã¿ã«å¤‰æ›´ï¼ˆè‹±èªæ··åœ¨ã‚’é¿ã‘ã‚‹ï¼‰
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE, // å˜ä¸€è¡Œãƒ¢ãƒ¼ãƒ‰
                                    // æ–‡å­—ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚’ä¸€æ™‚çš„ã«å¤–ã—ã¦å…¨æ–‡å­—èªè­˜
                                    preserve_interword_spaces: '1',
                                    tessedit_ocr_engine_mode: 3 // LSTM mode
                                }
                            );
                            
                            console.log('æœŸé™OCRç”Ÿã®çµæœ:', text);
                            
                            // æœŸé™å°‚ç”¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
                            const processedText = postprocessDeadlineText(text);
                            console.log('æœŸé™OCRå‡¦ç†å¾Œ:', processedText);
                            
                            resolve(processedText);
                        } catch (error) {
                            console.error('æœŸé™OCRã‚¨ãƒ©ãƒ¼:', error);
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // æœŸé™å°‚ç”¨å‰å‡¦ç†
        async function preprocessDeadlineImage(canvas) {
            const ctx = canvas.getContext('2d');
            
            // ç”»åƒã®å†…å®¹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            console.log('æœŸé™ç”»åƒã‚µã‚¤ã‚º:', canvas.width, 'x', canvas.height);
            
            // åè»¢æ¤œçŸ¥ï¼ˆé»’èƒŒæ™¯ã®å ´åˆï¼‰
            const sampleData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let blackPixels = 0;
            let totalPixels = sampleData.data.length / 4;
            
            for (let i = 0; i < sampleData.data.length; i += 4) {
                const gray = sampleData.data[i] * 0.299 + sampleData.data[i + 1] * 0.587 + sampleData.data[i + 2] * 0.114;
                if (gray < 128) blackPixels++;
            }
            
            const isInverted = blackPixels / totalPixels > 0.6;
            console.log('èƒŒæ™¯åˆ¤å®š:', isInverted ? 'é»’èƒŒæ™¯' : 'ç™½èƒŒæ™¯');
            
            // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ« + é©å¿œçš„äºŒå€¤åŒ–
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                
                // é»’èƒŒæ™¯ã®å ´åˆã¯è‰²ã‚’åè»¢
                let value;
                if (isInverted) {
                    value = gray < 128 ? 255 : 0;
                } else {
                    value = gray > 128 ? 255 : 0;
                }
                
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            ctx.putImageData(imageData, 0, 0);
            
            // 4å€æ‹¡å¤§ï¼ˆGoogle TODO ã®å°ã•ã„æœŸé™ãƒ†ã‚­ã‚¹ãƒˆç”¨ï¼‰
            const scaledCanvas = document.createElement('canvas');
            const scaledCtx = scaledCanvas.getContext('2d');
            scaledCanvas.width = canvas.width * 4;
            scaledCanvas.height = canvas.height * 4;
            
            // ãƒã‚¤ãƒªãƒ‹ã‚¢è£œé–“ã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šæ»‘ã‚‰ã‹ãªæ‹¡å¤§ï¼‰
            scaledCtx.imageSmoothingEnabled = true;
            scaledCtx.imageSmoothingQuality = 'high';
            scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
            
            // å†åº¦ã‚·ãƒ£ãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°
            const finalData = scaledCtx.getImageData(0, 0, scaledCanvas.width, scaledCanvas.height);
            const finalPixels = finalData.data;
            
            for (let i = 0; i < finalPixels.length; i += 4) {
                const gray = finalPixels[i];
                const sharpened = gray > 200 ? 255 : 0;
                finalPixels[i] = finalPixels[i + 1] = finalPixels[i + 2] = sharpened;
            }
            scaledCtx.putImageData(finalData, 0, 0);
            
            return scaledCanvas;
        }
        
        // æœŸé™å°‚ç”¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
        function postprocessDeadlineText(text) {
            let processed = text.trim();
            
            // å›²ã¿æ•°å­—ã‚’é€šå¸¸æ•°å­—ã«å¤‰æ›
            const circledNumbers = {
                'â‘ ': '1', 'â‘¡': '2', 'â‘¢': '3', 'â‘£': '4', 'â‘¤': '5',
                'â‘¥': '6', 'â‘¦': '7', 'â‘§': '8', 'â‘¨': '9', 'â‘©': '10',
                'â‘ª': '11', 'â‘«': '12', 'â‘¬': '13', 'â‘­': '14', 'â‘®': '15',
                'â‘¯': '16', 'â‘°': '17', 'â‘±': '18', 'â‘²': '19', 'â‘³': '20',
                'ã‰‘': '21', 'ã‰’': '22', 'ã‰“': '23', 'ã‰”': '24', 'ã‰•': '25',
                'ã‰–': '26', 'ã‰—': '27', 'ã‰˜': '28', 'ã‰™': '29', 'ã‰š': '30', 'ã‰›': '31'
            };
            
            Object.keys(circledNumbers).forEach(circled => {
                const regex = new RegExp(circled, 'g');
                processed = processed.replace(regex, circledNumbers[circled]);
            });
            
            // æœŸé™ç‰¹æœ‰ã®èª¤èªè­˜ã‚’ä¿®æ­£
            processed = processed
                .replace(/[oO]/g, '0') // o,O â†’ 0
                .replace(/[lI]/g, '1') // l,I â†’ 1
                .replace(/[S]/g, '5') // S â†’ 5
                .replace(/[Zz]/g, '2') // Z,z â†’ 2
                .replace(/[B]/g, '8') // B â†’ 8
                .replace(/[G]/g, '6') // G â†’ 6
                // å…¨è§’æ•°å­—ã‚’åŠè§’ã«
                .replace(/[ï¼-ï¼™]/g, (match) => 
                    String.fromCharCode(match.charCodeAt(0) - 0xFEE0)
                )
                // ä¸è¦ãªè¨˜å·ã‚’é™¤å»ï¼ˆæœŸé™ã«å¿…è¦ãªæ–‡å­—ä»¥å¤–ï¼‰
                .replace(/[^\dæœˆæ—¥\(\)ç«æ°´æœ¨é‡‘åœŸ,:\ ]/g, '')
                // è¤‡æ•°ã‚¹ãƒšãƒ¼ã‚¹ã‚’å˜ä¸€ã‚¹ãƒšãƒ¼ã‚¹ã«
                .replace(/\s+/g, ' ');
            
            return processed.trim();
        }
        
        // æ‰‹æ›¸ãæ–‡å­—å¯¾å¿œOCRï¼ˆé«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ï¼‰
        async function performHandwritingOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('æ‰‹æ›¸ãæ–‡å­—OCRé–‹å§‹:', canvas.width, 'x', canvas.height);
                    
                    // æ‰‹æ›¸ãå°‚ç”¨å‰å‡¦ç†
                    const processedCanvas = await preprocessHandwritingImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            // æ‰‹æ›¸ãæ–‡å­—ã«æœ€é©åŒ–ã•ã‚ŒãŸè¨­å®šã§OCRå®Ÿè¡Œ
                            const { data: { text, confidence } } = await Tesseract.recognize(
                                blob,
                                'jpn', // æ—¥æœ¬èªã®ã¿ã«ç‰¹åŒ–
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.AUTO, // è‡ªå‹•ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
                                    tessedit_ocr_engine_mode: 3, // LSTM Neural Network
                                    // æ‰‹æ›¸ãæ–‡å­—ç”¨ã®è¨­å®š
                                    tessedit_char_whitelist: '0123456789æœˆæ—¥ç«æ°´æœ¨é‡‘åœŸæ—¥(),:ï¼šã€€ ', // æœŸé™ã«å¿…è¦ãªæ–‡å­—ã®ã¿
                                    c_min_confidence: 30, // ä¿¡é ¼åº¦ã‚’ä¸‹ã’ã¦æ‰‹æ›¸ãã‚‚èªè­˜
                                    preserve_interword_spaces: '1',
                                    // æ‰‹æ›¸ãæ–‡å­—èªè­˜å¼·åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                                    textord_heavy_nr: '1',
                                    textord_min_linesize: '2.5',
                                    edges_max_children_per_outline: '40'
                                }
                            );
                            
                            console.log('æ‰‹æ›¸ãOCRçµæœ:', text);
                            console.log('æ‰‹æ›¸ãOCRä¿¡é ¼åº¦:', confidence);
                            
                            // æ‰‹æ›¸ãå°‚ç”¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
                            const processedText = postprocessHandwritingText(text);
                            console.log('æ‰‹æ›¸ãOCRå‡¦ç†å¾Œ:', processedText);
                            
                            resolve({ text: processedText, confidence: confidence });
                        } catch (error) {
                            console.error('æ‰‹æ›¸ãOCRã‚¨ãƒ©ãƒ¼:', error);
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // æ‰‹æ›¸ãæ–‡å­—å°‚ç”¨å‰å‡¦ç†
        async function preprocessHandwritingImage(canvas) {
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            newCanvas.width = canvas.width;
            newCanvas.height = canvas.height;
            
            ctx.drawImage(canvas, 0, 0);
            
            // æ‰‹æ›¸ãæ–‡å­—ç”¨ã®ç‰¹åˆ¥ãªå‰å‡¦ç†
            const imageData = ctx.getImageData(0, 0, newCanvas.width, newCanvas.height);
            const data = imageData.data;
            
            // 1. ã‚¨ãƒƒã‚¸å¼·åŒ–ï¼ˆæ‰‹æ›¸ãã®è–„ã„ç·šã‚’å¼·èª¿ï¼‰
            const edgeData = new Uint8ClampedArray(data);
            for (let y = 1; y < newCanvas.height - 1; y++) {
                for (let x = 1; x < newCanvas.width - 1; x++) {
                    const idx = (y * newCanvas.width + x) * 4;
                    
                    // å‘¨å›²ã®ãƒ”ã‚¯ã‚»ãƒ«ã¨ã®å·®åˆ†ã‚’è¨ˆç®—
                    const center = data[idx];
                    const top = data[((y-1) * newCanvas.width + x) * 4];
                    const bottom = data[((y+1) * newCanvas.width + x) * 4];
                    const left = data[(y * newCanvas.width + (x-1)) * 4];
                    const right = data[(y * newCanvas.width + (x+1)) * 4];
                    
                    const edge = Math.abs(center - top) + Math.abs(center - bottom) + 
                                Math.abs(center - left) + Math.abs(center - right);
                    
                    const enhanced = Math.min(255, center + edge * 0.3);
                    edgeData[idx] = edgeData[idx + 1] = edgeData[idx + 2] = enhanced;
                }
            }
            
            // 2. ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã§ãƒã‚¤ã‚ºé™¤å»
            const filtered = applyGaussianFilter(edgeData, newCanvas.width, newCanvas.height);
            
            // 3. é©å¿œçš„äºŒå€¤åŒ–ï¼ˆæ‰‹æ›¸ãã®æ¿ƒåº¦ãƒ ãƒ©ã«å¯¾å¿œï¼‰
            for (let i = 0; i < filtered.length; i += 4) {
                const gray = filtered[i];
                // æ‰‹æ›¸ãæ–‡å­—ç”¨ã®é–¾å€¤èª¿æ•´
                const threshold = 140; // æ‰‹æ›¸ãã¯é€šå¸¸ã‚ˆã‚Šä½ã„é–¾å€¤
                const value = gray > threshold ? 255 : 0;
                filtered[i] = filtered[i + 1] = filtered[i + 2] = value;
            }
            
            const processedImageData = new ImageData(filtered, newCanvas.width, newCanvas.height);
            ctx.putImageData(processedImageData, 0, 0);
            
            // 4. æ‹¡å¤§å‡¦ç†ï¼ˆæ‰‹æ›¸ãã®ç´°ã‹ã„ç‰¹å¾´ã‚’ä¿æŒï¼‰
            const scaledCanvas = document.createElement('canvas');
            const scaledCtx = scaledCanvas.getContext('2d');
            scaledCanvas.width = newCanvas.width * 3;
            scaledCanvas.height = newCanvas.height * 3;
            
            scaledCtx.imageSmoothingEnabled = false; // æ‰‹æ›¸ãã®ç‰¹å¾´ã‚’ä¿æŒ
            scaledCtx.drawImage(newCanvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
            
            return scaledCanvas;
        }
        
        // ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆãƒã‚¤ã‚ºé™¤å»ç”¨ï¼‰
        function applyGaussianFilter(data, width, height) {
            const filtered = new Uint8ClampedArray(data.length);
            const kernel = [1, 2, 1, 2, 4, 2, 1, 2, 1]; // 3x3ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ«
            const kernelSum = 16;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    let sum = 0;
                    
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixelIdx = ((y + ky) * width + (x + kx)) * 4;
                            const kernelIdx = (ky + 1) * 3 + (kx + 1);
                            sum += data[pixelIdx] * kernel[kernelIdx];
                        }
                    }
                    
                    const filteredValue = sum / kernelSum;
                    filtered[idx] = filtered[idx + 1] = filtered[idx + 2] = filteredValue;
                    filtered[idx + 3] = 255; // Alpha
                }
            }
            
            return filtered;
        }
        
        // æ‰‹æ›¸ãæ–‡å­—å°‚ç”¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
        function postprocessHandwritingText(text) {
            let processed = text.trim();
            
            // æ‰‹æ›¸ãæ–‡å­—ç‰¹æœ‰ã®èª¤èªè­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¿®æ­£
            const handwritingCorrections = {
                // æ•°å­—ã®èª¤èªè­˜
                'o': '0', 'O': '0', 'ã€‡': '0', 'â—‹': '0',
                'l': '1', 'I': '1', '|': '1', 'ï½œ': '1',
                'Z': '2', 'z': '2', 'ã‚¢': '2',
                'ã‚´': '5', 'S': '5', 's': '5',
                'b': '6', 'G': '6', 'ãƒ­': '6',
                'T': '7', '7': '7', 'ï¼Ÿ': '7',
                'B': '8', '8': '8', 'ãŠ': '8',
                'g': '9', 'q': '9', 'ã‚Š': '9',
                
                // æ›œæ—¥ã®èª¤èªè­˜
                'ç«æ›œ': 'ç«', 'æ°´æ›œ': 'æ°´', 'æœ¨æ›œ': 'æœ¨', 'é‡‘æ›œ': 'é‡‘', 'åœŸæ›œ': 'åœŸ', 'æ—¥æ›œ': 'æ—¥', 'æœˆæ›œ': 'æœˆ',
                'ã²': 'ç«', 'ã¿': 'æ°´', 'ã': 'æœ¨', 'ãã‚“': 'é‡‘', 'ã©': 'åœŸ', 'ã«ã¡': 'æ—¥', 'ã’ã¤': 'æœˆ',
                
                // è¨˜å·ã®èª¤èªè­˜
                'ï¼š': ':', 'ã€‚': ',', 'ã€': ',', 'ï½': '',
                'ï¼': '/', 'ï¼¼': '\\', 'ï¼»': '(', 'ï¼½': ')'
            };
            
            // èª¤èªè­˜ä¿®æ­£ã‚’é©ç”¨
            Object.keys(handwritingCorrections).forEach(wrong => {
                const regex = new RegExp(wrong, 'g');
                processed = processed.replace(regex, handwritingCorrections[wrong]);
            });
            
            // æ‰‹æ›¸ããƒã‚¤ã‚ºã®é™¤å»
            processed = processed
                .replace(/[^\dæœˆæ—¥\(\)æœˆç«æ°´æœ¨é‡‘åœŸæ—¥,:ï¼šã€€ ]/g, '') // æœŸé™ã«å¿…è¦ãªæ–‡å­—ä»¥å¤–ã‚’é™¤å»
                .replace(/\s+/g, ' ') // é€£ç¶šç©ºç™½ã‚’1ã¤ã«
                .trim();
            
            console.log('æ‰‹æ›¸ãæ–‡å­—ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°:', processed);
            return processed;
        }
        
        // OCRè¨­å®šãƒªã‚»ãƒƒãƒˆ
        function resetOCRSettings() {
            document.getElementById('ocr-enhance-contrast').checked = false;
            document.getElementById('ocr-upscale').checked = false;
            document.getElementById('ocr-grayscale').checked = false;
            document.getElementById('ocr-cleanup-symbols').checked = false;
            document.getElementById('ocr-handwriting-mode').checked = false;
            document.getElementById('ocr-complex-layout-mode').checked = false;
        }
        
        // è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testComplexLayoutOCR() {
            if (selectedAreas.length === 0) {
                alert('OCRå¯¾è±¡ã®é ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆç”¨ã®é ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('=== è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            for (let i = 0; i < selectedAreas.length; i++) {
                const area = selectedAreas[i];
                console.log(`\nğŸ§© è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé ˜åŸŸ ${i + 1} ãƒ†ã‚¹ãƒˆ:`);
                
                // é ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    // è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRå®Ÿè¡Œ
                    const complexResult = await performComplexLayoutOCR(croppedCanvas);
                    console.log('ğŸ§© è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRçµæœ:', complexResult);
                    
                    // æ¯”è¼ƒç”¨ã«é€šå¸¸OCRã‚‚å®Ÿè¡Œ
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('ğŸ“„ é€šå¸¸OCRçµæœ:', normalText);
                    
                    // çµæœæ¯”è¼ƒ
                    console.log(`\nğŸ“Š çµæœæ¯”è¼ƒ:`);
                    console.log(`è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰: "${complexResult.text}" (ã‚¿ã‚¤ãƒ—: ${complexResult.type}, ä¿¡é ¼åº¦: ${complexResult.confidence?.toFixed(1)}%)`);
                    console.log(`é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: "${normalText}"`);
                    
                    // æ§‹é€ è§£æçµæœï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
                    if (complexResult.structure) {
                        console.log('ğŸ“ æ§‹é€ è§£æ:', complexResult.structure);
                    }
                    
                } catch (error) {
                    console.error('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            console.log('\n=== è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRãƒ†ã‚¹ãƒˆçµ‚äº† ===');
            alert('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãªçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // æ‰‹æ›¸ãOCRãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testHandwritingOCR() {
            const handwritingAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (handwritingAreas.length === 0) {
                alert('æœŸé™ã‚¿ã‚°ãŒè¨­å®šã•ã‚ŒãŸé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ‰‹æ›¸ããƒ†ã‚¹ãƒˆç”¨ã®é ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('=== æ‰‹æ›¸ãOCRãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            for (let i = 0; i < handwritingAreas.length; i++) {
                const area = handwritingAreas[i];
                console.log(`\nâœï¸ æ‰‹æ›¸ãé ˜åŸŸ ${i + 1} ãƒ†ã‚¹ãƒˆ:`);
                
                // é ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    // æ‰‹æ›¸ãOCRå®Ÿè¡Œ
                    const handwritingResult = await performHandwritingOCR(croppedCanvas);
                    console.log('âœï¸ æ‰‹æ›¸ãOCRçµæœ:', handwritingResult.text);
                    console.log('ğŸ¯ æ‰‹æ›¸ãOCRä¿¡é ¼åº¦:', handwritingResult.confidence);
                    console.log('ğŸ“… æœŸé™è§£æçµæœ:', parseDeadlineText(handwritingResult.text));
                    
                    // æ¯”è¼ƒç”¨ã«é€šå¸¸OCRã‚‚å®Ÿè¡Œ
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('ğŸ“„ é€šå¸¸OCRçµæœ:', normalText);
                    console.log('ğŸ“… é€šå¸¸OCRæœŸé™è§£æ:', parseDeadlineText(normalText));
                    
                    // ç²¾åº¦æ¯”è¼ƒ
                    const handwritingSuccess = parseDeadlineText(handwritingResult.text) !== null;
                    const normalSuccess = parseDeadlineText(normalText) !== null;
                    
                    console.log(`\nğŸ“Š çµæœæ¯”è¼ƒ:`);
                    console.log(`æ‰‹æ›¸ããƒ¢ãƒ¼ãƒ‰: ${handwritingSuccess ? 'æˆåŠŸ âœ…' : 'å¤±æ•— âŒ'} (ä¿¡é ¼åº¦: ${handwritingResult.confidence}%)`);
                    console.log(`é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ${normalSuccess ? 'æˆåŠŸ âœ…' : 'å¤±æ•— âŒ'}`);
                    
                } catch (error) {
                    console.error('æ‰‹æ›¸ãOCRã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            console.log('\n=== æ‰‹æ›¸ãOCRãƒ†ã‚¹ãƒˆçµ‚äº† ===');
            alert('æ‰‹æ›¸ãOCRãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãªçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè§£æOCRï¼ˆè¡¨ãƒ»å›³å¯¾å¿œï¼‰
        async function performComplexLayoutOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRé–‹å§‹:', canvas.width, 'x', canvas.height);
                    
                    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè‡ªå‹•æ¤œå‡º
                    const layoutType = detectLayoutType(canvas);
                    console.log('æ¤œå‡ºã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:', layoutType);
                    
                    let result;
                    switch (layoutType) {
                        case 'table':
                            result = await performTableOCR(canvas);
                            break;
                        case 'list':
                            result = await performListOCR(canvas);
                            break;
                        case 'form':
                            result = await performFormOCR(canvas);
                            break;
                        default:
                            result = await performAdvancedOCR(canvas);
                    }
                    
                    console.log('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRçµæœ:', result);
                    resolve(result);
                    
                } catch (error) {
                    console.error('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRã‚¨ãƒ©ãƒ¼:', error);
                    reject(error);
                }
            });
        }
        
        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¿ã‚¤ãƒ—è‡ªå‹•æ¤œå‡º
        function detectLayoutType(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // ç·šã®æ¤œå‡ºï¼ˆç¸¦ç·šãƒ»æ¨ªç·šã®å¤šã•ã§åˆ¤å®šï¼‰
            let horizontalLines = 0;
            let verticalLines = 0;
            
            // æ¨ªç·šæ¤œå‡º
            for (let y = 0; y < canvas.height; y += 5) {
                let linePixels = 0;
                for (let x = 0; x < canvas.width; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    const gray = data[idx] * 0.299 + data[idx + 1] * 0.587 + data[idx + 2] * 0.114;
                    if (gray < 128) linePixels++;
                }
                if (linePixels > canvas.width * 0.7) horizontalLines++;
            }
            
            // ç¸¦ç·šæ¤œå‡º
            for (let x = 0; x < canvas.width; x += 5) {
                let linePixels = 0;
                for (let y = 0; y < canvas.height; y++) {
                    const idx = (y * canvas.width + x) * 4;
                    const gray = data[idx] * 0.299 + data[idx + 1] * 0.587 + data[idx + 2] * 0.114;
                    if (gray < 128) linePixels++;
                }
                if (linePixels > canvas.height * 0.7) verticalLines++;
            }
            
            console.log(`ç·šæ¤œå‡ºçµæœ: æ¨ªç·š=${horizontalLines}, ç¸¦ç·š=${verticalLines}`);
            
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ¤å®š
            if (horizontalLines >= 3 && verticalLines >= 2) {
                return 'table'; // è¡¨å½¢å¼
            } else if (horizontalLines >= 3) {
                return 'list'; // ãƒªã‚¹ãƒˆå½¢å¼
            } else if (verticalLines >= 2) {
                return 'form'; // ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼
            } else {
                return 'mixed'; // æ··åˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
            }
        }
        
        // è¡¨å½¢å¼OCR
        async function performTableOCR(canvas) {
            console.log('è¡¨å½¢å¼OCRå®Ÿè¡Œä¸­...');
            
            // ã‚»ãƒ«å˜ä½ã«åˆ†å‰²ã—ã¦OCRå®Ÿè¡Œ
            const cells = detectTableCells(canvas);
            const results = [];
            
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                const cellCanvas = extractCellCanvas(canvas, cell);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        cellCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                            tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZã‚-ã‚–ã‚¢-ãƒ¶ä¸€-é¾¯(),:ï¼šæœˆæ—¥ç«æ°´æœ¨é‡‘åœŸæ—¥ ã€€',
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        row: cell.row,
                        col: cell.col,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`ã‚»ãƒ«[${cell.row},${cell.col}]ã®OCRã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            return formatTableResults(results);
        }
        
        // ãƒªã‚¹ãƒˆå½¢å¼OCR
        async function performListOCR(canvas) {
            console.log('ãƒªã‚¹ãƒˆå½¢å¼OCRå®Ÿè¡Œä¸­...');
            
            // è¡Œå˜ä½ã«åˆ†å‰²
            const lines = detectListLines(canvas);
            const results = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lineCanvas = extractLineCanvas(canvas, line);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        lineCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        line: i + 1,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`è¡Œ${i + 1}ã®OCRã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            return formatListResults(results);
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼OCR
        async function performFormOCR(canvas) {
            console.log('ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼OCRå®Ÿè¡Œä¸­...');
            
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å˜ä½ã«åˆ†å‰²
            const fields = detectFormFields(canvas);
            const results = [];
            
            for (let i = 0; i < fields.length; i++) {
                const field = fields[i];
                const fieldCanvas = extractFieldCanvas(canvas, field);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        fieldCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        field: field.label || `ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰${i + 1}`,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰${i + 1}ã®OCRã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            return formatFormResults(results);
        }
        
        // é«˜åº¦OCRï¼ˆæ··åˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
        async function performAdvancedOCR(canvas) {
            console.log('é«˜åº¦OCRå®Ÿè¡Œä¸­...');
            
            try {
                const { data: { text, confidence, lines, words } } = await Tesseract.recognize(
                    canvas,
                    'jpn+eng',
                    {
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                        tessedit_ocr_engine_mode: 3, // LSTM
                        preserve_interword_spaces: '1',
                        // è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨è¨­å®š
                        textord_heavy_nr: '1',
                        textord_tabfind_show_vlines: '1',
                        textord_tablefind_good_width: '3',
                        textord_tablefind_good_height: '3'
                    }
                );
                
                return {
                    type: 'advanced',
                    text: text,
                    confidence: confidence,
                    structure: analyzeTextStructure(lines, words)
                };
            } catch (error) {
                console.error('é«˜åº¦OCRã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }
        
        // è¡¨ã‚»ãƒ«æ¤œå‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function detectTableCells(canvas) {
            // å®Ÿè£…ç°¡ç•¥åŒ– - å®Ÿéš›ã¯ç”»åƒè§£æã§ç½«ç·šã‚’æ¤œå‡º
            const cells = [];
            const rows = 3, cols = 3; // ä»®ã®3x3è¡¨
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    cells.push({
                        row: r,
                        col: c,
                        x: (canvas.width / cols) * c,
                        y: (canvas.height / rows) * r,
                        width: canvas.width / cols,
                        height: canvas.height / rows
                    });
                }
            }
            
            return cells;
        }
        
        // ãƒªã‚¹ãƒˆè¡Œæ¤œå‡º
        function detectListLines(canvas) {
            const lines = [];
            const lineHeight = canvas.height / 5; // ä»®ã«5è¡Œ
            
            for (let i = 0; i < 5; i++) {
                lines.push({
                    x: 0,
                    y: lineHeight * i,
                    width: canvas.width,
                    height: lineHeight
                });
            }
            
            return lines;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œå‡º
        function detectFormFields(canvas) {
            const fields = [];
            const fieldHeight = canvas.height / 3;
            
            for (let i = 0; i < 3; i++) {
                fields.push({
                    label: `ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰${i + 1}`,
                    x: 0,
                    y: fieldHeight * i,
                    width: canvas.width,
                    height: fieldHeight
                });
            }
            
            return fields;
        }
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹æŠ½å‡ºé–¢æ•°ç¾¤
        function extractCellCanvas(canvas, cell) {
            const cellCanvas = document.createElement('canvas');
            const ctx = cellCanvas.getContext('2d');
            cellCanvas.width = cell.width;
            cellCanvas.height = cell.height;
            ctx.drawImage(canvas, cell.x, cell.y, cell.width, cell.height, 0, 0, cell.width, cell.height);
            return cellCanvas;
        }
        
        function extractLineCanvas(canvas, line) {
            const lineCanvas = document.createElement('canvas');
            const ctx = lineCanvas.getContext('2d');
            lineCanvas.width = line.width;
            lineCanvas.height = line.height;
            ctx.drawImage(canvas, line.x, line.y, line.width, line.height, 0, 0, line.width, line.height);
            return lineCanvas;
        }
        
        function extractFieldCanvas(canvas, field) {
            const fieldCanvas = document.createElement('canvas');
            const ctx = fieldCanvas.getContext('2d');
            fieldCanvas.width = field.width;
            fieldCanvas.height = field.height;
            ctx.drawImage(canvas, field.x, field.y, field.width, field.height, 0, 0, field.width, field.height);
            return fieldCanvas;
        }
        
        // çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ç¾¤
        function formatTableResults(results) {
            let formatted = 'ã€è¡¨å½¢å¼ãƒ‡ãƒ¼ã‚¿ã€‘\n';
            const maxRow = Math.max(...results.map(r => r.row));
            const maxCol = Math.max(...results.map(r => r.col));
            
            for (let r = 0; r <= maxRow; r++) {
                const rowData = [];
                for (let c = 0; c <= maxCol; c++) {
                    const cell = results.find(result => result.row === r && result.col === c);
                    rowData.push(cell ? cell.text : '');
                }
                formatted += rowData.join(' | ') + '\n';
            }
            
            return { type: 'table', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        function formatListResults(results) {
            let formatted = 'ã€ãƒªã‚¹ãƒˆå½¢å¼ãƒ‡ãƒ¼ã‚¿ã€‘\n';
            results.forEach(result => {
                formatted += `â€¢ ${result.text}\n`;
            });
            
            return { type: 'list', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        function formatFormResults(results) {
            let formatted = 'ã€ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼ãƒ‡ãƒ¼ã‚¿ã€‘\n';
            results.forEach(result => {
                formatted += `${result.field}: ${result.text}\n`;
            });
            
            return { type: 'form', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆæ§‹é€ è§£æ
        function analyzeTextStructure(lines, words) {
            return {
                lineCount: lines ? lines.length : 0,
                wordCount: words ? words.length : 0,
                avgConfidence: words ? words.reduce((sum, w) => sum + w.confidence, 0) / words.length : 0
            };
        }
        
        // æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        async function deepDeadlineDebug() {
            const deadlineAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (deadlineAreas.length === 0) {
                alert('æœŸé™ã‚¿ã‚°ãŒè¨­å®šã•ã‚ŒãŸé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœŸé™é ˜åŸŸã‚’é¸æŠã—ã¦ãƒ‡ãƒãƒƒã‚°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('ğŸ”¬=== æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===');
            
            for (let i = 0; i < deadlineAreas.length; i++) {
                const area = deadlineAreas[i];
                console.log(`\nğŸ¯ æœŸé™é ˜åŸŸ ${i + 1} è©³ç´°è§£æ:`);
                
                // é ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    console.log('ğŸ“ é ˜åŸŸæƒ…å ±:', { width: area.width, height: area.height, x: area.x, y: area.y });
                    
                    // 1. å…¨ç¨®é¡ã®OCRã‚’å®Ÿè¡Œã—ã¦æ¯”è¼ƒ
                    console.log('\nğŸ” å„ç¨®OCRçµæœæ¯”è¼ƒ:');
                    
                    // é€šå¸¸OCR
                    const normalResult = await performOCROnCanvas(croppedCanvas);
                    console.log('ğŸ“„ é€šå¸¸OCR:', normalResult);
                    console.log('ğŸ“… é€šå¸¸OCRæœŸé™è§£æ:', parseDeadlineText(normalResult));
                    
                    // æœŸé™å°‚ç”¨OCR  
                    const deadlineResult = await performDeadlineOCR(croppedCanvas);
                    console.log('â° æœŸé™å°‚ç”¨OCR:', deadlineResult);
                    console.log('ğŸ“… æœŸé™å°‚ç”¨OCRæœŸé™è§£æ:', parseDeadlineText(deadlineResult));
                    
                    // æ‰‹æ›¸ãOCR
                    try {
                        const handwritingResult = await performHandwritingOCR(croppedCanvas);
                        console.log('âœï¸ æ‰‹æ›¸ãOCR:', handwritingResult.text, `(ä¿¡é ¼åº¦: ${handwritingResult.confidence}%)`);
                        console.log('ğŸ“… æ‰‹æ›¸ãOCRæœŸé™è§£æ:', parseDeadlineText(handwritingResult.text));
                    } catch (error) {
                        console.log('âœï¸ æ‰‹æ›¸ãOCRã‚¨ãƒ©ãƒ¼:', error.message);
                    }
                    
                    // 2. çµ¶å¯¾å‚ç…§å¤‰æ›ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ç¢ºèª
                    console.log('\nğŸ”„ çµ¶å¯¾å‚ç…§å¤‰æ›è©³ç´°:');
                    console.log('ç”ŸOCRçµæœ:', normalResult);
                    const convertedText = convertToAbsoluteReference(normalResult);
                    console.log('çµ¶å¯¾å‚ç…§å¤‰æ›å¾Œ:', convertedText);
                    const parseResult = parseDeadlineText(normalResult);
                    console.log('æœ€çµ‚è§£æçµæœ:', parseResult);
                    
                    // 3. ç”»åƒè§£æï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ»ãƒã‚¤ã‚ºçŠ¶æ³ï¼‰
                    console.log('\nğŸ–¼ï¸ ç”»åƒå“è³ªè§£æ:');
                    const imageStats = analyzeImageQuality(croppedCanvas);
                    console.log('ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ:', imageStats.contrast);
                    console.log('ãƒã‚¤ã‚ºãƒ¬ãƒ™ãƒ«:', imageStats.noise);
                    console.log('æ–‡å­—å¯†åº¦:', imageStats.textDensity);
                    
                    // 4. æ¨å¥¨æ”¹å–„æ–¹æ³•
                    console.log('\nğŸ’¡ æ¨å¥¨æ”¹å–„æ–¹æ³•:');
                    const recommendations = getDeadlineRecommendations(normalResult, deadlineResult, imageStats);
                    recommendations.forEach(rec => console.log(`- ${rec}`));
                    
                } catch (error) {
                    console.error('æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            console.log('\nğŸ”¬=== æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°çµ‚äº† ===');
            alert('æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãªè§£æçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ç”»åƒå“è³ªè§£æ
        function analyzeImageQuality(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let minBrightness = 255;
            let maxBrightness = 0;
            let totalBrightness = 0;
            let darkPixels = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                minBrightness = Math.min(minBrightness, brightness);
                maxBrightness = Math.max(maxBrightness, brightness);
                totalBrightness += brightness;
                
                if (brightness < 128) darkPixels++;
            }
            
            const totalPixels = data.length / 4;
            const avgBrightness = totalBrightness / totalPixels;
            const contrast = maxBrightness - minBrightness;
            const textDensity = darkPixels / totalPixels;
            
            // ãƒã‚¤ã‚ºãƒ¬ãƒ™ãƒ«æ¨å®šï¼ˆéš£æ¥ãƒ”ã‚¯ã‚»ãƒ«é–“ã®å·®åˆ†ï¼‰
            let noiseSum = 0;
            let noiseCount = 0;
            for (let y = 1; y < canvas.height - 1; y++) {
                for (let x = 1; x < canvas.width - 1; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    const current = data[idx];
                    const right = data[idx + 4];
                    const bottom = data[idx + canvas.width * 4];
                    
                    noiseSum += Math.abs(current - right) + Math.abs(current - bottom);
                    noiseCount += 2;
                }
            }
            const noise = noiseSum / noiseCount;
            
            return {
                contrast: contrast,
                noise: noise,
                textDensity: textDensity,
                avgBrightness: avgBrightness
            };
        }
        
        // ãƒ‡ãƒãƒƒã‚°çµæœã«åŸºã¥ãæ¨å¥¨äº‹é …
        function getDeadlineRecommendations(normalOCR, deadlineOCR, imageStats) {
            const recommendations = [];
            
            // OCRçµæœåˆ†æ
            if (!normalOCR || normalOCR.trim().length === 0) {
                recommendations.push('é€šå¸¸OCRã§æ–‡å­—ãŒèªè­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–ãƒ»æ‹¡å¤§å‡¦ç†ã‚’è©¦ã—ã¦ãã ã•ã„');
            }
            
            if (!deadlineOCR || deadlineOCR.trim().length === 0) {
                recommendations.push('æœŸé™å°‚ç”¨OCRã§ã‚‚èªè­˜å¤±æ•—ã€‚æ‰‹æ›¸ããƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’è©¦ã—ã¦ãã ã•ã„');
            }
            
            if (!parseDeadlineText(normalOCR) && !parseDeadlineText(deadlineOCR)) {
                recommendations.push('æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã—ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:');
                recommendations.push('  - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: mmæœˆddæ—¥(æ›œæ—¥), hh:mm');
                recommendations.push('  - å›²ã¿æ•°å­—: â‘ â‘¡â‘¢ â†’ 123 å¤‰æ›ãŒå¿…è¦ã‹');
                recommendations.push('  - ãƒã‚¤ã‚º: æ ç·šã‚„èƒŒæ™¯ãŒæ··å…¥ã—ã¦ã„ãªã„ã‹');
            }
            
            // ç”»åƒå“è³ªåˆ†æ
            if (imageStats.contrast < 100) {
                recommendations.push('ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãŒä½ã„ã§ã™ã€‚ã€Œã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–ã€è¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
            }
            
            if (imageStats.noise > 20) {
                recommendations.push('ãƒã‚¤ã‚ºãŒå¤šã„ã§ã™ã€‚ã€Œã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–ã€è¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
            }
            
            if (imageStats.textDensity < 0.1) {
                recommendations.push('æ–‡å­—å¯†åº¦ãŒä½ã„ã§ã™ã€‚é ˜åŸŸé¸æŠã‚’æ–‡å­—éƒ¨åˆ†ã®ã¿ã«çµã£ã¦ãã ã•ã„');
            }
            
            if (imageStats.textDensity > 0.8) {
                recommendations.push('èƒŒæ™¯ãŒæš—ã™ãã¾ã™ã€‚é ˜åŸŸé¸æŠæ™‚ã«ä½™ç™½ã‚‚å«ã‚ã¦ãã ã•ã„');
            }
            
            // å…·ä½“çš„ãªå¯¾å‡¦æ³•
            recommendations.push('ã€æ¨å¥¨é †åºã€‘');
            recommendations.push('1. é ˜åŸŸé¸æŠã‚’æœŸé™æ–‡å­—éƒ¨åˆ†ã®ã¿ã«èª¿æ•´');
            recommendations.push('2. æ‰‹æ›¸ãæ–‡å­—ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–');
            recommendations.push('3. ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ– + 2å€æ‹¡å¤§å‡¦ç†ã‚’æœ‰åŠ¹åŒ–');
            recommendations.push('4. ãã‚Œã§ã‚‚å¤±æ•—ã™ã‚‹å ´åˆã¯ç”»åƒè‡ªä½“ã®æ’®å½±ãƒ»åˆ‡ã‚Šå–ã‚Šã‚’è¦‹ç›´ã—');
            
            return recommendations;
        }
        
        // æœŸé™è§£æãƒ†ã‚¹ãƒˆ
        function testDeadlineParsing() {
            const testTexts = [
                // æ¨™æº–GoogleTODOãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                '12æœˆ15æ—¥(æœˆ), 14:30',
                '12æœˆ15æ—¥(æœˆ)',
                '12æœˆ15æ—¥, 14:30',
                '12æœˆ15æ—¥',
                
                // å›²ã¿æ•°å­—ãƒ†ã‚¹ãƒˆï¼ˆGoogleTODOç‰¹æœ‰ï¼‰
                'â‘¢æœˆâ‘¡â‘¤æ—¥(æœ¨), â‘ â‘£:â‘¢â“ª',
                'â‘ â‘¡æœˆâ‘¢â“ªæ—¥(é‡‘), â‘¡â‘¢:â‘¤â‘¨',
                'â‘«æœˆã‰›æ—¥(æ—¥), â“ªâ‘¨:â‘¢â“ª',
                
                // å…¨è§’æ•°å­—ãƒ†ã‚¹ãƒˆ
                'ï¼‘ï¼’æœˆï¼‘ï¼•æ—¥(æœˆ), ï¼‘ï¼”:ï¼“ï¼',
                'ï¼ï¼“æœˆï¼ï¼—æ—¥(æ°´)',
                
                // ãƒã‚¤ã‚ºæ··å…¥ãƒ†ã‚¹ãƒˆï¼ˆæ ç·šãƒ»è¨˜å·ï¼‰
                '|12æœˆ15æ—¥(æœˆ), 14:30|',
                'â–¡12æœˆ15æ—¥(æœˆ)â– ',
                'ï½12æœˆ15æ—¥(æœˆ), 14:30ï½',
                'ãƒã‚¤ã‚ºï½œ12æœˆ15æ—¥(æœˆ), 14:30ï½œãƒã‚¤ã‚º',
                
                // è¤‡é›‘ãªãƒã‚¤ã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³
                'ï½œâ–¡â‘¢æœˆâ‘¡â‘¤æ—¥(æœ¨)â– ï½, â‘ â‘£:â‘¢â“ªï½œ',
                'èªè­˜ã‚¨ãƒ©ãƒ¼ï¼‘ï¼’æœˆï¼‘ï¼•æ—¥(æœˆæ›œæ—¥), ï¼‘ï¼”:ï¼“ï¼èª¤èªè­˜',
                
                // ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
                '14:30', // æ™‚åˆ»ã®ã¿
                'ç„¡åŠ¹ãªæœŸé™ãƒ†ã‚­ã‚¹ãƒˆ',
                ''
            ];
            
            console.log('=== GoogleTODOæœŸé™è§£æãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            testTexts.forEach((text, index) => {
                console.log(`\nğŸ“ ãƒ†ã‚¹ãƒˆ ${index + 1}: "${text}"`);
                
                // çµ¶å¯¾å‚ç…§å¤‰æ›ã®ãƒ†ã‚¹ãƒˆ
                const converted = convertToAbsoluteReference(text);
                console.log(`ğŸ”„ çµ¶å¯¾å‚ç…§å¤‰æ›: "${converted}"`);
                
                // æœŸé™è§£æã®ãƒ†ã‚¹ãƒˆ
                const result = parseDeadlineText(text);
                console.log(`ğŸ“… è§£æçµæœ: ${result}`);
                console.log(`âœ… æˆåŠŸ: ${result ? 'â—‹' : 'Ã—'}`);
            });
            console.log('=== GoogleTODOæœŸé™è§£æãƒ†ã‚¹ãƒˆçµ‚äº† ===');
            
            alert('æœŸé™è§£æãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ç›´æ¥OCRãƒ†ã‚¹ãƒˆï¼ˆé¸æŠã—ãŸæœŸé™é ˜åŸŸã§ï¼‰
        async function testOCRDirectly() {
            const deadlineAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (deadlineAreas.length === 0) {
                alert('æœŸé™ã‚¿ã‚°ãŒè¨­å®šã•ã‚ŒãŸé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            console.log('=== æœŸé™é ˜åŸŸOCRãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            for (let i = 0; i < deadlineAreas.length; i++) {
                const area = deadlineAreas[i];
                console.log(`\næœŸé™é ˜åŸŸ ${i + 1} ãƒ†ã‚¹ãƒˆ:`);
                
                // é ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                const croppedCanvas = document.createElement('canvas');
                const croppedCtx = croppedCanvas.getContext('2d');
                
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                croppedCtx.drawImage(
                    currentImage,
                    area.x, area.y, area.width, area.height,
                    0, 0, area.width, area.height
                );
                
                try {
                    // æœŸé™ç”¨OCR
                    const deadlineText = await performDeadlineOCR(croppedCanvas);
                    console.log('æœŸé™ç”¨OCRçµæœ:', deadlineText);
                    console.log('æœŸé™è§£æçµæœ:', parseDeadlineText(deadlineText));
                    
                    // é€šå¸¸OCR
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('é€šå¸¸OCRçµæœ:', normalText);
                    console.log('æœŸé™è§£æçµæœ:', parseDeadlineText(normalText));
                } catch (error) {
                    console.error('OCRã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            console.log('\n=== æœŸé™é ˜åŸŸOCRãƒ†ã‚¹ãƒˆçµ‚äº† ===');
            alert('æœŸé™é ˜åŸŸã®OCRãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // å‡¦ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€åˆã®é¸æŠé ˜åŸŸã§ãƒ†ã‚¹ãƒˆï¼‰
        function previewProcessing() {
            if (selectedAreas.length === 0) {
                alert('é¸æŠé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšé ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const area = selectedAreas[0];
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            
            croppedCanvas.width = area.width;
            croppedCanvas.height = area.height;
            
            croppedCtx.imageSmoothingEnabled = false;
            croppedCtx.drawImage(
                currentImage,
                area.x, area.y, area.width, area.height,
                0, 0, area.width, area.height
            );
            
            // å‰å‡¦ç†ã‚’é©ç”¨
            preprocessImage(croppedCanvas).then(processedCanvas => {
                // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§è¡¨ç¤º
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head><title>OCRå‰å‡¦ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title></head>
                        <body style="margin: 20px; font-family: Arial, sans-serif;">
                            <h3>å…ƒç”»åƒ vs å‡¦ç†å¾Œ</h3>
                            <div style="display: flex; gap: 20px;">
                                <div>
                                    <h4>å…ƒç”»åƒ</h4>
                                    <canvas id="original" style="border: 1px solid #ccc;"></canvas>
                                </div>
                                <div>
                                    <h4>å‡¦ç†å¾Œ</h4>
                                    <canvas id="processed" style="border: 1px solid #ccc;"></canvas>
                                </div>
                            </div>
                        </body>
                    </html>
                `);
                
                const originalCanvas = newWindow.document.getElementById('original');
                const processedCanvasElement = newWindow.document.getElementById('processed');
                
                // å…ƒç”»åƒã‚’è¡¨ç¤º
                originalCanvas.width = croppedCanvas.width;
                originalCanvas.height = croppedCanvas.height;
                const originalCtx = originalCanvas.getContext('2d');
                originalCtx.drawImage(croppedCanvas, 0, 0);
                
                // å‡¦ç†å¾Œã‚’è¡¨ç¤º
                processedCanvasElement.width = processedCanvas.width;
                processedCanvasElement.height = processedCanvas.height;
                const processedCtx = processedCanvasElement.getContext('2d');
                processedCtx.drawImage(processedCanvas, 0, 0);
            });
        }
        
        // åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function showAnalytics() {
            const modal = document.getElementById('analyticsModal');
            modal.style.display = 'block';
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šé€±ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—
            calculateAnalytics('week');
            
            // ã‚°ãƒ©ãƒ•ã‚’æç”»
            drawCompletionChart();
            drawDeadlineChart();
            
            // æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
            displayAssigneePerformance();
        }
        
        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }
        
        // æœŸé–“é¸æŠãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        function showAnalyticsForPeriod(period) {
            // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('#analyticsModal .period-btn').forEach(btn => {
                btn.style.background = '#e2e8f0';
                btn.style.color = '#333';
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒœã‚¿ãƒ³ã«activeã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            event.target.style.background = '#0052cc';
            event.target.style.color = 'white';
            
            // æœŸé–“ã«å¿œã˜ã¦åˆ†æã‚’å†è¨ˆç®—
            calculateAnalytics(period);
        }
        
        function calculateAnalytics(period = 'all') {
            // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            let filteredTasks = tasks;
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            if (period === 'today') {
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfToday;
                    }
                    return false;
                });
            } else if (period === 'week') {
                const startOfWeek = new Date(startOfToday);
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfWeek;
                    }
                    return false;
                });
            } else if (period === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfMonth;
                    }
                    return false;
                });
            }
            
            // ç·ã‚¿ã‚¹ã‚¯æ•°
            const totalTasks = filteredTasks.length;
            document.getElementById('total-tasks').textContent = totalTasks;
            
            // å®Œäº†ã‚¿ã‚¹ã‚¯æ•°ã¨å®Œäº†ç‡
            const completedTasks = filteredTasks.filter(task => task.columnId === 'done').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('completion-rate').textContent = completionRate + '%';
            
            // æœŸé™éµå®ˆç‡ã‚’è¨ˆç®—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã®ã†ã¡ã€æœŸé™å†…ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®å‰²åˆï¼‰
            const completedOnTime = filteredTasks.filter(task => {
                if (task.columnId === 'done' && task.deadline && task.completedAt) {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }
                return false;
            }).length;
            
            const deadlineCompliance = totalTasks > 0 
                ? Math.round((completedOnTime / totalTasks) * 100) 
                : 100;
                
            console.log(`ğŸ“Š [COMPLIANCE] Period: ${period}, Total tasks: ${totalTasks}`);
            console.log(`ğŸ“Š [COMPLIANCE] Completed on time: ${completedOnTime}`);
            console.log(`ğŸ“Š [COMPLIANCE] Compliance rate: ${deadlineCompliance}%`);
            
            document.getElementById('deadline-compliance').textContent = deadlineCompliance + '%';
            
            // å¹³å‡å®Œäº†æ™‚é–“ã‚’è¨ˆç®—
            const completedWithTime = tasks.filter(task => 
                task.columnId === 'done' && task.createdAt && task.completedAt
            );
            
            if (completedWithTime.length > 0) {
                const totalTime = completedWithTime.reduce((sum, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created);
                }, 0);
                
                const avgTime = totalTime / completedWithTime.length;
                const days = Math.floor(avgTime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((avgTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                document.getElementById('avg-completion-time').textContent = 
                    days > 0 ? `${days}æ—¥${hours}æ™‚é–“` : `${hours}æ™‚é–“`;
            } else {
                document.getElementById('avg-completion-time').textContent = '-';
            }
        }
        
        function drawCompletionChart() {
            const chartContainer = document.getElementById('completion-chart');
            
            // ã‚«ãƒ©ãƒ åˆ¥ã‚¿ã‚¹ã‚¯æ•°ã‚’é›†è¨ˆ
            const columnCounts = {};
            columns.forEach(column => {
                columnCounts[column.id] = tasks.filter(task => task.columnId === column.id).length;
            });
            
            // æœ€å¤§å€¤ã‚’æ±‚ã‚ã‚‹
            const maxCount = Math.max(...Object.values(columnCounts), 1);
            
            // æ£’ã‚°ãƒ©ãƒ•ã‚’HTMLã§ä½œæˆ
            let chartHTML = '<div style="display: flex; height: 100%; align-items: flex-end; justify-content: space-around; padding: 1rem;">';
            
            columns.forEach(column => {
                const count = columnCounts[column.id];
                const percentage = (count / maxCount) * 100;
                
                chartHTML += `
                    <div style="flex: 1; text-align: center; margin: 0 0.5rem;">
                        <div style="position: relative; height: 150px; display: flex; align-items: flex-end;">
                            <div style="background: ${column.color}; width: 100%; height: ${percentage}%; border-radius: 4px 4px 0 0; position: relative;">
                                <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-weight: bold; color: #333;">
                                    ${count}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            ${column.title.replace(/[^\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\w\s]/g, '')}
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        function drawDeadlineChart() {
            const chartContainer = document.getElementById('deadline-chart');
            
            // æœŸé™çŠ¶æ³ã‚’é›†è¨ˆï¼ˆDoneã‚«ãƒ©ãƒ ã‚’é™¤ãï¼‰
            const activeTasks = tasks.filter(task => task.columnId !== 'done');
            const now = new Date();
            
            const deadlineStatus = {
                overdue: 0,
                today: 0,
                thisWeek: 0,
                later: 0,
                noDeadline: 0
            };
            
            activeTasks.forEach(task => {
                if (!task.deadline) {
                    deadlineStatus.noDeadline++;
                    return;
                }
                
                const deadline = new Date(task.deadline);
                const daysUntil = Math.floor((deadline - now) / (1000 * 60 * 60 * 24));
                
                if (deadline < now) {
                    deadlineStatus.overdue++;
                } else if (daysUntil === 0) {
                    deadlineStatus.today++;
                } else if (daysUntil <= 7) {
                    deadlineStatus.thisWeek++;
                } else {
                    deadlineStatus.later++;
                }
            });
            
            // å††ã‚°ãƒ©ãƒ•é¢¨ã®è¡¨ç¤ºã‚’ä½œæˆ
            const total = activeTasks.length || 1;
            const statusConfig = [
                { key: 'overdue', label: 'æœŸé™åˆ‡ã‚Œ', color: '#e53e3e' },
                { key: 'today', label: 'ä»Šæ—¥', color: '#d69e2e' },
                { key: 'thisWeek', label: 'ä»Šé€±', color: '#3182ce' },
                { key: 'later', label: 'ãã‚Œä»¥é™', color: '#38a169' },
                { key: 'noDeadline', label: 'æœŸé™ãªã—', color: '#a0aec0' }
            ];
            
            let chartHTML = '<div style="display: flex; flex-direction: column; height: 100%; padding: 1rem;">';
            
            statusConfig.forEach(config => {
                const count = deadlineStatus[config.key];
                const percentage = Math.round((count / total) * 100);
                
                if (count > 0) {
                    chartHTML += `
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.9rem; color: #666;">${config.label}</span>
                                <span style="font-size: 0.9rem; font-weight: bold;">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: ${config.color}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        function displayAssigneePerformance() {
            const performanceContainer = document.getElementById('assignee-performance');
            
            // æ‹…å½“è€…åˆ¥ã®çµ±è¨ˆã‚’é›†è¨ˆ
            const assigneeStats = {};
            
            assignees.forEach(assignee => {
                const assigneeTasks = tasks.filter(task => task.assignee === assignee);
                const completed = assigneeTasks.filter(task => task.columnId === 'done').length;
                const total = assigneeTasks.length;
                
                // æœŸé™éµå®ˆç‡
                const completedWithDeadline = assigneeTasks.filter(task => 
                    task.columnId === 'done' && task.deadline && task.completedAt
                );
                const onTime = completedWithDeadline.filter(task => {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }).length;
                
                assigneeStats[assignee] = {
                    total: total,
                    completed: completed,
                    completionRate: total > 0 ? Math.round((completed / total) * 100) : 0,
                    onTimeRate: completedWithDeadline.length > 0 
                        ? Math.round((onTime / completedWithDeadline.length) * 100) 
                        : 100
                };
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 0.75rem; text-align: left;">æ‹…å½“è€…</th>
                            <th style="padding: 0.75rem; text-align: center;">ç·ã‚¿ã‚¹ã‚¯</th>
                            <th style="padding: 0.75rem; text-align: center;">å®Œäº†</th>
                            <th style="padding: 0.75rem; text-align: center;">å®Œäº†ç‡</th>
                            <th style="padding: 0.75rem; text-align: center;">æœŸé™éµå®ˆç‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(assigneeStats).forEach(([assignee, stats]) => {
                if (stats.total > 0) {
                    tableHTML += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 0.75rem; font-weight: 500;">${assignee}</td>
                            <td style="padding: 0.75rem; text-align: center;">${stats.total}</td>
                            <td style="padding: 0.75rem; text-align: center;">${stats.completed}</td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span style="color: ${stats.completionRate >= 80 ? '#38a169' : stats.completionRate >= 50 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${stats.completionRate}%
                                </span>
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span style="color: ${stats.onTimeRate >= 90 ? '#38a169' : stats.onTimeRate >= 70 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${stats.onTimeRate}%
                                </span>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            performanceContainer.innerHTML = tableHTML;
        }
        
        // åˆ†æã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateAnalyticsSummary() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.columnId === 'done').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // æœŸé™éµå®ˆç‡ï¼ˆå…¨ã‚¿ã‚¹ã‚¯ã®ã†ã¡æœŸé™å†…ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®å‰²åˆï¼‰
            const completedOnTime = tasks.filter(task => {
                if (task.columnId === 'done' && task.deadline && task.completedAt) {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }
                return false;
            }).length;
            
            const deadlineCompliance = totalTasks > 0 
                ? Math.round((completedOnTime / totalTasks) * 100) 
                : 100;
            
            // å¹³å‡å®Œäº†æ™‚é–“
            const completedWithTime = tasks.filter(task => 
                task.columnId === 'done' && task.createdAt && task.completedAt
            );
            let avgTimeText = '-';
            if (completedWithTime.length > 0) {
                const totalTime = completedWithTime.reduce((sum, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created);
                }, 0);
                const avgTime = totalTime / completedWithTime.length;
                const days = Math.floor(avgTime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((avgTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                avgTimeText = days > 0 ? `${days}æ—¥${hours}h` : `${hours}h`;
            }
            
            // è¡¨ç¤ºæ›´æ–°
            document.getElementById('summary-completion-rate').textContent = completionRate + '%';
            document.getElementById('summary-deadline-compliance').textContent = deadlineCompliance + '%';
            document.getElementById('summary-avg-time').textContent = avgTimeText;
        }
        
        // æœŸé–“ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function showPeriodReport(period) {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã®æ›´æ–°
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const now = new Date();
            let startDate, endDate, periodName;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    periodName = 'ä»Šæ—¥';
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    startDate = weekStart;
                    endDate = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
                    periodName = 'ä»Šé€±';
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    periodName = 'ä»Šæœˆ';
                    break;
            }
            
            // æœŸé–“å†…ã®ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡º
            const periodTasks = tasks.filter(task => {
                if (!task.createdAt) return false;
                const createdDate = new Date(task.createdAt);
                return createdDate >= startDate && createdDate < endDate;
            });
            
            const completedInPeriod = periodTasks.filter(task => {
                if (task.columnId !== 'done' || !task.completedAt) return false;
                const completedDate = new Date(task.completedAt);
                return completedDate >= startDate && completedDate < endDate;
            });
            
            // æœŸé™éµå®ˆï¼ˆæœŸé–“å†…ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®ã†ã¡ï¼‰
            const onTimeInPeriod = completedInPeriod.filter(task => {
                if (!task.deadline) return true;
                const deadline = new Date(task.deadline);
                const completed = new Date(task.completedAt);
                return completed <= deadline;
            });
            
            // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
            const modalId = 'period-report-' + Date.now();
            const reportHTML = `
                <div id="${modalId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) document.getElementById('${modalId}').remove()">
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748;">ğŸ“Š ${periodName}ã®ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                            <button onclick="document.getElementById('${modalId}').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #a0aec0; padding: 0.5rem; z-index: 2001; position: relative;">&times;</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${periodTasks.length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">ä½œæˆã‚¿ã‚¹ã‚¯</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${completedInPeriod.length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">å®Œäº†ã‚¿ã‚¹ã‚¯</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); color: #2d3748; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${periodTasks.length > 0 ? Math.round((completedInPeriod.length / periodTasks.length) * 100) : 0}%</div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">å®Œäº†ç‡</div>
                            </div>
                        </div>
                        
                        <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #2d3748;">æœŸé™éµå®ˆçŠ¶æ³</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>æœŸé™å†…å®Œäº†: ${onTimeInPeriod.length}ä»¶</span>
                                <span>éµå®ˆç‡: ${completedInPeriod.length > 0 ? Math.round((onTimeInPeriod.length / completedInPeriod.length) * 100) : 100}%</span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                                <div style="background: #38a169; height: 100%; width: ${completedInPeriod.length > 0 ? (onTimeInPeriod.length / completedInPeriod.length) * 100 : 100}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; color: #718096; font-size: 0.9rem;">
                            æœŸé–“: ${startDate.toLocaleDateString()} ã€œ ${endDate.toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reportHTML);
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†æ©Ÿèƒ½
        function showCreateTemplateModal() {
            // ã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
            const columnSelect = document.getElementById('template-column');
            if (columnSelect) {
                columnSelect.innerHTML = '';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    columnSelect.appendChild(option);
                });
            }
            
            // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const assigneesContainer = document.getElementById('template-assignees');
            assigneesContainer.innerHTML = '';
            assignees.forEach(assignee => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.9rem;';
                label.innerHTML = `
                    <input type="checkbox" value="${assignee}" style="margin: 0;">
                    <span>${assignee}</span>
                `;
                assigneesContainer.appendChild(label);
            });
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const templateModal = document.getElementById('templateModal');
            templateModal.style.display = 'flex';
        }
        
        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('template-name').value = '';
            document.getElementById('template-task-title').value = '';
            document.getElementById('template-memo').value = '';
            document.getElementById('template-category').value = 'å–¶æ¥­';
            document.getElementById('template-priority').value = 'medium';
            
            // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const checkboxes = document.querySelectorAll('#template-assignees input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('template-modal-title').textContent = 'ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ';
            document.getElementById('save-template-btn').textContent = 'ä¿å­˜';
            editingTemplateId = null;
        }
        
        async function saveTemplate(event) {
            event.preventDefault();
            
            const name = document.getElementById('template-name').value.trim();
            const category = document.getElementById('template-category').value;
            const taskTitle = document.getElementById('template-task-title').value.trim();
            const priority = document.getElementById('template-priority').value;
            const columnId = document.getElementById('template-column').value;
            const memo = document.getElementById('template-memo').value.trim();
            
            // é¸æŠã•ã‚ŒãŸæ‹…å½“è€…ã‚’å–å¾—
            const selectedAssignees = Array.from(document.querySelectorAll('#template-assignees input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (!name || !taskTitle) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã¨ã‚¿ã‚¹ã‚¯åã¯å¿…é ˆã§ã™');
                return;
            }
            
            try {
                if (editingTemplateId) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ - Firebaseçµ±åˆ
                    const templateData = {
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo
                    };
                    
                    // Firebaseæ›´æ–°
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('ğŸ”¥ [TEMPLATE] Firebaseãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ä¸­...', name);
                        const result = await window.FirebaseDB.updateTemplate(editingTemplateId, templateData);
                        
                        if (result.success) {
                            console.log('âœ… [FIREBASE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°æˆåŠŸ:', editingTemplateId);
                            
                            // ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã‚‚æ›´æ–°
                            const templateIndex = taskTemplates.findIndex(t => t.id === editingTemplateId);
                            if (templateIndex !== -1) {
                                taskTemplates[templateIndex] = {
                                    ...taskTemplates[templateIndex],
                                    ...templateData,
                                    updatedAt: new Date().toISOString()
                                };
                            }
                            alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                        } else {
                            console.error('âŒ [FIREBASE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', result.error);
                            alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        const templateIndex = taskTemplates.findIndex(t => t.id === editingTemplateId);
                        if (templateIndex !== -1) {
                            taskTemplates[templateIndex] = {
                                ...taskTemplates[templateIndex],
                                ...templateData,
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                            alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ï¼ˆLocalStorageï¼‰');
                        }
                    }
                } else {
                    // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ - Firebaseçµ±åˆ
                    const templateData = {
                        id: Date.now(),
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Firebaseä½œæˆ
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('ğŸ”¥ [TEMPLATE] Firebaseãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆä¸­...', name);
                        const result = await window.FirebaseDB.createTemplate(templateData);
                        
                        if (result.success) {
                            console.log('âœ… [FIREBASE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆæˆåŠŸ:', result.id);
                            
                            // Firebase IDã‚’è¨­å®šã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã«è¿½åŠ 
                            templateData.id = result.id;
                            taskTemplates.push(templateData);
                            alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                        } else {
                            console.error('âŒ [FIREBASE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', result.error);
                            alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        taskTemplates.push(templateData);
                        localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                        alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆLocalStorageï¼‰');
                    }
                }
                
                // LocalStorageã«ã‚‚ä¿å­˜ï¼ˆåŒæœŸç”¨ï¼‰
                localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’æ›´æ–°
                loadTemplateList();
                
                closeTemplateModal();
                
            } catch (error) {
                console.error('âŒ [TEMPLATE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        function loadTemplateList() {
            const container = document.getElementById('template-list');
            
            // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆåˆ¥ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»é¢ãªã©ï¼‰
            if (!container) {
                // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã„å ´åˆã¯æ­£å¸¸ - è­¦å‘Šãªã—ã§ã‚¹ã‚­ãƒƒãƒ—
                return;
            }
            
            if (taskTemplates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                if (!groupedTemplates[template.category]) {
                    groupedTemplates[template.category] = [];
                }
                groupedTemplates[template.category].push(template);
            });
            
            let html = '';
            Object.keys(groupedTemplates).forEach(category => {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e9ecef; padding-bottom: 0.25rem;">${category}</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem;">
                `;
                
                groupedTemplates[category].forEach(template => {
                    html += `
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; width: 220px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <h6 style="margin: 0; font-size: 1rem; font-weight: 600; color: #172b4d; line-height: 1.2;">${template.name}</h6>
                                <div style="display: flex; gap: 0.25rem;">
                                    <button onclick="editTemplate(${template.id})" style="background: none; border: none; color: #6c757d; cursor: pointer; font-size: 0.9rem; padding: 0.2rem;" title="ç·¨é›†">âœï¸</button>
                                    <button onclick="deleteTemplate(${template.id})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1rem; padding: 0.2rem;" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.75rem; line-height: 1.3;">${template.taskTitle}</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0.75rem;">
                                <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">${template.priority === 'high' ? 'ğŸ”´ æœ€é‡è¦' : template.priority === 'medium' ? 'ğŸŸ¡ é‡è¦' : 'ğŸŸ¢ é€šå¸¸'}</span>
                                <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">${columns.find(c => c.id === template.columnId)?.title || template.columnId}</span>
                            </div>
                            <button onclick="applyTemplate(${template.id})" style="width: 100%; padding: 0.6rem; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                âš¡ é©ç”¨
                            </button>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }
        
        function editTemplate(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            editingTemplateId = templateId;
            document.getElementById('template-modal-title').textContent = 'âœï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†';
            document.getElementById('save-template-btn').textContent = 'æ›´æ–°';
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            showCreateTemplateModal();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å€¤ã‚’è¨­å®š
            setTimeout(() => {
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-category').value = template.category;
                document.getElementById('template-task-title').value = template.taskTitle;
                document.getElementById('template-priority').value = template.priority;
                document.getElementById('template-column').value = template.columnId;
                document.getElementById('template-memo').value = template.memo || '';
                
                // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
                const checkboxes = document.querySelectorAll('#template-assignees input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = template.assignees && template.assignees.includes(cb.value);
                });
            }, 100);
        }
        
        function deleteTemplate(templateId) {
            if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            taskTemplates = taskTemplates.filter(t => t.id !== templateId);
            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
            loadTemplateList();
        }
        
        function applyTemplate(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å€¤ã‚’é©ç”¨
            createTaskUnified();
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å€¤ã‚’è¨­å®š
            setTimeout(() => {
                document.getElementById('task-title-input').value = template.taskTitle;
                document.getElementById('task-priority-input').value = template.priority;
                document.getElementById('task-column-input').value = template.columnId;
                document.getElementById('task-memo-input').value = template.memo || '';
                
                // æ‹…å½“è€…ã‚’è¨­å®š
                if (template.assignees && template.assignees.length > 0) {
                    setSelectedAssignees(template.assignees);
                }
            }, 100);
            
            // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeSettingsModal();
        }
        
        // ============ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°ç¾¤ ============
        let currentEditingTemplateId = null;
        
        function openTemplateManagementModal() {
            document.getElementById('templateManagementModal').style.display = 'flex';
            loadTemplateManagementList();
            showTemplateWelcomeScreen();
        }
        
        function closeTemplateManagementModal() {
            document.getElementById('templateManagementModal').style.display = 'none';
            currentEditingTemplateId = null;
            showTemplateWelcomeScreen();
        }
        
        function showTemplateWelcomeScreen() {
            document.getElementById('template-welcome-screen').style.display = 'flex';
            document.getElementById('template-form-container').style.display = 'none';
            currentEditingTemplateId = null;
        }
        
        function showTemplateCreateForm() {
            document.getElementById('template-welcome-screen').style.display = 'none';
            document.getElementById('template-form-container').style.display = 'flex';
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('template-management-form').reset();
            document.getElementById('mgmt-save-template-btn').textContent = 'ğŸ’¾ ä¿å­˜';
            document.getElementById('mgmt-delete-template-btn').style.display = 'none';
            currentEditingTemplateId = null;
            
            // ã‚«ãƒ©ãƒ ã¨æ‹…å½“è€…ã‚’æ›´æ–°
            updateTemplateManagementFormOptions();
        }
        
        function loadTemplateManagementList() {
            const container = document.getElementById('template-management-list');
            
            if (taskTemplates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“</div>
                        <p>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">ã€Œæ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã€ã§<br>æœ€åˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
                    </div>
                `;
                return;
            }
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                const category = template.category || 'ãã®ä»–';
                if (!groupedTemplates[category]) {
                    groupedTemplates[category] = [];
                }
                groupedTemplates[category].push(template);
            });
            
            let html = '';
            Object.keys(groupedTemplates).forEach(category => {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #374151; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">${category}</h5>
                `;
                
                groupedTemplates[category].forEach(template => {
                    const isSelected = currentEditingTemplateId === template.id;
                    html += `
                        <div onclick="selectTemplateInManagement(${template.id})" 
                             style="background: ${isSelected ? '#eff6ff' : 'white'}; 
                                    border: 1px solid ${isSelected ? '#3b82f6' : '#e5e7eb'}; 
                                    border-radius: 8px; 
                                    padding: 0.75rem; 
                                    margin-bottom: 0.5rem; 
                                    cursor: pointer; 
                                    transition: all 0.2s;"
                             onmouseover="if(!${isSelected}) { this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'; }"
                             onmouseout="if(!${isSelected}) { this.style.background='white'; this.style.borderColor='#e5e7eb'; }">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${template.name}</div>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">${template.taskTitle}</div>
                            <div style="display: flex; gap: 0.25rem;">
                                <span style="background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 12px; font-size: 0.7rem; color: #374151;">
                                    ${template.priority === 'high' ? 'ğŸ”´' : template.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢'} ${template.priority === 'high' ? 'æœ€é‡è¦' : template.priority === 'medium' ? 'é‡è¦' : 'é€šå¸¸'}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function selectTemplateInManagement(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            currentEditingTemplateId = templateId;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            document.getElementById('template-welcome-screen').style.display = 'none';
            document.getElementById('template-form-container').style.display = 'flex';
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('mgmt-template-name').value = template.name;
            document.getElementById('mgmt-template-category').value = template.category;
            document.getElementById('mgmt-template-task-title').value = template.taskTitle;
            document.getElementById('mgmt-template-priority').value = template.priority;
            document.getElementById('mgmt-template-column').value = template.columnId;
            document.getElementById('mgmt-template-memo').value = template.memo || '';
            
            // ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            document.getElementById('mgmt-save-template-btn').textContent = 'ğŸ’¾ æ›´æ–°';
            document.getElementById('mgmt-delete-template-btn').style.display = 'block';
            
            // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            updateTemplateManagementFormOptions();
            setTimeout(() => {
                const checkboxes = document.querySelectorAll('#mgmt-template-assignees input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = template.assignees && template.assignees.includes(cb.value);
                });
            }, 100);
            
            // ä¸€è¦§ã‚’æ›´æ–°ï¼ˆé¸æŠçŠ¶æ…‹ã‚’åæ˜ ï¼‰
            loadTemplateManagementList();
        }
        
        function updateTemplateManagementFormOptions() {
            // ã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
            const columnSelect = document.getElementById('mgmt-template-column');
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const assigneesContainer = document.getElementById('mgmt-template-assignees');
            assigneesContainer.innerHTML = '';
            assignees.forEach(assignee => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.5rem; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-size: 0.9rem;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = assignee;
                checkbox.name = 'mgmt-assignees';
                
                const span = document.createElement('span');
                span.textContent = assignee;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                assigneesContainer.appendChild(label);
                
                // ãƒ›ãƒãƒ¼åŠ¹æœ
                label.addEventListener('mouseenter', () => {
                    label.style.background = '#f3f4f6';
                });
                label.addEventListener('mouseleave', () => {
                    label.style.background = 'white';
                });
            });
        }
        
        async function saveTemplateFromManagement(event) {
            event.preventDefault();
            
            const name = document.getElementById('mgmt-template-name').value.trim();
            const category = document.getElementById('mgmt-template-category').value;
            const taskTitle = document.getElementById('mgmt-template-task-title').value.trim();
            const priority = document.getElementById('mgmt-template-priority').value;
            const columnId = document.getElementById('mgmt-template-column').value;
            const memo = document.getElementById('mgmt-template-memo').value.trim();
            
            // é¸æŠã•ã‚ŒãŸæ‹…å½“è€…ã‚’å–å¾—
            const selectedAssignees = Array.from(document.querySelectorAll('#mgmt-template-assignees input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (!name || !taskTitle) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã¨ã‚¿ã‚¹ã‚¯åã¯å¿…é ˆã§ã™');
                return;
            }
            
            try {
                if (currentEditingTemplateId) {
                    // æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ - Firebaseçµ±åˆ
                    const templateData = {
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo
                    };
                    
                    // Firebaseæ›´æ–°
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('ğŸ”¥ [TEMPLATE-MGMT] Firebaseãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ä¸­...', name);
                        const result = await window.FirebaseDB.updateTemplate(currentEditingTemplateId, templateData);
                        
                        if (result.success) {
                            console.log('âœ… [FIREBASE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°æˆåŠŸ:', currentEditingTemplateId);
                            
                            // ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã‚‚æ›´æ–°
                            const index = taskTemplates.findIndex(t => t.id === currentEditingTemplateId);
                            if (index !== -1) {
                                taskTemplates[index] = {
                                    ...taskTemplates[index],
                                    ...templateData,
                                    updatedAt: new Date().toISOString()
                                };
                            }
                            alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                        } else {
                            console.error('âŒ [FIREBASE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', result.error);
                            alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        const index = taskTemplates.findIndex(t => t.id === currentEditingTemplateId);
                        if (index !== -1) {
                            taskTemplates[index] = {
                                ...taskTemplates[index],
                                ...templateData,
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                            alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ï¼ˆLocalStorageï¼‰');
                        }
                    }
                } else {
                    // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ - Firebaseçµ±åˆ
                    const templateData = {
                        id: Date.now(),
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Firebaseä½œæˆ
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('ğŸ”¥ [TEMPLATE-MGMT] Firebaseãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆä¸­...', name);
                        const result = await window.FirebaseDB.createTemplate(templateData);
                        
                        if (result.success) {
                            console.log('âœ… [FIREBASE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆæˆåŠŸ:', result.id);
                            
                            // Firebase IDã‚’è¨­å®šã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã«è¿½åŠ 
                            templateData.id = result.id;
                            taskTemplates.push(templateData);
                            alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼');
                        } else {
                            console.error('âŒ [FIREBASE] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', result.error);
                            alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        taskTemplates.push(templateData);
                        localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                        alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼ï¼ˆLocalStorageï¼‰');
                    }
                }
                
                // LocalStorageã«ã‚‚ä¿å­˜ï¼ˆåŒæœŸç”¨ï¼‰
                localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                
                // ä¸€è¦§ã‚’æ›´æ–°
                loadTemplateManagementList();
                if (window.loadTemplateList) {
                    loadTemplateList(); // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸€è¦§ã‚‚æ›´æ–°ï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
                }
                
            } catch (error) {
                console.error('âŒ [TEMPLATE-MGMT] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
            
            // ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã«æˆ»ã‚‹
            showTemplateWelcomeScreen();
        }
        
        function cancelTemplateForm() {
            showTemplateWelcomeScreen();
        }
        
        function deleteCurrentTemplate() {
            if (!currentEditingTemplateId) return;
            
            const template = taskTemplates.find(t => t.id === currentEditingTemplateId);
            if (!template) return;
            
            if (!confirm(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            taskTemplates = taskTemplates.filter(t => t.id !== currentEditingTemplateId);
            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
            
            // ä¸€è¦§ã‚’æ›´æ–°
            loadTemplateManagementList();
            loadTemplateList(); // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸€è¦§ã‚‚æ›´æ–°
            
            // ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã«æˆ»ã‚‹
            showTemplateWelcomeScreen();
            
            alert('ğŸ—‘ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
        
        // ============ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°ç¾¤ çµ‚äº† ============
        
        // ============ ã‚¿ã‚¹ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°ç¾¤ ============
        let previewTasksModal = [];
        
        function openTaskImportModal() {
            document.getElementById('taskImportModal').style.display = 'flex';
            hidePreviewModal();
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('import-text-modal').value = '';
            document.getElementById('ocr-file-input-modal').value = '';
        }
        
        function closeTaskImportModal() {
            document.getElementById('taskImportModal').style.display = 'none';
            hidePreviewModal();
            previewTasksModal = [];
        }
        
        function processImportText(showPreview) {
            const importText = document.getElementById('import-text-modal').value.trim();
            if (!importText) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // å…ƒã® previewImport æ©Ÿèƒ½ã‚’å¾©å…ƒ
            const currentUser = getCurrentUser();
            const defaultAssignee = currentUser ? currentUser.name : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            const defaultDeadline = new Date().toISOString().split('T')[0];
            const defaultPriority = 'medium';
            const defaultColumn = 'todo';
            
            const lines = importText.split('\n');
            previewTasksModal = [];
            let lastMainTaskIndex = -1;
            
            lines.forEach((line, index) => {
                if (!line.trim()) return;
                
                const trimmedLine = line.trim();
                let taskText = trimmedLine;
                
                // æ•°å­—è¨˜å·ã®ä¿®æ­£ï¼ˆå…ƒã®æ©Ÿèƒ½ï¼‰
                taskText = taskText
                    .replace(/â‘ /g, '1').replace(/â‘¡/g, '2').replace(/â‘¢/g, '3').replace(/â‘£/g, '4').replace(/â‘¤/g, '5')
                    .replace(/â‘¥/g, '6').replace(/â‘¦/g, '7').replace(/â‘§/g, '8').replace(/â‘¨/g, '9').replace(/â‘©/g, '10')
                    .replace(/â—‹/g, '0').replace(/â—/g, '1');
                
                // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆåˆ¤å®šï¼ˆåŠè§’ã‚¹ãƒšãƒ¼ã‚¹2å€‹ãƒ»å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹1å€‹ãƒ»ã‚¿ãƒ–ï¼‰
                const hasIndent = line.match(/^(\s{2,}|ã€€|\t+)/);
                const isMainTask = !hasIndent;
                
                // æ‹…å½“è€…æŠ½å‡º
                const assigneeMatch = taskText.match(/@([^\s@]+)/g);
                let assignee = defaultAssignee;
                if (assigneeMatch && assigneeMatch.length > 0) {
                    assignee = assigneeMatch[0].replace('@', '');
                    taskText = taskText.replace(/@[^\s@]+/g, '').trim();
                }
                
                // æ—¥ä»˜æŠ½å‡º
                const dateMatches = taskText.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}æœˆ\d{1,2}æ—¥)/g);
                let deadline = defaultDeadline;
                if (dateMatches && dateMatches.length > 0) {
                    let dateStr = dateMatches[0];
                    if (dateStr.includes('æœˆ') && dateStr.includes('æ—¥')) {
                        const year = new Date().getFullYear();
                        const month = dateStr.match(/(\d{1,2})æœˆ/)[1].padStart(2, '0');
                        const day = dateStr.match(/(\d{1,2})æ—¥/)[1].padStart(2, '0');
                        deadline = `${year}-${month}-${day}`;
                    } else {
                        const parts = dateStr.split(/[-\/]/);
                        if (parts[0].length === 4) {
                            deadline = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                        } else {
                            const year = parts[2].length === 4 ? parts[2] : new Date().getFullYear();
                            deadline = `${year}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                        }
                    }
                    taskText = taskText.replace(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}æœˆ\d{1,2}æ—¥)/g, '').trim();
                }
                
                // å„ªå…ˆåº¦æŠ½å‡º
                let priority = defaultPriority;
                if (taskText.match(/[!ï¼]{2,}|é«˜|ç·Šæ€¥|urgent|URGENT|æ€¥/)) {
                    priority = 'high';
                    taskText = taskText.replace(/[!ï¼]+|é«˜|ç·Šæ€¥|urgent|URGENT|æ€¥/g, '').trim();
                } else if (taskText.match(/ä½|later|LATER|å¾Œã§/)) {
                    priority = 'low';
                    taskText = taskText.replace(/ä½|later|LATER|å¾Œã§/g, '').trim();
                }
                
                taskText = taskText.replace(/\s+/g, ' ').trim();
                
                if (taskText && taskText.length > 1) {
                    const task = {
                        id: `preview_${index}`,
                        title: taskText,
                        assignee: assignee,
                        deadline: deadline,
                        priority: priority,
                        columnId: defaultColumn,
                        originalLine: line,
                        lineIndex: index,
                        isMainTask: isMainTask,
                        parentIndex: isMainTask ? null : lastMainTaskIndex,
                        isSkip: false,
                        autoDetected: !isMainTask && hasIndent
                    };
                    
                    if (isMainTask) {
                        lastMainTaskIndex = previewTasksModal.length;
                    }
                    
                    previewTasksModal.push(task);
                }
            });
            
            if (showPreview) {
                displayLineByLinePreviewModal();
            } else {
                executeImportFromModal();
            }
        }
        
        
        // ============ ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨é«˜æ©Ÿèƒ½OCRé–¢æ•°ç¾¤ ============
        let selectedAreasModal = [];
        let isSelectingModal = false;
        let startXModal = 0, startYModal = 0;
        let currentImageModal = null;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç‰ˆï¼‰- DOMContentLoadedå¾Œã«è¨­å®š
        function initOCRModalEventListeners() {
            const ocrInput = document.getElementById('ocr-file-input-modal');
            if (ocrInput) {
                ocrInput.addEventListener('change', function(e) {
                    handleOCRFileModal(this);
                });
            }
        }
        
        function handleOCRFileModal(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageModal = new Image();
                currentImageModal.onload = function() {
                    showImagePreviewModal(this);
                };
                currentImageModal.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function showImagePreviewModal(img) {
            const container = document.getElementById('image-preview-container-modal');
            const canvas = document.getElementById('image-canvas-modal');
            const ctx = canvas.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ç”»åƒã«åˆã‚ã›ã‚‹
            canvas.width = img.width;
            canvas.height = img.height;
            
            // ç”»åƒã‚’æç”»
            ctx.drawImage(img, 0, 0);
            
            // é¸æŠé ˜åŸŸã‚’ã‚¯ãƒªã‚¢
            selectedAreasModal = [];
            updateSelectionCountModal();
            
            // ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
            container.style.display = 'block';
            
            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            setupCanvasEventsModal(canvas);
        }
        
        function setupCanvasEventsModal(canvas) {
            canvas.onmousedown = function(e) {
                isSelectingModal = true;
                const rect = canvas.getBoundingClientRect();
                startXModal = e.clientX - rect.left;
                startYModal = e.clientY - rect.top;
            };
            
            canvas.onmousemove = function(e) {
                if (!isSelectingModal) return;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                // é¸æŠé ˜åŸŸã‚’æç”»
                drawSelectionRectModal(startXModal, startYModal, currentX, currentY);
            };
            
            canvas.onmouseup = function(e) {
                if (!isSelectingModal) return;
                
                isSelectingModal = false;
                const rect = canvas.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;
                
                // é¸æŠé ˜åŸŸã‚’ä¿å­˜
                const area = {
                    x: Math.min(startXModal, endX),
                    y: Math.min(startYModal, endY),
                    width: Math.abs(endX - startXModal),
                    height: Math.abs(endY - startYModal)
                };
                
                if (area.width > 10 && area.height > 10) {
                    selectedAreasModal.push(area);
                    updateSelectionCountModal();
                    drawAllSelectionsModal();
                }
            };
        }
        
        function drawSelectionRectModal(x1, y1, x2, y2) {
            const canvas = document.getElementById('image-canvas-modal');
            const ctx = canvas.getContext('2d');
            
            // ç”»åƒã‚’å†æç”»
            ctx.drawImage(currentImageModal, 0, 0);
            
            // æ—¢å­˜ã®é¸æŠé ˜åŸŸã‚’æç”»
            drawAllSelectionsModal();
            
            // ç¾åœ¨ã®é¸æŠé ˜åŸŸã‚’æç”»
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(Math.min(x1, x2), Math.min(y1, y2), Math.abs(x2 - x1), Math.abs(y2 - y1));
        }
        
        function drawAllSelectionsModal() {
            const canvas = document.getElementById('image-canvas-modal');
            const ctx = canvas.getContext('2d');
            
            ctx.setLineDash([]);
            selectedAreasModal.forEach((area, index) => {
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.strokeRect(area.x, area.y, area.width, area.height);
                
                // é ˜åŸŸç•ªå·ã‚’è¡¨ç¤º
                ctx.fillStyle = '#00ff00';
                ctx.font = '16px Arial';
                ctx.fillText((index + 1).toString(), area.x + 5, area.y + 20);
            });
        }
        
        function updateSelectionCountModal() {
            document.getElementById('selection-count-modal').textContent = `${selectedAreasModal.length}å€‹ã®é ˜åŸŸã‚’é¸æŠä¸­`;
        }
        
        function clearSelectionsModal() {
            selectedAreasModal = [];
            updateSelectionCountModal();
            
            if (currentImageModal) {
                const canvas = document.getElementById('image-canvas-modal');
                const ctx = canvas.getContext('2d');
                ctx.drawImage(currentImageModal, 0, 0);
            }
        }
        
        function hideImagePreviewModal() {
            document.getElementById('image-preview-container-modal').style.display = 'none';
            selectedAreasModal = [];
            currentImageModal = null;
        }
        
        async function processSelectedAreasModal() {
            if (selectedAreasModal.length === 0) {
                alert('ã¾ãšé ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            showOCRProgressModal();
            let allText = '';
            
            try {
                for (let i = 0; i < selectedAreasModal.length; i++) {
                    const area = selectedAreasModal[i];
                    updateOCRProgressModal(10 + (i * 80 / selectedAreasModal.length), `é ˜åŸŸ ${i + 1}/${selectedAreasModal.length} ã‚’å‡¦ç†ä¸­...`);
                    
                    // é¸æŠé ˜åŸŸã‚’åˆ‡ã‚Šå‡ºã—
                    const croppedCanvas = document.createElement('canvas');
                    const croppedCtx = croppedCanvas.getContext('2d');
                    croppedCanvas.width = area.width;
                    croppedCanvas.height = area.height;
                    
                    croppedCtx.drawImage(currentImageModal, area.x, area.y, area.width, area.height, 0, 0, area.width, area.height);
                    
                    // OCRå®Ÿè¡Œ
                    const { data: { text } } = await Tesseract.recognize(croppedCanvas, 'jpn+eng', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = 10 + (i * 80 / selectedAreasModal.length) + (m.progress * 80 / selectedAreasModal.length);
                                updateOCRProgressModal(progress, `é ˜åŸŸ ${i + 1}: ${Math.round(m.progress * 100)}%`);
                            }
                        }
                    });
                    
                    if (text.trim()) {
                        allText += text.trim() + '\n';
                    }
                }
                
                updateOCRProgressModal(100, 'âœ… OCRå®Œäº†ï¼');
                
                // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ã«è¨­å®š
                document.getElementById('import-text-modal').value = allText;
                
                hideOCRProgressModal();
                hideImagePreviewModal();
                
                if (allText.trim()) {
                    alert(`OCRãŒå®Œäº†ã—ã¾ã—ãŸï¼\n${selectedAreasModal.length}å€‹ã®é ˜åŸŸã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚`);
                } else {
                    alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç”»åƒã®å“è³ªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
                
            } catch (error) {
                console.error('OCR Error:', error);
                alert('OCRå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                hideOCRProgressModal();
            }
        }
        
        function showOCRProgressModal() {
            document.getElementById('ocr-status-modal').style.display = 'block';
            updateOCRProgressModal(0, 'ğŸ“¸ OCRå‡¦ç†ã‚’é–‹å§‹ä¸­...');
        }
        
        function updateOCRProgressModal(percentage, message) {
            document.getElementById('ocr-progress-bar-modal').style.width = percentage + '%';
            document.getElementById('ocr-progress-text-modal').textContent = message;
        }
        
        function hideOCRProgressModal() {
            setTimeout(() => {
                document.getElementById('ocr-status-modal').style.display = 'none';
            }, 2000);
        }
        
        function resetOCRSettingsModal() {
            document.getElementById('ocr-handwriting-mode-modal').checked = false;
            document.getElementById('ocr-complex-layout-mode-modal').checked = false;
            document.getElementById('ocr-enhance-contrast-modal').checked = false;
            document.getElementById('ocr-upscale-modal').checked = false;
            document.getElementById('ocr-grayscale-modal').checked = false;
            document.getElementById('ocr-cleanup-symbols-modal').checked = true;
        }
        
        function previewProcessingModal() {
            alert('å‡¦ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã¯å®Ÿè£…äºˆå®šã§ã™');
        }
        
        function testOCRDirectlyModal() {
            alert('OCRãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¯å®Ÿè£…äºˆå®šã§ã™');
        }
        
        // ã€å…ƒã®å®Œå…¨ãªæ©Ÿèƒ½ã‚’å¾©å…ƒã€‘ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ»3åˆ—è¡¨ç¤ºãƒ»æœŸé™ç·¨é›†
        
        function displayLineByLinePreviewModal() {
            const previewDiv = document.getElementById('import-preview-modal');
            const contentDiv = document.getElementById('preview-content-modal');
            
            if (previewTasksModal.length === 0) {
                alert('æœ‰åŠ¹ãªã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const activeTaskCount = previewTasksModal.filter(t => !t.isSkip).length;
            const mainTaskCount = previewTasksModal.filter(t => !t.isSkip && t.isMainTask).length;
            const commentCount = previewTasksModal.filter(t => !t.isSkip && !t.isMainTask).length;
            
            const modeInfo = `<div style="font-size: 0.9rem; margin-top: 0.5rem;">âœ¨ ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆè¡Œã¯è‡ªå‹•ã§ã‚³ãƒ¡ãƒ³ãƒˆã«è¨­å®šæ¸ˆã¿ï¼ˆåŠè§’ã‚¹ãƒšãƒ¼ã‚¹2å€‹ãƒ»å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹1å€‹ãƒ»ã‚¿ãƒ–ï¼‰ã€‚ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§è¦ªå­é–¢ä¿‚ã‚’å¤‰æ›´å¯èƒ½</div>`;
            
            let content = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f5e8; border-radius: 4px; color: #2f7d2f;">
                    <strong>ğŸ“ ${activeTaskCount}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ  (ğŸ“‹ ãƒ¡ã‚¤ãƒ³: ${mainTaskCount}, ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ: ${commentCount})</strong>
                    ${modeInfo}
                </div>
                
                <!-- 3åˆ—è¡¨ç¤ºãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
                <div style="padding: 1rem; background: #f0f2f5; border-radius: 12px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;" id="preview-container-modal">
            `;
            
            previewTasksModal.forEach((task, index) => {
                if (task.isSkip) return;
                
                const mainTaskOptions = previewTasksModal.map((t, i) => 
                    i < index && t.isMainTask ? `<option value="${i}" ${task.parentIndex === i ? 'selected' : ''}>ğŸ“‹ ${t.title.substring(0, 30)}${t.title.length > 30 ? '...' : ''}</option>` : ''
                ).join('');
                
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                const borderColor = isAutoComment ? '#28a745' : '#ddd';
                const bgColor = isAutoComment ? '#f8fff9' : 'white';
                const headerText = isAutoComment ? 'âœ¨ è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆ' : 'ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½';
                
                content += `
                    <div style="border: 2px solid ${borderColor}; border-radius: 8px; background: ${bgColor}; transition: all 0.2s; cursor: move; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); height: fit-content;" 
                         draggable="true" 
                         ondragstart="handlePreviewDragStartModal(event, ${index})" 
                         ondragend="handleDragEndModal(event)"
                         ondragover="handleDragOverModal(event)" 
                         ondrop="handlePreviewDropModal(event, ${index})"
                         ondragenter="handleDragEnterModal(event)"
                         ondragleave="handleDragLeaveModal(event)"
                         id="preview-item-modal-${index}">
                        
                        <!-- ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« -->
                        <div style="background: ${borderColor}; padding: 0.4rem 0.8rem; text-align: center; color: white; font-weight: bold; cursor: grab; user-select: none; font-size: 0.85rem;">
                            â‹®â‹® ${headerText} â‹®â‹®
                        </div>
                        
                        <!-- ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div style="padding: 0.75rem; background: white;">
                            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                <input type="text" 
                                       value="${task.title.replace(/"/g, '&quot;')}" 
                                       onchange="updateTaskTitleModal(${index}, this.value)" 
                                       style="flex: 1; font-family: monospace; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; border: 1px solid ${borderColor}; border-left: 3px solid ${borderColor};"
                                       id="title-input-modal-${index}">
                                <button onclick="deletePreviewTaskModal(${index})" 
                                        style="background: #e53e3e; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                                        title="ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                                å…ƒ: "${task.originalLine}"
                            </div>
                        </div>
                        
                        <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
                        <div style="padding: 0.75rem; background: #fafafa; border-top: 1px solid #eee;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">ç¨®é¡:</label>
                                    <select onchange="updateTaskTypeModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;">
                                        <option value="main" ${task.isMainTask ? 'selected' : ''}>ğŸ“‹ ãƒ¡ã‚¤ãƒ³</option>
                                        <option value="comment" ${!task.isMainTask ? 'selected' : ''}>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</option>
                                        <option value="skip">â­ï¸ ã‚¹ã‚­ãƒƒãƒ—</option>
                                    </select>
                                </div>
                                
                                ${!task.isMainTask ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">è¦ª:</label>
                                    <select onchange="updateTaskParentModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="parent-select-modal-${index}">
                                        <option value="">ï¼</option>
                                        ${mainTaskOptions}
                                    </select>
                                </div>
                                ` : `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">åˆ—:</label>
                                    <select onchange="updateTaskColumnModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="column-select-modal-${index}">
                                        ${columns.map(c => `<option value="${c.id}" ${task.columnId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <!-- æ‹…å½“è€…è¨­å®š -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">æ‹…å½“:</label>
                                    <input type="text" onchange="updateTaskAssigneeModal(${index}, this.value)" value="${task.assignee}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" placeholder="æ‹…å½“è€…å" id="assignee-input-modal-${index}">
                                </div>
                                
                                <!-- æœŸé™è¨­å®š -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">æœŸé™:</label>
                                    <input type="date" onchange="updateTaskDeadlineModal(${index}, this.value)" value="${task.deadline}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="deadline-input-modal-${index}">
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += `
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 0.9rem;">
                    <strong>ğŸ’¡ ä½¿ã„æ–¹ï¼š</strong><br>
                    â€¢ <strong>âœ¨ è‡ªå‹•åˆ¤å®š</strong>ï¼šç©ºç™½ãŒã‚ã‚‹è¡Œã¯è‡ªå‹•ã§ã‚³ãƒ¡ãƒ³ãƒˆã«è¨­å®šã•ã‚Œã€ç›´å‰ã®ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ãŒè¦ªã«è¨­å®šã•ã‚Œã¾ã™<br>
                    â€¢ <strong>ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</strong>ï¼šä»»æ„ã®è¡Œã‚’ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã«å¤‰æ›´<br>
                    â€¢ <strong>ğŸ“‹ ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯</strong>ï¼šç‹¬ç«‹ã—ãŸã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦ä½œæˆ<br>
                    â€¢ <strong>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</strong>ï¼šæŒ‡å®šã—ãŸãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ <br>
                    â€¢ <strong>â­ï¸ ã‚¹ã‚­ãƒƒãƒ—</strong>ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ç„¡è¦–
                </div>
            `;
            
            contentDiv.innerHTML = content;
            previewDiv.style.display = 'block';
        }
        
        // ã€å…ƒã®å®Œå…¨ãªupdateé–¢æ•°ç¾¤ã‚’å¾©å…ƒã€‘
        function updateTaskTitleModal(index, title) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].title = title.trim();
            }
        }
        
        function updateTaskTypeModal(index, type) {
            if (previewTasksModal[index]) {
                // ã‚³ãƒ¡ãƒ³ãƒˆåŒ–ã—ã‚ˆã†ã¨ã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã®è¦ªã«ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (type === 'comment' && previewTasksModal[index].isMainTask) {
                    const hasChildComments = previewTasksModal.some((task, i) => 
                        i !== index && !task.isMainTask && task.parentIndex === index
                    );
                    
                    if (hasChildComments) {
                        alert('âš ï¸ ã“ã®ã‚¿ã‚¹ã‚¯ã¯ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã®è¦ªã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆåŒ–ã§ãã¾ã›ã‚“ã€‚\nå…ˆã«å­ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»–ã®ã‚¿ã‚¹ã‚¯ã«ç§»å‹•ã™ã‚‹ã‹ã€ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');
                        document.querySelector(`#preview-item-modal-${index} select`).value = 'main';
                        return;
                    }
                }
                
                previewTasksModal[index].isMainTask = (type === 'main');
                previewTasksModal[index].isSkip = (type === 'skip');
                
                displayLineByLinePreviewModal();
            }
        }
        
        function updateTaskParentModal(index, parentIndex) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].parentIndex = parentIndex === '' ? null : parseInt(parentIndex);
                displayLineByLinePreviewModal();
            }
        }
        
        function updateTaskColumnModal(index, columnId) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].columnId = columnId;
            }
        }
        
        function updateTaskAssigneeModal(index, assignee) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].assignee = assignee.trim();
            }
        }
        
        function updateTaskDeadlineModal(index, deadline) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].deadline = deadline;
            }
        }
        
        function deletePreviewTaskModal(index) {
            const task = previewTasksModal[index];
            
            // ã“ã®ã‚¿ã‚¹ã‚¯ã‚’è¦ªã«ã—ã¦ã„ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
            const childComments = previewTasksModal.filter((t, i) => 
                i !== index && !t.isMainTask && t.parentIndex === index
            );
            
            if (childComments.length > 0) {
                if (!confirm(`âš ï¸ ã“ã®ã‚¿ã‚¹ã‚¯ã«ã¯${childComments.length}å€‹ã®å­ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚\nå­ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ä¸€ç·’ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                
                // å­ã‚³ãƒ¡ãƒ³ãƒˆã‚‚å‰Šé™¤
                childComments.forEach(childTask => {
                    const childIndex = previewTasksModal.findIndex(t => t === childTask);
                    if (childIndex !== -1) {
                        previewTasksModal.splice(childIndex, 1);
                    }
                });
            }
            
            previewTasksModal.splice(index, 1);
            displayLineByLinePreviewModal();
        }
        
        // ã€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’å¾©å…ƒã€‘
        function handlePreviewDragStartModal(event, index) {
            draggedIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.6';
        }
        
        function handleDragEndModal(event) {
            event.target.style.opacity = '1';
            draggedIndex = -1;
        }
        
        function handleDragOverModal(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnterModal(event) {
            event.preventDefault();
            if (event.target.closest('[id^="preview-item-modal-"]')) {
                event.target.closest('[id^="preview-item-modal-"]').style.backgroundColor = '#e3f2fd';
            }
        }
        
        function handleDragLeaveModal(event) {
            if (event.target.closest('[id^="preview-item-modal-"]')) {
                const item = event.target.closest('[id^="preview-item-modal-"]');
                const itemIndex = parseInt(item.id.split('-')[3]);
                const task = previewTasksModal[itemIndex];
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                item.style.backgroundColor = isAutoComment ? '#f8fff9' : 'white';
            }
        }
        
        function handlePreviewDropModal(event, targetIndex) {
            event.preventDefault();
            
            if (draggedIndex === targetIndex || draggedIndex === -1) {
                event.target.closest('[id^="preview-item-modal-"]').style.opacity = '1';
                return;
            }
            
            const draggedTask = previewTasksModal[draggedIndex];
            const targetTask = previewTasksModal[targetIndex];
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å¤‰æ›´ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¿ã‚¹ã‚¯ã‚’è¦ªã«è¨­å®š
            if (targetTask.isMainTask) {
                // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã®è¦ªã«ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (draggedTask.isMainTask) {
                    const childComments = previewTasksModal.filter((task, i) => 
                        i !== draggedIndex && !task.isMainTask && task.parentIndex === draggedIndex
                    );
                    
                    if (childComments.length > 0) {
                        // å­ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ä¸€ç·’ã«ç§»å‹•
                        childComments.forEach(childTask => {
                            childTask.parentIndex = targetIndex;
                        });
                    }
                }
                
                draggedTask.isMainTask = false;
                draggedTask.parentIndex = targetIndex;
                
                displayLineByLinePreviewModal();
                
                const movedCount = draggedTask.isMainTask ? 0 : previewTasksModal.filter(t => !t.isMainTask && t.parentIndex === targetIndex).length;
                alert(`ğŸ’¬ "${draggedTask.title}"ã‚’"${targetTask.title}"ã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¨­å®šã—ã¾ã—ãŸ${movedCount > 1 ? `ï¼ˆå­ã‚³ãƒ¡ãƒ³ãƒˆ${movedCount-1}å€‹ã‚‚ç§»å‹•ï¼‰` : ''}`);
            } else {
                alert('âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
            }
            
            draggedIndex = -1;
        }
        
        function executeImportFromModal() {
            if (previewTasksModal.length === 0) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const activeTasksModal = previewTasksModal.filter(t => !t.isSkip);
            if (activeTasksModal.length === 0) {
                alert('æœ‰åŠ¹ãªã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const importedCount = importTasksModal(activeTasksModal);
            const mainCount = activeTasksModal.filter(t => t.isMainTask).length;
            const commentCount = activeTasksModal.filter(t => !t.isMainTask).length;
            
            alert(`ğŸ‰ ã‚¿ã‚¹ã‚¯è¿½åŠ ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nğŸ“‹ ${mainCount}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ \nğŸ’¬ ${commentCount}å€‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ \n\nåˆè¨ˆ: ${importedCount}ä»¶`);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’æ›´æ–°
            closeTaskImportModal();
            render();
            
            // ğŸš« ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¾Œã®æœŸé™ãƒã‚§ãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
            // setTimeout(() => checkDeadlines(), 100);
        }
        
        // ============ ã‚¿ã‚¹ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°ç¾¤ çµ‚äº† ============

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠé–¢é€£é–¢æ•°
        function initializeTemplateSelector() {
            const templateSelect = document.getElementById('template-select');
            templateSelect.innerHTML = '<option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ --</option>';
            
            if (taskTemplates.length === 0) {
                return;
            }
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                if (!groupedTemplates[template.category]) {
                    groupedTemplates[template.category] = [];
                }
                groupedTemplates[template.category].push(template);
            });
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            Object.keys(groupedTemplates).forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                groupedTemplates[category].forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    optgroup.appendChild(option);
                });
                
                templateSelect.appendChild(optgroup);
            });
        }
        
        function handleTemplateSelection(templateId) {
            if (!templateId) {
                return;
            }
            
            const template = taskTemplates.find(t => t.id == templateId);
            if (!template) {
                return;
            }
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å€¤ã‚’è¨­å®š
            document.getElementById('task-title-input').value = template.taskTitle;
            document.getElementById('task-priority-input').value = template.priority;
            document.getElementById('task-column-input').value = template.columnId;
            document.getElementById('task-memo-input').value = template.memo || '';
            
            // æ‹…å½“è€…ã‚’è¨­å®š
            if (template.assignees && template.assignees.length > 0) {
                setSelectedAssignees(template.assignees);
            }
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('template-select').value = '';
        }
        
        // ãƒãƒ«ã‚¯æ“ä½œé–¢æ•°ç¾¤
        function toggleBulkMode() {
            isBulkMode = !isBulkMode;
            console.log(`ğŸ”„ [BULK] toggleBulkMode called, new state: ${isBulkMode}`);
            const bulkBar = document.getElementById('bulk-actions-bar');
            const toggleBtn = document.querySelector('button[onclick="toggleBulkMode()"]');
            
            if (isBulkMode) {
                bulkBar.style.display = 'block';
                toggleBtn.textContent = 'â˜‘ï¸ é¸æŠä¸­';
                toggleBtn.style.background = 'linear-gradient(135deg, #e53e3e 0%, #c53030 100%)';
                
                // ç§»å‹•å…ˆã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
                const moveSelect = document.getElementById('bulk-move-column');
                moveSelect.innerHTML = '<option value="">ç§»å‹•å…ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ</option>';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    moveSelect.appendChild(option);
                });
            } else {
                bulkBar.style.display = 'none';
                toggleBtn.textContent = 'â˜‘ï¸ è¤‡æ•°é¸æŠ';
                toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                clearSelection();
            }
            
            render(); // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º/éè¡¨ç¤ºã‚’åæ˜ 
        }
        
        function selectAllTasks() {
            selectedTasks.clear();
            tasks.forEach(task => {
                selectedTasks.add(task.id);
            });
            updateSelectedCount();
            render();
        }
        
        function clearSelection() {
            selectedTasks.clear();
            updateSelectedCount();
            render();
        }
        
        function toggleTaskSelection(taskId) {
            console.log(`Toggle selection for task ${taskId}, current size: ${selectedTasks.size}`);
            
            if (selectedTasks.has(taskId)) {
                selectedTasks.delete(taskId);
                console.log(`Removed task ${taskId}, new size: ${selectedTasks.size}`);
            } else {
                selectedTasks.add(taskId);
                console.log(`Added task ${taskId}, new size: ${selectedTasks.size}`);
            }
            updateSelectedCount();
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const checkbox = document.querySelector(`input[onchange="toggleTaskSelection(${taskId})"]`);
            if (checkbox) {
                checkbox.checked = selectedTasks.has(taskId);
            }
            
            console.log(`Selected tasks:`, Array.from(selectedTasks));
        }
        
        function updateSelectedCount() {
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = `${selectedTasks.size}ä»¶é¸æŠ`;
            }
        }
        
        function bulkMoveSelected() {
            const targetColumn = document.getElementById('bulk-move-column').value;
            if (!targetColumn) {
                alert('ç§»å‹•å…ˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (selectedTasks.size === 0) {
                alert('ç§»å‹•ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const selectedTaskIds = Array.from(selectedTasks);
            let movedCount = 0;
            
            selectedTaskIds.forEach(taskId => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    console.log(`Moving task ${task.title} from ${task.columnId} to ${targetColumn}`);
                    task.columnId = targetColumn;
                    movedCount++;
                }
            });
            
            if (movedCount > 0) {
                saveTasks();
                render();
                updateStats();
                clearSelection();
                
                const targetColumnTitle = columns.find(c => c.id === targetColumn)?.title || targetColumn;
                alert(`${movedCount}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ã€Œ${targetColumnTitle}ã€ã«ç§»å‹•ã—ã¾ã—ãŸ`);
            } else {
                alert('ç§»å‹•ã§ãã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
        }
        
        function bulkDeleteSelected() {
            if (selectedTasks.size === 0) {
                alert('å‰Šé™¤ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const selectedTaskIds = Array.from(selectedTasks);
            const confirmMessage = `é¸æŠã—ãŸ${selectedTaskIds.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            tasks = tasks.filter(task => !selectedTasks.has(task.id));
            
            saveTasks();
            clearSelection();
            render();
            updateStats();
            
            alert(`${selectedTaskIds.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
        
        
        
        // Phase 2: ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³å‰Šé™¤å®Ÿè¡Œ
        setTimeout(() => {
            removeMyProfileButton();
        }, 1500); // 1.5ç§’å¾Œã«å®‰å…¨ã«å®Ÿè¡Œ
        
        // Phase 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³åˆ¶å¾¡å®Ÿè¡Œï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ç§»æ¤ã®ãŸã‚ä¸è¦ï¼‰
        // setTimeout(() => {
        //     hideUserManagementForUsers();
        // }, 300); // 0.3ç§’å¾Œã«é«˜é€Ÿå®Ÿè¡Œ
        
        // ãƒ†ã‚¹ãƒˆç”¨: åœæ»ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
        function createTestStaleTask() {
            const staleDate = new Date();
            staleDate.setDate(staleDate.getDate() - 5); // 5æ—¥å‰
            
            const testTask = {
                id: Date.now(),
                title: 'ã€ãƒ†ã‚¹ãƒˆã€‘5æ—¥å‰ã«ä½œæˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯',
                deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7æ—¥å¾Œã®æœŸé™
                priority: 'medium',
                columnId: 'todo',
                assignee: 'ç”°ä¸­éƒ¨é•·',
                assignees: ['ç”°ä¸­éƒ¨é•·'],
                memo: 'ã“ã‚Œã¯åœæ»ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆç”¨ã§ã™ã€‚3æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ãŸã‚èµ¤æ è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚',
                createdAt: staleDate.toISOString(),
                isMainTask: false
            };
            
            tasks.push(testTask);
            taskCounter++;
            
            saveTasks();
            renderKanban();
            updateStats();
            
            alert('5æ—¥å‰ã«ä½œæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\nèµ¤æ ã§è¡¨ç¤ºã•ã‚Œã€åœæ»ä¸­ã‚«ã‚¦ãƒ³ãƒˆã«å«ã¾ã‚Œã¾ã™ã€‚');
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½ï¼‰
        window.createTestStaleTask = createTestStaleTask;
        
        // ãƒ†ã‚¹ãƒˆç”¨PJã‚¿ã‚¹ã‚¯ä½œæˆ
        function createTestPJTask() {
            const testPJTask = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                title: 'ã€ãƒ†ã‚¹ãƒˆPJã€‘æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥ - è¦ä»¶å®šç¾©æ›¸ä½œæˆ',
                deadline: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString(), // 10æ—¥å¾Œã®æœŸé™
                priority: 'high',
                columnId: 'todo',
                assignee: 'ç”°ä¸­éƒ¨é•·',
                assignees: ['ç”°ä¸­éƒ¨é•·', 'ä½è—¤èª²é•·'],
                memo: 'ã“ã‚Œã¯PJã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚Wãƒã‚§ãƒƒã‚¯ä½“åˆ¶ã®ç¢ºèªç”¨ã€‚',
                createdAt: new Date().toISOString(),
                completed: false,
                
                // PJã‚¿ã‚¹ã‚¯å°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                projectId: 'PJ001',
                projectName: 'æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
                personalStatus: 'todo',
                projectStatus: 'todo',
                pendingMove: null,
                approvers: ['ä½è—¤èª²é•·', 'éˆ´æœ¨ä¸»ä»»'],
                lastApprovedBy: null,
                approvedAt: null
            };
            
            tasks.push(testPJTask);
            saveTasks();
            render();
            updateStats();
            
            alert('ãƒ†ã‚¹ãƒˆç”¨PJã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\nPJãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰ã€ŒPJ001ã€ã‚’é¸æŠã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚\n\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: PJ001');
        }
        
        window.createTestPJTask = createTestPJTask;
        
        // å®šæœŸã‚¿ã‚¹ã‚¯ç®¡ç†ã®åŸºæœ¬é–¢æ•°
        function createRecurringTemplate() {
            alert('å®šæœŸã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆæ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™ã€‚\n\näºˆå®šæ©Ÿèƒ½:\nâ€¢ æ¯æœˆãƒ»æ¯é€±ã®ç¹°ã‚Šè¿”ã—è¨­å®š\nâ€¢ æ‹…å½“è€…ãƒ»æœŸé™ã®è‡ªå‹•è¨­å®š\nâ€¢ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆ');
        }
        
        function generatePendingTasks() {
            // ç¾åœ¨å®šæœŸã‚¿ã‚¹ã‚¯ãŒ0ä»¶ãªã®ã§ã€ãƒ‡ãƒ¢ç”¨ã®èª¬æ˜ã‚’è¡¨ç¤º
            alert('å®šæœŸã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒã‚§ãƒƒã‚¯å®Œäº†\n\nç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ã€æŒ‡å®šã•ã‚ŒãŸé–“éš”ã§ã‚¿ã‚¹ã‚¯ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚');
        }
        
        window.createRecurringTemplate = createRecurringTemplate;
        window.generatePendingTasks = generatePendingTasks;
        
        // PJã‚¿ã‚¹ã‚¯è¨¼æ†‘ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆç§»å‹•ã®ãŸã³ã«æ–°ã—ã„è¨¼æ†‘ãŒå¿…è¦ï¼‰
        function checkTaskEvidence(task, isMoving = false) {
            // è¨¼æ†‘ã®å­˜åœ¨ç¢ºèª
            const hasComments = task.comments && task.comments.length > 0;
            const hasAttachments = task.attachments && task.attachments.length > 0;
            const hasDetailedMemo = task.memo && task.memo.trim().length > 10; // 10æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãƒ¡ãƒ¢
            
            // ç§»å‹•æ™‚ã¯ã€å‰å›ç§»å‹•å¾Œã«æ–°ã—ã„è¨¼æ†‘ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (isMoving && task.lastMovedAt) {
                const lastMoveTime = new Date(task.lastMovedAt).getTime();
                
                // å‰å›ç§»å‹•å¾Œã®ã‚³ãƒ¡ãƒ³ãƒˆç¢ºèª
                const recentComments = task.comments ? task.comments.filter(comment => 
                    new Date(comment.timestamp).getTime() > lastMoveTime
                ).length > 0 : false;
                
                // å‰å›ç§»å‹•å¾Œã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
                const recentAttachments = task.attachments ? task.attachments.filter(file =>
                    new Date(file.uploadedAt || file.timestamp || 0).getTime() > lastMoveTime
                ).length > 0 : false;
                
                // ãƒ¡ãƒ¢ã®æ›´æ–°ç¢ºèªï¼ˆupdatedAtãŒlastMovedAtã‚ˆã‚Šæ–°ã—ã„ï¼‰
                const recentMemoUpdate = task.updatedAt && 
                    new Date(task.updatedAt).getTime() > lastMoveTime &&
                    task.memo && task.memo.trim().length > 10;
                
                const hasRecentEvidence = recentComments || recentAttachments || recentMemoUpdate;
                
                console.log(`ğŸ” [EVIDENCE CHECK] Task: ${task.title}`);
                console.log(`ğŸ” [EVIDENCE CHECK] Last moved: ${task.lastMovedAt}`);
                console.log(`ğŸ” [EVIDENCE CHECK] Recent comments: ${recentComments}`);
                console.log(`ğŸ” [EVIDENCE CHECK] Recent attachments: ${recentAttachments}`);
                console.log(`ğŸ” [EVIDENCE CHECK] Recent memo update: ${recentMemoUpdate}`);
                console.log(`ğŸ” [EVIDENCE CHECK] Has recent evidence: ${hasRecentEvidence}`);
                
                return hasRecentEvidence;
            }
            
            // åˆå›ç§»å‹•æ™‚ã¯æ—¢å­˜ã®è¨¼æ†‘ã‚’ãƒã‚§ãƒƒã‚¯
            return hasComments || hasAttachments || hasDetailedMemo;
        }
        
        function promptForEvidence(task) {
            return new Promise((resolve) => {
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
                const dialogHTML = `
                    <div id="evidenceDialog" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    ">
                        <div style="
                            background: white;
                            padding: 2rem;
                            border-radius: 8px;
                            max-width: 500px;
                            margin: 1rem;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        ">
                            <h3 style="color: #e67e22; margin-bottom: 1rem;">âš ï¸ PJã‚¿ã‚¹ã‚¯ã®ç§»å‹•ã«ã¯è¨¼æ†‘ãŒå¿…è¦ã§ã™</h3>
                            <p style="margin-bottom: 1rem;"><strong>ã‚¿ã‚¹ã‚¯:</strong> ${task.title}</p>
                            <p style="margin-bottom: 1rem;"><strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</strong> ${task.projectName}</p>
                            <p style="margin-bottom: 1rem;">ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„:</p>
                            <ul style="margin-bottom: 1.5rem; padding-left: 1.5rem;">
                                <li>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆé€²æ—å ±å‘Šãƒ»é€£çµ¡å†…å®¹ç­‰ï¼‰</li>
                                <li>ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ï¼ˆè³‡æ–™ãƒ»ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç­‰ï¼‰</li>
                                <li>è©³ç´°ãƒ¡ãƒ¢ï¼ˆãƒ¡ãƒ¼ãƒ«å†…å®¹ãƒ»æ‰“ã¡åˆã‚ã›çµæœç­‰ï¼‰</li>
                            </ul>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button id="evidenceCancel" style="
                                    padding: 0.5rem 1rem;
                                    border: 1px solid #ddd;
                                    background: white;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">è¨¼æ†‘ã‚’è¿½åŠ ã™ã‚‹</button>
                                <button id="evidenceConfirm" style="
                                    padding: 0.5rem 1rem;
                                    border: none;
                                    background: #e74c3c;
                                    color: white;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">è¨¼æ†‘ãªã—ã§ç§»å‹•ã™ã‚‹</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', dialogHTML);
                
                const dialog = document.getElementById('evidenceDialog');
                const cancelBtn = document.getElementById('evidenceCancel');
                const confirmBtn = document.getElementById('evidenceConfirm');
                
                function cleanup() {
                    if (dialog && dialog.parentNode) {
                        dialog.parentNode.removeChild(dialog);
                    }
                }
                
                cancelBtn.onclick = () => {
                    cleanup();
                    // è¨¼æ†‘è¿½åŠ ã®ãŸã‚ã‚¿ã‚¹ã‚¯ç·¨é›†ç”»é¢ã‚’é–‹ã
                    editTask(task.id);
                    resolve(false);
                };
                
                confirmBtn.onclick = () => {
                    cleanup();
                    resolve(true); // è¨¼æ†‘ãªã—ã§å¼·åˆ¶ç§»å‹•
                };
            });
        }
        
        // PJã‚¿ã‚¹ã‚¯ç§»å‹•æ™‚ã®é€šçŸ¥æ©Ÿèƒ½ï¼ˆSlackå¯¾å¿œå¼·åŒ–ç‰ˆï¼‰
        function sendPJMoveNotification(task, newColumnId) {
            try {
                // éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®é€šçŸ¥æŠ‘åˆ¶ãƒã‚§ãƒƒã‚¯
                if (task.isHidden) {
                    console.log(`ğŸ”’ [SLACK-MOVE] éè¡¨ç¤ºã‚¿ã‚¹ã‚¯ã®ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${task.title}`);
                    return;
                }
                
                const currentUser = getCurrentUser();

                // ã‚«ãƒ©ãƒ IDã‹ã‚‰ã‚«ãƒ©ãƒ åã‚’å–å¾—ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ å¯¾å¿œï¼‰
                let columnTitle = newColumnId; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (task.projectId) {
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®å ´åˆã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ã‚«ãƒ©ãƒ ã‹ã‚‰æ¤œç´¢
                    const projectColumns = getProjectColumns(task.projectId);
                    const column = projectColumns.find(c => c.id === newColumnId);
                    columnTitle = column ? column.title : newColumnId;
                    console.log(`ğŸ” [SLACK-MOVE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ æ¤œç´¢: ${newColumnId} â†’ ${columnTitle}`);
                } else {
                    // å€‹äººã‚¿ã‚¹ã‚¯ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã‹ã‚‰æ¤œç´¢
                    const column = columns.find(c => c.id === newColumnId);
                    columnTitle = column ? column.title : newColumnId;
                    console.log(`ğŸ” [SLACK-MOVE] å€‹äººã‚«ãƒ©ãƒ æ¤œç´¢: ${newColumnId} â†’ ${columnTitle}`);
                }
                
                console.log(`ğŸ”” [SLACK-MOVE] ã‚¿ã‚¹ã‚¯ç§»å‹•é€šçŸ¥é–‹å§‹: ${task.title} â†’ ${columnTitle}`);
                console.log(`ğŸ”” [SLACK-MOVE] ã‚¿ã‚¹ã‚¯æƒ…å ±:`, {
                    id: task.id,
                    title: task.title,
                    assignees: task.assignees,
                    assignee: task.assignee,
                    approvers: task.approvers
                });
                
                // é€šçŸ¥å¯¾è±¡è€…ã‚’é›†ã‚ã‚‹ï¼ˆæ‰¿èªè€… + æ‹…å½“è€… + ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ï¼‰
                const notifyUsers = new Set();
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®å ´åˆã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ 
                if (task.projectId && task.projectName) {
                    console.log(`ğŸ”” [SLACK-MOVE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯æ¤œå‡º: ${task.projectName} (${task.projectId})`);

                    // ğŸ”¥ Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—
                    let project = null;
                    if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                        const result = await window.FirebaseDB.getProjects();
                        if (result.success) {
                            project = result.projects.find(p => p.id === task.projectId);
                        }
                    }

                    if (project && project.members) {
                        project.members.forEach(member => {
                            notifyUsers.add(member);
                            console.log(`ğŸ”” [SLACK-MOVE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ : ${member}`);
                        });
                        console.log(`ğŸ”” [SLACK-MOVE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼åˆè¨ˆ: ${project.members.length}äºº`);
                    } else {
                        console.log(`âš ï¸ [SLACK-MOVE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãªã—`);
                    }
                }
                
                
                // æ‹…å½“è€…ã‚’è¿½åŠ 
                if (task.assignees && task.assignees.length > 0) {
                    task.assignees.forEach(assignee => {
                        notifyUsers.add(assignee);
                        console.log(`ğŸ”” [SLACK-MOVE] æ‹…å½“è€…è¿½åŠ : ${assignee}`);
                    });
                } else if (task.assignee) {
                    notifyUsers.add(task.assignee);
                    console.log(`ğŸ”” [SLACK-MOVE] æ‹…å½“è€…è¿½åŠ ï¼ˆæ—§å½¢å¼ï¼‰: ${task.assignee}`);
                }
                
                // ğŸ”§ ã‚¿ã‚¹ã‚¯ç§»å‹•é€šçŸ¥ã®å ´åˆã€è‡ªåˆ†ã‚‚å«ã‚ã¦å…¨å“¡ã«é€šçŸ¥ï¼ˆæƒ…å ±å…±æœ‰ã®ãŸã‚ï¼‰
                const includeCurrentUserInNotification = true;  // ã‚¿ã‚¹ã‚¯ç§»å‹•æ™‚ã¯è‡ªåˆ†ã‚‚é€šçŸ¥å¯¾è±¡ã«å«ã‚ã‚‹
                
                const filteredNotifyUsers = Array.from(notifyUsers).filter(user => {
                    if (includeCurrentUserInNotification) {
                        // ã‚¿ã‚¹ã‚¯ç§»å‹•é€šçŸ¥ã§ã¯å…¨å“¡ã«é€šçŸ¥
                        console.log(`ğŸ” [MOVE-FILTER] ${user}: ã‚¿ã‚¹ã‚¯ç§»å‹•ã®ãŸã‚å…¨å“¡ã«é€šçŸ¥`);
                        return true;
                    } else {
                        // ãã®ä»–ã®é€šçŸ¥ã‚¿ã‚¤ãƒ—ã§ã¯ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–
                        const isNotCurrentUser = (
                            user !== currentUser.name &&
                            user !== currentUser.email &&
                            user !== currentUser.id
                        );
                        console.log(`ğŸ” [MOVE-FILTER] ${user}: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„ = ${isNotCurrentUser}`);
                        return isNotCurrentUser;
                    }
                });
                
                const notifyUsersList = filteredNotifyUsers;
                
                console.log(`ğŸ”” [SLACK-MOVE] å…ƒã®é€šçŸ¥å¯¾è±¡è€…:`, Array.from(notifyUsers));
                console.log(`ğŸ”” [SLACK-MOVE] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œé€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼:`, notifyUsersList);
                console.log(`ğŸ”” [SLACK-MOVE] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser.name} (æ­£ã—ãé™¤å¤–)`);
                
                // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
                const notificationTitle = `ğŸ“¦ ã‚¿ã‚¹ã‚¯ç§»å‹•é€šçŸ¥`;
                const notificationBody = 
                    `ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€ãŒ${columnTitle}ã«ç§»å‹•ã•ã‚Œã¾ã—ãŸ\n\n` +
                    `ç§»å‹•å…ˆ: ${columnTitle}`;
                
                // é€šçŸ¥å¯¾è±¡è€…ãŒã„ãªã„å ´åˆã§ã‚‚ã€ãƒ†ã‚¹ãƒˆç”¨ã«Slacké€šçŸ¥ã‚’é€ä¿¡
                if (notifyUsersList.length === 0) {
                    console.log(`ğŸ”” [SLACK-MOVE] é€šçŸ¥å¯¾è±¡è€…ãªã— - ãƒ†ã‚¹ãƒˆç”¨Slacké€šçŸ¥ã‚’é€ä¿¡`);
                    console.log(`ğŸ”” [SLACK-MOVE] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:`, currentUser);
                    
                    // ãƒ†ã‚¹ãƒˆç”¨ã®è‡ªåˆ†ã¸ã®é€šçŸ¥ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç›´æ¥æŒ‡å®šï¼‰
                    showNotification(
                        notificationTitle,
                        `${notificationBody}\n\nâ€» ãƒ†ã‚¹ãƒˆç”¨é€šçŸ¥ï¼ˆå¯¾è±¡è€…ãªã—ï¼‰`,
                        {
                            tag: `move-test-${task.id}-${Date.now()}`,
                            taskId: task.id,
                            targetUser: currentUser.name,
                            targetEmail: currentUser.email || 'muranaka-tenma@terracom.co.jp',  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç›´æ¥æŒ‡å®š
                            type: 'task_move_test'
                        }
                    );
                    return;
                }
                
                // çµ±åˆé€šçŸ¥ã¨ã—ã¦1å›ã ã‘é€ä¿¡ï¼ˆå€‹åˆ¥é€ä¿¡ã‚’å»ƒæ­¢ï¼‰
                if (notifyUsersList.length > 0) {
                    console.log(`ğŸ”” [SLACK-MOVE] çµ±åˆé€šçŸ¥é€ä¿¡é–‹å§‹: ${notifyUsersList.length}äººã¸ã®çµ±åˆé€šçŸ¥`);
                    
                    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¯showNotificationã®'multiple'å‡¦ç†ã«ä»»ã›ã‚‹ï¼ˆé‡è¤‡å›é¿ã®ãŸã‚ï¼‰
                    showNotification(
                        notificationTitle,
                        notificationBody,
                        {
                            tag: `move-${task.id}-${Date.now()}`,
                            taskId: task.id,
                            targetUser: 'multiple',
                            mentionUsers: notifyUsersList,
                            type: 'task_move'
                        }
                    );
                    
                    console.log(`âœ… [SLACK-MOVE] çµ±åˆé€šçŸ¥é€ä¿¡å®Œäº†: ${notifyUsersList.length}äººã«1ã¤ã®é€šçŸ¥`);
                } else {
                    console.log('ğŸ“ [SLACK-MOVE] é€šçŸ¥å¯¾è±¡è€…ãªã—ã€é€šçŸ¥é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                }
                
            } catch (error) {
                console.error('âŒ [SLACK-MOVE] Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚¿ã‚¹ã‚¯å‰Šé™¤æ©Ÿèƒ½ï¼ˆã‚´ãƒŸç®±ç§»å‹•ï¼‰
        async function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼šä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã®ã¿å‰Šé™¤å¯èƒ½
            const currentUser = getCurrentUser();
            if (currentUser.role === 'user') {
                const canDelete = task.assignees && task.assignees.includes(currentUser.name) || 
                                 task.assignee === currentUser.name;
                if (!canDelete) {
                    alert('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚è‡ªåˆ†ãŒæ‹…å½“è€…ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®ã¿å‰Šé™¤å¯èƒ½ã§ã™ã€‚');
                    return;
                }
            }
            
            const result = confirm(
                `ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                `ã‚¿ã‚¹ã‚¯: ${task.title}\n\n` +
                `â€» ã‚´ãƒŸç®±ã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å¾©å…ƒå¯èƒ½ã§ã™\n` +
                `â€» ã‚´ãƒŸç®±ã§180æ—¥çµŒéå¾Œã«è‡ªå‹•å®Œå…¨å‰Šé™¤ã•ã‚Œã¾ã™`
            );
            
            if (result) {
                // ã‚´ãƒŸç®±ã«ç§»å‹•
                const previousColumn = task.columnId;
                task.columnId = 'trash';
                task.deletedAt = new Date().toISOString();
                task.previousColumn = previousColumn; // å¾©å…ƒç”¨
                
                saveTasks();
                render();
                updateStats();
                
                // ã‚´ãƒŸç®±ã®è‡ªå‹•å‰Šé™¤ãƒã‚§ãƒƒã‚¯
                cleanupTrash();
                
                console.log(`ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã—ãŸ`);
                
                // å‰Šé™¤é€šçŸ¥
                showNotification(
                    'ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯å‰Šé™¤',
                    `ã€Œ${task.title}ã€ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã—ãŸ`,
                    { tag: `delete-${Date.now()}` }
                );
            }
        }
        
        // ã‚´ãƒŸç®±ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
        function cleanupTrash() {
            const now = new Date();
            const oneEightyDaysAgo = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);

            const trashTasks = tasks.filter(t => t.columnId === 'trash');
            const expiredTasks = trashTasks.filter(t => {
                if (!t.deletedAt) return false;
                return new Date(t.deletedAt) < oneEightyDaysAgo;
            });

            if (expiredTasks.length > 0) {
                // 180æ—¥çµŒéã—ãŸã‚¿ã‚¹ã‚¯ã‚’å®Œå…¨å‰Šé™¤
                tasks = tasks.filter(t => !expiredTasks.includes(t));
                saveTasks();

                console.log(`ğŸ§¹ ã‚´ãƒŸç®±ã‹ã‚‰${expiredTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•å‰Šé™¤ã—ã¾ã—ãŸ`);

                // å‰Šé™¤é€šçŸ¥
                if (expiredTasks.length > 0) {
                    showNotification(
                        'ğŸ§¹ è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—',
                        `ã‚´ãƒŸç®±ã‹ã‚‰${expiredTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ180æ—¥çµŒéï¼‰`,
                        { tag: `cleanup-${Date.now()}` }
                    );
                }
            }
            
            // ã‚´ãƒŸç®±ãŒ20ä»¶ã‚’è¶…ãˆãŸå ´åˆã®è­¦å‘Š
            const remainingTrashTasks = tasks.filter(t => t.columnId === 'trash');
            if (remainingTrashTasks.length > 20) {
                console.log(`âš ï¸ ã‚´ãƒŸç®±ã«${remainingTrashTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™`);
            }
        }
        
        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleHamburgerMenu() {
            console.log('ğŸ” ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆé–‹å§‹...');
            
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            
            if (!hamburgerMenu) {
                console.error('âŒ hamburger-menuè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            if (!menuOverlay) {
                console.error('âŒ menu-overlayè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const isActive = hamburgerMenu.classList.contains('active');
            
            if (isActive) {
                hamburgerMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                console.log('ğŸ” ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã¾ã—ãŸ');
            } else {
                hamburgerMenu.classList.add('active');
                menuOverlay.classList.add('active');
                console.log('ğŸ” ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸ');
            }
        }
        
        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ›´æ–°
        function updateHamburgerMenu() {
            const currentUser = getCurrentUser();
            console.log('ğŸ” ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°ä¸­:', currentUser);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const avatar = document.getElementById('user-menu-avatar');
            const name = document.getElementById('user-menu-name');
            const role = document.getElementById('user-menu-role');
            
            if (avatar) avatar.textContent = currentUser.name ? currentUser.name.charAt(0) : '-';
            if (name) name.textContent = currentUser.name || 'ã‚²ã‚¹ãƒˆ';
            
            let roleText = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            if (currentUser.role === 'developer') roleText = 'é–‹ç™ºè€…';
            else if (currentUser.role === 'admin') roleText = 'ç®¡ç†è€…';
            else if (currentUser.role === 'guest') roleText = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
            if (role) role.textContent = roleText;
            
            // é–‹ç™ºè€…æ©Ÿèƒ½ã®è¡¨ç¤ºåˆ¶å¾¡
            const developerSection = document.getElementById('developer-menu-section');
            if (developerSection) {
                if (currentUser.role === 'developer') {
                    developerSection.style.display = 'block';
                } else {
                    developerSection.style.display = 'none';
                }
            }
            
            // è¨ºæ–­ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆå®Œå…¨ç„¡åŠ¹åŒ–ï¼‰
            const diagnosisBtn = document.getElementById('emergency-diagnosis-btn');
            if (diagnosisBtn) {
                diagnosisBtn.style.display = 'none';
                console.log('ğŸ”§ [MENU] è¨ºæ–­ãƒœã‚¿ãƒ³ã‚’å®Œå…¨éè¡¨ç¤º');
            }
            
            // ç®¡ç†æ©Ÿèƒ½ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«é–¢ä¿‚ãªãï¼‰
            const adminSection = document.getElementById('admin-menu-section');
            console.log('ğŸ” [DEBUG] adminSection found:', !!adminSection);
            if (adminSection) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯adminä»¥ä¸Šã®ã¿
                const userManagementLink = adminSection.querySelector('a[href="user-management.html"]');
                const adminDashboardLink = adminSection.querySelector('a[href="admin-dashboard.html"]');
                
                console.log('ğŸ” [DEBUG] Links found:', {
                    userManagement: !!userManagementLink,
                    adminDashboard: !!adminDashboardLink,
                    userRole: currentUser.role
                });
                
                if (currentUser.role === 'developer' || currentUser.role === 'admin') {
                    adminSection.style.display = 'block';
                    if (userManagementLink) userManagementLink.style.display = 'block';
                    if (adminDashboardLink) adminDashboardLink.style.display = 'block';
                    console.log('ğŸ” ç®¡ç†æ©Ÿèƒ½ã‚’è¡¨ç¤º:', currentUser.role);
                } else {
                    adminSection.style.display = 'none';
                    console.log('ğŸ” ç®¡ç†æ©Ÿèƒ½ã‚’éè¡¨ç¤º:', currentUser.role);
                }
            } else {
                console.error('ğŸ” [ERROR] admin-menu-section not found in DOM');
            }
        }
        
        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.updateHamburgerMenu = updateHamburgerMenu;
        
        
        
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('currentSession');
                window.location.href = 'login.html';
            }
        }
        
        // ğŸ”¥ æ©Ÿèƒ½æ”¹å–„æ›¸ã¯å‰Šé™¤æ¸ˆã¿

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function handleFileImport(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            console.log(`ğŸ“ [IMPORT] ${files.length} files selected`);
            
            for (let file of files) {
                const fileType = file.type;
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
                    // CSVãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
                    importCSV(file);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    // Excelãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
                    alert('Excelå½¢å¼ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ç¾åœ¨å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                } else if (fileType.startsWith('image/')) {
                    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆOCRï¼‰
                    importImageWithOCR(file);
                } else {
                    alert(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${file.name}`);
                }
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            event.target.value = '';
        }
        
        // CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function importCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                        return;
                    }
                    
                    // ç°¡å˜ãªCSVè§£æï¼ˆã‚¿ã‚¹ã‚¯å, æœŸé™, æ‹…å½“è€…, å„ªå…ˆåº¦, ãƒ¡ãƒ¢ã®é †ï¼‰
                    let importedCount = 0;
                    const currentTime = new Date();
                    
                    for (let i = 1; i < lines.length; i++) {
                        const columns = lines[i].split(',').map(col => col.trim().replace(/"/g, ''));
                        
                        if (columns.length >= 1 && columns[0]) {
                            const taskTitle = columns[0];
                            const deadline = columns[1] || new Date(currentTime.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                            const assignee = columns[2] || getCurrentUser().name;
                            const priority = columns[3] || 'medium';
                            const memo = columns[4] || '';
                            
                            const newTask = {
                                id: Date.now() + i,
                                title: taskTitle,
                                deadline: new Date(deadline + 'T23:59:59').toISOString(),
                                priority: ['high', 'medium', 'low'].includes(priority) ? priority : 'medium',
                                assignees: [assignee],
                                assignee: assignee,
                                memo: memo,
                                columnId: 'todo',
                                completed: false,
                                createdAt: new Date().toISOString(),
                                comments: [],
                                attachments: [],
                                // ã‚¿ã‚¹ã‚¯éè¡¨ç¤ºæ©Ÿèƒ½
                                isHidden: false
                            };
                            
                            tasks.unshift(newTask);
                            importedCount++;
                        }
                    }
                    
                    if (importedCount > 0) {
                        saveTasks();
                        render();
                        alert(`${importedCount}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
                    } else {
                        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                    
                } catch (error) {
                    console.error('CSV import error:', error);
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };
            reader.readAsText(file);
        }
        
        // ç”»åƒOCRã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function importImageWithOCR(file) {
            if (typeof Tesseract === 'undefined') {
                alert('ç”»åƒèª­ã¿å–ã‚Šæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // OCRå‡¦ç†ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                const loadingMsg = alert('ç”»åƒã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿å–ã‚Šä¸­...');
                
                Tesseract.recognize(imageData, 'jpn+eng')
                    .then(result => {
                        const text = result.data.text.trim();
                        if (text) {
                            // èª­ã¿å–ã£ãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
                            const newTask = {
                                id: Date.now(),
                                title: `ğŸ“· ${file.name}ã‹ã‚‰èª­ã¿å–ã‚Š`,
                                deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                                priority: 'medium',
                                assignees: [getCurrentUser().name],
                                assignee: getCurrentUser().name,
                                memo: `ç”»åƒã‹ã‚‰èª­ã¿å–ã£ãŸãƒ†ã‚­ã‚¹ãƒˆ:\n${text}`,
                                columnId: 'todo',
                                completed: false,
                                createdAt: new Date().toISOString(),
                                comments: [],
                                attachments: [],
                                // ã‚¿ã‚¹ã‚¯éè¡¨ç¤ºæ©Ÿèƒ½
                                isHidden: false
                            };
                            
                            tasks.unshift(newTask);
                            saveTasks();
                            render();
                            alert(`ç”»åƒã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ:\n${text.substring(0, 100)}...`);
                        } else {
                            alert('ç”»åƒã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                        }
                    })
                    .catch(error => {
                        console.error('OCR error:', error);
                        alert('ç”»åƒã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
            };
            reader.readAsDataURL(file);
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.checkTaskEvidence = checkTaskEvidence;
        window.promptForEvidence = promptForEvidence;
        window.testSlackNotification = testSlackNotification;
        window.testNotification = testNotification;

        // ğŸ”¥ [DELETED] toggleTaskSkipModal - å¤ã„previewTaskså®Ÿè£…ã®æ®‹éª¸ã‚’å‰Šé™¤
        // ï¼ˆæ–°ã—ã„previewTasksModalå®Ÿè£…ã§ã¯ä¸è¦ï¼‰

        // ğŸ”¥ [DELETED] executeImportFromModal ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ã‚’å‰Šé™¤ï¼ˆL13136ã®æ­£è¦å®Ÿè£…ã‚’ä½¿ç”¨ï¼‰

        // ===== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†æ©Ÿèƒ½ =====
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openProjectManagementModal() {
            const modal = document.getElementById('projectManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                loadNewProjectColumns(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰
                loadProjectsList();
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeProjectManagementModal() {
            const modal = document.getElementById('projectManagementModal');
            if (modal) {
                modal.style.display = 'none';
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('newProjectName').value = '';
                document.getElementById('newProjectDescription').value = '';
                document.getElementById('newProjectVisibility').value = 'public';
            }
        }

        // ===== ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½ =====

        // ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openAdminDashboardModal() {
            const modal = document.getElementById('adminDashboardModal');
            if (modal) {
                modal.style.display = 'flex';
                loadDashboardData();
            }
        }

        // ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeAdminDashboardModal() {
            const modal = document.getElementById('adminDashboardModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadDashboardData() {
            try {
                // ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
                let tasks = [];
                if (window.FirebaseDB?.getTasks) {
                    const result = await window.FirebaseDB.getTasks();
                    if (result.success) {
                        tasks = result.tasks;
                    }
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');

                // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯
                const now = new Date();
                const overdueTasks = tasks.filter(task =>
                    task.deadline && new Date(task.deadline) < now && task.columnId !== 'done'
                );

                // åœæ»ã‚¿ã‚¹ã‚¯ï¼ˆ3æ—¥ä»¥ä¸ŠåŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
                const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
                const staleTasks = tasks.filter(task =>
                    task.lastMovedAt && new Date(task.lastMovedAt) < threeDaysAgo && task.columnId !== 'done'
                );

                // UIæ›´æ–°
                document.getElementById('dashboard-overdue-count').textContent = overdueTasks.length;
                document.getElementById('dashboard-stale-count').textContent = staleTasks.length;
                document.getElementById('dashboard-total-tasks').textContent = tasks.length;
                document.getElementById('dashboard-active-users').textContent = users.length;

                // FirebaseçŠ¶æ…‹ç¢ºèª
                const firebaseStatus = window.firebaseAuth?.currentUser ? 'ğŸŸ¢ æ¥ç¶šä¸­' : 'ğŸ”´ æœªæ¥ç¶š';
                document.getElementById('dashboard-firebase-status').textContent = firebaseStatus;

                // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
                const performanceContent = document.getElementById('dashboard-performance-content');
                const userStats = {};

                tasks.forEach(task => {
                    if (task.assignee && task.assignee !== 'æœªè¨­å®š') {
                        if (!userStats[task.assignee]) {
                            userStats[task.assignee] = { total: 0, completed: 0 };
                        }
                        userStats[task.assignee].total++;
                        if (task.columnId === 'done') {
                            userStats[task.assignee].completed++;
                        }
                    }
                });

                performanceContent.innerHTML = Object.entries(userStats)
                    .map(([user, stats]) => {
                        const completion = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
                                <span>${user}:</span>
                                <span style="font-weight: 600; font-size: 1.1rem; color: #026aa7;">${completion}% (${stats.completed}/${stats.total})</span>
                            </div>
                        `;
                    }).join('');

            } catch (error) {
                console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ =====

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openUserManagementModal() {
            const modal = document.getElementById('userManagementModal');
            const iframe = document.getElementById('userManagementFrame');
            if (modal && iframe) {
                iframe.src = 'user-management.html';
                modal.style.display = 'flex';
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeUserManagementModal() {
            const modal = document.getElementById('userManagementModal');
            const iframe = document.getElementById('userManagementFrame');
            if (modal) {
                modal.style.display = 'none';
                if (iframe) {
                    iframe.src = ''; // iframeã‚’ã‚¯ãƒªã‚¢
                }
            }
        }

        // ===== ãƒã‚¤ãƒšãƒ¼ã‚¸æ©Ÿèƒ½ =====

        // ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openMyProfileModal() {
            const modal = document.getElementById('myProfileModal');
            const iframe = document.getElementById('myProfileFrame');
            if (modal && iframe) {
                iframe.src = 'my-profile.html';
                modal.style.display = 'flex';
            }
        }

        // ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeMyProfileModal() {
            const modal = document.getElementById('myProfileModal');
            const iframe = document.getElementById('myProfileFrame');
            if (modal) {
                modal.style.display = 'none';
                if (iframe) {
                    iframe.src = ''; // iframeã‚’ã‚¯ãƒªã‚¢
                }
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆFirebaseå¯¾å¿œï¼‰
        async function loadProjectsList(forceRefresh = false) {
            try {
                const projectsList = document.getElementById('projectsList');
                if (!projectsList) return;

                // ğŸ”¥ Firebaseçµ±åˆ: Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ï¼ˆLocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤ï¼‰
                let projects = [];
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    console.log('ğŸ“‚ [PROJECTS] Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—é–‹å§‹...', forceRefresh ? '(å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥)' : '');
                    const result = await window.FirebaseDB.getProjects(forceRefresh);
                    if (result.success) {
                        projects = result.projects || [];
                        console.log(`âœ… [PROJECTS] Firebaseå–å¾—æˆåŠŸ: ${projects.length}ä»¶`);

                        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                        updateProjectsCache();
                    } else {
                        console.error('âŒ [PROJECTS] Firebaseå–å¾—å¤±æ•—:', result.error);
                        // ğŸ”¥ LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤ - ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®ã¿
                        projects = [];
                        console.warn('âš ï¸ [PROJECTS] Firebaseæœªæ¥ç¶šã®ãŸã‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“');
                    }
                } else {
                    // ğŸ”¥ LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤ - ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®ã¿
                    projects = [];
                    console.error('âŒ [PROJECTS] Firebaseæœªæ¥ç¶šã®ãŸã‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“');
                }

                const currentUser = getCurrentUser();

                if (projects.length === 0) {
                    projectsList.innerHTML = `
                        <div style="text-align: center; color: #6b7280; padding: 2rem; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb;">
                            ğŸ“‚ ã¾ã ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“<br>
                            <span style="font-size: 0.9rem;">æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãƒãƒ¼ãƒ ä½œæ¥­ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</span>
                        </div>
                    `;
                    return;
                }
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
                projectsList.innerHTML = projects.map(project => {
                    const isOwner = project.createdBy === currentUser.email;
                    // ğŸ”¥ membersãŒæ–‡å­—åˆ—ã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
                    const membersArray = Array.isArray(project.members) ? project.members : [project.members];
                    const isMember = membersArray.includes(currentUser.email);
                    const canView = project.visibility === 'public' || isMember || isOwner;
                    
                    if (!canView) return '';
                    
                    const visibilityIcon = project.visibility === 'public' ? 'ğŸŒ' : 'ğŸ”’';
                    const statusIcon = project.status === 'active' ? 'ğŸŸ¢' : project.status === 'completed' ? 'âœ…' : 'ğŸ“';
                    
                    return `
                        <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        ${statusIcon} ${project.name}
                                        ${visibilityIcon}
                                        ${isOwner ? '<span style="background: #fbbf24; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">ä½œæˆè€…</span>' : ''}
                                    </h5>
                                    <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.9rem;">${project.description || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã¯ã‚ã‚Šã¾ã›ã‚“'}</p>
                                    <div style="font-size: 0.8rem; color: #9ca3af;">
                                        ãƒ¡ãƒ³ãƒãƒ¼: ${membersArray.length}å | ä½œæˆ: ${new Date(project.createdAt).toLocaleDateString('ja-JP')}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                    <button onclick="viewProjectTasks('${project.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                        ğŸ“‹ ã‚¿ã‚¹ã‚¯è¡¨ç¤º
                                    </button>
                                    ${(isOwner || currentUser.role === 'developer') ? `
                                        <button onclick="editProject('${project.id}')" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                            âœï¸ ç·¨é›†
                                        </button>
                                        <button onclick="deleteProject('${project.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                            ğŸ—‘ï¸ å‰Šé™¤
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼:</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${membersArray.map(email => {
                                        const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                                        const user = systemUsers.find(u => u.email === email);
                                        const userName = user ? user.name : email;
                                        return `<span style="background: #f3f4f6; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${userName}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).filter(html => html).join('');
                
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('projectsList').innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 1rem;">
                        ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}
                    </div>
                `;
            }
        }

        // ğŸ”§ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ 
        const DEFAULT_PROJECT_COLUMNS = ["ğŸ“‹ TODO", "ğŸ”„ é€²è¡Œä¸­", "âœ… å®Œäº†", "ğŸ—‘ï¸ ã‚´ãƒŸç®±"];

        // ğŸ”§ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚«ãƒ©ãƒ ç®¡ç†é–¢æ•°
        function loadNewProjectColumns(columns = DEFAULT_PROJECT_COLUMNS) {
            const container = document.getElementById('newProjectColumnsContainer');
            if (!container) return;

            container.innerHTML = columns.map((column, index) => `
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span style="cursor: move; color: #9ca3af; font-size: 1.2rem;" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ">â‹®â‹®</span>
                    <input type="text" value="${column}"
                           style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                    <button type="button" onclick="removeNewProjectColumn(${index})"
                            style="background: #ef4444; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                            ${columns.length <= 1 ? 'disabled' : ''}>
                        âœ•
                    </button>
                </div>
            `).join('');
        }

        function addNewProjectColumn() {
            const currentColumns = getNewProjectColumns();
            currentColumns.push('æ–°ã—ã„ã‚«ãƒ©ãƒ ');
            loadNewProjectColumns(currentColumns);
        }

        function removeNewProjectColumn(index) {
            const currentColumns = getNewProjectColumns();
            if (currentColumns.length <= 1) {
                alert('æœ€ä½1ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                return;
            }
            currentColumns.splice(index, 1);
            loadNewProjectColumns(currentColumns);
        }

        function getNewProjectColumns() {
            const container = document.getElementById('newProjectColumnsContainer');
            if (!container) return DEFAULT_PROJECT_COLUMNS;

            const inputs = container.querySelectorAll('input[type="text"]');
            return Array.from(inputs).map(input => input.value.trim()).filter(val => val);
        }

        // ğŸ”§ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚«ãƒ©ãƒ ç®¡ç†é–¢æ•°
        function loadEditProjectColumns(columns = DEFAULT_PROJECT_COLUMNS) {
            const container = document.getElementById('editProjectColumnsContainer');
            if (!container) return;

            container.innerHTML = columns.map((column, index) => `
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span style="cursor: move; color: #9ca3af; font-size: 1.2rem;" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ">â‹®â‹®</span>
                    <input type="text" value="${column}"
                           style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                    <button type="button" onclick="removeEditProjectColumn(${index})"
                            style="background: #ef4444; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                            ${columns.length <= 1 ? 'disabled' : ''}>
                        âœ•
                    </button>
                </div>
            `).join('');
        }

        function addEditProjectColumn() {
            const currentColumns = getEditProjectColumns();
            currentColumns.push('æ–°ã—ã„ã‚«ãƒ©ãƒ ');
            loadEditProjectColumns(currentColumns);
        }

        function removeEditProjectColumn(index) {
            const currentColumns = getEditProjectColumns();
            if (currentColumns.length <= 1) {
                alert('æœ€ä½1ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                return;
            }
            currentColumns.splice(index, 1);
            loadEditProjectColumns(currentColumns);
        }

        function getEditProjectColumns() {
            const container = document.getElementById('editProjectColumnsContainer');
            if (!container) return DEFAULT_PROJECT_COLUMNS;

            const inputs = container.querySelectorAll('input[type="text"]');
            return Array.from(inputs).map(input => input.value.trim()).filter(val => val);
        }

        // æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        async function createNewProject() {
            try {
                const name = document.getElementById('newProjectName').value.trim();
                const description = document.getElementById('newProjectDescription').value.trim();
                const visibility = document.getElementById('newProjectVisibility').value;
                const columns = getNewProjectColumns();
                const currentUser = getCurrentUser();

                if (!name) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (columns.length === 0) {
                    alert('æœ€ä½1ã¤ã®ã‚«ãƒ©ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }

                if (!currentUser.isLoggedIn) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }

                // ğŸ”¥ é‡è¤‡ãƒã‚§ãƒƒã‚¯å¼·åŒ–: Firebaseã‹ã‚‰æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                console.log('ğŸ” [PROJECT CREATE] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåé‡è¤‡ãƒã‚§ãƒƒã‚¯é–‹å§‹:', name);
                let existingProjects = [];

                if (window.FirebaseDB?.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        existingProjects = result.projects;
                        console.log(`ğŸ” [PROJECT CREATE] Firebase: ${existingProjects.length}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºèª`);
                    }
                }

                // ğŸ”¥ [REMOVED] LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‰Šé™¤ï¼ˆFirebaseå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼‰

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆå¤§æ–‡å­—å°æ–‡å­—åŒºåˆ¥ãªã—ï¼‰
                const duplicateProject = existingProjects.find(p => p.name.toLowerCase() === name.toLowerCase());
                if (duplicateProject) {
                    console.warn('âš ï¸ [PROJECT CREATE] é‡è¤‡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º:', duplicateProject.name, `(ID: ${duplicateProject.id})`);
                    alert(`âŒ åŒã˜åå‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™\n\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: ${duplicateProject.name}\n\nåˆ¥ã®åå‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }

                console.log('âœ… [PROJECT CREATE] é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Œäº†: å•é¡Œãªã—');

                const newProject = {
                    id: 'project_' + Date.now(),
                    name: name,
                    description: description,
                    visibility: visibility,
                    columns: columns,
                    members: [currentUser.email], // ä½œæˆè€…ã¯è‡ªå‹•çš„ã«ãƒ¡ãƒ³ãƒãƒ¼ã«ãªã‚‹
                    createdBy: currentUser.email,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                };

                // Firebaseã«ä¿å­˜ï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªï¼‰
                if (window.FirebaseDB?.saveProject && window.getCurrentUser()?.isLoggedIn) {
                    console.log('ğŸ”¥ [PROJECT SAVE] Firebaseã«æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ä¸­...');
                    const saveResult = await window.FirebaseDB.saveProject(newProject);
                    if (saveResult.success) {
                        console.log('âœ… [PROJECT SAVE] Firebaseä¿å­˜æˆåŠŸ:', saveResult.id);
                    } else {
                        console.error('âŒ [PROJECT SAVE] Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', saveResult.error);
                        alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + saveResult.error);
                        return;
                    }
                } else {
                    // ğŸ”¥ LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯å‰Šé™¤ï¼ˆFirebaseã®ã¿ä½¿ç”¨ï¼‰
                    console.error('âŒ [PROJECT SAVE] Firebaseæœªæ¥ç¶šã®ãŸã‚ä¿å­˜ã§ãã¾ã›ã‚“');
                    alert('Firebaseæœªæ¥ç¶šã®ãŸã‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã€‚');
                    return;
                }

                console.log('âœ… æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ:', newProject.name, `(ID: ${newProject.id})`);

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                document.getElementById('newProjectName').value = '';
                document.getElementById('newProjectDescription').value = '';
                document.getElementById('newProjectVisibility').value = 'public';
                loadNewProjectColumns(); // ã‚«ãƒ©ãƒ ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ

                await loadProjectsList();

                alert(`âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼`);

            } catch (error) {
                console.error('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
        async function viewProjectTasks(projectId) {
            try {
                closeProjectManagementModal();

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
                const filterDropdown = document.getElementById('project-filter');
                if (filterDropdown) {
                    filterDropdown.value = projectId;
                    applyProjectFilter();
                } else {
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã®ã¿ã‚’è¡¨ç¤º
                    await filterTasksByProject(projectId);
                }

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
                await showProjectInfo(projectId);

            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚¿ã‚¹ã‚¯ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        async function filterTasksByProject(projectId) {
            try {
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (!window.FirebaseDB || !currentUser) {
                    console.warn('âš ï¸ [FILTER] Firebaseæœªæ¥ç¶š - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }

                // ğŸ”¥ selectedProjectFiltersé…åˆ—ã‚’æ›´æ–°ï¼ˆrender()ãŒå‚ç…§ï¼‰
                selectedProjectFilters = [projectId];
                localStorage.setItem('currentProject', projectId);
                console.log('ğŸ“‹ [FILTER] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨:', projectId);

                // ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚“ã§å†æç”»
                await loadTasks();
                render();
            } catch (error) {
                console.error('âŒ [FILTER] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
        async function showProjectInfo(projectId) {
            // ğŸ”¥ Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
            if (!window.FirebaseDB) {
                console.warn('âš ï¸ Firebaseæœªæ¥ç¶š');
                return;
            }

            const result = await window.FirebaseDB.getProjects();
            if (!result.success) {
                console.error('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—å¤±æ•—:', result.error);
                return;
            }

            const project = result.projects.find(p => p.id === projectId);

            if (project) {
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
                const header = document.querySelector('.header h1');
                if (header) {
                    header.innerHTML = `ğŸ“‚ ${project.name} - ã‚¿ã‚¹ã‚¯ç®¡ç†`;
                }

                console.log(`ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤ºä¸­`);
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†
        async function editProject(projectId) {
            try {
                // ğŸ”¥ Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                if (!window.FirebaseDB) {
                    alert('Firebaseæœªæ¥ç¶š');
                    return;
                }

                const result = await window.FirebaseDB.getProjects();
                if (!result.success) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                const project = result.projects.find(p => p.id === projectId);

                if (!project) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                const currentUser = getCurrentUser();
                const isOwner = project.createdBy === currentUser.email;
                const isDeveloper = currentUser.role === 'developer';

                if (!isOwner && !isDeveloper) {
                    alert('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showProjectEditModal(project);

            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showProjectEditModal(project) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 2100;
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;
            
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const memberOptions = systemUsers.map(user => {
                const isSelected = project.members.includes(user.email);
                return `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${isSelected ? '#dbeafe' : '#f9fafb'}; border-radius: 6px; margin-bottom: 0.5rem;">
                        <input type="checkbox" value="${user.email}" ${isSelected ? 'checked' : ''} style="margin: 0;">
                        <span>${user.name} (${user.email})</span>
                    </label>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 80vh; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.25rem;">âœï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†</h3>
                        <button onclick="this.closest('div').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>
                    
                    <div style="padding: 1.5rem; overflow-y: auto; max-height: 60vh;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                            <input type="text" id="editProjectName" value="${project.name}" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">èª¬æ˜</label>
                            <textarea id="editProjectDescription" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; height: 80px; resize: vertical;">${project.description}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">å…¬é–‹è¨­å®š</label>
                            <select id="editProjectVisibility" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="public" ${project.visibility === 'public' ? 'selected' : ''}>ğŸŒ å…¨å“¡ã«å…¬é–‹</option>
                                <option value="private" ${project.visibility === 'private' ? 'selected' : ''}>ğŸ”’ ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="editProjectStatus" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="active" ${project.status === 'active' ? 'selected' : ''}>ğŸŸ¢ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
                                <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>âœ… å®Œäº†</option>
                                <option value="archived" ${project.status === 'archived' ? 'selected' : ''}>ğŸ“ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼</label>
                            <div id="membersList" style="max-height: 200px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                                ${memberOptions}
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ã‚«ãƒ©ãƒ è¨­å®š</label>
                            <div id="editProjectColumnsContainer" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <!-- ã‚«ãƒ©ãƒ ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                            </div>
                            <button type="button" onclick="addEditProjectColumn()" style="background: #e5e7eb; color: #374151; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 500;">
                                â• ã‚«ãƒ©ãƒ è¿½åŠ 
                            </button>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="this.closest('div').remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button onclick="saveProjectChanges('${project.id}', this.closest('div'))" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;">
                                ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ã‚«ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã‚€
            const projectColumns = project.columns || DEFAULT_PROJECT_COLUMNS;
            loadEditProjectColumns(projectColumns);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å¤‰æ›´ã‚’ä¿å­˜
        async function saveProjectChanges(projectId, modalElement) {
            try {
                const name = document.getElementById('editProjectName').value.trim();
                const description = document.getElementById('editProjectDescription').value.trim();
                const visibility = document.getElementById('editProjectVisibility').value;
                const status = document.getElementById('editProjectStatus').value;
                const columns = getEditProjectColumns();

                // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
                const memberCheckboxes = modalElement.querySelectorAll('#membersList input[type="checkbox"]');
                const members = Array.from(memberCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);

                if (!name) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (columns.length === 0) {
                    alert('æœ€ä½1ã¤ã®ã‚«ãƒ©ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }

                if (members.length === 0) {
                    alert('å°‘ãªãã¨ã‚‚1äººã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                // ğŸ”¥ Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—
                let existingProject = null;
                if (window.FirebaseDB && window.FirebaseDB.getProjects) {
                    const result = await window.FirebaseDB.getProjects();
                    if (result.success) {
                        existingProject = result.projects.find(p => p.id === projectId);
                    }
                }

                if (!existingProject) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’æ›´æ–°
                const updatedProject = {
                    ...existingProject,
                    name: name,
                    description: description,
                    visibility: visibility,
                    status: status,
                    columns: columns,
                    members: members,
                    updatedAt: new Date().toISOString()
                };

                // ğŸ”¥ Firebaseã«ä¿å­˜
                if (window.FirebaseDB && window.FirebaseDB.saveProject) {
                    console.log('ğŸ”¥ [PROJECT UPDATE] Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ä¸­...');
                    const result = await window.FirebaseDB.saveProject(updatedProject);
                    if (result.success) {
                        console.log('âœ… [PROJECT UPDATE] Firebaseæ›´æ–°æˆåŠŸ:', result.id);
                        modalElement.remove();
                        await loadProjectsList();
                        alert(`âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${name}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`);
                    } else {
                        console.error('âŒ [PROJECT UPDATE] Firebaseæ›´æ–°ã‚¨ãƒ©ãƒ¼:', result.error);
                        alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
                    }
                } else {
                    alert('Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ãŒã§ãã¾ã›ã‚“');
                }
                
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
        async function deleteProject(projectId) {
            try {
                // ğŸ”¥ Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                if (!window.FirebaseDB || !window.FirebaseDB.getProjects) {
                    alert('Firebaseæœªæ¥ç¶šã®ãŸã‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã§ãã¾ã›ã‚“');
                    return;
                }

                const result = await window.FirebaseDB.getProjects();
                if (!result.success) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                const project = result.projects.find(p => p.id === projectId);
                if (!project) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const currentUser = getCurrentUser();
                const isOwner = project.createdBy === currentUser.email;
                const isDeveloper = currentUser.role === 'developer';
                
                if (!isOwner && !isDeveloper) {
                    alert('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                if (!confirm(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚‚ç¢ºèªãŒå¿…è¦ã§ã™ã€‚`)) {
                    return;
                }
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
                const tasksResult = await window.FirebaseDB.getTasks();
                const allTasks = tasksResult.success ? tasksResult.tasks : [];
                const projectTasks = allTasks.filter(task => task.projectId === projectId);

                if (projectTasks.length > 0) {
                    const action = confirm(`ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯${projectTasks.length}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚\n\nã€ŒOKã€: ã‚¿ã‚¹ã‚¯ã‚‚ä¸€ç·’ã«å‰Šé™¤\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿å‰Šé™¤ï¼ˆã‚¿ã‚¹ã‚¯ã¯å€‹äººã‚¿ã‚¹ã‚¯ã«å¤‰æ›´ï¼‰`);

                    if (action) {
                        // ã‚¿ã‚¹ã‚¯ã‚‚ä¸€ç·’ã«å‰Šé™¤
                        for (const task of projectTasks) {
                            const taskId = task.firebaseId || task.id;
                            await window.FirebaseDB.deleteTask(taskId);
                        }
                        console.log(`ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯${projectTasks.length}å€‹ã‚’å‰Šé™¤`);
                    } else {
                        // ã‚¿ã‚¹ã‚¯ã‚’å€‹äººã‚¿ã‚¹ã‚¯ã«å¤‰æ›´
                        for (const task of projectTasks) {
                            const taskId = task.firebaseId || task.id;
                            delete task.projectId;
                            task.visibility = 'personal';
                            task.columnId = 'todo'; // å€‹äººã‚¿ã‚¹ã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ 
                            await window.FirebaseDB.updateTask(taskId, {
                                projectId: null,
                                visibility: 'personal',
                                columnId: 'todo',
                                updatedAt: new Date().toISOString()
                            });
                        }
                        console.log(`ğŸ”„ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯${projectTasks.length}å€‹ã‚’å€‹äººã‚¿ã‚¹ã‚¯ã«å¤‰æ›´`);
                    }
                }

                // ğŸ”¥ Firebaseã‹ã‚‰å‰Šé™¤
                if (window.FirebaseDB && window.FirebaseDB.deleteProject) {
                    const result = await window.FirebaseDB.deleteProject(projectId);
                    if (result.success) {
                        console.log('ğŸ—‘ï¸ [DELETE] Firebaseå‰Šé™¤æˆåŠŸ:', projectId);
                    } else {
                        console.error('âŒ [DELETE] Firebaseå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', result.error);
                        throw new Error(result.error);
                    }
                } else {
                    throw new Error('FirebaseDB.deleteProjectãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                console.log('ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤:', project.name);

                loadProjectsList(true); // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„ï¼‰
                loadTasks(); // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°
                
                alert(`ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ========================================
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£æ©Ÿèƒ½
        // ========================================

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openProjectTaskCreateModal() {
            console.log('ğŸ‘¥ [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã');
            const modal = document.getElementById('project-task-create-modal');
            modal.style.display = 'flex';

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('pj-task-form').reset();
            setPJDefaultDeadline();

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã¨æ‹…å½“è€…ã‚’èª­ã¿è¾¼ã¿
            loadPJExistingProjects();
            loadPJAssignees();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeProjectTaskCreateModal() {
            console.log('ğŸ‘¥ [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹');
            const modal = document.getElementById('project-task-create-modal');
            modal.style.display = 'none';

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            document.getElementById('pj-task-success-message').style.display = 'none';
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æœŸé™ã‚’è¨­å®š
        function setPJDefaultDeadline() {
            const now = new Date();

            // æ—¥ä»˜ï¼šãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜åŸºæº–ã§ä»Šæ—¥ã‚’è¨­å®š
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            document.getElementById('pj-deadline-date').value = `${year}-${month}-${day}`;

            // æ™‚åˆ»ï¼šç¾åœ¨æ™‚åˆ»+3æ™‚é–“ã‚’è¨­å®š
            let hours = now.getHours() + 3;
            let minutes = now.getMinutes();

            // 24æ™‚é–“ã‚’è¶…ãˆã‚‹å ´åˆã¯23:59ã«åˆ¶é™
            if (hours >= 24) {
                hours = 23;
                minutes = 59;
            }

            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            document.getElementById('pj-deadline-time').value = timeString;
        }

        // æ‹…å½“è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadPJAssignees() {
            console.log('ğŸ‘¥ [PJ-MODAL] æ‹…å½“è€…ä¸€è¦§ã®å‹•çš„èª­ã¿è¾¼ã¿é–‹å§‹');

            let assignees = [];

            // Firebaseçµ±åˆãƒ¢ãƒ¼ãƒ‰: ã‚·ã‚¹ãƒ†ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å–å¾—
            if (window.FirebaseDB && window.getCurrentUser()?.isLoggedIn) {
                console.log('ğŸ”¥ [PJ-MODAL] Firebaseçµ±åˆãƒ¢ãƒ¼ãƒ‰');
                try {
                    if (window.FirebaseDB.getUsers) {
                        const firebaseUsers = await window.FirebaseDB.getUsers();
                        if (firebaseUsers.success && firebaseUsers.users.length > 0) {
                            // LocalStorageã®systemUsersã‚’æ›´æ–°
                            localStorage.setItem('systemUsers', JSON.stringify(firebaseUsers.users));
                            console.log('ğŸ”„ [PJ-MODAL] systemUsersæ›´æ–°å®Œäº†');
                        }
                    }
                } catch (error) {
                    console.error('âŒ [PJ-MODAL] Firebaseå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // getActiveUsersé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–
            const activeUserNames = getActiveUserNames();

            if (activeUserNames.length > 0) {
                assignees = activeUserNames;
                console.log('âœ… [PJ-MODAL] getActiveUsers ã‹ã‚‰å–å¾—:', assignees.length, 'å');
            } else {
                console.log('âš ï¸ [PJ-MODAL] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                assignees = [];
            }

            console.log('ğŸ‘¥ [PJ-MODAL] æœ€çµ‚æ‹…å½“è€…ãƒªã‚¹ãƒˆ:', assignees);

            const assigneesDiv = document.getElementById('pj-assignees');

            // æ—¢å­˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
            assigneesDiv.innerHTML = '';

            if (assignees.length === 0) {
                assigneesDiv.innerHTML = '<p style="color: #718096;">æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>';
            } else {
                assignees.forEach(assignee => {
                    const assigneeItem = createPJCheckboxItem(assignee, 'pj-assignee');
                    assigneesDiv.appendChild(assigneeItem);
                });
            }

            console.log('âœ… [PJ-MODAL] æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆå®Œäº†');
        }

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¦ç´ ã‚’ä½œæˆ
        function createPJCheckboxItem(name, type) {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            div.style.cssText = 'display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #f0f2f5; border-radius: 4px;';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `${type}-${name}`;
            input.name = type;
            input.value = name;

            const label = document.createElement('label');
            label.htmlFor = `${type}-${name}`;
            label.textContent = name;
            label.style.cursor = 'pointer';

            div.appendChild(input);
            div.appendChild(label);

            return div;
        }

        // æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadPJExistingProjects() {
            console.log('ğŸ” [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿é–‹å§‹');

            try {
                const currentUser = window.getCurrentUser ? window.getCurrentUser() : null;
                console.log('ğŸ” [PJ-MODAL] Current user:', currentUser);

                let projectSettings = {};
                let tasks = [];

                // Firebaseçµ±åˆãƒ¢ãƒ¼ãƒ‰: Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                if (window.FirebaseDB) {
                    console.log('ğŸ”¥ [PJ-MODAL] Firebaseçµ±åˆãƒ¢ãƒ¼ãƒ‰ - Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—');

                    // Firebaseã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const firebaseTasks = await window.FirebaseDB.getTasks();
                    if (firebaseTasks.success) {
                        tasks = firebaseTasks.tasks;
                        console.log('ğŸ”¥ [PJ-MODAL] Firebase tasks loaded:', tasks.length);
                    }

                    // èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰Firebaseã‚¢ã‚¯ã‚»ã‚¹
                    if (currentUser && currentUser.isLoggedIn && window.FirebaseDB.getProjects) {
                        console.log('ğŸ”¥ [PJ-MODAL] èªè¨¼æ¸ˆã¿ - Firebaseã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—ä¸­...');
                        try {
                            const firebaseProjects = await window.FirebaseDB.getProjects();
                            if (firebaseProjects.success && firebaseProjects.projects.length > 0) {
                                projectSettings = {};
                                firebaseProjects.projects.forEach(project => {
                                    projectSettings[project.id] = {
                                        name: project.name,
                                        description: project.description || '',
                                        createdAt: project.createdAt,
                                        createdBy: project.createdBy || (currentUser ? currentUser.name : 'Unknown'),
                                        columns: project.columns || ["ğŸ“‹ TODO", "ğŸ”„ é€²è¡Œä¸­", "âœ… å®Œäº†", "ğŸ—‘ï¸ ã‚´ãƒŸç®±"]
                                    };
                                });
                                console.log('ğŸ”¥ [PJ-MODAL] Firebase projects converted:', Object.keys(projectSettings).length);
                            } else {
                                console.log('ğŸ“ [PJ-MODAL] Firebaseã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—');
                            }
                        } catch (firebaseError) {
                            console.error('âŒ [PJ-MODAL] Firebaseå–å¾—ã‚¨ãƒ©ãƒ¼:', firebaseError);
                        }
                    }

                    // ğŸ”¥ [REMOVED] LocalStorageãƒãƒ¼ã‚¸å‡¦ç†ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’å‰Šé™¤ï¼ˆFirebaseå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼‰
                }

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’æ§‹ç¯‰
                const existingProjects = Object.keys(projectSettings)
                    .filter(projectId => {
                        const project = projectSettings[projectId];
                        if (!project || !project.name || project.name.trim() === '') {
                            console.warn(`âš ï¸ [PJ-MODAL] ç„¡åŠ¹ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${projectId}`);
                            return false;
                        }
                        return true;
                    })
                    .map(projectId => {
                        const project = projectSettings[projectId];
                        const projectTasks = tasks.filter(task => task.projectId === projectId);
                        const taskCount = projectTasks.length;

                        return {
                            id: projectId,
                            name: project.name.trim(),
                            description: project.description || '',
                            taskCount: taskCount,
                            createdAt: project.createdAt || new Date().toISOString(),
                            createdBy: project.createdBy || 'Unknown'
                        };
                    })
                    .filter(project => project.name && project.name !== 'undefined' && project.name !== 'null')
                    .sort((a, b) => a.name.localeCompare(b.name));

                const selectElement = document.getElementById('pj-existing-project-select');
                selectElement.innerHTML = '<option value="">-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';

                existingProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = `${project.id}|${project.name}`;
                    option.textContent = `${project.name} (${project.taskCount}ä»¶)`;
                    selectElement.appendChild(option);
                });

                console.log('âœ… [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿å®Œäº†:', existingProjects.length, 'ä»¶');

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®è­¦å‘Š
                if (existingProjects.length === 0) {
                    console.warn('âš ï¸ [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

            } catch (error) {
                console.error('âŒ [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
        function selectExistingProjectInModal() {
            const selectElement = document.getElementById('pj-existing-project-select');
            const selectedValue = selectElement.value;

            if (selectedValue) {
                const [projectId, projectName] = selectedValue.split('|');
                document.getElementById('pj-project-id').value = projectId;
                document.getElementById('pj-project-name').value = projectName;
                console.log(`ğŸ“‚ [PJ-MODAL] æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ: ${projectId} - ${projectName}`);
            } else {
                document.getElementById('pj-project-id').value = '';
                document.getElementById('pj-project-name').value = '';
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
        async function createPJTask(event) {
            event.preventDefault();
            console.log('ğŸ‘¥ [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆé–‹å§‹...');

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã®å¿…é ˆãƒã‚§ãƒƒã‚¯
            const projectId = document.getElementById('pj-project-id').value.trim();
            const projectName = document.getElementById('pj-project-name').value.trim();
            const selectedProject = document.getElementById('pj-existing-project-select').value;

            console.log('ğŸ” [PJ-MODAL] Project validation:');
            console.log('ğŸ” [PJ-MODAL] Selected project:', selectedProject);
            console.log('ğŸ” [PJ-MODAL] Project ID:', projectId);
            console.log('ğŸ” [PJ-MODAL] Project name:', projectName);

            if (!selectedProject || !projectId || !projectName) {
                alert('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é¸æŠã¯å¿…é ˆã§ã™ã€‚\n\nã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã€ã§äº‹å‰ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã‹ã‚‰ã€ã“ã“ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆFirebaseå¯¾å¿œï¼‰
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ã€Firebaseã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«å­˜åœ¨ã™ã‚‹
            console.log('âœ… [PJ-MODAL] Project exists in dropdown - validation passed');

            // ğŸ”¥ Firebaseå¯¾å¿œ: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®tasksé…åˆ—ã‹ã‚‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const taskTitle = document.getElementById('pj-task-title').value.trim();
            const duplicateTask = tasks.find(task =>
                task.projectId === projectId &&
                task.title === taskTitle
            );

            if (duplicateTask) {
                if (!confirm(`âš ï¸ åŒã˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åŒåã®ã‚¿ã‚¹ã‚¯ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼š\n\nã€Œ${duplicateTask.title}ã€\n\nãã‚Œã§ã‚‚ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
            }

            console.log('âœ… [PJ-MODAL] All validations passed');

            // é¸æŠã•ã‚ŒãŸæ‹…å½“è€…ã‚’å–å¾—
            const selectedAssignees = Array.from(document.querySelectorAll('input[name="pj-assignee"]:checked'))
                .map(cb => cb.value);

            if (selectedAssignees.length === 0) {
                alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ğŸ”¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚«ãƒ©ãƒ IDã‚’å–å¾—ï¼ˆæœ€åˆã®ã‚«ãƒ©ãƒ ï¼‰
            const projectColumnId = `pj_${projectId}_0`;
            console.log('ğŸ“ [PJ-MODAL] ä½¿ç”¨ã™ã‚‹ã‚«ãƒ©ãƒ ID:', projectColumnId);

            // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const task = {
                id: Date.now(),
                title: document.getElementById('pj-task-title').value.trim(),
                projectId: projectId,
                projectName: projectName,
                deadline: `${document.getElementById('pj-deadline-date').value}T${document.getElementById('pj-deadline-time').value}`,
                priority: document.getElementById('pj-priority').value,
                assignees: selectedAssignees,
                memo: document.getElementById('pj-memo').value,
                columnId: projectColumnId,  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚«ãƒ©ãƒ IDã‚’ä½¿ç”¨
                createdAt: new Date().toISOString(),
                comments: [],
                attachments: [],
                isProjectTask: true
            };

            console.log('ğŸ‘¥ [PJ-MODAL] æ—¢å­˜ã‚¿ã‚¹ã‚¯æ•°:', tasks.length);

            // ğŸ”¥ Firebaseä¿å­˜
            if (!window.FirebaseDB || !window.firebaseAuth?.currentUser) {
                alert('âŒ Firebaseæœªæ¥ç¶šã¾ãŸã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã§ã™');
                return;
            }

            try {
                console.log('ğŸ”¥ [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚’Firebaseã«ä¿å­˜ä¸­...', task.title);
                const result = await window.FirebaseDB.createTask(task);
                if (result.success) {
                    console.log('âœ… [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆæˆåŠŸ:', result.id);
                    task.firebaseId = result.id;

                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®tasksé…åˆ—ã«è¿½åŠ 
                    tasks.push(task);
                    window.tasks = tasks;
                    console.log('ğŸ‘¥ [PJ-MODAL] ä¿å­˜å¾Œã‚¿ã‚¹ã‚¯æ•°:', tasks.length);

                    // ç”»é¢ã‚’æ›´æ–°
                    render();
                    updateStats();
                } else {
                    console.error('âŒ [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆã‚¨ãƒ©ãƒ¼:', result.error);
                    alert('âŒ ã‚¿ã‚¹ã‚¯ä½œæˆã‚¨ãƒ©ãƒ¼: ' + result.error);
                    return;
                }
            } catch (error) {
                console.error('âŒ [PJ-MODAL] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ã‚¿ã‚¹ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
                return;
            }

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById('pj-task-success-message').style.display = 'block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('pj-task-form').reset();
            setPJDefaultDeadline();
            loadPJExistingProjects();

            // 2ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            setTimeout(() => {
                closeProjectTaskCreateModal();
            }, 2000);
        }


        window.deleteTask = deleteTask;
        window.toggleHamburgerMenu = toggleHamburgerMenu;
        window.updateHamburgerMenu = updateHamburgerMenu;
        window.logout = logout;
        window.handleFileImport = handleFileImport;
        window.processImportText = processImportText;
        window.toggleTaskSkipModal = toggleTaskSkipModal;
        window.executeImportFromModal = executeImportFromModal;
        window.openProjectTaskCreateModal = openProjectTaskCreateModal;
        window.closeProjectTaskCreateModal = closeProjectTaskCreateModal;
        window.createPJTask = createPJTask;
        window.selectExistingProjectInModal = selectExistingProjectInModal;
        window.migrateProjectTaskColumnIds = migrateProjectTaskColumnIds; // ãƒ‡ãƒãƒƒã‚°ç”¨ã«å…¬é–‹
    </script>
    
    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="hamburger-menu" id="hamburger-menu">
        <div class="user-menu-info">
            <div class="user-menu-avatar" id="user-menu-avatar">-</div>
            <div class="user-menu-name" id="user-menu-name">ã‚²ã‚¹ãƒˆ</div>
            <div class="user-menu-role" id="user-menu-role">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">å€‹äººè¨­å®š</div>
            <a href="javascript:void(0);" class="menu-item" onclick="toggleHamburgerMenu(); openMyProfileModal();">
                <span>ğŸ‘¤</span>
                <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
            </a>
            <a href="#" class="menu-item" onclick="openSettingsModal(); toggleHamburgerMenu(); return false;">
                <span>âš™ï¸</span>
                <span>åŸºæœ¬è¨­å®š</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">ã‚«ãƒ©ãƒ ãƒ»é€šçŸ¥ãƒ»ãƒ†ãƒ¼ãƒè¨­å®š</div>
            </a>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">ã‚¿ã‚¹ã‚¯ç®¡ç†</div>
            <a href="#" class="menu-item" onclick="openTemplateManagementModal(); toggleHamburgerMenu(); return false;">
                <span>ğŸ“‹</span>
                <span>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤ºãƒ»ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤</div>
            </a>
            <a href="#" class="menu-item" onclick="openTaskImportModal(); toggleHamburgerMenu(); return false;">
                <span>ğŸ“</span>
                <span>ãƒ†ã‚­ã‚¹ãƒˆãƒ»OCRã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">ãƒ†ã‚­ã‚¹ãƒˆãƒ»ç”»åƒã‹ã‚‰ã‚¿ã‚¹ã‚¯ä½œæˆ</div>
            </a>
        </div>
        
        <!-- æ©Ÿèƒ½æ”¹å–„æ›¸ã¯å‰Šé™¤æ¸ˆã¿ -->
        
        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ -->
        <div class="menu-section">
            <div class="menu-section-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
            <a href="javascript:void(0);" class="menu-item" onclick="toggleHamburgerMenu(); openProjectManagementModal();">
                <span>ğŸ—ï¸</span>
                <span>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ»ç®¡ç†</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ»ã‚«ãƒ©ãƒ è¨­å®šãƒ»ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</div>
            </a>
        </div>

        <div class="menu-section" id="admin-menu-section" style="display: none;">
            <div class="menu-section-title">ç®¡ç†æ©Ÿèƒ½</div>
            <a href="javascript:void(0);" class="menu-item" onclick="toggleHamburgerMenu(); openUserManagementModal();">
                <span>ğŸ‘¥</span>
                <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</span>
            </a>
            <a href="javascript:void(0);" class="menu-item" onclick="toggleHamburgerMenu(); openAdminDashboardModal();">
                <span>ğŸ“Š</span>
                <span>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </a>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">ãã®ä»–</div>
            <a href="#" class="menu-item" onclick="logout(); toggleHamburgerMenu(); return false;">
                <span>ğŸšª</span>
                <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
            </a>
        </div>
    </div>
    
    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleHamburgerMenu()"></div>
    
    <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
    <input type="file" id="file-import" accept=".csv,.xlsx,.xls,.txt,.png,.jpg,.jpeg" multiple style="display: none;" onchange="handleFileImport(event)">

    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="project-task-create-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ‘¥ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ä½œæˆ</h3>
                <button class="close-btn" onclick="closeProjectTaskCreateModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="modal-left" style="width: 100%;">
                    <div id="pj-task-success-message" style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none;">
                        âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼
                    </div>

                    <form id="pj-task-form" onsubmit="createPJTask(event)">
                        <div class="form-group">
                            <label class="form-label">ğŸ“ ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« *</label>
                            <input type="text" class="form-input" id="pj-task-title" required>
                        </div>

                        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ -->
                        <div class="form-group">
                            <label class="form-label">ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ *</label>
                            <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; border-left: 4px solid #2196f3;">
                                <div style="font-size: 0.9rem; color: #1565c0;">
                                    ğŸ’¡ <strong>æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã«ã¤ã„ã¦</strong><br>
                                    æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹å ´åˆã¯ã€å…ˆã«ã€Œ<strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š</strong>ã€ãƒšãƒ¼ã‚¸ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚<br>
                                    ä½œæˆå¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã§ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
                                </div>
                            </div>

                            <!-- æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ -->
                            <div id="pj-existing-project-section" style="display: block;">
                                <label class="form-label">æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ:</label>
                                <select class="form-select" id="pj-existing-project-select" onchange="selectExistingProjectInModal()">
                                    <option value="">-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                </select>
                            </div>

                            <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆé¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ï¼‰ -->
                            <input type="hidden" id="pj-project-id">
                            <input type="hidden" id="pj-project-name">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ğŸ“… æœŸé™æ—¥ *</label>
                                <input type="date" class="form-input" id="pj-deadline-date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">â° æœŸé™æ™‚åˆ»</label>
                                <input type="time" class="form-input" id="pj-deadline-time" value="17:00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ğŸ¯ å„ªå…ˆåº¦</label>
                            <select class="form-select" id="pj-priority">
                                <option value="low">ä½</option>
                                <option value="medium" selected>ä¸­</option>
                                <option value="high">é«˜</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ğŸ‘¥ æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰*</label>
                            <div id="pj-assignees" class="checkbox-group" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ğŸ“„ ãƒ¡ãƒ¢</label>
                            <textarea class="form-input" id="pj-memo" rows="3"></textarea>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeProjectTaskCreateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="btn btn-primary">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html><!-- Cache bust: 20250820-debug-buttons-removed -->
<!-- UI Update: 20250820-debug-buttons-removed -->
<!-- DEBUG BUTTONS COMPLETELY REMOVED: All Firebase debug buttons eliminated -->
