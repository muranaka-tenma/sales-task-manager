<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç† - Kanbanãƒœãƒ¼ãƒ‰</title>
    <!-- Deploy: 2025-08-03-17:45 - PJ fields completely removed -->
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--body-bg, #f4f5f7);
            color: var(--text-color, #172b4d);
            overflow-x: auto;
        }
        
        .header {
            background: var(--theme-color, #026aa7);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .hamburger-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }
        
        .hamburger-menu.active {
            left: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        .menu-section {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .menu-section-title {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        
        .menu-item:hover {
            background: #f5f5f5;
            transform: translateX(4px);
        }
        
        .menu-item.active {
            background: #e3f2fd;
            color: #026aa7;
            font-weight: 600;
        }
        
        .user-menu-info {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-menu-avatar {
            width: 48px;
            height: 48px;
            background: var(--theme-color, #026aa7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .user-menu-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .user-menu-role {
            font-size: 0.85rem;
            color: #666;
        }
        
        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        /* çµ±è¨ˆè¡¨ç¤º */
        .stats-bar {
            background: var(--stats-bg, linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%));
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color, #dfe1e6);
            display: flex;
            gap: 1.5rem;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8rem;
        }
        
        .stat-number {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .stat-overdue { color: #e53e3e; }
        .stat-today { color: #d69e2e; }
        .stat-completed { color: #38a169; }
        
        /* åˆ†æã‚µãƒãƒªãƒ¼ãƒãƒ¼ */
        .analytics-summary {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .analytics-left {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .analytics-metric {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .analytics-value {
            font-weight: bold;
            font-size: 1rem;
        }
        
        .analytics-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .period-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .period-btn:hover {
            background: #f7fafc;
            border-color: #a0aec0;
        }
        
        .period-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        /* ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ */
        .board-container {
            padding: 0.25rem;
            height: calc(100vh - 120px);
            overflow-x: auto;
        }
        
        .kanban-board {
            display: flex;
            gap: 0.375rem;
            min-width: max-content;
            height: 100%;
            padding: 0 0.5rem;
        }
        
        .column {
            background: var(--column-bg, linear-gradient(135deg, #f8f9fb 0%, #ebecf0 100%));
            border-radius: 8px;
            min-width: 180px;
            max-width: 200px;
            width: 190px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--column-border, rgba(255,255,255,0.2));
        }
        
        /* ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .column[data-column-id="trash"] {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #6c757d;
            opacity: 0.8;
        }
        
        .column[data-column-id="trash"]:hover {
            opacity: 1;
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }
        
        .column[data-column-id="trash"] .task {
            opacity: 0.6;
            background: #f8f9fa;
        }
        
        .column-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: #172b4d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dfe1e6;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.6) 100%);
            border-radius: 8px 8px 0 0;
        }
        
        .column-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .column-count {
            background: rgba(0,0,0,0.1);
            color: #5e6c84;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .column-content {
            flex: 1;
            padding: 0.5rem;
            overflow-y: auto;
            min-height: 100px;
        }
        
        /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ */
        .task-card {
            background: var(--card-bg, linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%));
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.375rem;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(9,30,66,.15);
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            border: 1px solid var(--card-border, rgba(0,0,0,0.05));
            color: var(--card-text, inherit);
        }
        
        .dark-theme .task-card {
            --card-bg: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            --card-border: #30363d;
            --card-text: #c9d1d9;
        }
        
        .task-card:hover {
            box-shadow: 0 4px 8px rgba(9,30,66,.25);
            transform: translateY(-1px);
        }
        
        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.02);
            box-shadow: 0 8px 16px rgba(9,30,66,.3);
            z-index: 1000;
        }
        
        /* å„ªå…ˆåº¦ã‚«ãƒ©ãƒ¼ */
        .task-card.priority-high { 
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }
        .task-card.priority-medium { 
            border-left-color: #d69e2e;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        }
        .task-card.priority-low { 
            border-left-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
        }
        
        /* æœŸé™åˆ‡ã‚Œãƒ»ä»Šæ—¥æœŸé™ */
        .task-card.overdue {
            background: linear-gradient(135deg, #fed7d7 0%, #ffffff 100%);
            animation: pulse 2s infinite;
        }
        
        .task-card.today {
            background: linear-gradient(135deg, #fef5e7 0%, #ffffff 100%);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 1px 0 rgba(229, 62, 62, 0.25); }
            50% { box-shadow: 0 4px 8px rgba(229, 62, 62, 0.4); }
            100% { box-shadow: 0 1px 0 rgba(229, 62, 62, 0.25); }
        }
        
        .task-title {
            font-weight: 600;
            margin-bottom: 0.375rem;
            color: var(--title-color, #172b4d);
            font-size: 0.8rem;
            line-height: 1.25;
        }
        
        .dark-theme .task-title {
            --title-color: #c9d1d9;
        }
        
        .task-meta {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            flex-wrap: wrap;
            font-size: 0.7rem;
        }
        
        .task-deadline {
            background: #dfe1e6;
            color: #5e6c84;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 500;
        }
        
        .task-deadline.overdue {
            background: #e53e3e;
            color: white;
        }
        
        .task-deadline.today {
            background: #d69e2e;
            color: white;
        }
        
        .task-priority-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .priority-high { background: #fee2e2; color: #dc2626; }
        .priority-medium { background: #fef3c7; color: #d97706; }
        .priority-low { background: #dcfce7; color: #16a34a; }
        
        .task-memo {
            font-size: 0.75rem;
            color: #5e6c84;
            line-height: 1.3;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .task-badges {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }
        
        .attachment-icon {
            color: #5e6c84;
            font-size: 0.8rem;
        }
        
        .attachment-badge {
            background: #0079bf;
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }
        
        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .file-preview-item {
            background: #f4f5f7;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            padding: 0.3rem;
            font-size: 0.7rem;
            color: #5e6c84;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 100px;
            text-align: center;
        }
        
        .file-preview-item:hover {
            background: #ebecf0;
            border-color: #0079bf;
        }
        
        .file-preview-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 2px;
            margin-bottom: 0.2rem;
        }
        
        .file-drop-zone {
            border: 2px dashed #dfe1e6;
            border-radius: 3px;
            padding: 1rem;
            text-align: center;
            color: #5e6c84;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }
        
        .file-drop-zone.drag-over {
            border-color: #0079bf;
            background: rgba(0, 121, 191, 0.05);
            color: #0079bf;
        }
        
        .notification-test {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0079bf;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 0.8rem;
        }
        
        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .column-content.drag-over {
            background: rgba(0, 121, 191, 0.1);
            border: 2px dashed #0079bf;
            border-radius: 3px;
        }
        
        /* ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒœã‚¿ãƒ³ */
        .add-task-btn {
            padding: 0.5rem;
            margin: 0 1rem 1rem;
            border: none;
            background: transparent;
            color: #5e6c84;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .add-task-btn:hover {
            background: rgba(9,30,66,.08);
            color: #172b4d;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dfe1e6;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .modal-left {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #dfe1e6;
        }
        
        .modal-right {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        
        .comments-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dfe1e6;
            background: white;
        }
        
        .comments-section {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .comment-input-section {
            padding: 1rem;
            border-top: 1px solid #dfe1e6;
            background: white;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #172b4d;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #5e6c84;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        /* ã‚³ãƒ¡ãƒ³ãƒˆé–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .comment {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .comment-author {
            font-weight: 600;
            color: #172b4d;
            margin-right: 0.5rem;
        }
        
        .comment-time {
            color: #5e6c84;
            font-size: 0.75rem;
        }
        
        .comment-body {
            color: #172b4d;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        
        .comment-input {
            width: 100%;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .comment-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .btn-comment {
            background: #0079bf;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-comment:hover {
            background: #005a8b;
        }
        
        /* æ‹…å½“è€…é¸æŠé–¢é€£ */
        .assignees-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 0.5rem;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            background: white;
            min-height: 44px;
        }
        
        .assignee-checkbox {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .assignee-checkbox:hover {
            background: #f4f5f7;
        }
        
        .assignee-checkbox input[type="checkbox"] {
            margin: 0;
        }
        
        .assignee-checkbox.checked {
            background: #e3f2fd;
            color: #0079bf;
            font-weight: 500;
        }
        
        .selected-assignees {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        
        .assignee-tag {
            background: #0079bf;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .assignee-tag .remove-assignee {
            cursor: pointer;
            font-weight: bold;
            padding: 0 0.125rem;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }
        
        .assignee-tag .remove-assignee:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ */
        .mention-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
            min-width: 120px;
        }
        
        .mention-suggestion {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid #f4f5f7;
        }
        
        .mention-suggestion:hover,
        .mention-suggestion.selected {
            background: #e3f2fd;
            color: #0079bf;
        }
        
        .mention-suggestion:last-child {
            border-bottom: none;
        }
        
        .mention {
            background: #e3f2fd;
            color: #0079bf;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #172b4d;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--input-border, #dfe1e6);
            border-radius: 3px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            background: var(--input-bg, white);
            color: var(--input-text, inherit);
        }
        
        .dark-theme .form-input,
        .dark-theme .form-select,
        .dark-theme .form-textarea {
            --input-border: #30363d;
            --input-bg: #0d1117;
            --input-text: #c9d1d9;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #0079bf;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--theme-color, #0079bf);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--theme-color-dark, #026aa7);
        }
        
        .btn-secondary {
            background: #f4f5f7;
            color: #172b4d;
            border: 1px solid #dfe1e6;
        }
        
        .btn-secondary:hover {
            background: #ebecf0;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* ãƒ†ãƒ¼ãƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
        .theme-modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .theme-modal[style*="display: none"] {
            display: none !important;
        }
        
        .theme-modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: 8px;
            width: 98%;
            max-width: 1600px;
            max-height: 95vh;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .settings-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .theme-option {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
        }
        
        .theme-option:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .theme-option.active {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }
        
        .theme-option .theme-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 1600px) {
            .preview-grid {
                grid-template-columns: 1fr 1fr 1fr !important;
            }
        }
        
        @media (max-width: 1200px) {
            .preview-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        
        @media (max-width: 800px) {
            .preview-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
            <button class="hamburger-btn" onclick="toggleHamburgerMenu()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem;" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
                â˜°
            </button>
            <div class="header-title">ğŸ¯ å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç† - Kanbanãƒœãƒ¼ãƒ‰</div>
        </div>
        <div class="header-controls">
            <button onclick="openSettingsModal()" class="settings-btn" title="è¨­å®š" style="display: none;">âš™ï¸</button>
        </div>
    </div>
    
    
    
    <!-- çµ±è¨ˆãƒãƒ¼ -->
    <div class="stats-bar" id="stats-bar">
        <div class="stat-item stat-overdue">
            <span class="stat-number" id="overdue-count">0</span>
            <span>æœŸé™åˆ‡ã‚Œ</span>
        </div>
        <div class="stat-item stat-today">
            <span class="stat-number" id="today-count">0</span>
            <span>ä»Šæ—¥æœŸé™</span>
        </div>
        <div class="stat-item" style="color: #e77600;" onclick="showStaleTasksDetail()" title="3æ—¥ä»¥ä¸ŠåŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¿ã‚¹ã‚¯">
            <span style="cursor: pointer;">ğŸš¨</span>
            <span class="stat-number" id="stale-count">0</span>
            <span style="cursor: pointer;">åœæ»ä¸­</span>
        </div>
        <div class="stat-item" id="workload-item" style="color: #0052cc; display: none;" onclick="showWorkloadDetail()" title="ãƒãƒ¼ãƒ å¹³å‡ã®1.2å€ä»¥ä¸Šã®ã‚¿ã‚¹ã‚¯ã‚’æ‹…å½“">
            <span style="cursor: pointer;">ğŸ‘¥</span>
            <span class="stat-number" id="overload-count">0</span>
            <span style="cursor: pointer;">è¦èª¿æ•´</span>
        </div>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ç®¡ç†ãƒãƒ¼ -->
    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span style="font-weight: 600; color: #2d3748;">ğŸ‘¥ è¡¨ç¤ºå¯¾è±¡:</span>
            <!-- çµ±åˆæ‹…å½“è€…ãƒ»PJãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div style="position: relative;" id="assignee-filter-container">
                <button onclick="toggleAssigneeFilterDropdown()" style="padding: 0.5rem 0.75rem; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; min-width: 150px;">
                    <span id="assignee-filter-text">å…¨å“¡</span>
                    <span>â–¼</span>
                </button>
                <div id="assignee-filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 250px;">
                    <!-- æ‹…å½“è€…ãƒ»PJé¸æŠè‚¢ãŒã“ã“ã«å‹•çš„è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <!-- PJä½œæˆãƒœã‚¿ãƒ³ -->
            <button onclick="window.location.href='pj-create.html'" style="padding: 0.5rem 0.75rem; background: #2b6cb0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;" title="æ–°ã—ã„PJã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ">
                ğŸ‘¥ PJä½œæˆ
            </button>
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒšãƒ¼ã‚¸ã«ç§»æ¤ã®ãŸã‚éè¡¨ç¤º -->
            <button onclick="window.location.href='user-management.html'" style="display: none; padding: 0.5rem 0.75rem; background: #38a169; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†">
                ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
            </button>
            <button onclick="showFilterHelp()" style="background: none; border: none; color: #4a5568; cursor: pointer; font-size: 1rem;" title="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®èª¬æ˜">
                â“
            </button>
        </div>
    </div>
    
    <!-- åˆ†æã‚µãƒãƒªãƒ¼ãƒãƒ¼ -->
    <div class="analytics-summary" id="analytics-summary">
        <div class="analytics-left">
            <div class="analytics-metric">
                <span style="font-weight: 600;">å®Œäº†ç‡:</span>
                <span class="analytics-value" id="completion-rate-summary">0%</span>
            </div>
            <div class="analytics-metric">
                <span style="font-weight: 600;">æœŸé™éµå®ˆç‡:</span>
                <span class="analytics-value" id="compliance-rate-summary">0%</span>
            </div>
        </div>
        <button class="analytics-btn" onclick="showAnalytics()"
                style="padding: 0.5rem 1rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
            ğŸ“Š è©³ç´°åˆ†æ
        </button>
    </div>
        
        <!-- ã‚«ãƒ©ãƒ è¿½åŠ æ©Ÿèƒ½ -->
        <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="quick-column-name" placeholder="æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; width: 120px;">
            <button onclick="quickAddColumn()" style="padding: 0.4rem 0.8rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ï¼‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
        </div>
    </div>
    
    <!-- åˆ†æã‚µãƒãƒªãƒ¼ãƒãƒ¼ -->
    <div class="analytics-summary">
        <div class="analytics-left">
            <div class="analytics-metric">
                <span>ğŸ“ˆ å®Œäº†ç‡:</span>
                <span class="analytics-value" style="color: #38a169;" id="summary-completion-rate">-</span>
            </div>
            <div class="analytics-metric">
                <span>â° æœŸé™éµå®ˆç‡:</span>
                <span class="analytics-value" style="color: #4299e1;" id="summary-deadline-compliance">-</span>
            </div>
            <div class="analytics-metric">
                <span>âš¡ å¹³å‡å®Œäº†æ™‚é–“:</span>
                <span class="analytics-value" style="color: #9f7aea;" id="summary-avg-time">-</span>
            </div>
        </div>
        <div class="analytics-actions">
            <button onclick="createTaskUnified()" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; margin-right: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">âœ¨ æ–°è¦ã‚¿ã‚¹ã‚¯</button>
            <button onclick="toggleBulkMode()" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; margin-right: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">â˜‘ï¸ è¤‡æ•°é¸æŠ</button>
            <!-- æœŸé–“ãƒ¬ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å‰Šé™¤: è©³ç´°åˆ†æå†…ã«çµ±åˆ -->
        </div>
    </div>
    
    <!-- ãƒãƒ«ã‚¯æ“ä½œãƒãƒ¼ -->
    <div id="bulk-actions-bar" style="display: none; background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; padding: 0.75rem 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="selected-count" style="font-weight: 600;">0ä»¶é¸æŠ</span>
                <button onclick="selectAllTasks()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">å…¨é¸æŠ</button>
                <button onclick="clearSelection()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">é¸æŠè§£é™¤</button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <select id="bulk-move-column" style="padding: 0.4rem; border: none; border-radius: 4px; font-size: 0.8rem;">
                    <option value="">ç§»å‹•å…ˆã‚’é¸æŠ</option>
                </select>
                <button onclick="bulkMoveSelected()" style="background: #38a169; border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ“¦ ç§»å‹•</button>
                <button onclick="bulkDeleteSelected()" style="background: #e53e3e; border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ—‘ï¸ å‰Šé™¤</button>
                <button onclick="toggleBulkMode()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">âœ• çµ‚äº†</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ -->
    <div class="board-container">
        <div class="kanban-board" id="kanban-board">
            <!-- ã‚«ãƒ©ãƒ ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
        </div>
    </div>
    
    <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">æ–°ã—ã„ã‚¿ã‚¹ã‚¯</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- å·¦å´: ã‚¿ã‚¹ã‚¯è©³ç´° -->
                <div class="modal-left">
                    <form onsubmit="saveTask(event)">
                        <!-- PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ï¼ˆpj-create.htmlï¼‰ã«ç§»å‹• -->
                        
                        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
                        <div class="form-group" style="background: #f8f9fa; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <label class="form-label" style="color: #495057;">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä½œæˆï¼ˆä»»æ„ï¼‰</label>
                            <select id="template-select" onchange="handleTemplateSelection(this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                <option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ã‚¿ã‚¹ã‚¯å *</label>
                            <input type="text" class="form-input" id="task-title-input" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æœŸé™æ—¥ *</label>
                                <input type="date" class="form-input" id="task-date-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœŸé™æ™‚åˆ»</label>
                                <input type="time" class="form-input" id="task-time-input" value="17:00">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">å„ªå…ˆåº¦</label>
                                <select class="form-select" id="task-priority-input">
                                    <option value="high">ğŸ”´ æœ€é‡è¦</option>
                                    <option value="medium" selected>ğŸŸ¡ é‡è¦</option>
                                    <option value="low">ğŸŸ¢ é€šå¸¸</option>
                                </select>
                            </div>
                            <div class="form-group" id="column-selection-group" style="display: none;">
                                <label class="form-label">é…ç½®å…ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                                <select class="form-select" id="task-column-input" required>
                                    <!-- ã‚«ãƒ©ãƒ é¸æŠè‚¢ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                                <div class="assignees-container" id="assignees-container">
                                    <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ</label>
                            <textarea class="form-textarea" id="task-memo-input" rows="3" placeholder="è©³ç´°ãªé€²æ—çŠ¶æ³ã‚„å‚™è€ƒã‚’è¨˜éŒ²"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
                            <input type="file" class="form-input" id="task-files-input" multiple accept="*/*">
                            <div class="file-drop-zone" id="file-drop-zone">
                                ğŸ“ ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ä¸Šè¨˜ãƒœã‚¿ãƒ³ã§é¸æŠ
                            </div>
                            <div id="attached-files-list" style="margin-top: 0.5rem;"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
                
                <!-- å³å´: ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰ -->
                <div class="modal-right">
                    <div class="comments-header">
                        <h4 style="margin: 0; font-size: 1rem; color: #172b4d;">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆãƒ»é€²æ—å ±å‘Š</h4>
                    </div>
                    
                    <div class="comments-section" id="comments-section">
                        <!-- ã‚³ãƒ¡ãƒ³ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                    
                    <div class="comment-input-section" style="position: relative;">
                        <textarea class="comment-input" id="comment-input" placeholder="é€²æ—å ±å‘Šã€ç¢ºèªäº‹é …ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›... (@ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¯èƒ½)"></textarea>
                        <div id="mention-suggestions" class="mention-suggestions" style="display: none;"></div>
                        <div class="comment-actions">
                            <button type="button" class="btn-comment" onclick="addComment()">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title">âš™ï¸ è¨­å®š</h3>
                <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
            </div>
            
            <div class="settings-modal-body">
                <!-- è¨­å®šç”»é¢ã®èª¬æ˜ -->
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #026aa7;">
                    <p style="margin: 0; color: #172b4d; font-size: 0.9rem;">
                        ğŸ’¡ <strong>è¨­å®šç”»é¢ã®ä½¿ã„æ–¹ï¼š</strong><br>
                        â€¢ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼šãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ®µéšã‚’è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™<br>
                        â€¢ ã‚«ãƒ©ãƒ¼å¤‰æ›´ï¼šå„ãƒ•ã‚§ãƒ¼ã‚ºã®è‰²ã‚’å¤‰æ›´ã—ã¦ãƒãƒ¼ãƒ è­˜åˆ¥ã‚’å‘ä¸Š<br>
                        â€¢ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šï¼šæœŸé™é€šçŸ¥ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
                    </p>
                </div>
                
                <!-- ã‚«ãƒ©ãƒ ãƒ»ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç† -->
                <div class="setting-section">
                    <h4 style="margin-bottom: 1rem; color: #172b4d;">ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†</h4>
                    <div id="column-manager">
                        <div id="column-list" style="margin-bottom: 1rem;">
                            <!-- æ—¢å­˜ã®ã‚«ãƒ©ãƒ ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="new-column-name" placeholder="æ–°ã—ã„ã‚«ãƒ©ãƒ åï¼ˆä¾‹ï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã€æ‰¿èªå¾…ã¡ï¼‰" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addColumn()" style="padding: 0.5rem 1rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer;">è¿½åŠ </button>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š -->
                <div class="setting-section" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: #172b4d;">ğŸ”” æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-3hours" checked>
                            <span>3æ™‚é–“å‰ã«ã‚¢ãƒ©ãƒ¼ãƒˆ</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-1day">
                            <span>1æ—¥å‰ã«ã‚¢ãƒ©ãƒ¼ãƒˆ</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-overdue" checked>
                            <span>æœŸé™åˆ‡ã‚Œå¾Œã«ã‚¢ãƒ©ãƒ¼ãƒˆ</span>
                        </label>
                    </div>
                </div>
                
                <!-- åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ -->
                <div class="setting-section" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: #172b4d;">ğŸ“Š åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ</h4>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <button onclick="showAnalytics()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold;">
                            ğŸ“ˆ åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
                        </button>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666; text-align: center;">
                            ã‚¿ã‚¹ã‚¯å®Œäº†ç‡ãƒ»æ‹…å½“è€…ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»æœŸé™éµå®ˆç‡ã‚’åˆ†æ
                        </div>
                    </div>
                </div>

                <!-- ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† -->
                <div class="setting-section" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: #172b4d;">ğŸ“‹ ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h4>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <span style="font-weight: 500;">ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>
                            <button onclick="showCreateTemplateModal()" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                â• æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                            </button>
                        </div>
                        <div id="template-list" style="min-height: 100px;">
                            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                </div>

                <!-- è¡¨ç¤ºè¨­å®š -->
                <div class="setting-section" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: #172b4d;">ğŸ¯ è¡¨ç¤ºè¨­å®š</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="show-task-count" checked>
                            <span>ã‚«ãƒ©ãƒ ã«ã‚¿ã‚¹ã‚¯æ•°ã‚’è¡¨ç¤º</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="compact-mode">
                            <span>ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-section" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: #172b4d;">ğŸ“ æŸ”è»Ÿãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h4>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <textarea id="import-text" placeholder="ã‚·ãƒ³ãƒ—ãƒ«å½¢å¼ã§ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#10;ä¾‹:&#10;Aç¤¾ã¸ã®ææ¡ˆæ›¸ä½œæˆ @ãƒ¦ãƒ¼ã‚¶ãƒ¼å 2024-08-05&#10;  è©³ç´°ç¢ºèªäº‹é …ï¼ˆåŠè§’ã‚¹ãƒšãƒ¼ã‚¹2å€‹ï¼‰&#10;  è¦‹ç©ã‚‚ã‚Šèª¿æ•´&#10;Bç¤¾æ‰“ã¡åˆã‚ã›!!! @æ‹…å½“è€…å&#10;ã€€è³‡æ–™æº–å‚™æ¸ˆã¿ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‰&#10;		ä¼šè­°å®¤äºˆç´„ï¼ˆã‚¿ãƒ–ï¼‰&#10;Cç¤¾ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—" style="width: 100%; height: 120px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9rem; resize: vertical;"></textarea>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="previewImport()" style="flex: 1; padding: 0.75rem; background: #0079bf; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                            <button onclick="clearImportText()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                            <label for="ocr-file-input" style="padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; display: inline-block;" title="GoogleTODOã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå¯¾å¿œï¼é ˜åŸŸé¸æŠã§ã‚¿ã‚¹ã‚¯åãƒ»æœŸé™ã‚’è‡ªå‹•ãƒšã‚¢åŒ–">ğŸ“¸ OCR+ã‚¿ã‚°æ©Ÿèƒ½</label>
                            <input type="file" id="ocr-file-input" accept="image/*" style="display: none;" onchange="handleOCRFile(this)">
                        </div>
                        
                        <!-- OCRå‡¦ç†çŠ¶æ³ -->
                        <div id="ocr-status" style="display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 4px; background: #e3f2fd; border: 1px solid #90caf9;">
                            <div id="ocr-progress-text">ğŸ“¸ ç”»åƒã‚’è§£æä¸­...</div>
                            <div style="width: 100%; background: #f0f0f0; border-radius: 4px; height: 8px; margin-top: 0.5rem;">
                                <div id="ocr-progress-bar" style="width: 0%; height: 100%; background: #2196f3; border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                            <!-- AIä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
                            <div id="confidence-scores" style="display: none; margin-top: 0.75rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;">
                                <div style="font-size: 0.85rem; font-weight: bold; color: #495057; margin-bottom: 0.5rem;">ğŸ¯ AIä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢</div>
                                <div id="confidence-list" style="font-size: 0.8rem; color: #666;"></div>
                            </div>
                        </div>
                        
                        <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é ˜åŸŸé¸æŠ -->
                        <div id="image-preview-container" style="display: none; margin-top: 1rem; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                            <div style="padding: 1rem; border-bottom: 1px solid #ddd; background: #e8f5e8;">
                                <h5 style="margin: 0; color: #172b4d;">ğŸ–¼ï¸ ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - é ˜åŸŸã‚’é¸æŠã—ã¦OCR</h5>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                                    ãƒã‚¦ã‚¹ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é¸æŠé ˜åŸŸã‚’ä½œæˆã—ã€ã€ŒOCRå®Ÿè¡Œã€ã§ãƒ†ã‚­ã‚¹ãƒˆåŒ–
                                </div>
                            </div>
                            <div id="image-preview-scroll-container" style="padding: 1rem; max-height: 600px; overflow: auto; position: relative;">
                                <div id="image-canvas-container" style="position: relative; display: inline-block; border: 1px solid #ccc; transform-origin: top left;">
                                    <canvas id="image-canvas" style="cursor: crosshair;"></canvas>
                                    <!-- é¸æŠé ˜åŸŸã‚’è¡¨ç¤ºã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                                    <div id="selection-overlay" style="position: absolute; top: 0; left: 0; pointer-events: none;"></div>
                                </div>
                            </div>
                            <div style="padding: 1rem; border-top: 1px solid #ddd;">
                                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                    <button onclick="processSelectedAreas()" style="padding: 0.75rem; background: #0079bf; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” OCRå®Ÿè¡Œ</button>
                                    <button onclick="clearSelections()" style="padding: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ é¸æŠã‚¯ãƒªã‚¢</button>
                                    <button onclick="hideImagePreview()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">é–‰ã˜ã‚‹</button>
                                    <span id="selection-count" style="margin-left: 1rem; color: #666; font-size: 0.9rem;">0å€‹ã®é ˜åŸŸã‚’é¸æŠä¸­</span>
                                </div>
                                <details style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                                    <summary style="cursor: pointer; font-size: 0.85rem; color: #666;">ğŸ¯ OCRç²¾åº¦å‘ä¸Šè¨­å®š</summary>
                                    <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                        <div style="margin-bottom: 0.5rem;">
                                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: bold; color: #2563eb;">
                                                <input type="checkbox" id="ocr-handwriting-mode" title="æ‰‹æ›¸ãæ–‡å­—ã«ç‰¹åŒ–ã—ãŸé«˜ç²¾åº¦OCR"> âœï¸ æ‰‹æ›¸ãæ–‡å­—ãƒ¢ãƒ¼ãƒ‰ï¼ˆé«˜ç²¾åº¦ï¼‰
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: bold; color: #dc2626;">
                                                <input type="checkbox" id="ocr-complex-layout-mode" title="è¡¨ãƒ»å›³ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ãªã©ã®è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯¾å¿œ"> ğŸ§© è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆè¡¨ãƒ»å›³å¯¾å¿œï¼‰
                                            </label>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                                <input type="checkbox" id="ocr-enhance-contrast"> ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                                <input type="checkbox" id="ocr-upscale"> 2å€æ‹¡å¤§å‡¦ç†
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                                <input type="checkbox" id="ocr-grayscale"> ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;" title="â‘ â†’ 1, â—‹â†’ 0, â—â†’ 1 ãªã©">
                                                <input type="checkbox" id="ocr-cleanup-symbols" checked> æ•°å­—è¨˜å·ä¿®æ­£
                                            </label>
                                        </div>
                                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                                            <button onclick="previewProcessing()" style="padding: 0.5rem; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ” å‡¦ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                                            <button onclick="resetOCRSettings()" style="padding: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                                        <button onclick="testOCRDirectly()" style="margin-left: 0.5rem; padding: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ” OCRãƒ†ã‚¹ãƒˆ</button>
                                        <button onclick="testHandwritingOCR()" style="padding: 0.5rem; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">âœï¸ æ‰‹æ›¸ããƒ†ã‚¹ãƒˆ</button>
                                        <button onclick="testComplexLayoutOCR()" style="padding: 0.5rem; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ§© ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆ</button>
                                        </div>
                                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #d1ecf1; border-radius: 4px; font-size: 0.8rem; color: #0c5460;">
                                            ğŸ’¡ ãƒ’ãƒ³ãƒˆ: â‘ â†’ 1, â—‹â†’ 0 ãªã©ã®èª¤èªè­˜ãŒã‚ã‚‹å ´åˆã¯ã€Œæ•°å­—è¨˜å·ä¿®æ­£ã€ã‚’æœ‰åŠ¹ã«
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>
                        
                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ - æ‹¡å¤§ç‰ˆ -->
                        <div id="import-preview" style="display: none; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                            <div style="padding: 1rem; border-bottom: 1px solid #ddd; background: #e3f2fd;">
                                <h5 style="margin: 0; color: #172b4d;">ğŸ“‹ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç·¨é›†å¯èƒ½</h5>
                            </div>
                            <div id="preview-content" style="padding: 1rem; max-height: 500px; overflow-y: auto;"></div>
                            <div style="padding: 1rem; border-top: 1px solid #ddd; display: flex; gap: 0.5rem;">
                                <button onclick="executeImport()" style="flex: 1; padding: 0.75rem; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                                <button onclick="hidePreview()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.8rem; color: #6c757d; line-height: 1.4;">
                            <strong>ğŸ“ ã‚·ãƒ³ãƒ—ãƒ«å½¢å¼:</strong><br>
                            â€¢ <strong>ãƒ»</strong>ã§ä¸»ã‚¿ã‚¹ã‚¯é–‹å§‹<br>
                            â€¢ <strong>è¡Œé ­ã‚¹ãƒšãƒ¼ã‚¹</strong>ã§ã‚µãƒ–ã‚¿ã‚¹ã‚¯ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã«è‡ªå‹•è¿½åŠ ï¼‰<br>
                            â€¢ <strong>@æ‹…å½“è€…</strong>ã€<strong>æ—¥ä»˜</strong>ã€<strong>!!!</strong>é«˜å„ªå…ˆåº¦ã‚’è‡ªå‹•èªè­˜<br><br>
                            <strong>ğŸ“¸ OCRæ³¨æ„äº‹é …:</strong><br>
                            â€¢ ãƒ—ãƒªãƒ³ãƒˆæ–‡å­—ã®ã¿æ¨å¥¨ï¼ˆæ‰‹æ›¸ãã¯ç²¾åº¦ä½ï¼‰<br>
                            â€¢ ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã¿ï¼ˆè¡¨ãƒ»å›³ã¯éæ¨å¥¨ï¼‰<br>
                            â€¢ èªè­˜å¾Œã¯æ‰‹å‹•ã§ç¢ºèªãƒ»ä¿®æ­£ãŒå¿…è¦
                        </div>
                    </div>
                </div>
                
                <div class="setting-section" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: #172b4d;">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button onclick="clearAllData()" style="padding: 0.75rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="analyticsModal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content" style="max-width: 1000px;">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title">ğŸ“Š åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                <button class="close-btn" onclick="closeAnalyticsModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem; overflow-y: auto; max-height: 80vh;">
                <!-- æœŸé–“é¸æŠ -->
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                    <span style="font-weight: 600;">æœŸé–“:</span>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('all')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">å…¨æœŸé–“</button>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('today')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">ä»Šæ—¥</button>
                    <button class="period-btn active" onclick="showAnalyticsForPeriod('week')" style="padding: 0.5rem 1rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer;">ä»Šé€±</button>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('month')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">ä»Šæœˆ</button>
                </div>
                
                <!-- æ¦‚è¦çµ±è¨ˆ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="total-tasks">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="completion-rate">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">å®Œäº†ç‡</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="deadline-compliance">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">æœŸé™éµå®ˆç‡</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="avg-completion-time">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">å¹³å‡å®Œäº†æ™‚é–“</div>
                    </div>
                </div>
                
                <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- ã‚¿ã‚¹ã‚¯å®Œäº†ç‡ãƒãƒ£ãƒ¼ãƒˆ -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #172b4d;">ğŸ“ˆ ã‚¿ã‚¹ã‚¯å®Œäº†çŠ¶æ³</h4>
                        <div id="completion-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                            ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                    
                    <!-- æœŸé™éµå®ˆçŠ¶æ³ãƒãƒ£ãƒ¼ãƒˆ -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #172b4d;">â° æœŸé™éµå®ˆçŠ¶æ³</h4>
                        <div id="deadline-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                            ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>
                
                <!-- æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
                <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #172b4d;">ğŸ‘¥ æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>
                    <div id="assignee-performance" style="min-height: 200px;">
                        ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="templateModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 8px; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title" id="template-modal-title">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ</h3>
                <button class="close-btn" onclick="closeTemplateModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem; overflow-y: auto; flex: 1;">
                <form onsubmit="saveTemplate(event)">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå *</label>
                        <input type="text" id="template-name" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" placeholder="ä¾‹: å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ" required>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ã‚«ãƒ†ã‚´ãƒª</label>
                        <select id="template-category" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="å–¶æ¥­">å–¶æ¥­</option>
                            <option value="ä¼ç”»">ä¼ç”»</option>
                            <option value="ç®¡ç†">ç®¡ç†</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ã‚¿ã‚¹ã‚¯å *</label>
                        <input type="text" id="template-task-title" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" placeholder="ä¾‹: æœˆæ¬¡å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">å„ªå…ˆåº¦</label>
                            <select id="template-priority" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="high">ğŸ”´ æœ€é‡è¦</option>
                                <option value="medium" selected>ğŸŸ¡ é‡è¦</option>
                                <option value="low">ğŸŸ¢ é€šå¸¸</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ </label>
                            <select id="template-column" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                                <!-- ã‚«ãƒ©ãƒ é¸æŠè‚¢ãŒã“ã“ã«å‹•çš„è¿½åŠ ã•ã‚Œã‚‹ -->
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                        <div id="template-assignees" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <!-- æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã“ã“ã«å‹•çš„è¿½åŠ ã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ</label>
                        <textarea id="template-memo" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" rows="3" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è©³ç´°ã‚„ä½¿ç”¨å ´é¢"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" onclick="closeTemplateModal()" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button type="submit" id="save-template-btn" style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼‰
        function checkAuthentication() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (!session) {
                    // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = 'login.html';
                    return false;
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™ãƒã‚§ãƒƒã‚¯
                if (new Date() > new Date(session.expiresAt)) {
                    localStorage.removeItem('currentSession');
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœŸé™åˆ‡ã‚Œã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                displayUserInfo(session.user);
                return true;
            } catch (error) {
                console.error('èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                window.location.href = 'login.html';
                return false;
            }
        }
        
        function displayUserInfo(user) {
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
                headerTitle.innerHTML = `
                    ğŸ¯ å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç†
                    <span style="font-size: 0.8rem; font-weight: normal; margin-left: 1rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">
                        ${user.name} (${getRoleDisplayName(user.role)})
                    </span>
                `;
            }
            
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const headerRight = document.querySelector('.header').children[1];
            if (headerRight && !document.getElementById('logout-btn')) {
                const logoutBtn = document.createElement('button');
                logoutBtn.id = 'logout-btn';
                logoutBtn.innerHTML = 'ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
                logoutBtn.style.cssText = `
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9rem;
                    margin-left: 1rem;
                `;
                logoutBtn.onclick = function() {
                    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        localStorage.removeItem('currentSession');
                        window.location.href = 'login.html';
                    }
                };
                headerRight.appendChild(logoutBtn);
            }
            
            console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª:', user.name, user.role);
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': 'é–‹ç™ºè€…',
                'admin': 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…',
                'project_manager': 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†è€…',
                'user': 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                'viewer': 'é–²è¦§è€…'
            };
            return roleNames[role] || role;
        }
        
        // Phase 1: æ¨©é™å–å¾—æ©Ÿèƒ½ã®ã¿ï¼ˆè¡¨ç¤ºåˆ¶å¾¡ãªã—ï¼‰
        function getCurrentUser() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user) {
                    return {
                        name: session.user.name,
                        email: session.user.email,
                        role: session.user.role,
                        isLoggedIn: true
                    };
                }
            } catch (error) {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
            return {
                name: null,
                email: null,
                role: null,
                isLoggedIn: false
            };
        }
        
        // Phase 1: æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã®ã¿ï¼ˆåˆ¶å¾¡ãªã—ï¼‰
        function checkUserPermission() {
            const currentUser = getCurrentUser();
            console.log('ğŸ” [Phase 1] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', currentUser);
            
            if (currentUser.isLoggedIn) {
                console.log(`âœ… [Phase 1] ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª: ${currentUser.name} (${currentUser.role})`);
            } else {
                console.log('âŒ [Phase 1] æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹');
            }
            
            // ã“ã®æ®µéšã§ã¯ä½•ã‚‚åˆ¶å¾¡ã—ãªã„
            return currentUser;
        }
        
        // Phase 2: ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã®å‰Šé™¤ï¼ˆãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç§»è¡Œï¼‰
        function removeMyProfileButton() {
            try {
                const myProfileBtn = document.getElementById('my-profile-btn');
                if (myProfileBtn) {
                    myProfileBtn.remove();
                    console.log('ğŸ—‘ï¸ [Phase 2] ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ï¼ˆãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç§»è¡Œï¼‰');
                }
            } catch (error) {
                console.error('âŒ [Phase 2] ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // Phase 3: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³éè¡¨ç¤º
        function hideUserManagementForUsers() {
            try {
                const currentUser = getCurrentUser();
                if (!currentUser.isLoggedIn) {
                    console.log('âŒ [Phase 3] æœªãƒ­ã‚°ã‚¤ãƒ³: å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                console.log(`ğŸ” [Phase 3] æ¨©é™ãƒã‚§ãƒƒã‚¯: ${currentUser.name} (${currentUser.role})`);
                
                // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                if (currentUser.role === 'user') {
                    const userMgmtBtn = document.querySelector('button[onclick*="user-management.html"]');
                    if (userMgmtBtn) {
                        userMgmtBtn.style.display = 'none';
                        console.log('ğŸ”’ [Phase 3] ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º');
                    } else {
                        console.log('âš ï¸ [Phase 3] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                } else {
                    console.log(`âœ… [Phase 3] ${currentUser.role}æ¨©é™: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³è¡¨ç¤ºç¶­æŒ`);
                }
                
                // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ›´æ–°
                setTimeout(() => {
                    updateHamburgerMenu();
                    console.log('ğŸ” [Phase 3] ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°å®Œäº†');
                }, 200);
                
            } catch (error) {
                console.error('âŒ [Phase 3] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³åˆ¶å¾¡ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹å‰ã«ï¼‰
        if (!checkAuthentication()) {
            // èªè¨¼å¤±æ•—æ™‚ã¯ä»¥é™ã®å‡¦ç†ã‚’åœæ­¢
            throw new Error('Authentication required');
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let tasks = JSON.parse(localStorage.getItem('salesTasksKanban') || '[]');
        console.log('ğŸ“Š [LOAD] èª­ã¿è¾¼ã¾ã‚ŒãŸã‚¿ã‚¹ã‚¯æ•°:', tasks.length);
        const pjTasks = tasks.filter(t => t.projectId);
        console.log('ğŸ‘¥ [LOAD] PJã‚¿ã‚¹ã‚¯æ•°:', pjTasks.length, pjTasks.map(t => `${t.projectId}: ${t.title}`));
        
        // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã«createdAtãŒãªã„å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‹ã‚‰é¡ã£ã¦è¨­å®š
        // ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãªã©ç”¨ï¼‰
        tasks = tasks.map((task, index) => {
            if (!task.createdAt) {
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †ã‚’è€ƒæ…®ã—ã¦ã€å¤ã„ã‚¿ã‚¹ã‚¯ã¯7æ—¥å‰ã€æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã¯ä»Šæ—¥ã¨ã—ã¦è¨­å®š
                const daysAgo = Math.floor((tasks.length - index - 1) / Math.max(1, tasks.length / 7));
                const createdDate = new Date();
                createdDate.setDate(createdDate.getDate() - daysAgo);
                task.createdAt = createdDate.toISOString();
                console.log(`ğŸ“… [MIGRATION] Added createdAt to task ${task.id}: ${daysAgo} days ago`);
            }
            return task;
        });
        
        // åœæ»ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ³ãƒ—ãƒ«ã‚’è¿½åŠ ï¼ˆåˆå›ã®ã¿ï¼‰
        const hasStaleTestTask = tasks.some(task => task.title.includes('ã€åœæ»ãƒ†ã‚¹ãƒˆã€‘'));
        if (!hasStaleTestTask) {
            const staleDate = new Date();
            staleDate.setDate(staleDate.getDate() - 4); // 4æ—¥å‰
            
            const staleTestTask = {
                id: Date.now(),
                title: 'ã€åœæ»ãƒ†ã‚¹ãƒˆã€‘4æ—¥å‰ã‹ã‚‰é€²è¡Œä¸­ã®ã‚¿ã‚¹ã‚¯',
                deadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(), // 3æ—¥å¾ŒæœŸé™
                priority: 'high',
                columnId: 'inprogress',
                assignee: 'ä½è—¤èª²é•·',
                assignees: ['ä½è—¤èª²é•·'],
                memo: 'é‡è¦ãªæ¡ˆä»¶ã§ã™ã€‚4æ—¥å‰ã‹ã‚‰é€²è¡Œä¸­ã§ã™ãŒã€ä½•ã‚‰ã‹ã®ç†ç”±ã§åœæ»ã—ã¦ã„ã¾ã™ã€‚',
                createdAt: staleDate.toISOString(),
                isMainTask: false
            };
            
            tasks.push(staleTestTask);
            console.log('ğŸ“Š [INIT] Added stale test task for demonstration');
        }
        
        // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã¯ä¿å­˜
        localStorage.setItem('salesTasksKanban', JSON.stringify(tasks));
        
        let draggedTask = null;
        let editingTask = null;
        let taskCounter = tasks.length || 0;
        
        // æ‹…å½“è€…ãƒªã‚¹ãƒˆ
        let assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
        
        // ä¸€å›é™ã‚Šã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç½®æ›å‡¦ç†
        function migrateSampleDataToRealUser() {
            const migrationKey = 'sampleDataMigrated';
            if (localStorage.getItem(migrationKey)) return; // æ—¢ã«å®Ÿè¡Œæ¸ˆã¿
            
            // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            
            let realUser = null;
            if (currentSession && currentSession.user) {
                realUser = currentSession.user.name; // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼
            } else if (systemUsers.length > 0) {
                // é–‹ç™ºè€…æ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å„ªå…ˆçš„ã«é¸æŠ
                const developerUser = systemUsers.find(u => u.role === 'developer');
                realUser = developerUser ? developerUser.name : systemUsers[0].name;
            } else {
                realUser = 'é‚¨ä¸­å¤©çœŸ'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            }
            
            const sampleUsers = ['ç”°ä¸­éƒ¨é•·', 'ä½è—¤èª²é•·', 'éˆ´æœ¨ä¸»ä»»', 'å±±ç”°ã•ã‚“', 'å±±ç”°ä¸»ä»»', 'éˆ´æœ¨ä¿‚é•·'];
            let updated = false;
            
            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã®ç½®æ›
            assignees = assignees.map(name => {
                if (sampleUsers.includes(name)) {
                    updated = true;
                    console.log(`ğŸ”„ ç½®æ›: ${name} â†’ ${realUser}`);
                    return realUser;
                }
                return name;
            });
            
            // é‡è¤‡ã‚’å‰Šé™¤ã—ã€å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
            assignees = [...new Set(assignees)];
            if (!assignees.includes(realUser)) {
                assignees.push(realUser);
                updated = true;
            }
            
            if (updated) {
                localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                console.log(`âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${realUser}ã€ã«ç½®æ›å®Œäº†:`, assignees);
            }
            
            // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            localStorage.setItem(migrationKey, 'true');
        }
        
        // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        migrateSampleDataToRealUser();
        
        // ã‚«ãƒ©ãƒ å®šç¾©
        let columns = JSON.parse(localStorage.getItem('kanbanColumns') || '[{"id":"todo","title":"ğŸ“‹ TODO","color":"#667eea"},{"id":"inprogress","title":"âš¡ é€²è¡Œä¸­","color":"#f59e0b"},{"id":"waiting","title":"â³ é€£çµ¡å¾…ã¡","color":"#8b5cf6"},{"id":"done","title":"âœ… Done","color":"#10b981"},{"id":"trash","title":"ğŸ—‘ï¸ ã‚´ãƒŸç®±","color":"#6c757d"}]');
        
        // ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å¼·åˆ¶è¿½åŠ 
        const trashColumn = columns.find(c => c.id === 'trash');
        console.log('ğŸ—‘ï¸ [TRASH] ç¾åœ¨ã®ã‚«ãƒ©ãƒ :', columns.map(c => c.id));
        console.log('ğŸ—‘ï¸ [TRASH] ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ å­˜åœ¨:', !!trashColumn);
        
        if (!trashColumn) {
            columns.push({"id":"trash","title":"ğŸ—‘ï¸ ã‚´ãƒŸç®±","color":"#6c757d"});
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            console.log('ğŸ—‘ï¸ ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        } else {
            console.log('ğŸ—‘ï¸ ã‚´ãƒŸç®±ã‚«ãƒ©ãƒ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
        let taskTemplates = JSON.parse(localStorage.getItem('taskTemplates') || '[]');
        let editingTemplateId = null;
        
        // ãƒãƒ«ã‚¯æ“ä½œç®¡ç†
        let isBulkMode = false;
        let selectedTasks = new Set();
        
        // ãƒ•ã‚£ãƒ«ã‚¿ç®¡ç†ï¼ˆPhase 2å¯¾å¿œï¼‰
        let selectedAssigneeFilters = [];
        let selectedProjectFilters = [];
        let viewMode = 'personal'; // 'personal' or 'project'
        
        // å®šæœŸã‚¿ã‚¹ã‚¯ç®¡ç†
        let recurringTemplates = JSON.parse(localStorage.getItem('recurringTemplates') || '[]');
        
        // Phase 2: PJã‚¿ã‚¹ã‚¯é–¢é€£é–¢æ•°ï¼ˆPJä½œæˆå°‚ç”¨ï¼‰
        function isPJTaskMode() {
            // PJè¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã§PJãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¤å®š
            const projectSettings = document.getElementById('project-task-settings');
            return projectSettings && projectSettings.style.display === 'block';
        }
        
        function populateApprovers() {
            const container = document.getElementById('project-approvers');
            container.innerHTML = '';
            
            assignees.forEach(assignee => {
                const checkboxWrapper = document.createElement('label');
                checkboxWrapper.style.cssText = 'display: flex; align-items: center; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; background: #fff; border: 1px solid #ddd; font-size: 0.85rem;';
                checkboxWrapper.innerHTML = `
                    <input type="checkbox" value="${assignee}" style="margin-right: 0.5rem;">
                    <span>${assignee}</span>
                `;
                container.appendChild(checkboxWrapper);
            });
        }
        
        function getSelectedApprovers() {
            const checkboxes = document.querySelectorAll('#project-approvers input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // çµ±åˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ï¼ˆæ‹…å½“è€… + PJï¼‰
        function toggleAssigneeFilterDropdown() {
            const dropdown = document.getElementById('assignee-filter-dropdown');
            const isVisible = dropdown.style.display === 'block';
            
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                populateAssigneeFilterOptions();
                dropdown.style.display = 'block';
            }
        }
        
        function populateAssigneeFilterOptions() {
            const dropdown = document.getElementById('assignee-filter-dropdown');
            
            // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ï¼ˆé‡è¤‡é™¤å»ï¼‰
            const projectMap = new Map();
            tasks.filter(t => t.projectId && t.projectId !== null)
                 .forEach(t => {
                     if (!projectMap.has(t.projectId)) {
                         projectMap.set(t.projectId, {id: t.projectId, name: t.projectName});
                     }
                 });
            const allProjects = Array.from(projectMap.values());
            
            dropdown.innerHTML = `
                <div style="padding: 0.5rem;">
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 0.5rem; padding: 0.25rem;">ğŸ‘¤ æ‹…å½“è€…</div>
                    <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                        <input type="radio" name="filter-type" value="" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedAssigneeFilters.length === 0 && selectedProjectFilters.length === 0 ? 'checked' : ''}>
                        <span>å…¨å“¡</span>
                    </label>
                    ${assignees.map(assignee => `
                        <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                            <input type="radio" name="filter-type" value="assignee:${assignee}" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedAssigneeFilters.includes(assignee) && selectedProjectFilters.length === 0 ? 'checked' : ''}>
                            <span>${assignee}</span>
                        </label>
                    `).join('')}
                    
                    ${allProjects.length > 0 ? `
                        <div style="font-weight: 600; color: #2d3748; margin: 0.75rem 0 0.5rem 0; padding: 0.25rem; border-top: 1px solid #e2e8f0;">ğŸ‘¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
                        ${allProjects.map(project => `
                            <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                                <input type="radio" name="filter-type" value="project:${project.id}" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedProjectFilters.includes(project.id) ? 'checked' : ''}>
                                <span>${project.id} - ${project.name}</span>
                            </label>
                        `).join('')}
                    ` : ''}
                </div>
            `;
        }
        
        function updateAssigneeFilterSelection() {
            const selectedRadio = document.querySelector('#assignee-filter-dropdown input[name="filter-type"]:checked');
            
            // ãƒªã‚»ãƒƒãƒˆ
            selectedAssigneeFilters = [];
            selectedProjectFilters = [];
            viewMode = 'personal';
            
            if (selectedRadio && selectedRadio.value) {
                const [type, value] = selectedRadio.value.split(':');
                
                if (type === 'assignee') {
                    selectedAssigneeFilters = [value];
                    console.log(`ğŸ‘¤ [FILTER] Switched to assignee: ${value}`);
                } else if (type === 'project') {
                    selectedProjectFilters = [value];
                    viewMode = 'project';
                    console.log(`ğŸ‘¥ [FILTER] Switched to project: ${value}`);
                }
            } else {
                console.log(`ğŸ‘¥ [FILTER] Showing all tasks`);
            }
            
            updateAssigneeFilterText();
            render();
            updateStats();
        }
        
        function updateAssigneeFilterText() {
            const textElement = document.getElementById('assignee-filter-text');
            
            if (selectedProjectFilters.length > 0) {
                const projectTask = tasks.find(t => t.projectId === selectedProjectFilters[0]);
                textElement.textContent = projectTask ? `ğŸ‘¥ ${projectTask.projectId}` : selectedProjectFilters[0];
            } else if (selectedAssigneeFilters.length > 0) {
                textElement.textContent = `ğŸ‘¤ ${selectedAssigneeFilters[0]}`;
            } else {
                textElement.textContent = 'å…¨å“¡';
            }
        }
        
        function showFilterHelp() {
            const helpText = `
ğŸ‘¥ è¡¨ç¤ºå¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã¤ã„ã¦

ã€ğŸ‘¤ æ‹…å½“è€…é¸æŠã€‘
â€¢ ç‰¹å®šã®æ‹…å½“è€…ã®ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º
â€¢ å€‹äººã®ä½œæ¥­çŠ¶æ³ã‚’ç¢ºèª

ã€ğŸ‘¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã€‘
â€¢ ç‰¹å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º
â€¢ PJã‚¿ã‚¹ã‚¯ã®Wãƒã‚§ãƒƒã‚¯ç®¡ç†ç”¨
â€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã®ä¸€å…ƒç¢ºèª

ã€å…¨å“¡ã€‘
â€¢ å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
â€¢ ãƒãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ³æŠŠæ¡

ğŸ’¡ å€‹äººè¡¨ç¤ºã¨PJè¡¨ç¤ºã¯æ’ä»–çš„ã§ã™ã€‚
`;
            alert(helpText);
        }
        
        // PJä½œæˆæ©Ÿèƒ½
        function createProjectTask() {
            try {
                console.log('ğŸ‘¥ [PJ CREATE] Starting PJ task creation...');
                
                // æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€PJã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
                editingTask = null;
                
                // åŸºæœ¬å…¥åŠ›é …ç›®ã‚’ã‚¯ãƒªã‚¢
                const titleInput = document.getElementById('task-title-input');
                const dateInput = document.getElementById('task-date-input');
                const timeInput = document.getElementById('task-time-input');
                const priorityInput = document.getElementById('task-priority-input');
                const memoInput = document.getElementById('task-memo-input');
                
                if (!titleInput || !dateInput || !timeInput || !priorityInput || !memoInput) {
                    throw new Error('å¿…è¦ãªå…¥åŠ›è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                document.getElementById('modal-title').textContent = 'æ–°ã—ã„PJã‚¿ã‚¹ã‚¯';
                titleInput.value = '';
                dateInput.value = getDefaultDeadlineString();
                timeInput.value = getDefaultTimeString();
                priorityInput.value = 'medium';
                memoInput.value = '';
                
                // ã‚«ãƒ©ãƒ é¸æŠã‚’è¡¨ç¤º
                const columnGroup = document.getElementById('column-selection-group');
                const columnInput = document.getElementById('task-column-input');
                if (columnGroup && columnInput) {
                    columnGroup.style.display = 'block';
                    columnInput.setAttribute('required', '');
                    
                    // ã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
                    columnInput.innerHTML = '';
                    columns.forEach(column => {
                        const option = document.createElement('option');
                        option.value = column.id;
                        option.textContent = column.title;
                        if (column.id === 'todo') {
                            option.selected = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§TODOã‚’é¸æŠ
                        }
                        columnInput.appendChild(option);
                    });
                }
                
                // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
                updateAssigneeOptions();
                setSelectedAssignees([]);
                
                // PJã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
                const projectSettings = document.getElementById('project-task-settings');
                
                if (!projectSettings) {
                    throw new Error('PJã‚¿ã‚¹ã‚¯è¨­å®šè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                projectSettings.style.display = 'block';
                
                // PJã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã¯requiredå±æ€§ã‚’è¨­å®š
                // PJãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•
                
                // PJæƒ…å ±ã‚’ã‚¯ãƒªã‚¢
                const projectIdInput = document.getElementById('project-id-input');
                const projectNameInput = document.getElementById('project-name-input');
                
                if (!projectIdInput || !projectNameInput) {
                    throw new Error('PJæƒ…å ±å…¥åŠ›è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                projectIdInput.value = '';
                projectNameInput.value = '';
                
                // æ‰¿èªè€…ã‚’è¨­å®š
                populateApprovers();
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆé–¢é€£ã‚’ã‚¯ãƒªã‚¢
                displayAttachedFiles([]);
                const commentsSection = document.getElementById('comments-section');
                const commentInput = document.getElementById('comment-input');
                
                if (commentsSection) {
                    commentsSection.innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã§ã™ã€‚ä¿å­˜å¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã§ãã¾ã™ã€‚</div>';
                }
                if (commentInput) {
                    commentInput.disabled = true;
                }
                
                // çµ±ä¸€ä½œæˆãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
                const modal = document.getElementById('task-modal');
                if (!modal) {
                    throw new Error('ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                modal.dataset.unifiedMode = 'true';
                // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                window.scrollTo(0, 0);
                
                // å°‘ã—é…å»¶ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºå®Ÿã«ï¼‰
                setTimeout(() => {
                    modal.classList.add('show');
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å†åº¦ãƒˆãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«ï¼‰
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        document.body.scrollTop = 0; // Safariã«ã‚‚å¯¾å¿œ
                        document.documentElement.scrollTop = 0; // IEã«ã‚‚å¯¾å¿œ
                        
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ã‚‚ä¸Šéƒ¨ã«é…ç½®ã‚’å¼·åˆ¶
                        modal.style.top = '0px';
                        modal.scrollTop = 0;
                    }, 10);
                    
                    console.log('ğŸ‘¥ [PJ CREATE] Successfully opened PJ task creation modal');
                }, 50);
                
            } catch (error) {
                console.error('ğŸ‘¥ [PJ CREATE ERROR]', error);
                alert('PJã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', function(event) {
            const assigneeContainer = document.getElementById('assignee-filter-container');
            if (assigneeContainer && !assigneeContainer.contains(event.target)) {
                document.getElementById('assignee-filter-dropdown').style.display = 'none';
            }
        });
        
        // å®šæœŸã‚¿ã‚¹ã‚¯æ©Ÿèƒ½
        function saveRecurringTemplates() {
            localStorage.setItem('recurringTemplates', JSON.stringify(recurringTemplates));
        }
        
        function generateRecurringTask(template) {
            const now = new Date();
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—ã®ç½®æ›
            const title = formatTemplateString(template.taskTemplate.title, now);
            const deadline = calculateDeadline(now, template.deadlineConfig);
            
            const task = {
                id: Date.now(),
                title: title,
                deadline: deadline.toISOString(),
                priority: template.taskTemplate.priority,
                assignees: template.taskTemplate.assignees || [],
                assignee: template.taskTemplate.assignees?.[0] || 'æœªè¨­å®š',
                memo: template.taskTemplate.memo || '',
                attachments: [],
                comments: [],
                columnId: 'todo',
                completed: false,
                createdAt: now.toISOString(),
                
                // PJã‚¿ã‚¹ã‚¯å¯¾å¿œ
                projectId: template.taskTemplate.projectId,
                projectName: template.taskTemplate.projectName,
                personalStatus: 'todo',
                projectStatus: 'todo',
                pendingMove: null,
                approvers: template.taskTemplate.approvers || [],
                lastApprovedBy: null,
                approvedAt: null,
                
                // å®šæœŸã‚¿ã‚¹ã‚¯æƒ…å ±
                isRecurring: true,
                recurringTemplateId: template.id,
                generatedFor: formatDateForRecurring(now)
            };
            
            return task;
        }
        
        function formatTemplateString(template, date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            return template
                .replace(/\{\{YYYY\}\}/g, year)
                .replace(/\{\{YYYYå¹´\}\}/g, `${year}å¹´`)
                .replace(/\{\{MM\}\}/g, String(month).padStart(2, '0'))
                .replace(/\{\{MMæœˆ\}\}/g, `${month}æœˆ`)
                .replace(/\{\{DD\}\}/g, String(day).padStart(2, '0'))
                .replace(/\{\{DDæ—¥\}\}/g, `${day}æ—¥`);
        }
        
        function calculateDeadline(baseDate, deadlineConfig) {
            const deadline = new Date(baseDate);
            deadline.setDate(deadline.getDate() + deadlineConfig.relativeDays);
            
            const [hours, minutes] = deadlineConfig.timeOfDay.split(':');
            deadline.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            return deadline;
        }
        
        function formatDateForRecurring(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            return `${year}-${String(month).padStart(2, '0')}`;
        }
        
        function checkAndGenerateRecurringTasks() {
            const now = new Date();
            let generatedCount = 0;
            
            recurringTemplates.forEach(template => {
                if (shouldGenerateRecurringTask(template, now)) {
                    const newTask = generateRecurringTask(template);
                    tasks.unshift(newTask);
                    
                    // æ¬¡å›ç”Ÿæˆæ—¥ã‚’æ›´æ–°
                    updateNextGenerationDate(template, now);
                    generatedCount++;
                    
                    console.log(`ğŸ”„ [RECURRING] Generated task: ${newTask.title} for ${newTask.generatedFor}`);
                }
            });
            
            if (generatedCount > 0) {
                saveTasks();
                saveRecurringTemplates();
                render();
                updateStats();
                console.log(`ğŸ”„ [RECURRING] Generated ${generatedCount} recurring tasks`);
            }
        }
        
        function shouldGenerateRecurringTask(template, now) {
            if (!template.isActive) return false;
            
            const nextGen = template.generationConfig.nextGeneration 
                ? new Date(template.generationConfig.nextGeneration) 
                : now;
            
            return now >= nextGen;
        }
        
        function updateNextGenerationDate(template, currentDate) {
            const config = template.recurringConfig;
            const next = new Date(currentDate);
            
            switch (config.type) {
                case 'daily':
                    next.setDate(next.getDate() + config.interval);
                    break;
                case 'weekly':
                    next.setDate(next.getDate() + (7 * config.interval));
                    break;
                case 'monthly':
                    next.setMonth(next.getMonth() + config.interval);
                    break;
                case 'yearly':
                    next.setFullYear(next.getFullYear() + config.interval);
                    break;
            }
            
            template.generationConfig.lastGenerated = currentDate.toISOString();
            template.generationConfig.nextGeneration = next.toISOString();
        }
        
        function showRecurringTasksInfo() {
            showRecurringTasksManagement();
        }
        
        function showRecurringTasksManagement() {
            const activeTemplates = recurringTemplates.filter(t => t.isActive);
            const recurringTasks = tasks.filter(t => t.isRecurring);
            
            const modal = document.createElement('div');
            modal.id = 'recurring-tasks-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #805ad5 0%, #667eea 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                        <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            ğŸ”„ å®šæœŸã‚¿ã‚¹ã‚¯ç®¡ç†
                            <button onclick="document.getElementById('recurring-tasks-modal').remove()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
                        </h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">æ¯æœˆãƒ»æ¯é€±ã®ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†</p>
                    </div>
                    
                    <div style="padding: 1.5rem; overflow-y: auto; max-height: 60vh;">
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: #2d3748; margin: 0 0 1rem 0;">ğŸ“Š ç¾åœ¨ã®çŠ¶æ³</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #805ad5;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #805ad5;">${activeTemplates.length}</div>
                                    <div style="color: #4a5568; font-size: 0.9rem;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
                                </div>
                                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #38a169;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">${recurringTasks.length}</div>
                                    <div style="color: #4a5568; font-size: 0.9rem;">ç”Ÿæˆæ¸ˆã¿ã‚¿ã‚¹ã‚¯</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                            <button onclick="createRecurringTemplate()" style="background: #805ad5; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                â• ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
                            </button>
                            <button onclick="generatePendingTasks()" style="background: #3182ce; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ğŸ”„ ä»Šã™ãç”Ÿæˆãƒã‚§ãƒƒã‚¯
                            </button>
                            <button onclick="showRecurringTasksInfo_Old()" style="background: #718096; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ğŸ“‹ ç°¡æ˜“è¡¨ç¤º
                            </button>
                        </div>
                        
                        ${activeTemplates.length > 0 ? `
                            <div>
                                <h4 style="color: #2d3748; margin: 0 0 1rem 0;">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${activeTemplates.map(template => {
                                        const nextGen = template.generationConfig?.nextGeneration ? 
                                            new Date(template.generationConfig.nextGeneration).toLocaleDateString('ja-JP') : 'æœªè¨­å®š';
                                        const typeText = getRecurringTypeText(template.recurringConfig?.type || 'monthly');
                                        
                                        return `
                                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                    <div style="font-weight: 600; color: #2d3748;">${template.name || 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåæœªè¨­å®š'}</div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button onclick="alert('ç·¨é›†æ©Ÿèƒ½ã¯è¿‘æ—¥å®Ÿè£…äºˆå®šã§ã™')" style="background: #edf2f7; border: 1px solid #e2e8f0; color: #4a5568; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ç·¨é›†</button>
                                                        <button onclick="alert('åœæ­¢æ©Ÿèƒ½ã¯è¿‘æ—¥å®Ÿè£…äºˆå®šã§ã™')" style="background: #fed7d7; border: 1px solid #feb2b2; color: #c53030; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">åœæ­¢</button>
                                                    </div>
                                                </div>
                                                <div style="font-size: 0.85rem; color: #4a5568; line-height: 1.4;">
                                                    <div>ğŸ“… é »åº¦: ${typeText}</div>
                                                    <div>â° æ¬¡å›ç”Ÿæˆ: ${nextGen}</div>
                                                    <div>ğŸ‘¥ æ‹…å½“è€…: ${template.taskTemplate?.assignees ? template.taskTemplate.assignees.join(', ') : 'æœªè¨­å®š'}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 2rem; color: #718096;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“…</div>
                                <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">å®šæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
                                <div style="font-size: 0.9rem;">æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã€ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•åŒ–ã—ã¾ã—ã‚‡ã†</div>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // å…ƒã®ç°¡æ˜“è¡¨ç¤ºé–¢æ•°ï¼ˆä¸‹ä½äº’æ›ç”¨ï¼‰
        function showRecurringTasksInfo_Old() {
            const activeTemplates = recurringTemplates.filter(t => t.isActive);
            const recurringTasks = tasks.filter(t => t.isRecurring);
            
            let infoText = `ğŸ”„ å®šæœŸã‚¿ã‚¹ã‚¯ç®¡ç†\n\n`;
            infoText += `ğŸ“Š ç¾åœ¨ã®çŠ¶æ³:\n`;
            infoText += `â€¢ å®šæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ${activeTemplates.length}ä»¶\n`;
            infoText += `â€¢ ç”Ÿæˆæ¸ˆã¿ã‚¿ã‚¹ã‚¯: ${recurringTasks.length}ä»¶\n\n`;
            
            if (activeTemplates.length > 0) {
                infoText += `ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§:\n`;
                activeTemplates.forEach((template, index) => {
                    const nextGen = template.generationConfig?.nextGeneration 
                        ? new Date(template.generationConfig.nextGeneration).toLocaleDateString('ja-JP')
                        : 'æœªè¨­å®š';
                    infoText += `${index + 1}. ${template.name}\n`;
                    infoText += `   ç¨®é¡: ${getRecurringTypeText(template.recurringConfig?.type || 'monthly')}\n`;
                    infoText += `   æ¬¡å›ç”Ÿæˆ: ${nextGen}\n\n`;
                });
            }
            
            if (recurringTasks.length > 0) {
                infoText += `ğŸ“ ç”Ÿæˆæ¸ˆã¿ã‚¿ã‚¹ã‚¯:\n`;
                const recentTasks = recurringTasks.slice(0, 5);
                recentTasks.forEach(task => {
                    const status = getColumnTitle(task.columnId);
                    infoText += `â€¢ ${task.title} (${status})\n`;
                });
                if (recurringTasks.length > 5) {
                    infoText += `...ä»–${recurringTasks.length - 5}ä»¶\n`;
                }
            }
            
            infoText += `\nğŸ’¡ ãƒ’ãƒ³ãƒˆ: å®šæœŸã‚¿ã‚¹ã‚¯ã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã€ğŸ”„ã‚¢ã‚¤ã‚³ãƒ³ã§è­˜åˆ¥ã§ãã¾ã™ã€‚`;
            
            alert(infoText);
        }
        
        function getRecurringTypeText(type) {
            const typeMap = {
                'daily': 'æ¯æ—¥',
                'weekly': 'æ¯é€±',
                'monthly': 'æ¯æœˆ',
                'yearly': 'æ¯å¹´'
            };
            return typeMap[type] || type;
        }
        
        // æ—¥ä»˜ãƒ»æ™‚é–“ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function getCurrentDateTime() {
            return new Date();
        }
        
        function isOverdue(deadline, columnId) {
            if (columnId === 'done') return false;
            return new Date(deadline) < getCurrentDateTime();
        }
        
        function isToday(deadline, columnId) {
            if (columnId === 'done') return false;
            const today = new Date();
            const deadlineDate = new Date(deadline);
            return today.toDateString() === deadlineDate.toDateString();
        }
        
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getDefaultDeadlineString() {
            // æ—¥ä»˜ã¯ä»Šæ—¥ã‚’è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜åŸºæº–ï¼‰
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getDefaultTimeString() {
            // ç¾åœ¨æ™‚åˆ»+3æ™‚é–“ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»ã¨ã—ã¦è¨­å®š
            const now = new Date();
            const futureDate = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // 3æ™‚é–“å¾Œ
            
            const hours = futureDate.getHours();
            const minutes = futureDate.getMinutes();
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        function getDefaultDateTimeAfter3Hours() {
            // ç¾åœ¨æ™‚åˆ»+3æ™‚é–“å¾Œã®æ—¥ä»˜ã¨æ™‚é–“ã‚’æ­£ç¢ºã«è¨ˆç®—
            const now = new Date();
            const futureDate = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // 3æ™‚é–“å¾Œ
            
            const year = futureDate.getFullYear();
            const month = (futureDate.getMonth() + 1).toString().padStart(2, '0');
            const day = futureDate.getDate().toString().padStart(2, '0');
            const hours = futureDate.getHours();
            const minutes = futureDate.getMinutes();
            
            return {
                date: `${year}-${month}-${day}`,
                time: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`
            };
        }
        
        // çµ±ä¸€ã‚«ãƒ¼ãƒ‰ä½œæˆé–¢æ•°ï¼ˆç”»é¢ä¸Šéƒ¨ã®ãƒœã‚¿ãƒ³ç”¨ï¼‰
        function createTaskUnified() {
            console.log('ğŸ“ [CREATE UNIFIED] Starting unified task creation...');
            editingTask = null;
            document.getElementById('modal-title').textContent = 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = getDefaultDeadlineString();
            document.getElementById('task-time-input').value = getDefaultTimeString();
            document.getElementById('task-priority-input').value = 'medium';
            document.getElementById('task-memo-input').value = '';
            document.getElementById('task-files-input').value = '';
            document.getElementById('attached-files-list').innerHTML = '';
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚’åˆæœŸåŒ–
            initializeTemplateSelector();
            
            // ã‚«ãƒ©ãƒ é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºã—ã€åˆæœŸåŒ–
            const columnSelectionGroup = document.getElementById('column-selection-group');
            const columnSelect = document.getElementById('task-column-input');
            columnSelectionGroup.style.display = 'block';
            
            // ã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ã‚«ãƒ©ãƒ ã‚’é¸æŠ
            if (columns.length > 0) {
                columnSelect.value = columns[0].id;
            }
            
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            updateAssigneeOptions();
            clearSelectedAssignees();
            
            // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            displayComments([]);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ–°è¦ã‚¿ã‚¹ã‚¯ã®å ´åˆï¼‰
            document.getElementById('comment-input').disabled = true;
            document.getElementById('comments-section').innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã§ã™ã€‚ä¿å­˜å¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã§ãã¾ã™ã€‚</div>';
            
            // PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ãŸãŸã‚ã€ã“ã®å‡¦ç†ã¯ä¸è¦
            
            // çµ±ä¸€ä½œæˆãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            document.getElementById('task-modal').dataset.unifiedMode = 'true';
            
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å†åº¦ãƒˆãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«ï¼‰
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safariã«ã‚‚å¯¾å¿œ
                    document.documentElement.scrollTop = 0; // IEã«ã‚‚å¯¾å¿œ
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ã‚‚ä¸Šéƒ¨ã«é…ç½®ã‚’å¼·åˆ¶
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        // ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»ç·¨é›†
        function createTask(columnId) {
            editingTask = null;
            document.getElementById('modal-title').textContent = 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = getDefaultDeadlineString();
            document.getElementById('task-time-input').value = getDefaultTimeString();
            document.getElementById('task-priority-input').value = 'medium';
            document.getElementById('task-memo-input').value = '';
            document.getElementById('task-files-input').value = '';
            document.getElementById('attached-files-list').innerHTML = '';
            
            // ã‚«ãƒ©ãƒ é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
            document.getElementById('column-selection-group').style.display = 'none';
            document.getElementById('task-column-input').removeAttribute('required');
            
            // PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ãŸãŸã‚ã€ã“ã®å‡¦ç†ã¯ä¸è¦
            
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            updateAssigneeOptions();
            clearSelectedAssignees();
            
            // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            displayComments([]);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ–°è¦ã‚¿ã‚¹ã‚¯ã®å ´åˆï¼‰
            document.getElementById('comment-input').disabled = true;
            document.getElementById('comments-section').innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã§ã™ã€‚ä¿å­˜å¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã§ãã¾ã™ã€‚</div>';
            
            // ã‚«ãƒ©ãƒ æƒ…å ±ã‚’ä¿å­˜
            document.getElementById('task-modal').dataset.targetColumn = columnId;
            document.getElementById('task-modal').dataset.unifiedMode = 'false';
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å†åº¦ãƒˆãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«ï¼‰
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safariã«ã‚‚å¯¾å¿œ
                    document.documentElement.scrollTop = 0; // IEã«ã‚‚å¯¾å¿œ
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ã‚‚ä¸Šéƒ¨ã«é…ç½®ã‚’å¼·åˆ¶
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        function updateAssigneeOptions() {
            const container = document.getElementById('assignees-container');
            container.innerHTML = '';
            
            assignees.forEach(assignee => {
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'assignee-checkbox';
                checkboxWrapper.innerHTML = `
                    <input type="checkbox" id="assignee-${assignee}" value="${assignee}" onchange="updateSelectedAssignees()">
                    <label for="assignee-${assignee}">${assignee}</label>
                `;
                container.appendChild(checkboxWrapper);
            });
            
            // æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³
            const addButton = document.createElement('div');
            addButton.className = 'assignee-checkbox';
            addButton.style.cssText = 'color: #0079bf; font-weight: 500;';
            addButton.innerHTML = '+ æ–°ã—ã„æ‹…å½“è€…ã‚’è¿½åŠ ';
            addButton.onclick = addNewAssignee;
            container.appendChild(addButton);
        }
        
        function updateSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const wrapper = checkbox.closest('.assignee-checkbox');
                if (checkbox.checked) {
                    wrapper.classList.add('checked');
                } else {
                    wrapper.classList.remove('checked');
                }
            });
        }
        
        function getSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function setSelectedAssignees(assigneeList) {
            // æ–‡å­—åˆ—ã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
            if (typeof assigneeList === 'string') {
                assigneeList = assigneeList.split(',').map(a => a.trim()).filter(a => a);
            }
            
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = assigneeList.includes(checkbox.value);
                const wrapper = checkbox.closest('.assignee-checkbox');
                if (checkbox.checked) {
                    wrapper.classList.add('checked');
                } else {
                    wrapper.classList.remove('checked');
                }
            });
        }
        
        function clearSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.assignee-checkbox').classList.remove('checked');
            });
        }
        
        function addNewAssignee() {
            const newAssignee = prompt('æ–°ã—ã„æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (newAssignee && newAssignee.trim()) {
                const trimmedName = newAssignee.trim();
                if (!assignees.includes(trimmedName)) {
                    assignees.push(trimmedName);
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                    updateAssigneeOptions();
                    // æ–°ã—ãè¿½åŠ ã—ãŸæ‹…å½“è€…ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    setTimeout(() => {
                        const newCheckbox = document.getElementById(`assignee-${trimmedName}`);
                        if (newCheckbox) {
                            newCheckbox.checked = true;
                            updateSelectedAssignees();
                        }
                    }, 100);
                }
            }
        }
        
        function editTask(taskId) {
            editingTask = tasks.find(t => t.id === taskId);
            if (!editingTask) return;
            
            document.getElementById('modal-title').textContent = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
            document.getElementById('task-title-input').value = editingTask.title;
            document.getElementById('task-date-input').value = editingTask.deadline.split('T')[0];
            document.getElementById('task-time-input').value = editingTask.deadline.split('T')[1].substring(0, 5);
            document.getElementById('task-priority-input').value = editingTask.priority;
            document.getElementById('task-memo-input').value = editingTask.memo || '';
            
            // ã‚«ãƒ©ãƒ é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤ºï¼ˆç·¨é›†æ™‚ã¯ä¸è¦ï¼‰
            document.getElementById('column-selection-group').style.display = 'none';
            document.getElementById('task-column-input').removeAttribute('required');
            
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å€¤ã‚’è¨­å®š
            updateAssigneeOptions();
            setSelectedAssignees(editingTask.assignees || editingTask.assignee || []);
            
            // Phase 2: PJã‚¿ã‚¹ã‚¯ç·¨é›†æ™‚ã¯PJè¨­å®šã‚’éè¡¨ç¤ºï¼ˆä½œæˆæ™‚ã®ã¿ä½¿ç”¨ï¼‰
            // PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            
            // PJã‚¿ã‚¹ã‚¯ã®å ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤º
            const isPJTask = editingTask.projectId && editingTask.projectId !== null;
            if (isPJTask) {
                document.getElementById('modal-title').textContent = `ğŸ‘¥ PJã‚¿ã‚¹ã‚¯ç·¨é›†: ${editingTask.projectId}`;
                console.log(`ğŸ¯ [EDIT] Editing PJ task: ${editingTask.projectId} - ${editingTask.projectName}`);
            } else {
                console.log(`ğŸ‘¤ [EDIT] Editing personal task: ${editingTask.title}`);
            }
            
            // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
            displayAttachedFiles(editingTask.attachments || []);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
            displayComments(editingTask.comments || []);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('comment-input').disabled = false;
            
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å†åº¦ãƒˆãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«ï¼‰
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safariã«ã‚‚å¯¾å¿œ
                    document.documentElement.scrollTop = 0; // IEã«ã‚‚å¯¾å¿œ
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ã‚‚ä¸Šéƒ¨ã«é…ç½®ã‚’å¼·åˆ¶
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        function displayAttachedFiles(attachments) {
            const container = document.getElementById('attached-files-list');
            container.innerHTML = '';
            
            if (attachments.length === 0) return;
            
            const previewDiv = document.createElement('div');
            previewDiv.className = 'file-preview';
            
            attachments.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.onclick = () => previewFile(file, index);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                if (file.type && file.type.startsWith('image/') && file.dataUrl) {
                    fileItem.innerHTML = `
                        <img src="${file.dataUrl}" class="file-preview-thumbnail" alt="${file.name}">
                        <div style="font-size: 0.6rem; margin-top: 0.2rem;">${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}</div>
                        <button type="button" onclick="event.stopPropagation(); removeAttachment(${index})" style="background: #e53e3e; color: white; border: none; padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.6rem; cursor: pointer; margin-top: 0.2rem;">å‰Šé™¤</button>
                    `;
                } else {
                    const fileIcon = getFileIcon(file.type);
                    fileItem.innerHTML = `
                        <div style="font-size: 1.5rem; margin-bottom: 0.2rem;">${fileIcon}</div>
                        <div style="font-size: 0.6rem; margin-bottom: 0.2rem;">${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}</div>
                        <button type="button" onclick="event.stopPropagation(); removeAttachment(${index})" style="background: #e53e3e; color: white; border: none; padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.6rem; cursor: pointer;">å‰Šé™¤</button>
                    `;
                }
                
                previewDiv.appendChild(fileItem);
            });
            
            container.appendChild(previewDiv);
        }
        
        function getFileIcon(fileType) {
            if (!fileType) return 'ğŸ“„';
            if (fileType.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (fileType.includes('pdf')) return 'ğŸ“•';
            if (fileType.includes('word') || fileType.includes('document')) return 'ğŸ“';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'ğŸ“Š';
            if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'ğŸ“ˆ';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'ğŸ—œï¸';
            return 'ğŸ“„';
        }
        
        function previewFile(file, index) {
            if (file.dataUrl && file.type.startsWith('image/')) {
                // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
                modal.onclick = () => document.body.removeChild(modal);
                
                const img = document.createElement('img');
                img.src = file.dataUrl;
                img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
                
                modal.appendChild(img);
                document.body.appendChild(modal);
            } else {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}\nã‚µã‚¤ã‚º: ${(file.size / 1024).toFixed(1)}KB\nã‚¿ã‚¤ãƒ—: ${file.type || 'ä¸æ˜'}`);
            }
        }
        
        function removeAttachment(index) {
            if (editingTask && editingTask.attachments) {
                editingTask.attachments.splice(index, 1);
                displayAttachedFiles(editingTask.attachments);
            }
        }
        
        // ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
        function displayComments(comments) {
            const container = document.getElementById('comments-section');
            if (!comments || comments.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            container.innerHTML = comments.map(comment => {
                const commentDate = new Date(comment.timestamp);
                const timeAgo = getTimeAgo(commentDate);
                const processedText = processMentions(comment.text);
                
                return `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-time">${timeAgo}</span>
                        </div>
                        <div class="comment-body">${processedText}</div>
                    </div>
                `;
            }).join('');
            
            // æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            container.scrollTop = container.scrollHeight;
        }
        
        function processMentions(text) {
            // @ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã«å¤‰æ›
            return text.replace(/@(\w+[^\s]*)/g, '<span class="mention">@$1</span>');
        }
        
        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        let mentionSuggestionIndex = -1;
        let mentionStartPos = -1;
        let mentionQuery = '';
        
        function setupMentionSystem() {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚ŒãŸã¨ãã«åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
            // editTask ã¨ openTaskModal å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹
        }
        
        function initMentionListeners() {
            const commentInput = document.getElementById('comment-input');
            if (!commentInput) return;
            
            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦é‡è¤‡ã‚’é˜²ã
            commentInput.removeEventListener('input', handleMentionInput);
            commentInput.removeEventListener('keydown', handleMentionKeydown);
            
            commentInput.addEventListener('input', handleMentionInput);
            commentInput.addEventListener('keydown', handleMentionKeydown);
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚ŒãŸã¨ãã¯å€™è£œã‚’éè¡¨ç¤º
            commentInput.addEventListener('blur', () => {
                setTimeout(() => hideMentionSuggestions(), 200);
            });
        }
        
        function handleMentionInput(e) {
            const input = e.target;
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            // @ãƒãƒ¼ã‚¯ã®ä½ç½®ã‚’æ¢ã™
            let atPos = -1;
            for (let i = cursorPos - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atPos = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }
            
            if (atPos !== -1) {
                mentionStartPos = atPos;
                mentionQuery = text.substring(atPos + 1, cursorPos);
                showMentionSuggestions(mentionQuery, input);
            } else {
                hideMentionSuggestions();
            }
        }
        
        function handleMentionKeydown(e) {
            const suggestions = document.getElementById('mention-suggestions');
            if (suggestions.style.display === 'none') return;
            
            const suggestionItems = suggestions.querySelectorAll('.mention-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                mentionSuggestionIndex = Math.min(mentionSuggestionIndex + 1, suggestionItems.length - 1);
                updateMentionSelection(suggestionItems);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                mentionSuggestionIndex = Math.max(mentionSuggestionIndex - 1, 0);
                updateMentionSelection(suggestionItems);
            } else if (e.key === 'Enter' && mentionSuggestionIndex >= 0) {
                e.preventDefault();
                const selectedItem = suggestionItems[mentionSuggestionIndex];
                if (selectedItem) {
                    insertMention(selectedItem.textContent);
                }
            } else if (e.key === 'Escape') {
                hideMentionSuggestions();
            }
        }
        
        function showMentionSuggestions(query, input) {
            const suggestions = document.getElementById('mention-suggestions');
            const availableUsers = [...new Set([...assignees])];
            
            const filteredUsers = availableUsers.filter(user => 
                user.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);
            
            if (filteredUsers.length === 0) {
                hideMentionSuggestions();
                return;
            }
            
            suggestions.innerHTML = filteredUsers.map((user, index) => 
                `<div class="mention-suggestion" onclick="insertMention('${user}')">${user}</div>`
            ).join('');
            
            // ä½ç½®ã‚’èª¿æ•´
            const rect = input.getBoundingClientRect();
            suggestions.style.left = '10px';
            suggestions.style.bottom = '60px';
            suggestions.style.display = 'block';
            
            mentionSuggestionIndex = -1;
        }
        
        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === mentionSuggestionIndex);
            });
        }
        
        function insertMention(userName) {
            const input = document.getElementById('comment-input');
            const text = input.value;
            const beforeMention = text.substring(0, mentionStartPos);
            const afterMention = text.substring(input.selectionStart);
            
            const newText = `${beforeMention}@${userName} ${afterMention}`;
            input.value = newText;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
            const newCursorPos = mentionStartPos + userName.length + 2;
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            hideMentionSuggestions();
            input.focus();
        }
        
        function hideMentionSuggestions() {
            const suggestions = document.getElementById('mention-suggestions');
            suggestions.style.display = 'none';
            mentionSuggestionIndex = -1;
            mentionStartPos = -1;
            mentionQuery = '';
        }
        
        function addComment() {
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            
            if (!commentText) {
                alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‹ã‚‰å„ªå…ˆå–å¾—ï¼‰
            let currentUser = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user && session.user.name) {
                    currentUser = session.user.name;
                    console.log(`ğŸ“ [COMMENT] ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser}`);
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã‹ã‚‰å–å¾—
                    currentUser = document.getElementById('assignee-filter')?.value || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                    console.log(`ğŸ“ [COMMENT] ãƒ•ã‚£ãƒ«ã‚¿ã‹ã‚‰å–å¾—: ${currentUser}`);
                }
            } catch (error) {
                console.log(`âš ï¸ [COMMENT] ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
                currentUser = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            }
            
            const newComment = {
                id: Date.now(),
                author: currentUser || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                text: commentText,
                timestamp: new Date().toISOString()
            };
            
            // editingTaskãŒã‚ã‚‹å ´åˆã¯ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯ã«ã€ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
            if (editingTask) {
                // ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
                if (!editingTask.comments) editingTask.comments = [];
                editingTask.comments.push(newComment);
                saveTasks();
                displayComments(editingTask.comments);
                
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ã¯ç·¨é›†ä¿å­˜æ™‚ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å®Ÿè¡Œã—ãªã„
            }
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            commentInput.value = '';
            
        }
        
        function checkMentionNotifications(text, author, task) {
            console.log(`ğŸ” [MENTION] ãƒã‚§ãƒƒã‚¯é–‹å§‹: "${text}" by ${author}`);
            console.log(`ğŸ” [MENTION] ç¾åœ¨ã®æ‹…å½“è€…ãƒªã‚¹ãƒˆ:`, assignees);
            
            // @ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’æ¤œå‡ºï¼ˆæ—¥æœ¬èªæ–‡å­—å¯¾å¿œï¼‰
            const mentionPattern = /@([^\s@]+)/g;
            const mentions = text.match(mentionPattern);
            console.log(`ğŸ” [MENTION] ä½¿ç”¨ã—ãŸæ­£è¦è¡¨ç¾: ${mentionPattern}`);
            
            console.log(`ğŸ” [MENTION] æ¤œå‡ºã•ã‚ŒãŸãƒ¡ãƒ³ã‚·ãƒ§ãƒ³:`, mentions);
            
            if (mentions) {
                mentions.forEach(mention => {
                    const mentionedUser = mention.substring(1); // @ã‚’é™¤å»
                    console.log(`ğŸ” [MENTION] å‡¦ç†ä¸­: ${mention} â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${mentionedUser}`);
                    console.log(`ğŸ” [MENTION] æ‹…å½“è€…ãƒªã‚¹ãƒˆã«å­˜åœ¨: ${assignees.includes(mentionedUser)}`);
                    
                    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‹…å½“è€…ãƒªã‚¹ãƒˆã«å­˜åœ¨ã™ã‚‹å ´åˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ã«è‡ªå·±ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚‚è¨±å¯ï¼‰
                    if (assignees.includes(mentionedUser)) {
                        console.log(`âœ… [MENTION] é€šçŸ¥é€ä¿¡æº–å‚™: ${mentionedUser}`);
                        
                        // è‡ªåˆ†è‡ªèº«ã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‹ã©ã†ã‹ã§é€šçŸ¥å†…å®¹ã‚’å¤‰æ›´
                        const notificationTitle = mentionedUser === author ? 'ğŸ’¬ ã‚»ãƒ«ãƒ•ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆï¼‰' : 'ğŸ’¬ ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥';
                        const shortComment = text.length > 50 ? text.substring(0, 50) + '...' : text;
                        const notificationBody = mentionedUser === author 
                            ? `ã€Œ${task.title}ã€ã§ã‚»ãƒ«ãƒ•ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³\nğŸ’¬ ${shortComment}`
                            : `${author}ã•ã‚“ãŒã€Œ${task.title}ã€ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³\nğŸ’¬ ${shortComment}`;
                        
                        console.log(`ğŸ”” [MENTION] é€šçŸ¥å®Ÿè¡Œ: ${notificationTitle} - ${notificationBody}`);
                        
                        showNotification(
                            notificationTitle,
                            notificationBody,
                            { 
                                tag: `mention-${Date.now()}`,
                                taskId: task.id,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">ğŸ’¬</text></svg>'
                            }
                        );
                        
                        console.log(`âœ… [MENTION] é€šçŸ¥é€ä¿¡å®Œäº†: ${mentionedUser}ã•ã‚“`);
                    } else {
                        console.log(`âŒ [MENTION] æ‹…å½“è€…ãƒªã‚¹ãƒˆã«å­˜åœ¨ã—ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ${mentionedUser}`);
                    }
                });
            } else {
                console.log(`âŒ [MENTION] ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ`);
            }
        }
        
        function checkCollaborativeTaskNotifications(task, assignedUsers) {
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ‡ãƒ¢ç”¨: æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã®å€¤ã‚’ä½¿ç”¨ï¼‰
            const currentUser = document.getElementById('assignee-filter')?.value || 'ä½œæˆè€…';
            
            // è¤‡æ•°ã®æ‹…å½“è€…ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸå ´åˆã€å„æ‹…å½“è€…ã«é€šçŸ¥
            if (assignedUsers && assignedUsers.length > 0) {
                assignedUsers.forEach(user => {
                    // è‡ªåˆ†ä»¥å¤–ã®æ‹…å½“è€…ã«é€šçŸ¥ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ¯”è¼ƒï¼‰
                    if (user !== currentUser) {
                        showNotification(
                            'ğŸ‘¥ å…±åŒã‚¿ã‚¹ã‚¯å‰²ã‚Šå½“ã¦',
                            `${currentUser}ã•ã‚“ãŒã‚ãªãŸã‚’ã€Œ${task.title}ã€ã®æ‹…å½“è€…ã«è¨­å®šã—ã¾ã—ãŸ`,
                            { 
                                tag: `collab-${task.id}-${user}`,
                                taskId: task.id,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">ğŸ‘¥</text></svg>'
                            }
                        );
                        
                        console.log(`å…±åŒã‚¿ã‚¹ã‚¯é€šçŸ¥: ${user}ã•ã‚“ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
                    }
                });
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'ãŸã£ãŸä»Š';
            if (diffMins < 60) return `${diffMins}åˆ†å‰`;
            if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`;
            if (diffDays < 7) return `${diffDays}æ—¥å‰`;
            
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        async function saveTask(event) {
            try {
                console.log('ğŸš€ [SAVE TASK] Starting saveTask function...');
                event.preventDefault();
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ task-column-input ã® required å±æ€§ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤
            const columnInput = document.getElementById('task-column-input');
            const columnSelectionGroup = document.getElementById('column-selection-group');
            const wasRequired = columnInput.hasAttribute('required');
            const isColumnSelectionHidden = columnSelectionGroup.style.display === 'none';
            
            if (isColumnSelectionHidden && wasRequired) {
                columnInput.removeAttribute('required');
                console.log(`ğŸ”§ [FORM] Temporarily removed required attribute from task-column-input`);
            }
            
            const title = document.getElementById('task-title-input').value.trim();
            const date = document.getElementById('task-date-input').value;
            const time = document.getElementById('task-time-input').value;
            const priority = document.getElementById('task-priority-input').value;
            const selectedAssignees = getSelectedAssignees();
            const memo = document.getElementById('task-memo-input').value.trim();
            const fileInput = document.getElementById('task-files-input');
            
            // PJã‚¿ã‚¹ã‚¯æ©Ÿèƒ½ã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ãŸãŸã‚ã€å¸¸ã«é€šå¸¸ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å‡¦ç†
            const isProjectTask = false;
            const projectId = '';
            const projectName = '';
            const selectedApprovers = [];
            
            if (!title || !date) {
                alert('ã‚¿ã‚¹ã‚¯åã¨æœŸé™æ—¥ã¯å¿…é ˆã§ã™');
                return;
            }
            
            // Phase 2: PJã‚¿ã‚¹ã‚¯é–¢é€£ã®å¤‰æ•°ã‚’äº‹å‰ã«å®šç¾©
            let finalApprovers = [];
            
            // Phase 2: PJã‚¿ã‚¹ã‚¯ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (isProjectTask) {
                console.log(`ğŸ” [PJ VALIDATION] ProjectID: "${projectId}", ProjectName: "${projectName}", Approvers: [${selectedApprovers.join(', ')}]`);
                
                if (!projectId || !projectName) {
                    alert('PJã‚¿ã‚¹ã‚¯ã®å ´åˆã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯å¿…é ˆã§ã™');
                    // requiredå±æ€§ã‚’å¾©æ´»ã•ã›ã¦ã‹ã‚‰return
                    if (wasRequired && isColumnSelectionHidden) {
                        columnInput.setAttribute('required', '');
                    }
                    return;
                }
                if (selectedApprovers.length === 0) {
                    // æ‰¿èªè€…ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯è‡ªå‹•ã§æ‹…å½“è€…ã‚’æ‰¿èªè€…ã«è¨­å®š
                    if (selectedAssignees.length > 0) {
                        console.log(`âš ï¸ [PJ VALIDATION] No approvers selected, using assignees as approvers: [${selectedAssignees.join(', ')}]`);
                        // æ‰¿èªè€…ã‚’è‡ªå‹•è¨­å®šï¼ˆæ‹…å½“è€…ã®ä¸­ã‹ã‚‰ï¼‰
                        const approverCheckboxes = document.querySelectorAll('#project-approvers input[type="checkbox"]');
                        approverCheckboxes.forEach(cb => {
                            if (selectedAssignees.includes(cb.value)) {
                                cb.checked = true;
                            }
                        });
                        // å†åº¦å–å¾—
                        const autoSelectedApprovers = getSelectedApprovers();
                        if (autoSelectedApprovers.length === 0) {
                            alert('PJã‚¿ã‚¹ã‚¯ã®å ´åˆã€æ‰¿èªè€…ã‚’1åä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„\n\nâ€» æ‰¿èªè€…ä¸€è¦§ã‹ã‚‰1åä»¥ä¸Šãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„\nâ€» ã¾ãŸã¯æ‹…å½“è€…ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„');
                            // requiredå±æ€§ã‚’å¾©æ´»ã•ã›ã¦ã‹ã‚‰return
                            if (wasRequired && isColumnSelectionHidden) {
                                columnInput.setAttribute('required', '');
                            }
                            return;
                        }
                    } else {
                        alert('PJã‚¿ã‚¹ã‚¯ã®å ´åˆã€æ‰¿èªè€…ã‚’1åä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„\n\nâ€» æ‰¿èªè€…ä¸€è¦§ã‹ã‚‰1åä»¥ä¸Šãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„\nâ€» ã¾ãŸã¯æ‹…å½“è€…ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„');
                        // requiredå±æ€§ã‚’å¾©æ´»ã•ã›ã¦ã‹ã‚‰return
                        if (wasRequired && isColumnSelectionHidden) {
                            columnInput.setAttribute('required', '');
                        }
                        return;
                    }
                }
                finalApprovers = getSelectedApprovers(); // æœ€æ–°ã®æ‰¿èªè€…ã‚’å–å¾—
                console.log(`ğŸ¯ [PJ TASK] Creating project task: ${projectId} - ${projectName} with approvers: [${finalApprovers.join(', ')}]`);
            }
            
            if (selectedAssignees.length === 0) {
                if (!confirm('æ‹…å½“è€…ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }
            
            const deadline = new Date(`${date}T${time || '23:59'}`);
            
            // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
            const attachments = [];
            if (fileInput.files.length > 0) {
                const fileProcessingPromises = Array.from(fileInput.files).map(file => {
                    return new Promise((resolve, reject) => {
                        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ (5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            reject(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ãŒå¤§ãã™ãã¾ã™ï¼ˆ5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰`);
                            return;
                        }
                        
                        const fileInfo = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            lastModified: file.lastModified
                        };
                        
                        // ç”»åƒã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ãƒ‡ãƒ¼ã‚¿URLã‚’ç”Ÿæˆ
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                fileInfo.dataUrl = e.target.result;
                                resolve(fileInfo);
                            };
                            reader.onerror = () => resolve(fileInfo);
                            reader.readAsDataURL(file);
                        } else {
                            resolve(fileInfo);
                        }
                    });
                });
                
                try {
                    const processedFiles = await Promise.all(fileProcessingPromises);
                    attachments.push(...processedFiles);
                } catch (error) {
                    alert(error);
                    return;
                }
            }
            
            if (editingTask) {
                // æœŸé™å¤‰æ›´ã®ç¢ºèªå‡¦ç†
                const oldDeadline = new Date(editingTask.deadline);
                const newDeadline = deadline;
                const wasOverdue = isOverdue(editingTask.deadline, editingTask.columnId);
                const willBeOverdue = isOverdue(newDeadline.toISOString(), editingTask.columnId);
                
                console.log(`ğŸ” [DEADLINE] Checking deadline change for task ${editingTask.id}`);
                console.log(`ğŸ” [DEADLINE] Old deadline: ${editingTask.deadline}, wasOverdue: ${wasOverdue}`);
                console.log(`ğŸ” [DEADLINE] New deadline: ${newDeadline.toISOString()}, willBeOverdue: ${willBeOverdue}`);
                console.log(`ğŸ” [DEADLINE] Task column: ${editingTask.columnId}`);
                
                // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã®æœŸé™ãŒå»¶é•·ã•ã‚ŒãŸå ´åˆã®ç¢ºèª
                if (wasOverdue && !willBeOverdue) {
                    console.log(`ğŸ“… [DEADLINE] Overdue task deadline extended, showing confirmation dialog`);
                    const columnTitle = getColumnTitle(editingTask.columnId);
                    const shouldMoveBack = confirm(
                        `ğŸ“… æœŸé™ãŒå»¶é•·ã•ã‚Œã¾ã—ãŸ\n\n` +
                        `"${editingTask.title}" ã®æœŸé™ãŒå»¶é•·ã•ã‚Œã€æœŸé™åˆ‡ã‚Œã§ã¯ãªããªã‚Šã¾ã™ã€‚\n\n` +
                        `å…ƒã®é€²æ—çŠ¶æ³ã€Œ${columnTitle}ã€ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                        `â€¢ OK: ${columnTitle}ã«æˆ»ã™\n` +
                        `â€¢ ã‚­ãƒ£ãƒ³ã‚»ãƒ«: æœŸé™åˆ‡ã‚Œã‚¨ãƒªã‚¢ã«æ®‹ã™`
                    );
                    
                    if (!shouldMoveBack) {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœŸé™åˆ‡ã‚Œã‚¨ãƒªã‚¢ã«æ®‹ã™ã“ã¨ã‚’é¸æŠã—ãŸå ´åˆã€
                        // æœŸé™ã‚’å…ƒã«æˆ»ã—ã¦æœŸé™åˆ‡ã‚Œã®ã¾ã¾ã«ã™ã‚‹
                        if (confirm('æœŸé™å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€å…ƒã®æœŸé™ã®ã¾ã¾ã«ã—ã¾ã™ã‹ï¼Ÿ')) {
                            console.log(`âš ï¸ User chose to cancel deadline change for task ${editingTask.id}`);
                            closeModal();
                            return;
                        }
                    }
                    console.log(`ğŸ“… Deadline extended for overdue task ${editingTask.id}, moving back: ${shouldMoveBack}`);
                } else {
                    console.log(`ğŸ” [DEADLINE] No confirmation needed: wasOverdue=${wasOverdue}, willBeOverdue=${willBeOverdue}`);
                }
                
                // ç·¨é›†
                editingTask.title = title;
                editingTask.deadline = deadline.toISOString();
                editingTask.priority = priority;
                editingTask.assignees = selectedAssignees;
                // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚å¤ã„assigneeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ä¿æŒ
                editingTask.assignee = selectedAssignees.length > 0 ? selectedAssignees[0] : 'æœªè¨­å®š';
                editingTask.memo = memo;
                
                // Phase 2: PJã‚¿ã‚¹ã‚¯ã®ç·¨é›†ã§ã¯PJæƒ…å ±ã¯å¤‰æ›´ã—ãªã„
                console.log(`ğŸ“ [TASK EDIT] Updated task: ${editingTask.title}`);
                
                // æ–°ã—ã„æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
                if (attachments.length > 0) {
                    if (!editingTask.attachments) editingTask.attachments = [];
                    editingTask.attachments.push(...attachments);
                }
            } else {
                // æ–°è¦ä½œæˆ
                const isUnifiedMode = document.getElementById('task-modal').dataset.unifiedMode === 'true';
                const targetColumn = isUnifiedMode 
                    ? document.getElementById('task-column-input').value 
                    : document.getElementById('task-modal').dataset.targetColumn;
                const newTask = {
                    id: Date.now(),
                    title: title,
                    deadline: deadline.toISOString(),
                    priority: priority,
                    assignees: selectedAssignees,
                    // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚å¤ã„assigneeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ä¿æŒ
                    assignee: selectedAssignees.length > 0 ? selectedAssignees[0] : 'æœªè¨­å®š',
                    memo: memo,
                    attachments: attachments,
                    comments: [],
                    columnId: targetColumn,
                    completed: targetColumn === 'done',
                    createdAt: new Date().toISOString(),
                    
                    // Phase 2: PJã‚¿ã‚¹ã‚¯æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                    projectId: isProjectTask ? projectId : null,
                    projectName: isProjectTask ? projectName : null,
                    personalStatus: targetColumn,
                    projectStatus: targetColumn,
                    pendingMove: null,
                    approvers: isProjectTask ? finalApprovers : [],
                    lastApprovedBy: null,
                    approvedAt: null
                };
                
                if (isProjectTask) {
                    console.log(`ğŸ¯ [PJ TASK CREATE] Created new PJ task: ${projectId} - ${projectName}, approvers: ${finalApprovers.join(', ')}`);
                } else {
                    console.log(`ğŸ‘¤ [PERSONAL TASK CREATE] Created new personal task: ${title}`);
                }
                tasks.unshift(newTask);
                
                // å…±åŒã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã®é€šçŸ¥
                checkCollaborativeTaskNotifications(newTask, selectedAssignees);
            }
            
            saveTasks();
            render();
            
            // ç·¨é›†ä¿å­˜æ™‚ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ãƒã‚§ãƒƒã‚¯
            if (editingTask && editingTask.comments && editingTask.comments.length > 0) {
                // æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
                const latestComment = editingTask.comments[editingTask.comments.length - 1];
                console.log(`ğŸ”” [SAVE] æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ãƒã‚§ãƒƒã‚¯: "${latestComment.text}"`);
                checkMentionNotifications(latestComment.text, latestComment.author, editingTask);
            }
            
            // ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»ç·¨é›†å¾Œã«å³åº§ã«æœŸé™ãƒã‚§ãƒƒã‚¯
            setTimeout(() => checkDeadlines(), 100);
            
            // required å±æ€§ã‚’å¾©æ´» (çµ±ä¸€ä½œæˆãƒ¢ãƒ¼ãƒ‰ç”¨)
            if (wasRequired && isColumnSelectionHidden) {
                columnInput.setAttribute('required', '');
                console.log(`ğŸ”§ [FORM] Restored required attribute to task-column-input`);
            }
            
            closeModal();
            
            } catch (error) {
                console.error('ğŸš¨ [SAVE TASK ERROR]', error);
                alert('ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚requiredå±æ€§ã‚’å¾©æ´»
                if (wasRequired && isColumnSelectionHidden) {
                    columnInput.setAttribute('required', '');
                }
            }
        }
        
        function closeModal() {
            document.getElementById('task-modal').classList.remove('show');
            editingTask = null;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            const fileInput = document.getElementById('task-files-input');
            const dropZone = document.getElementById('file-drop-zone');
            const commentInput = document.getElementById('comment-input');
            
            if (fileInput) {
                fileInput.value = '';
            }
            if (dropZone) {
                dropZone.innerHTML = 'ğŸ“ ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ä¸Šè¨˜ãƒœã‚¿ãƒ³ã§é¸æŠ';
            }
            if (commentInput) {
                commentInput.value = '';
            }
            
            // Phase 2: PJã‚¿ã‚¹ã‚¯è¨­å®šã‚’éè¡¨ç¤ºã«æˆ»ã™
            // PJã‚¿ã‚¹ã‚¯è¨­å®šã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            // PJãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            
            // æ‰¿èªè€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
            const approverCheckboxes = document.querySelectorAll('#project-approvers input[type="checkbox"]');
            approverCheckboxes.forEach(cb => cb.checked = false);
        }
        
        function deleteTask(taskId) {
            if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                render();
                playMoveSound();
            }
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        function handleDragStart(e, taskId) {
            console.log(`ğŸŸ¢ [MAIN] handleDragStart called with taskId: ${taskId}`);
            console.log(`ğŸŸ¢ [MAIN] All tasks:`, tasks);
            console.log(`ğŸŸ¢ [MAIN] isBulkMode: ${isBulkMode}`);
            draggedTask = tasks.find(t => t.id === taskId);
            console.log(`ğŸŸ¢ [MAIN] Found draggedTask:`, draggedTask);
            if (!draggedTask) {
                console.error(`âŒ [MAIN] draggedTask not found for taskId: ${taskId}`);
                return false;
            }
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', taskId);
        }
        
        function handleDragEnd(e) {
            console.log(`ğŸ”´ [MAIN] handleDragEnd called`);
            e.target.classList.remove('dragging');
            draggedTask = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDrop(e, columnId) {
            console.log(`ğŸ”µ [MAIN] handleDrop called with columnId: ${columnId}`);
            console.log(`ğŸ”µ [MAIN] draggedTask:`, draggedTask);
            console.log(`ğŸ”µ [MAIN] Event target:`, e.target);
            console.log(`ğŸ”µ [MAIN] Event currentTarget:`, e.currentTarget);
            e.preventDefault();
            const dropZone = e.currentTarget;
            dropZone.classList.remove('drag-over');
            
            if (draggedTask) {
                console.log(`ğŸ”µ [MAIN] Current task column: ${draggedTask.columnId}, Target: ${columnId}`);
                
                if (draggedTask.columnId !== columnId) {
                    // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã®drag&dropã¯ç„¡åŠ¹ï¼ˆæœŸé™å»¶é•·ã§ã®ã¿ç§»å‹•å¯èƒ½ï¼‰
                    if (draggedTask.deadline && isOverdue(draggedTask.deadline, draggedTask.columnId)) {
                        console.log(`âŒ [MAIN] Overdue task drag&drop is disabled`);
                        alert('æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯ç›´æ¥ç§»å‹•ã§ãã¾ã›ã‚“ã€‚\nç·¨é›†ç”»é¢ã§æœŸé™ã‚’å»¶é•·ã™ã‚‹ã¨ç§»å‹•ã§ãã¾ã™ã€‚');
                        return;
                    }
                    
                    console.log(`ğŸŸ¡ [MAIN] Moving "${draggedTask.title}" from ${draggedTask.columnId} to ${columnId}`);
                    
                    // PJã‚¿ã‚¹ã‚¯ã®è¨¼æ†‘ãƒã‚§ãƒƒã‚¯
                    if (draggedTask.projectId && draggedTask.projectName) {
                        const hasEvidence = checkTaskEvidence(draggedTask);
                        if (!hasEvidence) {
                            const evidenceResult = promptForEvidence(draggedTask);
                            if (!evidenceResult) {
                                console.log(`âŒ [PJ] è¨¼æ†‘ãªã—ã®ãŸã‚ç§»å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ${draggedTask.title}`);
                                return; // ç§»å‹•ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            }
                        }
                    }
                    
                    // Doneã‚«ãƒ©ãƒ ã«ç§»å‹•ã™ã‚‹å ´åˆã€completedAtã‚’è¨˜éŒ²
                    if (columnId === 'done' && !draggedTask.completedAt) {
                        draggedTask.completedAt = new Date().toISOString();
                    }
                    // Doneã‚«ãƒ©ãƒ ã‹ã‚‰ä»–ã«ç§»å‹•ã™ã‚‹å ´åˆã€completedAtã‚’ã‚¯ãƒªã‚¢
                    else if (draggedTask.columnId === 'done' && columnId !== 'done') {
                        draggedTask.completedAt = null;
                    }
                    
                    draggedTask.columnId = columnId;
                    draggedTask.completed = (columnId === 'done');
                    saveTasks();
                    render();
                    updateStats();
                    
                    console.log(`âœ… [MAIN] Task moved successfully to ${columnId}`);
                } else {
                    console.log(`âš ï¸ [MAIN] Same column, no move needed`);
                }
            } else {
                console.log(`âŒ [MAIN] No draggedTask found`);
            }
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        function handleOverdueDrop(e) {
            console.log(`ğŸ”´ [OVERDUE] handleOverdueDrop called - disabled`);
            e.preventDefault();
            const dropZone = e.currentTarget;
            dropZone.classList.remove('drag-over');
            
            // æœŸé™åˆ‡ã‚Œã‚¨ãƒªã‚¢ã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—ã¯ç„¡åŠ¹
            alert('æœŸé™åˆ‡ã‚Œã‚¨ãƒªã‚¢ã«ã¯ç›´æ¥ç§»å‹•ã§ãã¾ã›ã‚“ã€‚\nç·¨é›†ç”»é¢ã§æœŸé™ã‚’å»¶é•·ã—ã¦ãã ã•ã„ã€‚');
            console.log(`âŒ [OVERDUE] Drop to overdue area is disabled`);
        }
        
        function getColumnTitle(columnId) {
            const column = columns.find(c => c.id === columnId);
            return column ? column.title : columnId;
        }
        
        
        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function render() {
            const board = document.getElementById('kanban-board');
            board.innerHTML = '';
            
            // çµ±åˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            let filteredTasks = tasks;
            
            if (selectedProjectFilters.length > 0) {
                // PJãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ç‰¹å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º
                filteredTasks = tasks.filter(t => 
                    t.projectId && selectedProjectFilters.includes(t.projectId)
                );
                console.log(`ğŸ‘¥ [RENDER] Project filter: showing ${filteredTasks.length} tasks for project ${selectedProjectFilters[0]}`);
            } else if (selectedAssigneeFilters.length > 0) {
                // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ç‰¹å®šæ‹…å½“è€…ã®ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º
                filteredTasks = tasks.filter(t => {
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.some(a => selectedAssigneeFilters.includes(a));
                    }
                    return selectedAssigneeFilters.includes(t.assignee);
                });
                console.log(`ğŸ‘¤ [RENDER] Assignee filter: showing ${filteredTasks.length} tasks for ${selectedAssigneeFilters[0]}`);
            } else {
                // å…¨å“¡: å…¨ã‚¿ã‚¹ã‚¯è¡¨ç¤º
                console.log(`ğŸ‘¥ [RENDER] Showing all ${filteredTasks.length} tasks`);
            }
            
            // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰ï¼‰
            let overdueTasks = filteredTasks.filter(t => 
                t.columnId !== 'done' && 
                t.deadline && 
                isOverdue(t.deadline, t.columnId)
            );
            
            // æœŸé™åˆ‡ã‚Œã‚«ãƒ©ãƒ ã‚’æœ€åˆã«è¡¨ç¤º
            if (overdueTasks.length > 0) {
                const overdueColumn = document.createElement('div');
                overdueColumn.className = 'column';
                overdueColumn.style.borderTop = '3px solid #e53e3e';
                overdueColumn.innerHTML = `
                    <div class="column-header" style="background: #e53e3e; color: white;">
                        <div class="column-title">ğŸš¨ æœŸé™åˆ‡ã‚Œ</div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <div class="column-count">${overdueTasks.length}</div>
                        </div>
                    </div>
                    <div class="column-content" 
                         style="background: #fee;"
                         ondragover="handleDragOver(event)"
                         ondrop="handleOverdueDrop(event)"
                         ondragenter="handleDragEnter(event)"
                         ondragleave="handleDragLeave(event)">
                        ${overdueTasks.map(task => createTaskCard(task, true)).join('')}
                    </div>
                `;
                board.appendChild(overdueColumn);
            }
            
            // é€šå¸¸ã®ã‚«ãƒ©ãƒ ã‚’è¡¨ç¤º
            columns.forEach(column => {
                let columnTasks = filteredTasks.filter(t => {
                    // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯æœŸé™åˆ‡ã‚Œã‚«ãƒ©ãƒ ã«è¡¨ç¤ºã™ã‚‹ã®ã§é™¤å¤–
                    if (t.columnId !== 'done' && t.deadline && isOverdue(t.deadline, t.columnId)) {
                        return false;
                    }
                    return t.columnId === column.id;
                });
                
                // æœŸé™é †ã§ã‚½ãƒ¼ãƒˆ
                columnTasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                
                const columnEl = document.createElement('div');
                columnEl.className = 'column';
                columnEl.setAttribute('data-column-id', column.id); // ã‚´ãƒŸç®±ã‚¹ã‚¿ã‚¤ãƒ«ç”¨
                columnEl.innerHTML = `
                    <div class="column-header" style="background: ${column.color}; color: white;">
                        <div class="column-title" ondblclick="editColumnNameInline('${column.id}', this)">${column.title}</div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <div class="column-count">${columnTasks.length}</div>
                            <div style="display: flex; gap: 0.25rem;">
                                <button onclick="editColumnNameInline('${column.id}')" style="background: rgba(255,255,255,0.2); border: none; cursor: pointer; color: white; font-size: 0.8rem; padding: 0.2rem; border-radius: 3px;" title="ç·¨é›†">âœï¸</button>
                                ${columns.length > 2 ? `<button onclick="deleteColumnInline('${column.id}')" style="background: rgba(255,255,255,0.2); border: none; cursor: pointer; color: white; font-size: 0.8rem; padding: 0.2rem; border-radius: 3px;" title="å‰Šé™¤">ğŸ—‘ï¸</button>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="column-content" 
                         ondragover="handleDragOver(event)"
                         ondrop="handleDrop(event, '${column.id}')"
                         ondragenter="handleDragEnter(event)"
                         ondragleave="handleDragLeave(event)">
                        ${columnTasks.map(task => createTaskCard(task)).join('')}
                    </div>
                `;
                
                board.appendChild(columnEl);
            });
            
            updateStats();
        }
        
        function createTaskCard(task, isFromOverdueColumn = false) {
            console.log(`ğŸ´ [CARD] Creating card for task ${task.id}, isBulkMode: ${isBulkMode}, isFromOverdueColumn: ${isFromOverdueColumn}`);
            const deadline = new Date(task.deadline);
            const isOverdueTask = isOverdue(task.deadline, task.columnId);
            const isTodayTask = isToday(task.deadline, task.columnId);
            const now = new Date();
            console.log(`ğŸ´ [CARD] Task ${task.id} - deadline: ${task.deadline}, columnId: ${task.columnId}`);
            console.log(`ğŸ´ [CARD] Task ${task.id} - Current time: ${now.toISOString()}, deadline < now: ${deadline < now}`);
            console.log(`ğŸ´ [CARD] Task ${task.id} - isOverdueTask: ${isOverdueTask}, draggable: ${!isBulkMode}`);
            
            // çµŒéæ™‚é–“ã‚’è¨ˆç®—
            let daysSinceCreated = 0;
            let elapsedText = '';
            let isStale = false; // 3æ—¥ä»¥ä¸Šåœæ»ãƒ•ãƒ©ã‚°
            
            if (task.createdAt) {
                const createdDate = new Date(task.createdAt);
                const now = new Date();
                const timeDiff = now - createdDate;
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                daysSinceCreated = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                
                if (hoursDiff < 24) {
                    // 24æ™‚é–“ä»¥å†…ã¯æ™‚é–“è¡¨ç¤º
                    elapsedText = `${String(hoursDiff).padStart(2, '0')}h`;
                } else {
                    // 24æ™‚é–“ä»¥ä¸Šã¯æ—¥æ•°è¡¨ç¤º
                    elapsedText = `${daysSinceCreated}d`;
                }
                
                // 3æ—¥ä»¥ä¸Šã§å®Œäº†ã—ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã¯åœæ»ãƒ•ãƒ©ã‚°
                if (daysSinceCreated >= 3 && task.columnId !== 'done') {
                    isStale = true;
                }
            }
            
            let cardClass = `task-card priority-${task.priority}`;
            if (isOverdueTask) cardClass += ' overdue';
            else if (isTodayTask) cardClass += ' today';
            
            let deadlineClass = 'task-deadline';
            let deadlineIcon = 'ğŸ“…';
            if (isOverdueTask) {
                deadlineClass += ' overdue';
                deadlineIcon = 'ğŸš¨';
            } else if (isTodayTask) {
                deadlineClass += ' today';
                deadlineIcon = 'â°';
            }
            
            const priorityText = {
                high: 'ğŸ”´ æœ€é‡è¦',
                medium: 'ğŸŸ¡ é‡è¦', 
                low: 'ğŸŸ¢ é€šå¸¸'
            }[task.priority];
            
            const checkboxHtml = isBulkMode ? `
                <div style="position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10;">
                    <input type="checkbox" 
                           onchange="toggleTaskSelection(${task.id})" 
                           onclick="event.stopPropagation()"
                           ${selectedTasks.has(task.id) ? 'checked' : ''}
                           style="width: 16px; height: 16px; cursor: pointer;">
                </div>
            ` : '';
            
            return `
                <div class="${cardClass}" 
                     draggable="${!isBulkMode && !(isFromOverdueColumn || isOverdueTask)}"
                     ${(!isBulkMode && !(isFromOverdueColumn || isOverdueTask)) ? `ondragstart="handleDragStart(event, ${task.id})" ondragend="handleDragEnd(event)"` : ''}
                     onclick="${isBulkMode ? `toggleTaskSelection(${task.id})` : `editTask(${task.id})`}"
                     style="position: relative; cursor: ${isBulkMode ? 'pointer' : ((isFromOverdueColumn || isOverdueTask) ? 'default' : 'move')}; ${(isFromOverdueColumn || isOverdueTask) ? 'opacity: 0.9;' : ''} ${isStale ? 'border: 2px solid #e53e3e; box-shadow: 0 0 8px rgba(229, 62, 62, 0.3);' : ''}"
                     title="${(isFromOverdueColumn || isOverdueTask) ? 'æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã§ã™ã€‚ç§»å‹•ã™ã‚‹ã«ã¯ç·¨é›†ã§æœŸé™ã‚’å»¶é•·ã—ã¦ãã ã•ã„ã€‚' : ''}${isStale ? ' âš ï¸ 3æ—¥ä»¥ä¸Šåœæ»ä¸­' : ''}">
                    ${checkboxHtml}
                    <div class="task-title" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span style="flex: 1;">
                            ${task.isRecurring ? '<span style="color: #2d3748; margin-right: 0.25rem;" title="å®šæœŸã‚¿ã‚¹ã‚¯">ğŸ”„</span>' : ''}
                            ${task.projectId ? '<span style="color: #2b6cb0; margin-right: 0.25rem;" title="PJã‚¿ã‚¹ã‚¯">ğŸ‘¥</span>' : ''}
                            ${task.title}
                        </span>
                        <button onclick="deleteTask(${task.id}); event.stopPropagation();" 
                                style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9rem; padding: 2px; opacity: 0.7; margin-left: 8px;"
                                title="ã‚´ãƒŸç®±ã«ç§»å‹•"
                                onmouseover="this.style.opacity='1'"
                                onmouseout="this.style.opacity='0.7'">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="task-meta">
                        <div style="margin-bottom: 0.25rem;">
                            <span class="${deadlineClass}">
                                ${deadlineIcon} ${deadline.toLocaleDateString('ja-JP')} ${deadline.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                            </span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            ${elapsedText ? `<span style="font-size: 0.75rem; color: ${isStale ? '#e53e3e' : '#718096'}; font-weight: ${isStale ? '600' : '400'};">â±ï¸ ${elapsedText}</span>` : ''}
                            ${isStale ? '<span style="font-size: 0.75rem; color: #e53e3e;">ğŸš¨ åœæ»ä¸­</span>' : ''}
                        </div>
                        <span class="task-priority-badge priority-${task.priority}">
                            ${priorityText}
                        </span>
                    </div>
                    ${task.memo ? `<div class="task-memo">${task.memo}</div>` : ''}
                    <div class="task-badges">
                        ${task.memo ? '<span class="attachment-icon">ğŸ“</span>' : ''}
                        ${task.attachments && task.attachments.length > 0 ? `<span class="attachment-badge">${task.attachments.length}</span>` : ''}
                        <span style="font-size: 0.7rem; color: #5e6c84;">ğŸ‘¤ ${getAssigneeDisplayText(task)}</span>
                    </div>
                </div>
            `;
        }
        
        function getAssigneeDisplayText(task) {
            if (task.assignees && Array.isArray(task.assignees) && task.assignees.length > 0) {
                if (task.assignees.length === 1) {
                    return task.assignees[0];
                } else if (task.assignees.length <= 3) {
                    return task.assignees.join(', ');
                } else {
                    return `${task.assignees[0]} ä»–${task.assignees.length - 1}å`;
                }
            }
            // å¾Œæ–¹äº’æ›æ€§
            return task.assignee || 'æœªè¨­å®š';
        }
        
        function updateStats() {
            const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
            let filteredTasks = tasks;
            
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            if (assigneeFilter) {
                filteredTasks = tasks.filter(t => {
                    // æ–°ã—ã„assigneesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(assigneeFilter);
                    }
                    // æ—§ã„assigneeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                    return t.assignee === assigneeFilter;
                });
            }
            
            const overdueCount = filteredTasks.filter(t => t.columnId !== 'done' && isOverdue(t.deadline, t.columnId)).length;
            const todayCount = filteredTasks.filter(t => t.columnId !== 'done' && isToday(t.deadline, t.columnId)).length;
            const completedCount = filteredTasks.filter(t => t.columnId === 'done').length;
            
            // 3æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æ¤œå‡º
            const now = new Date();
            const staleTasks = filteredTasks.filter(t => {
                if (t.columnId === 'done') return false;
                
                // createdAtãŒãªã„å ´åˆã¯ä»Šæ—¥ä½œæˆã•ã‚ŒãŸã‚‚ã®ã¨ã—ã¦æ‰±ã†ï¼ˆåœæ»åˆ¤å®šã‹ã‚‰é™¤å¤–ï¼‰
                if (!t.createdAt) return false;
                
                const createdDate = new Date(t.createdAt);
                const daysDiff = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                return daysDiff >= 3;
            });
            
            // ãƒãƒ¼ãƒ å¹³å‡ã®1.2å€ä»¥ä¸Šã®ã‚¿ã‚¹ã‚¯ã‚’æŒã¤æ‹…å½“è€…ã‚’æ¤œå‡º
            const assigneeCounts = {};
            let totalAssignedTasks = 0;
            let assigneeCount = 0;
            
            // å…¨ã‚¿ã‚¹ã‚¯ã§æ‹…å½“è€…åˆ¥ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿å‰ã®å…¨ä½“ã‹ã‚‰è¨ˆç®—ï¼‰
            tasks.forEach(task => {
                if (task.columnId !== 'done') {
                    // æ–°ã—ã„assigneesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‡¦ç†
                    if (task.assignees && Array.isArray(task.assignees)) {
                        task.assignees.forEach(assignee => {
                            if (!assigneeCounts[assignee]) {
                                assigneeCounts[assignee] = 0;
                                assigneeCount++;
                            }
                            assigneeCounts[assignee]++;
                            totalAssignedTasks++;
                        });
                    } else if (task.assignee && task.assignee !== 'æœªè¨­å®š') {
                        // æ—§assigneeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‡¦ç†
                        if (!assigneeCounts[task.assignee]) {
                            assigneeCounts[task.assignee] = 0;
                            assigneeCount++;
                        }
                        assigneeCounts[task.assignee]++;
                        totalAssignedTasks++;
                    }
                }
            });
            
            // ãƒãƒ¼ãƒ å¹³å‡ã‚’è¨ˆç®—
            const avgTasksPerPerson = assigneeCount > 0 ? totalAssignedTasks / assigneeCount : 0;
            const overloadThreshold = avgTasksPerPerson * 1.2;
            
            // éè² è·ã®æ‹…å½“è€…æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const overloadedAssignees = Object.entries(assigneeCounts)
                .filter(([assignee, count]) => count > overloadThreshold)
                .map(([assignee, count]) => ({ assignee, count }));
            
            document.getElementById('overdue-count').textContent = overdueCount;
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('stale-count').textContent = staleTasks.length;
            document.getElementById('overload-count').textContent = overloadedAssignees.length;
            
            // ç®¡ç†è€…ã®ã¿è¦èª¿æ•´ã‚’è¡¨ç¤º
            const workloadItem = document.getElementById('workload-item');
            if (workloadItem) {
                workloadItem.style.display = isAdmin() ? 'flex' : 'none';
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆè©³ç´°è¡¨ç¤ºç”¨ï¼‰
            window.staleTasks = staleTasks;
            window.overloadedAssignees = overloadedAssignees;
            window.avgTasksPerPerson = avgTasksPerPerson;
            
            // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºã‚’å‰Šé™¤: ç®¡ç†è€…ã«ã¨ã£ã¦ç”¨é€”ãŒä¸æ˜ç¢ºãªãŸã‚
            
            // åˆ†æã‚µãƒãƒªãƒ¼ã‚‚æ›´æ–°
            updateAnalyticsSummary();
        }
        
        function updateWorkflowStats(filteredTasks) {
            const workflowContainer = document.getElementById('workflow-status');
            if (!workflowContainer) return;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥çµ±è¨ˆã‚’è¨ˆç®—
            const statusStats = {};
            const now = new Date();
            
            columns.forEach(column => {
                const columnTasks = filteredTasks.filter(t => {
                    // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯æœŸé™åˆ‡ã‚Œã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§é™¤å¤–
                    if (t.columnId !== 'done' && t.deadline && isOverdue(t.deadline, t.columnId)) {
                        return false;
                    }
                    return t.columnId === column.id;
                });
                
                // å¹³å‡æ»ç•™æ™‚é–“ã‚’è¨ˆç®—
                let avgDays = 0;
                if (columnTasks.length > 0) {
                    const totalDays = columnTasks.reduce((sum, task) => {
                        if (task.createdAt) {
                            const createdDate = new Date(task.createdAt);
                            const days = Math.max(0, (now - createdDate) / (1000 * 60 * 60 * 24));
                            return sum + days;
                        }
                        return sum;
                    }, 0);
                    avgDays = Math.round((totalDays / columnTasks.length) * 10) / 10; // å°æ•°ç‚¹1æ¡
                }
                
                statusStats[column.id] = {
                    title: column.title,
                    count: columnTasks.length,
                    avgDays: avgDays,
                    color: column.color || '#026aa7'
                };
            });
            
            // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºã‚’ç”Ÿæˆ
            const workflowHtml = columns.map((column, index) => {
                const stats = statusStats[column.id];
                const isBottleneck = stats.avgDays > 2.0; // 2æ—¥ä»¥ä¸Šã§ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ¤å®š
                const statusClass = isBottleneck ? 'bottleneck' : 'normal';
                const statusIcon = isBottleneck ? 'ğŸš¨' : '';
                
                const arrow = index < columns.length - 1 ? '<span style="margin: 0 0.25rem; color: #5e6c84;">â†’</span>' : '';
                
                return `
                    <div class="workflow-status-item ${statusClass}" 
                         onclick="showStatusDetails('${column.id}')"
                         style="
                            display: flex; 
                            align-items: center; 
                            gap: 0.25rem; 
                            padding: 0.25rem 0.5rem; 
                            border-radius: 4px; 
                            cursor: pointer;
                            background: ${isBottleneck ? '#fee2e2' : '#f1f5f9'};
                            border: 1px solid ${isBottleneck ? '#fca5a5' : '#cbd5e1'};
                            transition: all 0.2s;
                         "
                         onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                         title="${stats.title}: ${stats.count}ä»¶ã€å¹³å‡${stats.avgDays}æ—¥">
                        ${statusIcon}
                        <span style="font-weight: 600; color: ${isBottleneck ? '#dc2626' : '#374151'};">${stats.title}</span>
                        <span style="color: ${isBottleneck ? '#dc2626' : '#6b7280'};">(${stats.count}ä»¶)</span>
                        ${stats.avgDays > 0 ? `<span style="font-size: 0.75rem; color: ${isBottleneck ? '#dc2626' : '#9ca3af'};">${stats.avgDays}æ—¥</span>` : ''}
                    </div>
                    ${arrow}
                `;
            }).join('');
            
            workflowContainer.innerHTML = workflowHtml;
        }
        
        // 3æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®è©³ç´°è¡¨ç¤º
        function showStaleTasksDetail() {
            if (!window.staleTasks || window.staleTasks.length === 0) {
                alert('ç¾åœ¨ã€3æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const now = new Date();
            const taskListHtml = window.staleTasks.map(task => {
                const createdDate = task.createdAt ? new Date(task.createdAt) : now;
                const daysDiff = task.createdAt ? Math.floor((now - createdDate) / (1000 * 60 * 60 * 24)) : 0;
                const column = columns.find(c => c.id === task.columnId);
                const assigneesText = task.assignees?.join(', ') || task.assignee || 'æœªè¨­å®š';
                
                // çµŒéæ—¥æ•°ã®è¡¨ç¤ºï¼ˆcreatedAtãŒãªã„å ´åˆã¯ã€Œä½œæˆæ—¥ä¸æ˜ã€ã¨è¡¨ç¤ºï¼‰
                const elapsedText = task.createdAt ? `â±ï¸ ${daysDiff}æ—¥çµŒé` : `â±ï¸ ä½œæˆæ—¥ä¸æ˜`;
                
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${task.title}</div>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #5e6c84;">
                            <span>ğŸ‘¤ ${assigneesText}</span>
                            <span>ğŸ“ ${column?.title || 'ãƒ¼'}</span>
                            <span>${elapsedText}</span>
                            ${task.deadline ? `<span>ğŸ“… æœŸé™: ${new Date(task.deadline).toLocaleDateString('ja-JP')}</span>` : ''}
                        </div>
                        ${task.memo ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">ğŸ“ ${task.memo.substring(0, 50)}...</div>` : ''}
                        <button onclick="editTask(${task.id})" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            ç¢ºèªãƒ»ç·¨é›†
                        </button>
                    </div>
                `;
            }).join('');
            
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modalOverlay.id = 'stale-tasks-modal';
            
            modalOverlay.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h2 style="margin: 0; font-size: 1.25rem;">ğŸš¨ 3æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ï¼ˆ${window.staleTasks.length}ä»¶ï¼‰</h2>
                        <p style="margin: 0.5rem 0 0; color: #5e6c84; font-size: 0.9rem;">é€²æ—ç¢ºèªãŒå¿…è¦ãªã‚¿ã‚¹ã‚¯ã§ã™</p>
                    </div>
                    <div>${taskListHtml}</div>
                    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button onclick="document.getElementById('stale-tasks-modal').remove()" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            é–‰ã˜ã‚‹
                        </button>
                    </div>
                </div>
            `;
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }
        
        // ãƒãƒ¼ãƒ å¹³å‡1.2å€ä»¥ä¸Šã®è² è·æ‹…å½“è€…ã®è©³ç´°è¡¨ç¤º
        function showWorkloadDetail() {
            if (!window.overloadedAssignees || window.overloadedAssignees.length === 0) {
                alert('ç¾åœ¨ã€éè² è·ã®æ‹…å½“è€…ã¯ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            const avgTasks = Math.round(window.avgTasksPerPerson * 10) / 10;
            const threshold = Math.round(avgTasks * 1.2 * 10) / 10;
            
            const assigneeListHtml = window.overloadedAssignees.map(({ assignee, count }) => {
                const overloadPercentage = Math.round((count / avgTasks - 1) * 100);
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${assignee}</div>
                                <div style="font-size: 0.85rem; color: #5e6c84;">
                                    æ‹…å½“ã‚¿ã‚¹ã‚¯æ•°: ${count}ä»¶ï¼ˆå¹³å‡ã®${100 + overloadPercentage}%ï¼‰
                                </div>
                            </div>
                            <button onclick="document.getElementById('assignee-filter').value='${assignee}'; filterTasks(); this.closest('div[style*=\\"position: fixed\\"]').remove();" 
                                    style="padding: 0.25rem 0.75rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                ã‚¿ã‚¹ã‚¯ç¢ºèª
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modalOverlay.id = 'workload-modal';
            
            modalOverlay.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h2 style="margin: 0; font-size: 1.25rem;">ğŸ‘¥ è² è·èª¿æ•´ãŒå¿…è¦ãªæ‹…å½“è€…ï¼ˆ${window.overloadedAssignees.length}åï¼‰</h2>
                        <p style="margin: 0.5rem 0 0; color: #5e6c84; font-size: 0.9rem;">
                            ãƒãƒ¼ãƒ å¹³å‡: ${avgTasks}ä»¶ / äººã€€ï½œã€€è¦èª¿æ•´åŸºæº–: ${threshold}ä»¶ä»¥ä¸Š
                        </p>
                    </div>
                    <div>${assigneeListHtml}</div>
                    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button onclick="document.getElementById('workload-modal').remove()" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            é–‰ã˜ã‚‹
                        </button>
                    </div>
                </div>
            `;
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }
        
        function showStatusDetails(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (!column) return;
            
            const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
            let filteredTasks = tasks;
            
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            if (assigneeFilter) {
                filteredTasks = tasks.filter(t => {
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(assigneeFilter);
                    }
                    return t.assignee === assigneeFilter;
                });
            }
            
            // è©²å½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
            const statusTasks = filteredTasks.filter(t => {
                // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯æœŸé™åˆ‡ã‚Œã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§é™¤å¤–
                if (t.columnId !== 'done' && t.deadline && isOverdue(t.deadline, t.columnId)) {
                    return false;
                }
                return t.columnId === columnId;
            });
            
            if (statusTasks.length === 0) {
                alert(`${column.title}ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã¯ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
                return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const now = new Date();
            const taskListHtml = statusTasks.map(task => {
                const createdDate = new Date(task.createdAt);
                const daysOld = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                const deadline = new Date(task.deadline);
                const isOverdueTask = deadline < now;
                const assigneeList = Array.isArray(task.assignees) ? task.assignees.join(', ') : (task.assignee || 'æœªè¨­å®š');
                
                return `
                    <div style="
                        padding: 0.75rem; 
                        margin-bottom: 0.5rem; 
                        background: white; 
                        border: 1px solid #e5e7eb; 
                        border-radius: 6px;
                        ${isOverdueTask ? 'border-left: 4px solid #dc2626;' : ''}
                    ">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem; ${isOverdueTask ? 'color: #dc2626;' : ''}">${task.title}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    ğŸ‘¤ ${assigneeList} | ğŸ“… ${deadline.toLocaleDateString('ja-JP')} | â° ${daysOld}æ—¥çµŒé
                                </div>
                            </div>
                            <button onclick="editTask(${task.id}); closeStatusModal();" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ç·¨é›†
                            </button>
                        </div>
                        ${task.memo ? `<div style="font-size: 0.85rem; color: #4b5563; margin-top: 0.5rem;">${task.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLç”Ÿæˆ
            const modalHtml = `
                <div id="status-detail-modal" style="
                    position: fixed; 
                    top: 0; left: 0; 
                    width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 1000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                " onclick="closeStatusModal()">
                    <div style="
                        background: white; 
                        border-radius: 8px; 
                        padding: 1.5rem; 
                        max-width: 600px; 
                        max-height: 80vh; 
                        overflow-y: auto;
                        margin: 1rem;
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem;">
                            <h3 style="margin: 0; color: #111827;">ğŸ“‹ ${column.title} (${statusTasks.length}ä»¶)</h3>
                            <button onclick="closeStatusModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">Ã—</button>
                        </div>
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-size: 0.9rem; color: #374151;">
                                å¹³å‡æ»ç•™æ™‚é–“: <strong>${Math.round((statusTasks.reduce((sum, t) => sum + Math.floor((now - new Date(t.createdAt)) / (1000 * 60 * 60 * 24)), 0) / statusTasks.length) * 10) / 10}æ—¥</strong>
                            </div>
                        </div>
                        <div>${taskListHtml}</div>
                    </div>
                </div>
            `;
            
            // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
            const existingModal = document.getElementById('status-detail-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeStatusModal() {
            const modal = document.getElementById('status-detail-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        
        
        function saveTasks() {
            localStorage.setItem('salesTasksKanban', JSON.stringify(tasks));
        }
        
        // é€šçŸ¥æ©Ÿèƒ½
        let notificationPermission = false;
        
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationPermission = (permission === 'granted');
                    console.log('é€šçŸ¥è¨±å¯:', notificationPermission);
                    
                    // è¨±å¯ãŒå–ã‚ŒãŸå ´åˆã¯ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
                    if (notificationPermission) {
                        showNotification('ğŸ¯ é€šçŸ¥è¨­å®šå®Œäº†', 'ã‚¿ã‚¹ã‚¯ã®æœŸé™é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼');
                    }
                });
            }
        }
        
        function testNotification() {
            if (notificationPermission) {
                showNotification('ğŸ”” ãƒ†ã‚¹ãƒˆé€šçŸ¥', 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™ã€‚é€šçŸ¥æ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼');
            } else {
                alert('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                requestNotificationPermission();
            }
        }
        
        function showNotification(title, body, options = {}) {
            console.log(`ğŸ”” é€šçŸ¥è©¦è¡Œ: ${title} - ${body}`);
            console.log(`ğŸ”” é€šçŸ¥è¨±å¯çŠ¶æ…‹: ${notificationPermission}`);
            console.log(`ğŸ”” Notificationå¯¾å¿œ: ${'Notification' in window}`);
            
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    console.log(`âœ… é€šçŸ¥é€ä¿¡: ${title}`);
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">ğŸ¯</text></svg>',
                        requireInteraction: false, // 3ç§’ã§è‡ªå‹•æ¶ˆå»ã™ã‚‹ãŸã‚å¤‰æ›´
                        ...options
                    });
                    
                    // 3ç§’å¾Œã«è‡ªå‹•ã§é€šçŸ¥ã‚’é–‰ã˜ã‚‹
                    setTimeout(() => {
                        notification.close();
                    }, 3000);
                    
                    // ã‚¿ã‚¹ã‚¯IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã§ãã®ã‚¿ã‚¹ã‚¯ã‚’é–‹ã
                    if (options.taskId) {
                        notification.onclick = () => {
                            window.focus(); // ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                            editTask(options.taskId); // ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                            notification.close();
                        };
                    }
                    
                    return notification;
                } else if (Notification.permission === 'default') {
                    console.log(`âš ï¸ é€šçŸ¥è¨±å¯è¦æ±‚ä¸­...`);
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            showNotification(title, body, options); // å†å®Ÿè¡Œ
                        }
                    });
                } else {
                    console.log(`âŒ é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™`);
                    alert(`é€šçŸ¥: ${title}\n${body}`); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                }
            } else {
                console.log(`âŒ ãƒ–ãƒ©ã‚¦ã‚¶ãŒé€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“`);
                alert(`é€šçŸ¥: ${title}\n${body}`); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            }
        }
        
        function checkDeadlines() {
            const now = new Date();
            const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
            const oneDayFromNow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            const threeHoursFromNow = new Date(now.getTime() + 3 * 60 * 60 * 1000);
            
            tasks.forEach(task => {
                if (task.columnId === 'done') return; // å®Œäº†æ¸ˆã¿ã¯é™¤å¤–
                
                const deadline = new Date(task.deadline);
                const timeUntilDeadline = deadline.getTime() - now.getTime();
                
                // æœŸé™åˆ‡ã‚Œé€šçŸ¥
                if (deadline < now && !task.overdueNotified) {
                    showNotification(
                        'ğŸš¨ æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯',
                        `ã€Œ${task.title}ã€ã®æœŸé™ãŒéãã¦ã„ã¾ã™ï¼`,
                        { tag: `overdue-${task.id}`, taskId: task.id }
                    );
                    task.overdueNotified = true;
                }
                // 5åˆ†å‰é€šçŸ¥
                else if (timeUntilDeadline > 0 && timeUntilDeadline <= 5 * 60 * 1000 && !task.fiveMinNotified) {
                    showNotification(
                        'ğŸš¨ ç·Šæ€¥æœŸé™',
                        `ã€Œ${task.title}ã€ã®æœŸé™ã¾ã§5åˆ†ã§ã™ï¼`,
                        { tag: `fivemin-${task.id}`, taskId: task.id }
                    );
                    task.fiveMinNotified = true;
                }
                // 3æ™‚é–“å‰é€šçŸ¥
                else if (timeUntilDeadline > 0 && timeUntilDeadline <= 3 * 60 * 60 * 1000 && !task.threeHourNotified) {
                    showNotification(
                        'âš ï¸ æœŸé™é–“è¿‘',
                        `ã€Œ${task.title}ã€ã®æœŸé™ã¾ã§3æ™‚é–“ã§ã™`,
                        { tag: `threehour-${task.id}`, taskId: task.id }
                    );
                    task.threeHourNotified = true;
                }
                // 1æ—¥å‰é€šçŸ¥
                else if (timeUntilDeadline > 0 && timeUntilDeadline <= 24 * 60 * 60 * 1000 && !task.oneDayNotified) {
                    showNotification(
                        'ğŸ“… æœŸé™äºˆå‘Š',
                        `ã€Œ${task.title}ã€ã®æœŸé™ã¾ã§1æ—¥ã§ã™`,
                        { tag: `oneday-${task.id}`, taskId: task.id }
                    );
                    task.oneDayNotified = true;
                }
            });
            
            saveTasks(); // é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜
        }
        
        // è¨­å®šé–¢é€£ã®é–¢æ•°
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            loadAlertSettings();
            loadColumnManager();
            loadImportDefaults();
            loadTemplateList(); // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®šã®åˆæœŸåŒ–
        function loadImportDefaults() {
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            const assigneeSelect = document.getElementById('default-assignee');
            assigneeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            assignees.forEach(assignee => {
                const option = document.createElement('option');
                option.value = assignee;
                option.textContent = assignee;
                assigneeSelect.appendChild(option);
            });
            
            // ã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
            const columnSelect = document.getElementById('default-column');
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé™ã‚’ä»Šæ—¥ã«è¨­å®š
            document.getElementById('default-deadline').value = new Date().toISOString().split('T')[0];
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
            saveAlertSettings();
        }
        
        // ã‚«ãƒ©ãƒ ç®¡ç†æ©Ÿèƒ½
        function loadColumnManager() {
            const columnList = document.getElementById('column-list');
            columnList.innerHTML = columns.map((column, index) => `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                    <span style="flex: 1;">${column.title}</span>
                    <input type="color" value="${column.color}" onchange="updateColumnColor(${index}, this.value)" style="width: 40px; height: 30px; border: none; border-radius: 4px;">
                    <button onclick="editColumnName(${index})" style="padding: 0.25rem 0.5rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer;">ç·¨é›†</button>
                    ${columns.length > 2 ? `<button onclick="deleteColumn(${index})" style="padding: 0.25rem 0.5rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>` : ''}
                </div>
            `).join('');
        }
        
        function addColumn() {
            const newColumnName = document.getElementById('new-column-name').value.trim();
            if (!newColumnName) {
                alert('ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const newColumn = {
                id: 'custom_' + Date.now(),
                title: newColumnName,
                color: '#026aa7'
            };
            
            columns.push(newColumn);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            document.getElementById('new-column-name').value = '';
            loadColumnManager();
            renderBoard();
        }
        
        function editColumnName(index) {
            const newName = prompt('æ–°ã—ã„ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', columns[index].title);
            if (newName && newName.trim()) {
                columns[index].title = newName.trim();
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                loadColumnManager();
                renderBoard();
            }
        }
        
        function updateColumnColor(index, color) {
            columns[index].color = color;
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            render(); // å³åº§ã«åæ˜ 
        }
        
        function deleteColumn(index) {
            if (columns.length <= 2) {
                alert('æœ€ä½2ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                return;
            }
            
            const columnToDelete = columns[index];
            const tasksInColumn = tasks.filter(task => task.columnId === columnToDelete.id);
            
            if (tasksInColumn.length > 0) {
                const moveToColumn = prompt(`ã“ã®ã‚«ãƒ©ãƒ ã«ã¯${tasksInColumn.length}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚\nç§»å‹•å…ˆã®ã‚«ãƒ©ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (${columns.filter((_, i) => i !== index).map(c => c.id).join(', ')}):`);
                if (!moveToColumn) return;
                
                // ã‚¿ã‚¹ã‚¯ã‚’ç§»å‹•
                tasksInColumn.forEach(task => {
                    task.columnId = moveToColumn;
                });
            }
            
            columns.splice(index, 1);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            saveTasks();
            loadColumnManager();
            render();
        }
        
        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ ã‚«ãƒ©ãƒ ç®¡ç†æ©Ÿèƒ½
        function quickAddColumn() {
            const newColumnName = document.getElementById('quick-column-name').value.trim();
            if (!newColumnName) {
                alert('ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const newColumn = {
                id: 'custom_' + Date.now(),
                title: newColumnName,
                color: '#026aa7'
            };
            
            columns.push(newColumn);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            document.getElementById('quick-column-name').value = '';
            render();
        }
        
        function editColumnNameInline(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (!column) return;
            
            const newName = prompt('æ–°ã—ã„ã‚«ãƒ©ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', column.title);
            if (newName && newName.trim()) {
                column.title = newName.trim();
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                render();
            }
        }
        
        function deleteColumnInline(columnId) {
            if (columns.length <= 2) {
                alert('æœ€ä½2ã¤ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™');
                return;
            }
            
            const columnIndex = columns.findIndex(c => c.id === columnId);
            const columnToDelete = columns[columnIndex];
            const tasksInColumn = tasks.filter(task => task.columnId === columnId);
            
            if (tasksInColumn.length > 0) {
                const availableColumns = columns.filter(c => c.id !== columnId);
                const moveToColumn = prompt(`ã“ã®ã‚«ãƒ©ãƒ ã«ã¯${tasksInColumn.length}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚\nç§»å‹•å…ˆã®ã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„:\n\n${availableColumns.map((c, i) => `${i+1}. ${c.title} (${c.id})`).join('\n')}\n\nç§»å‹•å…ˆã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);
                
                if (!moveToColumn) return;
                
                const selectedIndex = parseInt(moveToColumn) - 1;
                if (selectedIndex >= 0 && selectedIndex < availableColumns.length) {
                    // ã‚¿ã‚¹ã‚¯ã‚’ç§»å‹•
                    tasksInColumn.forEach(task => {
                        task.columnId = availableColumns[selectedIndex].id;
                    });
                } else {
                    alert('ç„¡åŠ¹ãªé¸æŠã§ã™');
                    return;
                }
            }
            
            if (confirm(`ã‚«ãƒ©ãƒ ã€Œ${columnToDelete.title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                columns.splice(columnIndex, 1);
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                saveTasks();
                render();
            }
        }
        
        function loadAlertSettings() {
            const settings = JSON.parse(localStorage.getItem('alertSettings') || '{"3hours": true, "1day": false, "overdue": true}');
            document.getElementById('alert-3hours').checked = settings['3hours'];
            document.getElementById('alert-1day').checked = settings['1day'];
            document.getElementById('alert-overdue').checked = settings.overdue;
        }
        
        function saveAlertSettings() {
            const settings = {
                '3hours': document.getElementById('alert-3hours').checked,
                '1day': document.getElementById('alert-1day').checked,
                'overdue': document.getElementById('alert-overdue').checked
            };
            localStorage.setItem('alertSettings', JSON.stringify(settings));
        }
        
        // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…ã®ã¿ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒåˆ©ç”¨å¯èƒ½ï¼‰
        function isAdmin() {
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æº
            return localStorage.getItem('userRole') === 'admin';
        }
        
        function setTheme(themeName, color, secondaryColor, darkColor, lightColor) {
            // ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒã¯ç®¡ç†è€…ã®ã¿
            if (themeName === 'black' && !isAdmin()) {
                alert('ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™');
                return;
            }
            
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-color-secondary', secondaryColor);
            document.documentElement.style.setProperty('--theme-color-dark', darkColor);
            document.documentElement.style.setProperty('--theme-color-light', lightColor);
            
            // ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒã®å ´åˆã€è¿½åŠ ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            if (themeName === 'black') {
                document.documentElement.style.setProperty('--body-bg', '#0d1117');
                document.documentElement.style.setProperty('--text-color', '#c9d1d9');
                document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #161b22 0%, #0d1117 100%)');
                document.documentElement.style.setProperty('--border-color', '#30363d');
                document.body.classList.add('dark-theme');
            } else {
                document.documentElement.style.setProperty('--body-bg', '#f4f5f7');
                document.documentElement.style.setProperty('--text-color', '#172b4d');
                document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)');
                document.documentElement.style.setProperty('--border-color', '#dfe1e6');
                document.body.classList.remove('dark-theme');
            }
            
            localStorage.setItem('selectedTheme', themeName);
            localStorage.setItem('themeColors', JSON.stringify({
                primary: color,
                secondary: secondaryColor,
                dark: darkColor,
                light: lightColor,
                themeName: themeName
            }));
            
            closeSettingsModal();
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            const savedColors = localStorage.getItem('themeColors');
            
            if (savedTheme && savedColors) {
                const colors = JSON.parse(savedColors);
                document.documentElement.style.setProperty('--theme-color', colors.primary);
                document.documentElement.style.setProperty('--theme-color-secondary', colors.secondary);
                document.documentElement.style.setProperty('--theme-color-dark', colors.dark);
                document.documentElement.style.setProperty('--theme-color-light', colors.light);
                
                // ãƒ–ãƒ©ãƒƒã‚¯ãƒ†ãƒ¼ãƒã®å ´åˆã€è¿½åŠ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                if (colors.themeName === 'black' || savedTheme === 'black') {
                    document.documentElement.style.setProperty('--body-bg', '#0d1117');
                    document.documentElement.style.setProperty('--text-color', '#c9d1d9');
                    document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #161b22 0%, #0d1117 100%)');
                    document.documentElement.style.setProperty('--border-color', '#30363d');
                    document.body.classList.add('dark-theme');
                }
            }
        }
        
        // åˆæœŸåŒ–
        function init() {
            // ãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã¿
            loadTheme();
            
            // é€šçŸ¥è¨±å¯ã‚’è¦æ±‚
            requestNotificationPermission();
            
            // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
            setupMentionSystem();
            
            // å®šæœŸã‚¿ã‚¹ã‚¯ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åˆæœŸåŒ–
            if (recurringTemplates.length === 0) {
                const sampleTemplate = {
                    id: "recurring_001",
                    name: "æœˆæ¬¡å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆ",
                    taskTemplate: {
                        title: "{{YYYYå¹´MMæœˆ}} å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ",
                        priority: "high",
                        assignees: [],
                        memo: "å‰æœˆå®Ÿç¸¾ã‚’ã¾ã¨ã‚ã¦æå‡ºã—ã¦ãã ã•ã„",
                        projectId: null,
                        projectName: null,
                        approvers: []
                    },
                    recurringConfig: {
                        type: "monthly",
                        interval: 1,
                        dayOfMonth: 25
                    },
                    deadlineConfig: {
                        relativeDays: 5,
                        timeOfDay: "17:00"
                    },
                    generationConfig: {
                        advanceDays: 3,
                        maxFutureGeneration: 2,
                        lastGenerated: null,
                        nextGeneration: new Date().toISOString()
                    },
                    isActive: true,
                    createdAt: new Date().toISOString(),
                    createdBy: "ã‚·ã‚¹ãƒ†ãƒ "
                };
                
                recurringTemplates.push(sampleTemplate);
                saveRecurringTemplates();
                console.log('ğŸ”„ [INIT] Created sample recurring template');
            }
            
            // å®šæœŸã‚¿ã‚¹ã‚¯ã®è‡ªå‹•ç”Ÿæˆãƒã‚§ãƒƒã‚¯
            checkAndGenerateRecurringTasks();
            
            // Phase 2å¯¾å¿œ: æ—¢å­˜ã‚¿ã‚¹ã‚¯ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            tasks = tasks.map(task => {
                // PJé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
                if (task.projectId === undefined) {
                    return {
                        ...task,
                        // PJã‚¿ã‚¹ã‚¯æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        projectId: null,           // PJã‚¿ã‚¹ã‚¯ã®å ´åˆã®ã¿è¨­å®š
                        projectName: null,         // PJè¡¨ç¤ºå
                        
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼ˆãƒ‡ãƒ¥ã‚¢ãƒ«ç®¡ç†ï¼‰
                        personalStatus: task.columnId || 'todo', // å€‹äººå´ã§ã®é€²æ—çŠ¶æ…‹
                        projectStatus: task.columnId || 'todo',  // PJå´ã§ã®æ‰¿èªçŠ¶æ…‹
                        
                        // ç§»å‹•ç”³è«‹ç®¡ç†
                        pendingMove: null,
                        
                        // æ‰¿èªè€…è¨­å®š
                        approvers: [],             // ã“ã®PJã®æ‰¿èªè€…ãƒªã‚¹ãƒˆ
                        lastApprovedBy: null,      // æœ€å¾Œã«æ‰¿èªã—ãŸäºº
                        approvedAt: null           // æ‰¿èªæ—¥æ™‚
                    };
                }
                return task;
            });

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºé…åˆ—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ä½œæˆã—ãªã„ï¼‰
            if (tasks.length === 0) {
                tasks = [];
                saveTasks();
                console.log('ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§é–‹å§‹: ã‚µãƒ³ãƒ—ãƒ«ã‚¿ã‚¹ã‚¯ãªã—');
            }
            
            render();
            updateStats();
            
            // å®šæœŸçš„ã«æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆ1åˆ†é–“éš”ï¼‰
            checkDeadlines();
            setInterval(checkDeadlines, 1 * 60 * 1000);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            const filterContainer = document.getElementById('assignee-filter-container');
            const dropdown = document.getElementById('assignee-filter-dropdown');
            
            if (filterContainer && !filterContainer.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        function setupFileDropZone() {
            const dropZone = document.getElementById('file-drop-zone');
            const fileInput = document.getElementById('task-files-input');
            
            if (!dropZone || !fileInput) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    // FileListã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                    const dt = new DataTransfer();
                    // æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚è¿½åŠ 
                    Array.from(fileInput.files).forEach(file => dt.items.add(file));
                    // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
                    files.forEach(file => dt.items.add(file));
                    
                    fileInput.files = dt.files;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’è¡¨ç¤º
                    dropZone.innerHTML = `ğŸ“ ${dt.files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™`;
                    
                    }
            });
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®è¡¨ç¤ºæ›´æ–°
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    dropZone.innerHTML = `ğŸ“ ${fileInput.files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™`;
                } else {
                    dropZone.innerHTML = 'ğŸ“ ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ä¸Šè¨˜ãƒœã‚¿ãƒ³ã§é¸æŠ';
                }
            });
        }
        
        // æ‹…å½“è€…é¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('DOMContentLoaded', () => {
            const assigneeSelect = document.getElementById('task-assignee-input');
            if (assigneeSelect) {
                assigneeSelect.addEventListener('change', function() {
                    if (this.value === '__ADD_NEW__') {
                        const newAssignee = prompt('æ–°ã—ã„æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                        if (newAssignee && newAssignee.trim()) {
                            const trimmedName = newAssignee.trim();
                            if (!assignees.includes(trimmedName)) {
                                assignees.push(trimmedName);
                                localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                            }
                            // é¸æŠè‚¢ã‚’æ›´æ–°ã—ã¦æ–°ã—ã„æ‹…å½“è€…ã‚’é¸æŠ
                            updateAssigneeOptions();
                            this.value = trimmedName;
                        } else {
                            this.value = '';
                        }
                    }
                });
            }
            
            // ã‚«ãƒ©ãƒ è¿½åŠ ã§Enterã‚­ãƒ¼å¯¾å¿œ
            const quickColumnInput = document.getElementById('quick-column-name');
            if (quickColumnInput) {
                quickColumnInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        quickAddColumn();
                    }
                });
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚’è¨­å®š
            setupFileDropZone();
        });
        
        // æŸ”è»Ÿãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        let previewTasks = [];
        
        function previewImport() {
            const importText = document.getElementById('import-text').value.trim();
            if (!importText) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±ä¸€ï¼‰
            const currentUser = localStorage.getItem('currentUser') || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            const defaultAssignee = currentUser;
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé™ã‚’ä»Šæ—¥+3æ™‚é–“ã«è¨­å®š
            const defaultDateTime = getDefaultDateTimeAfter3Hours();
            const defaultDeadline = defaultDateTime.date;
            const defaultTime = defaultDateTime.time;
            
            const defaultPriority = 'medium';
            const defaultColumn = 'todo';
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã«åˆ†å‰²
            const lines = importText.split('\n');
            previewTasks = [];
            
            // å„è¡Œã‚’å€‹åˆ¥ã®ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦å‡¦ç†
            let lastMainTaskIndex = -1;
            
        lines.forEach((line, index) => {
            if (!line.trim()) return; // ç©ºè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
            
            const trimmedLine = line.trim();
            let taskText = trimmedLine;
            
            // ã‚¹ãƒãƒ¼ãƒˆåˆ¤å®šï¼šã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆç©ºç™½ï¼‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            // åŠè§’ã‚¹ãƒšãƒ¼ã‚¹2ã¤ä»¥ä¸Šã€å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹1ã¤ä»¥ä¸Šã€ã¾ãŸã¯ã‚¿ãƒ–æ–‡å­—
            const hasIndent = line.match(/^(\s{2,}|ã€€+|\t+)/);
            const isMainTask = !hasIndent;
            
            // æ‹…å½“è€…ã‚’æŠ½å‡º
            const assigneeMatch = taskText.match(/@([^\s@]+)/g);
            let assignee = defaultAssignee;
            if (assigneeMatch && assigneeMatch.length > 0) {
                assignee = assigneeMatch[0].replace('@', '');
                taskText = taskText.replace(/@[^\s@]+/g, '').trim();
            }
            
            // æ—¥ä»˜ã‚’æŠ½å‡º
            const dateMatches = taskText.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}æœˆ\d{1,2}æ—¥)/g);
            let deadline = defaultDeadline;
            if (dateMatches && dateMatches.length > 0) {
                let dateStr = dateMatches[0];
                if (dateStr.includes('æœˆ') && dateStr.includes('æ—¥')) {
                    const year = new Date().getFullYear();
                    const month = dateStr.match(/(\d{1,2})æœˆ/)[1].padStart(2, '0');
                    const day = dateStr.match(/(\d{1,2})æ—¥/)[1].padStart(2, '0');
                    deadline = `${year}-${month}-${day}`;
                } else {
                    const parts = dateStr.split(/[-\/]/);
                    if (parts[0].length === 4) {
                        deadline = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    } else {
                        const year = parts[2].length === 4 ? parts[2] : new Date().getFullYear();
                        deadline = `${year}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                    }
                }
                taskText = taskText.replace(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}æœˆ\d{1,2}æ—¥)/g, '').trim();
            }
            
            // å„ªå…ˆåº¦ã‚’æŠ½å‡º
            let priority = defaultPriority;
            if (taskText.match(/[!ï¼]{2,}|é«˜|ç·Šæ€¥|urgent|URGENT|æ€¥/)) {
                priority = 'high';
                taskText = taskText.replace(/[!ï¼]+|é«˜|ç·Šæ€¥|urgent|URGENT|æ€¥/g, '').trim();
            } else if (taskText.match(/ä½|later|LATER|å¾Œã§/)) {
                priority = 'low';
                taskText = taskText.replace(/ä½|later|LATER|å¾Œã§/g, '').trim();
            }
            
            taskText = taskText.replace(/\s+/g, ' ').trim();
            
            if (taskText && taskText.length > 1) {
                const task = {
                    id: `preview_${index}`,
                    title: taskText,
                    assignee: assignee,
                    deadline: deadline,
                    time: defaultTime, // æ™‚é–“æƒ…å ±ã‚’è¿½åŠ 
                    priority: priority,
                    columnId: defaultColumn,
                    originalLine: line,
                    lineIndex: index,
                    isMainTask: isMainTask, // ã‚¹ãƒãƒ¼ãƒˆåˆ¤å®šçµæœ
                    parentIndex: isMainTask ? null : lastMainTaskIndex, // è‡ªå‹•ã§ç›´å‰ã®ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã‚’è¦ªã«è¨­å®š
                    isSkip: false, // ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹ã©ã†ã‹
                    autoDetected: !isMainTask && hasIndent // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã§è‡ªå‹•åˆ¤å®šã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‹ã©ã†ã‹
                };
                
                // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã®å ´åˆã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨˜éŒ²
                if (isMainTask) {
                    lastMainTaskIndex = previewTasks.length; // è¿½åŠ å¾Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                }
                
                previewTasks.push(task);
            }
        });
            
            // æ–°ã—ã„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            displayLineByLinePreview();
        }
        
        function displayLineByLinePreview() {
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            
            if (previewTasks.length === 0) {
                alert('æœ‰åŠ¹ãªã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const activeTaskCount = previewTasks.filter(t => !t.isSkip).length;
            const mainTaskCount = previewTasks.filter(t => !t.isSkip && t.isMainTask).length;
            const commentCount = previewTasks.filter(t => !t.isSkip && !t.isMainTask).length;
            
            const modeInfo = `<div style="font-size: 0.9rem; margin-top: 0.5rem;">âœ¨ ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆè¡Œã¯è‡ªå‹•ã§ã‚³ãƒ¡ãƒ³ãƒˆã«è¨­å®šæ¸ˆã¿ï¼ˆåŠè§’ã‚¹ãƒšãƒ¼ã‚¹2å€‹ä»¥ä¸Šãƒ»å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ãƒ»ã‚¿ãƒ–ï¼‰ã€‚ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§è¦ªå­é–¢ä¿‚ã‚’å¤‰æ›´å¯èƒ½</div>`;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ–¹å¼ã®åˆ¤å®š
            const isScreenshotMode = originalImageDataUrl ? true : false;
            
            let content = `
                        
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f5e8; border-radius: 4px; color: #2f7d2f;">
                            <strong>ğŸ“ ${activeTaskCount}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ  (ğŸ“‹ ãƒ¡ã‚¤ãƒ³: ${mainTaskCount}, ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ: ${commentCount})</strong>
                            ${modeInfo}
                        </div>
                        
                        ${isScreenshotMode ? `
                        <!-- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¡¨ç¤ºï¼‹ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰æ¨ªä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; height: 600px;">
                            <!-- å·¦å´ï¼šã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ -->
                            <div style="flex: 1; padding: 0.75rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <h6 style="margin: 0; color: #495057;">ğŸ–¼ï¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå‚è€ƒ</h6>
                                    <button onclick="toggleScreenshot()" id="screenshot-toggle" style="padding: 0.25rem 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                        éè¡¨ç¤º
                                    </button>
                                </div>
                                <div id="screenshot-preview" style="height: calc(100% - 40px); overflow: auto; text-align: center;">
                                    <img src="${originalImageDataUrl}" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                            </div>
                            
                            <!-- å³å´ï¼šã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ç¸¦åˆ—è¡¨ç¤º -->
                            <div style="flex: 1; padding: 0.75rem; background: #f0f2f5; border: 1px solid #ddd; border-radius: 4px; overflow-y: auto;">
                                <h6 style="margin: 0 0 1rem 0; color: #495057;">ğŸ“ èªè­˜ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ä¸€è¦§</h6>
                                <div id="preview-container" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ` : `
                        <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ™‚ï¼šå¾“æ¥ã®3åˆ—è¡¨ç¤º -->
                        <div style="padding: 1rem; background: #f0f2f5; border-radius: 12px; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" id="preview-container">
                        `}
            `;
            
            previewTasks.forEach((task, index) => {
                // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã¯è¡¨ç¤ºã—ãªã„
                if (task.isSkip) return;
                const mainTaskOptions = previewTasks.map((t, i) => 
                    i < index ? `<option value="${i}" ${task.parentIndex === i ? 'selected' : ''}>ğŸ“‹ ${t.title.substring(0, 30)}${t.title.length > 30 ? '...' : ''}</option>` : ''
                ).join('');
                
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                const isAutoDetected = task.autoDetected === true; // è‡ªå‹•åˆ¤å®šã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‹ã©ã†ã‹ï¼ˆæ˜ç¤ºçš„ã«trueã®å ´åˆã®ã¿ï¼‰
                const isGoogleTodo = task.hasAutoDeadline === true; // GoogleTODOã§æœŸé™ãŒè‡ªå‹•æŠ½å‡ºã•ã‚ŒãŸã‚¿ã‚¹ã‚¯
                
                let borderColor = '#ddd';
                let bgColor = 'white';
                let headerText = 'ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½';
                
                if (isGoogleTodo) {
                    borderColor = '#007bff';
                    bgColor = '#f8f9ff';
                    headerText = 'ğŸ“… æœŸé™è‡ªå‹•æŠ½å‡º';
                } else if (isAutoComment) {
                    borderColor = '#28a745';
                    bgColor = '#f8fff9';
                    headerText = isAutoDetected ? 'âœ¨ è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆ' : 'ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½';
                }
                
                // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¡¨ç¤ºæ™‚ã¯ç¸¦åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ã«ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´
                const cardStyle = originalImageDataUrl ? 
                    `border: 2px solid ${borderColor}; border-radius: 8px; background: ${bgColor}; transition: all 0.2s; cursor: move; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); width: 100%; margin-bottom: 0;` :
                    `border: 2px solid ${borderColor}; border-radius: 8px; background: ${bgColor}; transition: all 0.2s; cursor: move; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); height: fit-content;`;
                
                content += `
                    <div style="${cardStyle}" 
                         draggable="true" 
                         ondragstart="handlePreviewDragStart(event, ${index})" 
                         ondragend="handleDragEnd(event)"
                         ondragover="handleDragOver(event)" 
                         ondrop="handlePreviewDrop(event, ${index})"
                         ondragenter="handleDragEnter(event)"
                         ondragleave="handleDragLeave(event)"
                         id="preview-item-${index}">
                        
                        <!-- ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« -->
                        <div style="background: ${borderColor}; padding: 0.4rem 0.8rem; text-align: center; color: white; font-weight: bold; cursor: grab; user-select: none; font-size: 0.85rem;">
                            â‹®â‹® ${headerText} â‹®â‹®
                        </div>
                        
                        <!-- ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div style="padding: 0.75rem; background: white;">
                            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                <input type="text" 
                                       value="${task.title.replace(/"/g, '&quot;')}" 
                                       onchange="updateTaskTitle(${index}, this.value)" 
                                       style="flex: 1; font-family: monospace; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; border: 1px solid ${borderColor}; border-left: 3px solid ${borderColor};"
                                       id="title-input-${index}">
                                <button onclick="deletePreviewTask(${index})" 
                                        style="background: #e53e3e; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                                        title="ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                                å…ƒ: "${task.originalLine}"
                            </div>
                        </div>
                        
                        <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
                        <div style="padding: 0.75rem; background: #fafafa; border-top: 1px solid #eee;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">ç¨®é¡:</label>
                                    <select onchange="updateTaskType(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;">
                                        <option value="main" ${task.isMainTask ? 'selected' : ''}>ğŸ“‹ ãƒ¡ã‚¤ãƒ³</option>
                                        <option value="comment" ${!task.isMainTask ? 'selected' : ''}>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</option>
                                        <option value="skip">â­ï¸ ã‚¹ã‚­ãƒƒãƒ—</option>
                                    </select>
                                </div>
                                
                                ${!task.isMainTask ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">è¦ª:</label>
                                    <select onchange="updateTaskParent(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="parent-select-${index}">
                                        <option value="">ï¼</option>
                                        ${mainTaskOptions}
                                    </select>
                                </div>
                                ` : `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">åˆ—:</label>
                                    <select onchange="updateTaskColumn(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="column-select-${index}">
                                        ${columns.map(c => `<option value="${c.id}" ${task.columnId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <!-- æ‹…å½“è€…è¨­å®š -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">æ‹…å½“:</label>
                                    <input type="text" onchange="updateTaskAssignee(${index}, this.value)" value="${task.assignee}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" placeholder="æ‹…å½“è€…å" id="assignee-input-${index}">
                                </div>
                                
                                <!-- æœŸé™ãƒ»æ™‚é–“è¨­å®š -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">æœŸé™:</label>
                                    <input type="date" onchange="updateTaskDeadline(${index}, this.value)" value="${task.deadline}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="deadline-input-${index}">
                                    <input type="time" onchange="updateTaskTime(${index}, this.value)" value="${task.time}" style="flex: 0.8; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="time-input-${index}">
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += `
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 0.9rem;">
                    <strong>ğŸ’¡ ä½¿ã„æ–¹ï¼š</strong><br>
                    â€¢ <strong>âœ¨ è‡ªå‹•åˆ¤å®š</strong>ï¼šç©ºç™½ãŒã‚ã‚‹è¡Œã¯è‡ªå‹•ã§ã‚³ãƒ¡ãƒ³ãƒˆã«è¨­å®šã•ã‚Œã€ç›´å‰ã®ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ãŒè¦ªã«è¨­å®šã•ã‚Œã¾ã™<br>
                    â€¢ <strong>ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</strong>ï¼šä»»æ„ã®è¡Œã‚’ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã«å¤‰æ›´<br>
                    â€¢ <strong>ğŸ“‹ ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯</strong>ï¼šç‹¬ç«‹ã—ãŸã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦ä½œæˆ<br>
                    â€¢ <strong>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</strong>ï¼šæŒ‡å®šã—ãŸãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ <br>
                    â€¢ <strong>â­ï¸ ã‚¹ã‚­ãƒƒãƒ—</strong>ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ç„¡è¦–
                </div>
            `;
            
            contentDiv.innerHTML = content;
            previewDiv.style.display = 'block';
        }
        
        function updateTaskTitle(index, title) {
            if (previewTasks[index]) {
                previewTasks[index].title = title.trim();
            }
        }
        
        function deletePreviewTask(index) {
            const task = previewTasks[index];
            
            // ã“ã®ã‚¿ã‚¹ã‚¯ã‚’è¦ªã«ã—ã¦ã„ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
            const childComments = previewTasks.filter((t, i) => 
                i !== index && !t.isMainTask && t.parentIndex === index
            );
            
            if (childComments.length > 0) {
                if (!confirm(`âš ï¸ ã“ã®ã‚¿ã‚¹ã‚¯ã«ã¯${childComments.length}å€‹ã®å­ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚\nå­ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ä¸€ç·’ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                
                // å­ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ã‚¹ã‚­ãƒƒãƒ—ã«è¨­å®š
                childComments.forEach(child => {
                    child.isSkip = true;
                });
            }
            
            // ã‚¿ã‚¹ã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã«è¨­å®šï¼ˆå®Œå…¨å‰Šé™¤ã§ã¯ãªãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒï¼‰
            previewTasks[index].isSkip = true;
            
            // ä»–ã®ã‚¿ã‚¹ã‚¯ã®è¦ªå‚ç…§ã‚’æ›´æ–°
            previewTasks.forEach((t, i) => {
                if (t.parentIndex > index) {
                    // å‰Šé™¤ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚ˆã‚Šå¾Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’èª¿æ•´
                    const skipCount = previewTasks.slice(0, t.parentIndex).filter(pt => pt.isSkip).length;
                    const targetSkipCount = previewTasks.slice(0, index).filter(pt => pt.isSkip).length;
                    t.parentIndex = t.parentIndex - (skipCount - targetSkipCount);
                }
            });
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†è¡¨ç¤º
            displayLineByLinePreview();
        }
        
        function updateTaskAssignee(index, assignee) {
            if (previewTasks[index]) {
                previewTasks[index].assignee = assignee;
            }
        }
        
        function updateTaskDeadline(index, deadline) {
            if (previewTasks[index]) {
                previewTasks[index].deadline = deadline;
            }
        }
        
        function updateTaskTime(index, time) {
            if (previewTasks[index]) {
                previewTasks[index].time = time;
            }
        }
        
        function updateTaskType(index, type) {
            if (previewTasks[index]) {
                // ã‚³ãƒ¡ãƒ³ãƒˆåŒ–ã—ã‚ˆã†ã¨ã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã®è¦ªã«ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (type === 'comment' && previewTasks[index].isMainTask) {
                    const hasChildComments = previewTasks.some((task, i) => 
                        i !== index && !task.isMainTask && task.parentIndex === index
                    );
                    
                    if (hasChildComments) {
                        alert('âš ï¸ ã“ã®ã‚¿ã‚¹ã‚¯ã¯ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã®è¦ªã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆåŒ–ã§ãã¾ã›ã‚“ã€‚\nå…ˆã«å­ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»–ã®ã‚¿ã‚¹ã‚¯ã«ç§»å‹•ã™ã‚‹ã‹ã€ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');
                        // é¸æŠã‚’å…ƒã«æˆ»ã™
                        document.querySelector(`#preview-item-${index} select`).value = 'main';
                        return;
                    }
                }
                
                previewTasks[index].isMainTask = (type === 'main');
                previewTasks[index].isSkip = (type === 'skip');
                
                // è¦ªé¸æŠã¨ã‚«ãƒ©ãƒ é¸æŠã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                const parentSelect = document.getElementById(`parent-select-${index}`);
                const columnSelect = document.getElementById(`column-select-${index}`);
                
                if (type === 'main') {
                    parentSelect.disabled = true;
                    parentSelect.value = '';
                    previewTasks[index].parentIndex = null;
                    previewTasks[index].autoDetected = false; // æ‰‹å‹•ã§å¤‰æ›´ã—ãŸãŸã‚è‡ªå‹•åˆ¤å®šã§ã¯ãªã„
                    columnSelect.disabled = false;
                } else if (type === 'comment') {
                    previewTasks[index].autoDetected = false; // æ‰‹å‹•ã§å¤‰æ›´ã—ãŸãŸã‚è‡ªå‹•åˆ¤å®šã§ã¯ãªã„
                    parentSelect.disabled = false;
                    columnSelect.disabled = true;
                } else { // skip
                    parentSelect.disabled = true;
                    columnSelect.disabled = true;
                }
            }
        }
        
        function updateTaskParent(index, parentIndex) {
            if (previewTasks[index]) {
                previewTasks[index].parentIndex = parentIndex ? parseInt(parentIndex) : null;
                previewTasks[index].autoDetected = false; // æ‰‹å‹•ã§å¤‰æ›´ã—ãŸãŸã‚è‡ªå‹•åˆ¤å®šã§ã¯ãªã„
            }
        }
        
        function updateTaskColumn(index, columnId) {
            if (previewTasks[index]) {
                previewTasks[index].columnId = columnId;
            }
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        let draggedIndex = -1;
        
        function handlePreviewDragStart(event, index) {
            draggedIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.6';
        }
        
        function handleDragEnd(event) {
            event.target.style.opacity = '1';
            draggedIndex = -1;
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnter(event) {
            event.preventDefault();
            if (event.target.closest('[id^="preview-item-"]')) {
                event.target.closest('[id^="preview-item-"]').style.backgroundColor = '#e3f2fd';
            }
        }
        
        function handleDragLeave(event) {
            if (event.target.closest('[id^="preview-item-"]')) {
                const item = event.target.closest('[id^="preview-item-"]');
                const itemIndex = parseInt(item.id.split('-')[2]);
                const task = previewTasks[itemIndex];
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                item.style.backgroundColor = isAutoComment ? '#f8fff9' : 'white';
            }
        }
        
        function handlePreviewDrop(event, targetIndex) {
            event.preventDefault();
            
            if (draggedIndex === targetIndex || draggedIndex === -1) {
                // å…ƒã«æˆ»ã™
                event.target.closest('[id^="preview-item-"]').style.opacity = '1';
                return;
            }
            
            const draggedTask = previewTasks[draggedIndex];
            const targetTask = previewTasks[targetIndex];
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å¤‰æ›´ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¿ã‚¹ã‚¯ã‚’è¦ªã«è¨­å®š
            if (targetTask.isMainTask) {
                // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã®è¦ªã«ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (draggedTask.isMainTask) {
                    const childComments = previewTasks.filter((task, i) => 
                        i !== draggedIndex && !task.isMainTask && task.parentIndex === draggedIndex
                    );
                    
                    if (childComments.length > 0) {
                        const childTitles = childComments.map(c => `"${c.title}"`).join('\nâ€¢ ');
                        const shouldMoveChildren = confirm(
                            `ğŸ“ ã“ã®ã‚¿ã‚¹ã‚¯ã«ã¯${childComments.length}å€‹ã®å­ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ï¼š\n\nâ€¢ ${childTitles}\n\n` +
                            `ã“ã‚Œã‚‰ã®å­ã‚³ãƒ¡ãƒ³ãƒˆã‚‚"${targetTask.title}"ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                            `â€¢ OK: å­ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ä¸€ç·’ã«ç§»å‹•\nâ€¢ ã‚­ãƒ£ãƒ³ã‚»ãƒ«: æ“ä½œã‚’ä¸­æ­¢`
                        );
                        
                        if (!shouldMoveChildren) {
                            return;
                        }
                        
                        // å­ã‚³ãƒ¡ãƒ³ãƒˆã‚‚åŒã˜è¦ªã«ç§»å‹•
                        childComments.forEach(child => {
                            child.parentIndex = targetIndex;
                        });
                    }
                }
                
                draggedTask.isMainTask = false;
                draggedTask.parentIndex = targetIndex;
                draggedTask.autoDetected = false; // ãƒ‰ãƒ©ãƒƒã‚°ã§å¤‰æ›´ã—ãŸãŸã‚è‡ªå‹•åˆ¤å®šã§ã¯ãªã„
                
                // UIã‚’æ›´æ–°
                displayLineByLinePreview();
                
                const movedCount = draggedTask.isMainTask ? 0 : previewTasks.filter(t => !t.isMainTask && t.parentIndex === targetIndex).length;
                alert(`ğŸ’¬ "${draggedTask.title}"ã‚’"${targetTask.title}"ã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¨­å®šã—ã¾ã—ãŸ${movedCount > 1 ? `ï¼ˆå­ã‚³ãƒ¡ãƒ³ãƒˆ${movedCount-1}å€‹ã‚‚ç§»å‹•ï¼‰` : ''}`);
            } else {
                alert('âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
            }
            
            draggedIndex = -1;
        }
        
        function displayPreview() {
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            
            if (previewTasks.length === 0) {
                alert('æœ‰åŠ¹ãªã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const projectGroups = {};
            previewTasks.forEach(task => {
                const projectKey = task.project || 'æœªåˆ†é¡';
                if (!projectGroups[projectKey]) {
                    projectGroups[projectKey] = [];
                }
                projectGroups[projectKey].push(task);
            });
            
            let content = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f5e8; border-radius: 4px; color: #2f7d2f;">
                    <strong>âœ… ${previewTasks.length}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</strong>
                    ${Object.keys(projectGroups).length > 1 ? `<span style="margin-left: 1rem; font-size: 0.9rem;">(${Object.keys(projectGroups).length}ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)</span>` : ''}
                </div>
            `;
            
            Object.entries(projectGroups).forEach(([project, tasks]) => {
                content += `
                    <div style="margin-bottom: 1.5rem;">
                        ${project !== 'æœªåˆ†é¡' ? `<div style="background: #0079bf; color: white; padding: 0.5rem 1rem; border-radius: 4px 4px 0 0; font-weight: bold;">ğŸ“ ${project} ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>` : ''}
                        ${tasks.map((task, index) => {
                            const taskIndex = previewTasks.indexOf(task);
                            const indentStyle = task.indentLevel > 0 ? `margin-left: ${task.indentLevel * 20}px; border-left: 2px solid #0079bf;` : '';
                            const parentInfo = task.parentId ? `<span style="font-size: 0.7rem; color: #6c757d;">â†³ å­ã‚¿ã‚¹ã‚¯</span>` : '';
                            
                            return `
                                <div style="border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; overflow: hidden; ${indentStyle}">
                                    <div style="background: #f8f9fa; padding: 0.5rem; border-bottom: 1px solid #ddd; font-size: 0.8rem; color: #6c757d;">
                                        å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ: "${task.originalLine}" ${parentInfo}
                                    </div>
                                    <div style="padding: 0.75rem;">
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem;">
                                            <div>
                                                <input type="text" value="${task.title}" onchange="updatePreviewTask(${taskIndex}, 'title', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-weight: bold;">
                                                ${task.tags.length > 0 ? `<div style="font-size: 0.8rem; color: #0079bf; margin-top: 0.25rem;">${task.tags.join(' ')}</div>` : ''}
                                            </div>
                                            <div>
                                                <select onchange="updatePreviewTask(${taskIndex}, 'assignee', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                                    <option value="æœªè¨­å®š" ${task.assignee === 'æœªè¨­å®š' ? 'selected' : ''}>æœªè¨­å®š</option>
                                                    ${assignees.map(a => `<option value="${a}" ${task.assignee === a ? 'selected' : ''}>${a}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div>
                                                <input type="date" value="${task.deadline}" onchange="updatePreviewTask(${taskIndex}, 'deadline', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                            <div>
                                                <select onchange="updatePreviewTask(${taskIndex}, 'priority', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                                    <option value="low" ${task.priority === 'low' ? 'selected' : ''}>ğŸŸ¢ é€šå¸¸</option>
                                                    <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>ğŸŸ¡ é‡è¦</option>
                                                    <option value="high" ${task.priority === 'high' ? 'selected' : ''}>ğŸ”´ æœ€é‡è¦</option>
                                                </select>
                                            </div>
                                        </div>
                                        ${task.subTasks && task.subTasks.length > 0 ? `
                                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: #f0f8ff; border: 1px solid #bee5eb; border-radius: 4px;">
                                                <div style="font-size: 0.8rem; font-weight: bold; color: #0c5460; margin-bottom: 0.5rem;">ğŸ“ ã‚µãƒ–ã‚¿ã‚¹ã‚¯/ã‚³ãƒ¡ãƒ³ãƒˆ (${task.subTasks.length}ä»¶)</div>
                                                ${task.subTasks.map((subTask, subIndex) => `
                                                    <div style="font-size: 0.85rem; color: #495057; margin-bottom: 0.25rem; padding-left: 1rem; border-left: 2px solid #17a2b8;">
                                                        â€¢ ${subTask}
                                                    </div>
                                                `).join('')}
                                                <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.5rem;">
                                                    â€» ã“ã‚Œã‚‰ã¯ã‚¿ã‚¹ã‚¯ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è‡ªå‹•è¿½åŠ ã•ã‚Œã¾ã™
                                                </div>
                                            </div>
                                        ` : ''}
                                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.75rem;">
                                            <select onchange="updatePreviewTask(${taskIndex}, 'columnId', this.value)" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                                ${columns.map(c => `<option value="${c.id}" ${task.columnId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                                            </select>
                                            <button onclick="removePreviewTask(${taskIndex})" style="padding: 0.5rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ å‰Šé™¤</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®çµ‚äº†éƒ¨åˆ†
            content += `
                        ${isScreenshotMode ? '</div></div>' : '</div></div>'}
            `;
            
            if (isScreenshotMode) {
                // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                const fullscreenPreview = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; overflow-y: auto; padding: 1rem;">
                        <div style="max-width: 1200px; margin: 0 auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #dee2e6;">
                                <h3 style="margin: 0; color: #172b4d;">ğŸ“ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                                <div>
                                    <button onclick="executeImport()" style="padding: 0.5rem 1rem; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem; font-weight: bold;">âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                                    <button onclick="hidePreview()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ• é–‰ã˜ã‚‹</button>
                                </div>
                            </div>
                            ${content}
                        </div>
                    </div>
                `;
                contentDiv.innerHTML = fullscreenPreview;
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯é€šå¸¸ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                contentDiv.innerHTML = content;
            }
            
            previewDiv.style.display = 'block';
        }
        
        function updatePreviewTask(index, field, value) {
            if (previewTasks[index]) {
                previewTasks[index][field] = value;
            }
        }
        
        function removePreviewTask(index) {
            if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                previewTasks.splice(index, 1);
                displayPreview();
            }
        }
        
        function executeImport() {
            console.log('ğŸš€ executeImporté–‹å§‹, previewTasks.length:', previewTasks.length);
            console.log('ğŸ“¸ originalImageDataUrlå­˜åœ¨:', !!originalImageDataUrl);
            
            if (previewTasks.length === 0) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let importedCount = 0;
            const taskIdMap = {}; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨å®Ÿéš›ã®ã‚¿ã‚¹ã‚¯IDã®ãƒãƒƒãƒ”ãƒ³ã‚°
            const currentUser = localStorage.getItem('currentUser') || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            
            // ã¾ãšãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
            previewTasks.forEach((previewTask, index) => {
                if (previewTask.isSkip || !previewTask.isMainTask) return;
                
                // æ‹…å½“è€…ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
                if (previewTask.assignee !== 'æœªè¨­å®š' && !assignees.includes(previewTask.assignee)) {
                    assignees.push(previewTask.assignee);
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                }
                
                const taskId = Date.now() + index;
                taskIdMap[index] = taskId;
                
                const newTask = {
                    id: taskId,
                    title: previewTask.title,
                    deadline: new Date(`${previewTask.deadline}T${previewTask.time || '17:00'}`).toISOString(),
                    priority: previewTask.priority,
                    assignees: [previewTask.assignee],
                    assignee: previewTask.assignee,
                    memo: `ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ${new Date().toLocaleDateString()}`,
                    columnId: previewTask.columnId,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    comments: [],
                    originalLine: previewTask.originalLine
                };
                
                tasks.push(newTask);
                importedCount++;
            });
            
            // æ¬¡ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            previewTasks.forEach((previewTask, index) => {
                if (previewTask.isSkip || previewTask.isMainTask) return;
                if (previewTask.parentIndex === null) return;
                
                const parentTaskId = taskIdMap[previewTask.parentIndex];
                if (!parentTaskId) return;
                
                const parentTask = tasks.find(t => t.id === parentTaskId);
                if (parentTask) {
                    parentTask.comments.push({
                        id: Date.now() + index,
                        author: previewTask.assignee,
                        text: `ğŸ“ ${previewTask.title}`,
                        timestamp: new Date().toISOString(),
                        isImportedComment: true
                    });
                }
            });
            
            if (importedCount > 0) {
                saveTasks();
                render();
                
                // ã‚¿ã‚¹ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¾Œã«å³åº§ã«æœŸé™ãƒã‚§ãƒƒã‚¯
                setTimeout(() => checkDeadlines(), 100);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚¿ã‚¹ã‚¯ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('import-text').value = '';
                document.getElementById('ocr-file-input').value = ''; // OCRãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚‚ãƒªã‚»ãƒƒãƒˆ
                hidePreview();
                closeSettingsModal();
                
                const commentCount = previewTasks.filter(t => !t.isMainTask && !t.isSkip).length;
                let message = `ğŸ‰ ã‚¿ã‚¹ã‚¯è¿½åŠ ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n`;
                message += `ğŸ“‹ ${importedCount}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ \n`;
                if (commentCount > 0) {
                    message += `ğŸ’¬ ${commentCount}å€‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ \n`;
                }
                message += `\nğŸ¯ ã‚¿ã‚¹ã‚¯ç®¡ç†ç”»é¢ã«ç§»è¡Œã—ã¾ã™...`;
                
                console.log('ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º:', message);
                alert(message);
                console.log('ğŸ’¬ alertå®Œäº†');
                
                // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
                originalImageDataUrl = null;
                
                // ã‚¿ã‚¹ã‚¯ç®¡ç†ç”»é¢ã®æœ€ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                setTimeout(() => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }
        
        function hidePreview() {
            document.getElementById('import-preview').style.display = 'none';
            document.getElementById('preview-content').innerHTML = '';
            previewTasks = [];
        }
        
        function clearImportText() {
            document.getElementById('import-text').value = '';
            document.getElementById('ocr-file-input').value = ''; // OCRãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¯ãƒªã‚¢
            hidePreview(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚åŒæ™‚ã«ã‚¯ãƒªã‚¢
            hideImagePreview(); // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚ã‚¯ãƒªã‚¢
            originalImageDataUrl = null; // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
        }
        
        // ç”»åƒé¸æŠæ™‚ã®å‡¦ç†ï¼ˆé ˜åŸŸé¸æŠãƒ¢ãƒ¼ãƒ‰ï¼‰
        async function handleOCRFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (10MBåˆ¶é™)
            if (file.size > 10 * 1024 * 1024) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ (æœ€å¤§10MB)');
                return;
            }
            
            try {
                // ç”»åƒã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                await displayImagePreview(file);
            } catch (error) {
                console.error('Image Preview Error:', error);
                alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            input.value = '';
        }
        
        async function performOCR(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        updateOCRProgress(10, 'ğŸ“¸ ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...');
                        
                        const { data: { text } } = await Tesseract.recognize(
                            e.target.result,
                            'jpn+eng', // æ—¥æœ¬èªã¨è‹±èªã‚’èªè­˜
                            {
                                logger: m => {
                                    if (m.status === 'recognizing text') {
                                        const progress = Math.round(m.progress * 90) + 10; // 10-100%ã®ç¯„å›²
                                        updateOCRProgress(progress, `ğŸ” ãƒ†ã‚­ã‚¹ãƒˆèªè­˜ä¸­... ${Math.round(m.progress * 100)}%`);
                                    }
                                },
                                // ç²¾åº¦æ”¹å–„ã®ãŸã‚ã®è¨­å®š
                                tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                                tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZã‚-ã‚–ã‚¢-ãƒ¶ä¸€-é¾¯!@#$%^&*()_+-=[]{}|;:,.<>?/~ ã€€ã€Œã€ã€ã€‚',
                                preserve_interword_spaces: '1'
                            }
                        );
                        
                        updateOCRProgress(100, 'âœ… èªè­˜å®Œäº†ï¼');
                        resolve(text);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                reader.readAsDataURL(file);
            });
        }
        
        function showOCRProgress() {
            document.getElementById('ocr-status').style.display = 'block';
            updateOCRProgress(0, 'ğŸ“¸ OCRå‡¦ç†ã‚’é–‹å§‹ä¸­...');
        }
        
        function updateOCRProgress(percentage, message) {
            document.getElementById('ocr-progress-bar').style.width = percentage + '%';
            document.getElementById('ocr-progress-text').textContent = message;
        }
        
        function hideOCRProgress() {
            setTimeout(() => {
                document.getElementById('ocr-status').style.display = 'none';
                document.getElementById('confidence-scores').style.display = 'none';
            }, 2000);
        }
        
        // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢è¡¨ç¤ºæ©Ÿèƒ½
        function showConfidenceScores(scores) {
            const confidenceDiv = document.getElementById('confidence-scores');
            const listDiv = document.getElementById('confidence-list');
            
            if (scores && scores.length > 0) {
                let html = '';
                scores.forEach((score, index) => {
                    const confidenceColor = getConfidenceColor(score.confidence);
                    const confidenceIcon = getConfidenceIcon(score.confidence);
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; padding: 0.25rem; background: white; border-radius: 3px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: bold; color: #495057;">é ˜åŸŸ ${index + 1}:</span>
                                <span style="color: #6c757d; font-family: monospace;">${score.text.substring(0, 20)}${score.text.length > 20 ? '...' : ''}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <span style="color: ${confidenceColor};">${confidenceIcon}</span>
                                <span style="font-weight: bold; color: ${confidenceColor};">${score.confidence.toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                });
                
                // å¹³å‡ä¿¡é ¼åº¦è¨ˆç®—
                const avgConfidence = scores.reduce((sum, s) => sum + s.confidence, 0) / scores.length;
                const avgColor = getConfidenceColor(avgConfidence);
                const avgIcon = getConfidenceIcon(avgConfidence);
                
                html += `
                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: #e9ecef; border-radius: 3px; border-left: 4px solid ${avgColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold; color: #495057;">å¹³å‡ä¿¡é ¼åº¦:</span>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <span style="color: ${avgColor};">${avgIcon}</span>
                                <span style="font-weight: bold; color: ${avgColor}; font-size: 1.1em;">${avgConfidence.toFixed(1)}%</span>
                            </div>
                        </div>
                        <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                            ${getConfidenceRecommendation(avgConfidence)}
                        </div>
                    </div>
                `;
                
                listDiv.innerHTML = html;
                confidenceDiv.style.display = 'block';
            }
        }
        
        // ä¿¡é ¼åº¦ã«å¿œã˜ãŸè‰²ã‚’è¿”ã™
        function getConfidenceColor(confidence) {
            if (confidence >= 85) return '#28a745'; // ç·‘ï¼ˆé«˜ä¿¡é ¼åº¦ï¼‰
            if (confidence >= 70) return '#ffc107'; // é»„ï¼ˆä¸­ä¿¡é ¼åº¦ï¼‰
            if (confidence >= 50) return '#fd7e14'; // ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆä½ä¿¡é ¼åº¦ï¼‰
            return '#dc3545'; // èµ¤ï¼ˆéå¸¸ã«ä½ã„ä¿¡é ¼åº¦ï¼‰
        }
        
        // ä¿¡é ¼åº¦ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿”ã™
        function getConfidenceIcon(confidence) {
            if (confidence >= 85) return 'ğŸŸ¢'; // é«˜ä¿¡é ¼åº¦
            if (confidence >= 70) return 'ğŸŸ¡'; // ä¸­ä¿¡é ¼åº¦
            if (confidence >= 50) return 'ğŸŸ '; // ä½ä¿¡é ¼åº¦
            return 'ğŸ”´'; // éå¸¸ã«ä½ã„ä¿¡é ¼åº¦
        }
        
        // ä¿¡é ¼åº¦ã«å¿œã˜ãŸæ¨å¥¨äº‹é …ã‚’è¿”ã™
        function getConfidenceRecommendation(confidence) {
            if (confidence >= 85) {
                return 'âœ… é«˜ç²¾åº¦ï¼šãã®ã¾ã¾ä½¿ç”¨ã§ãã¾ã™';
            } else if (confidence >= 70) {
                return 'âš ï¸ ä¸­ç²¾åº¦ï¼šå†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
            } else if (confidence >= 50) {
                return 'ğŸ” ä½ç²¾åº¦ï¼šæ‰‹å‹•ã§ä¿®æ­£ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“';
            } else {
                return 'âŒ éå¸¸ã«ä½ã„ç²¾åº¦ï¼šæ‰‹æ›¸ããƒ¢ãƒ¼ãƒ‰ã‚„å‰å‡¦ç†è¨­å®šã®èª¿æ•´ã‚’è©¦ã—ã¦ãã ã•ã„';
            }
        }
        
        // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢è¿½åŠ 
        function addConfidenceScore(regionIndex, text, confidence, ocrType = 'standard') {
            if (!window.confidenceScores) {
                window.confidenceScores = [];
            }
            
            window.confidenceScores.push({
                region: regionIndex,
                text: text,
                confidence: confidence,
                type: ocrType,
                timestamp: new Date()
            });
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            showConfidenceScores(window.confidenceScores);
        }
        
        // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã‚¯ãƒªã‚¢
        function clearConfidenceScores() {
            window.confidenceScores = [];
            document.getElementById('confidence-scores').style.display = 'none';
        }
        
        // OCRä¿¡é ¼åº¦æ¨å®šï¼ˆå®Ÿéš›ã®confidenceãŒå–å¾—ã§ããªã„å ´åˆã®æ¨å®šå€¤ï¼‰
        function estimateOCRConfidence(text, tag) {
            if (!text || text.trim().length === 0) {
                return 0; // ç©ºæ–‡å­—ã¯ä¿¡é ¼åº¦0
            }
            
            let confidence = 50; // ãƒ™ãƒ¼ã‚¹ä¿¡é ¼åº¦
            
            // æœŸé™ã‚¿ã‚°ã®å ´åˆã®ç‰¹åˆ¥åˆ¤å®š
            if (tag === 'deadline') {
                if (parseDeadlineText(text)) {
                    confidence = 85; // æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã™ã‚‹å ´åˆã¯é«˜ä¿¡é ¼åº¦
                } else {
                    confidence = 30; // æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã—ãªã„å ´åˆã¯ä½ä¿¡é ¼åº¦
                }
            } else {
                // ä¸€èˆ¬çš„ãªãƒ†ã‚­ã‚¹ãƒˆã®å“è³ªåˆ¤å®š
                // æ—¥æœ¬èªæ–‡å­—ã®å‰²åˆ
                const japaneseChars = text.match(/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g);
                const japaneseRatio = japaneseChars ? japaneseChars.length / text.length : 0;
                
                // æ•°å­—ãƒ»ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®å‰²åˆ
                const alphanumericChars = text.match(/[a-zA-Z0-9]/g);
                const alphanumericRatio = alphanumericChars ? alphanumericChars.length / text.length : 0;
                
                // è¨˜å·ãƒ»ç‰¹æ®Šæ–‡å­—ã®å‰²åˆï¼ˆå¤šã™ãã‚‹ã¨èªè­˜ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ï¼‰
                const symbolChars = text.match(/[^\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAFa-zA-Z0-9\s]/g);
                const symbolRatio = symbolChars ? symbolChars.length / text.length : 0;
                
                // æ–‡å­—æ•°ã«ã‚ˆã‚‹èª¿æ•´
                if (text.length >= 3 && text.length <= 50) {
                    confidence += 20; // é©åˆ‡ãªæ–‡å­—æ•°
                } else if (text.length > 50) {
                    confidence -= 10; // é•·ã™ãã‚‹å ´åˆã¯ä¿¡é ¼åº¦ä¸‹ã’ã‚‹
                }
                
                // æ—¥æœ¬èªãŒå¤šã„å ´åˆã¯ä¿¡é ¼åº¦å‘ä¸Š
                if (japaneseRatio > 0.7) {
                    confidence += 15;
                } else if (japaneseRatio > 0.3) {
                    confidence += 10;
                }
                
                // è¨˜å·ãŒå¤šã™ãã‚‹å ´åˆã¯ä¿¡é ¼åº¦ä¸‹ã’ã‚‹
                if (symbolRatio > 0.3) {
                    confidence -= 20;
                } else if (symbolRatio > 0.1) {
                    confidence -= 10;
                }
                
                // æ˜ã‚‰ã‹ã«æ„å‘³ã®ã‚ã‚‹å˜èªãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                const meaningfulWords = ['ã‚¿ã‚¹ã‚¯', 'ä½œæ¥­', 'ç¢ºèª', 'é€£çµ¡', 'ä¼šè­°', 'è³‡æ–™', 'æå‡º', 'å®Œäº†', 'é€²è¡Œ'];
                const hasMeaningfulWord = meaningfulWords.some(word => text.includes(word));
                if (hasMeaningfulWord) {
                    confidence += 15;
                }
            }
            
            // ä¿¡é ¼åº¦ã‚’0-100ã®ç¯„å›²ã«åˆ¶é™
            return Math.max(0, Math.min(100, confidence));
        }
        
        function clearAllData() {
            if (confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                if (confirm('æœ€çµ‚ç¢ºèªï¼šå…¨ã¦ã®ã‚¿ã‚¹ã‚¯ã€ã‚«ãƒ©ãƒ è¨­å®šã€æ‹…å½“è€…æƒ…å ±ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                    localStorage.removeItem('salesTasksKanban');
                    localStorage.removeItem('kanbanColumns');
                    localStorage.removeItem('taskAssignees');
                    localStorage.removeItem('alertSettings');
                    localStorage.removeItem('selectedTheme');
                    localStorage.removeItem('themeColors');
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
                    tasks = [];
                    columns = [
                        { id: 'todo', title: 'ğŸ“‹ TODO', color: '#667eea' },
                        { id: 'inprogress', title: 'âš¡ é€²è¡Œä¸­', color: '#f59e0b' },
                        { id: 'waiting', title: 'â³ é€£çµ¡å¾…ã¡', color: '#8b5cf6' },
                        { id: 'done', title: 'âœ… Done', color: '#10b981' }
                    ];
                    // å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’å†æ§‹ç¯‰
                    const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                    assignees = users.map(user => user.name);
                    
                    localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                    
                    console.log('ğŸ§¹ ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆå®Œäº†: å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ™ãƒ¼ã‚¹ã§å†æ§‹ç¯‰', assignees);
                    
                    render();
                    closeSettingsModal();
                    alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                }
            }
        }
        
        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é ˜åŸŸé¸æŠæ©Ÿèƒ½
        let currentImage = null;
        let selectedAreas = [];
        let isSelecting = false;
        let startX, startY, endX, endY;
        let imageScale = 1;
        let originalImageDataUrl = null; // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¡¨ç¤ºç”¨
        
        async function displayImagePreview(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // å…ƒã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
                    originalImageDataUrl = e.target.result;
                    
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        
                        const canvas = document.getElementById('image-canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // å…ƒç”»åƒã®ãƒ•ãƒ«è§£åƒåº¦ã‚’ä¿æŒ
                        let { width, height } = img;
                        imageScale = 1;
                        
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å…ƒç”»åƒã‚µã‚¤ã‚ºã«è¨­å®š
                        canvas.width = width;
                        canvas.height = height;
                        
                        // é«˜ç”»è³ªè¨­å®š
                        ctx.imageSmoothingEnabled = false; // ãƒ”ã‚¯ã‚»ãƒ«ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // CSSã§æœ€å¤§è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’åˆ¶é™ï¼ˆç”»åƒè‡ªä½“ã¯ãƒ•ãƒ«ã‚µã‚¤ã‚ºï¼‰
                        canvas.style.maxWidth = '100%';
                        canvas.style.height = 'auto';
                        
                        // é¸æŠé ˜åŸŸã‚’ãƒªã‚»ãƒƒãƒˆ
                        selectedAreas = [];
                        clearSelectionDisplay();
                        
                        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                        setupCanvasEvents(canvas);
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                        document.getElementById('image-preview-container').style.display = 'block';
                        
                        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã¾ã§è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        setTimeout(() => {
                            document.getElementById('image-preview-container').scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }, 100); // 100msé…å»¶ã§ç¢ºå®Ÿã«DOMãŒæ›´æ–°ã•ã‚Œã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        
                        resolve();
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function setupCanvasEvents(canvas) {
            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            const newCanvas = canvas.cloneNode(true);
            canvas.parentNode.replaceChild(newCanvas, canvas);
            
            newCanvas.addEventListener('mousedown', function(e) {
                const rect = newCanvas.getBoundingClientRect();
                const scaleX = newCanvas.width / rect.width;
                const scaleY = newCanvas.height / rect.height;
                
                startX = (e.clientX - rect.left) * scaleX;
                startY = (e.clientY - rect.top) * scaleY;
                isSelecting = true;
            });
            
            newCanvas.addEventListener('mousemove', function(e) {
                if (!isSelecting) return;
                
                const rect = newCanvas.getBoundingClientRect();
                const scaleX = newCanvas.width / rect.width;
                const scaleY = newCanvas.height / rect.height;
                
                endX = (e.clientX - rect.left) * scaleX;
                endY = (e.clientY - rect.top) * scaleY;
                
                // é¸æŠç¯„å›²ã‚’è¡¨ç¤º
                drawSelection(newCanvas, startX, startY, endX, endY);
                
                // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                const scrollContainer = document.getElementById('image-preview-scroll-container');
                const containerRect = scrollContainer.getBoundingClientRect();
                const scrollSpeed = 10;
                
                // ä¸‹æ–¹å‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (e.clientY > containerRect.bottom - 50) {
                    scrollContainer.scrollTop += scrollSpeed;
                }
                // ä¸Šæ–¹å‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                else if (e.clientY < containerRect.top + 50) {
                    scrollContainer.scrollTop -= scrollSpeed;
                }
                // å³æ–¹å‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (e.clientX > containerRect.right - 50) {
                    scrollContainer.scrollLeft += scrollSpeed;
                }
                // å·¦æ–¹å‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                else if (e.clientX < containerRect.left + 50) {
                    scrollContainer.scrollLeft -= scrollSpeed;
                }
            });
            
            newCanvas.addEventListener('mouseup', function(e) {
                if (!isSelecting) return;
                
                const rect = newCanvas.getBoundingClientRect();
                const scaleX = newCanvas.width / rect.width;
                const scaleY = newCanvas.height / rect.height;
                
                endX = (e.clientX - rect.left) * scaleX;
                endY = (e.clientY - rect.top) * scaleY;
                
                // é¸æŠé ˜åŸŸã‚’ä¿å­˜ï¼ˆæœ€å°10x10ãƒ”ã‚¯ã‚»ãƒ«ï¼‰
                const width = Math.abs(endX - startX);
                const height = Math.abs(endY - startY);
                
                if (width > 10 && height > 10) {
                    const area = {
                        x: Math.min(startX, endX),
                        y: Math.min(startY, endY),
                        width: width,
                        height: height,
                        id: Date.now(),
                        tag: null, // 'task' ã¾ãŸã¯ 'deadline'
                        text: null // OCRçµæœ
                    };
                    selectedAreas.push(area);
                    updateSelectionDisplay();
                    
                    // ã‚¿ã‚°é¸æŠUIã‚’è¡¨ç¤º
                    showAreaTagSelector(selectedAreas.length - 1);
                }
                
                isSelecting = false;
                redrawCanvas(newCanvas);
            });
        }
        
        function drawSelection(canvas, x1, y1, x2, y2) {
            const ctx = canvas.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å†æç”»
            redrawCanvas(canvas);
            
            // ç¾åœ¨ã®é¸æŠç¯„å›²ã‚’æç”»
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(Math.min(x1, x2), Math.min(y1, y2), Math.abs(x2 - x1), Math.abs(y2 - y1));
            
            // åŠé€æ˜ã®èƒŒæ™¯
            ctx.fillStyle = 'rgba(0, 123, 255, 0.1)';
            ctx.fillRect(Math.min(x1, x2), Math.min(y1, y2), Math.abs(x2 - x1), Math.abs(y2 - y1));
        }
        
        function redrawCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // å…ƒç”»åƒã‚’å†æç”»
            if (currentImage) {
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            }
            
            // ä¿å­˜ã•ã‚ŒãŸé¸æŠé ˜åŸŸã‚’æç”»ï¼ˆã‚¿ã‚°ã«å¿œã˜ã¦è‰²åˆ†ã‘ï¼‰
            ctx.setLineDash([]);
            selectedAreas.forEach((area, index) => {
                let strokeColor = '#6c757d'; // æœªåˆ†é¡ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰
                let fillColor = 'rgba(108, 117, 125, 0.1)';
                let textIcon = '';
                
                if (area.tag === 'task') {
                    strokeColor = '#28a745'; // ã‚¿ã‚¹ã‚¯ï¼ˆç·‘ï¼‰
                    fillColor = 'rgba(40, 167, 69, 0.1)';
                    textIcon = 'ğŸ“‹';
                } else if (area.tag === 'deadline') {
                    strokeColor = '#dc3545'; // æœŸé™ï¼ˆèµ¤ï¼‰
                    fillColor = 'rgba(220, 53, 69, 0.1)';
                    textIcon = 'ğŸ“…';
                }
                
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = 3;
                ctx.strokeRect(area.x, area.y, area.width, area.height);
                
                ctx.fillStyle = fillColor;
                ctx.fillRect(area.x, area.y, area.width, area.height);
                
                // ç•ªå·ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
                ctx.fillStyle = strokeColor;
                ctx.font = 'bold 14px Arial';
                ctx.fillText(`${textIcon}${index + 1}`, area.x + 5, area.y + 18);
            });
        }
        
        function updateSelectionDisplay() {
            const taskCount = selectedAreas.filter(area => area.tag === 'task').length;
            const deadlineCount = selectedAreas.filter(area => area.tag === 'deadline').length;
            const untaggedCount = selectedAreas.filter(area => !area.tag).length;
            
            let displayText = `${selectedAreas.length}å€‹ã®é ˜åŸŸã‚’é¸æŠä¸­`;
            if (taskCount > 0 || deadlineCount > 0) {
                displayText += ` (ğŸ“‹ã‚¿ã‚¹ã‚¯:${taskCount}, ğŸ“…æœŸé™:${deadlineCount}`;
                if (untaggedCount > 0) {
                    displayText += `, æœªåˆ†é¡:${untaggedCount}`;
                }
                displayText += ')';
            }
            
            document.getElementById('selection-count').textContent = displayText;
        }
        
        // ã‚¿ã‚°é¸æŠUIã‚’è¡¨ç¤º
        function showAreaTagSelector(areaIndex) {
            // æ—¢å­˜ã®ã‚¿ã‚°é¸æŠUIã‚’å‰Šé™¤
            const existingSelector = document.getElementById('area-tag-selector');
            if (existingSelector) {
                existingSelector.remove();
            }
            
            const area = selectedAreas[areaIndex];
            const container = document.getElementById('image-preview-scroll-container');
            
            // ã‚¿ã‚°é¸æŠUIã‚’ä½œæˆ
            const selectorDiv = document.createElement('div');
            selectorDiv.id = 'area-tag-selector';
            selectorDiv.style.cssText = `
                position: absolute;
                top: ${area.y + area.height + 10}px;
                left: ${area.x}px;
                background: white;
                border: 2px solid #007bff;
                border-radius: 8px;
                padding: 0.5rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                display: flex;
                gap: 0.5rem;
                align-items: center;
                font-size: 0.9rem;
            `;
            
            selectorDiv.innerHTML = `
                <span style="font-weight: bold; color: #495057;">ã‚¿ã‚¹ã‚¯åã¨ã—ã¦èªè­˜ï¼š</span>
                <button onclick="setAreaTag(${areaIndex}, 'task')" 
                        style="padding: 0.4rem 0.8rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                    ğŸ“‹ ç¢ºå®š
                </button>
            `;
            
            container.appendChild(selectorDiv);
            
            // 3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãªã‹ã£ãŸå ´åˆï¼‰
            setTimeout(() => {
                if (document.getElementById('area-tag-selector')) {
                    selectorDiv.remove();
                }
            }, 5000);
        }
        
        // é ˜åŸŸã«ã‚¿ã‚°ã‚’è¨­å®š
        function setAreaTag(areaIndex, tag) {
            if (selectedAreas[areaIndex]) {
                selectedAreas[areaIndex].tag = 'task'; // å¸¸ã«ã‚¿ã‚¹ã‚¯ã¨ã—ã¦è¨­å®š
                updateSelectionDisplay();
                redrawCanvas(document.getElementById('image-canvas'));
                
                // ã‚¿ã‚°é¸æŠUIã‚’å‰Šé™¤
                const selector = document.getElementById('area-tag-selector');
                if (selector) {
                    selector.remove();
                }
            }
        }
        
        function clearSelections() {
            selectedAreas = [];
            updateSelectionDisplay();
            const canvas = document.getElementById('image-canvas');
            redrawCanvas(canvas);
        }
        
        function clearSelectionDisplay() {
            document.getElementById('selection-overlay').innerHTML = '';
            updateSelectionDisplay();
        }
        
        function hideImagePreview() {
            document.getElementById('image-preview-container').style.display = 'none';
            selectedAreas = [];
            currentImage = null;
            // æ³¨æ„ï¼šoriginalImageDataUrlã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã«ä¿æŒ
        }
        
        // ã‚¿ã‚¹ã‚¯å…¥åŠ›ã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollToTaskArea() {
            document.getElementById('import-text').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            document.getElementById('import-text').focus();
        }
        
        // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleScreenshot() {
            const preview = document.getElementById('screenshot-preview');
            const button = document.getElementById('screenshot-toggle');
            
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                button.textContent = 'éè¡¨ç¤º';
            } else {
                preview.style.display = 'none';
                button.textContent = 'è¡¨ç¤º';
            }
        }
        
        async function processSelectedAreas() {
            if (selectedAreas.length === 0) {
                alert('é¸æŠé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¦ã‚¹ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            showOCRProgress();
            clearConfidenceScores(); // æ–°ã—ã„OCRå‡¦ç†é–‹å§‹æ™‚ã«ã‚¯ãƒªã‚¢
            
            try {
                // å„é ˜åŸŸã®OCRå‡¦ç†
                for (let i = 0; i < selectedAreas.length; i++) {
                    const area = selectedAreas[i];
                    updateOCRProgress(10 + (i / selectedAreas.length) * 70, `ğŸ” é ˜åŸŸ ${i + 1}/${selectedAreas.length} ã‚’å‡¦ç†ä¸­...`);
                    
                    // é¸æŠé ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                    const croppedCanvas = document.createElement('canvas');
                    const croppedCtx = croppedCanvas.getContext('2d');
                    
                    // å®Ÿéš›ã®ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦åº§æ¨™ã‚’èª¿æ•´
                    const realX = area.x / imageScale;
                    const realY = area.y / imageScale;
                    const realWidth = area.width / imageScale;
                    const realHeight = area.height / imageScale;
                    
                    croppedCanvas.width = realWidth;
                    croppedCanvas.height = realHeight;
                    
                    croppedCtx.drawImage(
                        currentImage,
                        realX, realY, realWidth, realHeight,
                        0, 0, realWidth, realHeight
                    );
                    
                    // OCRå‡¦ç†ï¼ˆæœŸé™é ˜åŸŸã¯ç‰¹åˆ¥å‡¦ç†ï¼‰
                    let text;
                    if (area.tag === 'deadline') {
                        console.log(`æœŸé™é ˜åŸŸ ${i + 1} ã®å‡¦ç†é–‹å§‹:`, area);
                        
                        // æ‰‹æ›¸ããƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
                        const isHandwritingMode = document.getElementById('ocr-handwriting-mode').checked;
                        
                        if (isHandwritingMode) {
                            console.log('æ‰‹æ›¸ããƒ¢ãƒ¼ãƒ‰ã§æœŸé™OCRå®Ÿè¡Œ');
                            try {
                                const handwritingResult = await performHandwritingOCR(croppedCanvas);
                                text = handwritingResult.text;
                                console.log(`æœŸé™é ˜åŸŸ ${i + 1} æ‰‹æ›¸ãOCRçµæœ:`, text, `(ä¿¡é ¼åº¦: ${handwritingResult.confidence}%)`);
                                
                                // æ‰‹æ›¸ãã§æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœŸé™ç”¨OCRã‚‚è©¦è¡Œ
                                if (!parseDeadlineText(text)) {
                                    console.log('æ‰‹æ›¸ãOCRã§æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€æœŸé™ç”¨OCRã‚’è©¦è¡Œ');
                                    const deadlineText = await performDeadlineOCR(croppedCanvas);
                                    console.log(`æœŸé™é ˜åŸŸ ${i + 1} æœŸé™ç”¨OCRçµæœ:`, deadlineText);
                                    
                                    if (parseDeadlineText(deadlineText)) {
                                        text = deadlineText;
                                    }
                                }
                            } catch (error) {
                                console.error('æ‰‹æ›¸ãOCRã§ã‚¨ãƒ©ãƒ¼ã€æœŸé™ç”¨OCRã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
                                text = await performDeadlineOCR(croppedCanvas);
                            }
                        } else {
                            // é€šå¸¸ã®æœŸé™ç”¨OCRã‚’è©¦è¡Œ
                            text = await performDeadlineOCR(croppedCanvas);
                            console.log(`æœŸé™é ˜åŸŸ ${i + 1} æœŸé™ç”¨OCRçµæœ:`, text);
                            
                            // æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€é€šå¸¸OCRã‚‚è©¦è¡Œ
                            if (!parseDeadlineText(text)) {
                                console.log('æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€é€šå¸¸OCRã‚’è©¦è¡Œ');
                                const normalText = await performOCROnCanvas(croppedCanvas);
                                console.log(`æœŸé™é ˜åŸŸ ${i + 1} é€šå¸¸OCRçµæœ:`, normalText);
                                
                                // ã‚ˆã‚Šè‰¯ã„çµæœã‚’æ¡ç”¨
                                if (parseDeadlineText(normalText)) {
                                    text = normalText;
                                }
                            }
                        }
                    } else {
                        text = await performOCROnCanvas(croppedCanvas);
                        console.log(`ã‚¿ã‚¹ã‚¯é ˜åŸŸ ${i + 1} OCRçµæœ:`, text);
                    }
                    area.text = text.trim(); // çµæœã‚’é ˜åŸŸã«ä¿å­˜
                    
                    // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ï¼ˆæ‰‹æ›¸ãOCRã®å ´åˆã¯ä¿¡é ¼åº¦ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼‰
                    if (area.tag === 'deadline' && isHandwritingMode && typeof handwritingResult !== 'undefined') {
                        addConfidenceScore(i + 1, text.trim(), handwritingResult.confidence || 0, 'handwriting');
                    } else {
                        // é€šå¸¸OCRã®å ´åˆã€æ¨å®šä¿¡é ¼åº¦ã‚’è¨ˆç®—
                        const estimatedConfidence = estimateOCRConfidence(text.trim(), area.tag);
                        addConfidenceScore(i + 1, text.trim(), estimatedConfidence, area.tag === 'deadline' ? 'deadline' : 'standard');
                    }
                }
                
                updateOCRProgress(85, 'ğŸ”— ã‚¿ã‚¹ã‚¯ã¨æœŸé™ã‚’ãƒšã‚¢åŒ–ä¸­...');
                
                // ã‚¿ã‚°ä»˜ãã®é ˜åŸŸã‚’è‡ªå‹•ãƒšã‚¢åŒ–
                const tasks = generateSimpleTaskList();
                
                updateOCRProgress(95, 'ğŸ“ çµæœã‚’æ•´ç†ä¸­...');
                
                if (tasks.length > 0) {
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    alert(`âœ… OCRå®Œäº†ï¼\nğŸ“‹ ${tasks.length}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’èªè­˜ã—ã¾ã—ãŸ\n\nğŸ“ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æœŸé™ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚`);
                    
                    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
                    hideImagePreview();
                    
                    // è‡ªå‹•ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
                    setTimeout(() => {
                        previewImport();
                    }, 500);
                } else {
                    alert('æœ‰åŠ¹ãªã‚¿ã‚¹ã‚¯ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ–‡å­—ãŒã¯ã£ãã‚Šè¦‹ãˆã‚‹é ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                }
                
                hideOCRProgress();
            } catch (error) {
                hideOCRProgress();
                console.error('Area OCR Error:', error);
                
                // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                let errorMessage = 'OCRå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n';
                errorMessage += `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message || error}\n\n`;
                
                if (error.message && error.message.includes('network')) {
                    errorMessage += 'ã€åŸå› ã€‘ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n';
                    errorMessage += 'ã€å¯¾ç­–ã€‘ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message && error.message.includes('memory')) {
                    errorMessage += 'ã€åŸå› ã€‘ãƒ¡ãƒ¢ãƒªä¸è¶³ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n';
                    errorMessage += 'ã€å¯¾ç­–ã€‘ç”»åƒã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                } else if (error.message && error.message.includes('cors')) {
                    errorMessage += 'ã€åŸå› ã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã®å•é¡Œã§ã™ã€‚\n';
                    errorMessage += 'ã€å¯¾ç­–ã€‘åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãŠè©¦ã—ãã ã•ã„ã€‚';
                } else {
                    errorMessage += 'ã€å¯¾ç­–ã€‘\n';
                    errorMessage += '1. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„\n';
                    errorMessage += '2. ç•°ãªã‚‹ç”»åƒã§ãŠè©¦ã—ãã ã•ã„\n';
                    errorMessage += '3. ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„';
                }
                
                alert(errorMessage);
            }
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆç”Ÿæˆ
        function generateSimpleTaskList() {
            const tasks = selectedAreas
                .filter(area => area.text && area.text.trim().length > 1)
                .map(area => area.text.trim());
            
            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
            const importText = tasks.join('\n');
            document.getElementById('import-text').value = importText;
            
            console.log('èªè­˜ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯:', tasks);
            return tasks;
        }

        // ã‚¿ã‚¹ã‚¯ã¨æœŸé™ã‚’ãƒšã‚¢åŒ–ï¼ˆå‰Šé™¤äºˆå®šï¼‰
        function pairTasksAndDeadlines() {
            const taskAreas = selectedAreas.filter(area => area.tag === 'task' && area.text);
            const deadlineAreas = selectedAreas.filter(area => area.tag === 'deadline' && area.text);
            const untaggedAreas = selectedAreas.filter(area => !area.tag && area.text);
            
            console.log('=== ãƒšã‚¢åŒ–å‡¦ç†é–‹å§‹ ===');
            console.log('ã‚¿ã‚¹ã‚¯é ˜åŸŸ:', taskAreas.map(a => ({ text: a.text, tag: a.tag })));
            console.log('æœŸé™é ˜åŸŸ:', deadlineAreas.map(a => ({ text: a.text, tag: a.tag })));
            console.log('æœªåˆ†é¡é ˜åŸŸ:', untaggedAreas.map(a => ({ text: a.text, tag: a.tag })));
            
            const pairedTasks = [];
            
            // ã‚¿ã‚¹ã‚¯é ˜åŸŸã‚’åŸºæº–ã«ãƒšã‚¢åŒ–
            taskAreas.forEach(taskArea => {
                const task = {
                    type: 'task',
                    title: taskArea.text,
                    deadline: null,
                    taskArea: taskArea
                };
                
                // æœ€ã‚‚è¿‘ã„æœŸé™é ˜åŸŸã‚’æ¢ã™
                let closestDeadline = null;
                let minDistance = Infinity;
                
                deadlineAreas.forEach(deadlineArea => {
                    // è·é›¢ã‚’è¨ˆç®—ï¼ˆä¸­å¿ƒç‚¹é–“ã®è·é›¢ï¼‰
                    const taskCenterX = taskArea.x + taskArea.width / 2;
                    const taskCenterY = taskArea.y + taskArea.height / 2;
                    const deadlineCenterX = deadlineArea.x + deadlineArea.width / 2;
                    const deadlineCenterY = deadlineArea.y + deadlineArea.height / 2;
                    
                    const distance = Math.sqrt(
                        Math.pow(taskCenterX - deadlineCenterX, 2) + 
                        Math.pow(taskCenterY - deadlineCenterY, 2)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestDeadline = deadlineArea;
                    }
                });
                
                if (closestDeadline) {
                    console.log(`ã‚¿ã‚¹ã‚¯ "${taskArea.text}" ã«æœ€ã‚‚è¿‘ã„æœŸé™é ˜åŸŸ:`, closestDeadline.text);
                    task.deadline = parseDeadlineText(closestDeadline.text);
                    console.log(`è§£æçµæœ:`, task.deadline);
                    // ä½¿ç”¨æ¸ˆã¿ã®æœŸé™é ˜åŸŸã‚’å‰Šé™¤
                    const index = deadlineAreas.indexOf(closestDeadline);
                    if (index > -1) {
                        deadlineAreas.splice(index, 1);
                    }
                } else {
                    console.log(`ã‚¿ã‚¹ã‚¯ "${taskArea.text}" ã«å¯¾ã™ã‚‹æœŸé™é ˜åŸŸãŒè¦‹ã¤ã‹ã‚‰ãªã„`);
                }
                
                pairedTasks.push(task);
            });
            
            // æœªåˆ†é¡ã®é ˜åŸŸã‚‚è¿½åŠ ï¼ˆã‚¿ã‚¹ã‚¯ã¨ã—ã¦æ‰±ã†ï¼‰
            untaggedAreas.forEach(area => {
                pairedTasks.push({
                    type: 'task',
                    title: area.text,
                    deadline: null
                });
            });
            
            return pairedTasks;
        }
        
        // GoogleTODOå°‚ç”¨ã®çµ¶å¯¾å‚ç…§å¤‰æ›é–¢æ•°
        function convertToAbsoluteReference(text) {
            console.log('çµ¶å¯¾å‚ç…§å¤‰æ›é–‹å§‹:', text);
            
            // Step 1: å›²ã¿æ•°å­—ã®çµ¶å¯¾å¤‰æ›ï¼ˆæœ€å„ªå…ˆï¼‰
            const circledNumbers = {
                'â‘ ': '1', 'â‘¡': '2', 'â‘¢': '3', 'â‘£': '4', 'â‘¤': '5', 'â‘¥': '6', 'â‘¦': '7', 'â‘§': '8', 'â‘¨': '9', 'â‘©': '10',
                'â‘ª': '11', 'â‘«': '12', 'â‘¬': '13', 'â‘­': '14', 'â‘®': '15', 'â‘¯': '16', 'â‘°': '17', 'â‘±': '18', 'â‘²': '19', 'â‘³': '20',
                'ã‰‘': '21', 'ã‰’': '22', 'ã‰“': '23', 'ã‰”': '24', 'ã‰•': '25', 'ã‰–': '26', 'ã‰—': '27', 'ã‰˜': '28', 'ã‰™': '29', 'ã‰š': '30', 'ã‰›': '31'
            };
            
            let converted = text;
            Object.keys(circledNumbers).forEach(circle => {
                converted = converted.replace(new RegExp(circle, 'g'), circledNumbers[circle]);
            });
            
            // Step 2: å…¨è§’æ•°å­—ã®çµ¶å¯¾å¤‰æ›
            const fullWidthNumbers = {
                'ï¼': '0', 'ï¼‘': '1', 'ï¼’': '2', 'ï¼“': '3', 'ï¼”': '4', 'ï¼•': '5', 'ï¼–': '6', 'ï¼—': '7', 'ï¼˜': '8', 'ï¼™': '9'
            };
            
            Object.keys(fullWidthNumbers).forEach(full => {
                converted = converted.replace(new RegExp(full, 'g'), fullWidthNumbers[full]);
            });
            
            // Step 3: æ›œæ—¥ã®çµ¶å¯¾å‚ç…§ï¼ˆç¢ºå®Ÿãªå¤‰æ›ï¼‰
            const weekdays = {
                'æœˆæ›œ': 'æœˆ', 'ç«æ›œ': 'ç«', 'æ°´æ›œ': 'æ°´', 'æœ¨æ›œ': 'æœ¨', 'é‡‘æ›œ': 'é‡‘', 'åœŸæ›œ': 'åœŸ', 'æ—¥æ›œ': 'æ—¥',
                'ã’ã¤': 'æœˆ', 'ã‹': 'ç«', 'ã™ã„': 'æ°´', 'ã‚‚ã': 'æœ¨', 'ãã‚“': 'é‡‘', 'ã©': 'åœŸ', 'ã«ã¡': 'æ—¥'
            };
            
            Object.keys(weekdays).forEach(day => {
                converted = converted.replace(new RegExp(day, 'g'), weekdays[day]);
            });
            
            // Step 4: GoogleTODOç‰¹æœ‰ã®ãƒã‚¤ã‚ºé™¤å»
            converted = converted
                .replace(/[|ï½œ]/g, '') // ç¸¦ç·šé™¤å»
                .replace(/[â–¡â– ]/g, '') // å››è§’è¨˜å·é™¤å»  
                .replace(/[ï½ã€œ]/g, '') // æ³¢ç·šé™¤å»
                .replace(/\s+/g, ' ')  // é€£ç¶šç©ºç™½ã‚’1ã¤ã«
                .trim();
            
            // Step 5: æœŸé™ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å¼·åˆ¶æ­£è¦åŒ–
            // mmæœˆddæ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã—ã¦ç¢ºå®Ÿã«æŠ½å‡º
            const datePattern = /(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/;
            const timePattern = /(\d{1,2})\s*:\s*(\d{2})/;
            const dayPattern = /\(([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥])\)/;
            
            const dateMatch = converted.match(datePattern);
            const timeMatch = converted.match(timePattern);
            const dayMatch = converted.match(dayPattern);
            
            if (dateMatch) {
                let result = `${dateMatch[1]}æœˆ${dateMatch[2]}æ—¥`;
                
                if (dayMatch) {
                    result += `(${dayMatch[1]})`;
                }
                
                if (timeMatch) {
                    result += `, ${timeMatch[1]}:${timeMatch[2]}`;
                }
                
                console.log('çµ¶å¯¾å‚ç…§å¤‰æ›å®Œäº†:', result);
                return result;
            }
            
            console.log('çµ¶å¯¾å‚ç…§å¤‰æ›ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰:', converted);
            return converted;
        }
        
        // GoogleTODOæœŸé™ãƒ†ã‚­ã‚¹ãƒˆã‚’å³å¯†è§£æï¼ˆçµ¶å¯¾å‚ç…§æ–¹å¼ãƒ»å¼·åŒ–ç‰ˆï¼‰
        function parseDeadlineText(text) {
            console.log('æœŸé™è§£æå¯¾è±¡:', text);
            
            if (!text || text.trim().length === 0) {
                console.log('ç©ºæ–‡å­—ã®ãŸã‚è§£æå¤±æ•—');
                return null;
            }
            
            // Step 1: GoogleTODOå°‚ç”¨ã®çµ¶å¯¾å‚ç…§å¤‰æ›
            let absoluteText = convertToAbsoluteReference(text);
            console.log('çµ¶å¯¾å‚ç…§å¤‰æ›å¾Œ:', absoluteText);
            
            // Step 2: è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æœŸé™æŠ½å‡ºã‚’è©¦è¡Œ
            const patterns = [
                // Pattern 1: å³å¯†GoogleTODOãƒ‘ã‚¿ãƒ¼ãƒ³
                tryStrictGoogleTodoPattern,
                // Pattern 2: æŸ”è»Ÿãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒã‚¤ã‚ºã‚ã‚Šï¼‰
                tryFlexiblePattern,
                // Pattern 3: éƒ¨åˆ†ãƒãƒƒãƒãƒ‘ã‚¿ãƒ¼ãƒ³
                tryPartialMatchPattern,
                // Pattern 4: æ•°å­—æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
                tryNumberExtractionPattern
            ];
            
            for (let i = 0; i < patterns.length; i++) {
                console.log(`ãƒ‘ã‚¿ãƒ¼ãƒ³ ${i + 1} è©¦è¡Œä¸­...`);
                const result = patterns[i](absoluteText);
                if (result) {
                    console.log(`ãƒ‘ã‚¿ãƒ¼ãƒ³ ${i + 1} ã§æˆåŠŸ:`, result);
                    return result;
                }
            }
            
            console.log('å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è§£æå¤±æ•—');
            return null;
        }
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³1: å³å¯†GoogleTODOãƒ‘ã‚¿ãƒ¼ãƒ³
        function tryStrictGoogleTodoPattern(text) {
            // GoogleTODOã®å³å¯†ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒã‚¤ã‚ºã‚’é™¤å»ï¼‰
            const cleanText = text.replace(/[^\dæœˆæ—¥\(\)æœˆç«æ°´æœ¨é‡‘åœŸæ—¥,:\s]/g, '');
            console.log('å³å¯†ãƒ‘ã‚¿ãƒ¼ãƒ³ - ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œ:', cleanText);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: mmæœˆddæ—¥(æ›œæ—¥), hh:mm å½¢å¼
            const pattern1 = /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*\([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]\)\s*,?\s*(\d{1,2}):(\d{2})/;
            const match1 = cleanText.match(pattern1);
            if (match1) {
                const month = parseInt(match1[1]);
                const day = parseInt(match1[2]);
                const hour = parseInt(match1[3]);
                const minute = parseInt(match1[4]);
                
                // æ—¥ä»˜ãƒ»æ™‚åˆ»ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                if (month >= 1 && month <= 12 && 
                    day >= 1 && day <= 31 && 
                    hour >= 0 && hour <= 23 && 
                    minute >= 0 && minute <= 59) {
                    
                    const monthStr = month.toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-${monthStr}-${dayStr}T${hourStr}:${minuteStr}`;
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³1ãƒãƒƒãƒ:', result);
                    return result;
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: mmæœˆddæ—¥(æ›œæ—¥) å½¢å¼ï¼ˆæ™‚åˆ»ãªã—ï¼‰
            const pattern2 = /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*\([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]\)/;
            const match2 = cleanText.match(pattern2);
            if (match2) {
                const month = parseInt(match2[1]);
                const day = parseInt(match2[2]);
                
                // æ—¥ä»˜ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const monthStr = month.toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-${monthStr}-${dayStr}`;
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³2ãƒãƒƒãƒ:', result);
                    return result;
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: mmæœˆddæ—¥, hh:mm å½¢å¼ï¼ˆæ›œæ—¥ãªã—ï¼‰
            const pattern3 = /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*,?\s*(\d{1,2}):(\d{2})/;
            const match3 = cleanText.match(pattern3);
            if (match3) {
                const month = parseInt(match3[1]);
                const day = parseInt(match3[2]);
                const hour = parseInt(match3[3]);
                const minute = parseInt(match3[4]);
                
                // æ—¥ä»˜ãƒ»æ™‚åˆ»ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                if (month >= 1 && month <= 12 && 
                    day >= 1 && day <= 31 && 
                    hour >= 0 && hour <= 23 && 
                    minute >= 0 && minute <= 59) {
                    
                    const monthStr = month.toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-${monthStr}-${dayStr}T${hourStr}:${minuteStr}`;
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³3ãƒãƒƒãƒ:', result);
                    return result;
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³4: mmæœˆddæ—¥ å½¢å¼ï¼ˆæ›œæ—¥ãƒ»æ™‚åˆ»ãªã—ï¼‰
            const pattern4 = /(\d{1,2})æœˆ(\d{1,2})æ—¥/;
            const match4 = cleanText.match(pattern4);
            if (match4) {
                const month = parseInt(match4[1]);
                const day = parseInt(match4[2]);
                
                // æ—¥ä»˜ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const monthStr = month.toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-${monthStr}-${dayStr}`;
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³4ãƒãƒƒãƒ:', result);
                    return result;
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³5: æ™‚åˆ»ã®ã¿ hh:mmï¼ˆä»Šæ—¥ã®æœŸé™ã¨ã—ã¦å‡¦ç†ï¼‰
            const pattern5 = /^(\d{1,2}):(\d{2})$/;
            const match5 = cleanText.trim().match(pattern5);
            if (match5) {
                const hour = parseInt(match5[1]);
                const minute = parseInt(match5[2]);
                
                // æ™‚é–“ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆGoogleTODOã®æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
                if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const today = new Date();
                    const result = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T${hourStr}:${minuteStr}`;
                    console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³5ãƒãƒƒãƒï¼ˆæ™‚åˆ»ã®ã¿ï¼‰:', result);
                    return result;
                } else {
                    console.log('ç„¡åŠ¹ãªæ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:', match5[0]);
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³6: å³å¯†ãªæ™‚åˆ»ãƒã‚§ãƒƒã‚¯ä»˜ããƒ‘ã‚¿ãƒ¼ãƒ³å†æ¤œè¨¼
            const timeValidationPatterns = [
                // ã‚ˆã‚Šå³å¯†ãªæ™‚åˆ»ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ0-23æ™‚ã€0-59åˆ†ã®ã¿è¨±å¯ï¼‰
                /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*\([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]\)\s*,?\s*([0-2]?\d):([0-5]\d)/,
                /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*,?\s*([0-2]?\d):([0-5]\d)/
            ];
            
            for (const pattern of timeValidationPatterns) {
                const match = cleanText.match(pattern);
                if (match) {
                    const month = parseInt(match[1]);
                    const day = parseInt(match[2]);
                    const hour = parseInt(match[3]);
                    const minute = parseInt(match[4]);
                    
                    // æ—¥ä»˜ã¨æ™‚åˆ»ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                    if (month >= 1 && month <= 12 && 
                        day >= 1 && day <= 31 && 
                        hour >= 0 && hour <= 23 && 
                        minute >= 0 && minute <= 59) {
                        
                        const monthStr = month.toString().padStart(2, '0');
                        const dayStr = day.toString().padStart(2, '0');
                        const hourStr = hour.toString().padStart(2, '0');
                        const minuteStr = minute.toString().padStart(2, '0');
                        const currentYear = new Date().getFullYear();
                        const result = `${currentYear}-${monthStr}-${dayStr}T${hourStr}:${minuteStr}`;
                        console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³6ãƒãƒƒãƒï¼ˆå³å¯†ãƒã‚§ãƒƒã‚¯ï¼‰:', result);
                        return result;
                    }
                }
            }
            
            console.log('æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã›ãš:', text);
            return null;
        }
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³2: æŸ”è»Ÿãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒã‚¤ã‚ºã‚’å«ã‚€ï¼‰
        function tryFlexiblePattern(text) {
            console.log('æŸ”è»Ÿãƒ‘ã‚¿ãƒ¼ãƒ³é–‹å§‹:', text);
            
            // ã‚ˆã‚Šç·©ã„æ¸…æµ„åŒ–ï¼ˆé‡è¦æ–‡å­—ã‚’ä¿æŒï¼‰
            const flexibleText = text
                .replace(/[|ï½œ]/g, '') // ç¸¦ç·šé™¤å»
                .replace(/[â–¡â– â–¢â–£]/g, '') // å››è§’è¨˜å·é™¤å»
                .replace(/[ï½ã€œ]/g, '') // æ³¢ç·šé™¤å»
                .replace(/\s+/g, ' ') // é€£ç¶šç©ºç™½ã‚’1ã¤ã«
                .trim();
            
            console.log('æŸ”è»Ÿãƒ‘ã‚¿ãƒ¼ãƒ³ - è»½ã„ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œ:', flexibleText);
            
            // ã‚ˆã‚ŠæŸ”è»Ÿãªæ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³
            const flexiblePatterns = [
                { regex: /(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥.*?(\d{1,2})\s*:\s*(\d{2})/, type: 'flexible_full' },
                { regex: /(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/, type: 'flexible_date' },
                { regex: /(\d{1,2})\s*:\s*(\d{2})/, type: 'flexible_time' }
            ];
            
            for (const pattern of flexiblePatterns) {
                const match = flexibleText.match(pattern.regex);
                if (match) {
                    const result = buildDateString(match, pattern.type);
                    if (result) {
                        console.log(`æŸ”è»Ÿãƒ‘ã‚¿ãƒ¼ãƒ³(${pattern.type})ãƒãƒƒãƒ:`, result);
                        return result;
                    }
                }
            }
            
            console.log('æŸ”è»Ÿãƒ‘ã‚¿ãƒ¼ãƒ³ã§è§£æå¤±æ•—');
            return null;
        }
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³3: éƒ¨åˆ†ãƒãƒƒãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ–­ç‰‡çš„ãªæƒ…å ±ã‹ã‚‰æ§‹ç¯‰ï¼‰
        function tryPartialMatchPattern(text) {
            console.log('éƒ¨åˆ†ãƒãƒƒãƒãƒ‘ã‚¿ãƒ¼ãƒ³é–‹å§‹:', text);
            
            // æ•°å­—ã®ã¿ã‚’æŠ½å‡º
            const numbers = text.match(/\d+/g);
            if (!numbers || numbers.length < 2) {
                console.log('éƒ¨åˆ†ãƒãƒƒãƒ: æ•°å­—ãŒä¸è¶³');
                return null;
            }
            
            console.log('æŠ½å‡ºã•ã‚ŒãŸæ•°å­—:', numbers);
            
            // æœˆãƒ»æ—¥ã‚‰ã—ãæ•°å­—ã®çµ„ã¿åˆã‚ã›ã‚’æ¢ã™
            for (let i = 0; i < numbers.length - 1; i++) {
                const month = parseInt(numbers[i]);
                const day = parseInt(numbers[i + 1]);
                
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // æ™‚åˆ»ã‚‚æ¢ã™
                    let timeResult = '';
                    if (numbers.length >= i + 4) {
                        const hour = parseInt(numbers[i + 2]);
                        const minute = parseInt(numbers[i + 3]);
                        if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                            timeResult = `T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        }
                    }
                    
                    const result = `${new Date().getFullYear()}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}${timeResult}`;
                    console.log('éƒ¨åˆ†ãƒãƒƒãƒãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ:', result);
                    return result;
                }
            }
            
            console.log('éƒ¨åˆ†ãƒãƒƒãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã§è§£æå¤±æ•—');
            return null;
        }
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³4: æ•°å­—æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
        function tryNumberExtractionPattern(text) {
            console.log('æ•°å­—æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³é–‹å§‹:', text);
            
            // ã‚ˆã‚Šç©æ¥µçš„ãªæ•°å­—æŠ½å‡º
            const allNumbers = [];
            const digitMatches = text.match(/\d/g);
            if (digitMatches) {
                let currentNumber = '';
                for (const digit of digitMatches) {
                    currentNumber += digit;
                    if (currentNumber.length >= 2) {
                        allNumbers.push(parseInt(currentNumber));
                        currentNumber = digit; // æ¬¡ã®æ•°å­—ã¨ã—ã¦ç¶™ç¶š
                    }
                }
                if (currentNumber.length > 0) {
                    allNumbers.push(parseInt(currentNumber));
                }
            }
            
            console.log('å…¨æŠ½å‡ºæ•°å­—:', allNumbers);
            
            // æœ€ã‚‚æœŸé™ã‚‰ã—ãçµ„ã¿åˆã‚ã›ã‚’æ¢ã™
            for (let i = 0; i < allNumbers.length - 1; i++) {
                const num1 = allNumbers[i];
                const num2 = allNumbers[i + 1];
                
                // æœˆãƒ»æ—¥ã®å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
                if ((num1 >= 1 && num1 <= 12 && num2 >= 1 && num2 <= 31) ||
                    (num2 >= 1 && num2 <= 12 && num1 >= 1 && num1 <= 31)) {
                    
                    const month = num1 >= 1 && num1 <= 12 ? num1 : num2;
                    const day = num1 >= 1 && num1 <= 12 ? num2 : num1;
                    
                    const result = `${new Date().getFullYear()}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    console.log('æ•°å­—æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ:', result);
                    return result;
                }
            }
            
            console.log('æ•°å­—æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã§è§£æå¤±æ•—');
            return null;
        }
        
        // æ—¥ä»˜æ–‡å­—åˆ—æ§‹ç¯‰ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function buildDateString(match, type) {
            const currentYear = new Date().getFullYear();
            
            try {
                switch (type) {
                    case 'full':
                    case 'date_with_time':
                    case 'flexible_full':
                        const month = parseInt(match[1]);
                        const day = parseInt(match[2]);
                        const hour = parseInt(match[3]);
                        const minute = parseInt(match[4]);
                        
                        if (isValidDate(month, day) && isValidTime(hour, minute)) {
                            return `${currentYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        }
                        break;
                        
                    case 'date_with_day':
                    case 'date_only':
                    case 'flexible_date':
                        const monthOnly = parseInt(match[1]);
                        const dayOnly = parseInt(match[2]);
                        
                        if (isValidDate(monthOnly, dayOnly)) {
                            return `${currentYear}-${monthOnly.toString().padStart(2, '0')}-${dayOnly.toString().padStart(2, '0')}`;
                        }
                        break;
                        
                    case 'time_only':
                    case 'flexible_time':
                        const hourOnly = parseInt(match[1]);
                        const minuteOnly = parseInt(match[2]);
                        
                        if (isValidTime(hourOnly, minuteOnly)) {
                            const today = new Date();
                            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T${hourOnly.toString().padStart(2, '0')}:${minuteOnly.toString().padStart(2, '0')}`;
                        }
                        break;
                }
            } catch (error) {
                console.error('æ—¥ä»˜æ§‹ç¯‰ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            return null;
        }
        
        // æ—¥ä»˜æ¤œè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function isValidDate(month, day) {
            return month >= 1 && month <= 12 && day >= 1 && day <= 31;
        }
        
        // æ™‚åˆ»æ¤œè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function isValidTime(hour, minute) {
            return hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59;
        }
        
        // ãƒšã‚¢åŒ–ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatPairedTasks(pairedTasks) {
            return pairedTasks.map(task => {
                let line = task.title;
                if (task.deadline) {
                    line += ` ${task.deadline}`;
                }
                return line;
            }).join('\n');
        }
        
        // ç”»åƒå‰å‡¦ç†ã‚’é©ç”¨
        async function preprocessImage(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–ï¼ˆç©ã‚„ã‹ï¼‰
            if (document.getElementById('ocr-grayscale').checked) {
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                ctx.putImageData(imageData, 0, 0);
            }
            
            // ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–ï¼ˆç©ã‚„ã‹ãªäºŒå€¤åŒ–ï¼‰
            if (document.getElementById('ocr-enhance-contrast').checked) {
                const contrastImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const contrastData = contrastImageData.data;
                
                for (let i = 0; i < contrastData.length; i += 4) {
                    const gray = contrastData[i] * 0.299 + contrastData[i + 1] * 0.587 + contrastData[i + 2] * 0.114;
                    // ã‚ˆã‚Šç©ã‚„ã‹ãªé—¾å€¤ã§äºŒå€¤åŒ–
                    const threshold = 140; // 128ã‚ˆã‚Šé«˜ã‚ã«è¨­å®š
                    const value = gray > threshold ? 255 : 0;
                    contrastData[i] = contrastData[i + 1] = contrastData[i + 2] = value;
                }
                ctx.putImageData(contrastImageData, 0, 0);
            }
            
            // 2å€æ‹¡å¤§å‡¦ç†
            if (document.getElementById('ocr-upscale').checked) {
                const scaledCanvas = document.createElement('canvas');
                const scaledCtx = scaledCanvas.getContext('2d');
                scaledCanvas.width = canvas.width * 2;
                scaledCanvas.height = canvas.height * 2;
                
                // ã‚·ãƒ£ãƒ¼ãƒ—ãªæ‹¡å¤§
                scaledCtx.imageSmoothingEnabled = false;
                scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
                
                return scaledCanvas;
            }
            
            return canvas;
        }
        
        // GoogleTODOå½¢å¼ã®ã‚¿ã‚¹ã‚¯è§£æï¼ˆæœŸé™ä»˜ãã‚¿ã‚¹ã‚¯ã‚’åˆ†é›¢ï¼‰
        function parseGoogleTodoText(text) {
            // GoogleTODOã®æœŸé™å½¢å¼ãƒ‘ã‚¿ãƒ¼ãƒ³: mmæœˆddæ—¥(æ›œæ—¥), hh:mm
            // ä¾‹: "12æœˆ15æ—¥(æœˆ), 14:30" ã¾ãŸã¯ "12æœˆ15æ—¥ 14:30" ãªã©
            const dateTimePatterns = [
                // åŸºæœ¬å½¢å¼: mmæœˆddæ—¥(æ›œæ—¥), hh:mm
                /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*\([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]\)\s*,?\s*(\d{1,2}):(\d{2})/g,
                // æ›œæ—¥ãªã—: mmæœˆddæ—¥, hh:mm
                /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*,?\s*(\d{1,2}):(\d{2})/g,
                // æ™‚åˆ»ãªã—: mmæœˆddæ—¥(æ›œæ—¥)
                /(\d{1,2})æœˆ(\d{1,2})æ—¥\s*\([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]\)/g,
                // æ™‚åˆ»ãªã—æ›œæ—¥ãªã—: mmæœˆddæ—¥
                /(\d{1,2})æœˆ(\d{1,2})æ—¥/g,
                // è¥¿æš¦ä»˜ã: yyyyå¹´mmæœˆddæ—¥
                /(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/g
            ];
            
            const results = [];
            const lines = text.split('\n');
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                let taskTitle = trimmedLine;
                let deadline = null;
                let foundDate = false;
                
                // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒãƒƒãƒã‚’è©¦è¡Œ
                for (const pattern of dateTimePatterns) {
                    const matches = [...trimmedLine.matchAll(pattern)];
                    if (matches.length > 0) {
                        const match = matches[0];
                        foundDate = true;
                        
                        // æœŸé™æƒ…å ±ã‚’æŠ½å‡º
                        if (pattern.source.includes('å¹´')) {
                            // yyyyå¹´mmæœˆddæ—¥å½¢å¼
                            const year = match[1];
                            const month = match[2].padStart(2, '0');
                            const day = match[3].padStart(2, '0');
                            deadline = `${year}-${month}-${day}`;
                        } else if (match[3] && match[4]) {
                            // æ™‚åˆ»ä»˜ã
                            const month = match[1].padStart(2, '0');
                            const day = match[2].padStart(2, '0');
                            const hour = match[3].padStart(2, '0');
                            const minute = match[4].padStart(2, '0');
                            const currentYear = new Date().getFullYear();
                            deadline = `${currentYear}-${month}-${day}T${hour}:${minute}`;
                        } else {
                            // æ—¥ä»˜ã®ã¿
                            const month = match[1].padStart(2, '0');
                            const day = match[2].padStart(2, '0');
                            const currentYear = new Date().getFullYear();
                            deadline = `${currentYear}-${month}-${day}`;
                        }
                        
                        // æœŸé™éƒ¨åˆ†ã‚’ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é™¤å»
                        taskTitle = trimmedLine.replace(match[0], '').trim();
                        
                        // å‰å¾Œã®ä¸è¦ãªè¨˜å·ã‚’é™¤å»
                        taskTitle = taskTitle.replace(/^[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+|[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+$/g, '');
                        
                        break;
                    }
                }
                
                // æœŸé™ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ç°¡æ˜“ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ•°å­—ã®ã¿ã®æ™‚åˆ»ãªã©ï¼‰
                if (!foundDate) {
                    // å˜ç´”ãªæ™‚åˆ»ãƒ‘ã‚¿ãƒ¼ãƒ³: hh:mm
                    const timeMatch = taskTitle.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                        const hour = timeMatch[1].padStart(2, '0');
                        const minute = timeMatch[2].padStart(2, '0');
                        const today = new Date();
                        deadline = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T${hour}:${minute}`;
                        taskTitle = taskTitle.replace(timeMatch[0], '').trim();
                    }
                }
                
                // ç©ºã®ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¿ã‘ã‚‹
                if (taskTitle && taskTitle.length > 1) {
                    results.push({
                        title: taskTitle,
                        deadline: deadline,
                        hasDeadline: !!deadline,
                        originalLine: trimmedLine
                    });
                }
            });
            
            return results;
        }

        // OCRçµæœã®ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
        function postprocessOCRText(text) {
            let processed = text;
            
            // å›²ã¿æ•°å­—ã¯å¸¸ã«ä¿®æ­£ï¼ˆæ˜ã‚‰ã‹ãªèª¤èªè­˜ã®ãŸã‚ï¼‰
            const circledNumbers = {
                'â‘ ': '1', 'â‘¡': '2', 'â‘¢': '3', 'â‘£': '4', 'â‘¤': '5',
                'â‘¥': '6', 'â‘¦': '7', 'â‘§': '8', 'â‘¨': '9', 'â‘©': '10',
                'â‘ª': '11', 'â‘«': '12', 'â‘¬': '13', 'â‘­': '14', 'â‘®': '15',
                'â‘¯': '16', 'â‘°': '17', 'â‘±': '18', 'â‘²': '19', 'â‘³': '20',
                'â¶': '1', 'â·': '2', 'â¸': '3', 'â¹': '4', 'âº': '5',
                'â»': '6', 'â¼': '7', 'â½': '8', 'â¾': '9', 'â¿': '10',
                'â“ª': '0', 'â“«': '11', 'â“¬': '12', 'â“­': '13', 'â“®': '14',
                'â“¯': '15', 'â“°': '16', 'â“±': '17', 'â“²': '18', 'â“³': '19', 'â“´': '20'
            };
            
            // å›²ã¿æ•°å­—ã‚’é€šå¸¸ã®æ•°å­—ã«å¤‰æ›ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
            Object.keys(circledNumbers).forEach(circled => {
                const regex = new RegExp(circled, 'g');
                processed = processed.replace(regex, circledNumbers[circled]);
            });
            
            // ãã®ä»–ã®è¨˜å·ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            if (document.getElementById('ocr-cleanup-symbols').checked) {
                // å…¨è§’æ•°å­—â†’åŠè§’æ•°å­—
                processed = processed.replace(/[ï¼-ï¼™]/g, (match) => 
                    String.fromCharCode(match.charCodeAt(0) - 0xFEE0)
                );
                
                // æ˜ã‚‰ã‹ãªèª¤èªè­˜ã®ã¿ä¿®æ­£
                processed = processed
                    .replace(/\b[Oo]\.?\s*(?=\d)/g, '0') // O.æ•°å­— â†’ 0æ•°å­—
                    .replace(/\b[Il]\s*(?=\d)/g, '1') // Iæ•°å­— â†’ 1æ•°å­—
                    .replace(/\b[Il]\b/g, '1') // å˜ä½“ã®Iã‚„lâ†’ 1
                    // ä¸¸è¨˜å·ã®å¤‰æ›
                    .replace(/[â—‹â—¯â—Œâšª]/g, '0') // ç™½ä¸¸â†’ 0
                    .replace(/[â—â€¢âš«]/g, '1'); // é»’ä¸¸â†’ 1
            }
            
            return processed.trim();
        }
        
        async function performOCROnCanvas(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    // å‰å‡¦ç†ã‚’é©ç”¨
                    const processedCanvas = await preprocessImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            const { data: { text } } = await Tesseract.recognize(
                                blob,
                                'jpn+eng',
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                                    tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZã‚-ã‚–ã‚¢-ãƒ¶ä¸€-é¾¯!@#$%^&*()_+-=[]{}|;:,.<>?/~ ã€€ã€Œã€ã€ã€‚',
                                    preserve_interword_spaces: '1'
                                }
                            );
                            
                            // ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°ã‚’é©ç”¨
                            const processedText = postprocessOCRText(text);
                            resolve(processedText);
                        } catch (error) {
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // æœŸé™å°‚ç”¨OCRï¼ˆã‚ˆã‚Šå³å¯†ãªæ–‡å­—èªè­˜ï¼‰
        async function performDeadlineOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    // ã‚ˆã‚Šå³å¯†ãªå‰å‡¦ç†ï¼ˆæœŸé™ç”¨ï¼‰
                    const processedCanvas = await preprocessDeadlineImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            // æ—¥æœ¬èªå„ªå…ˆã®è¨­å®šã§OCRå®Ÿè¡Œ
                            const { data: { text } } = await Tesseract.recognize(
                                blob,
                                'jpn', // æ—¥æœ¬èªã®ã¿ã«å¤‰æ›´ï¼ˆè‹±èªæ··åœ¨ã‚’é¿ã‘ã‚‹ï¼‰
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE, // å˜ä¸€è¡Œãƒ¢ãƒ¼ãƒ‰
                                    // æ–‡å­—ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚’ä¸€æ™‚çš„ã«å¤–ã—ã¦å…¨æ–‡å­—èªè­˜
                                    preserve_interword_spaces: '1',
                                    tessedit_ocr_engine_mode: 3 // LSTM mode
                                }
                            );
                            
                            console.log('æœŸé™OCRç”Ÿã®çµæœ:', text);
                            
                            // æœŸé™å°‚ç”¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
                            const processedText = postprocessDeadlineText(text);
                            console.log('æœŸé™OCRå‡¦ç†å¾Œ:', processedText);
                            
                            resolve(processedText);
                        } catch (error) {
                            console.error('æœŸé™OCRã‚¨ãƒ©ãƒ¼:', error);
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // æœŸé™å°‚ç”¨å‰å‡¦ç†
        async function preprocessDeadlineImage(canvas) {
            const ctx = canvas.getContext('2d');
            
            // ç”»åƒã®å†…å®¹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            console.log('æœŸé™ç”»åƒã‚µã‚¤ã‚º:', canvas.width, 'x', canvas.height);
            
            // åè»¢æ¤œçŸ¥ï¼ˆé»’èƒŒæ™¯ã®å ´åˆï¼‰
            const sampleData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let blackPixels = 0;
            let totalPixels = sampleData.data.length / 4;
            
            for (let i = 0; i < sampleData.data.length; i += 4) {
                const gray = sampleData.data[i] * 0.299 + sampleData.data[i + 1] * 0.587 + sampleData.data[i + 2] * 0.114;
                if (gray < 128) blackPixels++;
            }
            
            const isInverted = blackPixels / totalPixels > 0.6;
            console.log('èƒŒæ™¯åˆ¤å®š:', isInverted ? 'é»’èƒŒæ™¯' : 'ç™½èƒŒæ™¯');
            
            // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ« + é©å¿œçš„äºŒå€¤åŒ–
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                
                // é»’èƒŒæ™¯ã®å ´åˆã¯è‰²ã‚’åè»¢
                let value;
                if (isInverted) {
                    value = gray < 128 ? 255 : 0;
                } else {
                    value = gray > 128 ? 255 : 0;
                }
                
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            ctx.putImageData(imageData, 0, 0);
            
            // 4å€æ‹¡å¤§ï¼ˆGoogle TODO ã®å°ã•ã„æœŸé™ãƒ†ã‚­ã‚¹ãƒˆç”¨ï¼‰
            const scaledCanvas = document.createElement('canvas');
            const scaledCtx = scaledCanvas.getContext('2d');
            scaledCanvas.width = canvas.width * 4;
            scaledCanvas.height = canvas.height * 4;
            
            // ãƒã‚¤ãƒªãƒ‹ã‚¢è£œé–“ã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šæ»‘ã‚‰ã‹ãªæ‹¡å¤§ï¼‰
            scaledCtx.imageSmoothingEnabled = true;
            scaledCtx.imageSmoothingQuality = 'high';
            scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
            
            // å†åº¦ã‚·ãƒ£ãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°
            const finalData = scaledCtx.getImageData(0, 0, scaledCanvas.width, scaledCanvas.height);
            const finalPixels = finalData.data;
            
            for (let i = 0; i < finalPixels.length; i += 4) {
                const gray = finalPixels[i];
                const sharpened = gray > 200 ? 255 : 0;
                finalPixels[i] = finalPixels[i + 1] = finalPixels[i + 2] = sharpened;
            }
            scaledCtx.putImageData(finalData, 0, 0);
            
            return scaledCanvas;
        }
        
        // æœŸé™å°‚ç”¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
        function postprocessDeadlineText(text) {
            let processed = text.trim();
            
            // å›²ã¿æ•°å­—ã‚’é€šå¸¸æ•°å­—ã«å¤‰æ›
            const circledNumbers = {
                'â‘ ': '1', 'â‘¡': '2', 'â‘¢': '3', 'â‘£': '4', 'â‘¤': '5',
                'â‘¥': '6', 'â‘¦': '7', 'â‘§': '8', 'â‘¨': '9', 'â‘©': '10',
                'â‘ª': '11', 'â‘«': '12', 'â‘¬': '13', 'â‘­': '14', 'â‘®': '15',
                'â‘¯': '16', 'â‘°': '17', 'â‘±': '18', 'â‘²': '19', 'â‘³': '20',
                'ã‰‘': '21', 'ã‰’': '22', 'ã‰“': '23', 'ã‰”': '24', 'ã‰•': '25',
                'ã‰–': '26', 'ã‰—': '27', 'ã‰˜': '28', 'ã‰™': '29', 'ã‰š': '30', 'ã‰›': '31'
            };
            
            Object.keys(circledNumbers).forEach(circled => {
                const regex = new RegExp(circled, 'g');
                processed = processed.replace(regex, circledNumbers[circled]);
            });
            
            // æœŸé™ç‰¹æœ‰ã®èª¤èªè­˜ã‚’ä¿®æ­£
            processed = processed
                .replace(/[oO]/g, '0') // o,O â†’ 0
                .replace(/[lI]/g, '1') // l,I â†’ 1
                .replace(/[S]/g, '5') // S â†’ 5
                .replace(/[Zz]/g, '2') // Z,z â†’ 2
                .replace(/[B]/g, '8') // B â†’ 8
                .replace(/[G]/g, '6') // G â†’ 6
                // å…¨è§’æ•°å­—ã‚’åŠè§’ã«
                .replace(/[ï¼-ï¼™]/g, (match) => 
                    String.fromCharCode(match.charCodeAt(0) - 0xFEE0)
                )
                // ä¸è¦ãªè¨˜å·ã‚’é™¤å»ï¼ˆæœŸé™ã«å¿…è¦ãªæ–‡å­—ä»¥å¤–ï¼‰
                .replace(/[^\dæœˆæ—¥\(\)ç«æ°´æœ¨é‡‘åœŸ,:\ ]/g, '')
                // è¤‡æ•°ã‚¹ãƒšãƒ¼ã‚¹ã‚’å˜ä¸€ã‚¹ãƒšãƒ¼ã‚¹ã«
                .replace(/\s+/g, ' ');
            
            return processed.trim();
        }
        
        // æ‰‹æ›¸ãæ–‡å­—å¯¾å¿œOCRï¼ˆé«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ï¼‰
        async function performHandwritingOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('æ‰‹æ›¸ãæ–‡å­—OCRé–‹å§‹:', canvas.width, 'x', canvas.height);
                    
                    // æ‰‹æ›¸ãå°‚ç”¨å‰å‡¦ç†
                    const processedCanvas = await preprocessHandwritingImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            // æ‰‹æ›¸ãæ–‡å­—ã«æœ€é©åŒ–ã•ã‚ŒãŸè¨­å®šã§OCRå®Ÿè¡Œ
                            const { data: { text, confidence } } = await Tesseract.recognize(
                                blob,
                                'jpn', // æ—¥æœ¬èªã®ã¿ã«ç‰¹åŒ–
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.AUTO, // è‡ªå‹•ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
                                    tessedit_ocr_engine_mode: 3, // LSTM Neural Network
                                    // æ‰‹æ›¸ãæ–‡å­—ç”¨ã®è¨­å®š
                                    tessedit_char_whitelist: '0123456789æœˆæ—¥ç«æ°´æœ¨é‡‘åœŸæ—¥(),:ï¼šã€€ ', // æœŸé™ã«å¿…è¦ãªæ–‡å­—ã®ã¿
                                    c_min_confidence: 30, // ä¿¡é ¼åº¦ã‚’ä¸‹ã’ã¦æ‰‹æ›¸ãã‚‚èªè­˜
                                    preserve_interword_spaces: '1',
                                    // æ‰‹æ›¸ãæ–‡å­—èªè­˜å¼·åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                                    textord_heavy_nr: '1',
                                    textord_min_linesize: '2.5',
                                    edges_max_children_per_outline: '40'
                                }
                            );
                            
                            console.log('æ‰‹æ›¸ãOCRçµæœ:', text);
                            console.log('æ‰‹æ›¸ãOCRä¿¡é ¼åº¦:', confidence);
                            
                            // æ‰‹æ›¸ãå°‚ç”¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
                            const processedText = postprocessHandwritingText(text);
                            console.log('æ‰‹æ›¸ãOCRå‡¦ç†å¾Œ:', processedText);
                            
                            resolve({ text: processedText, confidence: confidence });
                        } catch (error) {
                            console.error('æ‰‹æ›¸ãOCRã‚¨ãƒ©ãƒ¼:', error);
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // æ‰‹æ›¸ãæ–‡å­—å°‚ç”¨å‰å‡¦ç†
        async function preprocessHandwritingImage(canvas) {
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            newCanvas.width = canvas.width;
            newCanvas.height = canvas.height;
            
            ctx.drawImage(canvas, 0, 0);
            
            // æ‰‹æ›¸ãæ–‡å­—ç”¨ã®ç‰¹åˆ¥ãªå‰å‡¦ç†
            const imageData = ctx.getImageData(0, 0, newCanvas.width, newCanvas.height);
            const data = imageData.data;
            
            // 1. ã‚¨ãƒƒã‚¸å¼·åŒ–ï¼ˆæ‰‹æ›¸ãã®è–„ã„ç·šã‚’å¼·èª¿ï¼‰
            const edgeData = new Uint8ClampedArray(data);
            for (let y = 1; y < newCanvas.height - 1; y++) {
                for (let x = 1; x < newCanvas.width - 1; x++) {
                    const idx = (y * newCanvas.width + x) * 4;
                    
                    // å‘¨å›²ã®ãƒ”ã‚¯ã‚»ãƒ«ã¨ã®å·®åˆ†ã‚’è¨ˆç®—
                    const center = data[idx];
                    const top = data[((y-1) * newCanvas.width + x) * 4];
                    const bottom = data[((y+1) * newCanvas.width + x) * 4];
                    const left = data[(y * newCanvas.width + (x-1)) * 4];
                    const right = data[(y * newCanvas.width + (x+1)) * 4];
                    
                    const edge = Math.abs(center - top) + Math.abs(center - bottom) + 
                                Math.abs(center - left) + Math.abs(center - right);
                    
                    const enhanced = Math.min(255, center + edge * 0.3);
                    edgeData[idx] = edgeData[idx + 1] = edgeData[idx + 2] = enhanced;
                }
            }
            
            // 2. ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã§ãƒã‚¤ã‚ºé™¤å»
            const filtered = applyGaussianFilter(edgeData, newCanvas.width, newCanvas.height);
            
            // 3. é©å¿œçš„äºŒå€¤åŒ–ï¼ˆæ‰‹æ›¸ãã®æ¿ƒåº¦ãƒ ãƒ©ã«å¯¾å¿œï¼‰
            for (let i = 0; i < filtered.length; i += 4) {
                const gray = filtered[i];
                // æ‰‹æ›¸ãæ–‡å­—ç”¨ã®é–¾å€¤èª¿æ•´
                const threshold = 140; // æ‰‹æ›¸ãã¯é€šå¸¸ã‚ˆã‚Šä½ã„é–¾å€¤
                const value = gray > threshold ? 255 : 0;
                filtered[i] = filtered[i + 1] = filtered[i + 2] = value;
            }
            
            const processedImageData = new ImageData(filtered, newCanvas.width, newCanvas.height);
            ctx.putImageData(processedImageData, 0, 0);
            
            // 4. æ‹¡å¤§å‡¦ç†ï¼ˆæ‰‹æ›¸ãã®ç´°ã‹ã„ç‰¹å¾´ã‚’ä¿æŒï¼‰
            const scaledCanvas = document.createElement('canvas');
            const scaledCtx = scaledCanvas.getContext('2d');
            scaledCanvas.width = newCanvas.width * 3;
            scaledCanvas.height = newCanvas.height * 3;
            
            scaledCtx.imageSmoothingEnabled = false; // æ‰‹æ›¸ãã®ç‰¹å¾´ã‚’ä¿æŒ
            scaledCtx.drawImage(newCanvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
            
            return scaledCanvas;
        }
        
        // ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆãƒã‚¤ã‚ºé™¤å»ç”¨ï¼‰
        function applyGaussianFilter(data, width, height) {
            const filtered = new Uint8ClampedArray(data.length);
            const kernel = [1, 2, 1, 2, 4, 2, 1, 2, 1]; // 3x3ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ«
            const kernelSum = 16;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    let sum = 0;
                    
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixelIdx = ((y + ky) * width + (x + kx)) * 4;
                            const kernelIdx = (ky + 1) * 3 + (kx + 1);
                            sum += data[pixelIdx] * kernel[kernelIdx];
                        }
                    }
                    
                    const filteredValue = sum / kernelSum;
                    filtered[idx] = filtered[idx + 1] = filtered[idx + 2] = filteredValue;
                    filtered[idx + 3] = 255; // Alpha
                }
            }
            
            return filtered;
        }
        
        // æ‰‹æ›¸ãæ–‡å­—å°‚ç”¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°
        function postprocessHandwritingText(text) {
            let processed = text.trim();
            
            // æ‰‹æ›¸ãæ–‡å­—ç‰¹æœ‰ã®èª¤èªè­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¿®æ­£
            const handwritingCorrections = {
                // æ•°å­—ã®èª¤èªè­˜
                'o': '0', 'O': '0', 'ã€‡': '0', 'â—‹': '0',
                'l': '1', 'I': '1', '|': '1', 'ï½œ': '1',
                'Z': '2', 'z': '2', 'ã‚¢': '2',
                'ã‚´': '5', 'S': '5', 's': '5',
                'b': '6', 'G': '6', 'ãƒ­': '6',
                'T': '7', '7': '7', 'ï¼Ÿ': '7',
                'B': '8', '8': '8', 'ãŠ': '8',
                'g': '9', 'q': '9', 'ã‚Š': '9',
                
                // æ›œæ—¥ã®èª¤èªè­˜
                'ç«æ›œ': 'ç«', 'æ°´æ›œ': 'æ°´', 'æœ¨æ›œ': 'æœ¨', 'é‡‘æ›œ': 'é‡‘', 'åœŸæ›œ': 'åœŸ', 'æ—¥æ›œ': 'æ—¥', 'æœˆæ›œ': 'æœˆ',
                'ã²': 'ç«', 'ã¿': 'æ°´', 'ã': 'æœ¨', 'ãã‚“': 'é‡‘', 'ã©': 'åœŸ', 'ã«ã¡': 'æ—¥', 'ã’ã¤': 'æœˆ',
                
                // è¨˜å·ã®èª¤èªè­˜
                'ï¼š': ':', 'ã€‚': ',', 'ã€': ',', 'ï½': '',
                'ï¼': '/', 'ï¼¼': '\\', 'ï¼»': '(', 'ï¼½': ')'
            };
            
            // èª¤èªè­˜ä¿®æ­£ã‚’é©ç”¨
            Object.keys(handwritingCorrections).forEach(wrong => {
                const regex = new RegExp(wrong, 'g');
                processed = processed.replace(regex, handwritingCorrections[wrong]);
            });
            
            // æ‰‹æ›¸ããƒã‚¤ã‚ºã®é™¤å»
            processed = processed
                .replace(/[^\dæœˆæ—¥\(\)æœˆç«æ°´æœ¨é‡‘åœŸæ—¥,:ï¼šã€€ ]/g, '') // æœŸé™ã«å¿…è¦ãªæ–‡å­—ä»¥å¤–ã‚’é™¤å»
                .replace(/\s+/g, ' ') // é€£ç¶šç©ºç™½ã‚’1ã¤ã«
                .trim();
            
            console.log('æ‰‹æ›¸ãæ–‡å­—ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°:', processed);
            return processed;
        }
        
        // OCRè¨­å®šãƒªã‚»ãƒƒãƒˆ
        function resetOCRSettings() {
            document.getElementById('ocr-enhance-contrast').checked = false;
            document.getElementById('ocr-upscale').checked = false;
            document.getElementById('ocr-grayscale').checked = false;
            document.getElementById('ocr-cleanup-symbols').checked = false;
            document.getElementById('ocr-handwriting-mode').checked = false;
            document.getElementById('ocr-complex-layout-mode').checked = false;
        }
        
        // è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testComplexLayoutOCR() {
            if (selectedAreas.length === 0) {
                alert('OCRå¯¾è±¡ã®é ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆç”¨ã®é ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('=== è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            for (let i = 0; i < selectedAreas.length; i++) {
                const area = selectedAreas[i];
                console.log(`\nğŸ§© è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé ˜åŸŸ ${i + 1} ãƒ†ã‚¹ãƒˆ:`);
                
                // é ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    // è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRå®Ÿè¡Œ
                    const complexResult = await performComplexLayoutOCR(croppedCanvas);
                    console.log('ğŸ§© è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRçµæœ:', complexResult);
                    
                    // æ¯”è¼ƒç”¨ã«é€šå¸¸OCRã‚‚å®Ÿè¡Œ
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('ğŸ“„ é€šå¸¸OCRçµæœ:', normalText);
                    
                    // çµæœæ¯”è¼ƒ
                    console.log(`\nğŸ“Š çµæœæ¯”è¼ƒ:`);
                    console.log(`è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰: "${complexResult.text}" (ã‚¿ã‚¤ãƒ—: ${complexResult.type}, ä¿¡é ¼åº¦: ${complexResult.confidence?.toFixed(1)}%)`);
                    console.log(`é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: "${normalText}"`);
                    
                    // æ§‹é€ è§£æçµæœï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
                    if (complexResult.structure) {
                        console.log('ğŸ“ æ§‹é€ è§£æ:', complexResult.structure);
                    }
                    
                } catch (error) {
                    console.error('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            console.log('\n=== è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRãƒ†ã‚¹ãƒˆçµ‚äº† ===');
            alert('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãªçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // æ‰‹æ›¸ãOCRãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testHandwritingOCR() {
            const handwritingAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (handwritingAreas.length === 0) {
                alert('æœŸé™ã‚¿ã‚°ãŒè¨­å®šã•ã‚ŒãŸé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ‰‹æ›¸ããƒ†ã‚¹ãƒˆç”¨ã®é ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('=== æ‰‹æ›¸ãOCRãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            for (let i = 0; i < handwritingAreas.length; i++) {
                const area = handwritingAreas[i];
                console.log(`\nâœï¸ æ‰‹æ›¸ãé ˜åŸŸ ${i + 1} ãƒ†ã‚¹ãƒˆ:`);
                
                // é ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    // æ‰‹æ›¸ãOCRå®Ÿè¡Œ
                    const handwritingResult = await performHandwritingOCR(croppedCanvas);
                    console.log('âœï¸ æ‰‹æ›¸ãOCRçµæœ:', handwritingResult.text);
                    console.log('ğŸ¯ æ‰‹æ›¸ãOCRä¿¡é ¼åº¦:', handwritingResult.confidence);
                    console.log('ğŸ“… æœŸé™è§£æçµæœ:', parseDeadlineText(handwritingResult.text));
                    
                    // æ¯”è¼ƒç”¨ã«é€šå¸¸OCRã‚‚å®Ÿè¡Œ
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('ğŸ“„ é€šå¸¸OCRçµæœ:', normalText);
                    console.log('ğŸ“… é€šå¸¸OCRæœŸé™è§£æ:', parseDeadlineText(normalText));
                    
                    // ç²¾åº¦æ¯”è¼ƒ
                    const handwritingSuccess = parseDeadlineText(handwritingResult.text) !== null;
                    const normalSuccess = parseDeadlineText(normalText) !== null;
                    
                    console.log(`\nğŸ“Š çµæœæ¯”è¼ƒ:`);
                    console.log(`æ‰‹æ›¸ããƒ¢ãƒ¼ãƒ‰: ${handwritingSuccess ? 'æˆåŠŸ âœ…' : 'å¤±æ•— âŒ'} (ä¿¡é ¼åº¦: ${handwritingResult.confidence}%)`);
                    console.log(`é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ${normalSuccess ? 'æˆåŠŸ âœ…' : 'å¤±æ•— âŒ'}`);
                    
                } catch (error) {
                    console.error('æ‰‹æ›¸ãOCRã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            console.log('\n=== æ‰‹æ›¸ãOCRãƒ†ã‚¹ãƒˆçµ‚äº† ===');
            alert('æ‰‹æ›¸ãOCRãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãªçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè§£æOCRï¼ˆè¡¨ãƒ»å›³å¯¾å¿œï¼‰
        async function performComplexLayoutOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRé–‹å§‹:', canvas.width, 'x', canvas.height);
                    
                    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè‡ªå‹•æ¤œå‡º
                    const layoutType = detectLayoutType(canvas);
                    console.log('æ¤œå‡ºã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:', layoutType);
                    
                    let result;
                    switch (layoutType) {
                        case 'table':
                            result = await performTableOCR(canvas);
                            break;
                        case 'list':
                            result = await performListOCR(canvas);
                            break;
                        case 'form':
                            result = await performFormOCR(canvas);
                            break;
                        default:
                            result = await performAdvancedOCR(canvas);
                    }
                    
                    console.log('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRçµæœ:', result);
                    resolve(result);
                    
                } catch (error) {
                    console.error('è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆOCRã‚¨ãƒ©ãƒ¼:', error);
                    reject(error);
                }
            });
        }
        
        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¿ã‚¤ãƒ—è‡ªå‹•æ¤œå‡º
        function detectLayoutType(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // ç·šã®æ¤œå‡ºï¼ˆç¸¦ç·šãƒ»æ¨ªç·šã®å¤šã•ã§åˆ¤å®šï¼‰
            let horizontalLines = 0;
            let verticalLines = 0;
            
            // æ¨ªç·šæ¤œå‡º
            for (let y = 0; y < canvas.height; y += 5) {
                let linePixels = 0;
                for (let x = 0; x < canvas.width; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    const gray = data[idx] * 0.299 + data[idx + 1] * 0.587 + data[idx + 2] * 0.114;
                    if (gray < 128) linePixels++;
                }
                if (linePixels > canvas.width * 0.7) horizontalLines++;
            }
            
            // ç¸¦ç·šæ¤œå‡º
            for (let x = 0; x < canvas.width; x += 5) {
                let linePixels = 0;
                for (let y = 0; y < canvas.height; y++) {
                    const idx = (y * canvas.width + x) * 4;
                    const gray = data[idx] * 0.299 + data[idx + 1] * 0.587 + data[idx + 2] * 0.114;
                    if (gray < 128) linePixels++;
                }
                if (linePixels > canvas.height * 0.7) verticalLines++;
            }
            
            console.log(`ç·šæ¤œå‡ºçµæœ: æ¨ªç·š=${horizontalLines}, ç¸¦ç·š=${verticalLines}`);
            
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ¤å®š
            if (horizontalLines >= 3 && verticalLines >= 2) {
                return 'table'; // è¡¨å½¢å¼
            } else if (horizontalLines >= 3) {
                return 'list'; // ãƒªã‚¹ãƒˆå½¢å¼
            } else if (verticalLines >= 2) {
                return 'form'; // ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼
            } else {
                return 'mixed'; // æ··åˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
            }
        }
        
        // è¡¨å½¢å¼OCR
        async function performTableOCR(canvas) {
            console.log('è¡¨å½¢å¼OCRå®Ÿè¡Œä¸­...');
            
            // ã‚»ãƒ«å˜ä½ã«åˆ†å‰²ã—ã¦OCRå®Ÿè¡Œ
            const cells = detectTableCells(canvas);
            const results = [];
            
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                const cellCanvas = extractCellCanvas(canvas, cell);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        cellCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                            tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZã‚-ã‚–ã‚¢-ãƒ¶ä¸€-é¾¯(),:ï¼šæœˆæ—¥ç«æ°´æœ¨é‡‘åœŸæ—¥ ã€€',
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        row: cell.row,
                        col: cell.col,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`ã‚»ãƒ«[${cell.row},${cell.col}]ã®OCRã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            return formatTableResults(results);
        }
        
        // ãƒªã‚¹ãƒˆå½¢å¼OCR
        async function performListOCR(canvas) {
            console.log('ãƒªã‚¹ãƒˆå½¢å¼OCRå®Ÿè¡Œä¸­...');
            
            // è¡Œå˜ä½ã«åˆ†å‰²
            const lines = detectListLines(canvas);
            const results = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lineCanvas = extractLineCanvas(canvas, line);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        lineCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        line: i + 1,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`è¡Œ${i + 1}ã®OCRã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            return formatListResults(results);
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼OCR
        async function performFormOCR(canvas) {
            console.log('ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼OCRå®Ÿè¡Œä¸­...');
            
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å˜ä½ã«åˆ†å‰²
            const fields = detectFormFields(canvas);
            const results = [];
            
            for (let i = 0; i < fields.length; i++) {
                const field = fields[i];
                const fieldCanvas = extractFieldCanvas(canvas, field);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        fieldCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        field: field.label || `ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰${i + 1}`,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰${i + 1}ã®OCRã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            return formatFormResults(results);
        }
        
        // é«˜åº¦OCRï¼ˆæ··åˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
        async function performAdvancedOCR(canvas) {
            console.log('é«˜åº¦OCRå®Ÿè¡Œä¸­...');
            
            try {
                const { data: { text, confidence, lines, words } } = await Tesseract.recognize(
                    canvas,
                    'jpn+eng',
                    {
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                        tessedit_ocr_engine_mode: 3, // LSTM
                        preserve_interword_spaces: '1',
                        // è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨è¨­å®š
                        textord_heavy_nr: '1',
                        textord_tabfind_show_vlines: '1',
                        textord_tablefind_good_width: '3',
                        textord_tablefind_good_height: '3'
                    }
                );
                
                return {
                    type: 'advanced',
                    text: text,
                    confidence: confidence,
                    structure: analyzeTextStructure(lines, words)
                };
            } catch (error) {
                console.error('é«˜åº¦OCRã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }
        
        // è¡¨ã‚»ãƒ«æ¤œå‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function detectTableCells(canvas) {
            // å®Ÿè£…ç°¡ç•¥åŒ– - å®Ÿéš›ã¯ç”»åƒè§£æã§ç½«ç·šã‚’æ¤œå‡º
            const cells = [];
            const rows = 3, cols = 3; // ä»®ã®3x3è¡¨
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    cells.push({
                        row: r,
                        col: c,
                        x: (canvas.width / cols) * c,
                        y: (canvas.height / rows) * r,
                        width: canvas.width / cols,
                        height: canvas.height / rows
                    });
                }
            }
            
            return cells;
        }
        
        // ãƒªã‚¹ãƒˆè¡Œæ¤œå‡º
        function detectListLines(canvas) {
            const lines = [];
            const lineHeight = canvas.height / 5; // ä»®ã«5è¡Œ
            
            for (let i = 0; i < 5; i++) {
                lines.push({
                    x: 0,
                    y: lineHeight * i,
                    width: canvas.width,
                    height: lineHeight
                });
            }
            
            return lines;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œå‡º
        function detectFormFields(canvas) {
            const fields = [];
            const fieldHeight = canvas.height / 3;
            
            for (let i = 0; i < 3; i++) {
                fields.push({
                    label: `ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰${i + 1}`,
                    x: 0,
                    y: fieldHeight * i,
                    width: canvas.width,
                    height: fieldHeight
                });
            }
            
            return fields;
        }
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹æŠ½å‡ºé–¢æ•°ç¾¤
        function extractCellCanvas(canvas, cell) {
            const cellCanvas = document.createElement('canvas');
            const ctx = cellCanvas.getContext('2d');
            cellCanvas.width = cell.width;
            cellCanvas.height = cell.height;
            ctx.drawImage(canvas, cell.x, cell.y, cell.width, cell.height, 0, 0, cell.width, cell.height);
            return cellCanvas;
        }
        
        function extractLineCanvas(canvas, line) {
            const lineCanvas = document.createElement('canvas');
            const ctx = lineCanvas.getContext('2d');
            lineCanvas.width = line.width;
            lineCanvas.height = line.height;
            ctx.drawImage(canvas, line.x, line.y, line.width, line.height, 0, 0, line.width, line.height);
            return lineCanvas;
        }
        
        function extractFieldCanvas(canvas, field) {
            const fieldCanvas = document.createElement('canvas');
            const ctx = fieldCanvas.getContext('2d');
            fieldCanvas.width = field.width;
            fieldCanvas.height = field.height;
            ctx.drawImage(canvas, field.x, field.y, field.width, field.height, 0, 0, field.width, field.height);
            return fieldCanvas;
        }
        
        // çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ç¾¤
        function formatTableResults(results) {
            let formatted = 'ã€è¡¨å½¢å¼ãƒ‡ãƒ¼ã‚¿ã€‘\n';
            const maxRow = Math.max(...results.map(r => r.row));
            const maxCol = Math.max(...results.map(r => r.col));
            
            for (let r = 0; r <= maxRow; r++) {
                const rowData = [];
                for (let c = 0; c <= maxCol; c++) {
                    const cell = results.find(result => result.row === r && result.col === c);
                    rowData.push(cell ? cell.text : '');
                }
                formatted += rowData.join(' | ') + '\n';
            }
            
            return { type: 'table', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        function formatListResults(results) {
            let formatted = 'ã€ãƒªã‚¹ãƒˆå½¢å¼ãƒ‡ãƒ¼ã‚¿ã€‘\n';
            results.forEach(result => {
                formatted += `â€¢ ${result.text}\n`;
            });
            
            return { type: 'list', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        function formatFormResults(results) {
            let formatted = 'ã€ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼ãƒ‡ãƒ¼ã‚¿ã€‘\n';
            results.forEach(result => {
                formatted += `${result.field}: ${result.text}\n`;
            });
            
            return { type: 'form', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆæ§‹é€ è§£æ
        function analyzeTextStructure(lines, words) {
            return {
                lineCount: lines ? lines.length : 0,
                wordCount: words ? words.length : 0,
                avgConfidence: words ? words.reduce((sum, w) => sum + w.confidence, 0) / words.length : 0
            };
        }
        
        // æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        async function deepDeadlineDebug() {
            const deadlineAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (deadlineAreas.length === 0) {
                alert('æœŸé™ã‚¿ã‚°ãŒè¨­å®šã•ã‚ŒãŸé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœŸé™é ˜åŸŸã‚’é¸æŠã—ã¦ãƒ‡ãƒãƒƒã‚°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('ğŸ”¬=== æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===');
            
            for (let i = 0; i < deadlineAreas.length; i++) {
                const area = deadlineAreas[i];
                console.log(`\nğŸ¯ æœŸé™é ˜åŸŸ ${i + 1} è©³ç´°è§£æ:`);
                
                // é ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    console.log('ğŸ“ é ˜åŸŸæƒ…å ±:', { width: area.width, height: area.height, x: area.x, y: area.y });
                    
                    // 1. å…¨ç¨®é¡ã®OCRã‚’å®Ÿè¡Œã—ã¦æ¯”è¼ƒ
                    console.log('\nğŸ” å„ç¨®OCRçµæœæ¯”è¼ƒ:');
                    
                    // é€šå¸¸OCR
                    const normalResult = await performOCROnCanvas(croppedCanvas);
                    console.log('ğŸ“„ é€šå¸¸OCR:', normalResult);
                    console.log('ğŸ“… é€šå¸¸OCRæœŸé™è§£æ:', parseDeadlineText(normalResult));
                    
                    // æœŸé™å°‚ç”¨OCR  
                    const deadlineResult = await performDeadlineOCR(croppedCanvas);
                    console.log('â° æœŸé™å°‚ç”¨OCR:', deadlineResult);
                    console.log('ğŸ“… æœŸé™å°‚ç”¨OCRæœŸé™è§£æ:', parseDeadlineText(deadlineResult));
                    
                    // æ‰‹æ›¸ãOCR
                    try {
                        const handwritingResult = await performHandwritingOCR(croppedCanvas);
                        console.log('âœï¸ æ‰‹æ›¸ãOCR:', handwritingResult.text, `(ä¿¡é ¼åº¦: ${handwritingResult.confidence}%)`);
                        console.log('ğŸ“… æ‰‹æ›¸ãOCRæœŸé™è§£æ:', parseDeadlineText(handwritingResult.text));
                    } catch (error) {
                        console.log('âœï¸ æ‰‹æ›¸ãOCRã‚¨ãƒ©ãƒ¼:', error.message);
                    }
                    
                    // 2. çµ¶å¯¾å‚ç…§å¤‰æ›ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ç¢ºèª
                    console.log('\nğŸ”„ çµ¶å¯¾å‚ç…§å¤‰æ›è©³ç´°:');
                    console.log('ç”ŸOCRçµæœ:', normalResult);
                    const convertedText = convertToAbsoluteReference(normalResult);
                    console.log('çµ¶å¯¾å‚ç…§å¤‰æ›å¾Œ:', convertedText);
                    const parseResult = parseDeadlineText(normalResult);
                    console.log('æœ€çµ‚è§£æçµæœ:', parseResult);
                    
                    // 3. ç”»åƒè§£æï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ»ãƒã‚¤ã‚ºçŠ¶æ³ï¼‰
                    console.log('\nğŸ–¼ï¸ ç”»åƒå“è³ªè§£æ:');
                    const imageStats = analyzeImageQuality(croppedCanvas);
                    console.log('ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ:', imageStats.contrast);
                    console.log('ãƒã‚¤ã‚ºãƒ¬ãƒ™ãƒ«:', imageStats.noise);
                    console.log('æ–‡å­—å¯†åº¦:', imageStats.textDensity);
                    
                    // 4. æ¨å¥¨æ”¹å–„æ–¹æ³•
                    console.log('\nğŸ’¡ æ¨å¥¨æ”¹å–„æ–¹æ³•:');
                    const recommendations = getDeadlineRecommendations(normalResult, deadlineResult, imageStats);
                    recommendations.forEach(rec => console.log(`- ${rec}`));
                    
                } catch (error) {
                    console.error('æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            console.log('\nğŸ”¬=== æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°çµ‚äº† ===');
            alert('æœŸé™è©³ç´°ãƒ‡ãƒãƒƒã‚°ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãªè§£æçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ç”»åƒå“è³ªè§£æ
        function analyzeImageQuality(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let minBrightness = 255;
            let maxBrightness = 0;
            let totalBrightness = 0;
            let darkPixels = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                minBrightness = Math.min(minBrightness, brightness);
                maxBrightness = Math.max(maxBrightness, brightness);
                totalBrightness += brightness;
                
                if (brightness < 128) darkPixels++;
            }
            
            const totalPixels = data.length / 4;
            const avgBrightness = totalBrightness / totalPixels;
            const contrast = maxBrightness - minBrightness;
            const textDensity = darkPixels / totalPixels;
            
            // ãƒã‚¤ã‚ºãƒ¬ãƒ™ãƒ«æ¨å®šï¼ˆéš£æ¥ãƒ”ã‚¯ã‚»ãƒ«é–“ã®å·®åˆ†ï¼‰
            let noiseSum = 0;
            let noiseCount = 0;
            for (let y = 1; y < canvas.height - 1; y++) {
                for (let x = 1; x < canvas.width - 1; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    const current = data[idx];
                    const right = data[idx + 4];
                    const bottom = data[idx + canvas.width * 4];
                    
                    noiseSum += Math.abs(current - right) + Math.abs(current - bottom);
                    noiseCount += 2;
                }
            }
            const noise = noiseSum / noiseCount;
            
            return {
                contrast: contrast,
                noise: noise,
                textDensity: textDensity,
                avgBrightness: avgBrightness
            };
        }
        
        // ãƒ‡ãƒãƒƒã‚°çµæœã«åŸºã¥ãæ¨å¥¨äº‹é …
        function getDeadlineRecommendations(normalOCR, deadlineOCR, imageStats) {
            const recommendations = [];
            
            // OCRçµæœåˆ†æ
            if (!normalOCR || normalOCR.trim().length === 0) {
                recommendations.push('é€šå¸¸OCRã§æ–‡å­—ãŒèªè­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–ãƒ»æ‹¡å¤§å‡¦ç†ã‚’è©¦ã—ã¦ãã ã•ã„');
            }
            
            if (!deadlineOCR || deadlineOCR.trim().length === 0) {
                recommendations.push('æœŸé™å°‚ç”¨OCRã§ã‚‚èªè­˜å¤±æ•—ã€‚æ‰‹æ›¸ããƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯è¤‡é›‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’è©¦ã—ã¦ãã ã•ã„');
            }
            
            if (!parseDeadlineText(normalOCR) && !parseDeadlineText(deadlineOCR)) {
                recommendations.push('æœŸé™ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã—ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:');
                recommendations.push('  - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: mmæœˆddæ—¥(æ›œæ—¥), hh:mm');
                recommendations.push('  - å›²ã¿æ•°å­—: â‘ â‘¡â‘¢ â†’ 123 å¤‰æ›ãŒå¿…è¦ã‹');
                recommendations.push('  - ãƒã‚¤ã‚º: æ ç·šã‚„èƒŒæ™¯ãŒæ··å…¥ã—ã¦ã„ãªã„ã‹');
            }
            
            // ç”»åƒå“è³ªåˆ†æ
            if (imageStats.contrast < 100) {
                recommendations.push('ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãŒä½ã„ã§ã™ã€‚ã€Œã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–ã€è¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
            }
            
            if (imageStats.noise > 20) {
                recommendations.push('ãƒã‚¤ã‚ºãŒå¤šã„ã§ã™ã€‚ã€Œã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–ã€è¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
            }
            
            if (imageStats.textDensity < 0.1) {
                recommendations.push('æ–‡å­—å¯†åº¦ãŒä½ã„ã§ã™ã€‚é ˜åŸŸé¸æŠã‚’æ–‡å­—éƒ¨åˆ†ã®ã¿ã«çµã£ã¦ãã ã•ã„');
            }
            
            if (imageStats.textDensity > 0.8) {
                recommendations.push('èƒŒæ™¯ãŒæš—ã™ãã¾ã™ã€‚é ˜åŸŸé¸æŠæ™‚ã«ä½™ç™½ã‚‚å«ã‚ã¦ãã ã•ã„');
            }
            
            // å…·ä½“çš„ãªå¯¾å‡¦æ³•
            recommendations.push('ã€æ¨å¥¨é †åºã€‘');
            recommendations.push('1. é ˜åŸŸé¸æŠã‚’æœŸé™æ–‡å­—éƒ¨åˆ†ã®ã¿ã«èª¿æ•´');
            recommendations.push('2. æ‰‹æ›¸ãæ–‡å­—ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–');
            recommendations.push('3. ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ– + 2å€æ‹¡å¤§å‡¦ç†ã‚’æœ‰åŠ¹åŒ–');
            recommendations.push('4. ãã‚Œã§ã‚‚å¤±æ•—ã™ã‚‹å ´åˆã¯ç”»åƒè‡ªä½“ã®æ’®å½±ãƒ»åˆ‡ã‚Šå–ã‚Šã‚’è¦‹ç›´ã—');
            
            return recommendations;
        }
        
        // æœŸé™è§£æãƒ†ã‚¹ãƒˆ
        function testDeadlineParsing() {
            const testTexts = [
                // æ¨™æº–GoogleTODOãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                '12æœˆ15æ—¥(æœˆ), 14:30',
                '12æœˆ15æ—¥(æœˆ)',
                '12æœˆ15æ—¥, 14:30',
                '12æœˆ15æ—¥',
                
                // å›²ã¿æ•°å­—ãƒ†ã‚¹ãƒˆï¼ˆGoogleTODOç‰¹æœ‰ï¼‰
                'â‘¢æœˆâ‘¡â‘¤æ—¥(æœ¨), â‘ â‘£:â‘¢â“ª',
                'â‘ â‘¡æœˆâ‘¢â“ªæ—¥(é‡‘), â‘¡â‘¢:â‘¤â‘¨',
                'â‘«æœˆã‰›æ—¥(æ—¥), â“ªâ‘¨:â‘¢â“ª',
                
                // å…¨è§’æ•°å­—ãƒ†ã‚¹ãƒˆ
                'ï¼‘ï¼’æœˆï¼‘ï¼•æ—¥(æœˆ), ï¼‘ï¼”:ï¼“ï¼',
                'ï¼ï¼“æœˆï¼ï¼—æ—¥(æ°´)',
                
                // ãƒã‚¤ã‚ºæ··å…¥ãƒ†ã‚¹ãƒˆï¼ˆæ ç·šãƒ»è¨˜å·ï¼‰
                '|12æœˆ15æ—¥(æœˆ), 14:30|',
                'â–¡12æœˆ15æ—¥(æœˆ)â– ',
                'ï½12æœˆ15æ—¥(æœˆ), 14:30ï½',
                'ãƒã‚¤ã‚ºï½œ12æœˆ15æ—¥(æœˆ), 14:30ï½œãƒã‚¤ã‚º',
                
                // è¤‡é›‘ãªãƒã‚¤ã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³
                'ï½œâ–¡â‘¢æœˆâ‘¡â‘¤æ—¥(æœ¨)â– ï½, â‘ â‘£:â‘¢â“ªï½œ',
                'èªè­˜ã‚¨ãƒ©ãƒ¼ï¼‘ï¼’æœˆï¼‘ï¼•æ—¥(æœˆæ›œæ—¥), ï¼‘ï¼”:ï¼“ï¼èª¤èªè­˜',
                
                // ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
                '14:30', // æ™‚åˆ»ã®ã¿
                'ç„¡åŠ¹ãªæœŸé™ãƒ†ã‚­ã‚¹ãƒˆ',
                ''
            ];
            
            console.log('=== GoogleTODOæœŸé™è§£æãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            testTexts.forEach((text, index) => {
                console.log(`\nğŸ“ ãƒ†ã‚¹ãƒˆ ${index + 1}: "${text}"`);
                
                // çµ¶å¯¾å‚ç…§å¤‰æ›ã®ãƒ†ã‚¹ãƒˆ
                const converted = convertToAbsoluteReference(text);
                console.log(`ğŸ”„ çµ¶å¯¾å‚ç…§å¤‰æ›: "${converted}"`);
                
                // æœŸé™è§£æã®ãƒ†ã‚¹ãƒˆ
                const result = parseDeadlineText(text);
                console.log(`ğŸ“… è§£æçµæœ: ${result}`);
                console.log(`âœ… æˆåŠŸ: ${result ? 'â—‹' : 'Ã—'}`);
            });
            console.log('=== GoogleTODOæœŸé™è§£æãƒ†ã‚¹ãƒˆçµ‚äº† ===');
            
            alert('æœŸé™è§£æãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ç›´æ¥OCRãƒ†ã‚¹ãƒˆï¼ˆé¸æŠã—ãŸæœŸé™é ˜åŸŸã§ï¼‰
        async function testOCRDirectly() {
            const deadlineAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (deadlineAreas.length === 0) {
                alert('æœŸé™ã‚¿ã‚°ãŒè¨­å®šã•ã‚ŒãŸé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            console.log('=== æœŸé™é ˜åŸŸOCRãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            for (let i = 0; i < deadlineAreas.length; i++) {
                const area = deadlineAreas[i];
                console.log(`\næœŸé™é ˜åŸŸ ${i + 1} ãƒ†ã‚¹ãƒˆ:`);
                
                // é ˜åŸŸã‚’åˆ‡ã‚ŠæŠœã
                const croppedCanvas = document.createElement('canvas');
                const croppedCtx = croppedCanvas.getContext('2d');
                
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                croppedCtx.drawImage(
                    currentImage,
                    area.x, area.y, area.width, area.height,
                    0, 0, area.width, area.height
                );
                
                try {
                    // æœŸé™ç”¨OCR
                    const deadlineText = await performDeadlineOCR(croppedCanvas);
                    console.log('æœŸé™ç”¨OCRçµæœ:', deadlineText);
                    console.log('æœŸé™è§£æçµæœ:', parseDeadlineText(deadlineText));
                    
                    // é€šå¸¸OCR
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('é€šå¸¸OCRçµæœ:', normalText);
                    console.log('æœŸé™è§£æçµæœ:', parseDeadlineText(normalText));
                } catch (error) {
                    console.error('OCRã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            console.log('\n=== æœŸé™é ˜åŸŸOCRãƒ†ã‚¹ãƒˆçµ‚äº† ===');
            alert('æœŸé™é ˜åŸŸã®OCRãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        // å‡¦ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€åˆã®é¸æŠé ˜åŸŸã§ãƒ†ã‚¹ãƒˆï¼‰
        function previewProcessing() {
            if (selectedAreas.length === 0) {
                alert('é¸æŠé ˜åŸŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšé ˜åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const area = selectedAreas[0];
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            
            croppedCanvas.width = area.width;
            croppedCanvas.height = area.height;
            
            croppedCtx.imageSmoothingEnabled = false;
            croppedCtx.drawImage(
                currentImage,
                area.x, area.y, area.width, area.height,
                0, 0, area.width, area.height
            );
            
            // å‰å‡¦ç†ã‚’é©ç”¨
            preprocessImage(croppedCanvas).then(processedCanvas => {
                // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§è¡¨ç¤º
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head><title>OCRå‰å‡¦ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title></head>
                        <body style="margin: 20px; font-family: Arial, sans-serif;">
                            <h3>å…ƒç”»åƒ vs å‡¦ç†å¾Œ</h3>
                            <div style="display: flex; gap: 20px;">
                                <div>
                                    <h4>å…ƒç”»åƒ</h4>
                                    <canvas id="original" style="border: 1px solid #ccc;"></canvas>
                                </div>
                                <div>
                                    <h4>å‡¦ç†å¾Œ</h4>
                                    <canvas id="processed" style="border: 1px solid #ccc;"></canvas>
                                </div>
                            </div>
                        </body>
                    </html>
                `);
                
                const originalCanvas = newWindow.document.getElementById('original');
                const processedCanvasElement = newWindow.document.getElementById('processed');
                
                // å…ƒç”»åƒã‚’è¡¨ç¤º
                originalCanvas.width = croppedCanvas.width;
                originalCanvas.height = croppedCanvas.height;
                const originalCtx = originalCanvas.getContext('2d');
                originalCtx.drawImage(croppedCanvas, 0, 0);
                
                // å‡¦ç†å¾Œã‚’è¡¨ç¤º
                processedCanvasElement.width = processedCanvas.width;
                processedCanvasElement.height = processedCanvas.height;
                const processedCtx = processedCanvasElement.getContext('2d');
                processedCtx.drawImage(processedCanvas, 0, 0);
            });
        }
        
        // åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function showAnalytics() {
            const modal = document.getElementById('analyticsModal');
            modal.style.display = 'block';
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šé€±ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—
            calculateAnalytics('week');
            
            // ã‚°ãƒ©ãƒ•ã‚’æç”»
            drawCompletionChart();
            drawDeadlineChart();
            
            // æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
            displayAssigneePerformance();
        }
        
        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }
        
        // æœŸé–“é¸æŠãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        function showAnalyticsForPeriod(period) {
            // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('#analyticsModal .period-btn').forEach(btn => {
                btn.style.background = '#e2e8f0';
                btn.style.color = '#333';
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒœã‚¿ãƒ³ã«activeã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            event.target.style.background = '#0052cc';
            event.target.style.color = 'white';
            
            // æœŸé–“ã«å¿œã˜ã¦åˆ†æã‚’å†è¨ˆç®—
            calculateAnalytics(period);
        }
        
        function calculateAnalytics(period = 'all') {
            // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            let filteredTasks = tasks;
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            if (period === 'today') {
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfToday;
                    }
                    return false;
                });
            } else if (period === 'week') {
                const startOfWeek = new Date(startOfToday);
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfWeek;
                    }
                    return false;
                });
            } else if (period === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfMonth;
                    }
                    return false;
                });
            }
            
            // ç·ã‚¿ã‚¹ã‚¯æ•°
            const totalTasks = filteredTasks.length;
            document.getElementById('total-tasks').textContent = totalTasks;
            
            // å®Œäº†ã‚¿ã‚¹ã‚¯æ•°ã¨å®Œäº†ç‡
            const completedTasks = filteredTasks.filter(task => task.columnId === 'done').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('completion-rate').textContent = completionRate + '%';
            
            // æœŸé™éµå®ˆç‡ã‚’è¨ˆç®—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã®ã†ã¡ã€æœŸé™å†…ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®å‰²åˆï¼‰
            const completedOnTime = filteredTasks.filter(task => {
                if (task.columnId === 'done' && task.deadline && task.completedAt) {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }
                return false;
            }).length;
            
            const deadlineCompliance = totalTasks > 0 
                ? Math.round((completedOnTime / totalTasks) * 100) 
                : 100;
                
            console.log(`ğŸ“Š [COMPLIANCE] Period: ${period}, Total tasks: ${totalTasks}`);
            console.log(`ğŸ“Š [COMPLIANCE] Completed on time: ${completedOnTime}`);
            console.log(`ğŸ“Š [COMPLIANCE] Compliance rate: ${deadlineCompliance}%`);
            
            document.getElementById('deadline-compliance').textContent = deadlineCompliance + '%';
            
            // å¹³å‡å®Œäº†æ™‚é–“ã‚’è¨ˆç®—
            const completedWithTime = tasks.filter(task => 
                task.columnId === 'done' && task.createdAt && task.completedAt
            );
            
            if (completedWithTime.length > 0) {
                const totalTime = completedWithTime.reduce((sum, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created);
                }, 0);
                
                const avgTime = totalTime / completedWithTime.length;
                const days = Math.floor(avgTime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((avgTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                document.getElementById('avg-completion-time').textContent = 
                    days > 0 ? `${days}æ—¥${hours}æ™‚é–“` : `${hours}æ™‚é–“`;
            } else {
                document.getElementById('avg-completion-time').textContent = '-';
            }
        }
        
        function drawCompletionChart() {
            const chartContainer = document.getElementById('completion-chart');
            
            // ã‚«ãƒ©ãƒ åˆ¥ã‚¿ã‚¹ã‚¯æ•°ã‚’é›†è¨ˆ
            const columnCounts = {};
            columns.forEach(column => {
                columnCounts[column.id] = tasks.filter(task => task.columnId === column.id).length;
            });
            
            // æœ€å¤§å€¤ã‚’æ±‚ã‚ã‚‹
            const maxCount = Math.max(...Object.values(columnCounts), 1);
            
            // æ£’ã‚°ãƒ©ãƒ•ã‚’HTMLã§ä½œæˆ
            let chartHTML = '<div style="display: flex; height: 100%; align-items: flex-end; justify-content: space-around; padding: 1rem;">';
            
            columns.forEach(column => {
                const count = columnCounts[column.id];
                const percentage = (count / maxCount) * 100;
                
                chartHTML += `
                    <div style="flex: 1; text-align: center; margin: 0 0.5rem;">
                        <div style="position: relative; height: 150px; display: flex; align-items: flex-end;">
                            <div style="background: ${column.color}; width: 100%; height: ${percentage}%; border-radius: 4px 4px 0 0; position: relative;">
                                <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-weight: bold; color: #333;">
                                    ${count}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            ${column.title.replace(/[^\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\w\s]/g, '')}
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        function drawDeadlineChart() {
            const chartContainer = document.getElementById('deadline-chart');
            
            // æœŸé™çŠ¶æ³ã‚’é›†è¨ˆï¼ˆDoneã‚«ãƒ©ãƒ ã‚’é™¤ãï¼‰
            const activeTasks = tasks.filter(task => task.columnId !== 'done');
            const now = new Date();
            
            const deadlineStatus = {
                overdue: 0,
                today: 0,
                thisWeek: 0,
                later: 0,
                noDeadline: 0
            };
            
            activeTasks.forEach(task => {
                if (!task.deadline) {
                    deadlineStatus.noDeadline++;
                    return;
                }
                
                const deadline = new Date(task.deadline);
                const daysUntil = Math.floor((deadline - now) / (1000 * 60 * 60 * 24));
                
                if (deadline < now) {
                    deadlineStatus.overdue++;
                } else if (daysUntil === 0) {
                    deadlineStatus.today++;
                } else if (daysUntil <= 7) {
                    deadlineStatus.thisWeek++;
                } else {
                    deadlineStatus.later++;
                }
            });
            
            // å††ã‚°ãƒ©ãƒ•é¢¨ã®è¡¨ç¤ºã‚’ä½œæˆ
            const total = activeTasks.length || 1;
            const statusConfig = [
                { key: 'overdue', label: 'æœŸé™åˆ‡ã‚Œ', color: '#e53e3e' },
                { key: 'today', label: 'ä»Šæ—¥', color: '#d69e2e' },
                { key: 'thisWeek', label: 'ä»Šé€±', color: '#3182ce' },
                { key: 'later', label: 'ãã‚Œä»¥é™', color: '#38a169' },
                { key: 'noDeadline', label: 'æœŸé™ãªã—', color: '#a0aec0' }
            ];
            
            let chartHTML = '<div style="display: flex; flex-direction: column; height: 100%; padding: 1rem;">';
            
            statusConfig.forEach(config => {
                const count = deadlineStatus[config.key];
                const percentage = Math.round((count / total) * 100);
                
                if (count > 0) {
                    chartHTML += `
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.9rem; color: #666;">${config.label}</span>
                                <span style="font-size: 0.9rem; font-weight: bold;">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: ${config.color}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        function displayAssigneePerformance() {
            const performanceContainer = document.getElementById('assignee-performance');
            
            // æ‹…å½“è€…åˆ¥ã®çµ±è¨ˆã‚’é›†è¨ˆ
            const assigneeStats = {};
            
            assignees.forEach(assignee => {
                const assigneeTasks = tasks.filter(task => task.assignee === assignee);
                const completed = assigneeTasks.filter(task => task.columnId === 'done').length;
                const total = assigneeTasks.length;
                
                // æœŸé™éµå®ˆç‡
                const completedWithDeadline = assigneeTasks.filter(task => 
                    task.columnId === 'done' && task.deadline && task.completedAt
                );
                const onTime = completedWithDeadline.filter(task => {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }).length;
                
                assigneeStats[assignee] = {
                    total: total,
                    completed: completed,
                    completionRate: total > 0 ? Math.round((completed / total) * 100) : 0,
                    onTimeRate: completedWithDeadline.length > 0 
                        ? Math.round((onTime / completedWithDeadline.length) * 100) 
                        : 100
                };
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 0.75rem; text-align: left;">æ‹…å½“è€…</th>
                            <th style="padding: 0.75rem; text-align: center;">ç·ã‚¿ã‚¹ã‚¯</th>
                            <th style="padding: 0.75rem; text-align: center;">å®Œäº†</th>
                            <th style="padding: 0.75rem; text-align: center;">å®Œäº†ç‡</th>
                            <th style="padding: 0.75rem; text-align: center;">æœŸé™éµå®ˆç‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(assigneeStats).forEach(([assignee, stats]) => {
                if (stats.total > 0) {
                    tableHTML += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 0.75rem; font-weight: 500;">${assignee}</td>
                            <td style="padding: 0.75rem; text-align: center;">${stats.total}</td>
                            <td style="padding: 0.75rem; text-align: center;">${stats.completed}</td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span style="color: ${stats.completionRate >= 80 ? '#38a169' : stats.completionRate >= 50 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${stats.completionRate}%
                                </span>
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span style="color: ${stats.onTimeRate >= 90 ? '#38a169' : stats.onTimeRate >= 70 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${stats.onTimeRate}%
                                </span>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            performanceContainer.innerHTML = tableHTML;
        }
        
        // åˆ†æã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateAnalyticsSummary() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.columnId === 'done').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // æœŸé™éµå®ˆç‡ï¼ˆå…¨ã‚¿ã‚¹ã‚¯ã®ã†ã¡æœŸé™å†…ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®å‰²åˆï¼‰
            const completedOnTime = tasks.filter(task => {
                if (task.columnId === 'done' && task.deadline && task.completedAt) {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }
                return false;
            }).length;
            
            const deadlineCompliance = totalTasks > 0 
                ? Math.round((completedOnTime / totalTasks) * 100) 
                : 100;
            
            // å¹³å‡å®Œäº†æ™‚é–“
            const completedWithTime = tasks.filter(task => 
                task.columnId === 'done' && task.createdAt && task.completedAt
            );
            let avgTimeText = '-';
            if (completedWithTime.length > 0) {
                const totalTime = completedWithTime.reduce((sum, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created);
                }, 0);
                const avgTime = totalTime / completedWithTime.length;
                const days = Math.floor(avgTime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((avgTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                avgTimeText = days > 0 ? `${days}æ—¥${hours}h` : `${hours}h`;
            }
            
            // è¡¨ç¤ºæ›´æ–°
            document.getElementById('summary-completion-rate').textContent = completionRate + '%';
            document.getElementById('summary-deadline-compliance').textContent = deadlineCompliance + '%';
            document.getElementById('summary-avg-time').textContent = avgTimeText;
        }
        
        // æœŸé–“ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function showPeriodReport(period) {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã®æ›´æ–°
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const now = new Date();
            let startDate, endDate, periodName;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    periodName = 'ä»Šæ—¥';
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    startDate = weekStart;
                    endDate = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
                    periodName = 'ä»Šé€±';
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    periodName = 'ä»Šæœˆ';
                    break;
            }
            
            // æœŸé–“å†…ã®ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡º
            const periodTasks = tasks.filter(task => {
                if (!task.createdAt) return false;
                const createdDate = new Date(task.createdAt);
                return createdDate >= startDate && createdDate < endDate;
            });
            
            const completedInPeriod = periodTasks.filter(task => {
                if (task.columnId !== 'done' || !task.completedAt) return false;
                const completedDate = new Date(task.completedAt);
                return completedDate >= startDate && completedDate < endDate;
            });
            
            // æœŸé™éµå®ˆï¼ˆæœŸé–“å†…ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®ã†ã¡ï¼‰
            const onTimeInPeriod = completedInPeriod.filter(task => {
                if (!task.deadline) return true;
                const deadline = new Date(task.deadline);
                const completed = new Date(task.completedAt);
                return completed <= deadline;
            });
            
            // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
            const modalId = 'period-report-' + Date.now();
            const reportHTML = `
                <div id="${modalId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) document.getElementById('${modalId}').remove()">
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748;">ğŸ“Š ${periodName}ã®ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                            <button onclick="document.getElementById('${modalId}').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #a0aec0; padding: 0.5rem; z-index: 2001; position: relative;">&times;</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${periodTasks.length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">ä½œæˆã‚¿ã‚¹ã‚¯</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${completedInPeriod.length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">å®Œäº†ã‚¿ã‚¹ã‚¯</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); color: #2d3748; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${periodTasks.length > 0 ? Math.round((completedInPeriod.length / periodTasks.length) * 100) : 0}%</div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">å®Œäº†ç‡</div>
                            </div>
                        </div>
                        
                        <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #2d3748;">æœŸé™éµå®ˆçŠ¶æ³</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>æœŸé™å†…å®Œäº†: ${onTimeInPeriod.length}ä»¶</span>
                                <span>éµå®ˆç‡: ${completedInPeriod.length > 0 ? Math.round((onTimeInPeriod.length / completedInPeriod.length) * 100) : 100}%</span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                                <div style="background: #38a169; height: 100%; width: ${completedInPeriod.length > 0 ? (onTimeInPeriod.length / completedInPeriod.length) * 100 : 100}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; color: #718096; font-size: 0.9rem;">
                            æœŸé–“: ${startDate.toLocaleDateString()} ã€œ ${endDate.toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reportHTML);
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†æ©Ÿèƒ½
        function showCreateTemplateModal() {
            // ã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
            const columnSelect = document.getElementById('template-column');
            if (columnSelect) {
                columnSelect.innerHTML = '';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    columnSelect.appendChild(option);
                });
            }
            
            // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const assigneesContainer = document.getElementById('template-assignees');
            assigneesContainer.innerHTML = '';
            assignees.forEach(assignee => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.9rem;';
                label.innerHTML = `
                    <input type="checkbox" value="${assignee}" style="margin: 0;">
                    <span>${assignee}</span>
                `;
                assigneesContainer.appendChild(label);
            });
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const templateModal = document.getElementById('templateModal');
            templateModal.style.display = 'flex';
        }
        
        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('template-name').value = '';
            document.getElementById('template-task-title').value = '';
            document.getElementById('template-memo').value = '';
            document.getElementById('template-category').value = 'å–¶æ¥­';
            document.getElementById('template-priority').value = 'medium';
            
            // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const checkboxes = document.querySelectorAll('#template-assignees input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('template-modal-title').textContent = 'ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ';
            document.getElementById('save-template-btn').textContent = 'ä¿å­˜';
            editingTemplateId = null;
        }
        
        function saveTemplate(event) {
            event.preventDefault();
            
            const name = document.getElementById('template-name').value.trim();
            const category = document.getElementById('template-category').value;
            const taskTitle = document.getElementById('template-task-title').value.trim();
            const priority = document.getElementById('template-priority').value;
            const columnId = document.getElementById('template-column').value;
            const memo = document.getElementById('template-memo').value.trim();
            
            // é¸æŠã•ã‚ŒãŸæ‹…å½“è€…ã‚’å–å¾—
            const selectedAssignees = Array.from(document.querySelectorAll('#template-assignees input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (!name || !taskTitle) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã¨ã‚¿ã‚¹ã‚¯åã¯å¿…é ˆã§ã™');
                return;
            }
            
            if (editingTemplateId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                const templateIndex = taskTemplates.findIndex(t => t.id === editingTemplateId);
                if (templateIndex !== -1) {
                    taskTemplates[templateIndex] = {
                        ...taskTemplates[templateIndex],
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo,
                        updatedAt: new Date().toISOString()
                    };
                }
                alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
            } else {
                // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
                const template = {
                    id: Date.now(),
                    name: name,
                    category: category,
                    taskTitle: taskTitle,
                    priority: priority,
                    columnId: columnId,
                    assignees: selectedAssignees,
                    memo: memo,
                    createdAt: new Date().toISOString()
                };
                
                taskTemplates.push(template);
                alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            }
            
            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’æ›´æ–°
            loadTemplateList();
            
            closeTemplateModal();
        }
        
        function loadTemplateList() {
            const container = document.getElementById('template-list');
            
            if (taskTemplates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                if (!groupedTemplates[template.category]) {
                    groupedTemplates[template.category] = [];
                }
                groupedTemplates[template.category].push(template);
            });
            
            let html = '';
            Object.keys(groupedTemplates).forEach(category => {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e9ecef; padding-bottom: 0.25rem;">${category}</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem;">
                `;
                
                groupedTemplates[category].forEach(template => {
                    html += `
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; width: 220px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <h6 style="margin: 0; font-size: 1rem; font-weight: 600; color: #172b4d; line-height: 1.2;">${template.name}</h6>
                                <div style="display: flex; gap: 0.25rem;">
                                    <button onclick="editTemplate(${template.id})" style="background: none; border: none; color: #6c757d; cursor: pointer; font-size: 0.9rem; padding: 0.2rem;" title="ç·¨é›†">âœï¸</button>
                                    <button onclick="deleteTemplate(${template.id})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1rem; padding: 0.2rem;" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.75rem; line-height: 1.3;">${template.taskTitle}</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0.75rem;">
                                <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">${template.priority === 'high' ? 'ğŸ”´ æœ€é‡è¦' : template.priority === 'medium' ? 'ğŸŸ¡ é‡è¦' : 'ğŸŸ¢ é€šå¸¸'}</span>
                                <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">${columns.find(c => c.id === template.columnId)?.title || template.columnId}</span>
                            </div>
                            <button onclick="applyTemplate(${template.id})" style="width: 100%; padding: 0.6rem; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                âš¡ é©ç”¨
                            </button>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }
        
        function editTemplate(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            editingTemplateId = templateId;
            document.getElementById('template-modal-title').textContent = 'âœï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†';
            document.getElementById('save-template-btn').textContent = 'æ›´æ–°';
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            showCreateTemplateModal();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å€¤ã‚’è¨­å®š
            setTimeout(() => {
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-category').value = template.category;
                document.getElementById('template-task-title').value = template.taskTitle;
                document.getElementById('template-priority').value = template.priority;
                document.getElementById('template-column').value = template.columnId;
                document.getElementById('template-memo').value = template.memo || '';
                
                // æ‹…å½“è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
                const checkboxes = document.querySelectorAll('#template-assignees input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = template.assignees && template.assignees.includes(cb.value);
                });
            }, 100);
        }
        
        function deleteTemplate(templateId) {
            if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            taskTemplates = taskTemplates.filter(t => t.id !== templateId);
            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
            loadTemplateList();
        }
        
        function applyTemplate(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å€¤ã‚’é©ç”¨
            createTaskUnified();
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å€¤ã‚’è¨­å®š
            setTimeout(() => {
                document.getElementById('task-title-input').value = template.taskTitle;
                document.getElementById('task-priority-input').value = template.priority;
                document.getElementById('task-column-input').value = template.columnId;
                document.getElementById('task-memo-input').value = template.memo || '';
                
                // æ‹…å½“è€…ã‚’è¨­å®š
                if (template.assignees && template.assignees.length > 0) {
                    setSelectedAssignees(template.assignees);
                }
            }, 100);
            
            // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeSettingsModal();
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠé–¢é€£é–¢æ•°
        function initializeTemplateSelector() {
            const templateSelect = document.getElementById('template-select');
            templateSelect.innerHTML = '<option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ --</option>';
            
            if (taskTemplates.length === 0) {
                return;
            }
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                if (!groupedTemplates[template.category]) {
                    groupedTemplates[template.category] = [];
                }
                groupedTemplates[template.category].push(template);
            });
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            Object.keys(groupedTemplates).forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                groupedTemplates[category].forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    optgroup.appendChild(option);
                });
                
                templateSelect.appendChild(optgroup);
            });
        }
        
        function handleTemplateSelection(templateId) {
            if (!templateId) {
                return;
            }
            
            const template = taskTemplates.find(t => t.id == templateId);
            if (!template) {
                return;
            }
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å€¤ã‚’è¨­å®š
            document.getElementById('task-title-input').value = template.taskTitle;
            document.getElementById('task-priority-input').value = template.priority;
            document.getElementById('task-column-input').value = template.columnId;
            document.getElementById('task-memo-input').value = template.memo || '';
            
            // æ‹…å½“è€…ã‚’è¨­å®š
            if (template.assignees && template.assignees.length > 0) {
                setSelectedAssignees(template.assignees);
            }
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('template-select').value = '';
        }
        
        // ãƒãƒ«ã‚¯æ“ä½œé–¢æ•°ç¾¤
        function toggleBulkMode() {
            isBulkMode = !isBulkMode;
            console.log(`ğŸ”„ [BULK] toggleBulkMode called, new state: ${isBulkMode}`);
            const bulkBar = document.getElementById('bulk-actions-bar');
            const toggleBtn = document.querySelector('button[onclick="toggleBulkMode()"]');
            
            if (isBulkMode) {
                bulkBar.style.display = 'block';
                toggleBtn.textContent = 'â˜‘ï¸ é¸æŠä¸­';
                toggleBtn.style.background = 'linear-gradient(135deg, #e53e3e 0%, #c53030 100%)';
                
                // ç§»å‹•å…ˆã‚«ãƒ©ãƒ é¸æŠè‚¢ã‚’æ›´æ–°
                const moveSelect = document.getElementById('bulk-move-column');
                moveSelect.innerHTML = '<option value="">ç§»å‹•å…ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ</option>';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    moveSelect.appendChild(option);
                });
            } else {
                bulkBar.style.display = 'none';
                toggleBtn.textContent = 'â˜‘ï¸ è¤‡æ•°é¸æŠ';
                toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                clearSelection();
            }
            
            render(); // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º/éè¡¨ç¤ºã‚’åæ˜ 
        }
        
        function selectAllTasks() {
            selectedTasks.clear();
            tasks.forEach(task => {
                selectedTasks.add(task.id);
            });
            updateSelectedCount();
            render();
        }
        
        function clearSelection() {
            selectedTasks.clear();
            updateSelectedCount();
            render();
        }
        
        function toggleTaskSelection(taskId) {
            console.log(`Toggle selection for task ${taskId}, current size: ${selectedTasks.size}`);
            
            if (selectedTasks.has(taskId)) {
                selectedTasks.delete(taskId);
                console.log(`Removed task ${taskId}, new size: ${selectedTasks.size}`);
            } else {
                selectedTasks.add(taskId);
                console.log(`Added task ${taskId}, new size: ${selectedTasks.size}`);
            }
            updateSelectedCount();
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const checkbox = document.querySelector(`input[onchange="toggleTaskSelection(${taskId})"]`);
            if (checkbox) {
                checkbox.checked = selectedTasks.has(taskId);
            }
            
            console.log(`Selected tasks:`, Array.from(selectedTasks));
        }
        
        function updateSelectedCount() {
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = `${selectedTasks.size}ä»¶é¸æŠ`;
            }
        }
        
        function bulkMoveSelected() {
            const targetColumn = document.getElementById('bulk-move-column').value;
            if (!targetColumn) {
                alert('ç§»å‹•å…ˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (selectedTasks.size === 0) {
                alert('ç§»å‹•ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const selectedTaskIds = Array.from(selectedTasks);
            let movedCount = 0;
            
            selectedTaskIds.forEach(taskId => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    console.log(`Moving task ${task.title} from ${task.columnId} to ${targetColumn}`);
                    task.columnId = targetColumn;
                    movedCount++;
                }
            });
            
            if (movedCount > 0) {
                saveTasks();
                render();
                updateStats();
                clearSelection();
                
                const targetColumnTitle = columns.find(c => c.id === targetColumn)?.title || targetColumn;
                alert(`${movedCount}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ã€Œ${targetColumnTitle}ã€ã«ç§»å‹•ã—ã¾ã—ãŸ`);
            } else {
                alert('ç§»å‹•ã§ãã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
        }
        
        function bulkDeleteSelected() {
            if (selectedTasks.size === 0) {
                alert('å‰Šé™¤ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const selectedTaskIds = Array.from(selectedTasks);
            const confirmMessage = `é¸æŠã—ãŸ${selectedTaskIds.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            tasks = tasks.filter(task => !selectedTasks.has(task.id));
            
            saveTasks();
            clearSelection();
            render();
            updateStats();
            
            alert(`${selectedTaskIds.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
        
        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
        
        // Phase 1: æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ã¿å®Ÿè¡Œï¼ˆåˆ¶å¾¡ãªã—ï¼‰
        setTimeout(() => {
            checkUserPermission();
            // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚‚åˆæœŸåŒ–
            updateHamburgerMenu();
        }, 1000); // 1ç§’å¾Œã«å®‰å…¨ã«å®Ÿè¡Œ
        
        // Phase 2: ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³å‰Šé™¤å®Ÿè¡Œ
        setTimeout(() => {
            removeMyProfileButton();
        }, 1500); // 1.5ç§’å¾Œã«å®‰å…¨ã«å®Ÿè¡Œ
        
        // Phase 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³åˆ¶å¾¡å®Ÿè¡Œï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ç§»æ¤ã®ãŸã‚ä¸è¦ï¼‰
        // setTimeout(() => {
        //     hideUserManagementForUsers();
        // }, 300); // 0.3ç§’å¾Œã«é«˜é€Ÿå®Ÿè¡Œ
        
        // ãƒ†ã‚¹ãƒˆç”¨: åœæ»ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
        function createTestStaleTask() {
            const staleDate = new Date();
            staleDate.setDate(staleDate.getDate() - 5); // 5æ—¥å‰
            
            const testTask = {
                id: Date.now(),
                title: 'ã€ãƒ†ã‚¹ãƒˆã€‘5æ—¥å‰ã«ä½œæˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯',
                deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7æ—¥å¾Œã®æœŸé™
                priority: 'medium',
                columnId: 'todo',
                assignee: 'ç”°ä¸­éƒ¨é•·',
                assignees: ['ç”°ä¸­éƒ¨é•·'],
                memo: 'ã“ã‚Œã¯åœæ»ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆç”¨ã§ã™ã€‚3æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ãŸã‚èµ¤æ è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚',
                createdAt: staleDate.toISOString(),
                isMainTask: false
            };
            
            tasks.push(testTask);
            taskCounter++;
            
            saveTasks();
            renderKanban();
            updateStats();
            
            alert('5æ—¥å‰ã«ä½œæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\nèµ¤æ ã§è¡¨ç¤ºã•ã‚Œã€åœæ»ä¸­ã‚«ã‚¦ãƒ³ãƒˆã«å«ã¾ã‚Œã¾ã™ã€‚');
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½ï¼‰
        window.createTestStaleTask = createTestStaleTask;
        
        // ãƒ†ã‚¹ãƒˆç”¨PJã‚¿ã‚¹ã‚¯ä½œæˆ
        function createTestPJTask() {
            const testPJTask = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                title: 'ã€ãƒ†ã‚¹ãƒˆPJã€‘æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥ - è¦ä»¶å®šç¾©æ›¸ä½œæˆ',
                deadline: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString(), // 10æ—¥å¾Œã®æœŸé™
                priority: 'high',
                columnId: 'todo',
                assignee: 'ç”°ä¸­éƒ¨é•·',
                assignees: ['ç”°ä¸­éƒ¨é•·', 'ä½è—¤èª²é•·'],
                memo: 'ã“ã‚Œã¯PJã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚Wãƒã‚§ãƒƒã‚¯ä½“åˆ¶ã®ç¢ºèªç”¨ã€‚',
                createdAt: new Date().toISOString(),
                completed: false,
                
                // PJã‚¿ã‚¹ã‚¯å°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                projectId: 'PJ001',
                projectName: 'æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
                personalStatus: 'todo',
                projectStatus: 'todo',
                pendingMove: null,
                approvers: ['ä½è—¤èª²é•·', 'éˆ´æœ¨ä¸»ä»»'],
                lastApprovedBy: null,
                approvedAt: null
            };
            
            tasks.push(testPJTask);
            saveTasks();
            render();
            updateStats();
            
            alert('ãƒ†ã‚¹ãƒˆç”¨PJã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\nPJãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰ã€ŒPJ001ã€ã‚’é¸æŠã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚\n\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: æ–°è¦ã‚·ã‚¹ãƒ†ãƒ å°å…¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: PJ001');
        }
        
        window.createTestPJTask = createTestPJTask;
        
        // å®šæœŸã‚¿ã‚¹ã‚¯ç®¡ç†ã®åŸºæœ¬é–¢æ•°
        function createRecurringTemplate() {
            alert('å®šæœŸã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆæ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™ã€‚\n\näºˆå®šæ©Ÿèƒ½:\nâ€¢ æ¯æœˆãƒ»æ¯é€±ã®ç¹°ã‚Šè¿”ã—è¨­å®š\nâ€¢ æ‹…å½“è€…ãƒ»æœŸé™ã®è‡ªå‹•è¨­å®š\nâ€¢ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆ');
        }
        
        function generatePendingTasks() {
            // ç¾åœ¨å®šæœŸã‚¿ã‚¹ã‚¯ãŒ0ä»¶ãªã®ã§ã€ãƒ‡ãƒ¢ç”¨ã®èª¬æ˜ã‚’è¡¨ç¤º
            alert('å®šæœŸã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒã‚§ãƒƒã‚¯å®Œäº†\n\nç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ã€æŒ‡å®šã•ã‚ŒãŸé–“éš”ã§ã‚¿ã‚¹ã‚¯ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚');
        }
        
        window.createRecurringTemplate = createRecurringTemplate;
        window.generatePendingTasks = generatePendingTasks;
        
        // PJã‚¿ã‚¹ã‚¯è¨¼æ†‘ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        function checkTaskEvidence(task) {
            // è¨¼æ†‘ã®å­˜åœ¨ç¢ºèª
            const hasComments = task.comments && task.comments.length > 0;
            const hasAttachments = task.attachments && task.attachments.length > 0;
            const hasDetailedMemo = task.memo && task.memo.trim().length > 10; // 10æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãƒ¡ãƒ¢
            
            return hasComments || hasAttachments || hasDetailedMemo;
        }
        
        function promptForEvidence(task) {
            const result = confirm(
                `âš ï¸ PJã‚¿ã‚¹ã‚¯ã®ç§»å‹•ã«ã¯è¨¼æ†‘ãŒå¿…è¦ã§ã™\n\n` +
                `ã‚¿ã‚¹ã‚¯: ${task.title}\n` +
                `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${task.projectName}\n\n` +
                `ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„:\n` +
                `â€¢ ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆé€²æ—å ±å‘Šãƒ»é€£çµ¡å†…å®¹ç­‰ï¼‰\n` +
                `â€¢ ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ï¼ˆè³‡æ–™ãƒ»ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç­‰ï¼‰\n` +
                `â€¢ è©³ç´°ãƒ¡ãƒ¢ï¼ˆãƒ¡ãƒ¼ãƒ«å†…å®¹ãƒ»æ‰“ã¡åˆã‚ã›çµæœç­‰ï¼‰\n\n` +
                `è¨¼æ†‘ã‚’è¿½åŠ ã›ãšã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ\n` +
                `â€» æ‰¿èªè€…ãŒçŠ¶æ³ã‚’åˆ¤æ–­ã§ãã¾ã›ã‚“`
            );
            
            if (!result) {
                // è¨¼æ†‘è¿½åŠ ã®ãŸã‚ã‚¿ã‚¹ã‚¯ç·¨é›†ç”»é¢ã‚’é–‹ã
                editTask(task.id);
                return false;
            }
            
            return true; // è¨¼æ†‘ãªã—ã§å¼·åˆ¶ç§»å‹•
        }
        
        // ã‚¿ã‚¹ã‚¯å‰Šé™¤æ©Ÿèƒ½ï¼ˆã‚´ãƒŸç®±ç§»å‹•ï¼‰
        function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const result = confirm(
                `ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                `ã‚¿ã‚¹ã‚¯: ${task.title}\n\n` +
                `â€» ã‚´ãƒŸç®±ã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å¾©å…ƒå¯èƒ½ã§ã™\n` +
                `â€» ã‚´ãƒŸç®±ã§30æ—¥çµŒéå¾Œã«è‡ªå‹•å®Œå…¨å‰Šé™¤ã•ã‚Œã¾ã™`
            );
            
            if (result) {
                // ã‚´ãƒŸç®±ã«ç§»å‹•
                const previousColumn = task.columnId;
                task.columnId = 'trash';
                task.deletedAt = new Date().toISOString();
                task.previousColumn = previousColumn; // å¾©å…ƒç”¨
                
                saveTasks();
                render();
                updateStats();
                
                // ã‚´ãƒŸç®±ã®è‡ªå‹•å‰Šé™¤ãƒã‚§ãƒƒã‚¯
                cleanupTrash();
                
                console.log(`ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã—ãŸ`);
                
                // å‰Šé™¤é€šçŸ¥
                showNotification(
                    'ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯å‰Šé™¤',
                    `ã€Œ${task.title}ã€ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã—ãŸ`,
                    { tag: `delete-${Date.now()}` }
                );
            }
        }
        
        // ã‚´ãƒŸç®±ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
        function cleanupTrash() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const trashTasks = tasks.filter(t => t.columnId === 'trash');
            const expiredTasks = trashTasks.filter(t => {
                if (!t.deletedAt) return false;
                return new Date(t.deletedAt) < thirtyDaysAgo;
            });
            
            if (expiredTasks.length > 0) {
                // 30æ—¥çµŒéã—ãŸã‚¿ã‚¹ã‚¯ã‚’å®Œå…¨å‰Šé™¤
                tasks = tasks.filter(t => !expiredTasks.includes(t));
                saveTasks();
                
                console.log(`ğŸ§¹ ã‚´ãƒŸç®±ã‹ã‚‰${expiredTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•å‰Šé™¤ã—ã¾ã—ãŸ`);
                
                // å‰Šé™¤é€šçŸ¥
                if (expiredTasks.length > 0) {
                    showNotification(
                        'ğŸ§¹ è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—',
                        `ã‚´ãƒŸç®±ã‹ã‚‰${expiredTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ30æ—¥çµŒéï¼‰`,
                        { tag: `cleanup-${Date.now()}` }
                    );
                }
            }
            
            // ã‚´ãƒŸç®±ãŒ20ä»¶ã‚’è¶…ãˆãŸå ´åˆã®è­¦å‘Š
            const remainingTrashTasks = tasks.filter(t => t.columnId === 'trash');
            if (remainingTrashTasks.length > 20) {
                console.log(`âš ï¸ ã‚´ãƒŸç®±ã«${remainingTrashTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™`);
            }
        }
        
        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleHamburgerMenu() {
            console.log('ğŸ” ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆé–‹å§‹...');
            
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            
            if (!hamburgerMenu) {
                console.error('âŒ hamburger-menuè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            if (!menuOverlay) {
                console.error('âŒ menu-overlayè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const isActive = hamburgerMenu.classList.contains('active');
            
            if (isActive) {
                hamburgerMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                console.log('ğŸ” ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã¾ã—ãŸ');
            } else {
                hamburgerMenu.classList.add('active');
                menuOverlay.classList.add('active');
                console.log('ğŸ” ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸ');
            }
        }
        
        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ›´æ–°
        function updateHamburgerMenu() {
            const currentUser = getCurrentUser();
            
            if (currentUser.isLoggedIn) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                const avatar = document.getElementById('user-menu-avatar');
                const name = document.getElementById('user-menu-name');
                const role = document.getElementById('user-menu-role');
                
                if (avatar) avatar.textContent = currentUser.name ? currentUser.name.charAt(0) : '-';
                if (name) name.textContent = currentUser.name || 'ã‚²ã‚¹ãƒˆ';
                
                let roleText = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                if (currentUser.role === 'developer') roleText = 'é–‹ç™ºè€…';
                else if (currentUser.role === 'admin') roleText = 'ç®¡ç†è€…';
                if (role) role.textContent = roleText;
                
                // é–‹ç™ºè€…æ©Ÿèƒ½ã®è¡¨ç¤ºåˆ¶å¾¡
                const developerSection = document.getElementById('developer-menu-section');
                if (developerSection) {
                    if (currentUser.role === 'developer') {
                        developerSection.style.display = 'block';
                    } else {
                        developerSection.style.display = 'none';
                    }
                }
                
                // ç®¡ç†æ©Ÿèƒ½ã®è¡¨ç¤ºåˆ¶å¾¡
                const adminSection = document.getElementById('admin-menu-section');
                if (adminSection) {
                    if (currentUser.role === 'developer' || currentUser.role === 'admin') {
                        adminSection.style.display = 'block';
                    } else {
                        adminSection.style.display = 'none';
                    }
                }
            }
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('currentSession');
                window.location.href = 'login.html';
            }
        }
        
        // æ©Ÿèƒ½æ”¹å–„æ›¸ã‚’é–‹ãï¼ˆé–‹ç™ºè€…å°‚ç”¨ï¼‰
        function openDevelopmentLog() {
            const currentUser = getCurrentUser();
            if (currentUser.role !== 'developer') {
                alert('ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºè€…ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™');
                return;
            }
            window.location.href = 'my-profile.html#development-log';
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.checkTaskEvidence = checkTaskEvidence;
        window.promptForEvidence = promptForEvidence;
        window.deleteTask = deleteTask;
        window.toggleHamburgerMenu = toggleHamburgerMenu;
        window.updateHamburgerMenu = updateHamburgerMenu;
        window.logout = logout;
    </script>
    
    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="hamburger-menu" id="hamburger-menu">
        <div class="user-menu-info">
            <div class="user-menu-avatar" id="user-menu-avatar">-</div>
            <div class="user-menu-name" id="user-menu-name">ã‚²ã‚¹ãƒˆ</div>
            <div class="user-menu-role" id="user-menu-role">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">å€‹äººè¨­å®š</div>
            <a href="my-profile.html" class="menu-item" onclick="toggleHamburgerMenu();">
                <span>ğŸ‘¤</span>
                <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
            </a>
            <a href="#" class="menu-item" onclick="openSettingsModal(); toggleHamburgerMenu(); return false;">
                <span>âš™ï¸</span>
                <span>è¨­å®šãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>
            </a>
        </div>
        
        <div class="menu-section" id="developer-menu-section" style="display: none;">
            <div class="menu-section-title">é–‹ç™ºæ©Ÿèƒ½</div>
            <a href="#" class="menu-item" onclick="openDevelopmentLog(); toggleHamburgerMenu(); return false;">
                <span>ğŸ“</span>
                <span>æ©Ÿèƒ½æ”¹å–„æ›¸</span>
            </a>
        </div>
        
        <div class="menu-section" id="admin-menu-section" style="display: none;">
            <div class="menu-section-title">ç®¡ç†æ©Ÿèƒ½</div>
            <a href="user-management.html" class="menu-item" onclick="toggleHamburgerMenu();">
                <span>ğŸ‘¥</span>
                <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</span>
            </a>
            <a href="admin-dashboard.html" class="menu-item" onclick="toggleHamburgerMenu();">
                <span>ğŸ“Š</span>
                <span>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </a>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">ãã®ä»–</div>
            <a href="#" class="menu-item" onclick="logout(); toggleHamburgerMenu(); return false;">
                <span>ğŸšª</span>
                <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
            </a>
        </div>
    </div>
    
    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleHamburgerMenu()"></div>
</body>
</html><!-- Cache bust: 1754211273 -->
<!-- UI Update: 1754211273 -->
<!-- EMERGENCY FIX: Force cache refresh for PJ creation feature -->
