<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Âñ∂Ê•≠„Çø„Çπ„ÇØÁÆ°ÁêÜ - Kanban„Éú„Éº„Éâ</title>
    <!-- Deploy: 2025-08-03-17:45 - PJ fields completely removed -->
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- FirebaseÁµ±Âêà„Ç∑„Çπ„ÉÜ„É† - „Éû„É´„ÉÅ„É¶„Éº„Ç∂„ÉºÂØæÂøú -->
    <script type="module" src="firebase-config.js"></script>
    <!-- üî• FirebaseÁµ±Âêà„É¢„Éº„Éâ - ÂÖ±Êúâ„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„ÇπË™≠„ÅøËæº„ÅøÁÑ°ÂäπÂåñÔºà„Çª„ÉÉ„Ç∑„Éß„É≥‰øùË≠∑Ôºâ -->
    <!-- „Ç≠„É£„ÉÉ„Ç∑„É•ÂïèÈ°åËß£Ê±∫„ÅÆ„Åü„ÇÅÂÆåÂÖ®ÁÑ°ÂäπÂåñ -->
    <!-- <script src="shared-users-database.js?v=disabled-20250806"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--body-bg, #f4f5f7);
            color: var(--text-color, #172b4d);
            overflow-x: auto;
        }
        
        .header {
            background: var(--theme-color, #026aa7);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        /* „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº */
        .hamburger-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }
        
        .hamburger-menu.active {
            left: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        .menu-section {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .menu-section-title {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        
        .menu-item:hover {
            background: #f5f5f5;
            transform: translateX(4px);
        }
        
        .menu-item.active {
            background: #e3f2fd;
            color: #026aa7;
            font-weight: 600;
        }
        
        .user-menu-info {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-menu-avatar {
            width: 48px;
            height: 48px;
            background: var(--theme-color, #026aa7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .user-menu-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .user-menu-role {
            font-size: 0.85rem;
            color: #666;
        }
        
        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        /* Áµ±Ë®àË°®Á§∫ */
        .stats-bar {
            background: var(--stats-bg, linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%));
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color, #dfe1e6);
            display: flex;
            gap: 1.5rem;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8rem;
        }
        
        .stat-number {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .stat-overdue { color: #e53e3e; }
        .stat-today { color: #d69e2e; }
        .stat-completed { color: #38a169; }
        
        /* ÂàÜÊûê„Çµ„Éû„É™„Éº„Éê„Éº */
        .analytics-summary {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .analytics-left {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .analytics-metric {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .analytics-value {
            font-weight: bold;
            font-size: 1rem;
        }
        
        .analytics-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .period-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .period-btn:hover {
            background: #f7fafc;
            border-color: #a0aec0;
        }
        
        .period-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        /* „Ç´„É≥„Éê„É≥„Éú„Éº„Éâ */
        .board-container {
            padding: 0.25rem;
            height: calc(100vh - 120px);
            overflow-x: auto;
        }
        
        .kanban-board {
            display: flex;
            gap: 0.375rem;
            min-width: max-content;
            height: 100%;
            padding: 0 0.5rem;
        }
        
        .column {
            background: var(--column-bg, linear-gradient(135deg, #f8f9fb 0%, #ebecf0 100%));
            border-radius: 8px;
            min-width: 180px;
            max-width: 200px;
            width: 190px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--column-border, rgba(255,255,255,0.2));
        }
        
        /* „Ç¥„ÉüÁÆ±„Ç´„É©„É†Â∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .column[data-column-id="trash"] {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #6c757d;
            opacity: 0.8;
        }
        
        .column[data-column-id="trash"]:hover {
            opacity: 1;
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }
        
        .column[data-column-id="trash"] .task {
            opacity: 0.6;
            background: #f8f9fa;
        }
        
        .column-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: #172b4d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dfe1e6;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.6) 100%);
            border-radius: 8px 8px 0 0;
        }
        
        .column-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .column-count {
            background: rgba(0,0,0,0.1);
            color: #5e6c84;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .column-content {
            flex: 1;
            padding: 0.5rem;
            overflow-y: auto;
            min-height: 100px;
        }
        
        /* „Çø„Çπ„ÇØ„Ç´„Éº„Éâ */
        .task-card {
            background: var(--card-bg, linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%));
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.375rem;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(9,30,66,.15);
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            border: 1px solid var(--card-border, rgba(0,0,0,0.05));
            color: var(--card-text, inherit);
        }
        
        .dark-theme .task-card {
            --card-bg: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            --card-border: #30363d;
            --card-text: #c9d1d9;
        }
        
        .task-card:hover {
            box-shadow: 0 4px 8px rgba(9,30,66,.25);
            transform: translateY(-1px);
        }
        
        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.02);
            box-shadow: 0 8px 16px rgba(9,30,66,.3);
            z-index: 1000;
        }
        
        /* ÂÑ™ÂÖàÂ∫¶„Ç´„É©„Éº */
        .task-card.priority-high { 
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }
        .task-card.priority-medium { 
            border-left-color: #d69e2e;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        }
        .task-card.priority-low { 
            border-left-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
        }
        
        /* ÊúüÈôêÂàá„Çå„Éª‰ªäÊó•ÊúüÈôê */
        .task-card.overdue {
            background: linear-gradient(135deg, #fed7d7 0%, #ffffff 100%);
            animation: pulse 2s infinite;
        }
        
        .task-card.today {
            background: linear-gradient(135deg, #fef5e7 0%, #ffffff 100%);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 1px 0 rgba(229, 62, 62, 0.25); }
            50% { box-shadow: 0 4px 8px rgba(229, 62, 62, 0.4); }
            100% { box-shadow: 0 1px 0 rgba(229, 62, 62, 0.25); }
        }
        
        .task-title {
            font-weight: 600;
            margin-bottom: 0.375rem;
            color: var(--title-color, #172b4d);
            font-size: 0.8rem;
            line-height: 1.25;
        }
        
        .dark-theme .task-title {
            --title-color: #c9d1d9;
        }
        
        .task-meta {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            flex-wrap: wrap;
            font-size: 0.7rem;
        }
        
        .task-deadline {
            background: #dfe1e6;
            color: #5e6c84;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 500;
        }
        
        .task-deadline.overdue {
            background: #e53e3e;
            color: white;
        }
        
        .task-deadline.today {
            background: #d69e2e;
            color: white;
        }
        
        .task-priority-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .priority-high { background: #fee2e2; color: #dc2626; }
        .priority-medium { background: #fef3c7; color: #d97706; }
        .priority-low { background: #dcfce7; color: #16a34a; }
        
        .task-memo {
            font-size: 0.75rem;
            color: #5e6c84;
            line-height: 1.3;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .task-badges {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }
        
        .attachment-icon {
            color: #5e6c84;
            font-size: 0.8rem;
        }
        
        .attachment-badge {
            background: #0079bf;
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }
        
        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .file-preview-item {
            background: #f4f5f7;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            padding: 0.3rem;
            font-size: 0.7rem;
            color: #5e6c84;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 100px;
            text-align: center;
        }
        
        .file-preview-item:hover {
            background: #ebecf0;
            border-color: #0079bf;
        }
        
        .file-preview-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 2px;
            margin-bottom: 0.2rem;
        }
        
        .file-drop-zone {
            border: 2px dashed #dfe1e6;
            border-radius: 3px;
            padding: 1rem;
            text-align: center;
            color: #5e6c84;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }
        
        .file-drop-zone.drag-over {
            border-color: #0079bf;
            background: rgba(0, 121, 191, 0.05);
            color: #0079bf;
        }
        
        .notification-test {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0079bf;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 0.8rem;
        }
        
        /* „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥ */
        .column-content.drag-over {
            background: rgba(0, 121, 191, 0.1);
            border: 2px dashed #0079bf;
            border-radius: 3px;
        }
        
        /* „Çø„Çπ„ÇØËøΩÂä†„Éú„Çø„É≥ */
        .add-task-btn {
            padding: 0.5rem;
            margin: 0 1rem 1rem;
            border: none;
            background: transparent;
            color: #5e6c84;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .add-task-btn:hover {
            background: rgba(9,30,66,.08);
            color: #172b4d;
        }
        
        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dfe1e6;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .modal-left {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #dfe1e6;
        }
        
        .modal-right {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        
        .comments-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dfe1e6;
            background: white;
        }
        
        .comments-section {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .comment-input-section {
            padding: 1rem;
            border-top: 1px solid #dfe1e6;
            background: white;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #172b4d;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #5e6c84;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        /* „Ç≥„É°„É≥„ÉàÈñ¢ÈÄ£„Çπ„Çø„Ç§„É´ */
        .comment {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .comment-author {
            font-weight: 600;
            color: #172b4d;
            margin-right: 0.5rem;
        }
        
        .comment-time {
            color: #5e6c84;
            font-size: 0.75rem;
        }
        
        .comment-body {
            color: #172b4d;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        
        .comment-input {
            width: 100%;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .comment-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .btn-comment {
            background: #0079bf;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-comment:hover {
            background: #005a8b;
        }
        
        /* ÊãÖÂΩìËÄÖÈÅ∏ÊäûÈñ¢ÈÄ£ */
        .assignees-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 0.5rem;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            background: white;
            min-height: 44px;
        }
        
        .assignee-checkbox {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .assignee-checkbox:hover {
            background: #f4f5f7;
        }
        
        .assignee-checkbox input[type="checkbox"] {
            margin: 0;
        }
        
        .assignee-checkbox.checked {
            background: #e3f2fd;
            color: #0079bf;
            font-weight: 500;
        }
        
        .selected-assignees {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        
        .assignee-tag {
            background: #0079bf;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .assignee-tag .remove-assignee {
            cursor: pointer;
            font-weight: bold;
            padding: 0 0.125rem;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }
        
        .assignee-tag .remove-assignee:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ */
        .mention-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
            min-width: 120px;
        }
        
        .mention-suggestion {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid #f4f5f7;
        }
        
        .mention-suggestion:hover,
        .mention-suggestion.selected {
            background: #e3f2fd;
            color: #0079bf;
        }
        
        .mention-suggestion:last-child {
            border-bottom: none;
        }
        
        .mention {
            background: #e3f2fd;
            color: #0079bf;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #172b4d;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--input-border, #dfe1e6);
            border-radius: 3px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            background: var(--input-bg, white);
            color: var(--input-text, inherit);
        }
        
        .dark-theme .form-input,
        .dark-theme .form-select,
        .dark-theme .form-textarea {
            --input-border: #30363d;
            --input-bg: #0d1117;
            --input-text: #c9d1d9;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #0079bf;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--theme-color, #0079bf);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--theme-color-dark, #026aa7);
        }
        
        .btn-secondary {
            background: #f4f5f7;
            color: #172b4d;
            border: 1px solid #dfe1e6;
        }
        
        .btn-secondary:hover {
            background: #ebecf0;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* „ÉÜ„Éº„ÉûÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
        .theme-modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .theme-modal[style*="display: none"] {
            display: none !important;
        }
        
        .theme-modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: 8px;
            width: 98%;
            max-width: 1600px;
            max-height: 95vh;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .settings-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .theme-option {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
        }
        
        .theme-option:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .theme-option.active {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }
        
        .theme-option .theme-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* „Éó„É¨„Éì„É•„Éº„Ç∞„É™„ÉÉ„Éâ„ÅÆ„É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 1600px) {
            .preview-grid {
                grid-template-columns: 1fr 1fr 1fr !important;
            }
        }
        
        @media (max-width: 1200px) {
            .preview-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        
        @media (max-width: 800px) {
            .preview-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„Éú„Çø„É≥ -->
            <button class="hamburger-btn" onclick="toggleHamburgerMenu()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem;" title="„É°„Éã„É•„Éº">
                ‚ò∞
            </button>
            <!-- üîß Á∑äÊÄ•Ë®∫Êñ≠„Éú„Çø„É≥„ÇíËøΩÂä† -->
            <button onclick="emergencyDiagnosis()" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; margin-left: 0.5rem; border-radius: 3px; font-size: 0.7rem; cursor: pointer;" title="Á∑äÊÄ•Ë®∫Êñ≠">
                üö®Ë®∫Êñ≠
            </button>
            <div class="header-title">üéØ Âñ∂Ê•≠„Çø„Çπ„ÇØÁÆ°ÁêÜ - Kanban„Éú„Éº„Éâ 
                <span style="font-size: 0.7rem; background: #ff6b6b; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; margin-left: 0.5rem;">
                    v2025.08.18-FirebaseÂÆåÂÖ®Âåñ
                </span>
            </div>
        </div>
        <div class="header-controls">
            <button onclick="debugFirebase()" class="settings-btn" title="FirebaseÁä∂ÊÖãÁ¢∫Ë™ç" style="background: #ff6b6b; margin-right: 10px;">üîç</button>
            <button onclick="forceSync()" class="settings-btn" title="Âº∑Âà∂ÂêåÊúü" style="background: #4CAF50; margin-right: 10px;">üîÑ</button>
            <button onclick="openSettingsModal()" class="settings-btn" title="Ë®≠ÂÆö" style="display: none;">‚öôÔ∏è</button>
        </div>
    </div>
    
    
    
    <!-- Áµ±Ë®à„Éê„Éº -->
    <div class="stats-bar" id="stats-bar">
        <div class="stat-item stat-overdue">
            <span class="stat-number" id="overdue-count">0</span>
            <span>ÊúüÈôêÂàá„Çå</span>
        </div>
        <div class="stat-item stat-today">
            <span class="stat-number" id="today-count">0</span>
            <span>‰ªäÊó•ÊúüÈôê</span>
        </div>
        <div class="stat-item" style="color: #e77600;" onclick="showStaleTasksDetail()" title="3Êó•‰ª•‰∏äÂêå„Åò„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Çø„Çπ„ÇØ">
            <span style="cursor: pointer;">üö®</span>
            <span class="stat-number" id="stale-count">0</span>
            <span style="cursor: pointer;">ÂÅúÊªû‰∏≠</span>
        </div>
        <div class="stat-item" id="workload-item" style="color: #0052cc; display: none;" onclick="showWorkloadDetail()" title="„ÉÅ„Éº„É†Âπ≥Âùá„ÅÆ1.2ÂÄç‰ª•‰∏ä„ÅÆ„Çø„Çπ„ÇØ„ÇíÊãÖÂΩì">
            <span style="cursor: pointer;">üë•</span>
            <span class="stat-number" id="overload-count">0</span>
            <span style="cursor: pointer;">Ë¶ÅË™øÊï¥</span>
        </div>
    </div>
    
    <!-- „Éï„Ç£„É´„Çø„Éº„ÉªÁÆ°ÁêÜ„Éê„Éº -->
    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span style="font-weight: 600; color: #2d3748;">üë• Ë°®Á§∫ÂØæË±°:</span>
            <!-- Áµ±ÂêàÊãÖÂΩìËÄÖ„ÉªPJ„Éï„Ç£„É´„Çø„Éº -->
            <div style="position: relative;" id="assignee-filter-container">
                <button onclick="toggleAssigneeFilterDropdown()" style="padding: 0.5rem 0.75rem; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; min-width: 150px;">
                    <span id="assignee-filter-text">ÂÖ®Âì°</span>
                    <span>‚ñº</span>
                </button>
                <div id="assignee-filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 250px;">
                    <!-- ÊãÖÂΩìËÄÖ„ÉªPJÈÅ∏ÊäûËÇ¢„Åå„Åì„Åì„Å´ÂãïÁöÑËøΩÂä†„Åï„Çå„Çã -->
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <!-- PJ‰ΩúÊàê„Éú„Çø„É≥ -->
            <button onclick="window.location.href='pj-create.html'" style="padding: 0.5rem 0.75rem; background: #2b6cb0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;" title="Êñ∞„Åó„ÅÑPJ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê">
                üë• PJ‰ΩúÊàê
            </button>
            <!-- „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥„Çí„Éû„Ç§„Éö„Éº„Ç∏„Å´ÁßªÊ§ç„ÅÆ„Åü„ÇÅÈùûË°®Á§∫ -->
            <button onclick="window.location.href='user-management.html'" style="display: none; padding: 0.5rem 0.75rem; background: #38a169; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;" title="„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ">
                üë• „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ
            </button>
            <button onclick="showFilterHelp()" style="background: none; border: none; color: #4a5568; cursor: pointer; font-size: 1rem;" title="„Éï„Ç£„É´„Çø„Éº„ÅÆË™¨Êòé">
                ‚ùì
            </button>
        </div>
    </div>
    
    <!-- ÂàÜÊûê„Çµ„Éû„É™„Éº„Éê„Éº -->
    <div class="analytics-summary" id="analytics-summary">
        <div class="analytics-left">
            <div class="analytics-metric">
                <span style="font-weight: 600;">ÂÆå‰∫ÜÁéá:</span>
                <span class="analytics-value" id="completion-rate-summary">0%</span>
            </div>
            <div class="analytics-metric">
                <span style="font-weight: 600;">ÊúüÈôêÈÅµÂÆàÁéá:</span>
                <span class="analytics-value" id="compliance-rate-summary">0%</span>
            </div>
        </div>
    </div>
        
        <!-- „Ç´„É©„É†ËøΩÂä†Ê©üËÉΩ -->
        <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="quick-column-name" placeholder="Êñ∞„Çπ„ÉÜ„Éº„Çø„ÇπÂêç" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; width: 120px;">
            <button onclick="quickAddColumn()" style="padding: 0.4rem 0.8rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Ôºã„Çπ„ÉÜ„Éº„Çø„Çπ</button>
        </div>
    </div>
    
    <!-- ÂàÜÊûê„Çµ„Éû„É™„Éº„Éê„Éº -->
    <div class="analytics-summary">
        <div class="analytics-left">
            <div class="analytics-metric">
                <span>üìà ÂÆå‰∫ÜÁéá:</span>
                <span class="analytics-value" style="color: #38a169;" id="summary-completion-rate">-</span>
            </div>
            <div class="analytics-metric">
                <span>‚è∞ ÊúüÈôêÈÅµÂÆàÁéá:</span>
                <span class="analytics-value" style="color: #4299e1;" id="summary-deadline-compliance">-</span>
            </div>
            <div class="analytics-metric">
                <span>‚ö° Âπ≥ÂùáÂÆå‰∫ÜÊôÇÈñì:</span>
                <span class="analytics-value" style="color: #9f7aea;" id="summary-avg-time">-</span>
            </div>
        </div>
        <div class="analytics-actions">
            <button onclick="createTaskUnified()" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; margin-right: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">‚ú® Êñ∞Ë¶è„Çø„Çπ„ÇØ</button>
            <button onclick="toggleBulkMode()" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; margin-right: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">‚òëÔ∏è Ë§áÊï∞ÈÅ∏Êäû</button>
            <!-- ÊúüÈñì„É¨„Éù„Éº„Éà„Éú„Çø„É≥„ÇíÂâäÈô§: Ë©≥Á¥∞ÂàÜÊûêÂÜÖ„Å´Áµ±Âêà -->
        </div>
    </div>
    
    <!-- „Éê„É´„ÇØÊìç‰Ωú„Éê„Éº -->
    <div id="bulk-actions-bar" style="display: none; background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; padding: 0.75rem 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="selected-count" style="font-weight: 600;">0‰ª∂ÈÅ∏Êäû</span>
                <button onclick="selectAllTasks()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ÂÖ®ÈÅ∏Êäû</button>
                <button onclick="clearSelection()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ÈÅ∏ÊäûËß£Èô§</button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <select id="bulk-move-column" style="padding: 0.4rem; border: none; border-radius: 4px; font-size: 0.8rem;">
                    <option value="">ÁßªÂãïÂÖà„ÇíÈÅ∏Êäû</option>
                </select>
                <button onclick="bulkMoveSelected()" style="background: #38a169; border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üì¶ ÁßªÂãï</button>
                <button onclick="bulkDeleteSelected()" style="background: #e53e3e; border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è ÂâäÈô§</button>
                <button onclick="toggleBulkMode()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úï ÁµÇ‰∫Ü</button>
            </div>
        </div>
    </div>
    
    <!-- „Ç´„É≥„Éê„É≥„Éú„Éº„Éâ -->
    <div class="board-container">
        <div class="kanban-board" id="kanban-board">
            <!-- „Ç´„É©„É†„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Çã -->
        </div>
    </div>
    
    <!-- „Çø„Çπ„ÇØÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Â∑¶ÂÅ¥: „Çø„Çπ„ÇØË©≥Á¥∞ -->
                <div class="modal-left">
                    <form onsubmit="saveTask(event)">
                        <!-- PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏Ôºàpj-create.htmlÔºâ„Å´ÁßªÂãï -->
                        
                        <!-- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû -->
                        <div class="form-group" style="background: #f8f9fa; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <label class="form-label" style="color: #495057;">üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ‰ΩúÊàêÔºà‰ªªÊÑèÔºâ</label>
                            <select id="template-select" onchange="handleTemplateSelection(this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                <option value="">-- „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">„Çø„Çπ„ÇØÂêç *</label>
                            <input type="text" class="form-input" id="task-title-input" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÊúüÈôêÊó• *</label>
                                <input type="date" class="form-input" id="task-date-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊúüÈôêÊôÇÂàª</label>
                                <input type="time" class="form-input" id="task-time-input" value="17:00">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÂÑ™ÂÖàÂ∫¶</label>
                                <select class="form-select" id="task-priority-input">
                                    <option value="high">üî¥ ÊúÄÈáçË¶Å</option>
                                    <option value="medium" selected>üü° ÈáçË¶Å</option>
                                    <option value="low">üü¢ ÈÄöÂ∏∏</option>
                                </select>
                            </div>
                            <div class="form-group" id="column-selection-group" style="display: none;">
                                <label class="form-label">ÈÖçÁΩÆÂÖà„Çπ„ÉÜ„Éº„Çø„Çπ *</label>
                                <select class="form-select" id="task-column-input" required>
                                    <!-- „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">„Éó„É≠„Ç∏„Çß„ÇØ„Éà</label>
                                <select class="form-control" id="task-project-select">
                                    <option value="">ÂÄã‰∫∫„Çø„Çπ„ÇØÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„ÅóÔºâ</option>
                                    <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                </select>
                                <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                    „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº„Å®ÂÖ±Êúâ„Åï„Çå„Åæ„Åô
                                </small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÊãÖÂΩìËÄÖÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
                                <div class="assignees-container" id="assignees-container">
                                    <!-- „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">„É°„É¢„ÉªÂÇôËÄÉ</label>
                            <textarea class="form-textarea" id="task-memo-input" rows="3" placeholder="Ë©≥Á¥∞„Å™ÈÄ≤ÊçóÁä∂Ê≥Å„ÇÑÂÇôËÄÉ„ÇíË®òÈå≤"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ê∑ª‰ªò„Éï„Ç°„Ç§„É´</label>
                            <input type="file" class="form-input" id="task-files-input" multiple accept="*/*">
                            <div class="file-drop-zone" id="file-drop-zone">
                                üìÅ „Åì„Åì„Å´„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó „Åæ„Åü„ÅØ ‰∏äË®ò„Éú„Çø„É≥„ÅßÈÅ∏Êäû
                            </div>
                            <div id="attached-files-list" style="margin-top: 0.5rem;"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
                            <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                        </div>
                    </form>
                </div>
                
                <!-- Âè≥ÂÅ¥: „Ç≥„É°„É≥„Éà„Çπ„É¨„ÉÉ„Éâ -->
                <div class="modal-right">
                    <div class="comments-header">
                        <h4 style="margin: 0; font-size: 1rem; color: #172b4d;">üí¨ „Ç≥„É°„É≥„Éà„ÉªÈÄ≤ÊçóÂ†±Âëä</h4>
                    </div>
                    
                    <div class="comments-section" id="comments-section">
                        <!-- „Ç≥„É°„É≥„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                    
                    <div class="comment-input-section" style="position: relative;">
                        <textarea class="comment-input" id="comment-input" placeholder="ÈÄ≤ÊçóÂ†±Âëä„ÄÅÁ¢∫Ë™ç‰∫ãÈ†Ö„ÄÅ„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ... (@„Åß„É¶„Éº„Ç∂„Éº„É°„É≥„Ç∑„Éß„É≥ÂèØËÉΩ)"></textarea>
                        <div id="mention-suggestions" class="mention-suggestions" style="display: none;"></div>
                        <div class="comment-actions">
                            <button type="button" class="btn-comment" onclick="console.log('üîç [BUTTON] Comment button clicked'); addComment()">„Ç≥„É°„É≥„ÉàËøΩÂä†</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settingsModal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title">‚öôÔ∏è Ë®≠ÂÆö</h3>
                <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
            </div>
            
            <div class="settings-modal-body">
                <!-- Ë®≠ÂÆöÁîªÈù¢„ÅÆË™¨Êòé -->
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #026aa7;">
                    <p style="margin: 0; color: #172b4d; font-size: 0.9rem;">
                        üí° <strong>Ë®≠ÂÆöÁîªÈù¢„ÅÆ‰Ωø„ÅÑÊñπÔºö</strong><br>
                        ‚Ä¢ „Çπ„ÉÜ„Éº„Çø„ÇπÁÆ°ÁêÜÔºö„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅÆÊÆµÈöé„ÇíËøΩÂä†„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§„Åß„Åç„Åæ„Åô<br>
                        ‚Ä¢ „Ç´„É©„ÉºÂ§âÊõ¥ÔºöÂêÑ„Éï„Çß„Éº„Ç∫„ÅÆËâ≤„ÇíÂ§âÊõ¥„Åó„Å¶„ÉÅ„Éº„É†Ë≠òÂà•„ÇíÂêë‰∏ä<br>
                        ‚Ä¢ „Ç¢„É©„Éº„ÉàË®≠ÂÆöÔºöÊúüÈôêÈÄöÁü•„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
                    </p>
                </div>
                
                <!-- „Ç´„É©„É†„Éª„Éï„Çß„Éº„Ç∫ÁÆ°ÁêÜ -->
                <div class="setting-section" style="background: #f8fafc; padding: 2rem; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #026aa7;">üìã „Çπ„ÉÜ„Éº„Çø„Çπ„Éª„Éï„Çß„Éº„Ç∫ÁÆ°ÁêÜ</h3>
                    <div id="column-manager">
                        <div id="column-list" style="margin-bottom: 1rem;">
                            <!-- Êó¢Â≠ò„ÅÆ„Ç´„É©„É†„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="new-column-name" placeholder="Êñ∞„Åó„ÅÑ„Ç´„É©„É†ÂêçÔºà‰æãÔºö„É¨„Éì„É•„Éº‰∏≠„ÄÅÊâøË™çÂæÖ„Å°Ôºâ" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addColumn()" style="padding: 0.5rem 1rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer;">ËøΩÂä†</button>
                        </div>
                    </div>
                </div>
                
                <!-- „Ç¢„É©„Éº„ÉàË®≠ÂÆö -->
                <div class="setting-section" style="margin-top: 2rem; background: #fef5e7; padding: 2rem; border-radius: 12px; border: 1px solid #fed7aa;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #f59e0b;">üîî ÊúüÈôê„Ç¢„É©„Éº„ÉàË®≠ÂÆö</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-3hours" checked>
                            <span>3ÊôÇÈñìÂâç„Å´„Ç¢„É©„Éº„Éà</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-1day">
                            <span>1Êó•Ââç„Å´„Ç¢„É©„Éº„Éà</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="alert-overdue" checked>
                            <span>ÊúüÈôêÂàá„ÇåÂæå„Å´„Ç¢„É©„Éº„Éà</span>
                        </label>
                    </div>
                </div>
                

                <!-- Ë°®Á§∫Ë®≠ÂÆö -->
                <div class="setting-section" style="margin-top: 2rem; background: #f0fdf4; padding: 2rem; border-radius: 12px; border: 1px solid #bbf7d0;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #22c55e;">üéØ Ë°®Á§∫Ë®≠ÂÆö</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="show-task-count" checked>
                            <span>„Ç´„É©„É†„Å´„Çø„Çπ„ÇØÊï∞„ÇíË°®Á§∫</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="compact-mode">
                            <span>„Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫„É¢„Éº„Éâ</span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-section" style="margin-top: 2rem; background: #fef2f2; padding: 2rem; border-radius: 12px; border: 1px solid #fecaca;">
                    <h3 style="margin-bottom: 1.5rem; color: #1a202c; font-size: 1.4rem; font-weight: 700; padding-bottom: 0.75rem; border-bottom: 3px solid #ef4444;">üîÑ „Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button onclick="clearAllData()" style="padding: 0.75rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- ÂàÜÊûê„Éª„É¨„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
    <div id="analyticsModal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content" style="max-width: 1000px;">
            <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #dfe1e6; flex-shrink: 0;">
                <h3 class="modal-title">üìä ÂàÜÊûê„Éª„É¨„Éù„Éº„Éà</h3>
                <button class="close-btn" onclick="closeAnalyticsModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem; overflow-y: auto; max-height: 80vh;">
                <!-- ÊúüÈñìÈÅ∏Êäû -->
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                    <span style="font-weight: 600;">ÊúüÈñì:</span>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('all')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">ÂÖ®ÊúüÈñì</button>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('today')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">‰ªäÊó•</button>
                    <button class="period-btn active" onclick="showAnalyticsForPeriod('week')" style="padding: 0.5rem 1rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer;">‰ªäÈÄ±</button>
                    <button class="period-btn" onclick="showAnalyticsForPeriod('month')" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">‰ªäÊúà</button>
                </div>
                
                <!-- Ê¶ÇË¶ÅÁµ±Ë®à -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="total-tasks">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Á∑è„Çø„Çπ„ÇØÊï∞</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="completion-rate">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ÂÆå‰∫ÜÁéá</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="deadline-compliance">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">ÊúüÈôêÈÅµÂÆàÁéá</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;" id="avg-completion-time">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Âπ≥ÂùáÂÆå‰∫ÜÊôÇÈñì</div>
                    </div>
                </div>
                
                <!-- „Ç∞„É©„Éï„Ç®„É™„Ç¢ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- „Çø„Çπ„ÇØÂÆå‰∫ÜÁéá„ÉÅ„É£„Éº„Éà -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #172b4d;">üìà „Çø„Çπ„ÇØÂÆå‰∫ÜÁä∂Ê≥Å</h4>
                        <div id="completion-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                            „Ç∞„É©„Éï„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                        </div>
                    </div>
                    
                    <!-- ÊúüÈôêÈÅµÂÆàÁä∂Ê≥Å„ÉÅ„É£„Éº„Éà -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #172b4d;">‚è∞ ÊúüÈôêÈÅµÂÆàÁä∂Ê≥Å</h4>
                        <div id="deadline-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                            „Ç∞„É©„Éï„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                        </div>
                    </div>
                </div>
                
                <!-- ÊãÖÂΩìËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ -->
                <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #172b4d;">üë• ÊãÖÂΩìËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h4>
                    <div id="assignee-performance" style="min-height: 200px;">
                        „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ÔºàÁã¨Á´ãÁâàÔºâ -->
    <div id="taskImportModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: #fdf2f8; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: #1f2937; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìù „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„Éà
                    <span style="font-size: 0.8rem; background: #ec4899; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 500;">„ÉÜ„Ç≠„Çπ„Éà„ÉªOCR</span>
                </h3>
                <button class="close-btn" onclick="closeTaskImportModal()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">&times;</button>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                <!-- Ë®≠ÂÆöÁîªÈù¢„ÅÆÂÆåÁíß„Å™„Äåüìù ÊüîËªü„ÉÜ„Ç≠„Çπ„Éà„Ç§„É≥„Éù„Éº„Éà„ÄçÊ©üËÉΩ„Çí„Åì„Åì„Å´ÁßªÊ§ç -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <textarea id="import-text" placeholder="„Ç∑„É≥„Éó„É´ÂΩ¢Âºè„Åß„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ&#10;‰æã:&#10;AÁ§æ„Å∏„ÅÆÊèêÊ°àÊõ∏‰ΩúÊàê @Áî∞‰∏≠ÈÉ®Èï∑ 2024-08-05&#10;  Ë©≥Á¥∞Á¢∫Ë™ç‰∫ãÈ†ÖÔºàÂçäËßí„Çπ„Éö„Éº„Çπ2ÂÄãÔºâ&#10;  Ë¶ãÁ©ç„ÇÇ„ÇäË™øÊï¥&#10;BÁ§æÊâì„Å°Âêà„Çè„Åõ!!! @‰ΩêËó§Ë™≤Èï∑&#10;„ÄÄË≥áÊñôÊ∫ñÂÇôÊ∏à„ÅøÔºàÂÖ®Ëßí„Çπ„Éö„Éº„ÇπÔºâ&#10;		‰ºöË≠∞ÂÆ§‰∫àÁ¥ÑÔºà„Çø„ÉñÔºâ&#10;CÁ§æ„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„Éó" style="width: 100%; height: 120px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9rem; resize: vertical;"></textarea>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="previewImport()" style="flex: 1; padding: 0.75rem; background: #0079bf; color: white; border: none; border-radius: 4px; cursor: pointer;">üëÅÔ∏è „Éó„É¨„Éì„É•„Éº</button>
                        <button onclick="clearImportText()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è „ÇØ„É™„Ç¢</button>
                        <label for="ocr-file-input" style="padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; display: inline-block;" title="GoogleTODO„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÂØæÂøúÔºÅÈ†òÂüüÈÅ∏Êäû„Åß„Çø„Çπ„ÇØÂêç„ÉªÊúüÈôê„ÇíËá™Âãï„Éö„Ç¢Âåñ">üì∏ OCR+„Çø„Ç∞Ê©üËÉΩ</label>
                        <input type="file" id="ocr-file-input" accept="image/*" style="display: none;" onchange="handleOCRFile(this)">
                    </div>
                    
                    <!-- OCRÂá¶ÁêÜÁä∂Ê≥Å -->
                    <div id="ocr-status" style="display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 4px; background: #e3f2fd; border: 1px solid #90caf9;">
                        <div id="ocr-progress-text">üì∏ ÁîªÂÉè„ÇíËß£Êûê‰∏≠...</div>
                        <div style="width: 100%; background: #f0f0f0; border-radius: 4px; height: 8px; margin-top: 0.5rem;">
                            <div id="ocr-progress-bar" style="width: 0%; height: 100%; background: #2196f3; border-radius: 4px; transition: width 0.3s;"></div>
                        </div>
                        <!-- AI‰ø°È†ºÂ∫¶„Çπ„Ç≥„Ç¢Ë°®Á§∫ -->
                        <div id="confidence-scores" style="display: none; margin-top: 0.75rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;">
                            <div style="font-size: 0.85rem; font-weight: bold; color: #495057; margin-bottom: 0.5rem;">üéØ AI‰ø°È†ºÂ∫¶„Çπ„Ç≥„Ç¢</div>
                            <div id="confidence-list" style="font-size: 0.8rem; color: #666;"></div>
                        </div>
                    </div>
                    
                    <!-- ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„Å®È†òÂüüÈÅ∏Êäû -->
                    <div id="image-preview-container" style="display: none; margin-top: 1rem; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                        <div style="padding: 1rem; border-bottom: 1px solid #ddd; background: #e8f5e8;">
                            <h5 style="margin: 0; color: #172b4d;">üñºÔ∏è ÁîªÂÉè„Éó„É¨„Éì„É•„Éº - È†òÂüü„ÇíÈÅ∏Êäû„Åó„Å¶OCR</h5>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                                „Éû„Ç¶„Çπ„Åß„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÈÅ∏ÊäûÈ†òÂüü„Çí‰ΩúÊàê„Åó„ÄÅ„ÄåOCRÂÆüË°å„Äç„Åß„ÉÜ„Ç≠„Çπ„ÉàÂåñ
                            </div>
                        </div>
                        <div id="image-preview-scroll-container" style="padding: 1rem; max-height: 600px; overflow: auto; position: relative;">
                            <div id="image-canvas-container" style="position: relative; display: inline-block; border: 1px solid #ccc; transform-origin: top left;">
                                <canvas id="image-canvas" style="cursor: crosshair;"></canvas>
                                <!-- ÈÅ∏ÊäûÈ†òÂüü„ÇíË°®Á§∫„Åô„Çã„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
                                <div id="selection-overlay" style="position: absolute; top: 0; left: 0; pointer-events: none;"></div>
                            </div>
                        </div>
                        <div style="padding: 1rem; border-top: 1px solid #ddd;">
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <button onclick="processSelectedAreas()" style="padding: 0.75rem; background: #0079bf; color: white; border: none; border-radius: 4px; cursor: pointer;">üîç OCRÂÆüË°å</button>
                                <button onclick="clearSelections()" style="padding: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è ÈÅ∏Êäû„ÇØ„É™„Ç¢</button>
                                <button onclick="hideImagePreview()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Èñâ„Åò„Çã</button>
                                <span id="selection-count" style="margin-left: 1rem; color: #666; font-size: 0.9rem;">0ÂÄã„ÅÆÈ†òÂüü„ÇíÈÅ∏Êäû‰∏≠</span>
                            </div>
                            <details style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                                <summary style="cursor: pointer; font-size: 0.85rem; color: #666;">üéØ OCRÁ≤æÂ∫¶Âêë‰∏äË®≠ÂÆö</summary>
                                <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: bold; color: #2563eb;">
                                            <input type="checkbox" id="ocr-handwriting-mode" title="ÊâãÊõ∏„ÅçÊñáÂ≠ó„Å´ÁâπÂåñ„Åó„ÅüÈ´òÁ≤æÂ∫¶OCR"> ‚úçÔ∏è ÊâãÊõ∏„ÅçÊñáÂ≠ó„É¢„Éº„ÉâÔºàÈ´òÁ≤æÂ∫¶Ôºâ
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: bold; color: #dc2626;">
                                            <input type="checkbox" id="ocr-complex-layout-mode" title="Ë°®„ÉªÂõ≥„Éª„Éï„Ç©„Éº„É†„Å™„Å©„ÅÆË§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàÂØæÂøú"> üß© Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„Éà„É¢„Éº„ÉâÔºàË°®„ÉªÂõ≥ÂØæÂøúÔºâ
                                        </label>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                            <input type="checkbox" id="ocr-enhance-contrast"> „Ç≥„É≥„Éà„É©„Çπ„ÉàÂº∑Âåñ
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                            <input type="checkbox" id="ocr-upscale"> 2ÂÄçÊã°Â§ßÂá¶ÁêÜ
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                            <input type="checkbox" id="ocr-grayscale"> „Ç∞„É¨„Éº„Çπ„Ç±„Éº„É´Âåñ
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;" title="‚ë†‚Üí 1, ‚óã‚Üí 0, ‚óè‚Üí 1 „Å™„Å©">
                                            <input type="checkbox" id="ocr-cleanup-symbols" checked> Êï∞Â≠óË®òÂè∑‰øÆÊ≠£
                                        </label>
                                    </div>
                                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                                        <button onclick="previewProcessing()" style="padding: 0.5rem; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üîç Âá¶ÁêÜ„Éó„É¨„Éì„É•„Éº</button>
                                        <button onclick="resetOCRSettings()" style="padding: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üîÑ „É™„Çª„ÉÉ„Éà</button>
                                    <button onclick="testOCRDirectly()" style="margin-left: 0.5rem; padding: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üîç OCR„ÉÜ„Çπ„Éà</button>
                                    <button onclick="testHandwritingOCR()" style="padding: 0.5rem; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úçÔ∏è ÊâãÊõ∏„Åç„ÉÜ„Çπ„Éà</button>
                                    <button onclick="testComplexLayoutOCR()" style="padding: 0.5rem; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üß© „É¨„Ç§„Ç¢„Ç¶„Éà„ÉÜ„Çπ„Éà</button>
                                    </div>
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: #d1ecf1; border-radius: 4px; font-size: 0.8rem; color: #0c5460;">
                                        üí° „Éí„É≥„Éà: ‚ë†‚Üí 1, ‚óã‚Üí 0 „Å™„Å©„ÅÆË™§Ë™çË≠ò„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄåÊï∞Â≠óË®òÂè∑‰øÆÊ≠£„Äç„ÇíÊúâÂäπ„Å´
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                    
                    <!-- „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ - Êã°Â§ßÁâà -->
                    <div id="import-preview" style="display: none; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                        <div style="padding: 1rem; border-bottom: 1px solid #ddd; background: #e3f2fd;">
                            <h5 style="margin: 0; color: #172b4d;">üìã „Ç§„É≥„Éù„Éº„Éà„Éó„É¨„Éì„É•„Éº - „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÁ∑®ÈõÜÂèØËÉΩ</h5>
                        </div>
                        <div id="preview-content" style="padding: 1rem; max-height: 500px; overflow-y: auto; overflow-x: auto;"></div>
                        <div style="padding: 1rem; border-top: 1px solid #ddd; display: flex; gap: 0.5rem;">
                            <button onclick="executeImport()" style="flex: 1; padding: 0.75rem; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úÖ „Ç§„É≥„Éù„Éº„ÉàÂÆüË°å</button>
                            <button onclick="hidePreview()" style="padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">„Ç≠„É£„É≥„Çª„É´</button>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.8rem; color: #6c757d; line-height: 1.4;">
                        <strong>üìù „Ç∑„É≥„Éó„É´ÂΩ¢Âºè:</strong><br>
                        ‚Ä¢ <strong>„Éª</strong>„Åß‰∏ª„Çø„Çπ„ÇØÈñãÂßã<br>
                        ‚Ä¢ <strong>Ë°åÈ†≠„Çπ„Éö„Éº„Çπ</strong>„Åß„Çµ„Éñ„Çø„Çπ„ÇØÔºà„Ç≥„É°„É≥„Éà„Å´Ëá™ÂãïËøΩÂä†Ôºâ<br>
                        ‚Ä¢ <strong>@ÊãÖÂΩìËÄÖ</strong>„ÄÅ<strong>Êó•‰ªò</strong>„ÄÅ<strong>!!!</strong>È´òÂÑ™ÂÖàÂ∫¶„ÇíËá™ÂãïË™çË≠ò<br><br>
                        <strong>üì∏ OCRÊ≥®ÊÑè‰∫ãÈ†Ö:</strong><br>
                        ‚Ä¢ „Éó„É™„É≥„ÉàÊñáÂ≠ó„ÅÆ„ÅøÊé®Â•®ÔºàÊâãÊõ∏„Åç„ÅØÁ≤æÂ∫¶‰ΩéÔºâ<br>
                        ‚Ä¢ „Ç∑„É≥„Éó„É´„Å™„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆ„ÅøÔºàË°®„ÉªÂõ≥„ÅØÈùûÊé®Â•®Ôºâ<br>
                        ‚Ä¢ Ë™çË≠òÂæå„ÅØÊâãÂãï„ÅßÁ¢∫Ë™ç„Éª‰øÆÊ≠£„ÅåÂøÖË¶Å
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="projectManagementModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìÇ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ
                </h3>
                <button class="close-btn" onclick="closeProjectManagementModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem; margin-left: auto;">&times;</button>
            </div>
            
            <div style="padding: 1.5rem 2rem; overflow-y: auto; flex: 1;">
                <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #374151; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                        ‚ûï Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
                    </h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="newProjectName" placeholder="„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; margin-bottom: 0.5rem;">
                            <textarea id="newProjectDescription" placeholder="„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™¨Êòé" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; height: 80px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="font-size: 0.9rem; color: #6b7280;">ÂÖ¨ÈñãË®≠ÂÆö:</label>
                            <select id="newProjectVisibility" style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="public">üåê ÂÖ®Âì°„Å´ÂÖ¨Èñã</option>
                                <option value="private">üîí „É°„É≥„Éê„Éº„ÅÆ„Åø</option>
                            </select>
                            <button onclick="createNewProject()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;">
                                ‰ΩúÊàê
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß -->
                <div>
                    <h4 style="color: #374151; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                        üìã Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß
                    </h4>
                    <div id="projectsList" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ÊåøÂÖ•„Åï„Çå„Çã -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ÔºàÁµ±ÂêàÁâàÔºâ -->
    <div id="templateManagementModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="modal-header" style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: #f9fafb; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: #1f2937; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìã „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ
                    <span style="font-size: 0.8rem; background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 500;">Áµ±Âêà</span>
                </h3>
                <button class="close-btn" onclick="closeTemplateManagementModal()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">&times;</button>
            </div>
            
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Â∑¶ÂÅ¥Ôºö„ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß -->
                <div style="width: 350px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column;">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
                        <h4 style="margin: 0 0 1rem 0; color: #1f2937; font-weight: 600;">üìã ‰ΩúÊàêÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà</h4>
                        <button onclick="showTemplateCreateForm()" style="width: 100%; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            ‚ûï Êñ∞Ë¶è„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê
                        </button>
                    </div>
                    <div id="template-management-list" style="flex: 1; overflow-y: auto; padding: 1rem;">
                        <!-- „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        <div style="text-align: center; color: #6b7280; padding: 2rem;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                </div>
                
                <!-- Âè≥ÂÅ¥Ôºö„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„ÉªÁ∑®ÈõÜ„Éï„Ç©„Éº„É† -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <div id="template-welcome-screen" style="display: flex; flex-direction: column; justify-content: center; align-items: center; flex: 1; color: #6b7280; text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üìã</div>
                        <h3 style="margin: 0 0 0.5rem 0; color: #374151;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ</h3>
                        <p style="margin: 0; line-height: 1.6;">
                            Â∑¶ÂÅ¥„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„Åã„ÇâÈÅ∏Êäû„Åô„Çã„Åã„ÄÅ<br>
                            „ÄåÊñ∞Ë¶è„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Äç„ÅßÊñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô
                        </p>
                    </div>
                    
                    <div id="template-form-container" style="display: none; flex: 1; overflow-y: auto; padding: 1.5rem 2rem;">
                        <form id="template-management-form" onsubmit="saveTemplateFromManagement(event)">
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç *</label>
                                <input type="text" id="mgmt-template-name" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="‰æã: Âñ∂Ê•≠„É¨„Éù„Éº„Éà‰ΩúÊàê" required>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Ç´„ÉÜ„Ç¥„É™</label>
                                <select id="mgmt-template-category" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                    <option value="Âñ∂Ê•≠">Âñ∂Ê•≠</option>
                                    <option value="‰ºÅÁîª">‰ºÅÁîª</option>
                                    <option value="ÁÆ°ÁêÜ">ÁÆ°ÁêÜ</option>
                                    <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Çø„Çπ„ÇØÂêç *</label>
                                <input type="text" id="mgmt-template-task-title" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="‰æã: ÊúàÊ¨°Âñ∂Ê•≠„É¨„Éù„Éº„Éà‰ΩúÊàê" required>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ÂÑ™ÂÖàÂ∫¶</label>
                                    <select id="mgmt-template-priority" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                        <option value="high">üî¥ ÊúÄÈáçË¶Å</option>
                                        <option value="medium" selected>üü° ÈáçË¶Å</option>
                                        <option value="low">üü¢ ÈÄöÂ∏∏</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†</label>
                                    <select id="mgmt-template-column" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                        <!-- „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„Åå„Åì„Åì„Å´ÂãïÁöÑËøΩÂä†„Åï„Çå„Çã -->
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ÊãÖÂΩìËÄÖÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
                                <div id="mgmt-template-assignees" style="display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; min-height: 60px;">
                                    <!-- ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Åì„Åì„Å´ÂãïÁöÑËøΩÂä†„Åï„Çå„Çã -->
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 2rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„É°„É¢„ÉªÂÇôËÄÉ</label>
                                <textarea id="mgmt-template-memo" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; resize: vertical;" rows="4" placeholder="„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆË©≥Á¥∞„ÇÑ‰ΩøÁî®Â†¥Èù¢"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <button type="button" onclick="cancelTemplateForm()" style="flex: 1; padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    „Ç≠„É£„É≥„Çª„É´
                                </button>
                                <button type="submit" id="mgmt-save-template-btn" style="flex: 1; padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    üíæ ‰øùÂ≠ò
                                </button>
                                <button type="button" id="mgmt-delete-template-btn" onclick="deleteCurrentTemplate()" style="display: none; padding: 0.75rem 1.5rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    üóëÔ∏è ÂâäÈô§
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØÔºà„Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇÔºâ
        function checkAuthentication() {
            try {
                // „Åæ„Åö„Çª„ÉÉ„Ç∑„Éß„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session) {
                    // „Çª„ÉÉ„Ç∑„Éß„É≥ÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ
                    if (new Date() <= new Date(session.expiresAt)) {
                        console.log('‚úÖ [AUTH] Valid session found for:', session.user.name);
                        
                        // üîß Ê®©Èôê„ÅÆÂÆåÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™çÊôÇÔºâ
                        ensureUserPermissionsIntegrity();
                        
                        displayUserInfo(session.user);
                        return true;
                    } else {
                        console.log('‚ö†Ô∏è [AUTH] Session expired, removing...');
                        localStorage.removeItem('currentSession');
                    }
                }
                
                // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁÑ°Âäπ/ÊúüÈôêÂàá„Çå„ÅÆÂ†¥Âêà„ÅØ„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                console.warn('‚ö†Ô∏è [AUTH] „Çª„ÉÉ„Ç∑„Éß„É≥ÁÑ°Âäπ/ÊúüÈôêÂàá„Çå - „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà');
                localStorage.clear();
                window.location.href = 'login.html';
                return false;
            } catch (error) {
                console.error('‚ùå [AUTH] „Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç„Ç®„É©„Éº:', error);
                localStorage.clear();
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÂàùÊúüÂåñÔºàÈÅ©Âàá„Å™Ê®©ÈôêË®≠ÂÆö‰ªò„ÅçÔºâ
        function initializeUserDatabase() {
            const existingUsers = localStorage.getItem('systemUsers');
            if (!existingUsers || JSON.parse(existingUsers).length === 0) {
                console.log('üîß [INIT] „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÂàùÊúüÂåñ‰∏≠...');
                
                // Ê≠£„Åó„ÅÑÊ®©ÈôêË®≠ÂÆö„ÅÆÂÆåÂÖ®„Å™„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„Çπ
                const systemUsers = [
                    {
                        id: 1,
                        name: 'ÈÇ®‰∏≠Â§©Áúü',
                        email: 'muranaka-tenma@terracom.co.jp',
                        password: 'Tenma7041',
                        role: 'developer',
                        department: 'ÈñãÁô∫ÈÉ®',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 2,
                        name: 'Âä†Ëó§Á¥î',
                        email: 'kato-jun@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 3,
                        name: 'ÊúùÊó•Âú≠‰∏Ä',
                        email: 'asahi-keiichi@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 4,
                        name: 'ÂçäÊæ§‰æëÊûú',
                        email: 'hanzawa-yuka@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 5,
                        name: 'Áî∞ÊùëÊ∏â',
                        email: 'tamura-wataru@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 6,
                        name: 'Ê©ãÊú¨ÂèãÁæé',
                        email: 'hashimoto-yumi@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    },
                    {
                        id: 7,
                        name: 'Á¶èÂ≥∂‰∫úÊú™',
                        email: 'fukushima-ami@terracom.co.jp',
                        password: 'aikakumei',
                        role: 'user',
                        department: '-',
                        createdAt: '2025-08-04T00:00:00.000Z'
                    }
                ];
                
                localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                console.log('‚úÖ [INIT] Ê≠£„Åó„ÅÑÊ®©Èôê„ÅßsystemUsers„ÇíÂàùÊúüÂåñ:', systemUsers.length, 'Âêç');
                
                // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇÇÂàùÊúüÂåñ
                const assignees = systemUsers.map(u => u.name);
                localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                console.log('‚úÖ [INIT] ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇíÂàùÊúüÂåñ:', assignees);
                
                // Ê®©ÈôêÁ¢∫Ë™ç„É≠„Ç∞
                systemUsers.forEach(user => {
                    const roleEmoji = user.role === 'developer' ? 'üë®‚Äçüíª' : 
                                     user.role === 'admin' ? 'üë§' : 'üßë‚Äçüíº';
                    console.log(`  ${roleEmoji} ${user.name} - ${user.role}`);
                });
            } else {
                console.log('‚úÖ [INIT] systemUsers„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô - ÊãÖÂΩìËÄÖ„É™„Çπ„ÉàËá™ÂãïÊõ¥Êñ∞');
                
                // üîß ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇísystemUsers„Åã„ÇâËá™ÂãïÊõ¥Êñ∞
                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                if (systemUsers.length > 0) {
                    const assignees = systemUsers.map(u => u.name);
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                    console.log('‚úÖ [INIT] ÊãÖÂΩìËÄÖ„É™„Çπ„ÉàËá™ÂãïÊõ¥Êñ∞ÂÆå‰∫Ü:', assignees);
                }
                
                // Ê®©Èôê„ÅÆÂÆåÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºàÊ®©Èôê„É™„Çª„ÉÉ„ÉàÈò≤Ê≠¢Ôºâ
                ensureUserPermissionsIntegrity();
            }
        }
        
        // Ê®©Èôê„ÅÆÂÆåÂÖ®ÊÄß„Çí‰øùË®º„Åô„ÇãÈñ¢Êï∞ÔºàÊ®©Èôê„É™„Çª„ÉÉ„ÉàÈò≤Ê≠¢Ôºâ
        function ensureUserPermissionsIntegrity() {
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const correctRoles = {
                'muranaka-tenma@terracom.co.jp': 'developer',
                'kato-jun@terracom.co.jp': 'user',
                'asahi-keiichi@terracom.co.jp': 'user',
                'hanzawa-yuka@terracom.co.jp': 'user',
                'tamura-wataru@terracom.co.jp': 'user',
                'hashimoto-yumi@terracom.co.jp': 'user',
                'fukushima-ami@terracom.co.jp': 'user'
            };
            
            let corrected = false;
            let allUsersAreUser = systemUsers.length > 0 && systemUsers.every(user => user.role === 'user');
            
            if (allUsersAreUser) {
                console.warn('‚ö†Ô∏è [CRITICAL] ÂÖ®„É¶„Éº„Ç∂„Éº„Ååuser„Å´„Å™„Å£„Å¶„ÅÑ„Çã - Á∑äÊÄ•‰øÆÂæ©ÂÆüË°å');
            }
            
            // üîß Âº∑Âà∂ÁöÑ„Å´Ê≠£„Åó„ÅÑÊ®©Èôê„ÇíÈÅ©Áî®
            systemUsers.forEach(user => {
                const correctRole = correctRoles[user.email];
                if (correctRole) {
                    const oldRole = user.role;
                    user.role = correctRole; // Âº∑Âà∂ÁöÑ„Å´Ê≠£„Åó„ÅÑÊ®©Èôê„Å´Ë®≠ÂÆö
                    if (oldRole !== correctRole) {
                        console.log(`üîß [FORCE-FIX] ${user.name}: ${oldRole} ‚Üí ${correctRole} (Âº∑Âà∂‰øÆÊ≠£)`);
                        corrected = true;
                    }
                }
            });
            
            // üîÑ Â∏∏„Å´‰øùÂ≠òÔºàÂº∑Âà∂‰øÆÊ≠£Ôºâ
            localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
            console.log('‚úÖ [FORCE-FIX] Ê®©Èôê„ÅÆÂÆåÂÖ®ÊÄß„ÇíÂº∑Âà∂‰øÆÂæ©„Åó„Åæ„Åó„Åü');
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇÇ‰øÆÂæ©
            const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (session && session.user && correctRoles[session.user.email]) {
                const correctRole = correctRoles[session.user.email];
                const oldSessionRole = session.user.role;
                session.user.role = correctRole; // Âº∑Âà∂ÁöÑ„Å´Ê≠£„Åó„ÅÑÊ®©Èôê„Å´Ë®≠ÂÆö
                localStorage.setItem('currentSession', JSON.stringify(session));
                if (oldSessionRole !== correctRole) {
                    console.log(`üîß [SESSION-FORCE-FIX] „Çª„ÉÉ„Ç∑„Éß„É≥Ê®©ÈôêÂº∑Âà∂‰øÆÂæ©: ${session.user.name} ${oldSessionRole} ‚Üí ${correctRole}`);
                }
            }
            
            // üîç ‰øÆÊ≠£Âæå„ÅÆÊ®©ÈôêÁä∂Ê≥Å„ÇíÁ¢∫Ë™çË°®Á§∫
            console.log('üìã [PERMISSION-STATUS] ‰øÆÊ≠£Âæå„ÅÆÊ®©ÈôêÁä∂Ê≥Å:');
            systemUsers.forEach(user => {
                const roleEmoji = user.role === 'developer' ? 'üë®‚Äçüíª' : 
                                 user.role === 'admin' ? 'üë§' : 'üßë‚Äçüíº';
                console.log(`  ${roleEmoji} ${user.name} (${user.email}) - ${user.role}`);
            });
            
            return corrected;
        }
        
        // ÂÆöÊúüÁöÑÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºà5ÂàÜ„Åî„Å®Ôºâ
        function startPeriodicPermissionCheck() {
            setInterval(() => {
                console.log('üîÑ [PERIODIC] ÂÆöÊúüÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å‰∏≠...');
                const wasFixed = ensureUserPermissionsIntegrity();
                if (wasFixed) {
                    console.log('üö® [PERIODIC] Ê®©ÈôêÁï∞Â∏∏„ÇíÊ§úÂá∫„Éª‰øÆÂæ©„Åó„Åæ„Åó„Åü');
                }
            }, 5 * 60 * 1000); // 5ÂàÜ„Åî„Å®
        }
        
        function displayUserInfo(user) {
            // „Éò„ÉÉ„ÉÄ„Éº„Å´„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
                headerTitle.innerHTML = `
                    üéØ Âñ∂Ê•≠„Çø„Çπ„ÇØÁÆ°ÁêÜ
                    <span style="font-size: 0.8rem; font-weight: normal; margin-left: 1rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">
                        ${user.name} (${getRoleDisplayName(user.role)})
                    </span>
                `;
            }
            
            // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥„ÇíËøΩÂä†
            const headerRight = document.querySelector('.header').children[1];
            if (headerRight && !document.getElementById('logout-btn')) {
                const logoutBtn = document.createElement('button');
                logoutBtn.id = 'logout-btn';
                logoutBtn.innerHTML = 'üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà';
                logoutBtn.style.cssText = `
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9rem;
                    margin-left: 1rem;
                `;
                logoutBtn.onclick = function() {
                    if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                        localStorage.removeItem('currentSession');
                        window.location.href = 'login.html';
                    }
                };
                headerRight.appendChild(logoutBtn);
            }
            
            console.log('‚úÖ „É≠„Ç∞„Ç§„É≥Á¢∫Ë™ç:', user.name, user.role);
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': 'ÈñãÁô∫ËÄÖ',
                'admin': '„Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜËÄÖ',
                'project_manager': '„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜËÄÖ',
                'user': '‰∏ÄËà¨„É¶„Éº„Ç∂„Éº',
                'viewer': 'Èñ≤Ë¶ßËÄÖ'
            };
            return roleNames[role] || role;
        }
        
        // Phase 1: Ê®©ÈôêÂèñÂæóÊ©üËÉΩ„ÅÆ„ÅøÔºàË°®Á§∫Âà∂Âæ°„Å™„ÅóÔºâ
        function getCurrentUser() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user) {
                    console.log('üîê [GET-USER] „Çª„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÂèñÂæó:', {
                        name: session.user.name,
                        role: session.user.role,
                        email: session.user.email
                    });
                    return {
                        name: session.user.name,
                        email: session.user.email,
                        role: session.user.role,
                        isLoggedIn: true
                    };
                }
            } catch (error) {
                console.error('‚ùå [GET-USER] „Çª„ÉÉ„Ç∑„Éß„É≥ÂèñÂæó„Ç®„É©„Éº:', error);
                // „Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„Çø„ÅåÁ†¥Êêç„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÇØ„É™„Ç¢
                localStorage.removeItem('currentSession');
            }
            
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: currentUser„ÇÇÁ¢∫Ë™ç
            try {
                const user = localStorage.getItem('currentUser');
                if (user) {
                    console.log('üîß [GET-USER] „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰ΩøÁî®');
                    // ÈÇ®‰∏≠Â§©Áúü„ÅÆÂ†¥Âêà„ÅØÈñãÁô∫ËÄÖÊ®©Èôê„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº
                    const userName = typeof user === 'string' ? user : JSON.parse(user).name;
                    if (userName && userName.includes('ÈÇ®‰∏≠Â§©Áúü')) {
                        return {
                            name: 'ÈÇ®‰∏≠Â§©Áúü',
                            email: 'muranaka-tenma@terracom.co.jp',
                            role: 'developer',
                            isLoggedIn: true
                        };
                    }
                }
            } catch (error) {
                console.error('„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Ç®„É©„Éº:', error);
            }
            
            console.log('‚ö†Ô∏è [GET-USER] „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„Å™„Åó');
            return {
                name: null,
                email: null,
                role: null,
                isLoggedIn: false
            };
        }
        
        // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞ÔºàÂÖ±ÈÄöÔºâ
        function hasPermission(requiredRoles) {
            const currentUser = getCurrentUser();
            if (!currentUser.isLoggedIn) {
                console.log('‚ùå [PERMISSION] Êú™„É≠„Ç∞„Ç§„É≥');
                return false;
            }
            
            const hasAccess = requiredRoles.includes(currentUser.role);
            console.log(`üîê [PERMISSION] ${currentUser.name} (${currentUser.role}) => ÂøÖË¶ÅÊ®©Èôê: [${requiredRoles.join(', ')}] => ${hasAccess ? '‚úÖ' : '‚ùå'}`);
            
            return hasAccess;
        }
        
        // ÁÆ°ÁêÜËÄÖÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºà‰æøÂà©Èñ¢Êï∞Ôºâ
        function isAdminOrDeveloper() {
            return hasPermission(['admin', 'developer']);
        }
        
        // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩÔºàÂÆåÂÖ®ÂÆüË£ÖÔºâ
        function checkUserPermission() {
            // Ê®©Èôê„ÅÆÊï¥ÂêàÊÄß„ÇíÊúÄÂàù„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Éª‰øÆÊ≠£
            ensureUserPermissionsIntegrity();
            
            const currentUser = getCurrentUser();
            console.log('üîê ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±:', currentUser);
            
            if (currentUser.isLoggedIn) {
                console.log(`‚úÖ „É≠„Ç∞„Ç§„É≥Á¢∫Ë™ç: ${currentUser.name} (${currentUser.role})`);
                
                // Ê®©Èôê„Å´Âü∫„Å•„ÅèUIÂà∂Âæ°„ÇíÂÆüË°å
                updateUIBasedOnPermissions(currentUser);
            } else {
                console.log('‚ùå Êú™„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã');
            }
            
            return currentUser;
        }
        
        // Ê®©Èôê„Å´Âü∫„Å•„ÅèUIÂà∂Âæ°
        function updateUIBasedOnPermissions(user) {
            const { role } = user;
            
            // ÈñãÁô∫ËÄÖÊ©üËÉΩ„ÅÆË°®Á§∫Âà∂Âæ°
            const developerSection = document.getElementById('developer-menu-section');
            if (developerSection) {
                if (role === 'developer') {
                    developerSection.style.display = 'block';
                    console.log('‚úÖ ÈñãÁô∫ËÄÖÊ©üËÉΩ: Ë°®Á§∫');
                } else {
                    developerSection.style.display = 'none';
                    console.log('üö´ ÈñãÁô∫ËÄÖÊ©üËÉΩ: ÈùûË°®Á§∫');
                }
            }
            
            // ÁÆ°ÁêÜÊ©üËÉΩ„ÅÆË°®Á§∫Âà∂Âæ°
            const adminSection = document.getElementById('admin-menu-section');
            if (adminSection) {
                if (role === 'developer' || role === 'admin') {
                    adminSection.style.display = 'block';
                    console.log('‚úÖ ÁÆ°ÁêÜÊ©üËÉΩ: Ë°®Á§∫');
                    
                    // ÁÆ°ÁêÜËÄÖÂ∞ÇÁî®„É™„É≥„ÇØ„ÅÆÂà∂Âæ°
                    const userManagementLink = adminSection.querySelector('a[href="user-management.html"]');
                    const adminDashboardLink = adminSection.querySelector('a[href="admin-dashboard.html"]');
                    
                    if (userManagementLink) userManagementLink.style.display = 'block';
                    if (adminDashboardLink) adminDashboardLink.style.display = 'block';
                } else {
                    adminSection.style.display = 'none';
                    console.log('üö´ ÁÆ°ÁêÜÊ©üËÉΩ: ÈùûË°®Á§∫');
                }
            }
        }
        
        // Phase 2: „Éû„Ç§„Éö„Éº„Ç∏„Éú„Çø„É≥„ÅÆÂâäÈô§Ôºà„Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„Å´ÁßªË°åÔºâ
        function removeMyProfileButton() {
            try {
                const myProfileBtn = document.getElementById('my-profile-btn');
                if (myProfileBtn) {
                    myProfileBtn.remove();
                    console.log('üóëÔ∏è [Phase 2] „Éû„Ç§„Éö„Éº„Ç∏„Éú„Çø„É≥„ÇíÂâäÈô§Ôºà„Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„Å´ÁßªË°åÔºâ');
                }
            } catch (error) {
                console.error('‚ùå [Phase 2] „Éû„Ç§„Éö„Éº„Ç∏„Éú„Çø„É≥ÂâäÈô§„Ç®„É©„Éº:', error);
            }
        }
        
        // Phase 3: ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅÆ„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥ÈùûË°®Á§∫
        function hideUserManagementForUsers() {
            try {
                const currentUser = getCurrentUser();
                if (!currentUser.isLoggedIn) {
                    console.log('‚ùå [Phase 3] Êú™„É≠„Ç∞„Ç§„É≥: Âá¶ÁêÜ„Çπ„Ç≠„ÉÉ„Éó');
                    return;
                }
                
                console.log(`üîê [Phase 3] Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ: ${currentUser.name} (${currentUser.role})`);
                
                // ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅÆÂ†¥Âêà„ÅÆ„Åø„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
                if (currentUser.role === 'user') {
                    const userMgmtBtn = document.querySelector('button[onclick*="user-management.html"]');
                    if (userMgmtBtn) {
                        userMgmtBtn.style.display = 'none';
                        console.log('üîí [Phase 3] ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº: „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫');
                    } else {
                        console.log('‚ö†Ô∏è [Phase 3] „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                } else {
                    console.log(`‚úÖ [Phase 3] ${currentUser.role}Ê®©Èôê: „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥Ë°®Á§∫Á∂≠ÊåÅ`);
                }
                
                // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆÊõ¥Êñ∞
                setTimeout(() => {
                    updateHamburgerMenu();
                    console.log('üçî [Phase 3] „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÊõ¥Êñ∞ÂÆå‰∫Ü');
                }, 200);
                
            } catch (error) {
                console.error('‚ùå [Phase 3] „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥Âà∂Âæ°„Ç®„É©„Éº:', error);
            }
        }
        
        // FirebaseÁµ±Âêà„É¢„Éº„Éâ - ÂæìÊù•„ÅÆË™çË®º„ÉÅ„Çß„ÉÉ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó
        
        // FirebaseÂÆåÂÖ®Âåñ: „Çø„Çπ„ÇØ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñ¢Êï∞
        async function loadTasks() {
            try {
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                
                if (!window.FirebaseDB || !currentUser) {
                    tasks = [];
                    window.tasks = [];
                    render();
                    updateStats();
                    return [];
                }
                
                const result = await window.FirebaseDB.getTasks();
                if (result.success && result.tasks) {
                    tasks = result.tasks;
                    window.tasks = result.tasks;
                    window.firestoreUnsubscribe = result.unsubscribe;
                    render();
                    updateStats();
                    return tasks;
                } else {
                    tasks = [];
                    window.tasks = [];
                    render();
                    updateStats();
                    return [];
                }
                
            } catch (error) {
                console.error('‚ùå „Çø„Çπ„ÇØË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                tasks = [];
                window.tasks = [];
                render();
                updateStats();
                return [];
            }
        }
        
        // FirebaseÁµ±Âêà„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñ¢Êï∞
        async function loadTemplates() {
            try {
                if (window.FirebaseAuth?.getCurrentUser() && window.FirebaseDB) {
                    try {
                        const result = await window.FirebaseDB.getTemplates();
                        if (result.success) {
                            localStorage.setItem('taskTemplates', JSON.stringify(result.templates));
                            window.templatesUnsubscribe = result.unsubscribe;
                            return result.templates;
                        }
                    } catch (firebaseError) {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    }
                }
                
                return JSON.parse(localStorage.getItem('taskTemplates') || '[]');
                
            } catch (error) {
                console.error('‚ùå „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                return JSON.parse(localStorage.getItem('taskTemplates') || '[]');
            }
        }
        
        // FirebaseÂåñ: LocalStorageË™≠„ÅøËæº„ÅøÈñ¢Êï∞„ÇíÂªÉÊ≠¢
        function loadTasksFromStorage() {
            // Firebase„Åã„Çâ„ÅÆ„ÅøË™≠„ÅøËæº„Åø
            return [];
        }

        // ÂÆöÊúü„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊ©üËÉΩ
        function createPeriodicBackup() {
            try {
                const currentTasks = localStorage.getItem('salesTasksKanban');
                if (!currentTasks) return;
                
                const backupKey = `salesTasksKanban_auto_backup_${Date.now()}`;
                localStorage.setItem(backupKey, currentTasks);
                console.log('‚è∞ [BACKUP] ÂÆöÊúü„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê:', backupKey);
                
                // Âè§„ÅÑ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂâäÈô§ÔºàÊúÄÊñ∞10ÂÄã„Çí‰øùÊåÅÔºâ
                const backupKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('salesTasksKanban_auto_backup_')) {
                        backupKeys.push(key);
                    }
                }
                
                if (backupKeys.length > 10) {
                    const sortedKeys = backupKeys.sort();
                    const keysToDelete = sortedKeys.slice(0, sortedKeys.length - 10);
                    keysToDelete.forEach(key => {
                        localStorage.removeItem(key);
                        console.log('üóëÔ∏è [BACKUP] Âè§„ÅÑ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂâäÈô§:', key);
                    });
                }
                
            } catch (error) {
                console.error('‚ùå [BACKUP] „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê„Ç®„É©„Éº:', error);
            }
        }

        // 5ÂàÜÊØé„Å´Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
        setInterval(createPeriodicBackup, 5 * 60 * 1000);

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ - FirebaseÂÑ™ÂÖàË™≠„ÅøËæº„Åø„Å´Â§âÊõ¥
        let tasks = []; // ÂàùÊúü„ÅØÁ©∫ÈÖçÂàó„ÄÅFirebaseË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´„Çª„ÉÉ„Éà
        console.log('üî• [INIT] FirebaseÂÑ™ÂÖà„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø„ÇíÈñãÂßã„Åó„Åæ„Åô...');
        
        // „Éá„Éº„ÇøÁßªË°åÂØæÁ≠ñÔºöPJË®≠ÂÆö„Éá„Éº„Çø„ÅÆ‰∫íÊèõÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
        function migrateProjectData() {
            try {
                const projectSettings = JSON.parse(localStorage.getItem('projectSettings') || '{}');
                let needsMigration = false;
                
                // Êó¢Â≠ò„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅÂøÖË¶Å„Éï„Ç£„Éº„É´„Éâ„ÇíËøΩÂä†
                Object.keys(projectSettings).forEach(projectId => {
                    const project = projectSettings[projectId];
                    if (!project.columns) {
                        // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„ÇíË®≠ÂÆö
                        project.columns = ["üìã TODO", "üîÑ ÈÄ≤Ë°å‰∏≠", "‚úÖ ÂÆå‰∫Ü", "üóëÔ∏è „Ç¥„ÉüÁÆ±"];
                        needsMigration = true;
                    }
                    if (!project.createdAt) {
                        project.createdAt = new Date().toISOString();
                        needsMigration = true;
                    }
                    if (!project.createdBy) {
                        project.createdBy = getCurrentUser().name || '„Ç∑„Çπ„ÉÜ„É†';
                        needsMigration = true;
                    }
                });
                
                if (needsMigration) {
                    localStorage.setItem('projectSettings', JSON.stringify(projectSettings));
                    console.log('üîÑ [MIGRATION] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Éá„Éº„Çø„ÇíÁßªË°å„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('‚ùå [MIGRATION] „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Éá„Éº„ÇøÁßªË°å„Ç®„É©„Éº:', error);
            }
        }
        
        // „Éá„Éº„ÇøÁßªË°åÂÆüË°å
        migrateProjectData();
        
        // Êó¢Â≠ò„Çø„Çπ„ÇØ„Å´createdAt„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÁèæÂú®ÊôÇÂàª„Åã„ÇâÈÅ°„Å£„Å¶Ë®≠ÂÆö
        // Ôºà„Ç§„É≥„Éù„Éº„Éà„Åï„Çå„Åü„Çø„Çπ„ÇØ„Å™„Å©Áî®Ôºâ
        tasks = tasks.map((task, index) => {
            if (!task.createdAt) {
                // „Ç§„É≥„Éù„Éº„ÉàÈ†Ü„ÇíËÄÉÊÖÆ„Åó„Å¶„ÄÅÂè§„ÅÑ„Çø„Çπ„ÇØ„ÅØ7Êó•Ââç„ÄÅÊñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÅØ‰ªäÊó•„Å®„Åó„Å¶Ë®≠ÂÆö
                const daysAgo = Math.floor((tasks.length - index - 1) / Math.max(1, tasks.length / 7));
                const createdDate = new Date();
                createdDate.setDate(createdDate.getDate() - daysAgo);
                task.createdAt = createdDate.toISOString();
                console.log(`üìÖ [MIGRATION] Added createdAt to task ${task.id}: ${daysAgo} days ago`);
            }
            return task;
        });
        
        // ÂÅúÊªû„Çø„Çπ„ÇØ„ÅÆ„ÉÜ„Çπ„ÉàÁî®„Çµ„É≥„Éó„É´„ÇíËøΩÂä†ÔºàÂàùÂõû„ÅÆ„ÅøÔºâ- ÁÑ°ÂäπÂåñ
        // const hasStaleTestTask = tasks.some(task => task.title.includes('„ÄêÂÅúÊªû„ÉÜ„Çπ„Éà„Äë'));
        // if (!hasStaleTestTask) {
        //     // ÂÅúÊªû„ÉÜ„Çπ„Éà„Çø„Çπ„ÇØ„ÅÆËá™ÂãïÁîüÊàê„ÇíÁÑ°ÂäπÂåñ - „É¶„Éº„Ç∂„Éº„É™„ÇØ„Ç®„Çπ„Éà„Å´„Çà„Çã
        //     console.log('üö´ [INIT] Stale test task creation disabled');
        // }
        
        // Â§âÊõ¥„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÅØ‰øùÂ≠ò
        localStorage.setItem('salesTasksKanban', JSON.stringify(tasks));
        
        let draggedTask = null;
        let editingTask = null;
        let taskCounter = tasks.length || 0;
        
        // ÊãÖÂΩìËÄÖ„É™„Çπ„ÉàÔºà„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶ÂÆöÁæ©Ôºâ
        let assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
        window.assignees = assignees; // „Ç∞„É≠„Éº„Éê„É´„Å´„ÇÇË®≠ÂÆö
        
        // „Äå„É¶„Éº„Ç∂„Éº„Äç„ÇíÊãÖÂΩìËÄÖ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
        assignees = assignees.filter(assignee => assignee !== '„É¶„Éº„Ç∂„Éº');
        if (assignees.length === 0) {
            // ÊãÖÂΩìËÄÖ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÄÅ„Ç∑„Çπ„ÉÜ„É†„É¶„Éº„Ç∂„Éº„Åã„ÇâÂèñÂæó
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            if (users.length > 0) {
                assignees = users.map(user => user.name);
                console.log('üë• [ASSIGNEE CLEANUP] „Ç∑„Çπ„ÉÜ„É†„É¶„Éº„Ç∂„Éº„Åã„ÇâÊãÖÂΩìËÄÖ„ÇíÂæ©ÂÖÉ:', assignees);
            } else {
                // „Ç∑„Çπ„ÉÜ„É†„É¶„Éº„Ç∂„Éº„ÇÇÁ©∫„ÅÆÂ†¥Âêà„ÄÅÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†
                const currentUser = getCurrentUser();
                if (currentUser && currentUser.name && currentUser.name !== '„Ç≤„Çπ„Éà') {
                    assignees = [currentUser.name];
                    console.log('üë§ [ASSIGNEE CLEANUP] ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÊãÖÂΩìËÄÖ„Å®„Åó„Å¶Ë®≠ÂÆö:', assignees);
                } else {
                    // ÊúÄÂæå„ÅÆÊâãÊÆµ„Å®„Åó„Å¶„ÄåÊú™Ë®≠ÂÆö„Äç„ÇíËøΩÂä†
                    assignees = ['Êú™Ë®≠ÂÆö'];
                    console.log('‚ö†Ô∏è [ASSIGNEE CLEANUP] „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö:', assignees);
                }
            }
        }
        localStorage.setItem('taskAssignees', JSON.stringify(assignees));
        
        // ‰∏ÄÂõûÈôê„Çä„ÅÆ„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÁΩÆÊèõÂá¶ÁêÜ
        function migrateSampleDataToRealUser() {
            const migrationKey = 'sampleDataMigrated';
            if (localStorage.getItem(migrationKey)) return; // Êó¢„Å´ÂÆüË°åÊ∏à„Åø
            
            // Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Åã„ÇâÂÆü„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            
            let realUser = null;
            if (currentSession && currentSession.user) {
                realUser = currentSession.user.name; // „É≠„Ç∞„Ç§„É≥‰∏≠„É¶„Éº„Ç∂„Éº
            } else if (systemUsers.length > 0) {
                // ÈñãÁô∫ËÄÖÊ®©Èôê„É¶„Éº„Ç∂„Éº„ÇíÂÑ™ÂÖàÁöÑ„Å´ÈÅ∏Êäû
                const developerUser = systemUsers.find(u => u.role === 'developer');
                realUser = developerUser ? developerUser.name : systemUsers[0].name;
            } else {
                realUser = 'ÈÇ®‰∏≠Â§©Áúü'; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            }
            
            const sampleUsers = ['Áî∞‰∏≠ÈÉ®Èï∑', '‰ΩêËó§Ë™≤Èï∑', 'Èà¥Êú®‰∏ª‰ªª', 'Â±±Áî∞„Åï„Çì', 'Â±±Áî∞‰∏ª‰ªª', 'Èà¥Êú®‰øÇÈï∑'];
            let updated = false;
            
            // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅÆÁΩÆÊèõ
            assignees = assignees.map(name => {
                if (sampleUsers.includes(name)) {
                    updated = true;
                    console.log(`üîÑ ÁΩÆÊèõ: ${name} ‚Üí ${realUser}`);
                    return realUser;
                }
                return name;
            });
            
            // ÈáçË§á„ÇíÂâäÈô§„Åó„ÄÅÂÆü„É¶„Éº„Ç∂„Éº„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
            assignees = [...new Set(assignees)];
            if (!assignees.includes(realUser)) {
                assignees.push(realUser);
                updated = true;
            }
            
            if (updated) {
                localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                console.log(`‚úÖ „Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíÂÆü„É¶„Éº„Ç∂„Éº„Äå${realUser}„Äç„Å´ÁΩÆÊèõÂÆå‰∫Ü:`, assignees);
            }
            
            // „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            localStorage.setItem(migrationKey, 'true');
        }
        
        // „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å
        migrateSampleDataToRealUser();
        
        // „Ç´„É©„É†ÂÆöÁæ©
        let columns = JSON.parse(localStorage.getItem('kanbanColumns') || '[{"id":"todo","title":"üìã TODO","color":"#667eea"},{"id":"inprogress","title":"‚ö° ÈÄ≤Ë°å‰∏≠","color":"#f59e0b"},{"id":"waiting","title":"‚è≥ ÈÄ£Áµ°ÂæÖ„Å°","color":"#8b5cf6"},{"id":"done","title":"‚úÖ Done","color":"#10b981"},{"id":"trash","title":"üóëÔ∏è „Ç¥„ÉüÁÆ±","color":"#6c757d"}]');
        
        // „Ç¥„ÉüÁÆ±„Ç´„É©„É†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÂº∑Âà∂ËøΩÂä†
        const trashColumn = columns.find(c => c.id === 'trash');
        console.log('üóëÔ∏è [TRASH] ÁèæÂú®„ÅÆ„Ç´„É©„É†:', columns.map(c => c.id));
        console.log('üóëÔ∏è [TRASH] „Ç¥„ÉüÁÆ±„Ç´„É©„É†Â≠òÂú®:', !!trashColumn);
        
        if (!trashColumn) {
            columns.push({"id":"trash","title":"üóëÔ∏è „Ç¥„ÉüÁÆ±","color":"#6c757d"});
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            console.log('üóëÔ∏è „Ç¥„ÉüÁÆ±„Ç´„É©„É†„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
        } else {
            console.log('üóëÔ∏è „Ç¥„ÉüÁÆ±„Ç´„É©„É†„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô');
        }
        
        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜÔºàFirebaseÁµ±ÂêàÂØæÂøúÔºâ
        let taskTemplates = [];
        let editingTemplateId = null;
        
        // „Éê„É´„ÇØÊìç‰ΩúÁÆ°ÁêÜ
        let isBulkMode = false;
        let selectedTasks = new Set();
        
        // „Éï„Ç£„É´„ÇøÁÆ°ÁêÜÔºàPhase 2ÂØæÂøúÔºâ
        let selectedAssigneeFilters = [];
        let selectedProjectFilters = [];
        let viewMode = 'personal'; // 'personal' or 'project'
        
        // ÂÆöÊúü„Çø„Çπ„ÇØÁÆ°ÁêÜ
        let recurringTemplates = JSON.parse(localStorage.getItem('recurringTemplates') || '[]');
        
        // Phase 2: PJ„Çø„Çπ„ÇØÈñ¢ÈÄ£Èñ¢Êï∞ÔºàPJ‰ΩúÊàêÂ∞ÇÁî®Ôºâ
        function isPJTaskMode() {
            // PJË®≠ÂÆö„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã„ÅßPJ„É¢„Éº„Éâ„ÇíÂà§ÂÆö
            const projectSettings = document.getElementById('project-task-settings');
            return projectSettings && projectSettings.style.display === 'block';
        }
        
        function populateApprovers() {
            const container = document.getElementById('project-approvers');
            container.innerHTML = '';
            
            assignees.forEach(assignee => {
                const checkboxWrapper = document.createElement('label');
                checkboxWrapper.style.cssText = 'display: flex; align-items: center; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; background: #fff; border: 1px solid #ddd; font-size: 0.85rem;';
                checkboxWrapper.innerHTML = `
                    <input type="checkbox" value="${assignee}" style="margin-right: 0.5rem;">
                    <span>${assignee}</span>
                `;
                container.appendChild(checkboxWrapper);
            });
        }
        
        function getSelectedApprovers() {
            const checkboxes = document.querySelectorAll('#project-approvers input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // Áµ±Âêà„Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩÔºàÊãÖÂΩìËÄÖ + PJÔºâ
        function toggleAssigneeFilterDropdown() {
            const dropdown = document.getElementById('assignee-filter-dropdown');
            const isVisible = dropdown.style.display === 'block';
            
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                populateAssigneeFilterOptions();
                dropdown.style.display = 'block';
            }
        }
        
        function populateAssigneeFilterOptions() {
            const dropdown = document.getElementById('assignee-filter-dropdown');
            
            // ÂÖ®„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæóÔºàÈáçË§áÈô§ÂéªÔºâ
            const projectMap = new Map();
            tasks.filter(t => t.projectId && t.projectId !== null)
                 .forEach(t => {
                     if (!projectMap.has(t.projectId)) {
                         projectMap.set(t.projectId, {id: t.projectId, name: t.projectName});
                     }
                 });
            const allProjects = Array.from(projectMap.values());
            
            dropdown.innerHTML = `
                <div style="padding: 0.5rem;">
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 0.5rem; padding: 0.25rem;">üë§ ÊãÖÂΩìËÄÖ</div>
                    <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                        <input type="radio" name="filter-type" value="" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedAssigneeFilters.length === 0 && selectedProjectFilters.length === 0 ? 'checked' : ''}>
                        <span>ÂÖ®Âì°</span>
                    </label>
                    ${assignees.map(assignee => `
                        <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                            <input type="radio" name="filter-type" value="assignee:${assignee}" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedAssigneeFilters.includes(assignee) && selectedProjectFilters.length === 0 ? 'checked' : ''}>
                            <span>${assignee}</span>
                        </label>
                    `).join('')}
                    
                    ${allProjects.length > 0 ? `
                        <div style="font-weight: 600; color: #2d3748; margin: 0.75rem 0 0.5rem 0; padding: 0.25rem; border-top: 1px solid #e2e8f0;">üë• „Éó„É≠„Ç∏„Çß„ÇØ„Éà</div>
                        ${allProjects.map(project => `
                            <label style="display: flex; align-items: center; padding: 0.25rem; cursor: pointer; border-radius: 3px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                                <input type="radio" name="filter-type" value="project:${project.id}" onchange="updateAssigneeFilterSelection()" style="margin-right: 0.5rem;" ${selectedProjectFilters.includes(project.id) ? 'checked' : ''}>
                                <span>${project.id} - ${project.name}</span>
                            </label>
                        `).join('')}
                    ` : ''}
                </div>
            `;
        }
        
        function updateAssigneeFilterSelection() {
            const selectedRadio = document.querySelector('#assignee-filter-dropdown input[name="filter-type"]:checked');
            
            // „É™„Çª„ÉÉ„Éà
            selectedAssigneeFilters = [];
            selectedProjectFilters = [];
            viewMode = 'personal';
            
            if (selectedRadio && selectedRadio.value) {
                const [type, value] = selectedRadio.value.split(':');
                
                if (type === 'assignee') {
                    selectedAssigneeFilters = [value];
                    console.log(`üë§ [FILTER] Switched to assignee: ${value}`);
                } else if (type === 'project') {
                    selectedProjectFilters = [value];
                    viewMode = 'project';
                    console.log(`üë• [FILTER] Switched to project: ${value}`);
                }
            } else {
                console.log(`üë• [FILTER] Showing all tasks`);
            }
            
            updateAssigneeFilterText();
            render();
            updateStats();
        }
        
        function updateAssigneeFilterText() {
            const textElement = document.getElementById('assignee-filter-text');
            
            if (selectedProjectFilters.length > 0) {
                const projectTask = tasks.find(t => t.projectId === selectedProjectFilters[0]);
                textElement.textContent = projectTask ? `üë• ${projectTask.projectId}` : selectedProjectFilters[0];
            } else if (selectedAssigneeFilters.length > 0) {
                textElement.textContent = `üë§ ${selectedAssigneeFilters[0]}`;
            } else {
                textElement.textContent = 'ÂÖ®Âì°';
            }
        }
        
        function showFilterHelp() {
            const helpText = `
üë• Ë°®Á§∫ÂØæË±°„Éï„Ç£„É´„Çø„Éº„Å´„Å§„ÅÑ„Å¶

„Äêüë§ ÊãÖÂΩìËÄÖÈÅ∏Êäû„Äë
‚Ä¢ ÁâπÂÆö„ÅÆÊãÖÂΩìËÄÖ„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫
‚Ä¢ ÂÄã‰∫∫„ÅÆ‰ΩúÊ•≠Áä∂Ê≥Å„ÇíÁ¢∫Ë™ç

„Äêüë• „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû„Äë
‚Ä¢ ÁâπÂÆö„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫
‚Ä¢ PJ„Çø„Çπ„ÇØ„ÅÆW„ÉÅ„Çß„ÉÉ„ÇØÁÆ°ÁêÜÁî®
‚Ä¢ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÄ≤Êçó„ÅÆ‰∏ÄÂÖÉÁ¢∫Ë™ç

„ÄêÂÖ®Âì°„Äë
‚Ä¢ ÂÖ®„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫
‚Ä¢ „ÉÅ„Éº„É†ÂÖ®‰Ωì„ÅÆÁä∂Ê≥ÅÊääÊè°

üí° ÂÄã‰∫∫Ë°®Á§∫„Å®PJË°®Á§∫„ÅØÊéí‰ªñÁöÑ„Åß„Åô„ÄÇ
`;
            alert(helpText);
        }
        
        // PJ‰ΩúÊàêÊ©üËÉΩ
        function createProjectTask() {
            // PJ„Çø„Çπ„ÇØ‰ΩúÊàê„ÅØ pj-create.html „ÅßÂÆüË°å
            console.log('üîÑ [PJ CREATE] Redirecting to pj-create.html...');
            window.location.href = 'pj-create.html';
        }
        
        function generateRecurringTask(template) {
            const now = new Date();
            
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊñáÂ≠óÂàó„ÅÆÁΩÆÊèõ
            const title = formatTemplateString(template.taskTemplate.title, now);
            const deadline = calculateDeadline(now, template.deadlineConfig);
            
            const task = {
                id: Date.now(),
                title: title,
                deadline: deadline.toISOString(),
                priority: template.taskTemplate.priority,
                assignees: template.taskTemplate.assignees || [],
                assignee: template.taskTemplate.assignees?.[0] || 'Êú™Ë®≠ÂÆö',
                memo: template.taskTemplate.memo || '',
                attachments: [],
                comments: [],
                columnId: 'todo',
                completed: false,
                createdAt: now.toISOString(),
                
                // PJ„Çø„Çπ„ÇØÂØæÂøú
                projectId: template.taskTemplate.projectId,
                projectName: template.taskTemplate.projectName,
                personalStatus: 'todo',
                projectStatus: 'todo',
                pendingMove: null,
                approvers: template.taskTemplate.approvers || [],
                lastApprovedBy: null,
                approvedAt: null,
                
                // ÂÆöÊúü„Çø„Çπ„ÇØÊÉÖÂ†±
                isRecurring: true,
                recurringTemplateId: template.id,
                generatedFor: formatDateForRecurring(now)
            };
            
            return task;
        }
        
        function formatTemplateString(template, date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            return template
                .replace(/\{\{YYYY\}\}/g, year)
                .replace(/\{\{YYYYÂπ¥\}\}/g, `${year}Âπ¥`)
                .replace(/\{\{MM\}\}/g, String(month).padStart(2, '0'))
                .replace(/\{\{MMÊúà\}\}/g, `${month}Êúà`)
                .replace(/\{\{DD\}\}/g, String(day).padStart(2, '0'))
                .replace(/\{\{DDÊó•\}\}/g, `${day}Êó•`);
        }
        
        function calculateDeadline(baseDate, deadlineConfig) {
            const deadline = new Date(baseDate);
            deadline.setDate(deadline.getDate() + deadlineConfig.relativeDays);
            
            const [hours, minutes] = deadlineConfig.timeOfDay.split(':');
            deadline.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            return deadline;
        }
        
        function formatDateForRecurring(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            return `${year}-${String(month).padStart(2, '0')}`;
        }
        
        function checkAndGenerateRecurringTasks() {
            const now = new Date();
            let generatedCount = 0;
            
            recurringTemplates.forEach(template => {
                if (shouldGenerateRecurringTask(template, now)) {
                    const newTask = generateRecurringTask(template);
                    tasks.unshift(newTask);
                    
                    // Ê¨°ÂõûÁîüÊàêÊó•„ÇíÊõ¥Êñ∞
                    updateNextGenerationDate(template, now);
                    generatedCount++;
                    
                    console.log(`üîÑ [RECURRING] Generated task: ${newTask.title} for ${newTask.generatedFor}`);
                }
            });
            
            if (generatedCount > 0) {
                saveTasks();
                saveRecurringTemplates();
                render();
                updateStats();
                console.log(`üîÑ [RECURRING] Generated ${generatedCount} recurring tasks`);
            }
        }
        
        function shouldGenerateRecurringTask(template, now) {
            if (!template.isActive) return false;
            
            const nextGen = template.generationConfig.nextGeneration 
                ? new Date(template.generationConfig.nextGeneration) 
                : now;
            
            return now >= nextGen;
        }
        
        function updateNextGenerationDate(template, currentDate) {
            const config = template.recurringConfig;
            const next = new Date(currentDate);
            
            switch (config.type) {
                case 'daily':
                    next.setDate(next.getDate() + config.interval);
                    break;
                case 'weekly':
                    next.setDate(next.getDate() + (7 * config.interval));
                    break;
                case 'monthly':
                    next.setMonth(next.getMonth() + config.interval);
                    break;
                case 'yearly':
                    next.setFullYear(next.getFullYear() + config.interval);
                    break;
            }
            
            template.generationConfig.lastGenerated = currentDate.toISOString();
            template.generationConfig.nextGeneration = next.toISOString();
        }
        
        function showRecurringTasksInfo() {
            showRecurringTasksManagement();
        }
        
        function showRecurringTasksManagement() {
            const activeTemplates = recurringTemplates.filter(t => t.isActive);
            const recurringTasks = tasks.filter(t => t.isRecurring);
            
            const modal = document.createElement('div');
            modal.id = 'recurring-tasks-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #805ad5 0%, #667eea 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                        <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            üîÑ ÂÆöÊúü„Çø„Çπ„ÇØÁÆ°ÁêÜ
                            <button onclick="document.getElementById('recurring-tasks-modal').remove()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
                        </h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">ÊØéÊúà„ÉªÊØéÈÄ±„ÅÆÁπ∞„ÇäËøî„Åó„Çø„Çπ„ÇØ„ÇíÁÆ°ÁêÜ</p>
                    </div>
                    
                    <div style="padding: 1.5rem; overflow-y: auto; max-height: 60vh;">
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: #2d3748; margin: 0 0 1rem 0;">üìä ÁèæÂú®„ÅÆÁä∂Ê≥Å</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #805ad5;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #805ad5;">${activeTemplates.length}</div>
                                    <div style="color: #4a5568; font-size: 0.9rem;">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÉÜ„É≥„Éó„É¨„Éº„Éà</div>
                                </div>
                                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #38a169;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">${recurringTasks.length}</div>
                                    <div style="color: #4a5568; font-size: 0.9rem;">ÁîüÊàêÊ∏à„Åø„Çø„Çπ„ÇØ</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                            <button onclick="createRecurringTemplate()" style="background: #805ad5; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                ‚ûï „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê
                            </button>
                            <button onclick="generatePendingTasks()" style="background: #3182ce; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                üîÑ ‰ªä„Åô„ÅêÁîüÊàê„ÉÅ„Çß„ÉÉ„ÇØ
                            </button>
                            <button onclick="showRecurringTasksInfo_Old()" style="background: #718096; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                üìã Á∞°ÊòìË°®Á§∫
                            </button>
                        </div>
                        
                        ${activeTemplates.length > 0 ? `
                            <div>
                                <h4 style="color: #2d3748; margin: 0 0 1rem 0;">üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${activeTemplates.map(template => {
                                        const nextGen = template.generationConfig?.nextGeneration ? 
                                            new Date(template.generationConfig.nextGeneration).toLocaleDateString('ja-JP') : 'Êú™Ë®≠ÂÆö';
                                        const typeText = getRecurringTypeText(template.recurringConfig?.type || 'monthly');
                                        
                                        return `
                                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                    <div style="font-weight: 600; color: #2d3748;">${template.name || '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêçÊú™Ë®≠ÂÆö'}</div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button onclick="alert('Á∑®ÈõÜÊ©üËÉΩ„ÅØËøëÊó•ÂÆüË£Ö‰∫àÂÆö„Åß„Åô')" style="background: #edf2f7; border: 1px solid #e2e8f0; color: #4a5568; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Á∑®ÈõÜ</button>
                                                        <button onclick="alert('ÂÅúÊ≠¢Ê©üËÉΩ„ÅØËøëÊó•ÂÆüË£Ö‰∫àÂÆö„Åß„Åô')" style="background: #fed7d7; border: 1px solid #feb2b2; color: #c53030; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ÂÅúÊ≠¢</button>
                                                    </div>
                                                </div>
                                                <div style="font-size: 0.85rem; color: #4a5568; line-height: 1.4;">
                                                    <div>üìÖ È†ªÂ∫¶: ${typeText}</div>
                                                    <div>‚è∞ Ê¨°ÂõûÁîüÊàê: ${nextGen}</div>
                                                    <div>üë• ÊãÖÂΩìËÄÖ: ${template.taskTemplate?.assignees ? template.taskTemplate.assignees.join(', ') : 'Êú™Ë®≠ÂÆö'}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 2rem; color: #718096;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                                <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">ÂÆöÊúü„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                                <div style="font-size: 0.9rem;">Êñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„ÄÅÁπ∞„ÇäËøî„Åó„Çø„Çπ„ÇØ„ÇíËá™ÂãïÂåñ„Åó„Åæ„Åó„Çá„ÅÜ</div>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ÂÖÉ„ÅÆÁ∞°ÊòìË°®Á§∫Èñ¢Êï∞Ôºà‰∏ã‰Ωç‰∫íÊèõÁî®Ôºâ
        function showRecurringTasksInfo_Old() {
            const activeTemplates = recurringTemplates.filter(t => t.isActive);
            const recurringTasks = tasks.filter(t => t.isRecurring);
            
            let infoText = `üîÑ ÂÆöÊúü„Çø„Çπ„ÇØÁÆ°ÁêÜ\n\n`;
            infoText += `üìä ÁèæÂú®„ÅÆÁä∂Ê≥Å:\n`;
            infoText += `‚Ä¢ ÂÆöÊúü„ÉÜ„É≥„Éó„É¨„Éº„Éà: ${activeTemplates.length}‰ª∂\n`;
            infoText += `‚Ä¢ ÁîüÊàêÊ∏à„Åø„Çø„Çπ„ÇØ: ${recurringTasks.length}‰ª∂\n\n`;
            
            if (activeTemplates.length > 0) {
                infoText += `üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß:\n`;
                activeTemplates.forEach((template, index) => {
                    const nextGen = template.generationConfig?.nextGeneration 
                        ? new Date(template.generationConfig.nextGeneration).toLocaleDateString('ja-JP')
                        : 'Êú™Ë®≠ÂÆö';
                    infoText += `${index + 1}. ${template.name}\n`;
                    infoText += `   Á®ÆÈ°û: ${getRecurringTypeText(template.recurringConfig?.type || 'monthly')}\n`;
                    infoText += `   Ê¨°ÂõûÁîüÊàê: ${nextGen}\n\n`;
                });
            }
            
            if (recurringTasks.length > 0) {
                infoText += `üìù ÁîüÊàêÊ∏à„Åø„Çø„Çπ„ÇØ:\n`;
                const recentTasks = recurringTasks.slice(0, 5);
                recentTasks.forEach(task => {
                    const status = getColumnTitle(task.columnId);
                    infoText += `‚Ä¢ ${task.title} (${status})\n`;
                });
                if (recurringTasks.length > 5) {
                    infoText += `...‰ªñ${recurringTasks.length - 5}‰ª∂\n`;
                }
            }
            
            infoText += `\nüí° „Éí„É≥„Éà: ÂÆöÊúü„Çø„Çπ„ÇØ„ÅØËá™ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÄÅüîÑ„Ç¢„Ç§„Ç≥„É≥„ÅßË≠òÂà•„Åß„Åç„Åæ„Åô„ÄÇ`;
            
            alert(infoText);
        }
        
        function getRecurringTypeText(type) {
            const typeMap = {
                'daily': 'ÊØéÊó•',
                'weekly': 'ÊØéÈÄ±',
                'monthly': 'ÊØéÊúà',
                'yearly': 'ÊØéÂπ¥'
            };
            return typeMap[type] || type;
        }
        
        // Êó•‰ªò„ÉªÊôÇÈñì„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function getCurrentDateTime() {
            return new Date();
        }
        
        function isOverdue(deadline, columnId) {
            if (columnId === 'done') return false;
            return new Date(deadline) < getCurrentDateTime();
        }
        
        function isToday(deadline, columnId) {
            if (columnId === 'done') return false;
            const today = new Date();
            const deadlineDate = new Date(deadline);
            return today.toDateString() === deadlineDate.toDateString();
        }
        
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getDefaultDeadlineString() {
            // Êó•‰ªò„ÅØ‰ªäÊó•„ÇíË®≠ÂÆöÔºà„É≠„Éº„Ç´„É´Êó•‰ªòÂü∫Ê∫ñÔºâ
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getDefaultTimeString() {
            // ÁèæÂú®ÊôÇÂàª+3ÊôÇÈñì„Çí„Éá„Éï„Ç©„É´„ÉàÊôÇÂàª„Å®„Åó„Å¶Ë®≠ÂÆö
            const now = new Date();
            const futureDate = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // 3ÊôÇÈñìÂæå
            
            const hours = futureDate.getHours();
            const minutes = futureDate.getMinutes();
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        function getDefaultDateTimeAfter3Hours() {
            // ÁèæÂú®ÊôÇÂàª+3ÊôÇÈñìÂæå„ÅÆÊó•‰ªò„Å®ÊôÇÈñì„ÇíÊ≠£Á¢∫„Å´Ë®àÁÆó
            const now = new Date();
            const futureDate = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // 3ÊôÇÈñìÂæå
            
            const year = futureDate.getFullYear();
            const month = (futureDate.getMonth() + 1).toString().padStart(2, '0');
            const day = futureDate.getDate().toString().padStart(2, '0');
            const hours = futureDate.getHours();
            const minutes = futureDate.getMinutes();
            
            return {
                date: `${year}-${month}-${day}`,
                time: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`
            };
        }
        
        // Áµ±‰∏Ä„Ç´„Éº„Éâ‰ΩúÊàêÈñ¢Êï∞ÔºàÁîªÈù¢‰∏äÈÉ®„ÅÆ„Éú„Çø„É≥Áî®Ôºâ
        function createTaskUnified() {
            console.log('üìù [CREATE UNIFIED] Starting unified task creation...');
            editingTask = null;
            document.getElementById('modal-title').textContent = 'Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = getDefaultDeadlineString();
            document.getElementById('task-time-input').value = getDefaultTimeString();
            document.getElementById('task-priority-input').value = 'medium';
            document.getElementById('task-memo-input').value = '';
            document.getElementById('task-files-input').value = '';
            document.getElementById('attached-files-list').innerHTML = '';
            
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÇíÂàùÊúüÂåñ
            initializeTemplateSelector();
            
            // „Ç´„É©„É†ÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ„ÇíË°®Á§∫„Åó„ÄÅÂàùÊúüÂåñ
            const columnSelectionGroup = document.getElementById('column-selection-group');
            const columnSelect = document.getElementById('task-column-input');
            columnSelectionGroup.style.display = 'block';
            
            // „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // „Éá„Éï„Ç©„É´„Éà„ÅßÊúÄÂàù„ÅÆ„Ç´„É©„É†„ÇíÈÅ∏Êäû
            if (columns.length > 0) {
                columnSelect.value = columns[0].id;
            }
            
            // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            updateAssigneeOptions();
            clearSelectedAssignees();
            
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            updateProjectOptions();
            
            // „Ç≥„É°„É≥„ÉàË°®Á§∫„Çí„ÇØ„É™„Ç¢
            displayComments([]);
            
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÇíÁÑ°ÂäπÂåñÔºàÊñ∞Ë¶è„Çø„Çπ„ÇØ„ÅÆÂ†¥ÂêàÔºâ
            document.getElementById('comment-input').disabled = true;
            document.getElementById('comments-section').innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„Åß„Åô„ÄÇ‰øùÂ≠òÂæå„Å´„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ</div>';
            
            // PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï„Åó„Åü„Åü„ÇÅ„ÄÅ„Åì„ÅÆÂá¶ÁêÜ„ÅØ‰∏çË¶Å
            
            // Áµ±‰∏Ä‰ΩúÊàê„É¢„Éº„Éâ„ÇíË®≠ÂÆö
            document.getElementById('task-modal').dataset.unifiedMode = 'true';
            
            // „Éö„Éº„Ç∏„Éà„ÉÉ„Éó„Å´„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åã„Çâ„É¢„Éº„ÉÄ„É´Ë°®Á§∫
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´ÂÜçÂ∫¶„Éà„ÉÉ„Éó„Çπ„ÇØ„É≠„Éº„É´ÔºàÁ¢∫ÂÆü„Å´Ôºâ
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safari„Å´„ÇÇÂØæÂøú
                    document.documentElement.scrollTop = 0; // IE„Å´„ÇÇÂØæÂøú
                    
                    // „É¢„Éº„ÉÄ„É´Ëá™‰Ωì„ÇÇ‰∏äÈÉ®„Å´ÈÖçÁΩÆ„ÇíÂº∑Âà∂
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        // „Çø„Çπ„ÇØ‰ΩúÊàê„ÉªÁ∑®ÈõÜ
        function createTask(columnId) {
            editingTask = null;
            document.getElementById('modal-title').textContent = 'Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ';
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-date-input').value = getDefaultDeadlineString();
            document.getElementById('task-time-input').value = getDefaultTimeString();
            document.getElementById('task-priority-input').value = 'medium';
            document.getElementById('task-memo-input').value = '';
            document.getElementById('task-files-input').value = '';
            document.getElementById('attached-files-list').innerHTML = '';
            
            // „Ç´„É©„É†ÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫
            document.getElementById('column-selection-group').style.display = 'none';
            document.getElementById('task-column-input').removeAttribute('required');
            
            // PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï„Åó„Åü„Åü„ÇÅ„ÄÅ„Åì„ÅÆÂá¶ÁêÜ„ÅØ‰∏çË¶Å
            
            // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            updateAssigneeOptions();
            clearSelectedAssignees();
            
            // „Ç≥„É°„É≥„ÉàË°®Á§∫„Çí„ÇØ„É™„Ç¢
            displayComments([]);
            
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÇíÁÑ°ÂäπÂåñÔºàÊñ∞Ë¶è„Çø„Çπ„ÇØ„ÅÆÂ†¥ÂêàÔºâ
            document.getElementById('comment-input').disabled = true;
            document.getElementById('comments-section').innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„Åß„Åô„ÄÇ‰øùÂ≠òÂæå„Å´„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ</div>';
            
            // „Ç´„É©„É†ÊÉÖÂ†±„Çí‰øùÂ≠ò
            document.getElementById('task-modal').dataset.targetColumn = columnId;
            document.getElementById('task-modal').dataset.unifiedMode = 'false';
            // „Éö„Éº„Ç∏„Éà„ÉÉ„Éó„Å´„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åã„Çâ„É¢„Éº„ÉÄ„É´Ë°®Á§∫
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´ÂÜçÂ∫¶„Éà„ÉÉ„Éó„Çπ„ÇØ„É≠„Éº„É´ÔºàÁ¢∫ÂÆü„Å´Ôºâ
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safari„Å´„ÇÇÂØæÂøú
                    document.documentElement.scrollTop = 0; // IE„Å´„ÇÇÂØæÂøú
                    
                    // „É¢„Éº„ÉÄ„É´Ëá™‰Ωì„ÇÇ‰∏äÈÉ®„Å´ÈÖçÁΩÆ„ÇíÂº∑Âà∂
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        function updateAssigneeOptions() {
            const container = document.getElementById('assignees-container');
            container.innerHTML = '';
            
            assignees.forEach(assignee => {
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'assignee-checkbox';
                checkboxWrapper.innerHTML = `
                    <input type="checkbox" id="assignee-${assignee}" value="${assignee}" onchange="updateSelectedAssignees()">
                    <label for="assignee-${assignee}">${assignee}</label>
                `;
                container.appendChild(checkboxWrapper);
            });
            
            // Êñ∞Ë¶èËøΩÂä†„Éú„Çø„É≥
            const addButton = document.createElement('div');
            addButton.className = 'assignee-checkbox';
            addButton.style.cssText = 'color: #0079bf; font-weight: 500;';
            addButton.innerHTML = '+ Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖ„ÇíËøΩÂä†';
            addButton.onclick = addNewAssignee;
            container.appendChild(addButton);
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
        function updateProjectOptions() {
            try {
                const projectSelect = document.getElementById('task-project-select');
                if (!projectSelect) return;
                
                // „Éá„Éï„Ç©„É´„Éà„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊÆã„Åó„Å¶„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„Çí„ÇØ„É™„Ç¢
                projectSelect.innerHTML = '<option value="">ÂÄã‰∫∫„Çø„Çπ„ÇØÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„ÅóÔºâ</option>';
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíÂèñÂæó
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                const currentUser = getCurrentUser();
                
                if (projects.length === 0) {
                    return;
                }
                
                // „É¶„Éº„Ç∂„Éº„Åå„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                const accessibleProjects = projects.filter(project => {
                    // ÂÖ¨Èñã„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åæ„Åü„ÅØ„É°„É≥„Éê„Éº„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„ÅøË°®Á§∫
                    return project.status === 'active' && 
                           (project.visibility === 'public' || 
                            project.members.includes(currentUser.email) ||
                            project.createdBy === currentUser.email);
                });
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíËøΩÂä†
                accessibleProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    
                    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„Å®ÂÖ¨ÈñãÁä∂ÊÖã„ÇíË°®Á§∫
                    const visibilityIcon = project.visibility === 'public' ? 'üåê' : 'üîí';
                    const memberCount = project.members.length;
                    option.textContent = `${visibilityIcon} ${project.name} (${memberCount}Âêç)`;
                    
                    projectSelect.appendChild(option);
                });
                
                console.log(`‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞: ${accessibleProjects.length}ÂÄã„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà`);
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÅÆÊõ¥Êñ∞„Ç®„É©„Éº:', error);
            }
        }
        
        function updateSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const wrapper = checkbox.closest('.assignee-checkbox');
                if (checkbox.checked) {
                    wrapper.classList.add('checked');
                } else {
                    wrapper.classList.remove('checked');
                }
            });
        }
        
        function getSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function setSelectedAssignees(assigneeList) {
            // ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØÈÖçÂàó„Å´Â§âÊèõ
            if (typeof assigneeList === 'string') {
                assigneeList = assigneeList.split(',').map(a => a.trim()).filter(a => a);
            }
            
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = assigneeList.includes(checkbox.value);
                const wrapper = checkbox.closest('.assignee-checkbox');
                if (checkbox.checked) {
                    wrapper.classList.add('checked');
                } else {
                    wrapper.classList.remove('checked');
                }
            });
        }
        
        function clearSelectedAssignees() {
            const checkboxes = document.querySelectorAll('#assignees-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.assignee-checkbox').classList.remove('checked');
            });
        }
        
        function addNewAssignee() {
            const newAssignee = prompt('Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (newAssignee && newAssignee.trim()) {
                const trimmedName = newAssignee.trim();
                if (!assignees.includes(trimmedName)) {
                    assignees.push(trimmedName);
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                    updateAssigneeOptions();
                    // Êñ∞„Åó„ÅèËøΩÂä†„Åó„ÅüÊãÖÂΩìËÄÖ„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                    setTimeout(() => {
                        const newCheckbox = document.getElementById(`assignee-${trimmedName}`);
                        if (newCheckbox) {
                            newCheckbox.checked = true;
                            updateSelectedAssignees();
                        }
                    }, 100);
                }
            }
        }
        
        function editTask(taskId) {
            editingTask = tasks.find(t => t.id === taskId);
            if (!editingTask) return;
            
            // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºö‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ
            const currentUser = getCurrentUser();
            if (currentUser.role === 'user') {
                const canEdit = editingTask.assignees && editingTask.assignees.includes(currentUser.name) || 
                               editingTask.assignee === currentUser.name;
                if (!canEdit) {
                    alert('‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Çø„Çπ„ÇØ„ÅØÁ∑®ÈõÜ„Åß„Åç„Åæ„Åõ„Çì„ÄÇËá™ÂàÜ„ÅåÊãÖÂΩìËÄÖ„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ„Åß„Åô„ÄÇ');
                    return;
                }
            }
            
            document.getElementById('modal-title').textContent = '„Çø„Çπ„ÇØÁ∑®ÈõÜ';
            document.getElementById('task-title-input').value = editingTask.title;
            
            console.log('üîç [MODAL DEBUG] Setting up edit modal:');
            console.log('üîç [MODAL DEBUG] Original deadline:', editingTask.deadline);
            console.log('üîç [MODAL DEBUG] Split date part:', editingTask.deadline.split('T')[0]);
            console.log('üîç [MODAL DEBUG] Split time part:', editingTask.deadline.split('T')[1]);
            console.log('üîç [MODAL DEBUG] Time substring:', editingTask.deadline.split('T')[1].substring(0, 5));
            
            // ‚òÖ‚òÖ‚òÖ „Çø„Ç§„É†„Çæ„Éº„É≥ÂïèÈ°å„ÅÆ‰øÆÊ≠£ÔºöJST„ÅßÊ≠£„Åó„ÅèË°®Á§∫ ‚òÖ‚òÖ‚òÖ
            const deadlineDate = new Date(editingTask.deadline);
            const jstOffset = 9 * 60; // JST = UTC+9
            const localDate = new Date(deadlineDate.getTime() + (jstOffset * 60 * 1000));
            
            const dateStr = localDate.toISOString().split('T')[0];
            const timeStr = localDate.toISOString().split('T')[1].substring(0, 5);
            
            console.log('üîç [TIMEZONE FIX] Original deadline:', editingTask.deadline);
            console.log('üîç [TIMEZONE FIX] Deadline as Date object:', deadlineDate);
            console.log('üîç [TIMEZONE FIX] Adjusted for JST:', localDate.toISOString()); 
            console.log('üîç [TIMEZONE FIX] Date string for form:', dateStr);
            console.log('üîç [TIMEZONE FIX] Time string for form:', timeStr);
            
            document.getElementById('task-date-input').value = dateStr;
            document.getElementById('task-time-input').value = timeStr;
            
            console.log('üîç [MODAL DEBUG] After setting form values:');
            console.log('üîç [MODAL DEBUG] Date input now:', document.getElementById('task-date-input').value);
            console.log('üîç [MODAL DEBUG] Time input now:', document.getElementById('task-time-input').value);
            document.getElementById('task-priority-input').value = editingTask.priority;
            document.getElementById('task-memo-input').value = editingTask.memo || '';
            
            // „Ç´„É©„É†ÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫ÔºàÁ∑®ÈõÜÊôÇ„ÅØ‰∏çË¶ÅÔºâ
            document.getElementById('column-selection-group').style.display = 'none';
            document.getElementById('task-column-input').removeAttribute('required');
            
            // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞„Åó„Å¶„Åã„ÇâÂÄ§„ÇíË®≠ÂÆö
            updateAssigneeOptions();
            setSelectedAssignees(editingTask.assignees || editingTask.assignee || []);
            
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞„Åó„Å¶„Åã„ÇâÂÄ§„ÇíË®≠ÂÆö
            updateProjectOptions();
            const projectSelect = document.getElementById('task-project-select');
            if (projectSelect && editingTask.projectId) {
                projectSelect.value = editingTask.projectId;
            }
            
            // Phase 2: PJ„Çø„Çπ„ÇØÁ∑®ÈõÜÊôÇ„ÅØPJË®≠ÂÆö„ÇíÈùûË°®Á§∫Ôºà‰ΩúÊàêÊôÇ„ÅÆ„Åø‰ΩøÁî®Ôºâ
            // PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï
            
            // PJ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅØ„Çø„Ç§„Éà„É´„Å´Ë°®Á§∫
            const isPJTask = editingTask.projectId && editingTask.projectId !== null;
            if (isPJTask) {
                document.getElementById('modal-title').textContent = `üë• PJ„Çø„Çπ„ÇØÁ∑®ÈõÜ: ${editingTask.projectId}`;
                console.log(`üéØ [EDIT] Editing PJ task: ${editingTask.projectId} - ${editingTask.projectName}`);
            } else {
                console.log(`üë§ [EDIT] Editing personal task: ${editingTask.title}`);
            }
            
            // Ê∑ª‰ªò„Éï„Ç°„Ç§„É´Ë°®Á§∫
            displayAttachedFiles(editingTask.attachments || []);
            
            // „Ç≥„É°„É≥„ÉàË°®Á§∫
            displayComments(editingTask.comments || []);
            
            // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„ÇíÊúâÂäπÂåñ
            document.getElementById('comment-input').disabled = false;
            
            // „Éö„Éº„Ç∏„Éà„ÉÉ„Éó„Å´„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åã„Çâ„É¢„Éº„ÉÄ„É´Ë°®Á§∫
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                document.getElementById('task-modal').classList.add('show');
                
                // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´ÂÜçÂ∫¶„Éà„ÉÉ„Éó„Çπ„ÇØ„É≠„Éº„É´ÔºàÁ¢∫ÂÆü„Å´Ôºâ
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0; // Safari„Å´„ÇÇÂØæÂøú
                    document.documentElement.scrollTop = 0; // IE„Å´„ÇÇÂØæÂøú
                    
                    // „É¢„Éº„ÉÄ„É´Ëá™‰Ωì„ÇÇ‰∏äÈÉ®„Å´ÈÖçÁΩÆ„ÇíÂº∑Âà∂
                    const modalElement = document.getElementById('task-modal');
                    if (modalElement) {
                        modalElement.style.top = '0px';
                        modalElement.scrollTop = 0;
                    }
                }, 10);
                
                // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
                setTimeout(() => initMentionListeners(), 100);
            }, 50);
        }
        
        function displayAttachedFiles(attachments) {
            const container = document.getElementById('attached-files-list');
            container.innerHTML = '';
            
            if (attachments.length === 0) return;
            
            const previewDiv = document.createElement('div');
            previewDiv.className = 'file-preview';
            
            attachments.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.onclick = () => previewFile(file, index);
                
                // „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Éó„É¨„Éì„É•„Éº
                if (file.type && file.type.startsWith('image/') && file.dataUrl) {
                    fileItem.innerHTML = `
                        <img src="${file.dataUrl}" class="file-preview-thumbnail" alt="${file.name}">
                        <div style="font-size: 0.6rem; margin-top: 0.2rem;">${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}</div>
                        <button type="button" onclick="event.stopPropagation(); removeAttachment(${index})" style="background: #e53e3e; color: white; border: none; padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.6rem; cursor: pointer; margin-top: 0.2rem;">ÂâäÈô§</button>
                    `;
                } else {
                    const fileIcon = getFileIcon(file.type);
                    fileItem.innerHTML = `
                        <div style="font-size: 1.5rem; margin-bottom: 0.2rem;">${fileIcon}</div>
                        <div style="font-size: 0.6rem; margin-bottom: 0.2rem;">${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}</div>
                        <button type="button" onclick="event.stopPropagation(); removeAttachment(${index})" style="background: #e53e3e; color: white; border: none; padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.6rem; cursor: pointer;">ÂâäÈô§</button>
                    `;
                }
                
                previewDiv.appendChild(fileItem);
            });
            
            container.appendChild(previewDiv);
        }
        
        function getFileIcon(fileType) {
            if (!fileType) return 'üìÑ';
            if (fileType.startsWith('image/')) return 'üñºÔ∏è';
            if (fileType.includes('pdf')) return 'üìï';
            if (fileType.includes('word') || fileType.includes('document')) return 'üìù';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìä';
            if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'üìà';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'üóúÔ∏è';
            return 'üìÑ';
        }
        
        function previewFile(file, index) {
            if (file.dataUrl && file.type.startsWith('image/')) {
                // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
                modal.onclick = () => document.body.removeChild(modal);
                
                const img = document.createElement('img');
                img.src = file.dataUrl;
                img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
                
                modal.appendChild(img);
                document.body.appendChild(modal);
            } else {
                alert(`„Éï„Ç°„Ç§„É´: ${file.name}\n„Çµ„Ç§„Ç∫: ${(file.size / 1024).toFixed(1)}KB\n„Çø„Ç§„Éó: ${file.type || '‰∏çÊòé'}`);
            }
        }
        
        function removeAttachment(index) {
            if (editingTask && editingTask.attachments) {
                editingTask.attachments.splice(index, 1);
                // ‚òÖ‚òÖ‚òÖ ÈáçË¶ÅÔºötasksÈÖçÂàóÂÜÖ„ÅÆ„Çø„Çπ„ÇØÂÖ®‰Ωì„ÇíÂêåÊúü ‚òÖ‚òÖ‚òÖ
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('üîç [ATTACHMENT SYNC] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('üîç [ATTACHMENT SYNC] Before sync - Task exists:', !!tasks[taskIndex]);
                    // editingTaskÂÖ®‰Ωì„ÇítasksÈÖçÂàó„Å´ÂêåÊúü
                    tasks[taskIndex] = { ...editingTask };
                    console.log('üîç [ATTACHMENT SYNC] After sync - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        attachmentsCount: tasks[taskIndex].attachments ? tasks[taskIndex].attachments.length : 0
                    });
                    saveTasks();
                } else {
                    console.error('‚ùå [ATTACHMENT SYNC] Task not found in tasks array! EditingTask ID:', editingTask.id);
                }
                displayAttachedFiles(editingTask.attachments);
                
                // ÁîªÈù¢„ÇíÂÜçÊèèÁîª„Åó„Å¶„Ç´„Éº„Éâ„ÅåÊ∂àÂ§±„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
                render();
            }
        }
        
        // „Ç≥„É°„É≥„ÉàÊ©üËÉΩ
        function displayComments(comments) {
            const container = document.getElementById('comments-section');
            if (!comments || comments.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 2rem;">„Åæ„Å†„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            container.innerHTML = comments.map(comment => {
                const commentDate = new Date(comment.timestamp);
                const timeAgo = getTimeAgo(commentDate);
                const processedText = processMentions(comment.text);
                
                return `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-time">${timeAgo}</span>
                        </div>
                        <div class="comment-body">${processedText}</div>
                    </div>
                `;
            }).join('');
            
            // ÊúÄÊñ∞„Ç≥„É°„É≥„Éà„Å´„Çπ„ÇØ„É≠„Éº„É´
            container.scrollTop = container.scrollHeight;
        }
        
        function processMentions(text) {
            // @„É¶„Éº„Ç∂„ÉºÂêç„Çí„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫„Å´Â§âÊèõ
            return text.replace(/@(\w+[^\s]*)/g, '<span class="mention">@$1</span>');
        }
        
        // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ
        let mentionSuggestionIndex = -1;
        let mentionStartPos = -1;
        let mentionQuery = '';
        
        function setupMentionSystem() {
            // „É¢„Éº„ÉÄ„É´„ÅåÈñã„Åã„Çå„Åü„Å®„Åç„Å´ÂàùÊúüÂåñ„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            // editTask „Å® openTaskModal ÂÜÖ„ÅßÂëº„Å≥Âá∫„Åï„Çå„Çã
        }
        
        function initMentionListeners() {
            const commentInput = document.getElementById('comment-input');
            if (!commentInput) return;
            
            // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂâäÈô§„Åó„Å¶ÈáçË§á„ÇíÈò≤„Åê
            commentInput.removeEventListener('input', handleMentionInput);
            commentInput.removeEventListener('keydown', handleMentionKeydown);
            
            commentInput.addEventListener('input', handleMentionInput);
            commentInput.addEventListener('keydown', handleMentionKeydown);
            
            // „Éï„Ç©„Éº„Ç´„ÇπÂ§ñ„Çå„Åü„Å®„Åç„ÅØÂÄôË£ú„ÇíÈùûË°®Á§∫
            commentInput.addEventListener('blur', () => {
                setTimeout(() => hideMentionSuggestions(), 200);
            });
        }
        
        function handleMentionInput(e) {
            const input = e.target;
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            // @„Éû„Éº„ÇØ„ÅÆ‰ΩçÁΩÆ„ÇíÊé¢„Åô
            let atPos = -1;
            for (let i = cursorPos - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atPos = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }
            
            if (atPos !== -1) {
                mentionStartPos = atPos;
                mentionQuery = text.substring(atPos + 1, cursorPos);
                showMentionSuggestions(mentionQuery, input);
            } else {
                hideMentionSuggestions();
            }
        }
        
        function handleMentionKeydown(e) {
            const suggestions = document.getElementById('mention-suggestions');
            if (suggestions.style.display === 'none') return;
            
            const suggestionItems = suggestions.querySelectorAll('.mention-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                mentionSuggestionIndex = Math.min(mentionSuggestionIndex + 1, suggestionItems.length - 1);
                updateMentionSelection(suggestionItems);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                mentionSuggestionIndex = Math.max(mentionSuggestionIndex - 1, 0);
                updateMentionSelection(suggestionItems);
            } else if (e.key === 'Enter' && mentionSuggestionIndex >= 0) {
                e.preventDefault();
                const selectedItem = suggestionItems[mentionSuggestionIndex];
                if (selectedItem) {
                    insertMention(selectedItem.textContent);
                }
            } else if (e.key === 'Escape') {
                hideMentionSuggestions();
            }
        }
        
        function showMentionSuggestions(query, input) {
            const suggestions = document.getElementById('mention-suggestions');
            const availableUsers = [...new Set([...assignees])];
            
            const filteredUsers = availableUsers.filter(user => 
                user.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);
            
            if (filteredUsers.length === 0) {
                hideMentionSuggestions();
                return;
            }
            
            suggestions.innerHTML = filteredUsers.map((user, index) => 
                `<div class="mention-suggestion" onclick="insertMention('${user}')">${user}</div>`
            ).join('');
            
            // ‰ΩçÁΩÆ„ÇíË™øÊï¥
            const rect = input.getBoundingClientRect();
            suggestions.style.left = '10px';
            suggestions.style.bottom = '60px';
            suggestions.style.display = 'block';
            
            mentionSuggestionIndex = -1;
        }
        
        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === mentionSuggestionIndex);
            });
        }
        
        function insertMention(userName) {
            const input = document.getElementById('comment-input');
            const text = input.value;
            const beforeMention = text.substring(0, mentionStartPos);
            const afterMention = text.substring(input.selectionStart);
            
            const newText = `${beforeMention}@${userName} ${afterMention}`;
            input.value = newText;
            
            // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíË™øÊï¥
            const newCursorPos = mentionStartPos + userName.length + 2;
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            hideMentionSuggestions();
            input.focus();
        }
        
        function hideMentionSuggestions() {
            const suggestions = document.getElementById('mention-suggestions');
            suggestions.style.display = 'none';
            mentionSuggestionIndex = -1;
            mentionStartPos = -1;
            mentionQuery = '';
        }
        
        function addComment() {
            console.log('üìù [COMMENT] addComment function called');
            console.log('üìù [COMMENT] Function context:', typeof addComment, window.addComment === addComment);
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            
            console.log('üìù [COMMENT] Comment text:', commentText);
            console.log('üìù [COMMENT] editingTask:', editingTask);
            
            if (!commentText) {
                alert('„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!editingTask) {
                console.error('‚ùå [COMMENT] No editing task found!');
                alert('„Ç®„É©„Éº: Á∑®ÈõÜ‰∏≠„ÅÆ„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂèñÂæóÔºà„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„Åã„ÇâÂÑ™ÂÖàÂèñÂæóÔºâ
            let currentUser = '„É¶„Éº„Ç∂„Éº';
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (session && session.user && session.user.name) {
                    currentUser = session.user.name;
                    console.log(`üìù [COMMENT] „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº: ${currentUser}`);
                } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Åã„ÇâÂèñÂæó
                    currentUser = document.getElementById('assignee-filter')?.value || '„É¶„Éº„Ç∂„Éº';
                    console.log(`üìù [COMMENT] „Éï„Ç£„É´„Çø„Åã„ÇâÂèñÂæó: ${currentUser}`);
                }
            } catch (error) {
                console.log(`‚ö†Ô∏è [COMMENT] „É¶„Éº„Ç∂„ÉºÂêçÂèñÂæó„Ç®„É©„Éº:`, error);
                currentUser = '„É¶„Éº„Ç∂„Éº';
            }
            
            const newComment = {
                id: Date.now(),
                author: currentUser || '„É¶„Éº„Ç∂„Éº',
                text: commentText,
                timestamp: new Date().toISOString()
            };
            
            // editingTask„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁ∑®ÈõÜ‰∏≠„ÅÆ„Çø„Çπ„ÇØ„Å´„ÄÅ„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰ΩúÊàê
            if (editingTask) {
                // Á∑®ÈõÜ‰∏≠„ÅÆ„Çø„Çπ„ÇØ„Å´„Ç≥„É°„É≥„ÉàËøΩÂä†
                if (!editingTask.comments) editingTask.comments = [];
                editingTask.comments.push(newComment);
                
                // ‚òÖ‚òÖ‚òÖ ÈáçË¶ÅÔºötasksÈÖçÂàóÂÜÖ„ÅÆ„Çø„Çπ„ÇØÂÖ®‰Ωì„ÇíÂêåÊúü ‚òÖ‚òÖ‚òÖ
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('üîç [COMMENT SYNC] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('üîç [COMMENT SYNC] Before sync - Task exists:', !!tasks[taskIndex]);
                    // editingTaskÂÖ®‰Ωì„ÇítasksÈÖçÂàó„Å´ÂêåÊúü
                    tasks[taskIndex] = { ...editingTask };
                    console.log('üîç [COMMENT SYNC] After sync - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        commentsCount: tasks[taskIndex].comments ? tasks[taskIndex].comments.length : 0
                    });
                } else {
                    console.error('‚ùå [COMMENT SYNC] Task not found in tasks array! EditingTask ID:', editingTask.id);
                }
                
                console.log('üìù [COMMENT] About to save tasks and render');
                saveTasks();
                displayComments(editingTask.comments);
                
                console.log('üìù [COMMENT] About to call render()');
                // ÁîªÈù¢„ÇíÂÜçÊèèÁîª„Åó„Å¶„Ç´„Éº„Éâ„ÅåÊ∂àÂ§±„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
                render();
                console.log('üìù [COMMENT] render() completed');
                
                // „É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•„ÅØÁ∑®ÈõÜ‰øùÂ≠òÊôÇ„Å´ÂÆüË°å„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÂÆüË°å„Åó„Å™„ÅÑ
            }
            
            // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
            commentInput.value = '';
            
        }
        
        // addCommentÈñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÁôªÈå≤
        window.addComment = addComment;
        
        function checkMentionNotifications(text, author, task) {
            console.log(`üîç [MENTION] „ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã: "${text}" by ${author}`);
            console.log(`üîç [MENTION] ÁèæÂú®„ÅÆÊãÖÂΩìËÄÖ„É™„Çπ„Éà:`, assignees);
            
            // @„É°„É≥„Ç∑„Éß„É≥„ÇíÊ§úÂá∫ÔºàÊó•Êú¨Ë™ûÊñáÂ≠óÂØæÂøúÔºâ
            const mentionPattern = /@([^\s@]+)/g;
            const mentions = text.match(mentionPattern);
            console.log(`üîç [MENTION] ‰ΩøÁî®„Åó„ÅüÊ≠£Ë¶èË°®Áèæ: ${mentionPattern}`);
            
            console.log(`üîç [MENTION] Ê§úÂá∫„Åï„Çå„Åü„É°„É≥„Ç∑„Éß„É≥:`, mentions);
            
            if (mentions) {
                mentions.forEach(mention => {
                    const mentionedUser = mention.substring(1); // @„ÇíÈô§Âéª
                    console.log(`üîç [MENTION] Âá¶ÁêÜ‰∏≠: ${mention} ‚Üí „É¶„Éº„Ç∂„ÉºÂêç: ${mentionedUser}`);
                    console.log(`üîç [MENTION] ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„Å´Â≠òÂú®: ${assignees.includes(mentionedUser)}`);
                    
                    // „É°„É≥„Ç∑„Éß„É≥„Åï„Çå„Åü„É¶„Éº„Ç∂„Éº„ÅåÊãÖÂΩìËÄÖ„É™„Çπ„Éà„Å´Â≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºà„ÉÜ„Çπ„ÉàÁî®„Å´Ëá™Â∑±„É°„É≥„Ç∑„Éß„É≥„ÇÇË®±ÂèØÔºâ
                    if (assignees.includes(mentionedUser)) {
                        console.log(`‚úÖ [MENTION] ÈÄöÁü•ÈÄÅ‰ø°Ê∫ñÂÇô: ${mentionedUser}`);
                        
                        // Ëá™ÂàÜËá™Ë∫´„Å∏„ÅÆ„É°„É≥„Ç∑„Éß„É≥„Åã„Å©„ÅÜ„Åã„ÅßÈÄöÁü•ÂÜÖÂÆπ„ÇíÂ§âÊõ¥
                        const notificationTitle = mentionedUser === author ? 'üí¨ „Çª„É´„Éï„É°„É≥„Ç∑„Éß„É≥Ôºà„ÉÜ„Çπ„ÉàÔºâ' : 'üí¨ „É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•';
                        const shortComment = text.length > 50 ? text.substring(0, 50) + '...' : text;
                        const notificationBody = mentionedUser === author 
                            ? `„Äå${task.title}„Äç„Åß„Çª„É´„Éï„É°„É≥„Ç∑„Éß„É≥\nüí¨ ${shortComment}`
                            : `${author}„Åï„Çì„Åå„Äå${task.title}„Äç„Åß„É°„É≥„Ç∑„Éß„É≥\nüí¨ ${shortComment}`;
                        
                        console.log(`üîî [MENTION] ÈÄöÁü•ÂÆüË°å: ${notificationTitle} - ${notificationBody}`);
                        
                        showNotification(
                            notificationTitle,
                            notificationBody,
                            { 
                                tag: `mention-${Date.now()}`,
                                taskId: task.id,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üí¨</text></svg>'
                            }
                        );
                        
                        console.log(`‚úÖ [MENTION] ÈÄöÁü•ÈÄÅ‰ø°ÂÆå‰∫Ü: ${mentionedUser}„Åï„Çì`);
                    } else {
                        console.log(`‚ùå [MENTION] ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„Å´Â≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó: ${mentionedUser}`);
                    }
                });
            } else {
                console.log(`‚ùå [MENTION] „É°„É≥„Ç∑„Éß„É≥„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü`);
            }
        }
        
        function checkCollaborativeTaskNotifications(task, assignedUsers) {
            // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÔºà„Éá„É¢Áî®: ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„ÅÆÂÄ§„Çí‰ΩøÁî®Ôºâ
            const currentUser = document.getElementById('assignee-filter')?.value || '‰ΩúÊàêËÄÖ';
            
            // Ë§áÊï∞„ÅÆÊãÖÂΩìËÄÖ„ÅåÂâ≤„ÇäÂΩì„Å¶„Çâ„Çå„ÅüÂ†¥Âêà„ÄÅÂêÑÊãÖÂΩìËÄÖ„Å´ÈÄöÁü•
            if (assignedUsers && assignedUsers.length > 0) {
                assignedUsers.forEach(user => {
                    // Ëá™ÂàÜ‰ª•Â§ñ„ÅÆÊãÖÂΩìËÄÖ„Å´ÈÄöÁü•ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ„ÄÅ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„Å®ÊØîËºÉÔºâ
                    if (user !== currentUser) {
                        showNotification(
                            'üë• ÂÖ±Âêå„Çø„Çπ„ÇØÂâ≤„ÇäÂΩì„Å¶',
                            `${currentUser}„Åï„Çì„Åå„ÅÇ„Å™„Åü„Çí„Äå${task.title}„Äç„ÅÆÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü`,
                            { 
                                tag: `collab-${task.id}-${user}`,
                                taskId: task.id,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üë•</text></svg>'
                            }
                        );
                        
                        console.log(`ÂÖ±Âêå„Çø„Çπ„ÇØÈÄöÁü•: ${user}„Åï„Çì„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`);
                    }
                });
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return '„Åü„Å£„Åü‰ªä';
            if (diffMins < 60) return `${diffMins}ÂàÜÂâç`;
            if (diffHours < 24) return `${diffHours}ÊôÇÈñìÂâç`;
            if (diffDays < 7) return `${diffDays}Êó•Ââç`;
            
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        async function saveTask(event) {
            try {
                console.log('üöÄ [SAVE TASK] Starting saveTask function...');
                event.preventDefault();
            
            // Á∑®ÈõÜ„É¢„Éº„ÉâÊôÇ„ÅØ task-column-input „ÅÆ required Â±ûÊÄß„Çí‰∏ÄÊôÇÁöÑ„Å´ÂâäÈô§
            const columnInput = document.getElementById('task-column-input');
            const columnSelectionGroup = document.getElementById('column-selection-group');
            const wasRequired = columnInput.hasAttribute('required');
            const isColumnSelectionHidden = columnSelectionGroup.style.display === 'none';
            
            if (isColumnSelectionHidden && wasRequired) {
                columnInput.removeAttribute('required');
                console.log(`üîß [FORM] Temporarily removed required attribute from task-column-input`);
            }
            
            const title = document.getElementById('task-title-input').value.trim();
            const date = document.getElementById('task-date-input').value;
            const time = document.getElementById('task-time-input').value;
            
            console.log('üîç [DEADLINE DEBUG] Form values:');
            console.log('üîç [DEADLINE DEBUG] Date input value:', date);
            console.log('üîç [DEADLINE DEBUG] Time input value:', time);
            console.log('üîç [DEADLINE DEBUG] Original deadline:', editingTask ? editingTask.deadline : 'new task');
            const priority = document.getElementById('task-priority-input').value;
            const selectedAssignees = getSelectedAssignees();
            const memo = document.getElementById('task-memo-input').value.trim();
            const fileInput = document.getElementById('task-files-input');
            
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÊÉÖÂ†±„ÇíÂèñÂæó
            const selectedProjectId = document.getElementById('task-project-select').value;
            const isProjectTask = selectedProjectId !== '';
            let projectId = '';
            let projectName = '';
            
            if (isProjectTask) {
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                const selectedProject = projects.find(p => p.id === selectedProjectId);
                if (selectedProject) {
                    projectId = selectedProject.id;
                    projectName = selectedProject.name;
                    console.log(`üìÇ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„Å®„Åó„Å¶‰ΩúÊàê: ${projectName} (${projectId})`);
                } else {
                    console.error('ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', selectedProjectId);
                    alert('ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
            }
            
            const selectedApprovers = [];
            
            if (!title || !date) {
                alert('„Çø„Çπ„ÇØÂêç„Å®ÊúüÈôêÊó•„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }
            
            // Phase 2: PJ„Çø„Çπ„ÇØÈñ¢ÈÄ£„ÅÆÂ§âÊï∞„Çí‰∫ãÂâç„Å´ÂÆöÁæ©
            let finalApprovers = [];
            
            // Phase 2: PJ„Çø„Çπ„ÇØ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (isProjectTask) {
                console.log(`üîç [PJ VALIDATION] ProjectID: "${projectId}", ProjectName: "${projectName}", Approvers: [${selectedApprovers.join(', ')}]`);
                
                if (!projectId || !projectName) {
                    alert('PJ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàID„Å®„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÅØÂøÖÈ†à„Åß„Åô');
                    // requiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª„Åï„Åõ„Å¶„Åã„Çâreturn
                    if (wasRequired && isColumnSelectionHidden) {
                        columnInput.setAttribute('required', '');
                    }
                    return;
                }
                if (selectedApprovers.length === 0) {
                    // ÊâøË™çËÄÖ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØËá™Âãï„ÅßÊãÖÂΩìËÄÖ„ÇíÊâøË™çËÄÖ„Å´Ë®≠ÂÆö
                    if (selectedAssignees.length > 0) {
                        console.log(`‚ö†Ô∏è [PJ VALIDATION] No approvers selected, using assignees as approvers: [${selectedAssignees.join(', ')}]`);
                        // ÊâøË™çËÄÖ„ÇíËá™ÂãïË®≠ÂÆöÔºàÊãÖÂΩìËÄÖ„ÅÆ‰∏≠„Åã„ÇâÔºâ
                        const approverCheckboxes = document.querySelectorAll('#project-approvers input[type="checkbox"]');
                        approverCheckboxes.forEach(cb => {
                            if (selectedAssignees.includes(cb.value)) {
                                cb.checked = true;
                            }
                        });
                        // ÂÜçÂ∫¶ÂèñÂæó
                        const autoSelectedApprovers = getSelectedApprovers();
                        if (autoSelectedApprovers.length === 0) {
                            alert('PJ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÄÅÊâøË™çËÄÖ„Çí1Âêç‰ª•‰∏äÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n\n‚Äª ÊâøË™çËÄÖ‰∏ÄË¶ß„Åã„Çâ1Âêç‰ª•‰∏ä„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n‚Äª „Åæ„Åü„ÅØÊãÖÂΩìËÄÖ„ÇíÂÖà„Å´ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                            // requiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª„Åï„Åõ„Å¶„Åã„Çâreturn
                            if (wasRequired && isColumnSelectionHidden) {
                                columnInput.setAttribute('required', '');
                            }
                            return;
                        }
                    } else {
                        alert('PJ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÄÅÊâøË™çËÄÖ„Çí1Âêç‰ª•‰∏äÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n\n‚Äª ÊâøË™çËÄÖ‰∏ÄË¶ß„Åã„Çâ1Âêç‰ª•‰∏ä„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n‚Äª „Åæ„Åü„ÅØÊãÖÂΩìËÄÖ„ÇíÂÖà„Å´ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                        // requiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª„Åï„Åõ„Å¶„Åã„Çâreturn
                        if (wasRequired && isColumnSelectionHidden) {
                            columnInput.setAttribute('required', '');
                        }
                        return;
                    }
                }
                finalApprovers = getSelectedApprovers(); // ÊúÄÊñ∞„ÅÆÊâøË™çËÄÖ„ÇíÂèñÂæó
                console.log(`üéØ [PJ TASK] Creating project task: ${projectId} - ${projectName} with approvers: [${finalApprovers.join(', ')}]`);
            }
            
            if (selectedAssignees.length === 0) {
                if (!confirm('ÊãÖÂΩìËÄÖ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                    return;
                }
            }
            
            // ‚òÖ‚òÖ‚òÖ „Çø„Ç§„É†„Çæ„Éº„É≥ÂïèÈ°å„ÅÆ‰øÆÊ≠£ÔºöÁ∑®ÈõÜÊôÇ„ÅÆ„ÅøJSTË£úÊ≠£ ‚òÖ‚òÖ‚òÖ
            let deadline;
            if (editingTask) {
                // Á∑®ÈõÜÊôÇÔºö„É≠„Éº„Ç´„É´ÊôÇÈñì„Å®„Åó„Å¶Ëß£Èáà„Åó„Å¶UTC„Å´Â§âÊèõ
                const localDateTime = `${date}T${time || '23:59'}`;
                const localDate = new Date(localDateTime);
                console.log('üîç [TIMEZONE SAVE] Edit mode - Local datetime string:', localDateTime);
                console.log('üîç [TIMEZONE SAVE] Edit mode - Local date object:', localDate);
                console.log('üîç [TIMEZONE SAVE] Edit mode - UTC conversion:', localDate.toISOString());
                deadline = localDate;
            } else {
                // Êñ∞Ë¶è‰ΩúÊàêÊôÇÔºöÂæìÊù•ÈÄö„Çä„ÅÆÂá¶ÁêÜÔºàÂ§âÊõ¥„Å™„ÅóÔºâ
                deadline = new Date(`${date}T${time || '23:59'}`);
                console.log('üîç [TIMEZONE SAVE] New task mode - No timezone adjustment');
            }
            
            console.log('üîç [DEADLINE DEBUG] Constructed deadline:');
            console.log('üîç [DEADLINE DEBUG] Date string:', `${date}T${time || '23:59'}`);
            console.log('üîç [DEADLINE DEBUG] Deadline object:', deadline);
            console.log('üîç [DEADLINE DEBUG] Deadline ISO:', deadline.toISOString());
            console.log('üîç [DEADLINE DEBUG] Current time:', new Date().toISOString());
            console.log('üîç [DEADLINE DEBUG] Is future deadline:', deadline > new Date());
            
            // Ê∑ª‰ªò„Éï„Ç°„Ç§„É´Âá¶ÁêÜ
            const attachments = [];
            if (fileInput.files.length > 0) {
                const fileProcessingPromises = Array.from(fileInput.files).map(file => {
                    return new Promise((resolve, reject) => {
                        // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫Âà∂Èôê (5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            reject(`„Éï„Ç°„Ç§„É´ "${file.name}" „ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºà5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ`);
                            return;
                        }
                        
                        const fileInfo = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            lastModified: file.lastModified
                        };
                        
                        // ÁîªÂÉè„ÅÆÂ†¥Âêà„ÅØ„Éó„É¨„Éì„É•„ÉºÁî®„ÅÆ„Éá„Éº„ÇøURL„ÇíÁîüÊàê
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                fileInfo.dataUrl = e.target.result;
                                resolve(fileInfo);
                            };
                            reader.onerror = () => resolve(fileInfo);
                            reader.readAsDataURL(file);
                        } else {
                            resolve(fileInfo);
                        }
                    });
                });
                
                try {
                    const processedFiles = await Promise.all(fileProcessingPromises);
                    attachments.push(...processedFiles);
                } catch (error) {
                    alert(error);
                    return;
                }
            }
            
            if (editingTask) {
                // ÊúüÈôêÂ§âÊõ¥„ÅÆÁ¢∫Ë™çÂá¶ÁêÜ
                const oldDeadline = new Date(editingTask.deadline);
                const newDeadline = deadline;
                const wasOverdue = isOverdue(editingTask.deadline, editingTask.columnId);
                const willBeOverdue = isOverdue(newDeadline.toISOString(), editingTask.columnId);
                
                console.log(`üîç [DEADLINE] Checking deadline change for task ${editingTask.id}`);
                console.log(`üîç [DEADLINE] Old deadline: ${editingTask.deadline}, wasOverdue: ${wasOverdue}`);
                console.log(`üîç [DEADLINE] New deadline: ${newDeadline.toISOString()}, willBeOverdue: ${willBeOverdue}`);
                console.log(`üîç [DEADLINE] Task column: ${editingTask.columnId}`);
                
                // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÅÆÊúüÈôê„ÅåÂª∂Èï∑„Åï„Çå„ÅüÂ†¥Âêà„ÅÆÁ¢∫Ë™ç
                if (wasOverdue && !willBeOverdue) {
                    console.log(`üìÖ [DEADLINE] Overdue task deadline extended, showing confirmation dialog`);
                    const columnTitle = getColumnTitle(editingTask.columnId);
                    const shouldMoveBack = confirm(
                        `üìÖ ÊúüÈôê„ÅåÂª∂Èï∑„Åï„Çå„Åæ„Åó„Åü\n\n` +
                        `"${editingTask.title}" „ÅÆÊúüÈôê„ÅåÂª∂Èï∑„Åï„Çå„ÄÅÊúüÈôêÂàá„Çå„Åß„ÅØ„Å™„Åè„Å™„Çä„Åæ„Åô„ÄÇ\n\n` +
                        `ÂÖÉ„ÅÆÈÄ≤ÊçóÁä∂Ê≥Å„Äå${columnTitle}„Äç„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                        `‚Ä¢ OK: ${columnTitle}„Å´Êàª„Åô\n` +
                        `‚Ä¢ „Ç≠„É£„É≥„Çª„É´: ÊúüÈôêÂàá„Çå„Ç®„É™„Ç¢„Å´ÊÆã„Åô`
                    );
                    
                    if (!shouldMoveBack) {
                        // „É¶„Éº„Ç∂„Éº„ÅåÊúüÈôêÂàá„Çå„Ç®„É™„Ç¢„Å´ÊÆã„Åô„Åì„Å®„ÇíÈÅ∏Êäû„Åó„ÅüÂ†¥Âêà„ÄÅ
                        // ÊúüÈôê„ÇíÂÖÉ„Å´Êàª„Åó„Å¶ÊúüÈôêÂàá„Çå„ÅÆ„Åæ„Åæ„Å´„Åô„Çã
                        if (confirm('ÊúüÈôêÂ§âÊõ¥„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Å¶„ÄÅÂÖÉ„ÅÆÊúüÈôê„ÅÆ„Åæ„Åæ„Å´„Åó„Åæ„Åô„ÅãÔºü')) {
                            console.log(`‚ö†Ô∏è User chose to cancel deadline change for task ${editingTask.id}`);
                            closeModal();
                            return;
                        }
                    }
                    console.log(`üìÖ Deadline extended for overdue task ${editingTask.id}, moving back: ${shouldMoveBack}`);
                } else {
                    console.log(`üîç [DEADLINE] No confirmation needed: wasOverdue=${wasOverdue}, willBeOverdue=${willBeOverdue}`);
                }
                
                // Á∑®ÈõÜ
                console.log('üîç [EDIT] Before updating editingTask:', {
                    id: editingTask.id,
                    title: editingTask.title,
                    projectId: editingTask.projectId,
                    projectName: editingTask.projectName,
                    columnId: editingTask.columnId
                });
                
                editingTask.title = title;
                editingTask.deadline = deadline.toISOString();
                editingTask.priority = priority;
                editingTask.assignees = selectedAssignees;
                // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÂè§„ÅÑassignee„Éï„Ç£„Éº„É´„Éâ„ÇÇ‰øùÊåÅ
                editingTask.assignee = selectedAssignees.length > 0 ? selectedAssignees[0] : 'Êú™Ë®≠ÂÆö';
                editingTask.memo = memo;
                editingTask.updatedAt = new Date().toISOString(); // Êõ¥Êñ∞ÊôÇÂàª„ÇíË®òÈå≤
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                if (isProjectTask) {
                    editingTask.projectId = projectId;
                    editingTask.projectName = projectName;
                } else {
                    editingTask.projectId = null;
                    editingTask.projectName = null;
                }
                
                console.log('üîç [EDIT] After updating editingTask:', {
                    id: editingTask.id,
                    title: editingTask.title,
                    projectId: editingTask.projectId,
                    projectName: editingTask.projectName,
                    columnId: editingTask.columnId
                });
                
                // Phase 2: PJ„Çø„Çπ„ÇØ„ÅÆÁ∑®ÈõÜ„Åß„ÅØPJÊÉÖÂ†±„ÅØÂ§âÊõ¥„Åó„Å™„ÅÑ
                console.log(`üìù [TASK EDIT] Updated task: ${editingTask.title}`);
                
                // Êñ∞„Åó„ÅÑÊ∑ª‰ªò„Éï„Ç°„Ç§„É´„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
                if (attachments.length > 0) {
                    if (!editingTask.attachments) editingTask.attachments = [];
                    editingTask.attachments.push(...attachments);
                }
                
                // ‚òÖ‚òÖ‚òÖ ÈáçË¶ÅÔºötasksÈÖçÂàóÂÜÖ„ÅÆÂØæÂøú„Åô„Çã„Çø„Çπ„ÇØ„ÇÇÊõ¥Êñ∞ ‚òÖ‚òÖ‚òÖ
                const taskIndex = tasks.findIndex(t => t.id === editingTask.id);
                console.log('üîç [CRITICAL] Task index in tasks array:', taskIndex);
                
                if (taskIndex !== -1) {
                    console.log('üîç [CRITICAL] Before updating tasks array - Task exists:', !!tasks[taskIndex]);
                    // editingTask„ÅÆÂÖ®„Å¶„ÅÆÂ§âÊõ¥„ÇítasksÈÖçÂàó„Å´ÂèçÊò†
                    tasks[taskIndex] = { ...editingTask };
                    console.log('üîç [CRITICAL] After updating tasks array - Updated task:', {
                        id: tasks[taskIndex].id,
                        title: tasks[taskIndex].title,
                        projectId: tasks[taskIndex].projectId,
                        columnId: tasks[taskIndex].columnId
                    });
                } else {
                    console.error('‚ùå [CRITICAL] Task not found in tasks array! EditingTask ID:', editingTask.id);
                    console.log('üîç [CRITICAL] Current tasks array IDs:', tasks.map(t => t.id));
                }
            } else {
                // Êñ∞Ë¶è‰ΩúÊàê
                const isUnifiedMode = document.getElementById('task-modal').dataset.unifiedMode === 'true';
                const targetColumn = isUnifiedMode 
                    ? document.getElementById('task-column-input').value 
                    : document.getElementById('task-modal').dataset.targetColumn;
                const newTask = {
                    id: Date.now(),
                    title: title,
                    deadline: deadline.toISOString(),
                    priority: priority,
                    assignees: selectedAssignees,
                    // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÂè§„ÅÑassignee„Éï„Ç£„Éº„É´„Éâ„ÇÇ‰øùÊåÅ
                    assignee: selectedAssignees.length > 0 ? selectedAssignees[0] : 'Êú™Ë®≠ÂÆö',
                    memo: memo,
                    attachments: attachments,
                    comments: [],
                    columnId: targetColumn,
                    completed: targetColumn === 'done',
                    createdAt: new Date().toISOString(),
                    
                    // Phase 2: PJ„Çø„Çπ„ÇØÊã°Âºµ„Éï„Ç£„Éº„É´„Éâ
                    projectId: isProjectTask ? projectId : null,
                    projectName: isProjectTask ? projectName : null,
                    personalStatus: targetColumn,
                    projectStatus: targetColumn,
                    pendingMove: null,
                    approvers: isProjectTask ? finalApprovers : [],
                    lastApprovedBy: null,
                    approvedAt: null
                };
                
                if (isProjectTask) {
                    console.log(`üéØ [PJ TASK CREATE] Created new PJ task: ${projectId} - ${projectName}, approvers: ${finalApprovers.join(', ')}`);
                } else {
                    console.log(`üë§ [PERSONAL TASK CREATE] Created new personal task: ${title}`);
                }
                tasks.unshift(newTask);
                
                // ÂÖ±Âêå„Çø„Çπ„ÇØ‰ΩúÊàêÊôÇ„ÅÆÈÄöÁü•
                checkCollaborativeTaskNotifications(newTask, selectedAssignees);
            }
            
            console.log('üíæ [EDIT SAVE] About to save tasks and render');
            console.log('üîç [EDIT SAVE] Tasks count before save:', tasks.length);
            console.log('üîç [EDIT SAVE] EditingTask details:', editingTask ? {
                id: editingTask.id,
                title: editingTask.title,
                projectId: editingTask.projectId,
                projectName: editingTask.projectName,
                columnId: editingTask.columnId
            } : 'null');
            
            saveTasks();
            console.log('üîç [EDIT SAVE] Tasks count after save:', tasks.length);
            
            // üîí „Çª„ÉÉ„Ç∑„Éß„É≥‰øùË≠∑Ôºö„Çø„Çπ„ÇØ‰ΩúÊàêÂâç„Å´„Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            const currentUserBackup = localStorage.getItem('currentUser');
            console.log('üîí [SESSION-PROTECT] „Çø„Çπ„ÇØ‰ΩúÊàêÂâç„Çª„ÉÉ„Ç∑„Éß„É≥‰øùË≠∑:', {
                hasSession: !!currentSession,
                userName: currentSession?.user?.name,
                userEmail: currentSession?.user?.email,
                backupUser: currentUserBackup
            });

            // FirebaseÂêåÊúüÔºàÊñ∞Ë¶è„Çø„Çπ„ÇØ„Åæ„Åü„ÅØÁ∑®ÈõÜ„Çø„Çπ„ÇØÔºâ
            if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                try {
                    const targetTask = editingTask || tasks[tasks.length - 1]; // Á∑®ÈõÜ‰∏≠„Åæ„Åü„ÅØÊúÄÊñ∞„Çø„Çπ„ÇØ
                    if (targetTask) {
                        console.log('üî• [FIREBASE] „Çø„Çπ„ÇØ„ÇíFirebase„Å´ÂêåÊúü‰∏≠...', targetTask.title);
                        
                        if (editingTask) {
                            // Á∑®ÈõÜ„ÅÆÂ†¥Âêà„ÅØÊõ¥Êñ∞
                            const result = await window.FirebaseDB.updateTask(targetTask.id, targetTask);
                            if (result.success) {
                                console.log('‚úÖ [FIREBASE] „Çø„Çπ„ÇØÊõ¥Êñ∞ÊàêÂäü:', targetTask.id);
                            } else {
                                console.error('‚ùå [FIREBASE] „Çø„Çπ„ÇØÊõ¥Êñ∞„Ç®„É©„Éº:', result.error);
                            }
                        } else {
                            // üî• Êñ∞Ë¶è„ÅÆÂ†¥Âêà„ÅØ‰ΩúÊàêÔºàFirebaseÂÆåÂÖ®‰æùÂ≠òÔºâ
                            const result = await window.FirebaseDB.createTask(targetTask);
                            if (result.success) {
                                console.log('‚úÖ [FIREBASE-ONLY] „Çø„Çπ„ÇØ‰ΩúÊàêÊàêÂäü:', result.id);
                                // üîß LocalStorage„Å∏„ÅÆ‰øùÂ≠ò„ÅØ‰∏çË¶Å - Firebase„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„ÅßËá™ÂãïÊõ¥Êñ∞
                            } else {
                                console.error('‚ùå [FIREBASE] „Çø„Çπ„ÇØ‰ΩúÊàê„Ç®„É©„Éº:', result.error);
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [FIREBASE] ÂêåÊúü„Ç®„É©„Éº:', error);
                }
            } else {
                console.log('üíæ [FIREBASE] FirebaseÊú™ÂØæÂøú„Åæ„Åü„ÅØ„É≠„Ç∞„Ç¢„Ç¶„ÉàÁä∂ÊÖã - LocalStorage„ÅÆ„Åø');
            }

            // üîí „Çª„ÉÉ„Ç∑„Éß„É≥‰øùË≠∑ÔºöFirebaseÂêåÊúüÂæå„Å´„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
            const sessionAfterSync = JSON.parse(localStorage.getItem('currentSession') || 'null');
            const userAfterSync = localStorage.getItem('currentUser');
            
            if (currentSession && sessionAfterSync) {
                if (currentSession.user?.email !== sessionAfterSync.user?.email) {
                    console.warn('‚ö†Ô∏è [SESSION-PROTECT] „Çª„ÉÉ„Ç∑„Éß„É≥Â§âÊõ¥„ÇíÊ§úÂá∫ÔºÅÂæ©ÂÖÉ„Åó„Åæ„Åô:', {
                        before: currentSession.user?.email,
                        after: sessionAfterSync.user?.email
                    });
                    localStorage.setItem('currentSession', JSON.stringify(currentSession));
                    if (currentUserBackup) {
                        localStorage.setItem('currentUser', currentUserBackup);
                    }
                }
            }
            
            console.log('üé® [EDIT SAVE] About to call render()');
            render();
            console.log('üé® [EDIT SAVE] render() completed');
            
            // Á∑®ÈõÜ‰øùÂ≠òÊôÇ„ÅÆ„É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ
            if (editingTask && editingTask.comments && editingTask.comments.length > 0) {
                // ÊúÄÊñ∞„ÅÆ„Ç≥„É°„É≥„Éà„Åß„É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const latestComment = editingTask.comments[editingTask.comments.length - 1];
                console.log(`üîî [SAVE] ÊúÄÊñ∞„Ç≥„É°„É≥„Éà„ÅÆ„É°„É≥„Ç∑„Éß„É≥ÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ: "${latestComment.text}"`);
                checkMentionNotifications(latestComment.text, latestComment.author, editingTask);
            }
            
            // „Çø„Çπ„ÇØ‰ΩúÊàê„ÉªÁ∑®ÈõÜÂæå„Å´Âç≥Â∫ß„Å´ÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ
            setTimeout(() => checkDeadlines(), 100);
            
            // required Â±ûÊÄß„ÇíÂæ©Ê¥ª (Áµ±‰∏Ä‰ΩúÊàê„É¢„Éº„ÉâÁî®)
            if (wasRequired && isColumnSelectionHidden) {
                columnInput.setAttribute('required', '');
                console.log(`üîß [FORM] Restored required attribute to task-column-input`);
            }
            
            closeModal();
            
            } catch (error) {
                console.error('üö® [SAVE TASK ERROR]', error);
                alert('„Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                
                // „Ç®„É©„ÉºÊôÇ„ÇÇrequiredÂ±ûÊÄß„ÇíÂæ©Ê¥ª
                if (wasRequired && isColumnSelectionHidden) {
                    columnInput.setAttribute('required', '');
                }
            }
        }
        
        function closeModal() {
            document.getElementById('task-modal').classList.remove('show');
            editingTask = null;
            
            // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
            const fileInput = document.getElementById('task-files-input');
            const dropZone = document.getElementById('file-drop-zone');
            const commentInput = document.getElementById('comment-input');
            
            if (fileInput) {
                fileInput.value = '';
            }
            if (dropZone) {
                dropZone.innerHTML = 'üìÅ „Åì„Åì„Å´„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó „Åæ„Åü„ÅØ ‰∏äË®ò„Éú„Çø„É≥„ÅßÈÅ∏Êäû';
            }
            if (commentInput) {
                commentInput.value = '';
            }
            
            // Phase 2: PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÇíÈùûË°®Á§∫„Å´Êàª„Åô
            // PJ„Çø„Çπ„ÇØË®≠ÂÆö„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï
            // PJ„Éï„Ç£„Éº„É´„Éâ„ÅØÂà•„Éö„Éº„Ç∏„Å´ÁßªÂãï
            
            // ÊâøË™çËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Ç¢
            const approverCheckboxes = document.querySelectorAll('#project-approvers input[type="checkbox"]');
            approverCheckboxes.forEach(cb => cb.checked = false);
        }
        
        function deleteTask(taskId) {
            if (confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                render();
                playMoveSound();
            }
        }
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
        function handleDragStart(e, taskId) {
            console.log(`üü¢ [MAIN] handleDragStart called with taskId: ${taskId}`);
            console.log(`üü¢ [MAIN] All tasks:`, tasks);
            console.log(`üü¢ [MAIN] isBulkMode: ${isBulkMode}`);
            draggedTask = tasks.find(t => t.id === taskId);
            console.log(`üü¢ [MAIN] Found draggedTask:`, draggedTask);
            if (!draggedTask) {
                console.error(`‚ùå [MAIN] draggedTask not found for taskId: ${taskId}`);
                return false;
            }
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', taskId);
        }
        
        function handleDragEnd(e) {
            console.log(`üî¥ [MAIN] handleDragEnd called`);
            e.target.classList.remove('dragging');
            draggedTask = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDrop(e, columnId) {
            console.log(`üîµ [MAIN] handleDrop called with columnId: ${columnId}`);
            console.log(`üîµ [MAIN] draggedTask:`, draggedTask);
            console.log(`üîµ [MAIN] Event target:`, e.target);
            console.log(`üîµ [MAIN] Event currentTarget:`, e.currentTarget);
            e.preventDefault();
            const dropZone = e.currentTarget;
            dropZone.classList.remove('drag-over');
            
            if (draggedTask) {
                console.log(`üîµ [MAIN] Current task column: ${draggedTask.columnId}, Target: ${columnId}`);
                console.log(`üîç [DROP DEBUG] Tasks count BEFORE move: ${tasks.length}`);
                console.log(`üîç [DROP DEBUG] DraggedTask details:`, JSON.stringify({
                    id: draggedTask.id,
                    title: draggedTask.title,
                    projectId: draggedTask.projectId,
                    projectName: draggedTask.projectName,
                    hasComments: draggedTask.comments ? draggedTask.comments.length : 0,
                    hasAttachments: draggedTask.attachments ? draggedTask.attachments.length : 0
                }, null, 2));
                
                if (draggedTask.columnId !== columnId) {
                    // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÅÆdrag&drop„ÅØÁÑ°ÂäπÔºàÊúüÈôêÂª∂Èï∑„Åß„ÅÆ„ÅøÁßªÂãïÂèØËÉΩÔºâ
                    if (draggedTask.deadline && isOverdue(draggedTask.deadline, draggedTask.columnId)) {
                        console.log(`‚ùå [MAIN] Overdue task drag&drop is disabled`);
                        alert('ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÅØÁõ¥Êé•ÁßªÂãï„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nÁ∑®ÈõÜÁîªÈù¢„ÅßÊúüÈôê„ÇíÂª∂Èï∑„Åô„Çã„Å®ÁßªÂãï„Åß„Åç„Åæ„Åô„ÄÇ');
                        return;
                    }
                    
                    console.log(`üü° [MAIN] Moving "${draggedTask.title}" from ${draggedTask.columnId} to ${columnId}`);
                    
                    // PJ„Çø„Çπ„ÇØ„ÅÆË®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÔºàÁßªÂãï„ÅÆ„Åü„Å≥„Å´ÂøÖÈ†àÔºâ
                    if (draggedTask.projectId && draggedTask.projectName) {
                        console.log(`üîç [PJ DEBUG] Before evidence check - Tasks count: ${tasks.length}`);
                        const hasEvidence = checkTaskEvidence(draggedTask, true); // ÁßªÂãïÊôÇ„Éï„É©„Ç∞„Çítrue
                        console.log(`üîç [PJ DEBUG] Evidence check result: ${hasEvidence}, Tasks count: ${tasks.length}`);
                        
                        if (!hasEvidence) {
                            console.log(`üîç [PJ DEBUG] Before promptForEvidence - Tasks count: ${tasks.length}`);
                            const evidenceResult = promptForEvidence(draggedTask);
                            console.log(`üîç [PJ DEBUG] After promptForEvidence - Result: ${evidenceResult}, Tasks count: ${tasks.length}`);
                            
                            if (!evidenceResult) {
                                console.log(`‚ùå [PJ] Ë®ºÊÜë„Å™„Åó„ÅÆ„Åü„ÇÅÁßªÂãï„Ç≠„É£„É≥„Çª„É´: ${draggedTask.title}`);
                                console.log(`üîç [PJ DEBUG] Cancel move - Tasks count: ${tasks.length}`);
                                return; // ÁßªÂãï„Çí„Ç≠„É£„É≥„Çª„É´
                            }
                        }
                        console.log(`üîç [PJ DEBUG] After all evidence checks - Tasks count: ${tasks.length}`);
                    }
                    
                    // Done„Ç´„É©„É†„Å´ÁßªÂãï„Åô„ÇãÂ†¥Âêà„ÄÅcompletedAt„ÇíË®òÈå≤
                    if (columnId === 'done' && !draggedTask.completedAt) {
                        draggedTask.completedAt = new Date().toISOString();
                    }
                    // Done„Ç´„É©„É†„Åã„Çâ‰ªñ„Å´ÁßªÂãï„Åô„ÇãÂ†¥Âêà„ÄÅcompletedAt„Çí„ÇØ„É™„Ç¢
                    else if (draggedTask.columnId === 'done' && columnId !== 'done') {
                        draggedTask.completedAt = null;
                    }
                    
                    console.log(`üîç [DROP DEBUG] Before column change - Tasks count: ${tasks.length}`);
                    draggedTask.columnId = columnId;
                    draggedTask.completed = (columnId === 'done');
                    console.log(`üîç [DROP DEBUG] After column change - Tasks count: ${tasks.length}`);
                    
                    // PJ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÄÅÊúÄÂæå„ÅÆÁßªÂãïÊôÇÂàª„ÇíË®òÈå≤„Åó„ÄÅÈÄöÁü•„ÇíÈÄÅ‰ø°
                    if (draggedTask.projectId && draggedTask.projectName) {
                        draggedTask.lastMovedAt = new Date().toISOString();
                        console.log(`üìÖ [PJ MOVE] Recorded move time: ${draggedTask.lastMovedAt}`);
                        
                        // ÊâøË™çËÄÖ„ÉªÊãÖÂΩìËÄÖ„Å∏„ÅÆÁßªÂãïÈÄöÁü•
                        console.log(`üîç [DROP DEBUG] Before notification - Tasks count: ${tasks.length}`);
                        sendPJMoveNotification(draggedTask, columnId);
                        console.log(`üîç [DROP DEBUG] After notification - Tasks count: ${tasks.length}`);
                    }
                    
                    console.log(`üîç [DROP DEBUG] Before saveTasks() - Tasks count: ${tasks.length}`);
                    saveTasks();
                    console.log(`üîç [DROP DEBUG] After saveTasks() - Tasks count: ${tasks.length}`);
                    
                    console.log(`üîç [DROP DEBUG] Before render() - Tasks count: ${tasks.length}`);
                    render();
                    console.log(`üîç [DROP DEBUG] After render() - Tasks count: ${tasks.length}`);
                    
                    console.log(`üîç [DROP DEBUG] Before updateStats() - Tasks count: ${tasks.length}`);
                    updateStats();
                    console.log(`üîç [DROP DEBUG] After updateStats() - Tasks count: ${tasks.length}`);
                    
                    console.log(`‚úÖ [MAIN] Task moved successfully to ${columnId}`);
                } else {
                    console.log(`‚ö†Ô∏è [MAIN] Same column, no move needed`);
                }
            } else {
                console.log(`‚ùå [MAIN] No draggedTask found`);
            }
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        function handleOverdueDrop(e) {
            console.log(`üî¥ [OVERDUE] handleOverdueDrop called - disabled`);
            e.preventDefault();
            const dropZone = e.currentTarget;
            dropZone.classList.remove('drag-over');
            
            // ÊúüÈôêÂàá„Çå„Ç®„É™„Ç¢„Å∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÅØÁÑ°Âäπ
            alert('ÊúüÈôêÂàá„Çå„Ç®„É™„Ç¢„Å´„ÅØÁõ¥Êé•ÁßªÂãï„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nÁ∑®ÈõÜÁîªÈù¢„ÅßÊúüÈôê„ÇíÂª∂Èï∑„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            console.log(`‚ùå [OVERDUE] Drop to overdue area is disabled`);
        }
        
        function getColumnTitle(columnId) {
            const column = columns.find(c => c.id === columnId);
            return column ? column.title : columnId;
        }
        
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†ÂèñÂæó
        function getProjectColumns(projectId) {
            if (!projectId) return columns;
            
            const projectSettings = JSON.parse(localStorage.getItem('projectSettings') || '{}');
            const project = projectSettings[projectId];
            
            if (project && project.columns && project.columns.length > 0) {
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†„ÇíÈÄöÂ∏∏„ÅÆ„Ç´„É©„É†ÂΩ¢Âºè„Å´Â§âÊèõ
                return project.columns.map((columnTitle, index) => ({
                    id: `pj_${projectId}_${index}`,
                    title: columnTitle,
                    color: ['#667eea', '#f59e0b', '#8b5cf6', '#10b981', '#6c757d'][index % 5] // Ëâ≤„Çí„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥
                }));
            }
            
            return columns; // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†„Çí‰ΩøÁî®
        }

        // „É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function render() {
            console.log('üé® [RENDER] Starting render, total tasks:', tasks.length);
            const board = document.getElementById('kanban-board');
            if (!board) {
                console.error('‚ùå [RENDER] kanban-board element not found!');
                return;
            }
            board.innerHTML = '';
            console.log('üé® [RENDER] Board cleared successfully');
            
            // Áµ±Âêà„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            let filteredTasks = tasks;
            let currentColumns = columns; // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†
            
            console.log('üîç [RENDER] Before filtering - total tasks:', tasks.length);
            console.log('üîç [RENDER] selectedProjectFilters:', selectedProjectFilters);
            console.log('üîç [RENDER] selectedAssigneeFilters:', selectedAssigneeFilters);
            
            if (selectedProjectFilters.length > 0) {
                // PJ„Éï„Ç£„É´„Çø„Éº: ÁâπÂÆö„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫
                filteredTasks = tasks.filter(t => 
                    t.projectId && selectedProjectFilters.includes(t.projectId)
                );
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†„ÇíÂèñÂæó
                currentColumns = getProjectColumns(selectedProjectFilters[0]);
                console.log(`üë• [RENDER] Project filter: showing ${filteredTasks.length} tasks for project ${selectedProjectFilters[0]} with ${currentColumns.length} columns`);
            } else if (selectedAssigneeFilters.length > 0) {
                // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº: ÁâπÂÆöÊãÖÂΩìËÄÖ„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫
                filteredTasks = tasks.filter(t => {
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.some(a => selectedAssigneeFilters.includes(a));
                    }
                    return selectedAssigneeFilters.includes(t.assignee);
                });
                console.log(`üë§ [RENDER] Assignee filter: showing ${filteredTasks.length} tasks for ${selectedAssigneeFilters[0]}`);
            } else {
                // ÂÖ®Âì°: ÂÖ®„Çø„Çπ„ÇØË°®Á§∫
                console.log(`üë• [RENDER] Showing all ${filteredTasks.length} tasks`);
            }
            
            console.log('üîç [RENDER] After filtering - filteredTasks count:', filteredTasks.length);
            
            // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÇíÊäΩÂá∫Ôºà„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Âæå„ÅÆ„Çø„Çπ„ÇØ„Åã„ÇâÔºâ
            let overdueTasks = filteredTasks.filter(t => 
                t.columnId !== 'done' && 
                t.deadline && 
                isOverdue(t.deadline, t.columnId)
            );
            
            // ÊúüÈôêÂàá„Çå„Ç´„É©„É†„ÇíÊúÄÂàù„Å´Ë°®Á§∫
            if (overdueTasks.length > 0) {
                const overdueColumn = document.createElement('div');
                overdueColumn.className = 'column';
                overdueColumn.style.borderTop = '3px solid #e53e3e';
                overdueColumn.innerHTML = `
                    <div class="column-header" style="background: #e53e3e; color: white;">
                        <div class="column-title">üö® ÊúüÈôêÂàá„Çå</div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <div class="column-count">${overdueTasks.length}</div>
                        </div>
                    </div>
                    <div class="column-content" 
                         style="background: #fee;"
                         ondragover="handleDragOver(event)"
                         ondrop="handleOverdueDrop(event)"
                         ondragenter="handleDragEnter(event)"
                         ondragleave="handleDragLeave(event)">
                        ${overdueTasks.map(task => createTaskCard(task, true)).join('')}
                    </div>
                `;
                board.appendChild(overdueColumn);
            }
            
            // ÈÄöÂ∏∏„ÅÆ„Ç´„É©„É†„ÇíË°®Á§∫Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†„Åæ„Åü„ÅØ„Éá„Éï„Ç©„É´„Éà„Ç´„É©„É†Ôºâ
            currentColumns.forEach(column => {
                let columnTasks = filteredTasks.filter(t => {
                    // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÅØÊúüÈôêÂàá„Çå„Ç´„É©„É†„Å´Ë°®Á§∫„Åô„Çã„ÅÆ„ÅßÈô§Â§ñ
                    if (t.columnId !== 'done' && t.deadline && isOverdue(t.deadline, t.columnId)) {
                        return false;
                    }
                    
                    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†„ÅÆÂ†¥Âêà„ÄÅ„Ç´„É©„É†„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åß„Éû„ÉÉ„Éî„É≥„Ç∞
                    if (selectedProjectFilters.length > 0 && column.id.startsWith('pj_')) {
                        const columnIndex = parseInt(column.id.split('_')[2]);
                        const projectSettings = JSON.parse(localStorage.getItem('projectSettings') || '{}');
                        const project = projectSettings[selectedProjectFilters[0]];
                        
                        if (project && project.columns) {
                            // „Çø„Çπ„ÇØ„ÅÆcolumnId„ÅåÊ®ôÊ∫ñ„Ç´„É©„É†„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„É†„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
                            const defaultColumns = ['todo', 'inprogress', 'waiting', 'done', 'trash'];
                            const taskColumnIndex = defaultColumns.indexOf(t.columnId);
                            
                            if (taskColumnIndex !== -1 && taskColumnIndex < project.columns.length) {
                                return taskColumnIndex === columnIndex;
                            }
                            
                            // Êó¢„Å´„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ∞ÇÁî®„Ç´„É©„É†ID„ÅÆÂ†¥Âêà
                            return t.columnId === column.id;
                        }
                    }
                    
                    return t.columnId === column.id;
                });
                
                // ÊúüÈôêÈ†Ü„Åß„ÇΩ„Éº„Éà
                columnTasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                
                const columnEl = document.createElement('div');
                columnEl.className = 'column';
                columnEl.setAttribute('data-column-id', column.id); // „Ç¥„ÉüÁÆ±„Çπ„Çø„Ç§„É´Áî®
                columnEl.innerHTML = `
                    <div class="column-header" style="background: ${column.color}; color: white;">
                        <div class="column-title" ondblclick="editColumnNameInline('${column.id}', this)">${column.title}</div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <div class="column-count">${columnTasks.length}</div>
                            <div style="display: flex; gap: 0.25rem;">
                                <button onclick="editColumnNameInline('${column.id}')" style="background: rgba(255,255,255,0.2); border: none; cursor: pointer; color: white; font-size: 0.8rem; padding: 0.2rem; border-radius: 3px;" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                                ${columns.length > 2 ? `<button onclick="deleteColumnInline('${column.id}')" style="background: rgba(255,255,255,0.2); border: none; cursor: pointer; color: white; font-size: 0.8rem; padding: 0.2rem; border-radius: 3px;" title="ÂâäÈô§">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="column-content" 
                         ondragover="handleDragOver(event)"
                         ondrop="handleDrop(event, '${column.id}')"
                         ondragenter="handleDragEnter(event)"
                         ondragleave="handleDragLeave(event)">
                        ${columnTasks.map(task => createTaskCard(task)).join('')}
                    </div>
                `;
                
                board.appendChild(columnEl);
            });
            
            updateStats();
        }
        
        function createTaskCard(task, isFromOverdueColumn = false) {
            console.log(`üé¥ [CARD] Creating card for task ${task.id}, isBulkMode: ${isBulkMode}, isFromOverdueColumn: ${isFromOverdueColumn}`);
            const deadline = new Date(task.deadline);
            const isOverdueTask = isOverdue(task.deadline, task.columnId);
            const isTodayTask = isToday(task.deadline, task.columnId);
            const now = new Date();
            console.log(`üé¥ [CARD] Task ${task.id} - deadline: ${task.deadline}, columnId: ${task.columnId}`);
            console.log(`üé¥ [CARD] Task ${task.id} - Current time: ${now.toISOString()}, deadline < now: ${deadline < now}`);
            console.log(`üé¥ [CARD] Task ${task.id} - isOverdueTask: ${isOverdueTask}, draggable: ${!isBulkMode}`);
            
            // ÁµåÈÅéÊôÇÈñì„ÇíË®àÁÆó
            let daysSinceCreated = 0;
            let elapsedText = '';
            let isStale = false; // 3Êó•‰ª•‰∏äÂÅúÊªû„Éï„É©„Ç∞
            
            if (task.createdAt) {
                const createdDate = new Date(task.createdAt);
                const now = new Date();
                const timeDiff = now - createdDate;
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                daysSinceCreated = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                
                if (hoursDiff < 24) {
                    // 24ÊôÇÈñì‰ª•ÂÜÖ„ÅØÊôÇÈñìË°®Á§∫
                    elapsedText = `${String(hoursDiff).padStart(2, '0')}h`;
                } else {
                    // 24ÊôÇÈñì‰ª•‰∏ä„ÅØÊó•Êï∞Ë°®Á§∫
                    elapsedText = `${daysSinceCreated}d`;
                }
                
                // 3Êó•‰ª•‰∏ä„ÅßÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Å™„ÅÑ„Çø„Çπ„ÇØ„ÅØÂÅúÊªû„Éï„É©„Ç∞
                if (daysSinceCreated >= 3 && task.columnId !== 'done') {
                    isStale = true;
                }
            }
            
            let cardClass = `task-card priority-${task.priority}`;
            if (isOverdueTask) cardClass += ' overdue';
            else if (isTodayTask) cardClass += ' today';
            
            let deadlineClass = 'task-deadline';
            let deadlineIcon = 'üìÖ';
            if (isOverdueTask) {
                deadlineClass += ' overdue';
                deadlineIcon = 'üö®';
            } else if (isTodayTask) {
                deadlineClass += ' today';
                deadlineIcon = '‚è∞';
            }
            
            const priorityText = {
                high: 'üî¥ ÊúÄÈáçË¶Å',
                medium: 'üü° ÈáçË¶Å', 
                low: 'üü¢ ÈÄöÂ∏∏'
            }[task.priority];
            
            const checkboxHtml = isBulkMode ? `
                <div style="position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10;">
                    <input type="checkbox" 
                           onchange="toggleTaskSelection(${task.id})" 
                           onclick="event.stopPropagation()"
                           ${selectedTasks.has(task.id) ? 'checked' : ''}
                           style="width: 16px; height: 16px; cursor: pointer;">
                </div>
            ` : '';
            
            return `
                <div class="${cardClass}" 
                     draggable="${!isBulkMode && !(isFromOverdueColumn || isOverdueTask)}"
                     ${(!isBulkMode && !(isFromOverdueColumn || isOverdueTask)) ? `ondragstart="handleDragStart(event, ${task.id})" ondragend="handleDragEnd(event)"` : ''}
                     onclick="${isBulkMode ? `toggleTaskSelection(${task.id})` : `editTask(${task.id})`}"
                     style="position: relative; cursor: ${isBulkMode ? 'pointer' : ((isFromOverdueColumn || isOverdueTask) ? 'default' : 'move')}; ${(isFromOverdueColumn || isOverdueTask) ? 'opacity: 0.9;' : ''} ${isStale ? 'border: 2px solid #e53e3e; box-shadow: 0 0 8px rgba(229, 62, 62, 0.3);' : ''}"
                     title="${(isFromOverdueColumn || isOverdueTask) ? 'ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„Åß„Åô„ÄÇÁßªÂãï„Åô„Çã„Å´„ÅØÁ∑®ÈõÜ„ÅßÊúüÈôê„ÇíÂª∂Èï∑„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' : ''}${isStale ? ' ‚ö†Ô∏è 3Êó•‰ª•‰∏äÂÅúÊªû‰∏≠' : ''}">
                    ${checkboxHtml}
                    <div class="task-title" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span style="flex: 1;">
                            ${task.isRecurring ? '<span style="color: #2d3748; margin-right: 0.25rem;" title="ÂÆöÊúü„Çø„Çπ„ÇØ">üîÑ</span>' : ''}
                            ${task.projectId ? '<span style="color: #2b6cb0; margin-right: 0.25rem;" title="PJ„Çø„Çπ„ÇØ">üë•</span>' : ''}
                            ${task.title}
                        </span>
                        <button onclick="deleteTask(${task.id}); event.stopPropagation();" 
                                style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9rem; padding: 2px; opacity: 0.7; margin-left: 8px;"
                                title="„Ç¥„ÉüÁÆ±„Å´ÁßªÂãï"
                                onmouseover="this.style.opacity='1'"
                                onmouseout="this.style.opacity='0.7'">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="task-meta">
                        <div style="margin-bottom: 0.25rem;">
                            <span class="${deadlineClass}">
                                ${deadlineIcon} ${deadline.toLocaleDateString('ja-JP')} ${deadline.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                            </span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            ${elapsedText ? `<span style="font-size: 0.75rem; color: ${isStale ? '#e53e3e' : '#718096'}; font-weight: ${isStale ? '600' : '400'};">‚è±Ô∏è ${elapsedText}</span>` : ''}
                            ${isStale ? '<span style="font-size: 0.75rem; color: #e53e3e;">üö® ÂÅúÊªû‰∏≠</span>' : ''}
                        </div>
                        <span class="task-priority-badge priority-${task.priority}">
                            ${priorityText}
                        </span>
                    </div>
                    ${task.memo ? `<div class="task-memo">${task.memo}</div>` : ''}
                    <div class="task-badges">
                        ${task.memo ? '<span class="attachment-icon">üìù</span>' : ''}
                        ${task.attachments && task.attachments.length > 0 ? `<span class="attachment-badge">${task.attachments.length}</span>` : ''}
                        <span style="font-size: 0.7rem; color: #5e6c84;">üë§ ${getAssigneeDisplayText(task)}</span>
                    </div>
                </div>
            `;
        }
        
        function getAssigneeDisplayText(task) {
            if (task.assignees && Array.isArray(task.assignees) && task.assignees.length > 0) {
                if (task.assignees.length === 1) {
                    return task.assignees[0];
                } else if (task.assignees.length <= 3) {
                    return task.assignees.join(', ');
                } else {
                    return `${task.assignees[0]} ‰ªñ${task.assignees.length - 1}Âêç`;
                }
            }
            // ÂæåÊñπ‰∫íÊèõÊÄß
            return task.assignee || 'Êú™Ë®≠ÂÆö';
        }
        
        function updateStats() {
            const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
            let filteredTasks = tasks;
            
            // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
            if (assigneeFilter) {
                filteredTasks = tasks.filter(t => {
                    // Êñ∞„Åó„ÅÑassignees„Éï„Ç£„Éº„É´„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(assigneeFilter);
                    }
                    // Êóß„ÅÑassignee„Éï„Ç£„Éº„É´„Éâ„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
                    return t.assignee === assigneeFilter;
                });
            }
            
            const overdueCount = filteredTasks.filter(t => t.columnId !== 'done' && isOverdue(t.deadline, t.columnId)).length;
            const todayCount = filteredTasks.filter(t => t.columnId !== 'done' && isToday(t.deadline, t.columnId)).length;
            const completedCount = filteredTasks.filter(t => t.columnId === 'done').length;
            
            // 3Êó•‰ª•‰∏äÂÅúÊªû„Åó„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÇíÊ§úÂá∫
            const now = new Date();
            const staleTasks = filteredTasks.filter(t => {
                if (t.columnId === 'done') return false;
                
                // createdAt„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ªäÊó•‰ΩúÊàê„Åï„Çå„Åü„ÇÇ„ÅÆ„Å®„Åó„Å¶Êâ±„ÅÜÔºàÂÅúÊªûÂà§ÂÆö„Åã„ÇâÈô§Â§ñÔºâ
                if (!t.createdAt) return false;
                
                const createdDate = new Date(t.createdAt);
                const daysDiff = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                return daysDiff >= 3;
            });
            
            // „ÉÅ„Éº„É†Âπ≥Âùá„ÅÆ1.2ÂÄç‰ª•‰∏ä„ÅÆ„Çø„Çπ„ÇØ„ÇíÊåÅ„Å§ÊãÖÂΩìËÄÖ„ÇíÊ§úÂá∫
            const assigneeCounts = {};
            let totalAssignedTasks = 0;
            let assigneeCount = 0;
            
            // ÂÖ®„Çø„Çπ„ÇØ„ÅßÊãÖÂΩìËÄÖÂà•„Ç´„Ç¶„É≥„ÉàÔºà„Éï„Ç£„É´„ÇøÂâç„ÅÆÂÖ®‰Ωì„Åã„ÇâË®àÁÆóÔºâ
            tasks.forEach(task => {
                if (task.columnId !== 'done') {
                    // Êñ∞„Åó„ÅÑassignees„Éï„Ç£„Éº„É´„Éâ„ÅÆÂá¶ÁêÜ
                    if (task.assignees && Array.isArray(task.assignees)) {
                        task.assignees.forEach(assignee => {
                            if (!assigneeCounts[assignee]) {
                                assigneeCounts[assignee] = 0;
                                assigneeCount++;
                            }
                            assigneeCounts[assignee]++;
                            totalAssignedTasks++;
                        });
                    } else if (task.assignee && task.assignee !== 'Êú™Ë®≠ÂÆö') {
                        // Êóßassignee„Éï„Ç£„Éº„É´„Éâ„ÅÆÂá¶ÁêÜ
                        if (!assigneeCounts[task.assignee]) {
                            assigneeCounts[task.assignee] = 0;
                            assigneeCount++;
                        }
                        assigneeCounts[task.assignee]++;
                        totalAssignedTasks++;
                    }
                }
            });
            
            // „ÉÅ„Éº„É†Âπ≥Âùá„ÇíË®àÁÆó
            const avgTasksPerPerson = assigneeCount > 0 ? totalAssignedTasks / assigneeCount : 0;
            const overloadThreshold = avgTasksPerPerson * 1.2;
            
            // ÈÅéË≤†Ëç∑„ÅÆÊãÖÂΩìËÄÖÊï∞„Çí„Ç´„Ç¶„É≥„Éà
            const overloadedAssignees = Object.entries(assigneeCounts)
                .filter(([assignee, count]) => count > overloadThreshold)
                .map(([assignee, count]) => ({ assignee, count }));
            
            document.getElementById('overdue-count').textContent = overdueCount;
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('stale-count').textContent = staleTasks.length;
            document.getElementById('overload-count').textContent = overloadedAssignees.length;
            
            // ÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøË¶ÅË™øÊï¥„ÇíË°®Á§∫
            const workloadItem = document.getElementById('workload-item');
            if (workloadItem) {
                workloadItem.style.display = isAdmin() ? 'flex' : 'none';
            }
            
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠òÔºàË©≥Á¥∞Ë°®Á§∫Áî®Ôºâ
            window.staleTasks = staleTasks;
            window.overloadedAssignees = overloadedAssignees;
            window.avgTasksPerPerson = avgTasksPerPerson;
            
            // „ÉØ„Éº„ÇØ„Éï„É≠„ÉºË°®Á§∫„ÇíÂâäÈô§: ÁÆ°ÁêÜËÄÖ„Å´„Å®„Å£„Å¶Áî®ÈÄî„Åå‰∏çÊòéÁ¢∫„Å™„Åü„ÇÅ
            
            // ÂàÜÊûê„Çµ„Éû„É™„Éº„ÇÇÊõ¥Êñ∞
            updateAnalyticsSummary();
        }
        
        function updateWorkflowStats(filteredTasks) {
            const workflowContainer = document.getElementById('workflow-status');
            if (!workflowContainer) return;
            
            // „Çπ„ÉÜ„Éº„Çø„ÇπÂà•Áµ±Ë®à„ÇíË®àÁÆó
            const statusStats = {};
            const now = new Date();
            
            columns.forEach(column => {
                const columnTasks = filteredTasks.filter(t => {
                    // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÅØÊúüÈôêÂàá„Çå„Ç®„É™„Ç¢„Å´Ë°®Á§∫„Åï„Çå„Çã„ÅÆ„ÅßÈô§Â§ñ
                    if (t.columnId !== 'done' && t.deadline && isOverdue(t.deadline, t.columnId)) {
                        return false;
                    }
                    return t.columnId === column.id;
                });
                
                // Âπ≥ÂùáÊªûÁïôÊôÇÈñì„ÇíË®àÁÆó
                let avgDays = 0;
                if (columnTasks.length > 0) {
                    const totalDays = columnTasks.reduce((sum, task) => {
                        if (task.createdAt) {
                            const createdDate = new Date(task.createdAt);
                            const days = Math.max(0, (now - createdDate) / (1000 * 60 * 60 * 24));
                            return sum + days;
                        }
                        return sum;
                    }, 0);
                    avgDays = Math.round((totalDays / columnTasks.length) * 10) / 10; // Â∞èÊï∞ÁÇπ1Ê°Å
                }
                
                statusStats[column.id] = {
                    title: column.title,
                    count: columnTasks.length,
                    avgDays: avgDays,
                    color: column.color || '#026aa7'
                };
            });
            
            // „ÉØ„Éº„ÇØ„Éï„É≠„ÉºË°®Á§∫„ÇíÁîüÊàê
            const workflowHtml = columns.map((column, index) => {
                const stats = statusStats[column.id];
                const isBottleneck = stats.avgDays > 2.0; // 2Êó•‰ª•‰∏ä„Åß„Éú„Éà„É´„Éç„ÉÉ„ÇØÂà§ÂÆö
                const statusClass = isBottleneck ? 'bottleneck' : 'normal';
                const statusIcon = isBottleneck ? 'üö®' : '';
                
                const arrow = index < columns.length - 1 ? '<span style="margin: 0 0.25rem; color: #5e6c84;">‚Üí</span>' : '';
                
                return `
                    <div class="workflow-status-item ${statusClass}" 
                         onclick="showStatusDetails('${column.id}')"
                         style="
                            display: flex; 
                            align-items: center; 
                            gap: 0.25rem; 
                            padding: 0.25rem 0.5rem; 
                            border-radius: 4px; 
                            cursor: pointer;
                            background: ${isBottleneck ? '#fee2e2' : '#f1f5f9'};
                            border: 1px solid ${isBottleneck ? '#fca5a5' : '#cbd5e1'};
                            transition: all 0.2s;
                         "
                         onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                         title="${stats.title}: ${stats.count}‰ª∂„ÄÅÂπ≥Âùá${stats.avgDays}Êó•">
                        ${statusIcon}
                        <span style="font-weight: 600; color: ${isBottleneck ? '#dc2626' : '#374151'};">${stats.title}</span>
                        <span style="color: ${isBottleneck ? '#dc2626' : '#6b7280'};">(${stats.count}‰ª∂)</span>
                        ${stats.avgDays > 0 ? `<span style="font-size: 0.75rem; color: ${isBottleneck ? '#dc2626' : '#9ca3af'};">${stats.avgDays}Êó•</span>` : ''}
                    </div>
                    ${arrow}
                `;
            }).join('');
            
            workflowContainer.innerHTML = workflowHtml;
        }
        
        // 3Êó•‰ª•‰∏äÂÅúÊªû„Åó„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅÆË©≥Á¥∞Ë°®Á§∫
        function showStaleTasksDetail() {
            if (!window.staleTasks || window.staleTasks.length === 0) {
                alert('ÁèæÂú®„ÄÅ3Êó•‰ª•‰∏äÂÅúÊªû„Åó„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const now = new Date();
            const taskListHtml = window.staleTasks.map(task => {
                const createdDate = task.createdAt ? new Date(task.createdAt) : now;
                const daysDiff = task.createdAt ? Math.floor((now - createdDate) / (1000 * 60 * 60 * 24)) : 0;
                const column = columns.find(c => c.id === task.columnId);
                const assigneesText = task.assignees?.join(', ') || task.assignee || 'Êú™Ë®≠ÂÆö';
                
                // ÁµåÈÅéÊó•Êï∞„ÅÆË°®Á§∫ÔºàcreatedAt„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Äå‰ΩúÊàêÊó•‰∏çÊòé„Äç„Å®Ë°®Á§∫Ôºâ
                const elapsedText = task.createdAt ? `‚è±Ô∏è ${daysDiff}Êó•ÁµåÈÅé` : `‚è±Ô∏è ‰ΩúÊàêÊó•‰∏çÊòé`;
                
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${task.title}</div>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #5e6c84;">
                            <span>üë§ ${assigneesText}</span>
                            <span>üìç ${column?.title || '„Éº'}</span>
                            <span>${elapsedText}</span>
                            ${task.deadline ? `<span>üìÖ ÊúüÈôê: ${new Date(task.deadline).toLocaleDateString('ja-JP')}</span>` : ''}
                        </div>
                        ${task.memo ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">üìù ${task.memo.substring(0, 50)}...</div>` : ''}
                        <button onclick="editTask(${task.id})" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            Á¢∫Ë™ç„ÉªÁ∑®ÈõÜ
                        </button>
                    </div>
                `;
            }).join('');
            
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modalOverlay.id = 'stale-tasks-modal';
            
            modalOverlay.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h2 style="margin: 0; font-size: 1.25rem;">üö® 3Êó•‰ª•‰∏äÂÅúÊªû„Åó„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØÔºà${window.staleTasks.length}‰ª∂Ôºâ</h2>
                        <p style="margin: 0.5rem 0 0; color: #5e6c84; font-size: 0.9rem;">ÈÄ≤ÊçóÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Å™„Çø„Çπ„ÇØ„Åß„Åô</p>
                    </div>
                    <div>${taskListHtml}</div>
                    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button onclick="document.getElementById('stale-tasks-modal').remove()" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                </div>
            `;
            
            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }
        
        // „ÉÅ„Éº„É†Âπ≥Âùá1.2ÂÄç‰ª•‰∏ä„ÅÆË≤†Ëç∑ÊãÖÂΩìËÄÖ„ÅÆË©≥Á¥∞Ë°®Á§∫
        function showWorkloadDetail() {
            if (!window.overloadedAssignees || window.overloadedAssignees.length === 0) {
                alert('ÁèæÂú®„ÄÅÈÅéË≤†Ëç∑„ÅÆÊãÖÂΩìËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const avgTasks = Math.round(window.avgTasksPerPerson * 10) / 10;
            const threshold = Math.round(avgTasks * 1.2 * 10) / 10;
            
            const assigneeListHtml = window.overloadedAssignees.map(({ assignee, count }) => {
                const overloadPercentage = Math.round((count / avgTasks - 1) * 100);
                return `
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${assignee}</div>
                                <div style="font-size: 0.85rem; color: #5e6c84;">
                                    ÊãÖÂΩì„Çø„Çπ„ÇØÊï∞: ${count}‰ª∂ÔºàÂπ≥Âùá„ÅÆ${100 + overloadPercentage}%Ôºâ
                                </div>
                            </div>
                            <button onclick="document.getElementById('assignee-filter').value='${assignee}'; filterTasks(); this.closest('div[style*=\\"position: fixed\\"]').remove();" 
                                    style="padding: 0.25rem 0.75rem; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                „Çø„Çπ„ÇØÁ¢∫Ë™ç
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modalOverlay.id = 'workload-modal';
            
            modalOverlay.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h2 style="margin: 0; font-size: 1.25rem;">üë• Ë≤†Ëç∑Ë™øÊï¥„ÅåÂøÖË¶Å„Å™ÊãÖÂΩìËÄÖÔºà${window.overloadedAssignees.length}ÂêçÔºâ</h2>
                        <p style="margin: 0.5rem 0 0; color: #5e6c84; font-size: 0.9rem;">
                            „ÉÅ„Éº„É†Âπ≥Âùá: ${avgTasks}‰ª∂ / ‰∫∫„ÄÄÔΩú„ÄÄË¶ÅË™øÊï¥Âü∫Ê∫ñ: ${threshold}‰ª∂‰ª•‰∏ä
                        </p>
                    </div>
                    <div>${assigneeListHtml}</div>
                    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button onclick="document.getElementById('workload-modal').remove()" style="padding: 0.5rem 1rem; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                </div>
            `;
            
            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }
        
        function showStatusDetails(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (!column) return;
            
            const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
            let filteredTasks = tasks;
            
            // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
            if (assigneeFilter) {
                filteredTasks = tasks.filter(t => {
                    if (t.assignees && Array.isArray(t.assignees)) {
                        return t.assignees.includes(assigneeFilter);
                    }
                    return t.assignee === assigneeFilter;
                });
            }
            
            // Ë©≤ÂΩì„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Çø„Çπ„ÇØ„ÇíÂèñÂæó
            const statusTasks = filteredTasks.filter(t => {
                // ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÅØÊúüÈôêÂàá„Çå„Ç®„É™„Ç¢„Å´Ë°®Á§∫„Åï„Çå„Çã„ÅÆ„ÅßÈô§Â§ñ
                if (t.columnId !== 'done' && t.deadline && isOverdue(t.deadline, t.columnId)) {
                    return false;
                }
                return t.columnId === columnId;
            });
            
            if (statusTasks.length === 0) {
                alert(`${column.title}„Çπ„ÉÜ„Éº„Çø„Çπ„Å´„ÅØ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`);
                return;
            }
            
            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const now = new Date();
            const taskListHtml = statusTasks.map(task => {
                const createdDate = new Date(task.createdAt);
                const daysOld = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                const deadline = new Date(task.deadline);
                const isOverdueTask = deadline < now;
                const assigneeList = Array.isArray(task.assignees) ? task.assignees.join(', ') : (task.assignee || 'Êú™Ë®≠ÂÆö');
                
                return `
                    <div style="
                        padding: 0.75rem; 
                        margin-bottom: 0.5rem; 
                        background: white; 
                        border: 1px solid #e5e7eb; 
                        border-radius: 6px;
                        ${isOverdueTask ? 'border-left: 4px solid #dc2626;' : ''}
                    ">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem; ${isOverdueTask ? 'color: #dc2626;' : ''}">${task.title}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    üë§ ${assigneeList} | üìÖ ${deadline.toLocaleDateString('ja-JP')} | ‚è∞ ${daysOld}Êó•ÁµåÈÅé
                                </div>
                            </div>
                            <button onclick="editTask(${task.id}); closeStatusModal();" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Á∑®ÈõÜ
                            </button>
                        </div>
                        ${task.memo ? `<div style="font-size: 0.85rem; color: #4b5563; margin-top: 0.5rem;">${task.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // „É¢„Éº„ÉÄ„É´HTMLÁîüÊàê
            const modalHtml = `
                <div id="status-detail-modal" style="
                    position: fixed; 
                    top: 0; left: 0; 
                    width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 1000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                " onclick="closeStatusModal()">
                    <div style="
                        background: white; 
                        border-radius: 8px; 
                        padding: 1.5rem; 
                        max-width: 600px; 
                        max-height: 80vh; 
                        overflow-y: auto;
                        margin: 1rem;
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem;">
                            <h3 style="margin: 0; color: #111827;">üìã ${column.title} (${statusTasks.length}‰ª∂)</h3>
                            <button onclick="closeStatusModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
                        </div>
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-size: 0.9rem; color: #374151;">
                                Âπ≥ÂùáÊªûÁïôÊôÇÈñì: <strong>${Math.round((statusTasks.reduce((sum, t) => sum + Math.floor((now - new Date(t.createdAt)) / (1000 * 60 * 60 * 24)), 0) / statusTasks.length) * 10) / 10}Êó•</strong>
                            </div>
                        </div>
                        <div>${taskListHtml}</div>
                    </div>
                </div>
            `;
            
            // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§„Åó„Å¶„Åã„ÇâÊñ∞„Åó„ÅÑ„É¢„Éº„ÉÄ„É´„ÇíËøΩÂä†
            const existingModal = document.getElementById('status-detail-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            console.log('üé® [RENDER] Render completed successfully');
        }
        
        function closeStatusModal() {
            const modal = document.getElementById('status-detail-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        
        
        // üî• ÂÆåÂÖ®FirebaseÂåñ: „Çø„Çπ„ÇØ‰øùÂ≠òÊ©üËÉΩ
        function saveTasks() {
            console.log('üî• [FIREBASE-ONLY] saveTasks„ÅØ‰∏çË¶Å - Firebase„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„Å´„Çà„ÇäËá™Âãï‰øùÂ≠ò');
            console.log('üìù [INFO] „Çø„Çπ„ÇØ„ÅÆÂ§âÊõ¥„ÅØFirebaseDB„ÅÆÂêÑÈñ¢Êï∞„ÅßÁõ¥Êé•Firestore„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô');
            
            // üîß ÈáçË¶Å: LocalStorage„ÅØÂÆåÂÖ®„Å´ÂªÉÊ≠¢
            // „Åü„Å†„Åó„ÄÅFirebase„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„Å´„Çà„Å£„Å¶window.tasks„ÅØËá™ÂãïÊõ¥Êñ∞„Åï„Çå„Çã
            // ÂêÑÊìç‰ΩúÔºà‰ΩúÊàê„ÉªÊõ¥Êñ∞„ÉªÂâäÈô§Ôºâ„ÅØÂÄãÂà•„Å´FirebaseDBÈñ¢Êï∞„ÇíÂëº„Å∂ÂøÖË¶Å„Åå„ÅÇ„Çã
            
            console.warn('‚ö†Ô∏è [DEPRECATED] saveTasks()„ÅØÂªÉÊ≠¢‰∫àÂÆö„Åß„Åô„ÄÇÊìç‰Ωú„ÅØÁõ¥Êé•FirebaseDBÈñ¢Êï∞„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            console.warn('   - ‰ΩúÊàê: window.FirebaseDB.createTask(task)');
            console.warn('   - Êõ¥Êñ∞: window.FirebaseDB.updateTask(taskId, updates)');
            console.warn('   - ÂâäÈô§: window.FirebaseDB.deleteTask(taskId)');
            
            return true; // ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊàêÂäü„ÇíËøî„Åô
        }
        
        // ÈÄöÁü•Ê©üËÉΩ
        let notificationPermission = false;
        
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationPermission = (permission === 'granted');
                    console.log('ÈÄöÁü•Ë®±ÂèØ:', notificationPermission);
                    
                    // Ë®±ÂèØ„ÅåÂèñ„Çå„ÅüÂ†¥Âêà„ÅØ„ÉÜ„Çπ„ÉàÈÄöÁü•„ÇíË°®Á§∫
                    if (notificationPermission) {
                        showNotification('üéØ ÈÄöÁü•Ë®≠ÂÆöÂÆå‰∫Ü', '„Çø„Çπ„ÇØ„ÅÆÊúüÈôêÈÄöÁü•„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ');
                    }
                });
            }
        }
        
        function testNotification() {
            if (notificationPermission) {
                showNotification('üîî „ÉÜ„Çπ„ÉàÈÄöÁü•', '„Åì„Çå„ÅØ„ÉÜ„Çπ„ÉàÈÄöÁü•„Åß„Åô„ÄÇÈÄöÁü•Ê©üËÉΩ„ÅØÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ');
            } else {
                alert('ÈÄöÁü•„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÅßÈÄöÁü•„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                requestNotificationPermission();
            }
        }
        
        function showNotification(title, body, options = {}) {
            console.log(`üîî ÈÄöÁü•Ë©¶Ë°å: ${title} - ${body}`);
            console.log(`üîî ÈÄöÁü•Ë®±ÂèØÁä∂ÊÖã: ${notificationPermission}`);
            console.log(`üîî NotificationÂØæÂøú: ${'Notification' in window}`);
            
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    console.log(`‚úÖ ÈÄöÁü•ÈÄÅ‰ø°: ${title}`);
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üéØ</text></svg>',
                        requireInteraction: false, // 3Áßí„ÅßËá™ÂãïÊ∂àÂéª„Åô„Çã„Åü„ÇÅÂ§âÊõ¥
                        ...options
                    });
                    
                    // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈÄöÁü•„ÇíÈñâ„Åò„Çã
                    setTimeout(() => {
                        notification.close();
                    }, 3000);
                    
                    // „Çø„Çπ„ÇØID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åß„Åù„ÅÆ„Çø„Çπ„ÇØ„ÇíÈñã„Åè
                    if (options.taskId) {
                        notification.onclick = () => {
                            window.focus(); // „Éñ„É©„Ç¶„Ç∂„Ç¶„Ç£„É≥„Éâ„Ç¶„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
                            editTask(options.taskId); // „Çø„Çπ„ÇØ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
                            notification.close();
                        };
                    }
                    
                    return notification;
                } else if (Notification.permission === 'default') {
                    console.log(`‚ö†Ô∏è ÈÄöÁü•Ë®±ÂèØË¶ÅÊ±Ç‰∏≠...`);
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            showNotification(title, body, options); // ÂÜçÂÆüË°å
                        }
                    });
                } else {
                    console.log(`‚ùå ÈÄöÁü•„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`);
                    alert(`ÈÄöÁü•: ${title}\n${body}`); // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                }
            } else {
                console.log(`‚ùå „Éñ„É©„Ç¶„Ç∂„ÅåÈÄöÁü•„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì`);
                alert(`ÈÄöÁü•: ${title}\n${body}`); // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            }
        }
        
        function checkDeadlines() {
            const now = new Date();
            const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
            const oneDayFromNow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            const threeHoursFromNow = new Date(now.getTime() + 3 * 60 * 60 * 1000);
            
            tasks.forEach(task => {
                if (task.columnId === 'done') return; // ÂÆå‰∫ÜÊ∏à„Åø„ÅØÈô§Â§ñ
                
                const deadline = new Date(task.deadline);
                const timeUntilDeadline = deadline.getTime() - now.getTime();
                
                // ÊúüÈôêÂàá„ÇåÈÄöÁü•
                if (deadline < now && !task.overdueNotified) {
                    showNotification(
                        'üö® ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ',
                        `„Äå${task.title}„Äç„ÅÆÊúüÈôê„ÅåÈÅé„Åé„Å¶„ÅÑ„Åæ„ÅôÔºÅ`,
                        { tag: `overdue-${task.id}`, taskId: task.id }
                    );
                    task.overdueNotified = true;
                }
                // 5ÂàÜÂâçÈÄöÁü•
                else if (timeUntilDeadline > 0 && timeUntilDeadline <= 5 * 60 * 1000 && !task.fiveMinNotified) {
                    showNotification(
                        'üö® Á∑äÊÄ•ÊúüÈôê',
                        `„Äå${task.title}„Äç„ÅÆÊúüÈôê„Åæ„Åß5ÂàÜ„Åß„ÅôÔºÅ`,
                        { tag: `fivemin-${task.id}`, taskId: task.id }
                    );
                    task.fiveMinNotified = true;
                }
                // 3ÊôÇÈñìÂâçÈÄöÁü•
                else if (timeUntilDeadline > 0 && timeUntilDeadline <= 3 * 60 * 60 * 1000 && !task.threeHourNotified) {
                    showNotification(
                        '‚ö†Ô∏è ÊúüÈôêÈñìËøë',
                        `„Äå${task.title}„Äç„ÅÆÊúüÈôê„Åæ„Åß3ÊôÇÈñì„Åß„Åô`,
                        { tag: `threehour-${task.id}`, taskId: task.id }
                    );
                    task.threeHourNotified = true;
                }
                // 1Êó•ÂâçÈÄöÁü•
                else if (timeUntilDeadline > 0 && timeUntilDeadline <= 24 * 60 * 60 * 1000 && !task.oneDayNotified) {
                    showNotification(
                        'üìÖ ÊúüÈôê‰∫àÂëä',
                        `„Äå${task.title}„Äç„ÅÆÊúüÈôê„Åæ„Åß1Êó•„Åß„Åô`,
                        { tag: `oneday-${task.id}`, taskId: task.id }
                    );
                    task.oneDayNotified = true;
                }
            });
            
            saveTasks(); // ÈÄöÁü•„Éï„É©„Ç∞„Çí‰øùÂ≠ò
        }
        
        // Ë®≠ÂÆöÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            loadAlertSettings();
            loadColumnManager();
            loadImportDefaults();
        }
        
        // „Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö„ÅÆÂàùÊúüÂåñ
        function loadImportDefaults() {
            // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            const assigneeSelect = document.getElementById('default-assignee');
            assigneeSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            assignees.forEach(assignee => {
                const option = document.createElement('option');
                option.value = assignee;
                option.textContent = assignee;
                assigneeSelect.appendChild(option);
            });
            
            // „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            const columnSelect = document.getElementById('default-column');
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // „Éá„Éï„Ç©„É´„ÉàÊúüÈôê„Çí‰ªäÊó•„Å´Ë®≠ÂÆö
            document.getElementById('default-deadline').value = new Date().toISOString().split('T')[0];
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
            saveAlertSettings();
        }
        
        // „Ç´„É©„É†ÁÆ°ÁêÜÊ©üËÉΩ
        function loadColumnManager() {
            const columnList = document.getElementById('column-list');
            columnList.innerHTML = columns.map((column, index) => `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                    <span style="flex: 1;">${column.title}</span>
                    <input type="color" value="${column.color}" onchange="updateColumnColor(${index}, this.value)" style="width: 40px; height: 30px; border: none; border-radius: 4px;">
                    <button onclick="editColumnName(${index})" style="padding: 0.25rem 0.5rem; background: #026aa7; color: white; border: none; border-radius: 4px; cursor: pointer;">Á∑®ÈõÜ</button>
                    ${columns.length > 2 ? `<button onclick="deleteColumn(${index})" style="padding: 0.25rem 0.5rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">ÂâäÈô§</button>` : ''}
                </div>
            `).join('');
        }
        
        function addColumn() {
            const newColumnName = document.getElementById('new-column-name').value.trim();
            if (!newColumnName) {
                alert('„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const newColumn = {
                id: 'custom_' + Date.now(),
                title: newColumnName,
                color: '#026aa7'
            };
            
            columns.push(newColumn);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            document.getElementById('new-column-name').value = '';
            loadColumnManager();
            renderBoard();
        }
        
        function editColumnName(index) {
            const newName = prompt('Êñ∞„Åó„ÅÑ„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', columns[index].title);
            if (newName && newName.trim()) {
                columns[index].title = newName.trim();
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                loadColumnManager();
                renderBoard();
            }
        }
        
        function updateColumnColor(index, color) {
            columns[index].color = color;
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            render(); // Âç≥Â∫ß„Å´ÂèçÊò†
        }
        
        function deleteColumn(index) {
            if (columns.length <= 2) {
                alert('ÊúÄ‰Ωé2„Å§„ÅÆ„Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            const columnToDelete = columns[index];
            const tasksInColumn = tasks.filter(task => task.columnId === columnToDelete.id);
            
            if (tasksInColumn.length > 0) {
                const moveToColumn = prompt(`„Åì„ÅÆ„Ç´„É©„É†„Å´„ÅØ${tasksInColumn.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÁßªÂãïÂÖà„ÅÆ„Ç´„É©„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (${columns.filter((_, i) => i !== index).map(c => c.id).join(', ')}):`);
                if (!moveToColumn) return;
                
                // „Çø„Çπ„ÇØ„ÇíÁßªÂãï
                tasksInColumn.forEach(task => {
                    task.columnId = moveToColumn;
                });
            }
            
            columns.splice(index, 1);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            saveTasks();
            loadColumnManager();
            render();
        }
        
        // „Ç§„É≥„É©„Ç§„É≥ „Ç´„É©„É†ÁÆ°ÁêÜÊ©üËÉΩ
        function quickAddColumn() {
            const newColumnName = document.getElementById('quick-column-name').value.trim();
            if (!newColumnName) {
                alert('„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const newColumn = {
                id: 'custom_' + Date.now(),
                title: newColumnName,
                color: '#026aa7'
            };
            
            columns.push(newColumn);
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            document.getElementById('quick-column-name').value = '';
            render();
        }
        
        function editColumnNameInline(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (!column) return;
            
            const newName = prompt('Êñ∞„Åó„ÅÑ„Ç´„É©„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', column.title);
            if (newName && newName.trim()) {
                column.title = newName.trim();
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                render();
            }
        }
        
        function deleteColumnInline(columnId) {
            if (columns.length <= 2) {
                alert('ÊúÄ‰Ωé2„Å§„ÅÆ„Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            const columnIndex = columns.findIndex(c => c.id === columnId);
            const columnToDelete = columns[columnIndex];
            const tasksInColumn = tasks.filter(task => task.columnId === columnId);
            
            if (tasksInColumn.length > 0) {
                const availableColumns = columns.filter(c => c.id !== columnId);
                const moveToColumn = prompt(`„Åì„ÅÆ„Ç´„É©„É†„Å´„ÅØ${tasksInColumn.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÁßªÂãïÂÖà„ÅÆ„Ç´„É©„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n\n${availableColumns.map((c, i) => `${i+1}. ${c.title} (${c.id})`).join('\n')}\n\nÁßªÂãïÂÖà„ÅÆÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:`);
                
                if (!moveToColumn) return;
                
                const selectedIndex = parseInt(moveToColumn) - 1;
                if (selectedIndex >= 0 && selectedIndex < availableColumns.length) {
                    // „Çø„Çπ„ÇØ„ÇíÁßªÂãï
                    tasksInColumn.forEach(task => {
                        task.columnId = availableColumns[selectedIndex].id;
                    });
                } else {
                    alert('ÁÑ°Âäπ„Å™ÈÅ∏Êäû„Åß„Åô');
                    return;
                }
            }
            
            if (confirm(`„Ç´„É©„É†„Äå${columnToDelete.title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                columns.splice(columnIndex, 1);
                localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                saveTasks();
                render();
            }
        }
        
        function loadAlertSettings() {
            const settings = JSON.parse(localStorage.getItem('alertSettings') || '{"3hours": true, "1day": false, "overdue": true}');
            document.getElementById('alert-3hours').checked = settings['3hours'];
            document.getElementById('alert-1day').checked = settings['1day'];
            document.getElementById('alert-overdue').checked = settings.overdue;
        }
        
        function saveAlertSettings() {
            const settings = {
                '3hours': document.getElementById('alert-3hours').checked,
                '1day': document.getElementById('alert-1day').checked,
                'overdue': document.getElementById('alert-overdue').checked
            };
            localStorage.setItem('alertSettings', JSON.stringify(settings));
        }
        
        // ÁÆ°ÁêÜËÄÖÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„Åø„Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„ÉûÂà©Áî®ÂèØËÉΩÔºâ
        function isAdmin() {
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØË™çË®º„Ç∑„Çπ„ÉÜ„É†„Å®ÈÄ£Êê∫
            return localStorage.getItem('userRole') === 'admin';
        }
        
        function setTheme(themeName, color, secondaryColor, darkColor, lightColor) {
            // „Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„Éû„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„Åø
            if (themeName === 'black' && !isAdmin()) {
                alert('„Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„Éû„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂà©Áî®ÂèØËÉΩ„Åß„Åô');
                return;
            }
            
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-color-secondary', secondaryColor);
            document.documentElement.style.setProperty('--theme-color-dark', darkColor);
            document.documentElement.style.setProperty('--theme-color-light', lightColor);
            
            // „Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„Éû„ÅÆÂ†¥Âêà„ÄÅËøΩÂä†„ÅÆ„Çπ„Çø„Ç§„É´Â§âÊõ¥
            if (themeName === 'black') {
                document.documentElement.style.setProperty('--body-bg', '#0d1117');
                document.documentElement.style.setProperty('--text-color', '#c9d1d9');
                document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #161b22 0%, #0d1117 100%)');
                document.documentElement.style.setProperty('--border-color', '#30363d');
                document.body.classList.add('dark-theme');
            } else {
                document.documentElement.style.setProperty('--body-bg', '#f4f5f7');
                document.documentElement.style.setProperty('--text-color', '#172b4d');
                document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)');
                document.documentElement.style.setProperty('--border-color', '#dfe1e6');
                document.body.classList.remove('dark-theme');
            }
            
            localStorage.setItem('selectedTheme', themeName);
            localStorage.setItem('themeColors', JSON.stringify({
                primary: color,
                secondary: secondaryColor,
                dark: darkColor,
                light: lightColor,
                themeName: themeName
            }));
            
            closeSettingsModal();
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            const savedColors = localStorage.getItem('themeColors');
            
            if (savedTheme && savedColors) {
                const colors = JSON.parse(savedColors);
                document.documentElement.style.setProperty('--theme-color', colors.primary);
                document.documentElement.style.setProperty('--theme-color-secondary', colors.secondary);
                document.documentElement.style.setProperty('--theme-color-dark', colors.dark);
                document.documentElement.style.setProperty('--theme-color-light', colors.light);
                
                // „Éñ„É©„ÉÉ„ÇØ„ÉÜ„Éº„Éû„ÅÆÂ†¥Âêà„ÄÅËøΩÂä†„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
                if (colors.themeName === 'black' || savedTheme === 'black') {
                    document.documentElement.style.setProperty('--body-bg', '#0d1117');
                    document.documentElement.style.setProperty('--text-color', '#c9d1d9');
                    document.documentElement.style.setProperty('--stats-bg', 'linear-gradient(135deg, #161b22 0%, #0d1117 100%)');
                    document.documentElement.style.setProperty('--border-color', '#30363d');
                    document.body.classList.add('dark-theme');
                }
            }
        }
        
        // ÂàùÊúüÂåñ
        async function init() {
            // „ÉÜ„Éº„Éû„ÇíË™≠„ÅøËæº„Åø
            loadTheme();
            
            // ÈÄöÁü•Ë®±ÂèØ„ÇíË¶ÅÊ±Ç
            requestNotificationPermission();
            
            // „É°„É≥„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ
            setupMentionSystem();
            
            // FirebaseÁµ±Âêà - Ë™çË®º„ÇíÂæÖ„Å£„Å¶„Åã„Çâ„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            try {
                console.log('üî• [INIT] FirebaseÁµ±ÂêàÊ∫ñÂÇô‰∏≠...');
                
                // FirebaseË™çË®ºÁä∂ÊÖã„ÇíÂæÖ„Å§ÔºàÊúÄÂ§ß3ÁßíÔºâ
                let waitTime = 0;
                const checkInterval = 100;
                while (waitTime < 3000) {
                    if (window.FirebaseAuth && window.FirebaseDB) {
                        console.log('‚úÖ [INIT] FirebaseÊ∫ñÂÇôÂÆå‰∫Ü');
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                    waitTime += checkInterval;
                }
                
                if (!window.FirebaseAuth || !window.FirebaseDB) {
                    console.warn('‚ö†Ô∏è [INIT] FirebaseÊú™Ê∫ñÂÇô„ÅÆ„Åü„ÇÅLocalStorage„Çí‰ΩøÁî®');
                    tasks = loadTasksFromStorage();
                } else {
                    // Firebase Auth„ÅÆ„É≠„Ç∞„Ç§„É≥„ÇíË©¶Ë°å
                    const localSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
                    if (localSession && localSession.user) {
                        console.log('üîê [INIT] Firebase„É≠„Ç∞„Ç§„É≥Ë©¶Ë°å‰∏≠:', localSession.user.email);
                        
                        // „É≠„Éº„Ç´„É´„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„É¶„Éº„Ç∂„Éº„ÅßFirebase„É≠„Ç∞„Ç§„É≥
                        // „Éë„Çπ„ÉØ„Éº„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàÂÆüÈöõ„ÅÆÈÅãÁî®„Åß„ÅØÂÆâÂÖ®„Å™ÊñπÊ≥ï„ÅßÁÆ°ÁêÜÔºâ
                        const passwordMap = {
                            'muranaka-tenma@terracom.co.jp': 'Tenma7041',
                            'kato-jun@terracom.co.jp': 'aikakumei',
                            'asahi-keiichi@terracom.co.jp': 'aikakumei',
                            'hanzawa-yuka@terracom.co.jp': 'aikakumei',
                            'tamura-wataru@terracom.co.jp': 'aikakumei',
                            'hashimoto-yumi@terracom.co.jp': 'aikakumei',
                            'fukushima-ami@terracom.co.jp': 'aikakumei'
                        };
                        
                        const password = passwordMap[localSession.user.email] || 'aikakumei';
                        const signInResult = await window.FirebaseAuth.signIn(
                            localSession.user.email,
                            password
                        );
                        
                        if (signInResult.success) {
                            console.log('‚úÖ [INIT] Firebase„É≠„Ç∞„Ç§„É≥ÊàêÂäü');
                            
                            // üîß FirebaseË™çË®ºÁä∂ÊÖã„ÅÆÁ¢∫Ë™çÔºàÂº∑Âà∂ÂêåÊúü„ÅØÁÑ°ÂäπÂåñÔºâ
                            const firebaseUser = window.firebaseAuth?.currentUser || signInResult.user;
                            console.log('üîÑ [SYNC] FirebaseË™çË®º„É¶„Éº„Ç∂„ÉºÁ¢∫Ë™ç:', firebaseUser?.email);
                            console.log('üîÑ [SYNC] „É≠„Éº„Ç´„É´„Çª„ÉÉ„Ç∑„Éß„É≥„É¶„Éº„Ç∂„Éº:', localSession?.user?.email);
                            
                            // „É≠„Éº„Ç´„É´„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøFirebaseË™çË®º„Å´Âêà„Çè„Åõ„Çã
                            if (firebaseUser && (!localSession || !localSession.user)) {
                                console.log('üîß [SYNC] „É≠„Éº„Ç´„É´„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅFirebaseË™çË®º„Å´Âêà„Çè„Åõ„Å¶ÂàùÊúüÂåñ');
                                
                                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                                const correctUser = systemUsers.find(u => u.email === firebaseUser.email);
                                
                                if (correctUser) {
                                    const updatedSession = {
                                        user: {
                                            id: correctUser.id,
                                            name: correctUser.name,
                                            email: correctUser.email,
                                            role: correctUser.role,
                                            department: correctUser.department
                                        },
                                        loginTime: new Date().toISOString(),
                                        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                                    };
                                    localStorage.setItem('currentSession', JSON.stringify(updatedSession));
                                    localStorage.setItem('currentUser', correctUser.name);
                                    console.log('‚úÖ [SYNC] FirebaseË™çË®º„Å´Âêà„Çè„Åõ„Å¶„Çª„ÉÉ„Ç∑„Éß„É≥ÂàùÊúüÂåñÂÆå‰∫Ü:', correctUser.name, correctUser.role, correctUser.email);
                                } else {
                                    console.error('‚ùå [SYNC] FirebaseË™çË®º„É¶„Éº„Ç∂„Éº„ÅåsystemUsers„Å´Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', firebaseUser.email);
                                }
                            } else if (firebaseUser && localSession && localSession.user) {
                                console.log('‚ÑπÔ∏è [SYNC] „É≠„Éº„Ç´„É´„Çª„ÉÉ„Ç∑„Éß„É≥Á∂≠ÊåÅ:', localSession.user.name, '(Firebase:', firebaseUser.email + ')');
                            }
                            
                            // „É≠„Ç∞„Ç§„É≥ÊàêÂäüÂæå„ÄÅÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            console.log('üî• [INIT] FirebaseÁµ±Âêà„Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÈñãÂßã...');
                            tasks = await loadTasks();
                            console.log('‚úÖ [INIT] „Çø„Çπ„ÇØ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', tasks.length, '‰ª∂');
                        } else {
                            console.warn('‚ö†Ô∏è [INIT] Firebase„É≠„Ç∞„Ç§„É≥Â§±Êïó:', signInResult.error);
                            tasks = loadTasksFromStorage();
                        }
                    } else {
                        console.warn('‚ö†Ô∏è [INIT] „É≠„Éº„Ç´„É´„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó - LocalStorage‰ΩøÁî®');
                        tasks = loadTasksFromStorage();
                    }
                }
            } catch (error) {
                console.error('‚ùå [INIT] FirebaseÁµ±Âêà„Ç®„É©„Éº - LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ:', error);
                tasks = loadTasksFromStorage();
            }
            
            // FirebaseÁµ±Âêà - „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            try {
                console.log('üî• [INIT] FirebaseÁµ±Âêà„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„ÅøÈñãÂßã...');
                taskTemplates = await loadTemplates();
                console.log('‚úÖ [INIT] „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', taskTemplates.length, '‰ª∂');
            } catch (error) {
                console.error('‚ùå [INIT] „ÉÜ„É≥„Éó„É¨„Éº„ÉàFirebaseÁµ±Âêà„Ç®„É©„Éº - LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ:', error);
                taskTemplates = JSON.parse(localStorage.getItem('taskTemplates') || '[]');
            }
            
            // ÂÆöÊúü„Çø„Çπ„ÇØ„ÅÆËá™ÂãïÁîüÊàê„ÉÅ„Çß„ÉÉ„ÇØ
            checkAndGenerateRecurringTasks();
            
            // Phase 2ÂØæÂøú: Êó¢Â≠ò„Çø„Çπ„ÇØ„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥
            tasks = tasks.map(task => {
                // PJÈñ¢ÈÄ£„Éï„Ç£„Éº„É´„Éâ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
                if (task.projectId === undefined) {
                    return {
                        ...task,
                        // PJ„Çø„Çπ„ÇØÊã°Âºµ„Éï„Ç£„Éº„É´„Éâ
                        projectId: null,           // PJ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅÆ„ÅøË®≠ÂÆö
                        projectName: null,         // PJË°®Á§∫Âêç
                        
                        // „Çπ„ÉÜ„Éº„Çø„ÇπÁÆ°ÁêÜÔºà„Éá„É•„Ç¢„É´ÁÆ°ÁêÜÔºâ
                        personalStatus: task.columnId || 'todo', // ÂÄã‰∫∫ÂÅ¥„Åß„ÅÆÈÄ≤ÊçóÁä∂ÊÖã
                        projectStatus: task.columnId || 'todo',  // PJÂÅ¥„Åß„ÅÆÊâøË™çÁä∂ÊÖã
                        
                        // ÁßªÂãïÁî≥Ë´ãÁÆ°ÁêÜ
                        pendingMove: null,
                        
                        // ÊâøË™çËÄÖË®≠ÂÆö
                        approvers: [],             // „Åì„ÅÆPJ„ÅÆÊâøË™çËÄÖ„É™„Çπ„Éà
                        lastApprovedBy: null,      // ÊúÄÂæå„Å´ÊâøË™ç„Åó„Åü‰∫∫
                        approvedAt: null,          // ÊâøË™çÊó•ÊôÇ
                        
                        // ÁßªÂãïÊôÇÂàªË®òÈå≤ÔºàË®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÁî®Ôºâ
                        lastMovedAt: null          // ÊúÄÂæå„ÅÆÁßªÂãïÊôÇÂàª
                    };
                }
                return task;
            });

            // Êó¢Â≠ò„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫ÈÖçÂàó
            if (tasks.length === 0) {
                tasks = [];
                saveTasks();
            }
            
            // ÁîªÈù¢Êõ¥Êñ∞
            if (!window.FirebaseAuth || !window.FirebaseDB) {
                render();
                updateStats();
            } else {
                updateStats();
            }
            
            // UIÊõ¥Êñ∞
            setTimeout(() => {
                updateHamburgerMenu();
                
                // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇísystemUsers„Åã„ÇâËá™ÂãïÊõ¥Êñ∞
                const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                if (systemUsers.length > 0) {
                    assignees = systemUsers.map(u => u.name);
                    window.assignees = assignees;
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                }
                
                // ÁîªÈù¢‰∏äÈÉ®„ÅÆ„É¶„Éº„Ç∂„ÉºË°®Á§∫Êõ¥Êñ∞
                const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (currentSession?.user) {
                    const headerTitle = document.querySelector('.header-title');
                    if (headerTitle) {
                        const roleNames = {
                            'developer': 'ÈñãÁô∫ËÄÖ',
                            'admin': 'ÁÆ°ÁêÜËÄÖ',
                            'user': '‰∏ÄËà¨„É¶„Éº„Ç∂„Éº'
                        };
                        const roleName = roleNames[currentSession.user.role] || currentSession.user.role;
                        
                        headerTitle.innerHTML = `
                            üéØ Âñ∂Ê•≠„Çø„Çπ„ÇØÁÆ°ÁêÜ
                            <span style="font-size: 0.8rem; font-weight: normal; margin-left: 1rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">
                                ${currentSession.user.name} (${roleName})
                            </span>
                        `;
                    }
                }
            }, 200);
            
            // ÂÆöÊúüÁöÑ„Å´ÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØÔºà1ÂàÜÈñìÈöîÔºâ
            checkDeadlines();
            setInterval(checkDeadlines, 1 * 60 * 1000);
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // „ÇØ„É™„ÉÉ„ÇØ„Åß„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            const filterContainer = document.getElementById('assignee-filter-container');
            const dropdown = document.getElementById('assignee-filter-dropdown');
            
            if (filterContainer && !filterContainer.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // „Éï„Ç°„Ç§„É´„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ
        function setupFileDropZone() {
            const dropZone = document.getElementById('file-drop-zone');
            const fileInput = document.getElementById('task-files-input');
            
            if (!dropZone || !fileInput) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    // FileList„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
                    const dt = new DataTransfer();
                    // Êó¢Â≠ò„ÅÆ„Éï„Ç°„Ç§„É´„ÇÇËøΩÂä†
                    Array.from(fileInput.files).forEach(file => dt.items.add(file));
                    // Êñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´„ÇíËøΩÂä†
                    files.forEach(file => dt.items.add(file));
                    
                    fileInput.files = dt.files;
                    
                    // „Éï„Ç°„Ç§„É´Êï∞„ÇíË°®Á§∫
                    dropZone.innerHTML = `üìÅ ${dt.files.length}ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`;
                    
                    }
            });
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆË°®Á§∫Êõ¥Êñ∞
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    dropZone.innerHTML = `üìÅ ${fileInput.files.length}ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`;
                } else {
                    dropZone.innerHTML = 'üìÅ „Åì„Åì„Å´„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó „Åæ„Åü„ÅØ ‰∏äË®ò„Éú„Çø„É≥„ÅßÈÅ∏Êäû';
                }
            });
        }
        
        // üîß Á∑äÊÄ•Ë®∫Êñ≠: „É™„Ç¢„É´„Çø„Ç§„É†„Çø„Çπ„ÇØÁä∂Ê≥ÅÁ¢∫Ë™ç
        function emergencyDiagnosis() {
            console.log('üö® [EMERGENCY-DIAGNOSIS] Á∑äÊÄ•Ë®∫Êñ≠ÈñãÂßã...');
            
            const diagnosis = {
                timestamp: new Date().toISOString(),
                globalTasks: {
                    exists: typeof window.tasks !== 'undefined',
                    count: window.tasks ? window.tasks.length : 'undefined',
                    type: typeof window.tasks,
                    sample: window.tasks ? window.tasks.slice(0, 2).map(t => ({id: t.id, title: t.title?.substring(0, 20)})) : 'none'
                },
                localStorage: {
                    exists: !!localStorage.getItem('salesTasksKanban'),
                    size: localStorage.getItem('salesTasksKanban')?.length || 0,
                    count: (() => {
                        try {
                            const stored = localStorage.getItem('salesTasksKanban');
                            return stored ? JSON.parse(stored).length : 0;
                        } catch(e) { return 'parse-error'; }
                    })()
                },
                firebase: {
                    hasAuth: !!window.FirebaseAuth,
                    hasDB: !!window.FirebaseDB,
                    currentUser: window.firebaseAuth?.currentUser?.email || 'none',
                    debugFunctions: !!window.FirebaseDebug
                },
                dom: {
                    kanbanExists: !!document.querySelector('.kanban-board'),
                    columnsCount: document.querySelectorAll('.kanban-column').length,
                    tasksInDOM: document.querySelectorAll('.kanban-task').length
                }
            };
            
            console.log('üîç [EMERGENCY-DIAGNOSIS] Ë®∫Êñ≠ÁµêÊûú:', diagnosis);
            
            // „Ç¢„É©„Éº„Éà„Åß„ÇÇË°®Á§∫
            alert(`Á∑äÊÄ•Ë®∫Êñ≠ÁµêÊûú:
            
„Ç∞„É≠„Éº„Éê„É´tasks: ${diagnosis.globalTasks.count}‰ª∂
LocalStorage: ${diagnosis.localStorage.count}‰ª∂  
DOMÂÜÖ„Çø„Çπ„ÇØ: ${diagnosis.dom.tasksInDOM}‰ª∂
FirebaseË™çË®º: ${diagnosis.firebase.currentUser}

Ë©≥Á¥∞„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            
            return diagnosis;
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨Èñã
        window.emergencyDiagnosis = emergencyDiagnosis;
        
        // FirebaseÁä∂ÊÖãÁ¢∫Ë™çÈñ¢Êï∞
        window.debugFirebase = async function() {
            const user = window.firebaseAuth?.currentUser;
            const localTasks = JSON.parse(localStorage.getItem('salesTasksKanban') || '[]');
            
            let message = '„ÄêFirebaseÁä∂ÊÖã„Äë\n';
            message += `Ë™çË®º: ${user ? '‚úÖ„É≠„Ç∞„Ç§„É≥‰∏≠' : '‚ùåÊú™„É≠„Ç∞„Ç§„É≥'}\n`;
            message += `„É¶„Éº„Ç∂„Éº: ${user?.email || '„Å™„Åó'}\n`;
            message += `„É≠„Éº„Ç´„É´„Çø„Çπ„ÇØ: ${localTasks.length}‰ª∂\n`;
            message += `Ë°®Á§∫‰∏≠„Çø„Çπ„ÇØ: ${tasks.length}‰ª∂\n`;
            
            alert(message);
            
            if (!user) {
                if (confirm('Firebase„Å´„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åô„ÅãÔºü')) {
                    const localSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
                    if (localSession?.user) {
                        // „Éë„Çπ„ÉØ„Éº„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞
                        const passwordMap = {
                            'muranaka-tenma@terracom.co.jp': 'Tenma7041',
                            'kato-jun@terracom.co.jp': 'aikakumei',
                            'asahi-keiichi@terracom.co.jp': 'aikakumei',
                            'hanzawa-yuka@terracom.co.jp': 'aikakumei',
                            'tamura-wataru@terracom.co.jp': 'aikakumei',
                            'hashimoto-yumi@terracom.co.jp': 'aikakumei',
                            'fukushima-ami@terracom.co.jp': 'aikakumei'
                        };
                        
                        const password = passwordMap[localSession.user.email] || 'aikakumei';
                        const result = await window.FirebaseAuth.signIn(localSession.user.email, password);
                        
                        if (result.success) {
                            alert('‚úÖ Firebase„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ\n„Çø„Çπ„ÇØ„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô„ÄÇ');
                            const newTasks = await loadTasks();
                            render();
                            alert(`‚úÖ „Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${newTasks.length}‰ª∂`);
                        } else {
                            alert('‚ùå „É≠„Ç∞„Ç§„É≥Â§±Êïó: ' + result.error);
                        }
                    }
                }
            } else {
                if (confirm('Firestore„Åã„Çâ„Çø„Çπ„ÇØ„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô„ÅãÔºü')) {
                    const newTasks = await loadTasks();
                    render();
                    alert(`‚úÖ „Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${newTasks.length}‰ª∂`);
                }
            }
        };
        
        // „Éá„Éê„ÉÉ„Ç∞Áî®„ÉÜ„Çπ„ÉàÈñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´Ôºâ
        window.testFirebaseSync = async function() {
            try {
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (!currentUser) {
                    alert('‚ùå Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }

                // ÂêåÊúü„ÉÜ„Çπ„Éà„Çø„Çπ„ÇØ„Çí‰ΩúÊàê
                const testTask = {
                    title: `üß™ÂêåÊúü„ÉÜ„Çπ„Éà ${new Date().toLocaleTimeString()}`,
                    description: '„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúüÁ¢∫Ë™çÁî®„ÅÆ„ÉÜ„Çπ„Éà„Çø„Çπ„ÇØ',
                    columnId: 'todo',
                    priority: 'low',
                    assignee: currentUser.email,
                    isTestTask: true
                };

                if (window.FirebaseDB && window.FirebaseDB.createTask) {
                    const result = await window.FirebaseDB.createTask(testTask);
                    if (result.success) {
                        alert(`‚úÖ ÂêåÊúü„ÉÜ„Çπ„Éà„Çø„Çπ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ\n‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Åß„Äåüß™ÂêåÊúü„ÉÜ„Çπ„Éà„Äç„Çø„Çπ„ÇØ„ÅåË°®Á§∫„Åï„Çå„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    } else {
                        alert(`‚ùå ÂêåÊúü„ÉÜ„Çπ„ÉàÂ§±Êïó: ${result.error}`);
                    }
                } else {
                    alert('‚ùå Firebase DB „ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                }
            } catch (error) {
                alert(`‚ùå „Ç®„É©„Éº: ${error.message}`);
                console.error('ÂêåÊúü„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
            }
        };

        // Âº∑Âà∂ÂêåÊúüÈñ¢Êï∞
        window.forceSync = async function() {
            alert('FirebaseÂêåÊúü„ÇíÈñãÂßã„Åó„Åæ„Åô...');
            
            // LocalStorage„Çí„ÇØ„É™„Ç¢ÔºàÂè§„ÅÑ„Éá„Éº„Çø„ÇíÂâäÈô§Ôºâ
            localStorage.removeItem('salesTasksKanban');
            
            // Firebase„É≠„Ç∞„Ç§„É≥„ÇíË©¶Ë°å
            const localSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (!localSession?.user) {
                alert('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „Éë„Çπ„ÉØ„Éº„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞
            const passwordMap = {
                'muranaka-tenma@terracom.co.jp': 'Tenma7041',
                'kato-jun@terracom.co.jp': 'aikakumei',
                'asahi-keiichi@terracom.co.jp': 'aikakumei',
                'hanzawa-yuka@terracom.co.jp': 'aikakumei',
                'tamura-wataru@terracom.co.jp': 'aikakumei',
                'hashimoto-yumi@terracom.co.jp': 'aikakumei',
                'fukushima-ami@terracom.co.jp': 'aikakumei'
            };
            
            try {
                // Firebase„É≠„Ç∞„Ç§„É≥
                if (!window.firebaseAuth?.currentUser) {
                    const password = passwordMap[localSession.user.email] || 'aikakumei';
                    const result = await window.FirebaseAuth.signIn(localSession.user.email, password);
                    
                    if (!result.success) {
                        alert('„É≠„Ç∞„Ç§„É≥Â§±Êïó: ' + result.error);
                        return;
                    }
                    
                    alert('‚úÖ Firebase„É≠„Ç∞„Ç§„É≥ÊàêÂäü');
                }
                
                // „Çø„Çπ„ÇØ„ÇíÂº∑Âà∂ÁöÑ„Å´Firestore„Åã„ÇâË™≠„ÅøËæº„Åø
                const tasksResult = await window.FirebaseDB.getTasks();
                if (tasksResult.success) {
                    tasks = tasksResult.tasks;
                    localStorage.setItem('salesTasksKanban', JSON.stringify(tasks));
                    render();
                    alert(`‚úÖ ÂêåÊúüÂÆå‰∫ÜÔºÅ\n${tasks.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
                } else {
                    alert('„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + tasksResult.error);
                }
            } catch (error) {
                alert('„Ç®„É©„Éº: ' + error.message);
            }
        };
        
        window.checkFirebaseAuth = function() {
            const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
            const message = currentUser 
                ? `‚úÖ „É≠„Ç∞„Ç§„É≥‰∏≠\n„É¶„Éº„Ç∂„Éº: ${currentUser.email}\nUID: ${currentUser.uid.substring(0, 8)}...`
                : '‚ùå Êú™„É≠„Ç∞„Ç§„É≥';
            
            console.log('üîç FirebaseË™çË®ºÁä∂ÊÖã:', {
                isAuthenticated: !!currentUser,
                user: currentUser ? currentUser.email : null,
                hasFirebaseAuth: !!window.FirebaseAuth,
                hasFirebaseDB: !!window.FirebaseDB,
                device: navigator.platform
            });
            
            alert(message);
        };

        // ÊãÖÂΩìËÄÖÈÅ∏Êäû„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà
        // üîß Âç≥Â∫ß„Å´„Éö„Éº„Ç∏Êõ¥Êñ∞„ÇíÊ§úÁü•„Åó„Å¶Ë®∫Êñ≠
        console.log('üö® [PAGE-RELOAD-DETECTION] „Éö„Éº„Ç∏„ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü');
        console.log('üîç [IMMEDIATE-CHECK] Âç≥Â∫ß„Å´LocalStorage„ÇíÁ¢∫Ë™ç...');
        
        const immediateLocalStorageCheck = localStorage.getItem('salesTasksKanban');
        console.log('üîç [IMMEDIATE-CHECK] salesTasksKanbanÂ≠òÂú®:', !!immediateLocalStorageCheck);
        console.log('üîç [IMMEDIATE-CHECK] „Éá„Éº„Çø„Çµ„Ç§„Ç∫:', immediateLocalStorageCheck ? immediateLocalStorageCheck.length : 0);
        
        if (immediateLocalStorageCheck) {
            try {
                const parsed = JSON.parse(immediateLocalStorageCheck);
                console.log('‚úÖ [IMMEDIATE-CHECK] LocalStorage„Å´', parsed.length, '‰ª∂„ÅÆ„Çø„Çπ„ÇØ„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                console.log('üîç [IMMEDIATE-CHECK] ÊúÄÂàù„ÅÆ3‰ª∂:', parsed.slice(0, 3).map(t => ({
                    id: t.id, 
                    title: t.title?.substring(0, 20),
                    createdBy: t.createdBy
                })));
            } catch(e) {
                console.error('‚ùå [IMMEDIATE-CHECK] LocalStorage„Éá„Éº„Çø„ÅÆËß£Êûê„Å´Â§±Êïó:', e);
            }
        } else {
            console.warn('‚ö†Ô∏è [IMMEDIATE-CHECK] LocalStorage„ÅåÁ©∫„Åß„Åô');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // üîß „ÄêÊúÄÂÑ™ÂÖà„Äë„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„ÇπÂàùÊúüÂåñ
            try {
                initializeUserDatabase();
                console.log('‚úÖ [INIT] „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„ÇπÂàùÊúüÂåñÂÆå‰∫Ü');
                
                // üîê „ÄêÈáçË¶Å„ÄëÊ®©ÈôêÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„Éª‰øÆÊ≠£„ÇíÂç≥Â∫ß„Å´ÂÆüË°åÔºà2ÂõûÂÆüË°å„ÅßÁ¢∫ÂÆü„Å´‰øÆÊ≠£Ôºâ
                ensureUserPermissionsIntegrity();
                setTimeout(() => ensureUserPermissionsIntegrity(), 100); // 0.1ÁßíÂæå„Å´ÂÜçÂÆüË°å
                console.log('‚úÖ [INIT] Ê®©ÈôêÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫ÜÔºà2ÂõûÂÆüË°åÔºâ');
                
                // üîç Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°åÔºàUIÂà∂Âæ°Âê´„ÇÄÔºâ
                setTimeout(() => {
                    checkUserPermission();
                    console.log('‚úÖ [INIT] Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü');
                }, 500); // 0.5ÁßíÂæå„Å´ÂÆüË°å
                
                // ÂÆöÊúüÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã
                startPeriodicPermissionCheck();
                console.log('üîÑ [INIT] ÂÆöÊúüÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßãÔºà5ÂàÜÈñìÈöîÔºâ');
            } catch (error) {
                console.error('‚ùå [INIT] „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Éô„Éº„ÇπÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
            
            // FirebaseÂàùÊúüÂåñÁä∂Ê≥Å„Çí„Éá„Éê„ÉÉ„Ç∞
            console.log('üöÄ [INIT-DEBUG] DOMContentLoadedÁô∫ÁÅ´:', {
                timestamp: new Date().toISOString(),
                device: navigator.platform,
                userAgent: navigator.userAgent.substring(0, 50) + '...',
                firebaseModules: {
                    hasFirebaseAuth: !!window.FirebaseAuth,
                    hasFirebaseDB: !!window.FirebaseDB,
                    hasFirebaseApp: !!window.firebaseApp,
                    hasFirebaseAuthObject: !!window.firebaseAuth
                },
                debugFunctions: {
                    hasCheckFirebaseAuth: typeof window.checkFirebaseAuth === 'function',
                    hasTestFirebaseSync: typeof window.testFirebaseSync === 'function'
                }
            });

            // „Éá„Éê„ÉÉ„Ç∞Èñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Å£„Åü„Åì„Å®„ÇíÈÄöÁü•
            console.log('üß™ „Éá„Éê„ÉÉ„Ç∞Èñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô:');
            console.log('  - Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç: checkFirebaseAuth()');
            console.log('  - ÂêåÊúü„ÉÜ„Çπ„Éà: testFirebaseSync()');

            // FirebaseË™çË®ºÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç
            setTimeout(() => {
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                console.log('üîê [INIT-DEBUG] FirebaseË™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç:', {
                    hasCurrentUser: !!currentUser,
                    userEmail: currentUser?.email || '„Å™„Åó',
                    userUID: currentUser?.uid || '„Å™„Åó',
                    timestamp: new Date().toISOString()
                });
            }, 1000);
            
            // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÇíÂàùÊúüÂåñÔºàÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶Á¢∫ÂÆü„Å´ÂÆüË°åÔºâ
            setTimeout(() => {
                updateHamburgerMenu();
                console.log('üçî „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÊõ¥Êñ∞ÂÆå‰∫Ü');
            }, 100);
            
            // ‰∏ªË¶ÅÂàùÊúüÂåñ„ÇíÂÆüË°å
            try {
                await init();
            } catch (error) {
                console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
            
            // OCR„É¢„Éº„ÉÄ„É´„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂàùÊúüÂåñ
            initOCRModalEventListeners();
            
            const assigneeSelect = document.getElementById('task-assignee-input');
            if (assigneeSelect) {
                assigneeSelect.addEventListener('change', function() {
                    if (this.value === '__ADD_NEW__') {
                        const newAssignee = prompt('Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                        if (newAssignee && newAssignee.trim()) {
                            const trimmedName = newAssignee.trim();
                            if (!assignees.includes(trimmedName)) {
                                assignees.push(trimmedName);
                                localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                            }
                            // ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞„Åó„Å¶Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû
                            updateAssigneeOptions();
                            this.value = trimmedName;
                        } else {
                            this.value = '';
                        }
                    }
                });
            }
            
            // „Ç´„É©„É†ËøΩÂä†„ÅßEnter„Ç≠„ÉºÂØæÂøú
            const quickColumnInput = document.getElementById('quick-column-name');
            if (quickColumnInput) {
                quickColumnInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        quickAddColumn();
                    }
                });
            }
            
            // „Éï„Ç°„Ç§„É´„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÇíË®≠ÂÆö
            setupFileDropZone();
        });
        
        // ÊüîËªü„ÉÜ„Ç≠„Çπ„Éà„Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩ
        let previewTasks = [];
        
        function previewImport() {
            const importText = document.getElementById('import-text').value.trim();
            if (!importText) {
                alert('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆöÔºà„É¶„Éº„Ç∂„ÉºÁµ±‰∏ÄÔºâ
            const currentUser = localStorage.getItem('currentUser') || '„É¶„Éº„Ç∂„Éº';
            const defaultAssignee = currentUser;
            
            // „Éá„Éï„Ç©„É´„ÉàÊúüÈôê„Çí‰ªäÊó•„ÅÆÊó•‰ªò+3ÊôÇÈñìÂæå„ÅÆÊôÇÈñì„Å´Ë®≠ÂÆö
            const now = new Date();
            
            // Êó•Êú¨ÊôÇÈñì„Åß‰ªäÊó•„ÅÆÊó•‰ªò„ÇíÊ≠£Á¢∫„Å´ÂèñÂæó
            const jstOffset = 9 * 60; // JST „ÅØ UTC+9
            const jstDate = new Date(now.getTime() + jstOffset * 60 * 1000);
            const year = jstDate.getFullYear();
            const month = (jstDate.getMonth() + 1).toString().padStart(2, '0');
            const day = jstDate.getDate().toString().padStart(2, '0');
            const defaultDeadline = `${year}-${month}-${day}`;
            
            const defaultTime = getDefaultTimeString(); // ÁèæÂú®ÊôÇÂàª+3ÊôÇÈñì
            
            console.log('üìÖ OCRÊó•‰ªòË®≠ÂÆö:', {
                now: now.toString(),
                jstDate: jstDate.toString(),
                defaultDeadline,
                defaultTime
            });
            
            const defaultPriority = 'medium';
            const defaultColumn = 'todo';
            
            // „ÉÜ„Ç≠„Çπ„Éà„ÇíË°å„Å´ÂàÜÂâ≤
            const lines = importText.split('\n');
            previewTasks = [];
            
            // ÂêÑË°å„ÇíÂÄãÂà•„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Å®„Åó„Å¶Âá¶ÁêÜ
            let lastMainTaskIndex = -1;
            
        lines.forEach((line, index) => {
            if (!line.trim()) return; // Á©∫Ë°å„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            
            const trimmedLine = line.trim();
            let taskText = trimmedLine;
            
            // „Çπ„Éû„Éº„ÉàÂà§ÂÆöÔºö„Ç§„É≥„Éá„É≥„ÉàÔºàÁ©∫ÁôΩÔºâ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            // ÂçäËßí„Çπ„Éö„Éº„Çπ2„Å§‰ª•‰∏ä„ÄÅÂÖ®Ëßí„Çπ„Éö„Éº„Çπ1„Å§‰ª•‰∏ä„ÄÅ„Åæ„Åü„ÅØ„Çø„ÉñÊñáÂ≠ó
            const hasIndent = line.match(/^(\s{2,}|„ÄÄ+|\t+)/);
            const isMainTask = !hasIndent;
            
            // ÊãÖÂΩìËÄÖ„ÇíÊäΩÂá∫
            const assigneeMatch = taskText.match(/@([^\s@]+)/g);
            let assignee = defaultAssignee;
            if (assigneeMatch && assigneeMatch.length > 0) {
                assignee = assigneeMatch[0].replace('@', '');
                taskText = taskText.replace(/@[^\s@]+/g, '').trim();
            }
            
            // Êó•‰ªò„ÇíÊäΩÂá∫
            const dateMatches = taskText.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}Êúà\d{1,2}Êó•)/g);
            let deadline = defaultDeadline;
            if (dateMatches && dateMatches.length > 0) {
                let dateStr = dateMatches[0];
                if (dateStr.includes('Êúà') && dateStr.includes('Êó•')) {
                    const year = new Date().getFullYear();
                    const month = dateStr.match(/(\d{1,2})Êúà/)[1].padStart(2, '0');
                    const day = dateStr.match(/(\d{1,2})Êó•/)[1].padStart(2, '0');
                    deadline = `${year}-${month}-${day}`;
                } else {
                    const parts = dateStr.split(/[-\/]/);
                    if (parts[0].length === 4) {
                        deadline = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    } else {
                        const year = parts[2].length === 4 ? parts[2] : new Date().getFullYear();
                        deadline = `${year}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                    }
                }
                taskText = taskText.replace(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}Êúà\d{1,2}Êó•)/g, '').trim();
            }
            
            // ÂÑ™ÂÖàÂ∫¶„ÇíÊäΩÂá∫
            let priority = defaultPriority;
            if (taskText.match(/[!ÔºÅ]{2,}|È´ò|Á∑äÊÄ•|urgent|URGENT|ÊÄ•/)) {
                priority = 'high';
                taskText = taskText.replace(/[!ÔºÅ]+|È´ò|Á∑äÊÄ•|urgent|URGENT|ÊÄ•/g, '').trim();
            } else if (taskText.match(/‰Ωé|later|LATER|Âæå„Åß/)) {
                priority = 'low';
                taskText = taskText.replace(/‰Ωé|later|LATER|Âæå„Åß/g, '').trim();
            }
            
            taskText = taskText.replace(/\s+/g, ' ').trim();
            
            if (taskText && taskText.length > 1) {
                const task = {
                    id: `preview_${index}`,
                    title: taskText,
                    assignee: assignee,
                    deadline: deadline,
                    time: defaultTime, // ÊôÇÈñìÊÉÖÂ†±„ÇíËøΩÂä†
                    priority: priority,
                    columnId: defaultColumn,
                    originalLine: line,
                    lineIndex: index,
                    isMainTask: isMainTask, // „Çπ„Éû„Éº„ÉàÂà§ÂÆöÁµêÊûú
                    parentIndex: isMainTask ? null : lastMainTaskIndex, // Ëá™Âãï„ÅßÁõ¥Ââç„ÅÆ„É°„Ç§„É≥„Çø„Çπ„ÇØ„ÇíË¶™„Å´Ë®≠ÂÆö
                    isSkip: false, // „Çπ„Ç≠„ÉÉ„Éó„Åô„Çã„Åã„Å©„ÅÜ„Åã
                    autoDetected: !isMainTask && hasIndent // „Ç§„É≥„Éá„É≥„Éà„ÅßËá™ÂãïÂà§ÂÆö„Åï„Çå„Åü„Ç≥„É°„É≥„Éà„Åã„Å©„ÅÜ„Åã
                };
                
                // „É°„Ç§„É≥„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÄÅ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíË®òÈå≤
                if (isMainTask) {
                    lastMainTaskIndex = previewTasks.length; // ËøΩÂä†Âæå„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
                }
                
                previewTasks.push(task);
            }
        });
            
            // Êñ∞„Åó„ÅÑ„Éó„É¨„Éì„É•„ÉºË°®Á§∫
            displayLineByLinePreview();
        }
        
        function displayLineByLinePreview() {
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            
            if (previewTasks.length === 0) {
                alert('ÊúâÂäπ„Å™„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const activeTaskCount = previewTasks.filter(t => !t.isSkip).length;
            const mainTaskCount = previewTasks.filter(t => !t.isSkip && t.isMainTask).length;
            const commentCount = previewTasks.filter(t => !t.isSkip && !t.isMainTask).length;
            
            const modeInfo = `<div style="font-size: 0.9rem; margin-top: 0.5rem;">‚ú® „Ç§„É≥„Éá„É≥„ÉàË°å„ÅØËá™Âãï„Åß„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆöÊ∏à„ÅøÔºàÂçäËßí„Çπ„Éö„Éº„Çπ2ÂÄã‰ª•‰∏ä„ÉªÂÖ®Ëßí„Çπ„Éö„Éº„Çπ„Éª„Çø„ÉñÔºâ„ÄÇ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßË¶™Â≠êÈñ¢‰øÇ„ÇíÂ§âÊõ¥ÂèØËÉΩ</div>`;
            
            // „Éó„É¨„Éì„É•„ÉºË°®Á§∫ÊñπÂºè„ÅÆÂà§ÂÆö
            const isScreenshotMode = originalImageDataUrl ? true : false;
            
            let content = `
                        
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f5e8; border-radius: 4px; color: #2f7d2f;">
                            <strong>üìù ${activeTaskCount}ÂÄã„ÅÆ„Ç¢„Ç§„ÉÜ„É† (üìã „É°„Ç§„É≥: ${mainTaskCount}, üí¨ „Ç≥„É°„É≥„Éà: ${commentCount})</strong>
                            ${modeInfo}
                        </div>
                        
                        ${isScreenshotMode ? `
                        <!-- „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàË°®Á§∫Ôºã„Çø„Çπ„ÇØ„Ç´„Éº„ÉâÊ®™‰∏¶„Å≥„É¨„Ç§„Ç¢„Ç¶„Éà -->
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; height: 600px;">
                            <!-- Â∑¶ÂÅ¥Ôºö„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà -->
                            <div style="flex: 1; padding: 0.75rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <h6 style="margin: 0; color: #495057;">üñºÔ∏è „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÂèÇËÄÉ</h6>
                                    <button onclick="toggleScreenshot()" id="screenshot-toggle" style="padding: 0.25rem 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                        ÈùûË°®Á§∫
                                    </button>
                                </div>
                                <div id="screenshot-preview" style="height: calc(100% - 40px); overflow: auto; text-align: center;">
                                    <img src="${originalImageDataUrl}" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                            </div>
                            
                            <!-- Âè≥ÂÅ¥Ôºö„Çø„Çπ„ÇØ„Ç´„Éº„ÉâÁ∏¶ÂàóË°®Á§∫ -->
                            <div style="flex: 1; padding: 0.75rem; background: #f0f2f5; border: 1px solid #ddd; border-radius: 4px; overflow-y: auto;">
                                <h6 style="margin: 0 0 1rem 0; color: #495057;">üìù Ë™çË≠ò„Åï„Çå„Åü„Çø„Çπ„ÇØ‰∏ÄË¶ß</h6>
                                <div id="preview-container" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ` : `
                        <!-- „ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÊôÇÔºö3ÂàóÂõ∫ÂÆöË°®Á§∫ -->
                        <div style="padding: 1rem; background: #f0f2f5; border-radius: 12px; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;" id="preview-container">
                        `}
            `;
            
            previewTasks.forEach((task, index) => {
                // „Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åü„Çø„Çπ„ÇØ„ÅØË°®Á§∫„Åó„Å™„ÅÑ
                if (task.isSkip) return;
                const mainTaskOptions = previewTasks.map((t, i) => 
                    i < index ? `<option value="${i}" ${task.parentIndex === i ? 'selected' : ''}>üìã ${t.title.substring(0, 30)}${t.title.length > 30 ? '...' : ''}</option>` : ''
                ).join('');
                
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                const isAutoDetected = task.autoDetected === true; // Ëá™ÂãïÂà§ÂÆö„Åï„Çå„Åü„Ç≥„É°„É≥„Éà„Åã„Å©„ÅÜ„ÅãÔºàÊòéÁ§∫ÁöÑ„Å´true„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
                const isGoogleTodo = task.hasAutoDeadline === true; // GoogleTODO„ÅßÊúüÈôê„ÅåËá™ÂãïÊäΩÂá∫„Åï„Çå„Åü„Çø„Çπ„ÇØ
                
                let borderColor = '#ddd';
                let bgColor = 'white';
                let headerText = '„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ';
                
                if (isGoogleTodo) {
                    borderColor = '#007bff';
                    bgColor = '#f8f9ff';
                    headerText = 'üìÖ ÊúüÈôêËá™ÂãïÊäΩÂá∫';
                } else if (isAutoComment) {
                    borderColor = '#28a745';
                    bgColor = '#f8fff9';
                    headerText = isAutoDetected ? '‚ú® Ëá™Âãï„Ç≥„É°„É≥„Éà' : '„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ';
                }
                
                // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàË°®Á§∫ÊôÇ„ÅØÁ∏¶Âàó„É¨„Ç§„Ç¢„Ç¶„ÉàÁî®„Å´„Çπ„Çø„Ç§„É´Ë™øÊï¥
                const cardStyle = originalImageDataUrl ? 
                    `border: 2px solid ${borderColor}; border-radius: 8px; background: ${bgColor}; transition: all 0.2s; cursor: move; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); width: 100%; margin-bottom: 0;` :
                    `border: 2px solid ${borderColor}; border-radius: 8px; background: ${bgColor}; transition: all 0.2s; cursor: move; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); height: fit-content; width: 100%; min-width: 320px;`;
                
                content += `
                    <div style="${cardStyle}" 
                         draggable="true" 
                         ondragstart="handlePreviewDragStart(event, ${index})" 
                         ondragend="handleDragEnd(event)"
                         ondragover="handleDragOver(event)" 
                         ondrop="handlePreviewDrop(event, ${index})"
                         ondragenter="handleDragEnter(event)"
                         ondragleave="handleDragLeave(event)"
                         id="preview-item-${index}">
                        
                        <!-- „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´ -->
                        <div style="background: ${borderColor}; padding: 0.2rem 0.4rem; text-align: center; color: white; font-weight: bold; cursor: grab; user-select: none; font-size: 0.7rem;">
                            ‚ãÆ‚ãÆ „Éâ„É©„ÉÉ„Ç∞ ‚ãÆ‚ãÆ
                        </div>
                        
                        <!-- „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫„Ç®„É™„Ç¢ -->
                        <div style="padding: 0.4rem; background: white;">
                            <div style="display: flex; gap: 0.3rem; align-items: flex-start;">
                                <textarea 
                                       onchange="updateTaskTitle(${index}, this.value)" 
                                       style="flex: 1; font-family: inherit; background: #f8f9fa; padding: 0.4rem; border-radius: 3px; font-size: 0.75rem; border: 1px solid ${borderColor}; min-width: 0; resize: vertical; min-height: 40px; overflow-wrap: break-word; word-break: break-all; width: 100%; max-width: 100%;"
                                       id="title-input-${index}"
                                       rows="2">${task.title}</textarea>
                                <button onclick="deletePreviewTask(${index})" 
                                        style="background: #e53e3e; color: white; border: none; padding: 0.3rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; flex-shrink: 0;"
                                        title="ÂâäÈô§">
                                    üóëÔ∏è
                                </button>
                            </div>
                            <div style="font-size: 0.65rem; color: #888; margin-top: 0.2rem; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ÂÖÉ: "${task.originalLine}"
                            </div>
                        </div>
                        
                        <!-- Á∏¶ÈÖçÂàó„Ç≥„É≥„Éë„ÇØ„ÉàË®≠ÂÆö„Ç®„É™„Ç¢ -->
                        <div style="padding: 0.4rem; background: #fafafa; border-top: 1px solid #eee; font-size: 0.75rem;">
                            <div style="display: flex; flex-direction: column; gap: 0.3rem;">
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <label style="font-weight: 600; font-size: 0.75rem; color: #555; width: 35px; flex-shrink: 0;">Á®ÆÈ°û</label>
                                    <select onchange="updateTaskType(${index}, this.value)" style="flex: 1; padding: 0.3rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.75rem; background: white;">
                                        <option value="main" ${task.isMainTask ? 'selected' : ''}>üìã„É°„Ç§„É≥</option>
                                        <option value="comment" ${!task.isMainTask ? 'selected' : ''}>üí¨„Ç≥„É°„É≥„Éà</option>
                                        <option value="skip">‚è≠Ô∏è„Çπ„Ç≠„ÉÉ„Éó</option>
                                    </select>
                                </div>
                                
                                ${!task.isMainTask ? `
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <label style="font-weight: 600; font-size: 0.75rem; color: #555; width: 35px; flex-shrink: 0;">Ë¶™</label>
                                    <select onchange="updateTaskParent(${index}, this.value)" style="flex: 1; padding: 0.3rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.75rem; background: white;" id="parent-select-${index}">
                                        <option value="">Ôºç</option>
                                        ${mainTaskOptions}
                                    </select>
                                </div>
                                ` : `
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <label style="font-weight: 600; font-size: 0.75rem; color: #555; width: 35px; flex-shrink: 0;">Âàó</label>
                                    <select onchange="updateTaskColumn(${index}, this.value)" style="flex: 1; padding: 0.3rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.75rem; background: white;" id="column-select-${index}">
                                        ${columns.map(c => `<option value="${c.id}" ${task.columnId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                                    </select>
                                </div>
                                `}
                                
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <label style="font-weight: 600; font-size: 0.75rem; color: #555; width: 35px; flex-shrink: 0;">ÊãÖÂΩì</label>
                                    <input type="text" onchange="updateTaskAssignee(${index}, this.value)" value="${task.assignee}" style="flex: 1; padding: 0.3rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.75rem; background: white;" placeholder="ÊãÖÂΩìËÄÖ" id="assignee-input-${index}">
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <label style="font-weight: 600; font-size: 0.75rem; color: #555; width: 35px; flex-shrink: 0;">Êó•‰ªò</label>
                                    <input type="date" onchange="updateTaskDeadline(${index}, this.value)" value="${task.deadline}" style="flex: 1; padding: 0.3rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.75rem; background: white;" id="deadline-input-${index}">
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <label style="font-weight: 600; font-size: 0.75rem; color: #555; width: 35px; flex-shrink: 0;">ÊôÇÂàª</label>
                                    <input type="time" onchange="updateTaskTime(${index}, this.value)" value="${task.time}" style="flex: 1; padding: 0.3rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.75rem; background: white;" id="time-input-${index}">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += `
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 0.9rem;">
                    <strong>üí° ‰Ωø„ÅÑÊñπÔºö</strong><br>
                    ‚Ä¢ <strong>‚ú® Ëá™ÂãïÂà§ÂÆö</strong>ÔºöÁ©∫ÁôΩ„Åå„ÅÇ„ÇãË°å„ÅØËá™Âãï„Åß„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆö„Åï„Çå„ÄÅÁõ¥Ââç„ÅÆ„É°„Ç§„É≥„Çø„Çπ„ÇØ„ÅåË¶™„Å´Ë®≠ÂÆö„Åï„Çå„Åæ„Åô<br>
                    ‚Ä¢ <strong>üñ±Ô∏è „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</strong>Ôºö‰ªªÊÑè„ÅÆË°å„Çí„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Ç≥„É°„É≥„Éà„Å´Â§âÊõ¥<br>
                    ‚Ä¢ <strong>üìã „É°„Ç§„É≥„Çø„Çπ„ÇØ</strong>ÔºöÁã¨Á´ã„Åó„Åü„Çø„Çπ„ÇØ„Ç´„Éº„Éâ„Å®„Åó„Å¶‰ΩúÊàê<br>
                    ‚Ä¢ <strong>üí¨ „Ç≥„É°„É≥„Éà</strong>ÔºöÊåáÂÆö„Åó„Åü„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ËøΩÂä†<br>
                    ‚Ä¢ <strong>‚è≠Ô∏è „Çπ„Ç≠„ÉÉ„Éó</strong>Ôºö„Ç§„É≥„Éù„Éº„ÉàÊôÇ„Å´ÁÑ°Ë¶ñ
                </div>
            `;
            
            contentDiv.innerHTML = content;
            previewDiv.style.display = 'block';
        }
        
        function updateTaskTitle(index, title) {
            if (previewTasks[index]) {
                previewTasks[index].title = title.trim();
            }
        }
        
        function deletePreviewTask(index) {
            const task = previewTasks[index];
            
            // „Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíË¶™„Å´„Åó„Å¶„ÅÑ„Çã„Ç≥„É°„É≥„Éà„ÇíÁ¢∫Ë™ç
            const childComments = previewTasks.filter((t, i) => 
                i !== index && !t.isMainTask && t.parentIndex === index
            );
            
            if (childComments.length > 0) {
                if (!confirm(`‚ö†Ô∏è „Åì„ÅÆ„Çø„Çπ„ÇØ„Å´„ÅØ${childComments.length}ÂÄã„ÅÆÂ≠ê„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÂ≠ê„Ç≥„É°„É≥„Éà„ÇÇ‰∏ÄÁ∑í„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }
                
                // Â≠ê„Ç≥„É°„É≥„Éà„ÇÇ„Çπ„Ç≠„ÉÉ„Éó„Å´Ë®≠ÂÆö
                childComments.forEach(child => {
                    child.isSkip = true;
                });
            }
            
            // „Çø„Çπ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó„Å´Ë®≠ÂÆöÔºàÂÆåÂÖ®ÂâäÈô§„Åß„ÅØ„Å™„Åè„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰øùÊåÅÔºâ
            previewTasks[index].isSkip = true;
            
            // ‰ªñ„ÅÆ„Çø„Çπ„ÇØ„ÅÆË¶™ÂèÇÁÖß„ÇíÊõ¥Êñ∞
            previewTasks.forEach((t, i) => {
                if (t.parentIndex > index) {
                    // ÂâäÈô§„Åï„Çå„Åü„Çø„Çπ„ÇØ„Çà„ÇäÂæå„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíË™øÊï¥
                    const skipCount = previewTasks.slice(0, t.parentIndex).filter(pt => pt.isSkip).length;
                    const targetSkipCount = previewTasks.slice(0, index).filter(pt => pt.isSkip).length;
                    t.parentIndex = t.parentIndex - (skipCount - targetSkipCount);
                }
            });
            
            // „Éó„É¨„Éì„É•„Éº„ÇíÂÜçË°®Á§∫
            displayLineByLinePreview();
        }
        
        function updateTaskAssignee(index, assignee) {
            if (previewTasks[index]) {
                previewTasks[index].assignee = assignee;
            }
        }
        
        function updateTaskDeadline(index, deadline) {
            if (previewTasks[index]) {
                previewTasks[index].deadline = deadline;
            }
        }
        
        function updateTaskTime(index, time) {
            if (previewTasks[index]) {
                previewTasks[index].time = time;
            }
        }
        
        function updateTaskType(index, type) {
            if (previewTasks[index]) {
                // „Ç≥„É°„É≥„ÉàÂåñ„Åó„Çà„ÅÜ„Å®„Åô„Çã„Çø„Çπ„ÇØ„Åå‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (type === 'comment' && previewTasks[index].isMainTask) {
                    const hasChildComments = previewTasks.some((task, i) => 
                        i !== index && !task.isMainTask && task.parentIndex === index
                    );
                    
                    if (hasChildComments) {
                        alert('‚ö†Ô∏è „Åì„ÅÆ„Çø„Çπ„ÇØ„ÅØ‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Ç≥„É°„É≥„ÉàÂåñ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nÂÖà„Å´Â≠ê„Ç≥„É°„É≥„Éà„Çí‰ªñ„ÅÆ„Çø„Çπ„ÇØ„Å´ÁßªÂãï„Åô„Çã„Åã„ÄÅ„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        // ÈÅ∏Êäû„ÇíÂÖÉ„Å´Êàª„Åô
                        document.querySelector(`#preview-item-${index} select`).value = 'main';
                        return;
                    }
                }
                
                previewTasks[index].isMainTask = (type === 'main');
                previewTasks[index].isSkip = (type === 'skip');
                
                // Ë¶™ÈÅ∏Êäû„Å®„Ç´„É©„É†ÈÅ∏Êäû„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂàá„ÇäÊõø„Åà
                const parentSelect = document.getElementById(`parent-select-${index}`);
                const columnSelect = document.getElementById(`column-select-${index}`);
                
                if (type === 'main') {
                    parentSelect.disabled = true;
                    parentSelect.value = '';
                    previewTasks[index].parentIndex = null;
                    previewTasks[index].autoDetected = false; // ÊâãÂãï„ÅßÂ§âÊõ¥„Åó„Åü„Åü„ÇÅËá™ÂãïÂà§ÂÆö„Åß„ÅØ„Å™„ÅÑ
                    columnSelect.disabled = false;
                } else if (type === 'comment') {
                    previewTasks[index].autoDetected = false; // ÊâãÂãï„ÅßÂ§âÊõ¥„Åó„Åü„Åü„ÇÅËá™ÂãïÂà§ÂÆö„Åß„ÅØ„Å™„ÅÑ
                    parentSelect.disabled = false;
                    columnSelect.disabled = true;
                } else { // skip
                    parentSelect.disabled = true;
                    columnSelect.disabled = true;
                }
            }
        }
        
        function updateTaskParent(index, parentIndex) {
            if (previewTasks[index]) {
                previewTasks[index].parentIndex = parentIndex ? parseInt(parentIndex) : null;
                previewTasks[index].autoDetected = false; // ÊâãÂãï„ÅßÂ§âÊõ¥„Åó„Åü„Åü„ÇÅËá™ÂãïÂà§ÂÆö„Åß„ÅØ„Å™„ÅÑ
            }
        }
        
        function updateTaskColumn(index, columnId) {
            if (previewTasks[index]) {
                previewTasks[index].columnId = columnId;
            }
        }
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ
        let draggedIndex = -1;
        
        function handlePreviewDragStart(event, index) {
            draggedIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.6';
        }
        
        function handleDragEnd(event) {
            event.target.style.opacity = '1';
            draggedIndex = -1;
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnter(event) {
            event.preventDefault();
            if (event.target.closest('[id^="preview-item-"]')) {
                event.target.closest('[id^="preview-item-"]').style.backgroundColor = '#e3f2fd';
            }
        }
        
        function handleDragLeave(event) {
            if (event.target.closest('[id^="preview-item-"]')) {
                const item = event.target.closest('[id^="preview-item-"]');
                const itemIndex = parseInt(item.id.split('-')[2]);
                const task = previewTasks[itemIndex];
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                item.style.backgroundColor = isAutoComment ? '#f8fff9' : 'white';
            }
        }
        
        function handlePreviewDrop(event, targetIndex) {
            event.preventDefault();
            
            if (draggedIndex === targetIndex || draggedIndex === -1) {
                // ÂÖÉ„Å´Êàª„Åô
                event.target.closest('[id^="preview-item-"]').style.opacity = '1';
                return;
            }
            
            const draggedTask = previewTasks[draggedIndex];
            const targetTask = previewTasks[targetIndex];
            
            // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Çø„Çπ„ÇØ„Çí„Ç≥„É°„É≥„Éà„Å´Â§âÊõ¥„Åó„ÄÅ„Çø„Éº„Ç≤„ÉÉ„Éà„Çø„Çπ„ÇØ„ÇíË¶™„Å´Ë®≠ÂÆö
            if (targetTask.isMainTask) {
                // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Çø„Çπ„ÇØ„Åå‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (draggedTask.isMainTask) {
                    const childComments = previewTasks.filter((task, i) => 
                        i !== draggedIndex && !task.isMainTask && task.parentIndex === draggedIndex
                    );
                    
                    if (childComments.length > 0) {
                        const childTitles = childComments.map(c => `"${c.title}"`).join('\n‚Ä¢ ');
                        const shouldMoveChildren = confirm(
                            `üìù „Åì„ÅÆ„Çø„Çπ„ÇØ„Å´„ÅØ${childComments.length}ÂÄã„ÅÆÂ≠ê„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„ÅôÔºö\n\n‚Ä¢ ${childTitles}\n\n` +
                            `„Åì„Çå„Çâ„ÅÆÂ≠ê„Ç≥„É°„É≥„Éà„ÇÇ"${targetTask.title}"„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                            `‚Ä¢ OK: Â≠ê„Ç≥„É°„É≥„Éà„ÇÇ‰∏ÄÁ∑í„Å´ÁßªÂãï\n‚Ä¢ „Ç≠„É£„É≥„Çª„É´: Êìç‰Ωú„Çí‰∏≠Ê≠¢`
                        );
                        
                        if (!shouldMoveChildren) {
                            return;
                        }
                        
                        // Â≠ê„Ç≥„É°„É≥„Éà„ÇÇÂêå„ÅòË¶™„Å´ÁßªÂãï
                        childComments.forEach(child => {
                            child.parentIndex = targetIndex;
                        });
                    }
                }
                
                draggedTask.isMainTask = false;
                draggedTask.parentIndex = targetIndex;
                draggedTask.autoDetected = false; // „Éâ„É©„ÉÉ„Ç∞„ÅßÂ§âÊõ¥„Åó„Åü„Åü„ÇÅËá™ÂãïÂà§ÂÆö„Åß„ÅØ„Å™„ÅÑ
                
                // UI„ÇíÊõ¥Êñ∞
                displayLineByLinePreview();
                
                const movedCount = draggedTask.isMainTask ? 0 : previewTasks.filter(t => !t.isMainTask && t.parentIndex === targetIndex).length;
                alert(`üí¨ "${draggedTask.title}"„Çí"${targetTask.title}"„ÅÆ„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü${movedCount > 1 ? `ÔºàÂ≠ê„Ç≥„É°„É≥„Éà${movedCount-1}ÂÄã„ÇÇÁßªÂãïÔºâ` : ''}`);
            } else {
                alert('‚ö†Ô∏è „Ç≥„É°„É≥„Éà„ÇíÂà•„ÅÆ„Ç≥„É°„É≥„Éà„Å´„Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            
            draggedIndex = -1;
        }
        
        function displayPreview() {
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            
            if (previewTasks.length === 0) {
                alert('ÊúâÂäπ„Å™„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const projectGroups = {};
            previewTasks.forEach(task => {
                const projectKey = task.project || 'Êú™ÂàÜÈ°û';
                if (!projectGroups[projectKey]) {
                    projectGroups[projectKey] = [];
                }
                projectGroups[projectKey].push(task);
            });
            
            let content = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f5e8; border-radius: 4px; color: #2f7d2f;">
                    <strong>‚úÖ ${previewTasks.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü</strong>
                    ${Object.keys(projectGroups).length > 1 ? `<span style="margin-left: 1rem; font-size: 0.9rem;">(${Object.keys(projectGroups).length}„Éó„É≠„Ç∏„Çß„ÇØ„Éà)</span>` : ''}
                </div>
            `;
            
            Object.entries(projectGroups).forEach(([project, tasks]) => {
                content += `
                    <div style="margin-bottom: 1.5rem;">
                        ${project !== 'Êú™ÂàÜÈ°û' ? `<div style="background: #0079bf; color: white; padding: 0.5rem 1rem; border-radius: 4px 4px 0 0; font-weight: bold;">üìÅ ${project} „Éó„É≠„Ç∏„Çß„ÇØ„Éà</div>` : ''}
                        ${tasks.map((task, index) => {
                            const taskIndex = previewTasks.indexOf(task);
                            const indentStyle = task.indentLevel > 0 ? `margin-left: ${task.indentLevel * 20}px; border-left: 2px solid #0079bf;` : '';
                            const parentInfo = task.parentId ? `<span style="font-size: 0.7rem; color: #6c757d;">‚Ü≥ Â≠ê„Çø„Çπ„ÇØ</span>` : '';
                            
                            return `
                                <div style="border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; overflow: hidden; ${indentStyle}">
                                    <div style="background: #f8f9fa; padding: 0.5rem; border-bottom: 1px solid #ddd; font-size: 0.8rem; color: #6c757d;">
                                        ÂÖÉ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà: "${task.originalLine}" ${parentInfo}
                                    </div>
                                    <div style="padding: 0.75rem;">
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem;">
                                            <div>
                                                <input type="text" value="${task.title}" onchange="updatePreviewTask(${taskIndex}, 'title', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-weight: bold;">
                                                ${task.tags.length > 0 ? `<div style="font-size: 0.8rem; color: #0079bf; margin-top: 0.25rem;">${task.tags.join(' ')}</div>` : ''}
                                            </div>
                                            <div>
                                                <select onchange="updatePreviewTask(${taskIndex}, 'assignee', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                                    <option value="Êú™Ë®≠ÂÆö" ${task.assignee === 'Êú™Ë®≠ÂÆö' ? 'selected' : ''}>Êú™Ë®≠ÂÆö</option>
                                                    ${assignees.map(a => `<option value="${a}" ${task.assignee === a ? 'selected' : ''}>${a}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div>
                                                <input type="date" value="${task.deadline}" onchange="updatePreviewTask(${taskIndex}, 'deadline', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                            <div>
                                                <select onchange="updatePreviewTask(${taskIndex}, 'priority', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                                    <option value="low" ${task.priority === 'low' ? 'selected' : ''}>üü¢ ÈÄöÂ∏∏</option>
                                                    <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>üü° ÈáçË¶Å</option>
                                                    <option value="high" ${task.priority === 'high' ? 'selected' : ''}>üî¥ ÊúÄÈáçË¶Å</option>
                                                </select>
                                            </div>
                                        </div>
                                        ${task.subTasks && task.subTasks.length > 0 ? `
                                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: #f0f8ff; border: 1px solid #bee5eb; border-radius: 4px;">
                                                <div style="font-size: 0.8rem; font-weight: bold; color: #0c5460; margin-bottom: 0.5rem;">üìù „Çµ„Éñ„Çø„Çπ„ÇØ/„Ç≥„É°„É≥„Éà (${task.subTasks.length}‰ª∂)</div>
                                                ${task.subTasks.map((subTask, subIndex) => `
                                                    <div style="font-size: 0.85rem; color: #495057; margin-bottom: 0.25rem; padding-left: 1rem; border-left: 2px solid #17a2b8;">
                                                        ‚Ä¢ ${subTask}
                                                    </div>
                                                `).join('')}
                                                <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.5rem;">
                                                    ‚Äª „Åì„Çå„Çâ„ÅØ„Çø„Çπ„ÇØ„ÅÆ„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶Ëá™ÂãïËøΩÂä†„Åï„Çå„Åæ„Åô
                                                </div>
                                            </div>
                                        ` : ''}
                                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.75rem;">
                                            <select onchange="updatePreviewTask(${taskIndex}, 'columnId', this.value)" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                                ${columns.map(c => `<option value="${c.id}" ${task.columnId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                                            </select>
                                            <button onclick="removePreviewTask(${taskIndex})" style="padding: 0.5rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è ÂâäÈô§</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });
            
            // „Éó„É¨„Éì„É•„Éº„ÅÆÁµÇ‰∫ÜÈÉ®ÂàÜ
            content += `
                        ${isScreenshotMode ? '</div></div>' : '</div></div>'}
            `;
            
            if (isScreenshotMode) {
                // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„É¢„Éº„ÉâÊôÇ„ÅØ„Éï„É´„Çπ„ÇØ„É™„Éº„É≥„Éó„É¨„Éì„É•„Éº
                const fullscreenPreview = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; overflow-y: auto; padding: 1rem;">
                        <div style="max-width: 1200px; margin: 0 auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #dee2e6;">
                                <h3 style="margin: 0; color: #172b4d;">üìù „Ç§„É≥„Éù„Éº„Éà„Éó„É¨„Éì„É•„Éº</h3>
                                <div>
                                    <button onclick="executeImport()" style="padding: 0.5rem 1rem; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem; font-weight: bold;">‚úÖ „Ç§„É≥„Éù„Éº„ÉàÂÆüË°å</button>
                                    <button onclick="hidePreview()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úï Èñâ„Åò„Çã</button>
                                </div>
                            </div>
                            ${content}
                        </div>
                    </div>
                `;
                contentDiv.innerHTML = fullscreenPreview;
            } else {
                // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„É¢„Éº„ÉâÊôÇ„ÅØÈÄöÂ∏∏„ÅÆ„Éó„É¨„Éì„É•„Éº
                contentDiv.innerHTML = content;
            }
            
            previewDiv.style.display = 'block';
        }
        
        function updatePreviewTask(index, field, value) {
            if (previewTasks[index]) {
                previewTasks[index][field] = value;
            }
        }
        
        function removePreviewTask(index) {
            if (confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                previewTasks.splice(index, 1);
                displayPreview();
            }
        }
        
        function executeImport() {
            console.log('üöÄ executeImportÈñãÂßã, previewTasks.length:', previewTasks.length);
            console.log('üì∏ originalImageDataUrlÂ≠òÂú®:', !!originalImageDataUrl);
            
            if (previewTasks.length === 0) {
                alert('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            let importedCount = 0;
            const taskIdMap = {}; // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å®ÂÆüÈöõ„ÅÆ„Çø„Çπ„ÇØID„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
            const currentUser = localStorage.getItem('currentUser') || '„É¶„Éº„Ç∂„Éº';
            
            // „Åæ„Åö„É°„Ç§„É≥„Çø„Çπ„ÇØ„Çí‰ΩúÊàê
            previewTasks.forEach((previewTask, index) => {
                if (previewTask.isSkip || !previewTask.isMainTask) return;
                
                // ÊãÖÂΩìËÄÖ„Çí„É™„Çπ„Éà„Å´ËøΩÂä†ÔºàÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥ÂêàÔºâ
                if (previewTask.assignee !== 'Êú™Ë®≠ÂÆö' && !assignees.includes(previewTask.assignee)) {
                    assignees.push(previewTask.assignee);
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                }
                
                const taskId = Date.now() + index;
                taskIdMap[index] = taskId;
                
                const newTask = {
                    id: taskId,
                    title: previewTask.title,
                    deadline: new Date(`${previewTask.deadline}T${previewTask.time || '17:00'}`).toISOString(),
                    priority: previewTask.priority,
                    assignees: [previewTask.assignee],
                    assignee: previewTask.assignee,
                    memo: `„Ç§„É≥„Éù„Éº„Éà: ${new Date().toLocaleDateString()}`,
                    columnId: previewTask.columnId,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    comments: [],
                    originalLine: previewTask.originalLine
                };
                
                tasks.push(newTask);
                importedCount++;
            });
            
            // Ê¨°„Å´„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†
            previewTasks.forEach((previewTask, index) => {
                if (previewTask.isSkip || previewTask.isMainTask) return;
                if (previewTask.parentIndex === null) return;
                
                const parentTaskId = taskIdMap[previewTask.parentIndex];
                if (!parentTaskId) return;
                
                const parentTask = tasks.find(t => t.id === parentTaskId);
                if (parentTask) {
                    parentTask.comments.push({
                        id: Date.now() + index,
                        author: previewTask.assignee,
                        text: `üìù ${previewTask.title}`,
                        timestamp: new Date().toISOString(),
                        isImportedComment: true
                    });
                }
            });
            
            if (importedCount > 0) {
                saveTasks();
                render();
                
                // „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„ÉàÂæå„Å´Âç≥Â∫ß„Å´ÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ
                setTimeout(() => checkDeadlines(), 100);
                
                // „Éó„É¨„Éì„É•„Éº„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„Çø„Çπ„ÇØÁîªÈù¢„Å´Âàá„ÇäÊõø„Åà
                document.getElementById('import-text').value = '';
                document.getElementById('ocr-file-input').value = ''; // OCR„Éï„Ç°„Ç§„É´ÂÖ•Âäõ„ÇÇ„É™„Çª„ÉÉ„Éà
                hidePreview();
                closeSettingsModal();
                
                const commentCount = previewTasks.filter(t => !t.isMainTask && !t.isSkip).length;
                let message = `üéâ „Çø„Çπ„ÇØËøΩÂä†„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\n`;
                message += `üìã ${importedCount}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„ÇíËøΩÂä†\n`;
                if (commentCount > 0) {
                    message += `üí¨ ${commentCount}ÂÄã„ÅÆ„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†\n`;
                }
                message += `\nüéØ „Çø„Çπ„ÇØÁÆ°ÁêÜÁîªÈù¢„Å´ÁßªË°å„Åó„Åæ„Åô...`;
                
                console.log('üí¨ „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫:', message);
                alert(message);
                console.log('üí¨ alertÂÆå‰∫Ü');
                
                // ÁîªÂÉè„Éá„Éº„Çø„ÇÇ„ÇØ„É™„Ç¢
                originalImageDataUrl = null;
                
                // „Çø„Çπ„ÇØÁÆ°ÁêÜÁîªÈù¢„ÅÆÊúÄ‰∏äÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
                setTimeout(() => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }
        
        function hidePreview() {
            document.getElementById('import-preview').style.display = 'none';
            document.getElementById('preview-content').innerHTML = '';
            previewTasks = [];
        }
        
        function clearImportText() {
            document.getElementById('import-text').value = '';
            document.getElementById('ocr-file-input').value = ''; // OCR„Éï„Ç°„Ç§„É´„ÇÇ„ÇØ„É™„Ç¢
            hidePreview(); // „Éó„É¨„Éì„É•„Éº„ÇÇÂêåÊôÇ„Å´„ÇØ„É™„Ç¢
            hideImagePreview(); // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„ÇÇ„ÇØ„É™„Ç¢
            originalImageDataUrl = null; // ÁîªÂÉè„Éá„Éº„Çø„ÇÇ„ÇØ„É™„Ç¢
        }
        
        // ÁîªÂÉèÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜÔºàÈ†òÂüüÈÅ∏Êäû„É¢„Éº„ÉâÔºâ
        async function handleOCRFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ (10MBÂà∂Èôê)
            if (file.size > 10 * 1024 * 1024) {
                alert('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô (ÊúÄÂ§ß10MB)');
                return;
            }
            
            try {
                // ÁîªÂÉè„Çí„Éó„É¨„Éì„É•„ÉºË°®Á§∫
                await displayImagePreview(file);
            } catch (error) {
                console.error('Image Preview Error:', error);
                alert('ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            }
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            input.value = '';
        }
        
        async function performOCR(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        updateOCRProgress(10, 'üì∏ ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                        
                        const { data: { text } } = await Tesseract.recognize(
                            e.target.result,
                            'jpn+eng', // Êó•Êú¨Ë™û„Å®Ëã±Ë™û„ÇíË™çË≠ò
                            {
                                logger: m => {
                                    if (m.status === 'recognizing text') {
                                        const progress = Math.round(m.progress * 90) + 10; // 10-100%„ÅÆÁØÑÂõ≤
                                        updateOCRProgress(progress, `üîç „ÉÜ„Ç≠„Çπ„ÉàË™çË≠ò‰∏≠... ${Math.round(m.progress * 100)}%`);
                                    }
                                },
                                // Á≤æÂ∫¶ÊîπÂñÑ„ÅÆ„Åü„ÇÅ„ÅÆË®≠ÂÆö
                                tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                                tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ„ÅÇ-„Çñ„Ç¢-„É∂‰∏Ä-ÈæØ!@#$%^&*()_+-=[]{}|;:,.<>?/~ „ÄÄ„Äå„Äç„ÄÅ„ÄÇ',
                                preserve_interword_spaces: '1'
                            }
                        );
                        
                        updateOCRProgress(100, '‚úÖ Ë™çË≠òÂÆå‰∫ÜÔºÅ');
                        resolve(text);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº'));
                reader.readAsDataURL(file);
            });
        }
        
        function showOCRProgress() {
            document.getElementById('ocr-status').style.display = 'block';
            updateOCRProgress(0, 'üì∏ OCRÂá¶ÁêÜ„ÇíÈñãÂßã‰∏≠...');
        }
        
        function updateOCRProgress(percentage, message) {
            document.getElementById('ocr-progress-bar').style.width = percentage + '%';
            document.getElementById('ocr-progress-text').textContent = message;
        }
        
        function hideOCRProgress() {
            setTimeout(() => {
                document.getElementById('ocr-status').style.display = 'none';
                document.getElementById('confidence-scores').style.display = 'none';
            }, 2000);
        }
        
        // ‰ø°È†ºÂ∫¶„Çπ„Ç≥„Ç¢Ë°®Á§∫Ê©üËÉΩ
        function showConfidenceScores(scores) {
            const confidenceDiv = document.getElementById('confidence-scores');
            const listDiv = document.getElementById('confidence-list');
            
            if (scores && scores.length > 0) {
                let html = '';
                scores.forEach((score, index) => {
                    const confidenceColor = getConfidenceColor(score.confidence);
                    const confidenceIcon = getConfidenceIcon(score.confidence);
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; padding: 0.25rem; background: white; border-radius: 3px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: bold; color: #495057;">È†òÂüü ${index + 1}:</span>
                                <span style="color: #6c757d; font-family: monospace;">${score.text.substring(0, 20)}${score.text.length > 20 ? '...' : ''}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <span style="color: ${confidenceColor};">${confidenceIcon}</span>
                                <span style="font-weight: bold; color: ${confidenceColor};">${score.confidence.toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                });
                
                // Âπ≥Âùá‰ø°È†ºÂ∫¶Ë®àÁÆó
                const avgConfidence = scores.reduce((sum, s) => sum + s.confidence, 0) / scores.length;
                const avgColor = getConfidenceColor(avgConfidence);
                const avgIcon = getConfidenceIcon(avgConfidence);
                
                html += `
                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: #e9ecef; border-radius: 3px; border-left: 4px solid ${avgColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold; color: #495057;">Âπ≥Âùá‰ø°È†ºÂ∫¶:</span>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <span style="color: ${avgColor};">${avgIcon}</span>
                                <span style="font-weight: bold; color: ${avgColor}; font-size: 1.1em;">${avgConfidence.toFixed(1)}%</span>
                            </div>
                        </div>
                        <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                            ${getConfidenceRecommendation(avgConfidence)}
                        </div>
                    </div>
                `;
                
                listDiv.innerHTML = html;
                confidenceDiv.style.display = 'block';
            }
        }
        
        // ‰ø°È†ºÂ∫¶„Å´Âøú„Åò„ÅüËâ≤„ÇíËøî„Åô
        function getConfidenceColor(confidence) {
            if (confidence >= 85) return '#28a745'; // Á∑ëÔºàÈ´ò‰ø°È†ºÂ∫¶Ôºâ
            if (confidence >= 70) return '#ffc107'; // ÈªÑÔºà‰∏≠‰ø°È†ºÂ∫¶Ôºâ
            if (confidence >= 50) return '#fd7e14'; // „Ç™„É¨„É≥„Ç∏Ôºà‰Ωé‰ø°È†ºÂ∫¶Ôºâ
            return '#dc3545'; // Ëµ§ÔºàÈùûÂ∏∏„Å´‰Ωé„ÅÑ‰ø°È†ºÂ∫¶Ôºâ
        }
        
        // ‰ø°È†ºÂ∫¶„Å´Âøú„Åò„Åü„Ç¢„Ç§„Ç≥„É≥„ÇíËøî„Åô
        function getConfidenceIcon(confidence) {
            if (confidence >= 85) return 'üü¢'; // È´ò‰ø°È†ºÂ∫¶
            if (confidence >= 70) return 'üü°'; // ‰∏≠‰ø°È†ºÂ∫¶
            if (confidence >= 50) return 'üü†'; // ‰Ωé‰ø°È†ºÂ∫¶
            return 'üî¥'; // ÈùûÂ∏∏„Å´‰Ωé„ÅÑ‰ø°È†ºÂ∫¶
        }
        
        // ‰ø°È†ºÂ∫¶„Å´Âøú„Åò„ÅüÊé®Â•®‰∫ãÈ†Ö„ÇíËøî„Åô
        function getConfidenceRecommendation(confidence) {
            if (confidence >= 85) {
                return '‚úÖ È´òÁ≤æÂ∫¶Ôºö„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®„Åß„Åç„Åæ„Åô';
            } else if (confidence >= 70) {
                return '‚ö†Ô∏è ‰∏≠Á≤æÂ∫¶ÔºöÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            } else if (confidence >= 50) {
                return 'üîç ‰ΩéÁ≤æÂ∫¶ÔºöÊâãÂãï„Åß‰øÆÊ≠£„ÅåÂøÖË¶Å„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì';
            } else {
                return '‚ùå ÈùûÂ∏∏„Å´‰Ωé„ÅÑÁ≤æÂ∫¶ÔºöÊâãÊõ∏„Åç„É¢„Éº„Éâ„ÇÑÂâçÂá¶ÁêÜË®≠ÂÆö„ÅÆË™øÊï¥„ÇíË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            }
        }
        
        // ‰ø°È†ºÂ∫¶„Çπ„Ç≥„Ç¢ËøΩÂä†
        function addConfidenceScore(regionIndex, text, confidence, ocrType = 'standard') {
            if (!window.confidenceScores) {
                window.confidenceScores = [];
            }
            
            window.confidenceScores.push({
                region: regionIndex,
                text: text,
                confidence: confidence,
                type: ocrType,
                timestamp: new Date()
            });
            
            // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
            showConfidenceScores(window.confidenceScores);
        }
        
        // ‰ø°È†ºÂ∫¶„Çπ„Ç≥„Ç¢„ÇØ„É™„Ç¢
        function clearConfidenceScores() {
            window.confidenceScores = [];
            document.getElementById('confidence-scores').style.display = 'none';
        }
        
        // OCR‰ø°È†ºÂ∫¶Êé®ÂÆöÔºàÂÆüÈöõ„ÅÆconfidence„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅÆÊé®ÂÆöÂÄ§Ôºâ
        function estimateOCRConfidence(text, tag) {
            if (!text || text.trim().length === 0) {
                return 0; // Á©∫ÊñáÂ≠ó„ÅØ‰ø°È†ºÂ∫¶0
            }
            
            let confidence = 50; // „Éô„Éº„Çπ‰ø°È†ºÂ∫¶
            
            // ÊúüÈôê„Çø„Ç∞„ÅÆÂ†¥Âêà„ÅÆÁâπÂà•Âà§ÂÆö
            if (tag === 'deadline') {
                if (parseDeadlineText(text)) {
                    confidence = 85; // ÊúüÈôê„Éë„Çø„Éº„É≥„Å´„Éû„ÉÉ„ÉÅ„Åô„ÇãÂ†¥Âêà„ÅØÈ´ò‰ø°È†ºÂ∫¶
                } else {
                    confidence = 30; // ÊúüÈôê„Éë„Çø„Éº„É≥„Å´„Éû„ÉÉ„ÉÅ„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωé‰ø°È†ºÂ∫¶
                }
            } else {
                // ‰∏ÄËà¨ÁöÑ„Å™„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂìÅË≥™Âà§ÂÆö
                // Êó•Êú¨Ë™ûÊñáÂ≠ó„ÅÆÂâ≤Âêà
                const japaneseChars = text.match(/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g);
                const japaneseRatio = japaneseChars ? japaneseChars.length / text.length : 0;
                
                // Êï∞Â≠ó„Éª„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„ÅÆÂâ≤Âêà
                const alphanumericChars = text.match(/[a-zA-Z0-9]/g);
                const alphanumericRatio = alphanumericChars ? alphanumericChars.length / text.length : 0;
                
                // Ë®òÂè∑„ÉªÁâπÊÆäÊñáÂ≠ó„ÅÆÂâ≤ÂêàÔºàÂ§ö„Åô„Åé„Çã„Å®Ë™çË≠ò„Ç®„É©„Éº„ÅÆÂèØËÉΩÊÄßÔºâ
                const symbolChars = text.match(/[^\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAFa-zA-Z0-9\s]/g);
                const symbolRatio = symbolChars ? symbolChars.length / text.length : 0;
                
                // ÊñáÂ≠óÊï∞„Å´„Çà„ÇãË™øÊï¥
                if (text.length >= 3 && text.length <= 50) {
                    confidence += 20; // ÈÅ©Âàá„Å™ÊñáÂ≠óÊï∞
                } else if (text.length > 50) {
                    confidence -= 10; // Èï∑„Åô„Åé„ÇãÂ†¥Âêà„ÅØ‰ø°È†ºÂ∫¶‰∏ã„Åí„Çã
                }
                
                // Êó•Êú¨Ë™û„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØ‰ø°È†ºÂ∫¶Âêë‰∏ä
                if (japaneseRatio > 0.7) {
                    confidence += 15;
                } else if (japaneseRatio > 0.3) {
                    confidence += 10;
                }
                
                // Ë®òÂè∑„ÅåÂ§ö„Åô„Åé„ÇãÂ†¥Âêà„ÅØ‰ø°È†ºÂ∫¶‰∏ã„Åí„Çã
                if (symbolRatio > 0.3) {
                    confidence -= 20;
                } else if (symbolRatio > 0.1) {
                    confidence -= 10;
                }
                
                // Êòé„Çâ„Åã„Å´ÊÑèÂë≥„ÅÆ„ÅÇ„ÇãÂçòË™û„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
                const meaningfulWords = ['„Çø„Çπ„ÇØ', '‰ΩúÊ•≠', 'Á¢∫Ë™ç', 'ÈÄ£Áµ°', '‰ºöË≠∞', 'Ë≥áÊñô', 'ÊèêÂá∫', 'ÂÆå‰∫Ü', 'ÈÄ≤Ë°å'];
                const hasMeaningfulWord = meaningfulWords.some(word => text.includes(word));
                if (hasMeaningfulWord) {
                    confidence += 15;
                }
            }
            
            // ‰ø°È†ºÂ∫¶„Çí0-100„ÅÆÁØÑÂõ≤„Å´Âà∂Èôê
            return Math.max(0, Math.min(100, confidence));
        }
        
        function clearAllData() {
            if (confirm('Êú¨ÂΩì„Å´ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                if (confirm('ÊúÄÁµÇÁ¢∫Ë™çÔºöÂÖ®„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÄÅ„Ç´„É©„É†Ë®≠ÂÆö„ÄÅÊãÖÂΩìËÄÖÊÉÖÂ†±„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                    localStorage.removeItem('salesTasksKanban');
                    localStorage.removeItem('kanbanColumns');
                    localStorage.removeItem('taskAssignees');
                    localStorage.removeItem('alertSettings');
                    localStorage.removeItem('selectedTheme');
                    localStorage.removeItem('themeColors');
                    
                    // „Éá„Éï„Ç©„É´„ÉàÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà
                    tasks = [];
                    columns = [
                        { id: 'todo', title: 'üìã TODO', color: '#667eea' },
                        { id: 'inprogress', title: '‚ö° ÈÄ≤Ë°å‰∏≠', color: '#f59e0b' },
                        { id: 'waiting', title: '‚è≥ ÈÄ£Áµ°ÂæÖ„Å°', color: '#8b5cf6' },
                        { id: 'done', title: '‚úÖ Done', color: '#10b981' }
                    ];
                    // ÂÆü„É¶„Éº„Ç∂„Éº„Åã„ÇâÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÇíÂÜçÊßãÁØâ
                    const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                    assignees = users.map(user => user.name);
                    
                    localStorage.setItem('kanbanColumns', JSON.stringify(columns));
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                    
                    console.log('üßπ „Ç∑„Çπ„ÉÜ„É†„É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü: ÂÆü„É¶„Éº„Ç∂„Éº„Éô„Éº„Çπ„ÅßÂÜçÊßãÁØâ', assignees);
                    
                    render();
                    closeSettingsModal();
                    alert('ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                }
            }
        }
        
        // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„Å®È†òÂüüÈÅ∏ÊäûÊ©üËÉΩ
        let currentImage = null;
        let selectedAreas = [];
        let isSelecting = false;
        let startX, startY, endX, endY;
        let imageScale = 1;
        let originalImageDataUrl = null; // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàË°®Á§∫Áî®
        
        async function displayImagePreview(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // ÂÖÉ„ÅÆÁîªÂÉè„Éá„Éº„Çø„Çí‰øùÂ≠òÔºà„Éó„É¨„Éì„É•„ÉºÁî®Ôºâ
                    originalImageDataUrl = e.target.result;
                    
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        
                        const canvas = document.getElementById('image-canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ÂÖÉÁîªÂÉè„ÅÆ„Éï„É´Ëß£ÂÉèÂ∫¶„Çí‰øùÊåÅ
                        let { width, height } = img;
                        imageScale = 1;
                        
                        // „Ç≠„É£„É≥„Éê„Çπ„ÇíÂÖÉÁîªÂÉè„Çµ„Ç§„Ç∫„Å´Ë®≠ÂÆö
                        canvas.width = width;
                        canvas.height = height;
                        
                        // È´òÁîªË≥™Ë®≠ÂÆö
                        ctx.imageSmoothingEnabled = false; // „Éî„ÇØ„Çª„É´„Éë„Éº„Éï„Çß„ÇØ„Éà
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // CSS„ÅßÊúÄÂ§ßË°®Á§∫„Çµ„Ç§„Ç∫„ÇíÂà∂ÈôêÔºàÁîªÂÉèËá™‰Ωì„ÅØ„Éï„É´„Çµ„Ç§„Ç∫Ôºâ
                        canvas.style.maxWidth = '100%';
                        canvas.style.height = 'auto';
                        
                        // ÈÅ∏ÊäûÈ†òÂüü„Çí„É™„Çª„ÉÉ„Éà
                        selectedAreas = [];
                        clearSelectionDisplay();
                        
                        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
                        setupCanvasEvents(canvas);
                        
                        // „Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫
                        document.getElementById('image-preview-container').style.display = 'block';
                        
                        // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢„Åæ„ÅßËá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                        setTimeout(() => {
                            document.getElementById('image-preview-container').scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }, 100); // 100msÈÅÖÂª∂„ÅßÁ¢∫ÂÆü„Å´DOM„ÅåÊõ¥Êñ∞„Åï„Çå„Å¶„Åã„Çâ„Çπ„ÇØ„É≠„Éº„É´
                        
                        resolve();
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function setupCanvasEvents(canvas) {
            // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà
            const newCanvas = canvas.cloneNode(true);
            canvas.parentNode.replaceChild(newCanvas, canvas);
            
            newCanvas.addEventListener('mousedown', function(e) {
                const rect = newCanvas.getBoundingClientRect();
                const scaleX = newCanvas.width / rect.width;
                const scaleY = newCanvas.height / rect.height;
                
                startX = (e.clientX - rect.left) * scaleX;
                startY = (e.clientY - rect.top) * scaleY;
                isSelecting = true;
            });
            
            newCanvas.addEventListener('mousemove', function(e) {
                if (!isSelecting) return;
                
                const rect = newCanvas.getBoundingClientRect();
                const scaleX = newCanvas.width / rect.width;
                const scaleY = newCanvas.height / rect.height;
                
                endX = (e.clientX - rect.left) * scaleX;
                endY = (e.clientY - rect.top) * scaleY;
                
                // ÈÅ∏ÊäûÁØÑÂõ≤„ÇíË°®Á§∫
                drawSelection(newCanvas, startX, startY, endX, endY);
                
                // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                const scrollContainer = document.getElementById('image-preview-scroll-container');
                const containerRect = scrollContainer.getBoundingClientRect();
                const scrollSpeed = 10;
                
                // ‰∏ãÊñπÂêë„Çπ„ÇØ„É≠„Éº„É´
                if (e.clientY > containerRect.bottom - 50) {
                    scrollContainer.scrollTop += scrollSpeed;
                }
                // ‰∏äÊñπÂêë„Çπ„ÇØ„É≠„Éº„É´
                else if (e.clientY < containerRect.top + 50) {
                    scrollContainer.scrollTop -= scrollSpeed;
                }
                // Âè≥ÊñπÂêë„Çπ„ÇØ„É≠„Éº„É´
                if (e.clientX > containerRect.right - 50) {
                    scrollContainer.scrollLeft += scrollSpeed;
                }
                // Â∑¶ÊñπÂêë„Çπ„ÇØ„É≠„Éº„É´
                else if (e.clientX < containerRect.left + 50) {
                    scrollContainer.scrollLeft -= scrollSpeed;
                }
            });
            
            newCanvas.addEventListener('mouseup', function(e) {
                if (!isSelecting) return;
                
                const rect = newCanvas.getBoundingClientRect();
                const scaleX = newCanvas.width / rect.width;
                const scaleY = newCanvas.height / rect.height;
                
                endX = (e.clientX - rect.left) * scaleX;
                endY = (e.clientY - rect.top) * scaleY;
                
                // ÈÅ∏ÊäûÈ†òÂüü„Çí‰øùÂ≠òÔºàÊúÄÂ∞è10x10„Éî„ÇØ„Çª„É´Ôºâ
                const width = Math.abs(endX - startX);
                const height = Math.abs(endY - startY);
                
                if (width > 10 && height > 10) {
                    const area = {
                        x: Math.min(startX, endX),
                        y: Math.min(startY, endY),
                        width: width,
                        height: height,
                        id: Date.now(),
                        tag: null, // 'task' „Åæ„Åü„ÅØ 'deadline'
                        text: null // OCRÁµêÊûú
                    };
                    selectedAreas.push(area);
                    updateSelectionDisplay();
                    
                    // „Çø„Ç∞ÈÅ∏ÊäûUI„ÇíË°®Á§∫
                    showAreaTagSelector(selectedAreas.length - 1);
                }
                
                isSelecting = false;
                redrawCanvas(newCanvas);
            });
        }
        
        function drawSelection(canvas, x1, y1, x2, y2) {
            const ctx = canvas.getContext('2d');
            
            // „Ç≠„É£„É≥„Éê„Çπ„ÇíÂÜçÊèèÁîª
            redrawCanvas(canvas);
            
            // ÁèæÂú®„ÅÆÈÅ∏ÊäûÁØÑÂõ≤„ÇíÊèèÁîª
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(Math.min(x1, x2), Math.min(y1, y2), Math.abs(x2 - x1), Math.abs(y2 - y1));
            
            // ÂçäÈÄèÊòé„ÅÆËÉåÊôØ
            ctx.fillStyle = 'rgba(0, 123, 255, 0.1)';
            ctx.fillRect(Math.min(x1, x2), Math.min(y1, y2), Math.abs(x2 - x1), Math.abs(y2 - y1));
        }
        
        function redrawCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ÂÖÉÁîªÂÉè„ÇíÂÜçÊèèÁîª
            if (currentImage) {
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            }
            
            // ‰øùÂ≠ò„Åï„Çå„ÅüÈÅ∏ÊäûÈ†òÂüü„ÇíÊèèÁîªÔºà„Çø„Ç∞„Å´Âøú„Åò„Å¶Ëâ≤ÂàÜ„ÅëÔºâ
            ctx.setLineDash([]);
            selectedAreas.forEach((area, index) => {
                let strokeColor = '#6c757d'; // Êú™ÂàÜÈ°ûÔºà„Ç∞„É¨„ÉºÔºâ
                let fillColor = 'rgba(108, 117, 125, 0.1)';
                let textIcon = '';
                
                if (area.tag === 'task') {
                    strokeColor = '#28a745'; // „Çø„Çπ„ÇØÔºàÁ∑ëÔºâ
                    fillColor = 'rgba(40, 167, 69, 0.1)';
                    textIcon = 'üìã';
                } else if (area.tag === 'deadline') {
                    strokeColor = '#dc3545'; // ÊúüÈôêÔºàËµ§Ôºâ
                    fillColor = 'rgba(220, 53, 69, 0.1)';
                    textIcon = 'üìÖ';
                }
                
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = 3;
                ctx.strokeRect(area.x, area.y, area.width, area.height);
                
                ctx.fillStyle = fillColor;
                ctx.fillRect(area.x, area.y, area.width, area.height);
                
                // Áï™Âè∑„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫
                ctx.fillStyle = strokeColor;
                ctx.font = 'bold 14px Arial';
                ctx.fillText(`${textIcon}${index + 1}`, area.x + 5, area.y + 18);
            });
        }
        
        function updateSelectionDisplay() {
            const taskCount = selectedAreas.filter(area => area.tag === 'task').length;
            const deadlineCount = selectedAreas.filter(area => area.tag === 'deadline').length;
            const untaggedCount = selectedAreas.filter(area => !area.tag).length;
            
            let displayText = `${selectedAreas.length}ÂÄã„ÅÆÈ†òÂüü„ÇíÈÅ∏Êäû‰∏≠`;
            if (taskCount > 0 || deadlineCount > 0) {
                displayText += ` (üìã„Çø„Çπ„ÇØ:${taskCount}, üìÖÊúüÈôê:${deadlineCount}`;
                if (untaggedCount > 0) {
                    displayText += `, Êú™ÂàÜÈ°û:${untaggedCount}`;
                }
                displayText += ')';
            }
            
            document.getElementById('selection-count').textContent = displayText;
        }
        
        // „Çø„Ç∞ÈÅ∏ÊäûUI„ÇíË°®Á§∫
        function showAreaTagSelector(areaIndex) {
            // Êó¢Â≠ò„ÅÆ„Çø„Ç∞ÈÅ∏ÊäûUI„ÇíÂâäÈô§
            const existingSelector = document.getElementById('area-tag-selector');
            if (existingSelector) {
                existingSelector.remove();
            }
            
            const area = selectedAreas[areaIndex];
            const container = document.getElementById('image-preview-scroll-container');
            
            // „Çø„Ç∞ÈÅ∏ÊäûUI„Çí‰ΩúÊàê
            const selectorDiv = document.createElement('div');
            selectorDiv.id = 'area-tag-selector';
            selectorDiv.style.cssText = `
                position: absolute;
                top: ${area.y + area.height + 10}px;
                left: ${area.x}px;
                background: white;
                border: 2px solid #007bff;
                border-radius: 8px;
                padding: 0.5rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                display: flex;
                gap: 0.5rem;
                align-items: center;
                font-size: 0.9rem;
            `;
            
            selectorDiv.innerHTML = `
                <span style="font-weight: bold; color: #495057;">„Çø„Çπ„ÇØÂêç„Å®„Åó„Å¶Ë™çË≠òÔºö</span>
                <button onclick="setAreaTag(${areaIndex}, 'task')" 
                        style="padding: 0.4rem 0.8rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                    üìã Á¢∫ÂÆö
                </button>
            `;
            
            container.appendChild(selectorDiv);
            
            // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÊ∂à„Åà„ÇãÔºà„É¶„Éº„Ç∂„Éº„ÅåÈÅ∏Êäû„Åó„Å™„Åã„Å£„ÅüÂ†¥ÂêàÔºâ
            setTimeout(() => {
                if (document.getElementById('area-tag-selector')) {
                    selectorDiv.remove();
                }
            }, 5000);
        }
        
        // È†òÂüü„Å´„Çø„Ç∞„ÇíË®≠ÂÆö
        function setAreaTag(areaIndex, tag) {
            if (selectedAreas[areaIndex]) {
                selectedAreas[areaIndex].tag = 'task'; // Â∏∏„Å´„Çø„Çπ„ÇØ„Å®„Åó„Å¶Ë®≠ÂÆö
                updateSelectionDisplay();
                redrawCanvas(document.getElementById('image-canvas'));
                
                // „Çø„Ç∞ÈÅ∏ÊäûUI„ÇíÂâäÈô§
                const selector = document.getElementById('area-tag-selector');
                if (selector) {
                    selector.remove();
                }
            }
        }
        
        function clearSelections() {
            selectedAreas = [];
            updateSelectionDisplay();
            const canvas = document.getElementById('image-canvas');
            redrawCanvas(canvas);
        }
        
        function clearSelectionDisplay() {
            document.getElementById('selection-overlay').innerHTML = '';
            updateSelectionDisplay();
        }
        
        function hideImagePreview() {
            document.getElementById('image-preview-container').style.display = 'none';
            selectedAreas = [];
            currentImage = null;
            // Ê≥®ÊÑèÔºöoriginalImageDataUrl„ÅØ„Éó„É¨„Éì„É•„ÉºÁî®„Å´‰øùÊåÅ
        }
        
        // „Çø„Çπ„ÇØÂÖ•Âäõ„Ç®„É™„Ç¢„Å´„Çπ„ÇØ„É≠„Éº„É´
        function scrollToTaskArea() {
            document.getElementById('import-text').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Çí„Éï„Ç©„Éº„Ç´„Çπ
            document.getElementById('import-text').focus();
        }
        
        // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleScreenshot() {
            const preview = document.getElementById('screenshot-preview');
            const button = document.getElementById('screenshot-toggle');
            
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                button.textContent = 'ÈùûË°®Á§∫';
            } else {
                preview.style.display = 'none';
                button.textContent = 'Ë°®Á§∫';
            }
        }
        
        async function processSelectedAreas() {
            if (selectedAreas.length === 0) {
                alert('ÈÅ∏ÊäûÈ†òÂüü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éû„Ç¶„Çπ„Åß„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶È†òÂüü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            showOCRProgress();
            clearConfidenceScores(); // Êñ∞„Åó„ÅÑOCRÂá¶ÁêÜÈñãÂßãÊôÇ„Å´„ÇØ„É™„Ç¢
            
            try {
                // ÂêÑÈ†òÂüü„ÅÆOCRÂá¶ÁêÜ
                for (let i = 0; i < selectedAreas.length; i++) {
                    const area = selectedAreas[i];
                    updateOCRProgress(10 + (i / selectedAreas.length) * 70, `üîç È†òÂüü ${i + 1}/${selectedAreas.length} „ÇíÂá¶ÁêÜ‰∏≠...`);
                    
                    // ÈÅ∏ÊäûÈ†òÂüü„ÇíÂàá„ÇäÊäú„Åç
                    const croppedCanvas = document.createElement('canvas');
                    const croppedCtx = croppedCanvas.getContext('2d');
                    
                    // ÂÆüÈöõ„ÅÆÁîªÂÉè„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶Â∫ßÊ®ô„ÇíË™øÊï¥
                    const realX = area.x / imageScale;
                    const realY = area.y / imageScale;
                    const realWidth = area.width / imageScale;
                    const realHeight = area.height / imageScale;
                    
                    croppedCanvas.width = realWidth;
                    croppedCanvas.height = realHeight;
                    
                    croppedCtx.drawImage(
                        currentImage,
                        realX, realY, realWidth, realHeight,
                        0, 0, realWidth, realHeight
                    );
                    
                    // OCRÂá¶ÁêÜÔºàÊúüÈôêÈ†òÂüü„ÅØÁâπÂà•Âá¶ÁêÜÔºâ
                    let text;
                    if (area.tag === 'deadline') {
                        console.log(`ÊúüÈôêÈ†òÂüü ${i + 1} „ÅÆÂá¶ÁêÜÈñãÂßã:`, area);
                        
                        // ÊâãÊõ∏„Åç„É¢„Éº„Éâ„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                        const isHandwritingMode = document.getElementById('ocr-handwriting-mode').checked;
                        
                        if (isHandwritingMode) {
                            console.log('ÊâãÊõ∏„Åç„É¢„Éº„Éâ„ÅßÊúüÈôêOCRÂÆüË°å');
                            try {
                                const handwritingResult = await performHandwritingOCR(croppedCanvas);
                                text = handwritingResult.text;
                                console.log(`ÊúüÈôêÈ†òÂüü ${i + 1} ÊâãÊõ∏„ÅçOCRÁµêÊûú:`, text, `(‰ø°È†ºÂ∫¶: ${handwritingResult.confidence}%)`);
                                
                                // ÊâãÊõ∏„Åç„ÅßÊúüÈôê„Éë„Çø„Éº„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅÊúüÈôêÁî®OCR„ÇÇË©¶Ë°å
                                if (!parseDeadlineText(text)) {
                                    console.log('ÊâãÊõ∏„ÅçOCR„ÅßÊúüÈôê„Éë„Çø„Éº„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÊúüÈôêÁî®OCR„ÇíË©¶Ë°å');
                                    const deadlineText = await performDeadlineOCR(croppedCanvas);
                                    console.log(`ÊúüÈôêÈ†òÂüü ${i + 1} ÊúüÈôêÁî®OCRÁµêÊûú:`, deadlineText);
                                    
                                    if (parseDeadlineText(deadlineText)) {
                                        text = deadlineText;
                                    }
                                }
                            } catch (error) {
                                console.error('ÊâãÊõ∏„ÅçOCR„Åß„Ç®„É©„Éº„ÄÅÊúüÈôêÁî®OCR„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ:', error);
                                text = await performDeadlineOCR(croppedCanvas);
                            }
                        } else {
                            // ÈÄöÂ∏∏„ÅÆÊúüÈôêÁî®OCR„ÇíË©¶Ë°å
                            text = await performDeadlineOCR(croppedCanvas);
                            console.log(`ÊúüÈôêÈ†òÂüü ${i + 1} ÊúüÈôêÁî®OCRÁµêÊûú:`, text);
                            
                            // ÊúüÈôê„Éë„Çø„Éº„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅÈÄöÂ∏∏OCR„ÇÇË©¶Ë°å
                            if (!parseDeadlineText(text)) {
                                console.log('ÊúüÈôê„Éë„Çø„Éº„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÈÄöÂ∏∏OCR„ÇíË©¶Ë°å');
                                const normalText = await performOCROnCanvas(croppedCanvas);
                                console.log(`ÊúüÈôêÈ†òÂüü ${i + 1} ÈÄöÂ∏∏OCRÁµêÊûú:`, normalText);
                                
                                // „Çà„ÇäËâØ„ÅÑÁµêÊûú„ÇíÊé°Áî®
                                if (parseDeadlineText(normalText)) {
                                    text = normalText;
                                }
                            }
                        }
                    } else {
                        text = await performOCROnCanvas(croppedCanvas);
                        console.log(`„Çø„Çπ„ÇØÈ†òÂüü ${i + 1} OCRÁµêÊûú:`, text);
                    }
                    area.text = text.trim(); // ÁµêÊûú„ÇíÈ†òÂüü„Å´‰øùÂ≠ò
                    
                    // ‰ø°È†ºÂ∫¶„Çπ„Ç≥„Ç¢„ÇíË®òÈå≤ÔºàÊâãÊõ∏„ÅçOCR„ÅÆÂ†¥Âêà„ÅØ‰ø°È†ºÂ∫¶„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÔºâ
                    if (area.tag === 'deadline' && isHandwritingMode && typeof handwritingResult !== 'undefined') {
                        addConfidenceScore(i + 1, text.trim(), handwritingResult.confidence || 0, 'handwriting');
                    } else {
                        // ÈÄöÂ∏∏OCR„ÅÆÂ†¥Âêà„ÄÅÊé®ÂÆö‰ø°È†ºÂ∫¶„ÇíË®àÁÆó
                        const estimatedConfidence = estimateOCRConfidence(text.trim(), area.tag);
                        addConfidenceScore(i + 1, text.trim(), estimatedConfidence, area.tag === 'deadline' ? 'deadline' : 'standard');
                    }
                }
                
                updateOCRProgress(85, 'üîó „Çø„Çπ„ÇØ„Å®ÊúüÈôê„Çí„Éö„Ç¢Âåñ‰∏≠...');
                
                // „Çø„Ç∞‰ªò„Åç„ÅÆÈ†òÂüü„ÇíËá™Âãï„Éö„Ç¢Âåñ
                const tasks = generateSimpleTaskList();
                
                updateOCRProgress(95, 'üìù ÁµêÊûú„ÇíÊï¥ÁêÜ‰∏≠...');
                
                if (tasks.length > 0) {
                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    alert(`‚úÖ OCRÂÆå‰∫ÜÔºÅ\nüìã ${tasks.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„ÇíË™çË≠ò„Åó„Åæ„Åó„Åü\n\nüìù „Ç§„É≥„Éù„Éº„Éà„Éó„É¨„Éì„É•„Éº„ÅßÊúüÈôê„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    
                    // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„ÇíÈñâ„Åò„Çã
                    hideImagePreview();
                    
                    // Ëá™Âãï„Åß„Ç§„É≥„Éù„Éº„Éà„Éó„É¨„Éì„É•„Éº„ÇíÂÆüË°å
                    setTimeout(() => {
                        previewImport();
                    }, 500);
                } else {
                    alert('ÊúâÂäπ„Å™„Çø„Çπ„ÇØ„ÇíË™çË≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÊñáÂ≠ó„Åå„ÅØ„Å£„Åç„ÇäË¶ã„Åà„ÇãÈ†òÂüü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
                
                hideOCRProgress();
            } catch (error) {
                hideOCRProgress();
                console.error('Area OCR Error:', error);
                
                // „Çà„ÇäË©≥Á¥∞„Å™„Ç®„É©„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
                let errorMessage = 'OCRÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n\n';
                errorMessage += `„Ç®„É©„ÉºË©≥Á¥∞: ${error.message || error}\n\n`;
                
                if (error.message && error.message.includes('network')) {
                    errorMessage += '„ÄêÂéüÂõ†„Äë„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÅÆÂïèÈ°å„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n';
                    errorMessage += '„ÄêÂØæÁ≠ñ„Äë„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                } else if (error.message && error.message.includes('memory')) {
                    errorMessage += '„ÄêÂéüÂõ†„Äë„É°„É¢„É™‰∏çË∂≥„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n';
                    errorMessage += '„ÄêÂØæÁ≠ñ„ÄëÁîªÂÉè„Çµ„Ç§„Ç∫„ÇíÂ∞è„Åï„Åè„Åó„Å¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                } else if (error.message && error.message.includes('cors')) {
                    errorMessage += '„ÄêÂéüÂõ†„Äë„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âà∂Èôê„ÅÆÂïèÈ°å„Åß„Åô„ÄÇ\n';
                    errorMessage += '„ÄêÂØæÁ≠ñ„ÄëÂà•„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                } else {
                    errorMessage += '„ÄêÂØæÁ≠ñ„Äë\n';
                    errorMessage += '1. „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n';
                    errorMessage += '2. Áï∞„Å™„ÇãÁîªÂÉè„Åß„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ\n';
                    errorMessage += '3. „Éñ„É©„Ç¶„Ç∂„ÇíÂ§âÊõ¥„Åó„Å¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                }
                
                alert(errorMessage);
            }
        }
        
        // „Ç∑„É≥„Éó„É´„Å™„Çø„Çπ„ÇØ„É™„Çπ„ÉàÁîüÊàê
        function generateSimpleTaskList() {
            const tasks = selectedAreas
                .filter(area => area.text && area.text.trim().length > 1)
                .map(area => area.text.trim());
            
            // „Ç§„É≥„Éù„Éº„ÉàÁî®„ÉÜ„Ç≠„Çπ„Éà„ÇíÁîüÊàê
            const importText = tasks.join('\n');
            document.getElementById('import-text').value = importText;
            
            console.log('Ë™çË≠ò„Åï„Çå„Åü„Çø„Çπ„ÇØ:', tasks);
            return tasks;
        }

        // „Çø„Çπ„ÇØ„Å®ÊúüÈôê„Çí„Éö„Ç¢ÂåñÔºàÂâäÈô§‰∫àÂÆöÔºâ
        function pairTasksAndDeadlines() {
            const taskAreas = selectedAreas.filter(area => area.tag === 'task' && area.text);
            const deadlineAreas = selectedAreas.filter(area => area.tag === 'deadline' && area.text);
            const untaggedAreas = selectedAreas.filter(area => !area.tag && area.text);
            
            console.log('=== „Éö„Ç¢ÂåñÂá¶ÁêÜÈñãÂßã ===');
            console.log('„Çø„Çπ„ÇØÈ†òÂüü:', taskAreas.map(a => ({ text: a.text, tag: a.tag })));
            console.log('ÊúüÈôêÈ†òÂüü:', deadlineAreas.map(a => ({ text: a.text, tag: a.tag })));
            console.log('Êú™ÂàÜÈ°ûÈ†òÂüü:', untaggedAreas.map(a => ({ text: a.text, tag: a.tag })));
            
            const pairedTasks = [];
            
            // „Çø„Çπ„ÇØÈ†òÂüü„ÇíÂü∫Ê∫ñ„Å´„Éö„Ç¢Âåñ
            taskAreas.forEach(taskArea => {
                const task = {
                    type: 'task',
                    title: taskArea.text,
                    deadline: null,
                    taskArea: taskArea
                };
                
                // ÊúÄ„ÇÇËøë„ÅÑÊúüÈôêÈ†òÂüü„ÇíÊé¢„Åô
                let closestDeadline = null;
                let minDistance = Infinity;
                
                deadlineAreas.forEach(deadlineArea => {
                    // Ë∑ùÈõ¢„ÇíË®àÁÆóÔºà‰∏≠ÂøÉÁÇπÈñì„ÅÆË∑ùÈõ¢Ôºâ
                    const taskCenterX = taskArea.x + taskArea.width / 2;
                    const taskCenterY = taskArea.y + taskArea.height / 2;
                    const deadlineCenterX = deadlineArea.x + deadlineArea.width / 2;
                    const deadlineCenterY = deadlineArea.y + deadlineArea.height / 2;
                    
                    const distance = Math.sqrt(
                        Math.pow(taskCenterX - deadlineCenterX, 2) + 
                        Math.pow(taskCenterY - deadlineCenterY, 2)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestDeadline = deadlineArea;
                    }
                });
                
                if (closestDeadline) {
                    console.log(`„Çø„Çπ„ÇØ "${taskArea.text}" „Å´ÊúÄ„ÇÇËøë„ÅÑÊúüÈôêÈ†òÂüü:`, closestDeadline.text);
                    task.deadline = parseDeadlineText(closestDeadline.text);
                    console.log(`Ëß£ÊûêÁµêÊûú:`, task.deadline);
                    // ‰ΩøÁî®Ê∏à„Åø„ÅÆÊúüÈôêÈ†òÂüü„ÇíÂâäÈô§
                    const index = deadlineAreas.indexOf(closestDeadline);
                    if (index > -1) {
                        deadlineAreas.splice(index, 1);
                    }
                } else {
                    console.log(`„Çø„Çπ„ÇØ "${taskArea.text}" „Å´ÂØæ„Åô„ÇãÊúüÈôêÈ†òÂüü„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ`);
                }
                
                pairedTasks.push(task);
            });
            
            // Êú™ÂàÜÈ°û„ÅÆÈ†òÂüü„ÇÇËøΩÂä†Ôºà„Çø„Çπ„ÇØ„Å®„Åó„Å¶Êâ±„ÅÜÔºâ
            untaggedAreas.forEach(area => {
                pairedTasks.push({
                    type: 'task',
                    title: area.text,
                    deadline: null
                });
            });
            
            return pairedTasks;
        }
        
        // GoogleTODOÂ∞ÇÁî®„ÅÆÁµ∂ÂØæÂèÇÁÖßÂ§âÊèõÈñ¢Êï∞
        function convertToAbsoluteReference(text) {
            console.log('Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõÈñãÂßã:', text);
            
            // Step 1: Âõ≤„ÅøÊï∞Â≠ó„ÅÆÁµ∂ÂØæÂ§âÊèõÔºàÊúÄÂÑ™ÂÖàÔºâ
            const circledNumbers = {
                '‚ë†': '1', '‚ë°': '2', '‚ë¢': '3', '‚ë£': '4', '‚ë§': '5', '‚ë•': '6', '‚ë¶': '7', '‚ëß': '8', '‚ë®': '9', '‚ë©': '10',
                '‚ë™': '11', '‚ë´': '12', '‚ë¨': '13', '‚ë≠': '14', '‚ëÆ': '15', '‚ëØ': '16', '‚ë∞': '17', '‚ë±': '18', '‚ë≤': '19', '‚ë≥': '20',
                '„âë': '21', '„âí': '22', '„âì': '23', '„âî': '24', '„âï': '25', '„âñ': '26', '„âó': '27', '„âò': '28', '„âô': '29', '„âö': '30', '„âõ': '31'
            };
            
            let converted = text;
            Object.keys(circledNumbers).forEach(circle => {
                converted = converted.replace(new RegExp(circle, 'g'), circledNumbers[circle]);
            });
            
            // Step 2: ÂÖ®ËßíÊï∞Â≠ó„ÅÆÁµ∂ÂØæÂ§âÊèõ
            const fullWidthNumbers = {
                'Ôºê': '0', 'Ôºë': '1', 'Ôºí': '2', 'Ôºì': '3', 'Ôºî': '4', 'Ôºï': '5', 'Ôºñ': '6', 'Ôºó': '7', 'Ôºò': '8', 'Ôºô': '9'
            };
            
            Object.keys(fullWidthNumbers).forEach(full => {
                converted = converted.replace(new RegExp(full, 'g'), fullWidthNumbers[full]);
            });
            
            // Step 3: ÊõúÊó•„ÅÆÁµ∂ÂØæÂèÇÁÖßÔºàÁ¢∫ÂÆü„Å™Â§âÊèõÔºâ
            const weekdays = {
                'ÊúàÊõú': 'Êúà', 'ÁÅ´Êõú': 'ÁÅ´', 'Ê∞¥Êõú': 'Ê∞¥', 'Êú®Êõú': 'Êú®', 'ÈáëÊõú': 'Èáë', 'ÂúüÊõú': 'Âúü', 'Êó•Êõú': 'Êó•',
                '„Åí„Å§': 'Êúà', '„Åã': 'ÁÅ´', '„Åô„ÅÑ': 'Ê∞¥', '„ÇÇ„Åè': 'Êú®', '„Åç„Çì': 'Èáë', '„Å©': 'Âúü', '„Å´„Å°': 'Êó•'
            };
            
            Object.keys(weekdays).forEach(day => {
                converted = converted.replace(new RegExp(day, 'g'), weekdays[day]);
            });
            
            // Step 4: GoogleTODOÁâπÊúâ„ÅÆ„Éé„Ç§„Ç∫Èô§Âéª
            converted = converted
                .replace(/[|ÔΩú]/g, '') // Á∏¶Á∑öÈô§Âéª
                .replace(/[‚ñ°‚ñ†]/g, '') // ÂõõËßíË®òÂè∑Èô§Âéª  
                .replace(/[ÔΩû„Äú]/g, '') // Ê≥¢Á∑öÈô§Âéª
                .replace(/\s+/g, ' ')  // ÈÄ£Á∂öÁ©∫ÁôΩ„Çí1„Å§„Å´
                .trim();
            
            // Step 5: ÊúüÈôê„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆÂº∑Âà∂Ê≠£Ë¶èÂåñ
            // mmÊúàddÊó•„Éë„Çø„Éº„É≥„ÇíÊé¢„Åó„Å¶Á¢∫ÂÆü„Å´ÊäΩÂá∫
            const datePattern = /(\d{1,2})\s*Êúà\s*(\d{1,2})\s*Êó•/;
            const timePattern = /(\d{1,2})\s*:\s*(\d{2})/;
            const dayPattern = /\(([ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•])\)/;
            
            const dateMatch = converted.match(datePattern);
            const timeMatch = converted.match(timePattern);
            const dayMatch = converted.match(dayPattern);
            
            if (dateMatch) {
                let result = `${dateMatch[1]}Êúà${dateMatch[2]}Êó•`;
                
                if (dayMatch) {
                    result += `(${dayMatch[1]})`;
                }
                
                if (timeMatch) {
                    result += `, ${timeMatch[1]}:${timeMatch[2]}`;
                }
                
                console.log('Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõÂÆå‰∫Ü:', result);
                return result;
            }
            
            console.log('Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ:', converted);
            return converted;
        }
        
        // GoogleTODOÊúüÈôê„ÉÜ„Ç≠„Çπ„Éà„ÇíÂé≥ÂØÜËß£ÊûêÔºàÁµ∂ÂØæÂèÇÁÖßÊñπÂºè„ÉªÂº∑ÂåñÁâàÔºâ
        function parseDeadlineText(text) {
            console.log('ÊúüÈôêËß£ÊûêÂØæË±°:', text);
            
            if (!text || text.trim().length === 0) {
                console.log('Á©∫ÊñáÂ≠ó„ÅÆ„Åü„ÇÅËß£ÊûêÂ§±Êïó');
                return null;
            }
            
            // Step 1: GoogleTODOÂ∞ÇÁî®„ÅÆÁµ∂ÂØæÂèÇÁÖßÂ§âÊèõ
            let absoluteText = convertToAbsoluteReference(text);
            console.log('Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõÂæå:', absoluteText);
            
            // Step 2: Ë§áÊï∞„ÅÆ„Éë„Çø„Éº„É≥„ÅßÊúüÈôêÊäΩÂá∫„ÇíË©¶Ë°å
            const patterns = [
                // Pattern 1: Âé≥ÂØÜGoogleTODO„Éë„Çø„Éº„É≥
                tryStrictGoogleTodoPattern,
                // Pattern 2: ÊüîËªü„Éë„Çø„Éº„É≥Ôºà„Éé„Ç§„Ç∫„ÅÇ„ÇäÔºâ
                tryFlexiblePattern,
                // Pattern 3: ÈÉ®ÂàÜ„Éû„ÉÉ„ÉÅ„Éë„Çø„Éº„É≥
                tryPartialMatchPattern,
                // Pattern 4: Êï∞Â≠óÊäΩÂá∫„Éë„Çø„Éº„É≥
                tryNumberExtractionPattern
            ];
            
            for (let i = 0; i < patterns.length; i++) {
                console.log(`„Éë„Çø„Éº„É≥ ${i + 1} Ë©¶Ë°å‰∏≠...`);
                const result = patterns[i](absoluteText);
                if (result) {
                    console.log(`„Éë„Çø„Éº„É≥ ${i + 1} „ÅßÊàêÂäü:`, result);
                    return result;
                }
            }
            
            console.log('ÂÖ®„Éë„Çø„Éº„É≥„ÅßËß£ÊûêÂ§±Êïó');
            return null;
        }
        
        // „Éë„Çø„Éº„É≥1: Âé≥ÂØÜGoogleTODO„Éë„Çø„Éº„É≥
        function tryStrictGoogleTodoPattern(text) {
            // GoogleTODO„ÅÆÂé≥ÂØÜ„Éë„Çø„Éº„É≥Ôºà„Éé„Ç§„Ç∫„ÇíÈô§ÂéªÔºâ
            const cleanText = text.replace(/[^\dÊúàÊó•\(\)ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•,:\s]/g, '');
            console.log('Âé≥ÂØÜ„Éë„Çø„Éº„É≥ - „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂæå:', cleanText);
            
            // „Éë„Çø„Éº„É≥1: mmÊúàddÊó•(ÊõúÊó•), hh:mm ÂΩ¢Âºè
            const pattern1 = /(\d{1,2})Êúà(\d{1,2})Êó•\s*\([ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•]\)\s*,?\s*(\d{1,2}):(\d{2})/;
            const match1 = cleanText.match(pattern1);
            if (match1) {
                const month = parseInt(match1[1]);
                const day = parseInt(match1[2]);
                const hour = parseInt(match1[3]);
                const minute = parseInt(match1[4]);
                
                // Êó•‰ªò„ÉªÊôÇÂàª„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                if (month >= 1 && month <= 12 && 
                    day >= 1 && day <= 31 && 
                    hour >= 0 && hour <= 23 && 
                    minute >= 0 && minute <= 59) {
                    
                    const monthStr = month.toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-${monthStr}-${dayStr}T${hourStr}:${minuteStr}`;
                    console.log('„Éë„Çø„Éº„É≥1„Éû„ÉÉ„ÉÅ:', result);
                    return result;
                }
            }
            
            // „Éë„Çø„Éº„É≥2: mmÊúàddÊó•(ÊõúÊó•) ÂΩ¢ÂºèÔºàÊôÇÂàª„Å™„ÅóÔºâ
            const pattern2 = /(\d{1,2})Êúà(\d{1,2})Êó•\s*\([ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•]\)/;
            const match2 = cleanText.match(pattern2);
            if (match2) {
                const month = parseInt(match2[1]);
                const day = parseInt(match2[2]);
                
                // Êó•‰ªò„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const monthStr = month.toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-${monthStr}-${dayStr}`;
                    console.log('„Éë„Çø„Éº„É≥2„Éû„ÉÉ„ÉÅ:', result);
                    return result;
                }
            }
            
            // „Éë„Çø„Éº„É≥3: mmÊúàddÊó•, hh:mm ÂΩ¢ÂºèÔºàÊõúÊó•„Å™„ÅóÔºâ
            const pattern3 = /(\d{1,2})Êúà(\d{1,2})Êó•\s*,?\s*(\d{1,2}):(\d{2})/;
            const match3 = cleanText.match(pattern3);
            if (match3) {
                const month = parseInt(match3[1]);
                const day = parseInt(match3[2]);
                const hour = parseInt(match3[3]);
                const minute = parseInt(match3[4]);
                
                // Êó•‰ªò„ÉªÊôÇÂàª„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                if (month >= 1 && month <= 12 && 
                    day >= 1 && day <= 31 && 
                    hour >= 0 && hour <= 23 && 
                    minute >= 0 && minute <= 59) {
                    
                    const monthStr = month.toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-${monthStr}-${dayStr}T${hourStr}:${minuteStr}`;
                    console.log('„Éë„Çø„Éº„É≥3„Éû„ÉÉ„ÉÅ:', result);
                    return result;
                }
            }
            
            // „Éë„Çø„Éº„É≥4: mmÊúàddÊó• ÂΩ¢ÂºèÔºàÊõúÊó•„ÉªÊôÇÂàª„Å™„ÅóÔºâ
            const pattern4 = /(\d{1,2})Êúà(\d{1,2})Êó•/;
            const match4 = cleanText.match(pattern4);
            if (match4) {
                const month = parseInt(match4[1]);
                const day = parseInt(match4[2]);
                
                // Êó•‰ªò„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const monthStr = month.toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-${monthStr}-${dayStr}`;
                    console.log('„Éë„Çø„Éº„É≥4„Éû„ÉÉ„ÉÅ:', result);
                    return result;
                }
            }
            
            // „Éë„Çø„Éº„É≥5: ÊôÇÂàª„ÅÆ„Åø hh:mmÔºà‰ªäÊó•„ÅÆÊúüÈôê„Å®„Åó„Å¶Âá¶ÁêÜÔºâ
            const pattern5 = /^(\d{1,2}):(\d{2})$/;
            const match5 = cleanText.trim().match(pattern5);
            if (match5) {
                const hour = parseInt(match5[1]);
                const minute = parseInt(match5[2]);
                
                // ÊôÇÈñì„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºàGoogleTODO„ÅÆÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºâ
                if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const today = new Date();
                    const result = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T${hourStr}:${minuteStr}`;
                    console.log('„Éë„Çø„Éº„É≥5„Éû„ÉÉ„ÉÅÔºàÊôÇÂàª„ÅÆ„ÅøÔºâ:', result);
                    return result;
                } else {
                    console.log('ÁÑ°Âäπ„Å™ÊôÇÂàª„Éï„Ç©„Éº„Éû„ÉÉ„Éà:', match5[0]);
                }
            }
            
            // „Éë„Çø„Éº„É≥6: Âé≥ÂØÜ„Å™ÊôÇÂàª„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„Åç„Éë„Çø„Éº„É≥ÂÜçÊ§úË®º
            const timeValidationPatterns = [
                // „Çà„ÇäÂé≥ÂØÜ„Å™ÊôÇÂàª„Éë„Çø„Éº„É≥Ôºà0-23ÊôÇ„ÄÅ0-59ÂàÜ„ÅÆ„ÅøË®±ÂèØÔºâ
                /(\d{1,2})Êúà(\d{1,2})Êó•\s*\([ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•]\)\s*,?\s*([0-2]?\d):([0-5]\d)/,
                /(\d{1,2})Êúà(\d{1,2})Êó•\s*,?\s*([0-2]?\d):([0-5]\d)/
            ];
            
            for (const pattern of timeValidationPatterns) {
                const match = cleanText.match(pattern);
                if (match) {
                    const month = parseInt(match[1]);
                    const day = parseInt(match[2]);
                    const hour = parseInt(match[3]);
                    const minute = parseInt(match[4]);
                    
                    // Êó•‰ªò„Å®ÊôÇÂàª„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                    if (month >= 1 && month <= 12 && 
                        day >= 1 && day <= 31 && 
                        hour >= 0 && hour <= 23 && 
                        minute >= 0 && minute <= 59) {
                        
                        const monthStr = month.toString().padStart(2, '0');
                        const dayStr = day.toString().padStart(2, '0');
                        const hourStr = hour.toString().padStart(2, '0');
                        const minuteStr = minute.toString().padStart(2, '0');
                        const currentYear = new Date().getFullYear();
                        const result = `${currentYear}-${monthStr}-${dayStr}T${hourStr}:${minuteStr}`;
                        console.log('„Éë„Çø„Éº„É≥6„Éû„ÉÉ„ÉÅÔºàÂé≥ÂØÜ„ÉÅ„Çß„ÉÉ„ÇØÔºâ:', result);
                        return result;
                    }
                }
            }
            
            console.log('ÊúüÈôê„Éë„Çø„Éº„É≥„Å´„Éû„ÉÉ„ÉÅ„Åõ„Åö:', text);
            return null;
        }
        
        // „Éë„Çø„Éº„É≥2: ÊüîËªü„Éë„Çø„Éº„É≥Ôºà„Éé„Ç§„Ç∫„ÇíÂê´„ÇÄÔºâ
        function tryFlexiblePattern(text) {
            console.log('ÊüîËªü„Éë„Çø„Éº„É≥ÈñãÂßã:', text);
            
            // „Çà„ÇäÁ∑©„ÅÑÊ∏ÖÊµÑÂåñÔºàÈáçË¶ÅÊñáÂ≠ó„Çí‰øùÊåÅÔºâ
            const flexibleText = text
                .replace(/[|ÔΩú]/g, '') // Á∏¶Á∑öÈô§Âéª
                .replace(/[‚ñ°‚ñ†‚ñ¢‚ñ£]/g, '') // ÂõõËßíË®òÂè∑Èô§Âéª
                .replace(/[ÔΩû„Äú]/g, '') // Ê≥¢Á∑öÈô§Âéª
                .replace(/\s+/g, ' ') // ÈÄ£Á∂öÁ©∫ÁôΩ„Çí1„Å§„Å´
                .trim();
            
            console.log('ÊüîËªü„Éë„Çø„Éº„É≥ - ËªΩ„ÅÑ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂæå:', flexibleText);
            
            // „Çà„ÇäÊüîËªü„Å™Ê≠£Ë¶èË°®Áèæ„Éë„Çø„Éº„É≥
            const flexiblePatterns = [
                { regex: /(\d{1,2})\s*Êúà\s*(\d{1,2})\s*Êó•.*?(\d{1,2})\s*:\s*(\d{2})/, type: 'flexible_full' },
                { regex: /(\d{1,2})\s*Êúà\s*(\d{1,2})\s*Êó•/, type: 'flexible_date' },
                { regex: /(\d{1,2})\s*:\s*(\d{2})/, type: 'flexible_time' }
            ];
            
            for (const pattern of flexiblePatterns) {
                const match = flexibleText.match(pattern.regex);
                if (match) {
                    const result = buildDateString(match, pattern.type);
                    if (result) {
                        console.log(`ÊüîËªü„Éë„Çø„Éº„É≥(${pattern.type})„Éû„ÉÉ„ÉÅ:`, result);
                        return result;
                    }
                }
            }
            
            console.log('ÊüîËªü„Éë„Çø„Éº„É≥„ÅßËß£ÊûêÂ§±Êïó');
            return null;
        }
        
        // „Éë„Çø„Éº„É≥3: ÈÉ®ÂàÜ„Éû„ÉÉ„ÉÅ„Éë„Çø„Éº„É≥ÔºàÊñ≠ÁâáÁöÑ„Å™ÊÉÖÂ†±„Åã„ÇâÊßãÁØâÔºâ
        function tryPartialMatchPattern(text) {
            console.log('ÈÉ®ÂàÜ„Éû„ÉÉ„ÉÅ„Éë„Çø„Éº„É≥ÈñãÂßã:', text);
            
            // Êï∞Â≠ó„ÅÆ„Åø„ÇíÊäΩÂá∫
            const numbers = text.match(/\d+/g);
            if (!numbers || numbers.length < 2) {
                console.log('ÈÉ®ÂàÜ„Éû„ÉÉ„ÉÅ: Êï∞Â≠ó„Åå‰∏çË∂≥');
                return null;
            }
            
            console.log('ÊäΩÂá∫„Åï„Çå„ÅüÊï∞Â≠ó:', numbers);
            
            // Êúà„ÉªÊó•„Çâ„Åó„ÅçÊï∞Â≠ó„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÊé¢„Åô
            for (let i = 0; i < numbers.length - 1; i++) {
                const month = parseInt(numbers[i]);
                const day = parseInt(numbers[i + 1]);
                
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // ÊôÇÂàª„ÇÇÊé¢„Åô
                    let timeResult = '';
                    if (numbers.length >= i + 4) {
                        const hour = parseInt(numbers[i + 2]);
                        const minute = parseInt(numbers[i + 3]);
                        if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                            timeResult = `T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        }
                    }
                    
                    const result = `${new Date().getFullYear()}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}${timeResult}`;
                    console.log('ÈÉ®ÂàÜ„Éû„ÉÉ„ÉÅ„Éë„Çø„Éº„É≥„Éû„ÉÉ„ÉÅ:', result);
                    return result;
                }
            }
            
            console.log('ÈÉ®ÂàÜ„Éû„ÉÉ„ÉÅ„Éë„Çø„Éº„É≥„ÅßËß£ÊûêÂ§±Êïó');
            return null;
        }
        
        // „Éë„Çø„Éº„É≥4: Êï∞Â≠óÊäΩÂá∫„Éë„Çø„Éº„É≥ÔºàÊúÄÂæå„ÅÆÊâãÊÆµÔºâ
        function tryNumberExtractionPattern(text) {
            console.log('Êï∞Â≠óÊäΩÂá∫„Éë„Çø„Éº„É≥ÈñãÂßã:', text);
            
            // „Çà„ÇäÁ©çÊ•µÁöÑ„Å™Êï∞Â≠óÊäΩÂá∫
            const allNumbers = [];
            const digitMatches = text.match(/\d/g);
            if (digitMatches) {
                let currentNumber = '';
                for (const digit of digitMatches) {
                    currentNumber += digit;
                    if (currentNumber.length >= 2) {
                        allNumbers.push(parseInt(currentNumber));
                        currentNumber = digit; // Ê¨°„ÅÆÊï∞Â≠ó„Å®„Åó„Å¶Á∂ôÁ∂ö
                    }
                }
                if (currentNumber.length > 0) {
                    allNumbers.push(parseInt(currentNumber));
                }
            }
            
            console.log('ÂÖ®ÊäΩÂá∫Êï∞Â≠ó:', allNumbers);
            
            // ÊúÄ„ÇÇÊúüÈôê„Çâ„Åó„ÅçÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÊé¢„Åô
            for (let i = 0; i < allNumbers.length - 1; i++) {
                const num1 = allNumbers[i];
                const num2 = allNumbers[i + 1];
                
                // Êúà„ÉªÊó•„ÅÆÂèØËÉΩÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                if ((num1 >= 1 && num1 <= 12 && num2 >= 1 && num2 <= 31) ||
                    (num2 >= 1 && num2 <= 12 && num1 >= 1 && num1 <= 31)) {
                    
                    const month = num1 >= 1 && num1 <= 12 ? num1 : num2;
                    const day = num1 >= 1 && num1 <= 12 ? num2 : num1;
                    
                    const result = `${new Date().getFullYear()}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    console.log('Êï∞Â≠óÊäΩÂá∫„Éë„Çø„Éº„É≥„Éû„ÉÉ„ÉÅ:', result);
                    return result;
                }
            }
            
            console.log('Êï∞Â≠óÊäΩÂá∫„Éë„Çø„Éº„É≥„ÅßËß£ÊûêÂ§±Êïó');
            return null;
        }
        
        // Êó•‰ªòÊñáÂ≠óÂàóÊßãÁØâ„Éò„É´„Éë„Éº
        function buildDateString(match, type) {
            const currentYear = new Date().getFullYear();
            
            try {
                switch (type) {
                    case 'full':
                    case 'date_with_time':
                    case 'flexible_full':
                        const month = parseInt(match[1]);
                        const day = parseInt(match[2]);
                        const hour = parseInt(match[3]);
                        const minute = parseInt(match[4]);
                        
                        if (isValidDate(month, day) && isValidTime(hour, minute)) {
                            return `${currentYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}T${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        }
                        break;
                        
                    case 'date_with_day':
                    case 'date_only':
                    case 'flexible_date':
                        const monthOnly = parseInt(match[1]);
                        const dayOnly = parseInt(match[2]);
                        
                        if (isValidDate(monthOnly, dayOnly)) {
                            return `${currentYear}-${monthOnly.toString().padStart(2, '0')}-${dayOnly.toString().padStart(2, '0')}`;
                        }
                        break;
                        
                    case 'time_only':
                    case 'flexible_time':
                        const hourOnly = parseInt(match[1]);
                        const minuteOnly = parseInt(match[2]);
                        
                        if (isValidTime(hourOnly, minuteOnly)) {
                            const today = new Date();
                            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T${hourOnly.toString().padStart(2, '0')}:${minuteOnly.toString().padStart(2, '0')}`;
                        }
                        break;
                }
            } catch (error) {
                console.error('Êó•‰ªòÊßãÁØâ„Ç®„É©„Éº:', error);
            }
            
            return null;
        }
        
        // Êó•‰ªòÊ§úË®º„Éò„É´„Éë„Éº
        function isValidDate(month, day) {
            return month >= 1 && month <= 12 && day >= 1 && day <= 31;
        }
        
        // ÊôÇÂàªÊ§úË®º„Éò„É´„Éë„Éº
        function isValidTime(hour, minute) {
            return hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59;
        }
        
        // „Éö„Ç¢Âåñ„Åï„Çå„Åü„Çø„Çπ„ÇØ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatPairedTasks(pairedTasks) {
            return pairedTasks.map(task => {
                let line = task.title;
                if (task.deadline) {
                    line += ` ${task.deadline}`;
                }
                return line;
            }).join('\n');
        }
        
        // ÁîªÂÉèÂâçÂá¶ÁêÜ„ÇíÈÅ©Áî®
        async function preprocessImage(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // „Ç∞„É¨„Éº„Çπ„Ç±„Éº„É´ÂåñÔºàÁ©è„ÇÑ„ÅãÔºâ
            if (document.getElementById('ocr-grayscale').checked) {
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                ctx.putImageData(imageData, 0, 0);
            }
            
            // „Ç≥„É≥„Éà„É©„Çπ„ÉàÂº∑ÂåñÔºàÁ©è„ÇÑ„Åã„Å™‰∫åÂÄ§ÂåñÔºâ
            if (document.getElementById('ocr-enhance-contrast').checked) {
                const contrastImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const contrastData = contrastImageData.data;
                
                for (let i = 0; i < contrastData.length; i += 4) {
                    const gray = contrastData[i] * 0.299 + contrastData[i + 1] * 0.587 + contrastData[i + 2] * 0.114;
                    // „Çà„ÇäÁ©è„ÇÑ„Åã„Å™ÈóæÂÄ§„Åß‰∫åÂÄ§Âåñ
                    const threshold = 140; // 128„Çà„ÇäÈ´ò„ÇÅ„Å´Ë®≠ÂÆö
                    const value = gray > threshold ? 255 : 0;
                    contrastData[i] = contrastData[i + 1] = contrastData[i + 2] = value;
                }
                ctx.putImageData(contrastImageData, 0, 0);
            }
            
            // 2ÂÄçÊã°Â§ßÂá¶ÁêÜ
            if (document.getElementById('ocr-upscale').checked) {
                const scaledCanvas = document.createElement('canvas');
                const scaledCtx = scaledCanvas.getContext('2d');
                scaledCanvas.width = canvas.width * 2;
                scaledCanvas.height = canvas.height * 2;
                
                // „Ç∑„É£„Éº„Éó„Å™Êã°Â§ß
                scaledCtx.imageSmoothingEnabled = false;
                scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
                
                return scaledCanvas;
            }
            
            return canvas;
        }
        
        // „Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´Áî®„ÅÆ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ
        let draggedTaskIndex = null;
        let draggedElement = null;
        
        function handlePreviewDragStartModal(e, index) {
            draggedTaskIndex = index;
            draggedElement = e.target.closest('.preview-task-card');
            draggedElement.style.opacity = '0.5';
            console.log('üîÑ „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã:', index);
        }
        
        function handleDragOverModal(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDropModal(e, targetIndex) {
            e.preventDefault();
            if (draggedTaskIndex === null || draggedTaskIndex === targetIndex) return;
            
            console.log('üîÑ „Éâ„É≠„ÉÉ„Éó:', draggedTaskIndex, '->', targetIndex);
            
            // previewTasksÈÖçÂàóÂÜÖ„ÅÆÈ†ÜÂ∫è„ÇíÂ§âÊõ¥
            const draggedTask = previewTasks[draggedTaskIndex];
            previewTasks.splice(draggedTaskIndex, 1);
            previewTasks.splice(targetIndex, 0, draggedTask);
            
            // „Éó„É¨„Éì„É•„Éº„ÇíÂÜçË°®Á§∫
            displayLineByLinePreviewModal();
        }
        
        function handleDragEndModal() {
            if (draggedElement) {
                draggedElement.style.opacity = '1';
            }
            draggedTaskIndex = null;
            draggedElement = null;
        }
        
        // „Çø„Çπ„ÇØÊõ¥Êñ∞Èñ¢Êï∞Áæ§
        function updateTaskTitleModal(index, value) {
            if (previewTasks[index]) {
                previewTasks[index].title = value;
            }
        }
        
        function updateTaskDeadlineModal(index, value) {
            if (previewTasks[index]) {
                previewTasks[index].deadline = value;
            }
        }
        
        function updateTaskTimeModal(index, value) {
            if (previewTasks[index]) {
                previewTasks[index].time = value;
            }
        }
        
        function updateTaskAssigneeModal(index, value) {
            if (previewTasks[index]) {
                previewTasks[index].assignee = value;
            }
        }
        
        function updateTaskColumnModal(index, value) {
            if (previewTasks[index]) {
                previewTasks[index].columnId = value;
            }
        }
        
        function updateTaskTypeModal(index, value) {
            if (previewTasks[index]) {
                if (value === 'skip') {
                    previewTasks[index].isSkip = true;
                    previewTasks[index].isMainTask = false;
                } else if (value === 'comment') {
                    previewTasks[index].isSkip = false;
                    previewTasks[index].isMainTask = false;
                } else {
                    previewTasks[index].isSkip = false;
                    previewTasks[index].isMainTask = true;
                }
            }
        }
        
        function removeTaskModal(index) {
            if (confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                previewTasks.splice(index, 1);
                displayLineByLinePreviewModal();
            }
        }
        
        // 3Âàó„Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà„Åß„ÅÆ„Éó„É¨„Éì„É•„ÉºË°®Á§∫
        function displayLineByLinePreviewModal() {
            const contentDiv = document.getElementById('preview-content-modal');
            if (!contentDiv || previewTasks.length === 0) return;
            
            let content = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;" id="preview-container-modal">
            `;
            
            previewTasks.forEach((task, index) => {
                const isMainTask = task.isMainTask;
                const isSkip = task.isSkip;
                const hasComment = task.title.includes('‚Üí') || task.originalLine?.includes('„ÄÄ');
                
                const cardColor = isSkip ? '#f8f9fa' : (isMainTask ? '#e3f2fd' : '#fff3e0');
                const borderColor = isSkip ? '#dee2e6' : (isMainTask ? '#2196f3' : '#ff9800');
                const typeIcon = isSkip ? 'üö´' : (isMainTask ? 'üìã' : 'üí¨');
                
                content += `
                    <div class="preview-task-card" 
                         draggable="true" 
                         ondragstart="handlePreviewDragStartModal(event, ${index})"
                         ondragover="handleDragOverModal(event)"
                         ondrop="handleDropModal(event, ${index})"
                         ondragend="handleDragEndModal()"
                         style="
                             background: ${cardColor}; 
                             border: 2px solid ${borderColor}; 
                             border-radius: 8px; 
                             padding: 1rem; 
                             margin-bottom: 0.5rem;
                             cursor: move;
                             min-height: 180px;
                             position: relative;
                         ">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.2rem;">${typeIcon}</span>
                            <span style="font-weight: bold; font-size: 0.9rem; color: #666;">#${index + 1}</span>
                            ${hasComment ? '<span style="color: #ff9800; font-size: 0.8rem;">üìù</span>' : ''}
                            <div style="font-size: 0.7rem; color: #666; margin-left: auto;">‚ãÆ‚ãÆ</div>
                        </div>
                        
                        <!-- „Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´ -->
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text" value="${task.title}" 
                                   onchange="updateTaskTitleModal(${index}, this.value)"
                                   style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.9rem;">
                        </div>
                        
                        <!-- ÊúüÈôêË®≠ÂÆö -->
                        <div style="display: grid; grid-template-columns: 1fr 80px; gap: 0.25rem; margin-bottom: 0.5rem;">
                            <input type="date" value="${task.deadline || ''}" 
                                   onchange="updateTaskDeadlineModal(${index}, this.value)"
                                   style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8rem;">
                            <input type="time" value="${task.time || '17:00'}" 
                                   onchange="updateTaskTimeModal(${index}, this.value)"
                                   style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8rem;">
                        </div>
                        
                        <!-- ÊãÖÂΩìËÄÖ -->
                        <div style="margin-bottom: 0.5rem;">
                            <select onchange="updateTaskAssigneeModal(${index}, this.value)"
                                    style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8rem;">
                                <option value="Êú™Ë®≠ÂÆö" ${task.assignee === 'Êú™Ë®≠ÂÆö' ? 'selected' : ''}>Êú™Ë®≠ÂÆö</option>
                                ${assignees.map(assignee => 
                                    `<option value="${assignee}" ${task.assignee === assignee ? 'selected' : ''}>${assignee}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <!-- „Ç´„É©„É†ÈÅ∏Êäû -->
                        <div style="margin-bottom: 0.5rem;">
                            <select onchange="updateTaskColumnModal(${index}, this.value)"
                                    style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8rem;">
                                ${columns.map(col => 
                                    `<option value="${col.id}" ${task.columnId === col.id ? 'selected' : ''}>${col.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <!-- „Çø„Ç§„ÉóÈÅ∏Êäû -->
                        <div style="display: grid; grid-template-columns: 1fr 30px; gap: 0.25rem;">
                            <select onchange="updateTaskTypeModal(${index}, this.value)"
                                    style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8rem;">
                                <option value="task" ${isMainTask ? 'selected' : ''}>üìã „Çø„Çπ„ÇØ</option>
                                <option value="comment" ${!isMainTask && !isSkip ? 'selected' : ''}>üí¨ „Ç≥„É°„É≥„Éà</option>
                                <option value="skip" ${isSkip ? 'selected' : ''}>üö´ „Çπ„Ç≠„ÉÉ„Éó</option>
                            </select>
                            <button onclick="removeTaskModal(${index})" 
                                    style="background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">
                                ‚úï
                            </button>
                        </div>
                    </div>
                `;
            });
            
            content += '</div>';
            contentDiv.innerHTML = content;
        }
        
        // processImportTextÈñ¢Êï∞„ÅÆ‰øÆÊ≠£ÁâàÔºà„Éó„É¨„Éì„É•„ÉºË°®Á§∫„ÇíÊ≠£„Åó„ÅÑÈñ¢Êï∞„Å´Â§âÊõ¥Ôºâ
        function processImportTextModal() {
            const text = document.getElementById('import-text-modal').value.trim();
            if (!text) {
                alert('„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            console.log('üîç [MODAL] Processing import text:', text.substring(0, 100) + '...');
            
            previewTasks = [];
            const lines = text.split('\n').filter(line => line.trim());
            
            console.log('üîç [MODAL] Processing', lines.length, 'lines');
            
            // Êï∞Â≠óË®òÂè∑Â§âÊèõÔºà‚ë†‚Üí1, ‚ë°‚Üí2, ‚óã‚Üí0, ‚óè‚Üí1Ôºâ
            const processedLines = lines.map(line => {
                return line
                    .replace(/‚ë†/g, '1').replace(/‚ë°/g, '2').replace(/‚ë¢/g, '3')
                    .replace(/‚ë£/g, '4').replace(/‚ë§/g, '5').replace(/‚ë•/g, '6')
                    .replace(/‚ë¶/g, '7').replace(/‚ëß/g, '8').replace(/‚ë®/g, '9')
                    .replace(/‚ë©/g, '10').replace(/‚óã/g, '0').replace(/‚óè/g, '1');
            });
            
            console.log('üîç [MODAL] Symbol conversion completed');
            
            // „Ç§„É≥„Éá„É≥„ÉàÊ§úÂá∫„Å®ÈöéÂ±§ÂåñÔºà2 half-width spaces or 1 full-width spaceÔºâ
            processedLines.forEach((line, index) => {
                const originalLine = line;
                const trimmedLine = line.trim();
                
                if (!trimmedLine) return;
                
                // „Ç§„É≥„Éá„É≥„Éà„É¨„Éô„É´„ÇíÊ§úÂá∫ÔºàÂçäËßí„Çπ„Éö„Éº„Çπ2ÂÄã or ÂÖ®Ëßí„Çπ„Éö„Éº„Çπ1ÂÄã = 1„É¨„Éô„É´Ôºâ
                const indentLevel = Math.floor((line.length - line.trimStart().length) / 2);
                const isIndented = indentLevel > 0 || line.startsWith('„ÄÄ');
                
                console.log(`üîç [MODAL] Line ${index + 1}: "${trimmedLine}" (indent: ${indentLevel}, isIndented: ${isIndented})`);
                
                const task = {
                    id: index,
                    title: trimmedLine,
                    deadline: getTodayDate(),
                    time: '17:00',
                    priority: 'medium',
                    assignee: 'Êú™Ë®≠ÂÆö',
                    columnId: 'todo',
                    isMainTask: !isIndented,
                    isSkip: false,
                    parentIndex: isIndented ? Math.max(0, previewTasks.length - 1) : null,
                    originalLine: originalLine,
                    indentLevel: indentLevel
                };
                
                previewTasks.push(task);
            });
            
            console.log('üîç [MODAL] Preview tasks created:', previewTasks.length);
            
            // „Éó„É¨„Éì„É•„ÉºË°®Á§∫Ôºà„É¢„Éº„ÉÄ„É´Áî®„ÅÆÈñ¢Êï∞„Çí‰ΩøÁî®Ôºâ
            displayLineByLinePreviewModal();
            
            // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢„ÇíË°®Á§∫
            document.getElementById('import-preview-modal').style.display = 'block';
        }
        
        // „É¢„Éº„ÉÄ„É´Áî®„ÅÆ„Ç§„É≥„Éù„Éº„ÉàÂÆüË°åÈñ¢Êï∞
        function executeImportModal() {
            if (previewTasks.length === 0) {
                alert('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            let importedCount = 0;
            const taskIdMap = {};
            
            // „É°„Ç§„É≥„Çø„Çπ„ÇØ„Çí‰ΩúÊàê
            previewTasks.forEach((previewTask, index) => {
                if (previewTask.isSkip || !previewTask.isMainTask) return;
                
                if (previewTask.assignee !== 'Êú™Ë®≠ÂÆö' && !assignees.includes(previewTask.assignee)) {
                    assignees.push(previewTask.assignee);
                    localStorage.setItem('taskAssignees', JSON.stringify(assignees));
                }
                
                const taskId = Date.now() + index;
                taskIdMap[index] = taskId;
                
                const newTask = {
                    id: taskId,
                    title: previewTask.title,
                    deadline: new Date(`${previewTask.deadline}T${previewTask.time || '17:00'}`).toISOString(),
                    priority: previewTask.priority,
                    assignees: [previewTask.assignee],
                    assignee: previewTask.assignee,
                    memo: `„Ç§„É≥„Éù„Éº„Éà: ${new Date().toLocaleDateString()}`,
                    columnId: previewTask.columnId,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    comments: [],
                    originalLine: previewTask.originalLine
                };
                
                tasks.push(newTask);
                importedCount++;
            });
            
            // „Ç≥„É°„É≥„Éà„ÇíËøΩÂä†
            previewTasks.forEach((previewTask, index) => {
                if (previewTask.isSkip || previewTask.isMainTask) return;
                if (previewTask.parentIndex === null) return;
                
                const parentTaskId = taskIdMap[previewTask.parentIndex];
                if (!parentTaskId) return;
                
                const parentTask = tasks.find(t => t.id === parentTaskId);
                if (parentTask) {
                    parentTask.comments.push({
                        id: Date.now() + index,
                        author: previewTask.assignee,
                        text: `üìù ${previewTask.title}`,
                        timestamp: new Date().toISOString(),
                        isImportedComment: true
                    });
                }
            });
            
            if (importedCount > 0) {
                saveTasks();
                render();
                
                setTimeout(() => checkDeadlines(), 100);
                
                document.getElementById('import-text-modal').value = '';
                hidePreviewModal();
                closeTaskImportModal();
                
                const commentCount = previewTasks.filter(t => !t.isMainTask && !t.isSkip).length;
                let message = `üéâ „Çø„Çπ„ÇØËøΩÂä†„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\n`;
                message += `üìã ${importedCount}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„ÇíËøΩÂä†\n`;
                if (commentCount > 0) {
                    message += `üí¨ ${commentCount}ÂÄã„ÅÆ„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†\n`;
                }
                
                alert(message);
                
                setTimeout(() => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }
        
        // „É¢„Éº„ÉÄ„É´Áî®„ÅÆ„Éó„É¨„Éì„É•„ÉºÈùûË°®Á§∫Èñ¢Êï∞
        function hidePreviewModal() {
            document.getElementById('import-preview-modal').style.display = 'none';
            document.getElementById('preview-content-modal').innerHTML = '';
            previewTasks = [];
        }
        
        // „É¢„Éº„ÉÄ„É´Áî®„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇØ„É™„Ç¢Èñ¢Êï∞
        function clearImportTextModal() {
            document.getElementById('import-text-modal').value = '';
            hidePreviewModal();
        }
        
        // „Åô„Åπ„Å¶„ÅÆÈñ¢Êï∞„Çíwindow„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ËøΩÂä†
        window.handlePreviewDragStartModal = handlePreviewDragStartModal;
        window.handleDragOverModal = handleDragOverModal;
        window.handleDropModal = handleDropModal;
        window.handleDragEndModal = handleDragEndModal;
        window.updateTaskTitleModal = updateTaskTitleModal;
        window.updateTaskDeadlineModal = updateTaskDeadlineModal;
        window.updateTaskTimeModal = updateTaskTimeModal;
        window.updateTaskAssigneeModal = updateTaskAssigneeModal;
        window.updateTaskColumnModal = updateTaskColumnModal;
        window.updateTaskTypeModal = updateTaskTypeModal;
        window.removeTaskModal = removeTaskModal;
        window.displayLineByLinePreviewModal = displayLineByLinePreviewModal;
        window.processImportTextModal = processImportTextModal;
        window.executeImportModal = executeImportModal;
        window.hidePreviewModal = hidePreviewModal;
        window.clearImportTextModal = clearImportTextModal;

        // GoogleTODOÂΩ¢Âºè„ÅÆ„Çø„Çπ„ÇØËß£ÊûêÔºàÊúüÈôê‰ªò„Åç„Çø„Çπ„ÇØ„ÇíÂàÜÈõ¢Ôºâ
        function parseGoogleTodoText(text) {
            // GoogleTODO„ÅÆÊúüÈôêÂΩ¢Âºè„Éë„Çø„Éº„É≥: mmÊúàddÊó•(ÊõúÊó•), hh:mm
            // ‰æã: "12Êúà15Êó•(Êúà), 14:30" „Åæ„Åü„ÅØ "12Êúà15Êó• 14:30" „Å™„Å©
            const dateTimePatterns = [
                // Âü∫Êú¨ÂΩ¢Âºè: mmÊúàddÊó•(ÊõúÊó•), hh:mm
                /(\d{1,2})Êúà(\d{1,2})Êó•\s*\([ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•]\)\s*,?\s*(\d{1,2}):(\d{2})/g,
                // ÊõúÊó•„Å™„Åó: mmÊúàddÊó•, hh:mm
                /(\d{1,2})Êúà(\d{1,2})Êó•\s*,?\s*(\d{1,2}):(\d{2})/g,
                // ÊôÇÂàª„Å™„Åó: mmÊúàddÊó•(ÊõúÊó•)
                /(\d{1,2})Êúà(\d{1,2})Êó•\s*\([ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•]\)/g,
                // ÊôÇÂàª„Å™„ÅóÊõúÊó•„Å™„Åó: mmÊúàddÊó•
                /(\d{1,2})Êúà(\d{1,2})Êó•/g,
                // Ë•øÊö¶‰ªò„Åç: yyyyÂπ¥mmÊúàddÊó•
                /(\d{4})Âπ¥(\d{1,2})Êúà(\d{1,2})Êó•/g
            ];
            
            const results = [];
            const lines = text.split('\n');
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                let taskTitle = trimmedLine;
                let deadline = null;
                let foundDate = false;
                
                // ÂêÑ„Éë„Çø„Éº„É≥„Åß„Éû„ÉÉ„ÉÅ„ÇíË©¶Ë°å
                for (const pattern of dateTimePatterns) {
                    const matches = [...trimmedLine.matchAll(pattern)];
                    if (matches.length > 0) {
                        const match = matches[0];
                        foundDate = true;
                        
                        // ÊúüÈôêÊÉÖÂ†±„ÇíÊäΩÂá∫
                        if (pattern.source.includes('Âπ¥')) {
                            // yyyyÂπ¥mmÊúàddÊó•ÂΩ¢Âºè
                            const year = match[1];
                            const month = match[2].padStart(2, '0');
                            const day = match[3].padStart(2, '0');
                            deadline = `${year}-${month}-${day}`;
                        } else if (match[3] && match[4]) {
                            // ÊôÇÂàª‰ªò„Åç
                            const month = match[1].padStart(2, '0');
                            const day = match[2].padStart(2, '0');
                            const hour = match[3].padStart(2, '0');
                            const minute = match[4].padStart(2, '0');
                            const currentYear = new Date().getFullYear();
                            deadline = `${currentYear}-${month}-${day}T${hour}:${minute}`;
                        } else {
                            // Êó•‰ªò„ÅÆ„Åø
                            const month = match[1].padStart(2, '0');
                            const day = match[2].padStart(2, '0');
                            const currentYear = new Date().getFullYear();
                            deadline = `${currentYear}-${month}-${day}`;
                        }
                        
                        // ÊúüÈôêÈÉ®ÂàÜ„Çí„Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´„Åã„ÇâÈô§Âéª
                        taskTitle = trimmedLine.replace(match[0], '').trim();
                        
                        // ÂâçÂæå„ÅÆ‰∏çË¶Å„Å™Ë®òÂè∑„ÇíÈô§Âéª
                        taskTitle = taskTitle.replace(/^[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+|[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+$/g, '');
                        
                        break;
                    }
                }
                
                // ÊúüÈôê„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅÆÁ∞°Êòì„Éë„Çø„Éº„É≥ÔºàÊï∞Â≠ó„ÅÆ„Åø„ÅÆÊôÇÂàª„Å™„Å©Ôºâ
                if (!foundDate) {
                    // ÂçòÁ¥î„Å™ÊôÇÂàª„Éë„Çø„Éº„É≥: hh:mm
                    const timeMatch = taskTitle.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                        const hour = timeMatch[1].padStart(2, '0');
                        const minute = timeMatch[2].padStart(2, '0');
                        const today = new Date();
                        deadline = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T${hour}:${minute}`;
                        taskTitle = taskTitle.replace(timeMatch[0], '').trim();
                    }
                }
                
                // Á©∫„ÅÆ„Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´„ÇíÈÅø„Åë„Çã
                if (taskTitle && taskTitle.length > 1) {
                    results.push({
                        title: taskTitle,
                        deadline: deadline,
                        hasDeadline: !!deadline,
                        originalLine: trimmedLine
                    });
                }
            });
            
            return results;
        }

        // OCRÁµêÊûú„ÅÆ„Éù„Çπ„Éà„Éó„É≠„Çª„ÉÉ„Ç∑„É≥„Ç∞
        function postprocessOCRText(text) {
            let processed = text;
            
            // Âõ≤„ÅøÊï∞Â≠ó„ÅØÂ∏∏„Å´‰øÆÊ≠£ÔºàÊòé„Çâ„Åã„Å™Ë™§Ë™çË≠ò„ÅÆ„Åü„ÇÅÔºâ
            const circledNumbers = {
                '‚ë†': '1', '‚ë°': '2', '‚ë¢': '3', '‚ë£': '4', '‚ë§': '5',
                '‚ë•': '6', '‚ë¶': '7', '‚ëß': '8', '‚ë®': '9', '‚ë©': '10',
                '‚ë™': '11', '‚ë´': '12', '‚ë¨': '13', '‚ë≠': '14', '‚ëÆ': '15',
                '‚ëØ': '16', '‚ë∞': '17', '‚ë±': '18', '‚ë≤': '19', '‚ë≥': '20',
                '‚ù∂': '1', '‚ù∑': '2', '‚ù∏': '3', '‚ùπ': '4', '‚ù∫': '5',
                '‚ùª': '6', '‚ùº': '7', '‚ùΩ': '8', '‚ùæ': '9', '‚ùø': '10',
                '‚ì™': '0', '‚ì´': '11', '‚ì¨': '12', '‚ì≠': '13', '‚ìÆ': '14',
                '‚ìØ': '15', '‚ì∞': '16', '‚ì±': '17', '‚ì≤': '18', '‚ì≥': '19', '‚ì¥': '20'
            };
            
            // Âõ≤„ÅøÊï∞Â≠ó„ÇíÈÄöÂ∏∏„ÅÆÊï∞Â≠ó„Å´Â§âÊèõÔºàÂ∏∏„Å´ÂÆüË°åÔºâ
            Object.keys(circledNumbers).forEach(circled => {
                const regex = new RegExp(circled, 'g');
                processed = processed.replace(regex, circledNumbers[circled]);
            });
            
            // „Åù„ÅÆ‰ªñ„ÅÆË®òÂè∑„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            if (document.getElementById('ocr-cleanup-symbols').checked) {
                // ÂÖ®ËßíÊï∞Â≠ó‚ÜíÂçäËßíÊï∞Â≠ó
                processed = processed.replace(/[Ôºê-Ôºô]/g, (match) => 
                    String.fromCharCode(match.charCodeAt(0) - 0xFEE0)
                );
                
                // Êòé„Çâ„Åã„Å™Ë™§Ë™çË≠ò„ÅÆ„Åø‰øÆÊ≠£
                processed = processed
                    .replace(/\b[Oo]\.?\s*(?=\d)/g, '0') // O.Êï∞Â≠ó ‚Üí 0Êï∞Â≠ó
                    .replace(/\b[Il]\s*(?=\d)/g, '1') // IÊï∞Â≠ó ‚Üí 1Êï∞Â≠ó
                    .replace(/\b[Il]\b/g, '1') // Âçò‰Ωì„ÅÆI„ÇÑl‚Üí 1
                    // ‰∏∏Ë®òÂè∑„ÅÆÂ§âÊèõ
                    .replace(/[‚óã‚óØ‚óå‚ö™]/g, '0') // ÁôΩ‰∏∏‚Üí 0
                    .replace(/[‚óè‚Ä¢‚ö´]/g, '1'); // Èªí‰∏∏‚Üí 1
            }
            
            return processed.trim();
        }
        
        async function performOCROnCanvas(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    // ÂâçÂá¶ÁêÜ„ÇíÈÅ©Áî®
                    const processedCanvas = await preprocessImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            const { data: { text } } = await Tesseract.recognize(
                                blob,
                                'jpn+eng',
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                                    tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ„ÅÇ-„Çñ„Ç¢-„É∂‰∏Ä-ÈæØ!@#$%^&*()_+-=[]{}|;:,.<>?/~ „ÄÄ„Äå„Äç„ÄÅ„ÄÇ',
                                    preserve_interword_spaces: '1'
                                }
                            );
                            
                            // „Éù„Çπ„Éà„Éó„É≠„Çª„ÉÉ„Ç∑„É≥„Ç∞„ÇíÈÅ©Áî®
                            const processedText = postprocessOCRText(text);
                            resolve(processedText);
                        } catch (error) {
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // ÊúüÈôêÂ∞ÇÁî®OCRÔºà„Çà„ÇäÂé≥ÂØÜ„Å™ÊñáÂ≠óË™çË≠òÔºâ
        async function performDeadlineOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    // „Çà„ÇäÂé≥ÂØÜ„Å™ÂâçÂá¶ÁêÜÔºàÊúüÈôêÁî®Ôºâ
                    const processedCanvas = await preprocessDeadlineImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            // Êó•Êú¨Ë™ûÂÑ™ÂÖà„ÅÆË®≠ÂÆö„ÅßOCRÂÆüË°å
                            const { data: { text } } = await Tesseract.recognize(
                                blob,
                                'jpn', // Êó•Êú¨Ë™û„ÅÆ„Åø„Å´Â§âÊõ¥ÔºàËã±Ë™ûÊ∑∑Âú®„ÇíÈÅø„Åë„ÇãÔºâ
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE, // Âçò‰∏ÄË°å„É¢„Éº„Éâ
                                    // ÊñáÂ≠ó„Éõ„ÉØ„Ç§„Éà„É™„Çπ„Éà„Çí‰∏ÄÊôÇÁöÑ„Å´Â§ñ„Åó„Å¶ÂÖ®ÊñáÂ≠óË™çË≠ò
                                    preserve_interword_spaces: '1',
                                    tessedit_ocr_engine_mode: 3 // LSTM mode
                                }
                            );
                            
                            console.log('ÊúüÈôêOCRÁîü„ÅÆÁµêÊûú:', text);
                            
                            // ÊúüÈôêÂ∞ÇÁî®„Éù„Çπ„Éà„Éó„É≠„Çª„ÉÉ„Ç∑„É≥„Ç∞
                            const processedText = postprocessDeadlineText(text);
                            console.log('ÊúüÈôêOCRÂá¶ÁêÜÂæå:', processedText);
                            
                            resolve(processedText);
                        } catch (error) {
                            console.error('ÊúüÈôêOCR„Ç®„É©„Éº:', error);
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // ÊúüÈôêÂ∞ÇÁî®ÂâçÂá¶ÁêÜ
        async function preprocessDeadlineImage(canvas) {
            const ctx = canvas.getContext('2d');
            
            // ÁîªÂÉè„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™çÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
            console.log('ÊúüÈôêÁîªÂÉè„Çµ„Ç§„Ç∫:', canvas.width, 'x', canvas.height);
            
            // ÂèçËª¢Ê§úÁü•ÔºàÈªíËÉåÊôØ„ÅÆÂ†¥ÂêàÔºâ
            const sampleData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let blackPixels = 0;
            let totalPixels = sampleData.data.length / 4;
            
            for (let i = 0; i < sampleData.data.length; i += 4) {
                const gray = sampleData.data[i] * 0.299 + sampleData.data[i + 1] * 0.587 + sampleData.data[i + 2] * 0.114;
                if (gray < 128) blackPixels++;
            }
            
            const isInverted = blackPixels / totalPixels > 0.6;
            console.log('ËÉåÊôØÂà§ÂÆö:', isInverted ? 'ÈªíËÉåÊôØ' : 'ÁôΩËÉåÊôØ');
            
            // „Ç∞„É¨„Éº„Çπ„Ç±„Éº„É´ + ÈÅ©ÂøúÁöÑ‰∫åÂÄ§Âåñ
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                
                // ÈªíËÉåÊôØ„ÅÆÂ†¥Âêà„ÅØËâ≤„ÇíÂèçËª¢
                let value;
                if (isInverted) {
                    value = gray < 128 ? 255 : 0;
                } else {
                    value = gray > 128 ? 255 : 0;
                }
                
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            ctx.putImageData(imageData, 0, 0);
            
            // 4ÂÄçÊã°Â§ßÔºàGoogle TODO „ÅÆÂ∞è„Åï„ÅÑÊúüÈôê„ÉÜ„Ç≠„Çπ„ÉàÁî®Ôºâ
            const scaledCanvas = document.createElement('canvas');
            const scaledCtx = scaledCanvas.getContext('2d');
            scaledCanvas.width = canvas.width * 4;
            scaledCanvas.height = canvas.height * 4;
            
            // „Éê„Ç§„É™„Éã„Ç¢Ë£úÈñì„Çí‰ΩøÁî®Ôºà„Çà„ÇäÊªë„Çâ„Åã„Å™Êã°Â§ßÔºâ
            scaledCtx.imageSmoothingEnabled = true;
            scaledCtx.imageSmoothingQuality = 'high';
            scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
            
            // ÂÜçÂ∫¶„Ç∑„É£„Éº„Éó„Éã„É≥„Ç∞
            const finalData = scaledCtx.getImageData(0, 0, scaledCanvas.width, scaledCanvas.height);
            const finalPixels = finalData.data;
            
            for (let i = 0; i < finalPixels.length; i += 4) {
                const gray = finalPixels[i];
                const sharpened = gray > 200 ? 255 : 0;
                finalPixels[i] = finalPixels[i + 1] = finalPixels[i + 2] = sharpened;
            }
            scaledCtx.putImageData(finalData, 0, 0);
            
            return scaledCanvas;
        }
        
        // ÊúüÈôêÂ∞ÇÁî®„Éù„Çπ„Éà„Éó„É≠„Çª„ÉÉ„Ç∑„É≥„Ç∞
        function postprocessDeadlineText(text) {
            let processed = text.trim();
            
            // Âõ≤„ÅøÊï∞Â≠ó„ÇíÈÄöÂ∏∏Êï∞Â≠ó„Å´Â§âÊèõ
            const circledNumbers = {
                '‚ë†': '1', '‚ë°': '2', '‚ë¢': '3', '‚ë£': '4', '‚ë§': '5',
                '‚ë•': '6', '‚ë¶': '7', '‚ëß': '8', '‚ë®': '9', '‚ë©': '10',
                '‚ë™': '11', '‚ë´': '12', '‚ë¨': '13', '‚ë≠': '14', '‚ëÆ': '15',
                '‚ëØ': '16', '‚ë∞': '17', '‚ë±': '18', '‚ë≤': '19', '‚ë≥': '20',
                '„âë': '21', '„âí': '22', '„âì': '23', '„âî': '24', '„âï': '25',
                '„âñ': '26', '„âó': '27', '„âò': '28', '„âô': '29', '„âö': '30', '„âõ': '31'
            };
            
            Object.keys(circledNumbers).forEach(circled => {
                const regex = new RegExp(circled, 'g');
                processed = processed.replace(regex, circledNumbers[circled]);
            });
            
            // ÊúüÈôêÁâπÊúâ„ÅÆË™§Ë™çË≠ò„Çí‰øÆÊ≠£
            processed = processed
                .replace(/[oO]/g, '0') // o,O ‚Üí 0
                .replace(/[lI]/g, '1') // l,I ‚Üí 1
                .replace(/[S]/g, '5') // S ‚Üí 5
                .replace(/[Zz]/g, '2') // Z,z ‚Üí 2
                .replace(/[B]/g, '8') // B ‚Üí 8
                .replace(/[G]/g, '6') // G ‚Üí 6
                // ÂÖ®ËßíÊï∞Â≠ó„ÇíÂçäËßí„Å´
                .replace(/[Ôºê-Ôºô]/g, (match) => 
                    String.fromCharCode(match.charCodeAt(0) - 0xFEE0)
                )
                // ‰∏çË¶Å„Å™Ë®òÂè∑„ÇíÈô§ÂéªÔºàÊúüÈôê„Å´ÂøÖË¶Å„Å™ÊñáÂ≠ó‰ª•Â§ñÔºâ
                .replace(/[^\dÊúàÊó•\(\)ÁÅ´Ê∞¥Êú®ÈáëÂúü,:\ ]/g, '')
                // Ë§áÊï∞„Çπ„Éö„Éº„Çπ„ÇíÂçò‰∏Ä„Çπ„Éö„Éº„Çπ„Å´
                .replace(/\s+/g, ' ');
            
            return processed.trim();
        }
        
        // ÊâãÊõ∏„ÅçÊñáÂ≠óÂØæÂøúOCRÔºàÈ´òÁ≤æÂ∫¶„É¢„Éº„ÉâÔºâ
        async function performHandwritingOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('ÊâãÊõ∏„ÅçÊñáÂ≠óOCRÈñãÂßã:', canvas.width, 'x', canvas.height);
                    
                    // ÊâãÊõ∏„ÅçÂ∞ÇÁî®ÂâçÂá¶ÁêÜ
                    const processedCanvas = await preprocessHandwritingImage(canvas);
                    
                    processedCanvas.toBlob(async (blob) => {
                        try {
                            // ÊâãÊõ∏„ÅçÊñáÂ≠ó„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüË®≠ÂÆö„ÅßOCRÂÆüË°å
                            const { data: { text, confidence } } = await Tesseract.recognize(
                                blob,
                                'jpn', // Êó•Êú¨Ë™û„ÅÆ„Åø„Å´ÁâπÂåñ
                                {
                                    tessedit_pageseg_mode: Tesseract.PSM.AUTO, // Ëá™Âãï„Çª„Ç∞„É°„É≥„ÉÜ„Éº„Ç∑„Éß„É≥
                                    tessedit_ocr_engine_mode: 3, // LSTM Neural Network
                                    // ÊâãÊõ∏„ÅçÊñáÂ≠óÁî®„ÅÆË®≠ÂÆö
                                    tessedit_char_whitelist: '0123456789ÊúàÊó•ÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•(),:Ôºö„ÄÄ ', // ÊúüÈôê„Å´ÂøÖË¶Å„Å™ÊñáÂ≠ó„ÅÆ„Åø
                                    c_min_confidence: 30, // ‰ø°È†ºÂ∫¶„Çí‰∏ã„Åí„Å¶ÊâãÊõ∏„Åç„ÇÇË™çË≠ò
                                    preserve_interword_spaces: '1',
                                    // ÊâãÊõ∏„ÅçÊñáÂ≠óË™çË≠òÂº∑Âåñ„Éë„É©„É°„Éº„Çø
                                    textord_heavy_nr: '1',
                                    textord_min_linesize: '2.5',
                                    edges_max_children_per_outline: '40'
                                }
                            );
                            
                            console.log('ÊâãÊõ∏„ÅçOCRÁµêÊûú:', text);
                            console.log('ÊâãÊõ∏„ÅçOCR‰ø°È†ºÂ∫¶:', confidence);
                            
                            // ÊâãÊõ∏„ÅçÂ∞ÇÁî®„Éù„Çπ„Éà„Éó„É≠„Çª„ÉÉ„Ç∑„É≥„Ç∞
                            const processedText = postprocessHandwritingText(text);
                            console.log('ÊâãÊõ∏„ÅçOCRÂá¶ÁêÜÂæå:', processedText);
                            
                            resolve({ text: processedText, confidence: confidence });
                        } catch (error) {
                            console.error('ÊâãÊõ∏„ÅçOCR„Ç®„É©„Éº:', error);
                            reject(error);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // ÊâãÊõ∏„ÅçÊñáÂ≠óÂ∞ÇÁî®ÂâçÂá¶ÁêÜ
        async function preprocessHandwritingImage(canvas) {
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            newCanvas.width = canvas.width;
            newCanvas.height = canvas.height;
            
            ctx.drawImage(canvas, 0, 0);
            
            // ÊâãÊõ∏„ÅçÊñáÂ≠óÁî®„ÅÆÁâπÂà•„Å™ÂâçÂá¶ÁêÜ
            const imageData = ctx.getImageData(0, 0, newCanvas.width, newCanvas.height);
            const data = imageData.data;
            
            // 1. „Ç®„ÉÉ„Ç∏Âº∑ÂåñÔºàÊâãÊõ∏„Åç„ÅÆËñÑ„ÅÑÁ∑ö„ÇíÂº∑Ë™øÔºâ
            const edgeData = new Uint8ClampedArray(data);
            for (let y = 1; y < newCanvas.height - 1; y++) {
                for (let x = 1; x < newCanvas.width - 1; x++) {
                    const idx = (y * newCanvas.width + x) * 4;
                    
                    // Âë®Âõ≤„ÅÆ„Éî„ÇØ„Çª„É´„Å®„ÅÆÂ∑ÆÂàÜ„ÇíË®àÁÆó
                    const center = data[idx];
                    const top = data[((y-1) * newCanvas.width + x) * 4];
                    const bottom = data[((y+1) * newCanvas.width + x) * 4];
                    const left = data[(y * newCanvas.width + (x-1)) * 4];
                    const right = data[(y * newCanvas.width + (x+1)) * 4];
                    
                    const edge = Math.abs(center - top) + Math.abs(center - bottom) + 
                                Math.abs(center - left) + Math.abs(center - right);
                    
                    const enhanced = Math.min(255, center + edge * 0.3);
                    edgeData[idx] = edgeData[idx + 1] = edgeData[idx + 2] = enhanced;
                }
            }
            
            // 2. „Ç¨„Ç¶„Ç∑„Ç¢„É≥„Éï„Ç£„É´„Çø„Åß„Éé„Ç§„Ç∫Èô§Âéª
            const filtered = applyGaussianFilter(edgeData, newCanvas.width, newCanvas.height);
            
            // 3. ÈÅ©ÂøúÁöÑ‰∫åÂÄ§ÂåñÔºàÊâãÊõ∏„Åç„ÅÆÊøÉÂ∫¶„É†„É©„Å´ÂØæÂøúÔºâ
            for (let i = 0; i < filtered.length; i += 4) {
                const gray = filtered[i];
                // ÊâãÊõ∏„ÅçÊñáÂ≠óÁî®„ÅÆÈñæÂÄ§Ë™øÊï¥
                const threshold = 140; // ÊâãÊõ∏„Åç„ÅØÈÄöÂ∏∏„Çà„Çä‰Ωé„ÅÑÈñæÂÄ§
                const value = gray > threshold ? 255 : 0;
                filtered[i] = filtered[i + 1] = filtered[i + 2] = value;
            }
            
            const processedImageData = new ImageData(filtered, newCanvas.width, newCanvas.height);
            ctx.putImageData(processedImageData, 0, 0);
            
            // 4. Êã°Â§ßÂá¶ÁêÜÔºàÊâãÊõ∏„Åç„ÅÆÁ¥∞„Åã„ÅÑÁâπÂæ¥„Çí‰øùÊåÅÔºâ
            const scaledCanvas = document.createElement('canvas');
            const scaledCtx = scaledCanvas.getContext('2d');
            scaledCanvas.width = newCanvas.width * 3;
            scaledCanvas.height = newCanvas.height * 3;
            
            scaledCtx.imageSmoothingEnabled = false; // ÊâãÊõ∏„Åç„ÅÆÁâπÂæ¥„Çí‰øùÊåÅ
            scaledCtx.drawImage(newCanvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
            
            return scaledCanvas;
        }
        
        // „Ç¨„Ç¶„Ç∑„Ç¢„É≥„Éï„Ç£„É´„ÇøÔºà„Éé„Ç§„Ç∫Èô§ÂéªÁî®Ôºâ
        function applyGaussianFilter(data, width, height) {
            const filtered = new Uint8ClampedArray(data.length);
            const kernel = [1, 2, 1, 2, 4, 2, 1, 2, 1]; // 3x3„Ç¨„Ç¶„Ç∑„Ç¢„É≥„Ç´„Éº„Éç„É´
            const kernelSum = 16;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    let sum = 0;
                    
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixelIdx = ((y + ky) * width + (x + kx)) * 4;
                            const kernelIdx = (ky + 1) * 3 + (kx + 1);
                            sum += data[pixelIdx] * kernel[kernelIdx];
                        }
                    }
                    
                    const filteredValue = sum / kernelSum;
                    filtered[idx] = filtered[idx + 1] = filtered[idx + 2] = filteredValue;
                    filtered[idx + 3] = 255; // Alpha
                }
            }
            
            return filtered;
        }
        
        // ÊâãÊõ∏„ÅçÊñáÂ≠óÂ∞ÇÁî®„Éù„Çπ„Éà„Éó„É≠„Çª„ÉÉ„Ç∑„É≥„Ç∞
        function postprocessHandwritingText(text) {
            let processed = text.trim();
            
            // ÊâãÊõ∏„ÅçÊñáÂ≠óÁâπÊúâ„ÅÆË™§Ë™çË≠ò„Éë„Çø„Éº„É≥„Çí‰øÆÊ≠£
            const handwritingCorrections = {
                // Êï∞Â≠ó„ÅÆË™§Ë™çË≠ò
                'o': '0', 'O': '0', '„Äá': '0', '‚óã': '0',
                'l': '1', 'I': '1', '|': '1', 'ÔΩú': '1',
                'Z': '2', 'z': '2', '„Ç¢': '2',
                '„Ç¥': '5', 'S': '5', 's': '5',
                'b': '6', 'G': '6', '„É≠': '6',
                'T': '7', '7': '7', 'Ôºü': '7',
                'B': '8', '8': '8', '„Åä': '8',
                'g': '9', 'q': '9', '„Çä': '9',
                
                // ÊõúÊó•„ÅÆË™§Ë™çË≠ò
                'ÁÅ´Êõú': 'ÁÅ´', 'Ê∞¥Êõú': 'Ê∞¥', 'Êú®Êõú': 'Êú®', 'ÈáëÊõú': 'Èáë', 'ÂúüÊõú': 'Âúü', 'Êó•Êõú': 'Êó•', 'ÊúàÊõú': 'Êúà',
                '„Å≤': 'ÁÅ´', '„Åø': 'Ê∞¥', '„Åç': 'Êú®', '„Åç„Çì': 'Èáë', '„Å©': 'Âúü', '„Å´„Å°': 'Êó•', '„Åí„Å§': 'Êúà',
                
                // Ë®òÂè∑„ÅÆË™§Ë™çË≠ò
                'Ôºö': ':', '„ÄÇ': ',', '„ÄÅ': ',', 'ÔΩû': '',
                'Ôºè': '/', 'Ôºº': '\\', 'Ôºª': '(', 'ÔºΩ': ')'
            };
            
            // Ë™§Ë™çË≠ò‰øÆÊ≠£„ÇíÈÅ©Áî®
            Object.keys(handwritingCorrections).forEach(wrong => {
                const regex = new RegExp(wrong, 'g');
                processed = processed.replace(regex, handwritingCorrections[wrong]);
            });
            
            // ÊâãÊõ∏„Åç„Éé„Ç§„Ç∫„ÅÆÈô§Âéª
            processed = processed
                .replace(/[^\dÊúàÊó•\(\)ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúüÊó•,:Ôºö„ÄÄ ]/g, '') // ÊúüÈôê„Å´ÂøÖË¶Å„Å™ÊñáÂ≠ó‰ª•Â§ñ„ÇíÈô§Âéª
                .replace(/\s+/g, ' ') // ÈÄ£Á∂öÁ©∫ÁôΩ„Çí1„Å§„Å´
                .trim();
            
            console.log('ÊâãÊõ∏„ÅçÊñáÂ≠ó„Éù„Çπ„Éà„Éó„É≠„Çª„ÉÉ„Ç∑„É≥„Ç∞:', processed);
            return processed;
        }
        
        // OCRË®≠ÂÆö„É™„Çª„ÉÉ„Éà
        function resetOCRSettings() {
            document.getElementById('ocr-enhance-contrast').checked = false;
            document.getElementById('ocr-upscale').checked = false;
            document.getElementById('ocr-grayscale').checked = false;
            document.getElementById('ocr-cleanup-symbols').checked = false;
            document.getElementById('ocr-handwriting-mode').checked = false;
            document.getElementById('ocr-complex-layout-mode').checked = false;
        }
        
        // Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCR„ÉÜ„Çπ„ÉàÈñ¢Êï∞
        async function testComplexLayoutOCR() {
            if (selectedAreas.length === 0) {
                alert('OCRÂØæË±°„ÅÆÈ†òÂüü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇË§áÈõë„É¨„Ç§„Ç¢„Ç¶„Éà„ÉÜ„Çπ„ÉàÁî®„ÅÆÈ†òÂüü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            console.log('=== Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCR„ÉÜ„Çπ„ÉàÈñãÂßã ===');
            
            for (let i = 0; i < selectedAreas.length; i++) {
                const area = selectedAreas[i];
                console.log(`\nüß© Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàÈ†òÂüü ${i + 1} „ÉÜ„Çπ„Éà:`);
                
                // È†òÂüü„ÇíÂàá„ÇäÊäú„Åç
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    // Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCRÂÆüË°å
                    const complexResult = await performComplexLayoutOCR(croppedCanvas);
                    console.log('üß© Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCRÁµêÊûú:', complexResult);
                    
                    // ÊØîËºÉÁî®„Å´ÈÄöÂ∏∏OCR„ÇÇÂÆüË°å
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('üìÑ ÈÄöÂ∏∏OCRÁµêÊûú:', normalText);
                    
                    // ÁµêÊûúÊØîËºÉ
                    console.log(`\nüìä ÁµêÊûúÊØîËºÉ:`);
                    console.log(`Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„Éà„É¢„Éº„Éâ: "${complexResult.text}" („Çø„Ç§„Éó: ${complexResult.type}, ‰ø°È†ºÂ∫¶: ${complexResult.confidence?.toFixed(1)}%)`);
                    console.log(`ÈÄöÂ∏∏„É¢„Éº„Éâ: "${normalText}"`);
                    
                    // ÊßãÈÄ†Ëß£ÊûêÁµêÊûúÔºà„ÇÇ„Åó„ÅÇ„Çå„Å∞Ôºâ
                    if (complexResult.structure) {
                        console.log('üìê ÊßãÈÄ†Ëß£Êûê:', complexResult.structure);
                    }
                    
                } catch (error) {
                    console.error('Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCR„Ç®„É©„Éº:', error);
                }
            }
            
            console.log('\n=== Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCR„ÉÜ„Çπ„ÉàÁµÇ‰∫Ü ===');
            alert('Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCR„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´ÔºàF12Ôºâ„ÅßË©≥Á¥∞„Å™ÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
        
        // ÊâãÊõ∏„ÅçOCR„ÉÜ„Çπ„ÉàÈñ¢Êï∞
        async function testHandwritingOCR() {
            const handwritingAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (handwritingAreas.length === 0) {
                alert('ÊúüÈôê„Çø„Ç∞„ÅåË®≠ÂÆö„Åï„Çå„ÅüÈ†òÂüü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊâãÊõ∏„Åç„ÉÜ„Çπ„ÉàÁî®„ÅÆÈ†òÂüü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            console.log('=== ÊâãÊõ∏„ÅçOCR„ÉÜ„Çπ„ÉàÈñãÂßã ===');
            
            for (let i = 0; i < handwritingAreas.length; i++) {
                const area = handwritingAreas[i];
                console.log(`\n‚úçÔ∏è ÊâãÊõ∏„ÅçÈ†òÂüü ${i + 1} „ÉÜ„Çπ„Éà:`);
                
                // È†òÂüü„ÇíÂàá„ÇäÊäú„Åç
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    // ÊâãÊõ∏„ÅçOCRÂÆüË°å
                    const handwritingResult = await performHandwritingOCR(croppedCanvas);
                    console.log('‚úçÔ∏è ÊâãÊõ∏„ÅçOCRÁµêÊûú:', handwritingResult.text);
                    console.log('üéØ ÊâãÊõ∏„ÅçOCR‰ø°È†ºÂ∫¶:', handwritingResult.confidence);
                    console.log('üìÖ ÊúüÈôêËß£ÊûêÁµêÊûú:', parseDeadlineText(handwritingResult.text));
                    
                    // ÊØîËºÉÁî®„Å´ÈÄöÂ∏∏OCR„ÇÇÂÆüË°å
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('üìÑ ÈÄöÂ∏∏OCRÁµêÊûú:', normalText);
                    console.log('üìÖ ÈÄöÂ∏∏OCRÊúüÈôêËß£Êûê:', parseDeadlineText(normalText));
                    
                    // Á≤æÂ∫¶ÊØîËºÉ
                    const handwritingSuccess = parseDeadlineText(handwritingResult.text) !== null;
                    const normalSuccess = parseDeadlineText(normalText) !== null;
                    
                    console.log(`\nüìä ÁµêÊûúÊØîËºÉ:`);
                    console.log(`ÊâãÊõ∏„Åç„É¢„Éº„Éâ: ${handwritingSuccess ? 'ÊàêÂäü ‚úÖ' : 'Â§±Êïó ‚ùå'} (‰ø°È†ºÂ∫¶: ${handwritingResult.confidence}%)`);
                    console.log(`ÈÄöÂ∏∏„É¢„Éº„Éâ: ${normalSuccess ? 'ÊàêÂäü ‚úÖ' : 'Â§±Êïó ‚ùå'}`);
                    
                } catch (error) {
                    console.error('ÊâãÊõ∏„ÅçOCR„Ç®„É©„Éº:', error);
                }
            }
            
            console.log('\n=== ÊâãÊõ∏„ÅçOCR„ÉÜ„Çπ„ÉàÁµÇ‰∫Ü ===');
            alert('ÊâãÊõ∏„ÅçOCR„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´ÔºàF12Ôºâ„ÅßË©≥Á¥∞„Å™ÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
        
        // Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàËß£ÊûêOCRÔºàË°®„ÉªÂõ≥ÂØæÂøúÔºâ
        async function performComplexLayoutOCR(canvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCRÈñãÂßã:', canvas.width, 'x', canvas.height);
                    
                    // „É¨„Ç§„Ç¢„Ç¶„ÉàËá™ÂãïÊ§úÂá∫
                    const layoutType = detectLayoutType(canvas);
                    console.log('Ê§úÂá∫„Åï„Çå„Åü„É¨„Ç§„Ç¢„Ç¶„Éà:', layoutType);
                    
                    let result;
                    switch (layoutType) {
                        case 'table':
                            result = await performTableOCR(canvas);
                            break;
                        case 'list':
                            result = await performListOCR(canvas);
                            break;
                        case 'form':
                            result = await performFormOCR(canvas);
                            break;
                        default:
                            result = await performAdvancedOCR(canvas);
                    }
                    
                    console.log('Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCRÁµêÊûú:', result);
                    resolve(result);
                    
                } catch (error) {
                    console.error('Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàOCR„Ç®„É©„Éº:', error);
                    reject(error);
                }
            });
        }
        
        // „É¨„Ç§„Ç¢„Ç¶„Éà„Çø„Ç§„ÉóËá™ÂãïÊ§úÂá∫
        function detectLayoutType(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Á∑ö„ÅÆÊ§úÂá∫ÔºàÁ∏¶Á∑ö„ÉªÊ®™Á∑ö„ÅÆÂ§ö„Åï„ÅßÂà§ÂÆöÔºâ
            let horizontalLines = 0;
            let verticalLines = 0;
            
            // Ê®™Á∑öÊ§úÂá∫
            for (let y = 0; y < canvas.height; y += 5) {
                let linePixels = 0;
                for (let x = 0; x < canvas.width; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    const gray = data[idx] * 0.299 + data[idx + 1] * 0.587 + data[idx + 2] * 0.114;
                    if (gray < 128) linePixels++;
                }
                if (linePixels > canvas.width * 0.7) horizontalLines++;
            }
            
            // Á∏¶Á∑öÊ§úÂá∫
            for (let x = 0; x < canvas.width; x += 5) {
                let linePixels = 0;
                for (let y = 0; y < canvas.height; y++) {
                    const idx = (y * canvas.width + x) * 4;
                    const gray = data[idx] * 0.299 + data[idx + 1] * 0.587 + data[idx + 2] * 0.114;
                    if (gray < 128) linePixels++;
                }
                if (linePixels > canvas.height * 0.7) verticalLines++;
            }
            
            console.log(`Á∑öÊ§úÂá∫ÁµêÊûú: Ê®™Á∑ö=${horizontalLines}, Á∏¶Á∑ö=${verticalLines}`);
            
            // „É¨„Ç§„Ç¢„Ç¶„ÉàÂà§ÂÆö
            if (horizontalLines >= 3 && verticalLines >= 2) {
                return 'table'; // Ë°®ÂΩ¢Âºè
            } else if (horizontalLines >= 3) {
                return 'list'; // „É™„Çπ„ÉàÂΩ¢Âºè
            } else if (verticalLines >= 2) {
                return 'form'; // „Éï„Ç©„Éº„É†ÂΩ¢Âºè
            } else {
                return 'mixed'; // Ê∑∑Âêà„É¨„Ç§„Ç¢„Ç¶„Éà
            }
        }
        
        // Ë°®ÂΩ¢ÂºèOCR
        async function performTableOCR(canvas) {
            console.log('Ë°®ÂΩ¢ÂºèOCRÂÆüË°å‰∏≠...');
            
            // „Çª„É´Âçò‰Ωç„Å´ÂàÜÂâ≤„Åó„Å¶OCRÂÆüË°å
            const cells = detectTableCells(canvas);
            const results = [];
            
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                const cellCanvas = extractCellCanvas(canvas, cell);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        cellCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                            tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ„ÅÇ-„Çñ„Ç¢-„É∂‰∏Ä-ÈæØ(),:ÔºöÊúàÊó•ÁÅ´Ê∞¥Êú®ÈáëÂúüÊó• „ÄÄ',
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        row: cell.row,
                        col: cell.col,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`„Çª„É´[${cell.row},${cell.col}]„ÅÆOCR„Ç®„É©„Éº:`, error);
                }
            }
            
            return formatTableResults(results);
        }
        
        // „É™„Çπ„ÉàÂΩ¢ÂºèOCR
        async function performListOCR(canvas) {
            console.log('„É™„Çπ„ÉàÂΩ¢ÂºèOCRÂÆüË°å‰∏≠...');
            
            // Ë°åÂçò‰Ωç„Å´ÂàÜÂâ≤
            const lines = detectListLines(canvas);
            const results = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lineCanvas = extractLineCanvas(canvas, line);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        lineCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        line: i + 1,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`Ë°å${i + 1}„ÅÆOCR„Ç®„É©„Éº:`, error);
                }
            }
            
            return formatListResults(results);
        }
        
        // „Éï„Ç©„Éº„É†ÂΩ¢ÂºèOCR
        async function performFormOCR(canvas) {
            console.log('„Éï„Ç©„Éº„É†ÂΩ¢ÂºèOCRÂÆüË°å‰∏≠...');
            
            // „Éï„Ç£„Éº„É´„ÉâÂçò‰Ωç„Å´ÂàÜÂâ≤
            const fields = detectFormFields(canvas);
            const results = [];
            
            for (let i = 0; i < fields.length; i++) {
                const field = fields[i];
                const fieldCanvas = extractFieldCanvas(canvas, field);
                
                try {
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        fieldCanvas,
                        'jpn+eng',
                        {
                            tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    results.push({
                        field: field.label || `„Éï„Ç£„Éº„É´„Éâ${i + 1}`,
                        text: text.trim(),
                        confidence: confidence
                    });
                } catch (error) {
                    console.error(`„Éï„Ç£„Éº„É´„Éâ${i + 1}„ÅÆOCR„Ç®„É©„Éº:`, error);
                }
            }
            
            return formatFormResults(results);
        }
        
        // È´òÂ∫¶OCRÔºàÊ∑∑Âêà„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ
        async function performAdvancedOCR(canvas) {
            console.log('È´òÂ∫¶OCRÂÆüË°å‰∏≠...');
            
            try {
                const { data: { text, confidence, lines, words } } = await Tesseract.recognize(
                    canvas,
                    'jpn+eng',
                    {
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                        tessedit_ocr_engine_mode: 3, // LSTM
                        preserve_interword_spaces: '1',
                        // Ë§áÈõë„É¨„Ç§„Ç¢„Ç¶„ÉàÁî®Ë®≠ÂÆö
                        textord_heavy_nr: '1',
                        textord_tabfind_show_vlines: '1',
                        textord_tablefind_good_width: '3',
                        textord_tablefind_good_height: '3'
                    }
                );
                
                return {
                    type: 'advanced',
                    text: text,
                    confidence: confidence,
                    structure: analyzeTextStructure(lines, words)
                };
            } catch (error) {
                console.error('È´òÂ∫¶OCR„Ç®„É©„Éº:', error);
                throw error;
            }
        }
        
        // Ë°®„Çª„É´Ê§úÂá∫ÔºàÁ∞°ÊòìÁâàÔºâ
        function detectTableCells(canvas) {
            // ÂÆüË£ÖÁ∞°Áï•Âåñ - ÂÆüÈöõ„ÅØÁîªÂÉèËß£Êûê„ÅßÁΩ´Á∑ö„ÇíÊ§úÂá∫
            const cells = [];
            const rows = 3, cols = 3; // ‰ªÆ„ÅÆ3x3Ë°®
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    cells.push({
                        row: r,
                        col: c,
                        x: (canvas.width / cols) * c,
                        y: (canvas.height / rows) * r,
                        width: canvas.width / cols,
                        height: canvas.height / rows
                    });
                }
            }
            
            return cells;
        }
        
        // „É™„Çπ„ÉàË°åÊ§úÂá∫
        function detectListLines(canvas) {
            const lines = [];
            const lineHeight = canvas.height / 5; // ‰ªÆ„Å´5Ë°å
            
            for (let i = 0; i < 5; i++) {
                lines.push({
                    x: 0,
                    y: lineHeight * i,
                    width: canvas.width,
                    height: lineHeight
                });
            }
            
            return lines;
        }
        
        // „Éï„Ç©„Éº„É†„Éï„Ç£„Éº„É´„ÉâÊ§úÂá∫
        function detectFormFields(canvas) {
            const fields = [];
            const fieldHeight = canvas.height / 3;
            
            for (let i = 0; i < 3; i++) {
                fields.push({
                    label: `„Éï„Ç£„Éº„É´„Éâ${i + 1}`,
                    x: 0,
                    y: fieldHeight * i,
                    width: canvas.width,
                    height: fieldHeight
                });
            }
            
            return fields;
        }
        
        // „Ç≠„É£„É≥„Éê„ÇπÊäΩÂá∫Èñ¢Êï∞Áæ§
        function extractCellCanvas(canvas, cell) {
            const cellCanvas = document.createElement('canvas');
            const ctx = cellCanvas.getContext('2d');
            cellCanvas.width = cell.width;
            cellCanvas.height = cell.height;
            ctx.drawImage(canvas, cell.x, cell.y, cell.width, cell.height, 0, 0, cell.width, cell.height);
            return cellCanvas;
        }
        
        function extractLineCanvas(canvas, line) {
            const lineCanvas = document.createElement('canvas');
            const ctx = lineCanvas.getContext('2d');
            lineCanvas.width = line.width;
            lineCanvas.height = line.height;
            ctx.drawImage(canvas, line.x, line.y, line.width, line.height, 0, 0, line.width, line.height);
            return lineCanvas;
        }
        
        function extractFieldCanvas(canvas, field) {
            const fieldCanvas = document.createElement('canvas');
            const ctx = fieldCanvas.getContext('2d');
            fieldCanvas.width = field.width;
            fieldCanvas.height = field.height;
            ctx.drawImage(canvas, field.x, field.y, field.width, field.height, 0, 0, field.width, field.height);
            return fieldCanvas;
        }
        
        // ÁµêÊûú„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞Áæ§
        function formatTableResults(results) {
            let formatted = '„ÄêË°®ÂΩ¢Âºè„Éá„Éº„Çø„Äë\n';
            const maxRow = Math.max(...results.map(r => r.row));
            const maxCol = Math.max(...results.map(r => r.col));
            
            for (let r = 0; r <= maxRow; r++) {
                const rowData = [];
                for (let c = 0; c <= maxCol; c++) {
                    const cell = results.find(result => result.row === r && result.col === c);
                    rowData.push(cell ? cell.text : '');
                }
                formatted += rowData.join(' | ') + '\n';
            }
            
            return { type: 'table', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        function formatListResults(results) {
            let formatted = '„Äê„É™„Çπ„ÉàÂΩ¢Âºè„Éá„Éº„Çø„Äë\n';
            results.forEach(result => {
                formatted += `‚Ä¢ ${result.text}\n`;
            });
            
            return { type: 'list', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        function formatFormResults(results) {
            let formatted = '„Äê„Éï„Ç©„Éº„É†ÂΩ¢Âºè„Éá„Éº„Çø„Äë\n';
            results.forEach(result => {
                formatted += `${result.field}: ${result.text}\n`;
            });
            
            return { type: 'form', text: formatted, confidence: results.reduce((sum, r) => sum + r.confidence, 0) / results.length };
        }
        
        // „ÉÜ„Ç≠„Çπ„ÉàÊßãÈÄ†Ëß£Êûê
        function analyzeTextStructure(lines, words) {
            return {
                lineCount: lines ? lines.length : 0,
                wordCount: words ? words.length : 0,
                avgConfidence: words ? words.reduce((sum, w) => sum + w.confidence, 0) / words.length : 0
            };
        }
        
        // ÊúüÈôêË©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞Ê©üËÉΩ
        async function deepDeadlineDebug() {
            const deadlineAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (deadlineAreas.length === 0) {
                alert('ÊúüÈôê„Çø„Ç∞„ÅåË®≠ÂÆö„Åï„Çå„ÅüÈ†òÂüü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúüÈôêÈ†òÂüü„ÇíÈÅ∏Êäû„Åó„Å¶„Éá„Éê„ÉÉ„Ç∞„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            console.log('üî¨=== ÊúüÈôêË©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞ÈñãÂßã ===');
            
            for (let i = 0; i < deadlineAreas.length; i++) {
                const area = deadlineAreas[i];
                console.log(`\nüéØ ÊúüÈôêÈ†òÂüü ${i + 1} Ë©≥Á¥∞Ëß£Êûê:`);
                
                // È†òÂüü„ÇíÂàá„ÇäÊäú„Åç
                const croppedCanvas = document.createElement('canvas');
                const ctx = croppedCanvas.getContext('2d');
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                const img = document.getElementById('selected-image');
                const scaleX = img.naturalWidth / img.width;
                const scaleY = img.naturalHeight / img.height;
                
                const realX = area.x * scaleX;
                const realY = area.y * scaleY;
                const realWidth = area.width * scaleX;
                const realHeight = area.height * scaleY;
                
                ctx.drawImage(img, realX, realY, realWidth, realHeight, 0, 0, area.width, area.height);
                
                try {
                    console.log('üìê È†òÂüüÊÉÖÂ†±:', { width: area.width, height: area.height, x: area.x, y: area.y });
                    
                    // 1. ÂÖ®Á®ÆÈ°û„ÅÆOCR„ÇíÂÆüË°å„Åó„Å¶ÊØîËºÉ
                    console.log('\nüîç ÂêÑÁ®ÆOCRÁµêÊûúÊØîËºÉ:');
                    
                    // ÈÄöÂ∏∏OCR
                    const normalResult = await performOCROnCanvas(croppedCanvas);
                    console.log('üìÑ ÈÄöÂ∏∏OCR:', normalResult);
                    console.log('üìÖ ÈÄöÂ∏∏OCRÊúüÈôêËß£Êûê:', parseDeadlineText(normalResult));
                    
                    // ÊúüÈôêÂ∞ÇÁî®OCR  
                    const deadlineResult = await performDeadlineOCR(croppedCanvas);
                    console.log('‚è∞ ÊúüÈôêÂ∞ÇÁî®OCR:', deadlineResult);
                    console.log('üìÖ ÊúüÈôêÂ∞ÇÁî®OCRÊúüÈôêËß£Êûê:', parseDeadlineText(deadlineResult));
                    
                    // ÊâãÊõ∏„ÅçOCR
                    try {
                        const handwritingResult = await performHandwritingOCR(croppedCanvas);
                        console.log('‚úçÔ∏è ÊâãÊõ∏„ÅçOCR:', handwritingResult.text, `(‰ø°È†ºÂ∫¶: ${handwritingResult.confidence}%)`);
                        console.log('üìÖ ÊâãÊõ∏„ÅçOCRÊúüÈôêËß£Êûê:', parseDeadlineText(handwritingResult.text));
                    } catch (error) {
                        console.log('‚úçÔ∏è ÊâãÊõ∏„ÅçOCR„Ç®„É©„Éº:', error.message);
                    }
                    
                    // 2. Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõ„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Éê„Ç§„Çπ„ÉÜ„ÉÉ„ÉóÁ¢∫Ë™ç
                    console.log('\nüîÑ Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõË©≥Á¥∞:');
                    console.log('ÁîüOCRÁµêÊûú:', normalResult);
                    const convertedText = convertToAbsoluteReference(normalResult);
                    console.log('Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõÂæå:', convertedText);
                    const parseResult = parseDeadlineText(normalResult);
                    console.log('ÊúÄÁµÇËß£ÊûêÁµêÊûú:', parseResult);
                    
                    // 3. ÁîªÂÉèËß£ÊûêÔºà„Ç≥„É≥„Éà„É©„Çπ„Éà„Éª„Éé„Ç§„Ç∫Áä∂Ê≥ÅÔºâ
                    console.log('\nüñºÔ∏è ÁîªÂÉèÂìÅË≥™Ëß£Êûê:');
                    const imageStats = analyzeImageQuality(croppedCanvas);
                    console.log('„Ç≥„É≥„Éà„É©„Çπ„Éà:', imageStats.contrast);
                    console.log('„Éé„Ç§„Ç∫„É¨„Éô„É´:', imageStats.noise);
                    console.log('ÊñáÂ≠óÂØÜÂ∫¶:', imageStats.textDensity);
                    
                    // 4. Êé®Â•®ÊîπÂñÑÊñπÊ≥ï
                    console.log('\nüí° Êé®Â•®ÊîπÂñÑÊñπÊ≥ï:');
                    const recommendations = getDeadlineRecommendations(normalResult, deadlineResult, imageStats);
                    recommendations.forEach(rec => console.log(`- ${rec}`));
                    
                } catch (error) {
                    console.error('ÊúüÈôêË©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞„Ç®„É©„Éº:', error);
                }
            }
            
            console.log('\nüî¨=== ÊúüÈôêË©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞ÁµÇ‰∫Ü ===');
            alert('ÊúüÈôêË©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´ÔºàF12Ôºâ„ÅßË©≥Á¥∞„Å™Ëß£ÊûêÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
        
        // ÁîªÂÉèÂìÅË≥™Ëß£Êûê
        function analyzeImageQuality(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let minBrightness = 255;
            let maxBrightness = 0;
            let totalBrightness = 0;
            let darkPixels = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                minBrightness = Math.min(minBrightness, brightness);
                maxBrightness = Math.max(maxBrightness, brightness);
                totalBrightness += brightness;
                
                if (brightness < 128) darkPixels++;
            }
            
            const totalPixels = data.length / 4;
            const avgBrightness = totalBrightness / totalPixels;
            const contrast = maxBrightness - minBrightness;
            const textDensity = darkPixels / totalPixels;
            
            // „Éé„Ç§„Ç∫„É¨„Éô„É´Êé®ÂÆöÔºàÈö£Êé•„Éî„ÇØ„Çª„É´Èñì„ÅÆÂ∑ÆÂàÜÔºâ
            let noiseSum = 0;
            let noiseCount = 0;
            for (let y = 1; y < canvas.height - 1; y++) {
                for (let x = 1; x < canvas.width - 1; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    const current = data[idx];
                    const right = data[idx + 4];
                    const bottom = data[idx + canvas.width * 4];
                    
                    noiseSum += Math.abs(current - right) + Math.abs(current - bottom);
                    noiseCount += 2;
                }
            }
            const noise = noiseSum / noiseCount;
            
            return {
                contrast: contrast,
                noise: noise,
                textDensity: textDensity,
                avgBrightness: avgBrightness
            };
        }
        
        // „Éá„Éê„ÉÉ„Ç∞ÁµêÊûú„Å´Âü∫„Å•„ÅèÊé®Â•®‰∫ãÈ†Ö
        function getDeadlineRecommendations(normalOCR, deadlineOCR, imageStats) {
            const recommendations = [];
            
            // OCRÁµêÊûúÂàÜÊûê
            if (!normalOCR || normalOCR.trim().length === 0) {
                recommendations.push('ÈÄöÂ∏∏OCR„ÅßÊñáÂ≠ó„ÅåË™çË≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç≥„É≥„Éà„É©„Çπ„ÉàÂº∑Âåñ„ÉªÊã°Â§ßÂá¶ÁêÜ„ÇíË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            if (!deadlineOCR || deadlineOCR.trim().length === 0) {
                recommendations.push('ÊúüÈôêÂ∞ÇÁî®OCR„Åß„ÇÇË™çË≠òÂ§±Êïó„ÄÇÊâãÊõ∏„Åç„É¢„Éº„Éâ„Åæ„Åü„ÅØË§áÈõë„É¨„Ç§„Ç¢„Ç¶„Éà„É¢„Éº„Éâ„ÇíË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            if (!parseDeadlineText(normalOCR) && !parseDeadlineText(deadlineOCR)) {
                recommendations.push('ÊúüÈôê„Éë„Çø„Éº„É≥„Å´„Éû„ÉÉ„ÉÅ„Åó„Åæ„Åõ„Çì„ÄÇ‰ª•‰∏ã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                recommendations.push('  - „Éï„Ç©„Éº„Éû„ÉÉ„Éà: mmÊúàddÊó•(ÊõúÊó•), hh:mm');
                recommendations.push('  - Âõ≤„ÅøÊï∞Â≠ó: ‚ë†‚ë°‚ë¢ ‚Üí 123 Â§âÊèõ„ÅåÂøÖË¶Å„Åã');
                recommendations.push('  - „Éé„Ç§„Ç∫: Êû†Á∑ö„ÇÑËÉåÊôØ„ÅåÊ∑∑ÂÖ•„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åã');
            }
            
            // ÁîªÂÉèÂìÅË≥™ÂàÜÊûê
            if (imageStats.contrast < 100) {
                recommendations.push('„Ç≥„É≥„Éà„É©„Çπ„Éà„Åå‰Ωé„ÅÑ„Åß„Åô„ÄÇ„Äå„Ç≥„É≥„Éà„É©„Çπ„ÉàÂº∑Âåñ„ÄçË®≠ÂÆö„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            if (imageStats.noise > 20) {
                recommendations.push('„Éé„Ç§„Ç∫„ÅåÂ§ö„ÅÑ„Åß„Åô„ÄÇ„Äå„Ç∞„É¨„Éº„Çπ„Ç±„Éº„É´Âåñ„ÄçË®≠ÂÆö„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            if (imageStats.textDensity < 0.1) {
                recommendations.push('ÊñáÂ≠óÂØÜÂ∫¶„Åå‰Ωé„ÅÑ„Åß„Åô„ÄÇÈ†òÂüüÈÅ∏Êäû„ÇíÊñáÂ≠óÈÉ®ÂàÜ„ÅÆ„Åø„Å´Áµû„Å£„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            if (imageStats.textDensity > 0.8) {
                recommendations.push('ËÉåÊôØ„ÅåÊöó„Åô„Åé„Åæ„Åô„ÄÇÈ†òÂüüÈÅ∏ÊäûÊôÇ„Å´‰ΩôÁôΩ„ÇÇÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            // ÂÖ∑‰ΩìÁöÑ„Å™ÂØæÂá¶Ê≥ï
            recommendations.push('„ÄêÊé®Â•®È†ÜÂ∫è„Äë');
            recommendations.push('1. È†òÂüüÈÅ∏Êäû„ÇíÊúüÈôêÊñáÂ≠óÈÉ®ÂàÜ„ÅÆ„Åø„Å´Ë™øÊï¥');
            recommendations.push('2. ÊâãÊõ∏„ÅçÊñáÂ≠ó„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ');
            recommendations.push('3. „Ç≥„É≥„Éà„É©„Çπ„ÉàÂº∑Âåñ + 2ÂÄçÊã°Â§ßÂá¶ÁêÜ„ÇíÊúâÂäπÂåñ');
            recommendations.push('4. „Åù„Çå„Åß„ÇÇÂ§±Êïó„Åô„ÇãÂ†¥Âêà„ÅØÁîªÂÉèËá™‰Ωì„ÅÆÊíÆÂΩ±„ÉªÂàá„ÇäÂèñ„Çä„ÇíË¶ãÁõ¥„Åó');
            
            return recommendations;
        }
        
        // ÊúüÈôêËß£Êûê„ÉÜ„Çπ„Éà
        function testDeadlineParsing() {
            const testTexts = [
                // Ê®ôÊ∫ñGoogleTODO„Éï„Ç©„Éº„Éû„ÉÉ„Éà
                '12Êúà15Êó•(Êúà), 14:30',
                '12Êúà15Êó•(Êúà)',
                '12Êúà15Êó•, 14:30',
                '12Êúà15Êó•',
                
                // Âõ≤„ÅøÊï∞Â≠ó„ÉÜ„Çπ„ÉàÔºàGoogleTODOÁâπÊúâÔºâ
                '‚ë¢Êúà‚ë°‚ë§Êó•(Êú®), ‚ë†‚ë£:‚ë¢‚ì™',
                '‚ë†‚ë°Êúà‚ë¢‚ì™Êó•(Èáë), ‚ë°‚ë¢:‚ë§‚ë®',
                '‚ë´Êúà„âõÊó•(Êó•), ‚ì™‚ë®:‚ë¢‚ì™',
                
                // ÂÖ®ËßíÊï∞Â≠ó„ÉÜ„Çπ„Éà
                'ÔºëÔºíÊúàÔºëÔºïÊó•(Êúà), ÔºëÔºî:ÔºìÔºê',
                'ÔºêÔºìÊúàÔºêÔºóÊó•(Ê∞¥)',
                
                // „Éé„Ç§„Ç∫Ê∑∑ÂÖ•„ÉÜ„Çπ„ÉàÔºàÊû†Á∑ö„ÉªË®òÂè∑Ôºâ
                '|12Êúà15Êó•(Êúà), 14:30|',
                '‚ñ°12Êúà15Êó•(Êúà)‚ñ†',
                'ÔΩû12Êúà15Êó•(Êúà), 14:30ÔΩû',
                '„Éé„Ç§„Ç∫ÔΩú12Êúà15Êó•(Êúà), 14:30ÔΩú„Éé„Ç§„Ç∫',
                
                // Ë§áÈõë„Å™„Éé„Ç§„Ç∫„Éë„Çø„Éº„É≥
                'ÔΩú‚ñ°‚ë¢Êúà‚ë°‚ë§Êó•(Êú®)‚ñ†ÔΩû, ‚ë†‚ë£:‚ë¢‚ì™ÔΩú',
                'Ë™çË≠ò„Ç®„É©„ÉºÔºëÔºíÊúàÔºëÔºïÊó•(ÊúàÊõúÊó•), ÔºëÔºî:ÔºìÔºêË™§Ë™çË≠ò',
                
                // „Ç®„É©„Éº„Éë„Çø„Éº„É≥
                '14:30', // ÊôÇÂàª„ÅÆ„Åø
                'ÁÑ°Âäπ„Å™ÊúüÈôê„ÉÜ„Ç≠„Çπ„Éà',
                ''
            ];
            
            console.log('=== GoogleTODOÊúüÈôêËß£Êûê„ÉÜ„Çπ„ÉàÈñãÂßã ===');
            testTexts.forEach((text, index) => {
                console.log(`\nüìù „ÉÜ„Çπ„Éà ${index + 1}: "${text}"`);
                
                // Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõ„ÅÆ„ÉÜ„Çπ„Éà
                const converted = convertToAbsoluteReference(text);
                console.log(`üîÑ Áµ∂ÂØæÂèÇÁÖßÂ§âÊèõ: "${converted}"`);
                
                // ÊúüÈôêËß£Êûê„ÅÆ„ÉÜ„Çπ„Éà
                const result = parseDeadlineText(text);
                console.log(`üìÖ Ëß£ÊûêÁµêÊûú: ${result}`);
                console.log(`‚úÖ ÊàêÂäü: ${result ? '‚óã' : '√ó'}`);
            });
            console.log('=== GoogleTODOÊúüÈôêËß£Êûê„ÉÜ„Çπ„ÉàÁµÇ‰∫Ü ===');
            
            alert('ÊúüÈôêËß£Êûê„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´ÔºàF12Ôºâ„ÅßÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
        
        // Áõ¥Êé•OCR„ÉÜ„Çπ„ÉàÔºàÈÅ∏Êäû„Åó„ÅüÊúüÈôêÈ†òÂüü„ÅßÔºâ
        async function testOCRDirectly() {
            const deadlineAreas = selectedAreas.filter(area => area.tag === 'deadline');
            if (deadlineAreas.length === 0) {
                alert('ÊúüÈôê„Çø„Ç∞„ÅåË®≠ÂÆö„Åï„Çå„ÅüÈ†òÂüü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            console.log('=== ÊúüÈôêÈ†òÂüüOCR„ÉÜ„Çπ„ÉàÈñãÂßã ===');
            
            for (let i = 0; i < deadlineAreas.length; i++) {
                const area = deadlineAreas[i];
                console.log(`\nÊúüÈôêÈ†òÂüü ${i + 1} „ÉÜ„Çπ„Éà:`);
                
                // È†òÂüü„ÇíÂàá„ÇäÊäú„Åç
                const croppedCanvas = document.createElement('canvas');
                const croppedCtx = croppedCanvas.getContext('2d');
                
                croppedCanvas.width = area.width;
                croppedCanvas.height = area.height;
                
                croppedCtx.drawImage(
                    currentImage,
                    area.x, area.y, area.width, area.height,
                    0, 0, area.width, area.height
                );
                
                try {
                    // ÊúüÈôêÁî®OCR
                    const deadlineText = await performDeadlineOCR(croppedCanvas);
                    console.log('ÊúüÈôêÁî®OCRÁµêÊûú:', deadlineText);
                    console.log('ÊúüÈôêËß£ÊûêÁµêÊûú:', parseDeadlineText(deadlineText));
                    
                    // ÈÄöÂ∏∏OCR
                    const normalText = await performOCROnCanvas(croppedCanvas);
                    console.log('ÈÄöÂ∏∏OCRÁµêÊûú:', normalText);
                    console.log('ÊúüÈôêËß£ÊûêÁµêÊûú:', parseDeadlineText(normalText));
                } catch (error) {
                    console.error('OCR„Ç®„É©„Éº:', error);
                }
            }
            
            console.log('\n=== ÊúüÈôêÈ†òÂüüOCR„ÉÜ„Çπ„ÉàÁµÇ‰∫Ü ===');
            alert('ÊúüÈôêÈ†òÂüü„ÅÆOCR„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´ÔºàF12Ôºâ„ÅßÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
        
        // Âá¶ÁêÜ„Éó„É¨„Éì„É•„ÉºÔºàÊúÄÂàù„ÅÆÈÅ∏ÊäûÈ†òÂüü„Åß„ÉÜ„Çπ„ÉàÔºâ
        function previewProcessing() {
            if (selectedAreas.length === 0) {
                alert('ÈÅ∏ÊäûÈ†òÂüü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÈ†òÂüü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const area = selectedAreas[0];
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            
            croppedCanvas.width = area.width;
            croppedCanvas.height = area.height;
            
            croppedCtx.imageSmoothingEnabled = false;
            croppedCtx.drawImage(
                currentImage,
                area.x, area.y, area.width, area.height,
                0, 0, area.width, area.height
            );
            
            // ÂâçÂá¶ÁêÜ„ÇíÈÅ©Áî®
            preprocessImage(croppedCanvas).then(processedCanvas => {
                // Êñ∞„Åó„ÅÑ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅßË°®Á§∫
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head><title>OCRÂâçÂá¶ÁêÜ„Éó„É¨„Éì„É•„Éº</title></head>
                        <body style="margin: 20px; font-family: Arial, sans-serif;">
                            <h3>ÂÖÉÁîªÂÉè vs Âá¶ÁêÜÂæå</h3>
                            <div style="display: flex; gap: 20px;">
                                <div>
                                    <h4>ÂÖÉÁîªÂÉè</h4>
                                    <canvas id="original" style="border: 1px solid #ccc;"></canvas>
                                </div>
                                <div>
                                    <h4>Âá¶ÁêÜÂæå</h4>
                                    <canvas id="processed" style="border: 1px solid #ccc;"></canvas>
                                </div>
                            </div>
                        </body>
                    </html>
                `);
                
                const originalCanvas = newWindow.document.getElementById('original');
                const processedCanvasElement = newWindow.document.getElementById('processed');
                
                // ÂÖÉÁîªÂÉè„ÇíË°®Á§∫
                originalCanvas.width = croppedCanvas.width;
                originalCanvas.height = croppedCanvas.height;
                const originalCtx = originalCanvas.getContext('2d');
                originalCtx.drawImage(croppedCanvas, 0, 0);
                
                // Âá¶ÁêÜÂæå„ÇíË°®Á§∫
                processedCanvasElement.width = processedCanvas.width;
                processedCanvasElement.height = processedCanvas.height;
                const processedCtx = processedCanvasElement.getContext('2d');
                processedCtx.drawImage(processedCanvas, 0, 0);
            });
        }
        
        // ÂàÜÊûê„Éª„É¨„Éù„Éº„ÉàÊ©üËÉΩ
        function showAnalytics() {
            const modal = document.getElementById('analyticsModal');
            modal.style.display = 'block';
            
            // „Éá„Éï„Ç©„É´„Éà„ÅØ‰ªäÈÄ±„ÅÆÁµ±Ë®à„Éá„Éº„Çø„ÇíË®àÁÆó
            calculateAnalytics('week');
            
            // „Ç∞„É©„Éï„ÇíÊèèÁîª
            drawCompletionChart();
            drawDeadlineChart();
            
            // ÊãÖÂΩìËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇíË°®Á§∫
            displayAssigneePerformance();
        }
        
        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }
        
        // ÊúüÈñìÈÅ∏Êäû„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜ
        function showAnalyticsForPeriod(period) {
            // „Åô„Åπ„Å¶„ÅÆ„Éú„Çø„É≥„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('#analyticsModal .period-btn').forEach(btn => {
                btn.style.background = '#e2e8f0';
                btn.style.color = '#333';
            });
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Éú„Çø„É≥„Å´active„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
            event.target.style.background = '#0052cc';
            event.target.style.color = 'white';
            
            // ÊúüÈñì„Å´Âøú„Åò„Å¶ÂàÜÊûê„ÇíÂÜçË®àÁÆó
            calculateAnalytics(period);
        }
        
        function calculateAnalytics(period = 'all') {
            // ÊúüÈñì„Éï„Ç£„É´„Çø„Éº
            let filteredTasks = tasks;
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            if (period === 'today') {
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfToday;
                    }
                    return false;
                });
            } else if (period === 'week') {
                const startOfWeek = new Date(startOfToday);
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfWeek;
                    }
                    return false;
                });
            } else if (period === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredTasks = tasks.filter(task => {
                    if (task.createdAt) {
                        const createdDate = new Date(task.createdAt);
                        return createdDate >= startOfMonth;
                    }
                    return false;
                });
            }
            
            // Á∑è„Çø„Çπ„ÇØÊï∞
            const totalTasks = filteredTasks.length;
            document.getElementById('total-tasks').textContent = totalTasks;
            
            // ÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞„Å®ÂÆå‰∫ÜÁéá
            const completedTasks = filteredTasks.filter(task => task.columnId === 'done').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('completion-rate').textContent = completionRate + '%';
            
            // ÊúüÈôêÈÅµÂÆàÁéá„ÇíË®àÁÆóÔºà„Éï„Ç£„É´„Çø„ÉºÊ∏à„Åø„Çø„Çπ„ÇØ„ÅÆ„ÅÜ„Å°„ÄÅÊúüÈôêÂÜÖ„Å´ÂÆå‰∫Ü„Åó„Åü„Çø„Çπ„ÇØ„ÅÆÂâ≤ÂêàÔºâ
            const completedOnTime = filteredTasks.filter(task => {
                if (task.columnId === 'done' && task.deadline && task.completedAt) {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }
                return false;
            }).length;
            
            const deadlineCompliance = totalTasks > 0 
                ? Math.round((completedOnTime / totalTasks) * 100) 
                : 100;
                
            console.log(`üìä [COMPLIANCE] Period: ${period}, Total tasks: ${totalTasks}`);
            console.log(`üìä [COMPLIANCE] Completed on time: ${completedOnTime}`);
            console.log(`üìä [COMPLIANCE] Compliance rate: ${deadlineCompliance}%`);
            
            document.getElementById('deadline-compliance').textContent = deadlineCompliance + '%';
            
            // Âπ≥ÂùáÂÆå‰∫ÜÊôÇÈñì„ÇíË®àÁÆó
            const completedWithTime = tasks.filter(task => 
                task.columnId === 'done' && task.createdAt && task.completedAt
            );
            
            if (completedWithTime.length > 0) {
                const totalTime = completedWithTime.reduce((sum, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created);
                }, 0);
                
                const avgTime = totalTime / completedWithTime.length;
                const days = Math.floor(avgTime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((avgTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                document.getElementById('avg-completion-time').textContent = 
                    days > 0 ? `${days}Êó•${hours}ÊôÇÈñì` : `${hours}ÊôÇÈñì`;
            } else {
                document.getElementById('avg-completion-time').textContent = '-';
            }
        }
        
        function drawCompletionChart() {
            const chartContainer = document.getElementById('completion-chart');
            
            // „Ç´„É©„É†Âà•„Çø„Çπ„ÇØÊï∞„ÇíÈõÜË®à
            const columnCounts = {};
            columns.forEach(column => {
                columnCounts[column.id] = tasks.filter(task => task.columnId === column.id).length;
            });
            
            // ÊúÄÂ§ßÂÄ§„ÇíÊ±Ç„ÇÅ„Çã
            const maxCount = Math.max(...Object.values(columnCounts), 1);
            
            // Ê£í„Ç∞„É©„Éï„ÇíHTML„Åß‰ΩúÊàê
            let chartHTML = '<div style="display: flex; height: 100%; align-items: flex-end; justify-content: space-around; padding: 1rem;">';
            
            columns.forEach(column => {
                const count = columnCounts[column.id];
                const percentage = (count / maxCount) * 100;
                
                chartHTML += `
                    <div style="flex: 1; text-align: center; margin: 0 0.5rem;">
                        <div style="position: relative; height: 150px; display: flex; align-items: flex-end;">
                            <div style="background: ${column.color}; width: 100%; height: ${percentage}%; border-radius: 4px 4px 0 0; position: relative;">
                                <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-weight: bold; color: #333;">
                                    ${count}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            ${column.title.replace(/[^\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\w\s]/g, '')}
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        function drawDeadlineChart() {
            const chartContainer = document.getElementById('deadline-chart');
            
            // ÊúüÈôêÁä∂Ê≥Å„ÇíÈõÜË®àÔºàDone„Ç´„É©„É†„ÇíÈô§„ÅèÔºâ
            const activeTasks = tasks.filter(task => task.columnId !== 'done');
            const now = new Date();
            
            const deadlineStatus = {
                overdue: 0,
                today: 0,
                thisWeek: 0,
                later: 0,
                noDeadline: 0
            };
            
            activeTasks.forEach(task => {
                if (!task.deadline) {
                    deadlineStatus.noDeadline++;
                    return;
                }
                
                const deadline = new Date(task.deadline);
                const daysUntil = Math.floor((deadline - now) / (1000 * 60 * 60 * 24));
                
                if (deadline < now) {
                    deadlineStatus.overdue++;
                } else if (daysUntil === 0) {
                    deadlineStatus.today++;
                } else if (daysUntil <= 7) {
                    deadlineStatus.thisWeek++;
                } else {
                    deadlineStatus.later++;
                }
            });
            
            // ÂÜÜ„Ç∞„É©„ÉïÈ¢®„ÅÆË°®Á§∫„Çí‰ΩúÊàê
            const total = activeTasks.length || 1;
            const statusConfig = [
                { key: 'overdue', label: 'ÊúüÈôêÂàá„Çå', color: '#e53e3e' },
                { key: 'today', label: '‰ªäÊó•', color: '#d69e2e' },
                { key: 'thisWeek', label: '‰ªäÈÄ±', color: '#3182ce' },
                { key: 'later', label: '„Åù„Çå‰ª•Èôç', color: '#38a169' },
                { key: 'noDeadline', label: 'ÊúüÈôê„Å™„Åó', color: '#a0aec0' }
            ];
            
            let chartHTML = '<div style="display: flex; flex-direction: column; height: 100%; padding: 1rem;">';
            
            statusConfig.forEach(config => {
                const count = deadlineStatus[config.key];
                const percentage = Math.round((count / total) * 100);
                
                if (count > 0) {
                    chartHTML += `
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.9rem; color: #666;">${config.label}</span>
                                <span style="font-size: 0.9rem; font-weight: bold;">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: ${config.color}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        function displayAssigneePerformance() {
            const performanceContainer = document.getElementById('assignee-performance');
            
            // ÊãÖÂΩìËÄÖÂà•„ÅÆÁµ±Ë®à„ÇíÈõÜË®à
            const assigneeStats = {};
            
            assignees.forEach(assignee => {
                const assigneeTasks = tasks.filter(task => task.assignee === assignee);
                const completed = assigneeTasks.filter(task => task.columnId === 'done').length;
                const total = assigneeTasks.length;
                
                // ÊúüÈôêÈÅµÂÆàÁéá
                const completedWithDeadline = assigneeTasks.filter(task => 
                    task.columnId === 'done' && task.deadline && task.completedAt
                );
                const onTime = completedWithDeadline.filter(task => {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }).length;
                
                assigneeStats[assignee] = {
                    total: total,
                    completed: completed,
                    completionRate: total > 0 ? Math.round((completed / total) * 100) : 0,
                    onTimeRate: completedWithDeadline.length > 0 
                        ? Math.round((onTime / completedWithDeadline.length) * 100) 
                        : 100
                };
            });
            
            // „ÉÜ„Éº„Éñ„É´ÂΩ¢Âºè„ÅßË°®Á§∫
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 0.75rem; text-align: left;">ÊãÖÂΩìËÄÖ</th>
                            <th style="padding: 0.75rem; text-align: center;">Á∑è„Çø„Çπ„ÇØ</th>
                            <th style="padding: 0.75rem; text-align: center;">ÂÆå‰∫Ü</th>
                            <th style="padding: 0.75rem; text-align: center;">ÂÆå‰∫ÜÁéá</th>
                            <th style="padding: 0.75rem; text-align: center;">ÊúüÈôêÈÅµÂÆàÁéá</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(assigneeStats).forEach(([assignee, stats]) => {
                if (stats.total > 0) {
                    tableHTML += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 0.75rem; font-weight: 500;">${assignee}</td>
                            <td style="padding: 0.75rem; text-align: center;">${stats.total}</td>
                            <td style="padding: 0.75rem; text-align: center;">${stats.completed}</td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span style="color: ${stats.completionRate >= 80 ? '#38a169' : stats.completionRate >= 50 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${stats.completionRate}%
                                </span>
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span style="color: ${stats.onTimeRate >= 90 ? '#38a169' : stats.onTimeRate >= 70 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${stats.onTimeRate}%
                                </span>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            performanceContainer.innerHTML = tableHTML;
        }
        
        // ÂàÜÊûê„Çµ„Éû„É™„ÉºÊõ¥Êñ∞
        function updateAnalyticsSummary() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.columnId === 'done').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // ÊúüÈôêÈÅµÂÆàÁéáÔºàÂÖ®„Çø„Çπ„ÇØ„ÅÆ„ÅÜ„Å°ÊúüÈôêÂÜÖ„Å´ÂÆå‰∫Ü„Åó„Åü„Çø„Çπ„ÇØ„ÅÆÂâ≤ÂêàÔºâ
            const completedOnTime = tasks.filter(task => {
                if (task.columnId === 'done' && task.deadline && task.completedAt) {
                    const deadline = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadline;
                }
                return false;
            }).length;
            
            const deadlineCompliance = totalTasks > 0 
                ? Math.round((completedOnTime / totalTasks) * 100) 
                : 100;
            
            // Âπ≥ÂùáÂÆå‰∫ÜÊôÇÈñì
            const completedWithTime = tasks.filter(task => 
                task.columnId === 'done' && task.createdAt && task.completedAt
            );
            let avgTimeText = '-';
            if (completedWithTime.length > 0) {
                const totalTime = completedWithTime.reduce((sum, task) => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created);
                }, 0);
                const avgTime = totalTime / completedWithTime.length;
                const days = Math.floor(avgTime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((avgTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                avgTimeText = days > 0 ? `${days}Êó•${hours}h` : `${hours}h`;
            }
            
            // Ë°®Á§∫Êõ¥Êñ∞
            document.getElementById('summary-completion-rate').textContent = completionRate + '%';
            document.getElementById('summary-deadline-compliance').textContent = deadlineCompliance + '%';
            document.getElementById('summary-avg-time').textContent = avgTimeText;
        }
        
        // ÊúüÈñì„É¨„Éù„Éº„ÉàÊ©üËÉΩ
        function showPeriodReport(period) {
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const now = new Date();
            let startDate, endDate, periodName;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    periodName = '‰ªäÊó•';
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    startDate = weekStart;
                    endDate = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
                    periodName = '‰ªäÈÄ±';
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    periodName = '‰ªäÊúà';
                    break;
            }
            
            // ÊúüÈñìÂÜÖ„ÅÆ„Çø„Çπ„ÇØ„ÇíÊäΩÂá∫
            const periodTasks = tasks.filter(task => {
                if (!task.createdAt) return false;
                const createdDate = new Date(task.createdAt);
                return createdDate >= startDate && createdDate < endDate;
            });
            
            const completedInPeriod = periodTasks.filter(task => {
                if (task.columnId !== 'done' || !task.completedAt) return false;
                const completedDate = new Date(task.completedAt);
                return completedDate >= startDate && completedDate < endDate;
            });
            
            // ÊúüÈôêÈÅµÂÆàÔºàÊúüÈñìÂÜÖ„Å´ÂÆå‰∫Ü„Åó„Åü„Çø„Çπ„ÇØ„ÅÆ„ÅÜ„Å°Ôºâ
            const onTimeInPeriod = completedInPeriod.filter(task => {
                if (!task.deadline) return true;
                const deadline = new Date(task.deadline);
                const completed = new Date(task.completedAt);
                return completed <= deadline;
            });
            
            // „É¨„Éù„Éº„ÉàË°®Á§∫
            const modalId = 'period-report-' + Date.now();
            const reportHTML = `
                <div id="${modalId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) document.getElementById('${modalId}').remove()">
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748;">üìä ${periodName}„ÅÆ„É¨„Éù„Éº„Éà</h3>
                            <button onclick="document.getElementById('${modalId}').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #a0aec0; padding: 0.5rem; z-index: 2001; position: relative;">&times;</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${periodTasks.length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">‰ΩúÊàê„Çø„Çπ„ÇØ</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${completedInPeriod.length}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); color: #2d3748; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;">${periodTasks.length > 0 ? Math.round((completedInPeriod.length / periodTasks.length) * 100) : 0}%</div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">ÂÆå‰∫ÜÁéá</div>
                            </div>
                        </div>
                        
                        <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #2d3748;">ÊúüÈôêÈÅµÂÆàÁä∂Ê≥Å</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ÊúüÈôêÂÜÖÂÆå‰∫Ü: ${onTimeInPeriod.length}‰ª∂</span>
                                <span>ÈÅµÂÆàÁéá: ${completedInPeriod.length > 0 ? Math.round((onTimeInPeriod.length / completedInPeriod.length) * 100) : 100}%</span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                                <div style="background: #38a169; height: 100%; width: ${completedInPeriod.length > 0 ? (onTimeInPeriod.length / completedInPeriod.length) * 100 : 100}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; color: #718096; font-size: 0.9rem;">
                            ÊúüÈñì: ${startDate.toLocaleDateString()} „Äú ${endDate.toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reportHTML);
        }
        
        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜÊ©üËÉΩ
        function showCreateTemplateModal() {
            // „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            const columnSelect = document.getElementById('template-column');
            if (columnSelect) {
                columnSelect.innerHTML = '';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    columnSelect.appendChild(option);
                });
            }
            
            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
            const assigneesContainer = document.getElementById('template-assignees');
            assigneesContainer.innerHTML = '';
            assignees.forEach(assignee => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.9rem;';
                label.innerHTML = `
                    <input type="checkbox" value="${assignee}" style="margin: 0;">
                    <span>${assignee}</span>
                `;
                assigneesContainer.appendChild(label);
            });
            
            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const templateModal = document.getElementById('templateModal');
            templateModal.style.display = 'flex';
        }
        
        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('template-name').value = '';
            document.getElementById('template-task-title').value = '';
            document.getElementById('template-memo').value = '';
            document.getElementById('template-category').value = 'Âñ∂Ê•≠';
            document.getElementById('template-priority').value = 'medium';
            
            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„É™„Çª„ÉÉ„Éà
            const checkboxes = document.querySelectorAll('#template-assignees input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('template-modal-title').textContent = 'üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê';
            document.getElementById('save-template-btn').textContent = '‰øùÂ≠ò';
            editingTemplateId = null;
        }
        
        async function saveTemplate(event) {
            event.preventDefault();
            
            const name = document.getElementById('template-name').value.trim();
            const category = document.getElementById('template-category').value;
            const taskTitle = document.getElementById('template-task-title').value.trim();
            const priority = document.getElementById('template-priority').value;
            const columnId = document.getElementById('template-column').value;
            const memo = document.getElementById('template-memo').value.trim();
            
            // ÈÅ∏Êäû„Åï„Çå„ÅüÊãÖÂΩìËÄÖ„ÇíÂèñÂæó
            const selectedAssignees = Array.from(document.querySelectorAll('#template-assignees input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (!name || !taskTitle) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„Å®„Çø„Çπ„ÇØÂêç„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }
            
            try {
                if (editingTemplateId) {
                    // Á∑®ÈõÜ„É¢„Éº„Éâ - FirebaseÁµ±Âêà
                    const templateData = {
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo
                    };
                    
                    // FirebaseÊõ¥Êñ∞
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('üî• [TEMPLATE] Firebase„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞‰∏≠...', name);
                        const result = await window.FirebaseDB.updateTemplate(editingTemplateId, templateData);
                        
                        if (result.success) {
                            console.log('‚úÖ [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞ÊàêÂäü:', editingTemplateId);
                            
                            // „É≠„Éº„Ç´„É´ÈÖçÂàó„ÇÇÊõ¥Êñ∞
                            const templateIndex = taskTemplates.findIndex(t => t.id === editingTemplateId);
                            if (templateIndex !== -1) {
                                taskTemplates[templateIndex] = {
                                    ...taskTemplates[templateIndex],
                                    ...templateData,
                                    updatedAt: new Date().toISOString()
                                };
                            }
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                        } else {
                            console.error('‚ùå [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', result.error);
                            alert(`„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        const templateIndex = taskTemplates.findIndex(t => t.id === editingTemplateId);
                        if (templateIndex !== -1) {
                            taskTemplates[templateIndex] = {
                                ...taskTemplates[templateIndex],
                                ...templateData,
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅÔºàLocalStorageÔºâ');
                        }
                    }
                } else {
                    // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ - FirebaseÁµ±Âêà
                    const templateData = {
                        id: Date.now(),
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Firebase‰ΩúÊàê
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('üî• [TEMPLATE] Firebase„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê‰∏≠...', name);
                        const result = await window.FirebaseDB.createTemplate(templateData);
                        
                        if (result.success) {
                            console.log('‚úÖ [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàêÊàêÂäü:', result.id);
                            
                            // Firebase ID„ÇíË®≠ÂÆö„Åó„Å¶„É≠„Éº„Ç´„É´ÈÖçÂàó„Å´ËøΩÂä†
                            templateData.id = result.id;
                            taskTemplates.push(templateData);
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                        } else {
                            console.error('‚ùå [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Ç®„É©„Éº:', result.error);
                            alert(`„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Ç®„É©„Éº: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        taskTemplates.push(templateData);
                        localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                        alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅÔºàLocalStorageÔºâ');
                    }
                }
                
                // LocalStorage„Å´„ÇÇ‰øùÂ≠òÔºàÂêåÊúüÁî®Ôºâ
                localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                
                // „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                loadTemplateList();
                
                closeTemplateModal();
                
            } catch (error) {
                console.error('‚ùå [TEMPLATE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert(`„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
            }
        }
        
        function loadTemplateList() {
            const container = document.getElementById('template-list');
            
            // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàÂà•„ÅÆ„É¢„Éº„ÉÄ„É´ÁîªÈù¢„Å™„Å©Ôºâ
            if (!container) {
                // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÊ≠£Â∏∏ - Ë≠¶Âëä„Å™„Åó„Åß„Çπ„Ç≠„ÉÉ„Éó
                return;
            }
            
            if (taskTemplates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                if (!groupedTemplates[template.category]) {
                    groupedTemplates[template.category] = [];
                }
                groupedTemplates[template.category].push(template);
            });
            
            let html = '';
            Object.keys(groupedTemplates).forEach(category => {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e9ecef; padding-bottom: 0.25rem;">${category}</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem;">
                `;
                
                groupedTemplates[category].forEach(template => {
                    html += `
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; width: 220px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <h6 style="margin: 0; font-size: 1rem; font-weight: 600; color: #172b4d; line-height: 1.2;">${template.name}</h6>
                                <div style="display: flex; gap: 0.25rem;">
                                    <button onclick="editTemplate(${template.id})" style="background: none; border: none; color: #6c757d; cursor: pointer; font-size: 0.9rem; padding: 0.2rem;" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                                    <button onclick="deleteTemplate(${template.id})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1rem; padding: 0.2rem;" title="ÂâäÈô§">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.75rem; line-height: 1.3;">${template.taskTitle}</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0.75rem;">
                                <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">${template.priority === 'high' ? 'üî¥ ÊúÄÈáçË¶Å' : template.priority === 'medium' ? 'üü° ÈáçË¶Å' : 'üü¢ ÈÄöÂ∏∏'}</span>
                                <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">${columns.find(c => c.id === template.columnId)?.title || template.columnId}</span>
                            </div>
                            <button onclick="applyTemplate(${template.id})" style="width: 100%; padding: 0.6rem; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                ‚ö° ÈÅ©Áî®
                            </button>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }
        
        function editTemplate(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíË®≠ÂÆö
            editingTemplateId = templateId;
            document.getElementById('template-modal-title').textContent = '‚úèÔ∏è „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ';
            document.getElementById('save-template-btn').textContent = 'Êõ¥Êñ∞';
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            showCreateTemplateModal();
            
            // „Éï„Ç©„Éº„É†„Å´„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂÄ§„ÇíË®≠ÂÆö
            setTimeout(() => {
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-category').value = template.category;
                document.getElementById('template-task-title').value = template.taskTitle;
                document.getElementById('template-priority').value = template.priority;
                document.getElementById('template-column').value = template.columnId;
                document.getElementById('template-memo').value = template.memo || '';
                
                // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíË®≠ÂÆö
                const checkboxes = document.querySelectorAll('#template-assignees input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = template.assignees && template.assignees.includes(cb.value);
                });
            }, 100);
        }
        
        function deleteTemplate(templateId) {
            if (!confirm('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            taskTemplates = taskTemplates.filter(t => t.id !== templateId);
            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
            loadTemplateList();
        }
        
        function applyTemplate(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // Êñ∞Ë¶è„Çø„Çπ„ÇØ‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅÑ„Å¶„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂÄ§„ÇíÈÅ©Áî®
            createTaskUnified();
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂÄ§„ÇíË®≠ÂÆö
            setTimeout(() => {
                document.getElementById('task-title-input').value = template.taskTitle;
                document.getElementById('task-priority-input').value = template.priority;
                document.getElementById('task-column-input').value = template.columnId;
                document.getElementById('task-memo-input').value = template.memo || '';
                
                // ÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö
                if (template.assignees && template.assignees.length > 0) {
                    setSelectedAssignees(template.assignees);
                }
            }, 100);
            
            // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSettingsModal();
        }
        
        // ============ „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´Èñ¢Êï∞Áæ§ ============
        let currentEditingTemplateId = null;
        
        function openTemplateManagementModal() {
            document.getElementById('templateManagementModal').style.display = 'flex';
            loadTemplateManagementList();
            showTemplateWelcomeScreen();
        }
        
        function closeTemplateManagementModal() {
            document.getElementById('templateManagementModal').style.display = 'none';
            currentEditingTemplateId = null;
            showTemplateWelcomeScreen();
        }
        
        function showTemplateWelcomeScreen() {
            document.getElementById('template-welcome-screen').style.display = 'flex';
            document.getElementById('template-form-container').style.display = 'none';
            currentEditingTemplateId = null;
        }
        
        function showTemplateCreateForm() {
            document.getElementById('template-welcome-screen').style.display = 'none';
            document.getElementById('template-form-container').style.display = 'flex';
            
            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('template-management-form').reset();
            document.getElementById('mgmt-save-template-btn').textContent = 'üíæ ‰øùÂ≠ò';
            document.getElementById('mgmt-delete-template-btn').style.display = 'none';
            currentEditingTemplateId = null;
            
            // „Ç´„É©„É†„Å®ÊãÖÂΩìËÄÖ„ÇíÊõ¥Êñ∞
            updateTemplateManagementFormOptions();
        }
        
        function loadTemplateManagementList() {
            const container = document.getElementById('template-management-list');
            
            if (taskTemplates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
                        <p>„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">„ÄåÊñ∞Ë¶è„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Äç„Åß<br>ÊúÄÂàù„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ</p>
                    </div>
                `;
                return;
            }
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                const category = template.category || '„Åù„ÅÆ‰ªñ';
                if (!groupedTemplates[category]) {
                    groupedTemplates[category] = [];
                }
                groupedTemplates[category].push(template);
            });
            
            let html = '';
            Object.keys(groupedTemplates).forEach(category => {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #374151; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">${category}</h5>
                `;
                
                groupedTemplates[category].forEach(template => {
                    const isSelected = currentEditingTemplateId === template.id;
                    html += `
                        <div onclick="selectTemplateInManagement(${template.id})" 
                             style="background: ${isSelected ? '#eff6ff' : 'white'}; 
                                    border: 1px solid ${isSelected ? '#3b82f6' : '#e5e7eb'}; 
                                    border-radius: 8px; 
                                    padding: 0.75rem; 
                                    margin-bottom: 0.5rem; 
                                    cursor: pointer; 
                                    transition: all 0.2s;"
                             onmouseover="if(!${isSelected}) { this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'; }"
                             onmouseout="if(!${isSelected}) { this.style.background='white'; this.style.borderColor='#e5e7eb'; }">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${template.name}</div>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">${template.taskTitle}</div>
                            <div style="display: flex; gap: 0.25rem;">
                                <span style="background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 12px; font-size: 0.7rem; color: #374151;">
                                    ${template.priority === 'high' ? 'üî¥' : template.priority === 'medium' ? 'üü°' : 'üü¢'} ${template.priority === 'high' ? 'ÊúÄÈáçË¶Å' : template.priority === 'medium' ? 'ÈáçË¶Å' : 'ÈÄöÂ∏∏'}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function selectTemplateInManagement(templateId) {
            const template = taskTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            currentEditingTemplateId = templateId;
            
            // „Éï„Ç©„Éº„É†„ÇíË°®Á§∫
            document.getElementById('template-welcome-screen').style.display = 'none';
            document.getElementById('template-form-container').style.display = 'flex';
            
            // „Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('mgmt-template-name').value = template.name;
            document.getElementById('mgmt-template-category').value = template.category;
            document.getElementById('mgmt-template-task-title').value = template.taskTitle;
            document.getElementById('mgmt-template-priority').value = template.priority;
            document.getElementById('mgmt-template-column').value = template.columnId;
            document.getElementById('mgmt-template-memo').value = template.memo || '';
            
            // „Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            document.getElementById('mgmt-save-template-btn').textContent = 'üíæ Êõ¥Êñ∞';
            document.getElementById('mgmt-delete-template-btn').style.display = 'block';
            
            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
            updateTemplateManagementFormOptions();
            setTimeout(() => {
                const checkboxes = document.querySelectorAll('#mgmt-template-assignees input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = template.assignees && template.assignees.includes(cb.value);
                });
            }, 100);
            
            // ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞ÔºàÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂèçÊò†Ôºâ
            loadTemplateManagementList();
        }
        
        function updateTemplateManagementFormOptions() {
            // „Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
            const columnSelect = document.getElementById('mgmt-template-column');
            columnSelect.innerHTML = '';
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.title;
                columnSelect.appendChild(option);
            });
            
            // ÊãÖÂΩìËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
            const assigneesContainer = document.getElementById('mgmt-template-assignees');
            assigneesContainer.innerHTML = '';
            assignees.forEach(assignee => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.5rem; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-size: 0.9rem;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = assignee;
                checkbox.name = 'mgmt-assignees';
                
                const span = document.createElement('span');
                span.textContent = assignee;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                assigneesContainer.appendChild(label);
                
                // „Éõ„Éê„ÉºÂäπÊûú
                label.addEventListener('mouseenter', () => {
                    label.style.background = '#f3f4f6';
                });
                label.addEventListener('mouseleave', () => {
                    label.style.background = 'white';
                });
            });
        }
        
        async function saveTemplateFromManagement(event) {
            event.preventDefault();
            
            const name = document.getElementById('mgmt-template-name').value.trim();
            const category = document.getElementById('mgmt-template-category').value;
            const taskTitle = document.getElementById('mgmt-template-task-title').value.trim();
            const priority = document.getElementById('mgmt-template-priority').value;
            const columnId = document.getElementById('mgmt-template-column').value;
            const memo = document.getElementById('mgmt-template-memo').value.trim();
            
            // ÈÅ∏Êäû„Åï„Çå„ÅüÊãÖÂΩìËÄÖ„ÇíÂèñÂæó
            const selectedAssignees = Array.from(document.querySelectorAll('#mgmt-template-assignees input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (!name || !taskTitle) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„Å®„Çø„Çπ„ÇØÂêç„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }
            
            try {
                if (currentEditingTemplateId) {
                    // Êõ¥Êñ∞„É¢„Éº„Éâ - FirebaseÁµ±Âêà
                    const templateData = {
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo
                    };
                    
                    // FirebaseÊõ¥Êñ∞
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('üî• [TEMPLATE-MGMT] Firebase„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞‰∏≠...', name);
                        const result = await window.FirebaseDB.updateTemplate(currentEditingTemplateId, templateData);
                        
                        if (result.success) {
                            console.log('‚úÖ [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞ÊàêÂäü:', currentEditingTemplateId);
                            
                            // „É≠„Éº„Ç´„É´ÈÖçÂàó„ÇÇÊõ¥Êñ∞
                            const index = taskTemplates.findIndex(t => t.id === currentEditingTemplateId);
                            if (index !== -1) {
                                taskTemplates[index] = {
                                    ...taskTemplates[index],
                                    ...templateData,
                                    updatedAt: new Date().toISOString()
                                };
                            }
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                        } else {
                            console.error('‚ùå [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', result.error);
                            alert(`„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        const index = taskTemplates.findIndex(t => t.id === currentEditingTemplateId);
                        if (index !== -1) {
                            taskTemplates[index] = {
                                ...taskTemplates[index],
                                ...templateData,
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅÔºàLocalStorageÔºâ');
                        }
                    }
                } else {
                    // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ - FirebaseÁµ±Âêà
                    const templateData = {
                        id: Date.now(),
                        name: name,
                        category: category,
                        taskTitle: taskTitle,
                        priority: priority,
                        columnId: columnId,
                        assignees: selectedAssignees,
                        memo: memo,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Firebase‰ΩúÊàê
                    if (window.FirebaseDB && window.firebaseAuth?.currentUser) {
                        console.log('üî• [TEMPLATE-MGMT] Firebase„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê‰∏≠...', name);
                        const result = await window.FirebaseDB.createTemplate(templateData);
                        
                        if (result.success) {
                            console.log('‚úÖ [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàêÊàêÂäü:', result.id);
                            
                            // Firebase ID„ÇíË®≠ÂÆö„Åó„Å¶„É≠„Éº„Ç´„É´ÈÖçÂàó„Å´ËøΩÂä†
                            templateData.id = result.id;
                            taskTemplates.push(templateData);
                            alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ');
                        } else {
                            console.error('‚ùå [FIREBASE] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Ç®„É©„Éº:', result.error);
                            alert(`„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê„Ç®„É©„Éº: ${result.error}`);
                            return;
                        }
                    } else {
                        // LocalStorage„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        taskTemplates.push(templateData);
                        localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                        alert('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅÔºàLocalStorageÔºâ');
                    }
                }
                
                // LocalStorage„Å´„ÇÇ‰øùÂ≠òÔºàÂêåÊúüÁî®Ôºâ
                localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
                
                // ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                loadTemplateManagementList();
                if (window.loadTemplateList) {
                    loadTemplateList(); // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆ‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞ÔºàË¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
                }
                
            } catch (error) {
                console.error('‚ùå [TEMPLATE-MGMT] „ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert(`„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
            }
            
            // „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢„Å´Êàª„Çã
            showTemplateWelcomeScreen();
        }
        
        function cancelTemplateForm() {
            showTemplateWelcomeScreen();
        }
        
        function deleteCurrentTemplate() {
            if (!currentEditingTemplateId) return;
            
            const template = taskTemplates.find(t => t.id === currentEditingTemplateId);
            if (!template) return;
            
            if (!confirm(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                return;
            }
            
            taskTemplates = taskTemplates.filter(t => t.id !== currentEditingTemplateId);
            localStorage.setItem('taskTemplates', JSON.stringify(taskTemplates));
            
            // ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
            loadTemplateManagementList();
            loadTemplateList(); // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆ‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞
            
            // „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢„Å´Êàª„Çã
            showTemplateWelcomeScreen();
            
            alert('üóëÔ∏è „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }
        
        // ============ „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´Èñ¢Êï∞Áæ§ ÁµÇ‰∫Ü ============
        
        // ============ „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´Èñ¢Êï∞Áæ§ ============
        let previewTasksModal = [];
        
        function openTaskImportModal() {
            document.getElementById('taskImportModal').style.display = 'flex';
            hidePreviewModal();
            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
            document.getElementById('import-text-modal').value = '';
            document.getElementById('ocr-file-input-modal').value = '';
        }
        
        function closeTaskImportModal() {
            document.getElementById('taskImportModal').style.display = 'none';
            hidePreviewModal();
            previewTasksModal = [];
        }
        
        function processImportText(showPreview) {
            const importText = document.getElementById('import-text-modal').value.trim();
            if (!importText) {
                alert('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÂÖÉ„ÅÆ previewImport Ê©üËÉΩ„ÇíÂæ©ÂÖÉ
            const currentUser = getCurrentUser();
            const defaultAssignee = currentUser ? currentUser.name : '„É¶„Éº„Ç∂„Éº';
            const defaultDeadline = new Date().toISOString().split('T')[0];
            const defaultPriority = 'medium';
            const defaultColumn = 'todo';
            
            const lines = importText.split('\n');
            previewTasksModal = [];
            let lastMainTaskIndex = -1;
            
            lines.forEach((line, index) => {
                if (!line.trim()) return;
                
                const trimmedLine = line.trim();
                let taskText = trimmedLine;
                
                // Êï∞Â≠óË®òÂè∑„ÅÆ‰øÆÊ≠£ÔºàÂÖÉ„ÅÆÊ©üËÉΩÔºâ
                taskText = taskText
                    .replace(/‚ë†/g, '1').replace(/‚ë°/g, '2').replace(/‚ë¢/g, '3').replace(/‚ë£/g, '4').replace(/‚ë§/g, '5')
                    .replace(/‚ë•/g, '6').replace(/‚ë¶/g, '7').replace(/‚ëß/g, '8').replace(/‚ë®/g, '9').replace(/‚ë©/g, '10')
                    .replace(/‚óã/g, '0').replace(/‚óè/g, '1');
                
                // „Ç§„É≥„Éá„É≥„ÉàÂà§ÂÆöÔºàÂçäËßí„Çπ„Éö„Éº„Çπ2ÂÄã„ÉªÂÖ®Ëßí„Çπ„Éö„Éº„Çπ1ÂÄã„Éª„Çø„ÉñÔºâ
                const hasIndent = line.match(/^(\s{2,}|„ÄÄ|\t+)/);
                const isMainTask = !hasIndent;
                
                // ÊãÖÂΩìËÄÖÊäΩÂá∫
                const assigneeMatch = taskText.match(/@([^\s@]+)/g);
                let assignee = defaultAssignee;
                if (assigneeMatch && assigneeMatch.length > 0) {
                    assignee = assigneeMatch[0].replace('@', '');
                    taskText = taskText.replace(/@[^\s@]+/g, '').trim();
                }
                
                // Êó•‰ªòÊäΩÂá∫
                const dateMatches = taskText.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}Êúà\d{1,2}Êó•)/g);
                let deadline = defaultDeadline;
                if (dateMatches && dateMatches.length > 0) {
                    let dateStr = dateMatches[0];
                    if (dateStr.includes('Êúà') && dateStr.includes('Êó•')) {
                        const year = new Date().getFullYear();
                        const month = dateStr.match(/(\d{1,2})Êúà/)[1].padStart(2, '0');
                        const day = dateStr.match(/(\d{1,2})Êó•/)[1].padStart(2, '0');
                        deadline = `${year}-${month}-${day}`;
                    } else {
                        const parts = dateStr.split(/[-\/]/);
                        if (parts[0].length === 4) {
                            deadline = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                        } else {
                            const year = parts[2].length === 4 ? parts[2] : new Date().getFullYear();
                            deadline = `${year}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                        }
                    }
                    taskText = taskText.replace(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})|(\d{1,2}Êúà\d{1,2}Êó•)/g, '').trim();
                }
                
                // ÂÑ™ÂÖàÂ∫¶ÊäΩÂá∫
                let priority = defaultPriority;
                if (taskText.match(/[!ÔºÅ]{2,}|È´ò|Á∑äÊÄ•|urgent|URGENT|ÊÄ•/)) {
                    priority = 'high';
                    taskText = taskText.replace(/[!ÔºÅ]+|È´ò|Á∑äÊÄ•|urgent|URGENT|ÊÄ•/g, '').trim();
                } else if (taskText.match(/‰Ωé|later|LATER|Âæå„Åß/)) {
                    priority = 'low';
                    taskText = taskText.replace(/‰Ωé|later|LATER|Âæå„Åß/g, '').trim();
                }
                
                taskText = taskText.replace(/\s+/g, ' ').trim();
                
                if (taskText && taskText.length > 1) {
                    const task = {
                        id: `preview_${index}`,
                        title: taskText,
                        assignee: assignee,
                        deadline: deadline,
                        priority: priority,
                        columnId: defaultColumn,
                        originalLine: line,
                        lineIndex: index,
                        isMainTask: isMainTask,
                        parentIndex: isMainTask ? null : lastMainTaskIndex,
                        isSkip: false,
                        autoDetected: !isMainTask && hasIndent
                    };
                    
                    if (isMainTask) {
                        lastMainTaskIndex = previewTasksModal.length;
                    }
                    
                    previewTasksModal.push(task);
                }
            });
            
            if (showPreview) {
                displayLineByLinePreviewModal();
            } else {
                executeImportFromModal();
            }
        }
        
        
        // ============ „É¢„Éº„ÉÄ„É´Áî®È´òÊ©üËÉΩOCRÈñ¢Êï∞Áæ§ ============
        let selectedAreasModal = [];
        let isSelectingModal = false;
        let startXModal = 0, startYModal = 0;
        let currentImageModal = null;
        
        // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜÔºà„É¢„Éº„ÉÄ„É´ÁâàÔºâ- DOMContentLoadedÂæå„Å´Ë®≠ÂÆö
        function initOCRModalEventListeners() {
            const ocrInput = document.getElementById('ocr-file-input-modal');
            if (ocrInput) {
                ocrInput.addEventListener('change', function(e) {
                    handleOCRFileModal(this);
                });
            }
        }
        
        function handleOCRFileModal(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageModal = new Image();
                currentImageModal.onload = function() {
                    showImagePreviewModal(this);
                };
                currentImageModal.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function showImagePreviewModal(img) {
            const container = document.getElementById('image-preview-container-modal');
            const canvas = document.getElementById('image-canvas-modal');
            const ctx = canvas.getContext('2d');
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„ÇíÁîªÂÉè„Å´Âêà„Çè„Åõ„Çã
            canvas.width = img.width;
            canvas.height = img.height;
            
            // ÁîªÂÉè„ÇíÊèèÁîª
            ctx.drawImage(img, 0, 0);
            
            // ÈÅ∏ÊäûÈ†òÂüü„Çí„ÇØ„É™„Ç¢
            selectedAreasModal = [];
            updateSelectionCountModal();
            
            // „Ç≥„É≥„ÉÜ„Éä„ÇíË°®Á§∫
            container.style.display = 'block';
            
            // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
            setupCanvasEventsModal(canvas);
        }
        
        function setupCanvasEventsModal(canvas) {
            canvas.onmousedown = function(e) {
                isSelectingModal = true;
                const rect = canvas.getBoundingClientRect();
                startXModal = e.clientX - rect.left;
                startYModal = e.clientY - rect.top;
            };
            
            canvas.onmousemove = function(e) {
                if (!isSelectingModal) return;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                // ÈÅ∏ÊäûÈ†òÂüü„ÇíÊèèÁîª
                drawSelectionRectModal(startXModal, startYModal, currentX, currentY);
            };
            
            canvas.onmouseup = function(e) {
                if (!isSelectingModal) return;
                
                isSelectingModal = false;
                const rect = canvas.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;
                
                // ÈÅ∏ÊäûÈ†òÂüü„Çí‰øùÂ≠ò
                const area = {
                    x: Math.min(startXModal, endX),
                    y: Math.min(startYModal, endY),
                    width: Math.abs(endX - startXModal),
                    height: Math.abs(endY - startYModal)
                };
                
                if (area.width > 10 && area.height > 10) {
                    selectedAreasModal.push(area);
                    updateSelectionCountModal();
                    drawAllSelectionsModal();
                }
            };
        }
        
        function drawSelectionRectModal(x1, y1, x2, y2) {
            const canvas = document.getElementById('image-canvas-modal');
            const ctx = canvas.getContext('2d');
            
            // ÁîªÂÉè„ÇíÂÜçÊèèÁîª
            ctx.drawImage(currentImageModal, 0, 0);
            
            // Êó¢Â≠ò„ÅÆÈÅ∏ÊäûÈ†òÂüü„ÇíÊèèÁîª
            drawAllSelectionsModal();
            
            // ÁèæÂú®„ÅÆÈÅ∏ÊäûÈ†òÂüü„ÇíÊèèÁîª
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(Math.min(x1, x2), Math.min(y1, y2), Math.abs(x2 - x1), Math.abs(y2 - y1));
        }
        
        function drawAllSelectionsModal() {
            const canvas = document.getElementById('image-canvas-modal');
            const ctx = canvas.getContext('2d');
            
            ctx.setLineDash([]);
            selectedAreasModal.forEach((area, index) => {
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.strokeRect(area.x, area.y, area.width, area.height);
                
                // È†òÂüüÁï™Âè∑„ÇíË°®Á§∫
                ctx.fillStyle = '#00ff00';
                ctx.font = '16px Arial';
                ctx.fillText((index + 1).toString(), area.x + 5, area.y + 20);
            });
        }
        
        function updateSelectionCountModal() {
            document.getElementById('selection-count-modal').textContent = `${selectedAreasModal.length}ÂÄã„ÅÆÈ†òÂüü„ÇíÈÅ∏Êäû‰∏≠`;
        }
        
        function clearSelectionsModal() {
            selectedAreasModal = [];
            updateSelectionCountModal();
            
            if (currentImageModal) {
                const canvas = document.getElementById('image-canvas-modal');
                const ctx = canvas.getContext('2d');
                ctx.drawImage(currentImageModal, 0, 0);
            }
        }
        
        function hideImagePreviewModal() {
            document.getElementById('image-preview-container-modal').style.display = 'none';
            selectedAreasModal = [];
            currentImageModal = null;
        }
        
        async function processSelectedAreasModal() {
            if (selectedAreasModal.length === 0) {
                alert('„Åæ„ÅöÈ†òÂüü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            showOCRProgressModal();
            let allText = '';
            
            try {
                for (let i = 0; i < selectedAreasModal.length; i++) {
                    const area = selectedAreasModal[i];
                    updateOCRProgressModal(10 + (i * 80 / selectedAreasModal.length), `È†òÂüü ${i + 1}/${selectedAreasModal.length} „ÇíÂá¶ÁêÜ‰∏≠...`);
                    
                    // ÈÅ∏ÊäûÈ†òÂüü„ÇíÂàá„ÇäÂá∫„Åó
                    const croppedCanvas = document.createElement('canvas');
                    const croppedCtx = croppedCanvas.getContext('2d');
                    croppedCanvas.width = area.width;
                    croppedCanvas.height = area.height;
                    
                    croppedCtx.drawImage(currentImageModal, area.x, area.y, area.width, area.height, 0, 0, area.width, area.height);
                    
                    // OCRÂÆüË°å
                    const { data: { text } } = await Tesseract.recognize(croppedCanvas, 'jpn+eng', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = 10 + (i * 80 / selectedAreasModal.length) + (m.progress * 80 / selectedAreasModal.length);
                                updateOCRProgressModal(progress, `È†òÂüü ${i + 1}: ${Math.round(m.progress * 100)}%`);
                            }
                        }
                    });
                    
                    if (text.trim()) {
                        allText += text.trim() + '\n';
                    }
                }
                
                updateOCRProgressModal(100, '‚úÖ OCRÂÆå‰∫ÜÔºÅ');
                
                // „ÉÜ„Ç≠„Çπ„Éà„Çí„Ç§„É≥„Éù„Éº„Éà„Ç®„É™„Ç¢„Å´Ë®≠ÂÆö
                document.getElementById('import-text-modal').value = allText;
                
                hideOCRProgressModal();
                hideImagePreviewModal();
                
                if (allText.trim()) {
                    alert(`OCR„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n${selectedAreasModal.length}ÂÄã„ÅÆÈ†òÂüü„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫„Åó„Åæ„Åó„Åü„ÄÇ`);
                } else {
                    alert('„ÉÜ„Ç≠„Çπ„Éà„ÇíË™çË≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÁîªÂÉè„ÅÆÂìÅË≥™„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
                
            } catch (error) {
                console.error('OCR Error:', error);
                alert('OCRÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                hideOCRProgressModal();
            }
        }
        
        function showOCRProgressModal() {
            document.getElementById('ocr-status-modal').style.display = 'block';
            updateOCRProgressModal(0, 'üì∏ OCRÂá¶ÁêÜ„ÇíÈñãÂßã‰∏≠...');
        }
        
        function updateOCRProgressModal(percentage, message) {
            document.getElementById('ocr-progress-bar-modal').style.width = percentage + '%';
            document.getElementById('ocr-progress-text-modal').textContent = message;
        }
        
        function hideOCRProgressModal() {
            setTimeout(() => {
                document.getElementById('ocr-status-modal').style.display = 'none';
            }, 2000);
        }
        
        function resetOCRSettingsModal() {
            document.getElementById('ocr-handwriting-mode-modal').checked = false;
            document.getElementById('ocr-complex-layout-mode-modal').checked = false;
            document.getElementById('ocr-enhance-contrast-modal').checked = false;
            document.getElementById('ocr-upscale-modal').checked = false;
            document.getElementById('ocr-grayscale-modal').checked = false;
            document.getElementById('ocr-cleanup-symbols-modal').checked = true;
        }
        
        function previewProcessingModal() {
            alert('Âá¶ÁêÜ„Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ„ÅØÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
        }
        
        function testOCRDirectlyModal() {
            alert('OCR„ÉÜ„Çπ„ÉàÊ©üËÉΩ„ÅØÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
        }
        
        // „ÄêÂÖÉ„ÅÆÂÆåÂÖ®„Å™Ê©üËÉΩ„ÇíÂæ©ÂÖÉ„Äë„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Éª3ÂàóË°®Á§∫„ÉªÊúüÈôêÁ∑®ÈõÜ
        
        function displayLineByLinePreviewModal() {
            const previewDiv = document.getElementById('import-preview-modal');
            const contentDiv = document.getElementById('preview-content-modal');
            
            if (previewTasksModal.length === 0) {
                alert('ÊúâÂäπ„Å™„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const activeTaskCount = previewTasksModal.filter(t => !t.isSkip).length;
            const mainTaskCount = previewTasksModal.filter(t => !t.isSkip && t.isMainTask).length;
            const commentCount = previewTasksModal.filter(t => !t.isSkip && !t.isMainTask).length;
            
            const modeInfo = `<div style="font-size: 0.9rem; margin-top: 0.5rem;">‚ú® „Ç§„É≥„Éá„É≥„ÉàË°å„ÅØËá™Âãï„Åß„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆöÊ∏à„ÅøÔºàÂçäËßí„Çπ„Éö„Éº„Çπ2ÂÄã„ÉªÂÖ®Ëßí„Çπ„Éö„Éº„Çπ1ÂÄã„Éª„Çø„ÉñÔºâ„ÄÇ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßË¶™Â≠êÈñ¢‰øÇ„ÇíÂ§âÊõ¥ÂèØËÉΩ</div>`;
            
            let content = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f5e8; border-radius: 4px; color: #2f7d2f;">
                    <strong>üìù ${activeTaskCount}ÂÄã„ÅÆ„Ç¢„Ç§„ÉÜ„É† (üìã „É°„Ç§„É≥: ${mainTaskCount}, üí¨ „Ç≥„É°„É≥„Éà: ${commentCount})</strong>
                    ${modeInfo}
                </div>
                
                <!-- 3ÂàóË°®Á§∫„É¨„Ç§„Ç¢„Ç¶„Éà -->
                <div style="padding: 1rem; background: #f0f2f5; border-radius: 12px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;" id="preview-container-modal">
            `;
            
            previewTasksModal.forEach((task, index) => {
                if (task.isSkip) return;
                
                const mainTaskOptions = previewTasksModal.map((t, i) => 
                    i < index && t.isMainTask ? `<option value="${i}" ${task.parentIndex === i ? 'selected' : ''}>üìã ${t.title.substring(0, 30)}${t.title.length > 30 ? '...' : ''}</option>` : ''
                ).join('');
                
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                const borderColor = isAutoComment ? '#28a745' : '#ddd';
                const bgColor = isAutoComment ? '#f8fff9' : 'white';
                const headerText = isAutoComment ? '‚ú® Ëá™Âãï„Ç≥„É°„É≥„Éà' : '„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ';
                
                content += `
                    <div style="border: 2px solid ${borderColor}; border-radius: 8px; background: ${bgColor}; transition: all 0.2s; cursor: move; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); height: fit-content;" 
                         draggable="true" 
                         ondragstart="handlePreviewDragStartModal(event, ${index})" 
                         ondragend="handleDragEndModal(event)"
                         ondragover="handleDragOverModal(event)" 
                         ondrop="handlePreviewDropModal(event, ${index})"
                         ondragenter="handleDragEnterModal(event)"
                         ondragleave="handleDragLeaveModal(event)"
                         id="preview-item-modal-${index}">
                        
                        <!-- „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´ -->
                        <div style="background: ${borderColor}; padding: 0.4rem 0.8rem; text-align: center; color: white; font-weight: bold; cursor: grab; user-select: none; font-size: 0.85rem;">
                            ‚ãÆ‚ãÆ ${headerText} ‚ãÆ‚ãÆ
                        </div>
                        
                        <!-- „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫„Ç®„É™„Ç¢ -->
                        <div style="padding: 0.75rem; background: white;">
                            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                <input type="text" 
                                       value="${task.title.replace(/"/g, '&quot;')}" 
                                       onchange="updateTaskTitleModal(${index}, this.value)" 
                                       style="flex: 1; font-family: monospace; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; border: 1px solid ${borderColor}; border-left: 3px solid ${borderColor};"
                                       id="title-input-modal-${index}">
                                <button onclick="deletePreviewTaskModal(${index})" 
                                        style="background: #e53e3e; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                                        title="„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§">
                                    üóëÔ∏è
                                </button>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                                ÂÖÉ: "${task.originalLine}"
                            </div>
                        </div>
                        
                        <!-- Ë®≠ÂÆö„Ç®„É™„Ç¢ -->
                        <div style="padding: 0.75rem; background: #fafafa; border-top: 1px solid #eee;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">Á®ÆÈ°û:</label>
                                    <select onchange="updateTaskTypeModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;">
                                        <option value="main" ${task.isMainTask ? 'selected' : ''}>üìã „É°„Ç§„É≥</option>
                                        <option value="comment" ${!task.isMainTask ? 'selected' : ''}>üí¨ „Ç≥„É°„É≥„Éà</option>
                                        <option value="skip">‚è≠Ô∏è „Çπ„Ç≠„ÉÉ„Éó</option>
                                    </select>
                                </div>
                                
                                ${!task.isMainTask ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">Ë¶™:</label>
                                    <select onchange="updateTaskParentModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="parent-select-modal-${index}">
                                        <option value="">Ôºç</option>
                                        ${mainTaskOptions}
                                    </select>
                                </div>
                                ` : `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">Âàó:</label>
                                    <select onchange="updateTaskColumnModal(${index}, this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="column-select-modal-${index}">
                                        ${columns.map(c => `<option value="${c.id}" ${task.columnId === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <!-- ÊãÖÂΩìËÄÖË®≠ÂÆö -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">ÊãÖÂΩì:</label>
                                    <input type="text" onchange="updateTaskAssigneeModal(${index}, this.value)" value="${task.assignee}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" placeholder="ÊãÖÂΩìËÄÖÂêç" id="assignee-input-modal-${index}">
                                </div>
                                
                                <!-- ÊúüÈôêË®≠ÂÆö -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-weight: 600; min-width: 60px; font-size: 0.85rem; color: #333;">ÊúüÈôê:</label>
                                    <input type="date" onchange="updateTaskDeadlineModal(${index}, this.value)" value="${task.deadline}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: white;" id="deadline-input-modal-${index}">
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += `
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 0.9rem;">
                    <strong>üí° ‰Ωø„ÅÑÊñπÔºö</strong><br>
                    ‚Ä¢ <strong>‚ú® Ëá™ÂãïÂà§ÂÆö</strong>ÔºöÁ©∫ÁôΩ„Åå„ÅÇ„ÇãË°å„ÅØËá™Âãï„Åß„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆö„Åï„Çå„ÄÅÁõ¥Ââç„ÅÆ„É°„Ç§„É≥„Çø„Çπ„ÇØ„ÅåË¶™„Å´Ë®≠ÂÆö„Åï„Çå„Åæ„Åô<br>
                    ‚Ä¢ <strong>üñ±Ô∏è „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</strong>Ôºö‰ªªÊÑè„ÅÆË°å„Çí„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Ç≥„É°„É≥„Éà„Å´Â§âÊõ¥<br>
                    ‚Ä¢ <strong>üìã „É°„Ç§„É≥„Çø„Çπ„ÇØ</strong>ÔºöÁã¨Á´ã„Åó„Åü„Çø„Çπ„ÇØ„Ç´„Éº„Éâ„Å®„Åó„Å¶‰ΩúÊàê<br>
                    ‚Ä¢ <strong>üí¨ „Ç≥„É°„É≥„Éà</strong>ÔºöÊåáÂÆö„Åó„Åü„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ËøΩÂä†<br>
                    ‚Ä¢ <strong>‚è≠Ô∏è „Çπ„Ç≠„ÉÉ„Éó</strong>Ôºö„Ç§„É≥„Éù„Éº„ÉàÊôÇ„Å´ÁÑ°Ë¶ñ
                </div>
            `;
            
            contentDiv.innerHTML = content;
            previewDiv.style.display = 'block';
        }
        
        // „ÄêÂÖÉ„ÅÆÂÆåÂÖ®„Å™updateÈñ¢Êï∞Áæ§„ÇíÂæ©ÂÖÉ„Äë
        function updateTaskTitleModal(index, title) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].title = title.trim();
            }
        }
        
        function updateTaskTypeModal(index, type) {
            if (previewTasksModal[index]) {
                // „Ç≥„É°„É≥„ÉàÂåñ„Åó„Çà„ÅÜ„Å®„Åô„Çã„Çø„Çπ„ÇØ„Åå‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (type === 'comment' && previewTasksModal[index].isMainTask) {
                    const hasChildComments = previewTasksModal.some((task, i) => 
                        i !== index && !task.isMainTask && task.parentIndex === index
                    );
                    
                    if (hasChildComments) {
                        alert('‚ö†Ô∏è „Åì„ÅÆ„Çø„Çπ„ÇØ„ÅØ‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Ç≥„É°„É≥„ÉàÂåñ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nÂÖà„Å´Â≠ê„Ç≥„É°„É≥„Éà„Çí‰ªñ„ÅÆ„Çø„Çπ„ÇØ„Å´ÁßªÂãï„Åô„Çã„Åã„ÄÅ„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        document.querySelector(`#preview-item-modal-${index} select`).value = 'main';
                        return;
                    }
                }
                
                previewTasksModal[index].isMainTask = (type === 'main');
                previewTasksModal[index].isSkip = (type === 'skip');
                
                displayLineByLinePreviewModal();
            }
        }
        
        function updateTaskParentModal(index, parentIndex) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].parentIndex = parentIndex === '' ? null : parseInt(parentIndex);
                displayLineByLinePreviewModal();
            }
        }
        
        function updateTaskColumnModal(index, columnId) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].columnId = columnId;
            }
        }
        
        function updateTaskAssigneeModal(index, assignee) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].assignee = assignee.trim();
            }
        }
        
        function updateTaskDeadlineModal(index, deadline) {
            if (previewTasksModal[index]) {
                previewTasksModal[index].deadline = deadline;
            }
        }
        
        function deletePreviewTaskModal(index) {
            const task = previewTasksModal[index];
            
            // „Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíË¶™„Å´„Åó„Å¶„ÅÑ„Çã„Ç≥„É°„É≥„Éà„ÇíÁ¢∫Ë™ç
            const childComments = previewTasksModal.filter((t, i) => 
                i !== index && !t.isMainTask && t.parentIndex === index
            );
            
            if (childComments.length > 0) {
                if (!confirm(`‚ö†Ô∏è „Åì„ÅÆ„Çø„Çπ„ÇØ„Å´„ÅØ${childComments.length}ÂÄã„ÅÆÂ≠ê„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÂ≠ê„Ç≥„É°„É≥„Éà„ÇÇ‰∏ÄÁ∑í„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }
                
                // Â≠ê„Ç≥„É°„É≥„Éà„ÇÇÂâäÈô§
                childComments.forEach(childTask => {
                    const childIndex = previewTasksModal.findIndex(t => t === childTask);
                    if (childIndex !== -1) {
                        previewTasksModal.splice(childIndex, 1);
                    }
                });
            }
            
            previewTasksModal.splice(index, 1);
            displayLineByLinePreviewModal();
        }
        
        // „Äê„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ„ÇíÂæ©ÂÖÉ„Äë
        function handlePreviewDragStartModal(event, index) {
            draggedIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.6';
        }
        
        function handleDragEndModal(event) {
            event.target.style.opacity = '1';
            draggedIndex = -1;
        }
        
        function handleDragOverModal(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnterModal(event) {
            event.preventDefault();
            if (event.target.closest('[id^="preview-item-modal-"]')) {
                event.target.closest('[id^="preview-item-modal-"]').style.backgroundColor = '#e3f2fd';
            }
        }
        
        function handleDragLeaveModal(event) {
            if (event.target.closest('[id^="preview-item-modal-"]')) {
                const item = event.target.closest('[id^="preview-item-modal-"]');
                const itemIndex = parseInt(item.id.split('-')[3]);
                const task = previewTasksModal[itemIndex];
                const isAutoComment = !task.isMainTask && task.parentIndex !== null;
                item.style.backgroundColor = isAutoComment ? '#f8fff9' : 'white';
            }
        }
        
        function handlePreviewDropModal(event, targetIndex) {
            event.preventDefault();
            
            if (draggedIndex === targetIndex || draggedIndex === -1) {
                event.target.closest('[id^="preview-item-modal-"]').style.opacity = '1';
                return;
            }
            
            const draggedTask = previewTasksModal[draggedIndex];
            const targetTask = previewTasksModal[targetIndex];
            
            // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Çø„Çπ„ÇØ„Çí„Ç≥„É°„É≥„Éà„Å´Â§âÊõ¥„Åó„ÄÅ„Çø„Éº„Ç≤„ÉÉ„Éà„Çø„Çπ„ÇØ„ÇíË¶™„Å´Ë®≠ÂÆö
            if (targetTask.isMainTask) {
                // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Çø„Çπ„ÇØ„Åå‰ªñ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆË¶™„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (draggedTask.isMainTask) {
                    const childComments = previewTasksModal.filter((task, i) => 
                        i !== draggedIndex && !task.isMainTask && task.parentIndex === draggedIndex
                    );
                    
                    if (childComments.length > 0) {
                        // Â≠ê„Ç≥„É°„É≥„Éà„ÇÇ‰∏ÄÁ∑í„Å´ÁßªÂãï
                        childComments.forEach(childTask => {
                            childTask.parentIndex = targetIndex;
                        });
                    }
                }
                
                draggedTask.isMainTask = false;
                draggedTask.parentIndex = targetIndex;
                
                displayLineByLinePreviewModal();
                
                const movedCount = draggedTask.isMainTask ? 0 : previewTasksModal.filter(t => !t.isMainTask && t.parentIndex === targetIndex).length;
                alert(`üí¨ "${draggedTask.title}"„Çí"${targetTask.title}"„ÅÆ„Ç≥„É°„É≥„Éà„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü${movedCount > 1 ? `ÔºàÂ≠ê„Ç≥„É°„É≥„Éà${movedCount-1}ÂÄã„ÇÇÁßªÂãïÔºâ` : ''}`);
            } else {
                alert('‚ö†Ô∏è „Ç≥„É°„É≥„Éà„ÇíÂà•„ÅÆ„Ç≥„É°„É≥„Éà„Å´„Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„É°„Ç§„É≥„Çø„Çπ„ÇØ„Å´„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            
            draggedIndex = -1;
        }
        
        function executeImportFromModal() {
            if (previewTasksModal.length === 0) {
                alert('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const activeTasksModal = previewTasksModal.filter(t => !t.isSkip);
            if (activeTasksModal.length === 0) {
                alert('ÊúâÂäπ„Å™„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Çø„Çπ„ÇØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const importedCount = importTasksModal(activeTasksModal);
            const mainCount = activeTasksModal.filter(t => t.isMainTask).length;
            const commentCount = activeTasksModal.filter(t => !t.isMainTask).length;
            
            alert(`üéâ „Çø„Çπ„ÇØËøΩÂä†„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\nüìã ${mainCount}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„ÇíËøΩÂä†\nüí¨ ${commentCount}ÂÄã„ÅÆ„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†\n\nÂêàË®à: ${importedCount}‰ª∂`);
            
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶„É°„Ç§„É≥ÁîªÈù¢„ÇíÊõ¥Êñ∞
            closeTaskImportModal();
            render();
            
            // ÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ„ÇÇÂÆüË°å
            setTimeout(() => checkDeadlines(), 100);
        }
        
        // ============ „Çø„Çπ„ÇØ„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´Èñ¢Êï∞Áæ§ ÁµÇ‰∫Ü ============

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÈñ¢ÈÄ£Èñ¢Êï∞
        function initializeTemplateSelector() {
            const templateSelect = document.getElementById('template-select');
            templateSelect.innerHTML = '<option value="">-- „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû --</option>';
            
            if (taskTemplates.length === 0) {
                return;
            }
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const groupedTemplates = {};
            taskTemplates.forEach(template => {
                if (!groupedTemplates[template.category]) {
                    groupedTemplates[template.category] = [];
                }
                groupedTemplates[template.category].push(template);
            });
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Ç™„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†
            Object.keys(groupedTemplates).forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                groupedTemplates[category].forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    optgroup.appendChild(option);
                });
                
                templateSelect.appendChild(optgroup);
            });
        }
        
        function handleTemplateSelection(templateId) {
            if (!templateId) {
                return;
            }
            
            const template = taskTemplates.find(t => t.id == templateId);
            if (!template) {
                return;
            }
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('task-title-input').value = template.taskTitle;
            document.getElementById('task-priority-input').value = template.priority;
            document.getElementById('task-column-input').value = template.columnId;
            document.getElementById('task-memo-input').value = template.memo || '';
            
            // ÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö
            if (template.assignees && template.assignees.length > 0) {
                setSelectedAssignees(template.assignees);
            }
            
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('template-select').value = '';
        }
        
        // „Éê„É´„ÇØÊìç‰ΩúÈñ¢Êï∞Áæ§
        function toggleBulkMode() {
            isBulkMode = !isBulkMode;
            console.log(`üîÑ [BULK] toggleBulkMode called, new state: ${isBulkMode}`);
            const bulkBar = document.getElementById('bulk-actions-bar');
            const toggleBtn = document.querySelector('button[onclick="toggleBulkMode()"]');
            
            if (isBulkMode) {
                bulkBar.style.display = 'block';
                toggleBtn.textContent = '‚òëÔ∏è ÈÅ∏Êäû‰∏≠';
                toggleBtn.style.background = 'linear-gradient(135deg, #e53e3e 0%, #c53030 100%)';
                
                // ÁßªÂãïÂÖà„Ç´„É©„É†ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
                const moveSelect = document.getElementById('bulk-move-column');
                moveSelect.innerHTML = '<option value="">ÁßªÂãïÂÖà„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû</option>';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    moveSelect.appendChild(option);
                });
            } else {
                bulkBar.style.display = 'none';
                toggleBtn.textContent = '‚òëÔ∏è Ë§áÊï∞ÈÅ∏Êäû';
                toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                clearSelection();
            }
            
            render(); // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπË°®Á§∫/ÈùûË°®Á§∫„ÇíÂèçÊò†
        }
        
        function selectAllTasks() {
            selectedTasks.clear();
            tasks.forEach(task => {
                selectedTasks.add(task.id);
            });
            updateSelectedCount();
            render();
        }
        
        function clearSelection() {
            selectedTasks.clear();
            updateSelectedCount();
            render();
        }
        
        function toggleTaskSelection(taskId) {
            console.log(`Toggle selection for task ${taskId}, current size: ${selectedTasks.size}`);
            
            if (selectedTasks.has(taskId)) {
                selectedTasks.delete(taskId);
                console.log(`Removed task ${taskId}, new size: ${selectedTasks.size}`);
            } else {
                selectedTasks.add(taskId);
                console.log(`Added task ${taskId}, new size: ${selectedTasks.size}`);
            }
            updateSelectedCount();
            
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            const checkbox = document.querySelector(`input[onchange="toggleTaskSelection(${taskId})"]`);
            if (checkbox) {
                checkbox.checked = selectedTasks.has(taskId);
            }
            
            console.log(`Selected tasks:`, Array.from(selectedTasks));
        }
        
        function updateSelectedCount() {
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = `${selectedTasks.size}‰ª∂ÈÅ∏Êäû`;
            }
        }
        
        function bulkMoveSelected() {
            const targetColumn = document.getElementById('bulk-move-column').value;
            if (!targetColumn) {
                alert('ÁßªÂãïÂÖà„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (selectedTasks.size === 0) {
                alert('ÁßªÂãï„Åô„Çã„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const selectedTaskIds = Array.from(selectedTasks);
            let movedCount = 0;
            
            selectedTaskIds.forEach(taskId => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    console.log(`Moving task ${task.title} from ${task.columnId} to ${targetColumn}`);
                    task.columnId = targetColumn;
                    movedCount++;
                }
            });
            
            if (movedCount > 0) {
                saveTasks();
                render();
                updateStats();
                clearSelection();
                
                const targetColumnTitle = columns.find(c => c.id === targetColumn)?.title || targetColumn;
                alert(`${movedCount}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„Çí„Äå${targetColumnTitle}„Äç„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü`);
            } else {
                alert('ÁßªÂãï„Åß„Åç„Çã„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
            }
        }
        
        function bulkDeleteSelected() {
            if (selectedTasks.size === 0) {
                alert('ÂâäÈô§„Åô„Çã„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const selectedTaskIds = Array.from(selectedTasks);
            const confirmMessage = `ÈÅ∏Êäû„Åó„Åü${selectedTaskIds.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            tasks = tasks.filter(task => !selectedTasks.has(task.id));
            
            saveTasks();
            clearSelection();
            render();
            updateStats();
            
            alert(`${selectedTaskIds.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
        }
        
        
        
        // Phase 2: „Éû„Ç§„Éö„Éº„Ç∏„Éú„Çø„É≥ÂâäÈô§ÂÆüË°å
        setTimeout(() => {
            removeMyProfileButton();
        }, 1500); // 1.5ÁßíÂæå„Å´ÂÆâÂÖ®„Å´ÂÆüË°å
        
        // Phase 3: „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Éú„Çø„É≥Âà∂Âæ°ÂÆüË°åÔºà„Éû„Ç§„Éö„Éº„Ç∏ÁßªÊ§ç„ÅÆ„Åü„ÇÅ‰∏çË¶ÅÔºâ
        // setTimeout(() => {
        //     hideUserManagementForUsers();
        // }, 300); // 0.3ÁßíÂæå„Å´È´òÈÄüÂÆüË°å
        
        // „ÉÜ„Çπ„ÉàÁî®: ÂÅúÊªû„Çø„Çπ„ÇØ„Çí‰ΩúÊàêÔºà„Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÂÆüË°åÂèØËÉΩÔºâ
        function createTestStaleTask() {
            const staleDate = new Date();
            staleDate.setDate(staleDate.getDate() - 5); // 5Êó•Ââç
            
            const testTask = {
                id: Date.now(),
                title: '„Äê„ÉÜ„Çπ„Éà„Äë5Êó•Ââç„Å´‰ΩúÊàê„Åï„Çå„Åü„Çø„Çπ„ÇØ',
                deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7Êó•Âæå„ÅÆÊúüÈôê
                priority: 'medium',
                columnId: 'todo',
                assignee: 'Áî∞‰∏≠ÈÉ®Èï∑',
                assignees: ['Áî∞‰∏≠ÈÉ®Èï∑'],
                memo: '„Åì„Çå„ÅØÂÅúÊªû„Çø„Çπ„ÇØ„ÅÆ„ÉÜ„Çπ„ÉàÁî®„Åß„Åô„ÄÇ3Êó•‰ª•‰∏äÁµåÈÅé„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅËµ§Êû†Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ',
                createdAt: staleDate.toISOString(),
                isMainTask: false
            };
            
            tasks.push(testTask);
            taskCounter++;
            
            saveTasks();
            renderKanban();
            updateStats();
            
            alert('5Êó•Ââç„Å´‰ΩúÊàê„Åï„Çå„Åü„ÉÜ„Çπ„Éà„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ\nËµ§Êû†„ÅßË°®Á§∫„Åï„Çå„ÄÅÂÅúÊªû‰∏≠„Ç´„Ç¶„É≥„Éà„Å´Âê´„Åæ„Çå„Åæ„Åô„ÄÇ');
        }
        
        // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºà„Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÂëº„Å≥Âá∫„ÅóÂèØËÉΩÔºâ
        window.createTestStaleTask = createTestStaleTask;
        
        // „ÉÜ„Çπ„ÉàÁî®PJ„Çø„Çπ„ÇØ‰ΩúÊàê
        function createTestPJTask() {
            const testPJTask = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                title: '„Äê„ÉÜ„Çπ„ÉàPJ„ÄëÊñ∞Ë¶è„Ç∑„Çπ„ÉÜ„É†Â∞éÂÖ• - Ë¶Å‰ª∂ÂÆöÁæ©Êõ∏‰ΩúÊàê',
                deadline: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString(), // 10Êó•Âæå„ÅÆÊúüÈôê
                priority: 'high',
                columnId: 'todo',
                assignee: 'Áî∞‰∏≠ÈÉ®Èï∑',
                assignees: ['Áî∞‰∏≠ÈÉ®Èï∑', '‰ΩêËó§Ë™≤Èï∑'],
                memo: '„Åì„Çå„ÅØPJ„Çø„Çπ„ÇØ„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô„ÄÇW„ÉÅ„Çß„ÉÉ„ÇØ‰ΩìÂà∂„ÅÆÁ¢∫Ë™çÁî®„ÄÇ',
                createdAt: new Date().toISOString(),
                completed: false,
                
                // PJ„Çø„Çπ„ÇØÂ∞ÇÁî®„Éï„Ç£„Éº„É´„Éâ
                projectId: 'PJ001',
                projectName: 'Êñ∞Ë¶è„Ç∑„Çπ„ÉÜ„É†Â∞éÂÖ•„Éó„É≠„Ç∏„Çß„ÇØ„Éà',
                personalStatus: 'todo',
                projectStatus: 'todo',
                pendingMove: null,
                approvers: ['‰ΩêËó§Ë™≤Èï∑', 'Èà¥Êú®‰∏ª‰ªª'],
                lastApprovedBy: null,
                approvedAt: null
            };
            
            tasks.push(testPJTask);
            saveTasks();
            render();
            updateStats();
            
            alert('„ÉÜ„Çπ„ÉàÁî®PJ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ\n\nPJ„Éï„Ç£„É´„Çø„Éº„Åã„Çâ„ÄåPJ001„Äç„ÇíÈÅ∏Êäû„Åô„Çã„Å®Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ\n\n„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç: Êñ∞Ë¶è„Ç∑„Çπ„ÉÜ„É†Â∞éÂÖ•„Éó„É≠„Ç∏„Çß„ÇØ„Éà\n„Éó„É≠„Ç∏„Çß„ÇØ„ÉàID: PJ001');
        }
        
        window.createTestPJTask = createTestPJTask;
        
        // ÂÆöÊúü„Çø„Çπ„ÇØÁÆ°ÁêÜ„ÅÆÂü∫Êú¨Èñ¢Êï∞
        function createRecurringTemplate() {
            alert('ÂÆöÊúü„Çø„Çπ„ÇØ„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàêÊ©üËÉΩ„ÅØÂÆüË£Ö‰∏≠„Åß„Åô„ÄÇ\n\n‰∫àÂÆöÊ©üËÉΩ:\n‚Ä¢ ÊØéÊúà„ÉªÊØéÈÄ±„ÅÆÁπ∞„ÇäËøî„ÅóË®≠ÂÆö\n‚Ä¢ ÊãÖÂΩìËÄÖ„ÉªÊúüÈôê„ÅÆËá™ÂãïË®≠ÂÆö\n‚Ä¢ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ„ÅÆËá™ÂãïÁîüÊàê');
        }
        
        function generatePendingTasks() {
            // ÁèæÂú®ÂÆöÊúü„Çø„Çπ„ÇØ„Åå0‰ª∂„Å™„ÅÆ„Åß„ÄÅ„Éá„É¢Áî®„ÅÆË™¨Êòé„ÇíË°®Á§∫
            alert('ÂÆöÊúü„Çø„Çπ„ÇØÁîüÊàê„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü\n\nÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê„Åô„Çã„Å®„ÄÅÊåáÂÆö„Åï„Çå„ÅüÈñìÈöî„Åß„Çø„Çπ„ÇØ„ÅåËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„Åô„ÄÇ');
        }
        
        window.createRecurringTemplate = createRecurringTemplate;
        window.generatePendingTasks = generatePendingTasks;
        
        // PJ„Çø„Çπ„ÇØË®ºÊÜë„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩÔºàÁßªÂãï„ÅÆ„Åü„Å≥„Å´Êñ∞„Åó„ÅÑË®ºÊÜë„ÅåÂøÖË¶ÅÔºâ
        function checkTaskEvidence(task, isMoving = false) {
            // Ë®ºÊÜë„ÅÆÂ≠òÂú®Á¢∫Ë™ç
            const hasComments = task.comments && task.comments.length > 0;
            const hasAttachments = task.attachments && task.attachments.length > 0;
            const hasDetailedMemo = task.memo && task.memo.trim().length > 10; // 10ÊñáÂ≠ó‰ª•‰∏ä„ÅÆË©≥Á¥∞„É°„É¢
            
            // ÁßªÂãïÊôÇ„ÅØ„ÄÅÂâçÂõûÁßªÂãïÂæå„Å´Êñ∞„Åó„ÅÑË®ºÊÜë„ÅåËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (isMoving && task.lastMovedAt) {
                const lastMoveTime = new Date(task.lastMovedAt).getTime();
                
                // ÂâçÂõûÁßªÂãïÂæå„ÅÆ„Ç≥„É°„É≥„ÉàÁ¢∫Ë™ç
                const recentComments = task.comments ? task.comments.filter(comment => 
                    new Date(comment.timestamp).getTime() > lastMoveTime
                ).length > 0 : false;
                
                // ÂâçÂõûÁßªÂãïÂæå„ÅÆÊ∑ª‰ªò„Éï„Ç°„Ç§„É´Á¢∫Ë™ç
                const recentAttachments = task.attachments ? task.attachments.filter(file =>
                    new Date(file.uploadedAt || file.timestamp || 0).getTime() > lastMoveTime
                ).length > 0 : false;
                
                // „É°„É¢„ÅÆÊõ¥Êñ∞Á¢∫Ë™çÔºàupdatedAt„ÅålastMovedAt„Çà„ÇäÊñ∞„Åó„ÅÑÔºâ
                const recentMemoUpdate = task.updatedAt && 
                    new Date(task.updatedAt).getTime() > lastMoveTime &&
                    task.memo && task.memo.trim().length > 10;
                
                const hasRecentEvidence = recentComments || recentAttachments || recentMemoUpdate;
                
                console.log(`üîç [EVIDENCE CHECK] Task: ${task.title}`);
                console.log(`üîç [EVIDENCE CHECK] Last moved: ${task.lastMovedAt}`);
                console.log(`üîç [EVIDENCE CHECK] Recent comments: ${recentComments}`);
                console.log(`üîç [EVIDENCE CHECK] Recent attachments: ${recentAttachments}`);
                console.log(`üîç [EVIDENCE CHECK] Recent memo update: ${recentMemoUpdate}`);
                console.log(`üîç [EVIDENCE CHECK] Has recent evidence: ${hasRecentEvidence}`);
                
                return hasRecentEvidence;
            }
            
            // ÂàùÂõûÁßªÂãïÊôÇ„ÅØÊó¢Â≠ò„ÅÆË®ºÊÜë„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            return hasComments || hasAttachments || hasDetailedMemo;
        }
        
        function promptForEvidence(task) {
            const result = confirm(
                `‚ö†Ô∏è PJ„Çø„Çπ„ÇØ„ÅÆÁßªÂãï„Å´„ÅØË®ºÊÜë„ÅåÂøÖË¶Å„Åß„Åô\n\n` +
                `„Çø„Çπ„ÇØ: ${task.title}\n` +
                `„Éó„É≠„Ç∏„Çß„ÇØ„Éà: ${task.projectName}\n\n` +
                `‰ª•‰∏ã„ÅÆ„ÅÑ„Åö„Çå„Åã„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n` +
                `‚Ä¢ „Ç≥„É°„É≥„ÉàÔºàÈÄ≤ÊçóÂ†±Âëä„ÉªÈÄ£Áµ°ÂÜÖÂÆπÁ≠âÔºâ\n` +
                `‚Ä¢ „Éï„Ç°„Ç§„É´Ê∑ª‰ªòÔºàË≥áÊñô„Éª„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÁ≠âÔºâ\n` +
                `‚Ä¢ Ë©≥Á¥∞„É°„É¢Ôºà„É°„Éº„É´ÂÜÖÂÆπ„ÉªÊâì„Å°Âêà„Çè„ÅõÁµêÊûúÁ≠âÔºâ\n\n` +
                `Ë®ºÊÜë„ÇíËøΩÂä†„Åõ„Åö„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü\n` +
                `‚Äª ÊâøË™çËÄÖ„ÅåÁä∂Ê≥Å„ÇíÂà§Êñ≠„Åß„Åç„Åæ„Åõ„Çì`
            );
            
            if (!result) {
                // Ë®ºÊÜëËøΩÂä†„ÅÆ„Åü„ÇÅ„Çø„Çπ„ÇØÁ∑®ÈõÜÁîªÈù¢„ÇíÈñã„Åè
                editTask(task.id);
                return false;
            }
            
            return true; // Ë®ºÊÜë„Å™„Åó„ÅßÂº∑Âà∂ÁßªÂãï
        }
        
        // PJ„Çø„Çπ„ÇØÁßªÂãïÊôÇ„ÅÆÈÄöÁü•Ê©üËÉΩ
        function sendPJMoveNotification(task, newColumnId) {
            try {
                const currentUser = getCurrentUser();
                const column = columns.find(c => c.id === newColumnId);
                const columnTitle = column ? column.title : newColumnId;
                
                // ÈÄöÁü•ÂØæË±°ËÄÖ„ÇíÈõÜ„ÇÅ„ÇãÔºàÊâøË™çËÄÖ + ÊãÖÂΩìËÄÖÔºâ
                const notifyUsers = new Set();
                
                // ÊâøË™çËÄÖ„ÇíËøΩÂä†
                if (task.approvers && task.approvers.length > 0) {
                    task.approvers.forEach(approver => notifyUsers.add(approver));
                }
                
                // ÊãÖÂΩìËÄÖ„ÇíËøΩÂä†
                if (task.assignees && task.assignees.length > 0) {
                    task.assignees.forEach(assignee => notifyUsers.add(assignee));
                } else if (task.assignee) {
                    notifyUsers.add(task.assignee);
                }
                
                // ÁßªÂãïËÄÖËá™Ë∫´„ÅØÈÄöÁü•ÂØæË±°„Åã„ÇâÈô§Â§ñÔºàËá™ÂàÜ„ÅÆÊìç‰Ωú„Å™„ÅÆ„ÅßÔºâ
                notifyUsers.delete(currentUser.name);
                
                const notifyUsersList = Array.from(notifyUsers);
                
                if (notifyUsersList.length === 0) {
                    console.log(`üìß [PJ NOTIFY] No users to notify for task ${task.id}`);
                    return;
                }
                
                // ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏‰ΩúÊàê
                const notificationTitle = `üèóÔ∏è PJ„Çø„Çπ„ÇØÁßªÂãïÈÄöÁü•`;
                const notificationBody = 
                    `${task.projectId}: ${task.title}\n` +
                    `‚Üí ${columnTitle} „Å´ÁßªÂãï\n` +
                    `ÁßªÂãïËÄÖ: ${currentUser.name}`;
                
                // ÂêÑÂØæË±°ËÄÖ„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°
                notifyUsersList.forEach(user => {
                    console.log(`üìß [PJ NOTIFY] Sending notification to ${user}`);
                    
                    showNotification(
                        notificationTitle,
                        `${user}„Åï„Çì„Å∏\n${notificationBody}`,
                        {
                            tag: `pj-move-${task.id}-${Date.now()}`,
                            taskId: task.id,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üèóÔ∏è</text></svg>'
                        }
                    );
                });
                
                console.log(`üìß [PJ NOTIFY] Sent notifications to: ${notifyUsersList.join(', ')}`);
                
            } catch (error) {
                console.error('‚ùå [PJ NOTIFY] Error sending notifications:', error);
            }
        }
        
        // „Çø„Çπ„ÇØÂâäÈô§Ê©üËÉΩÔºà„Ç¥„ÉüÁÆ±ÁßªÂãïÔºâ
        function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºö‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„ÅøÂâäÈô§ÂèØËÉΩ
            const currentUser = getCurrentUser();
            if (currentUser.role === 'user') {
                const canDelete = task.assignees && task.assignees.includes(currentUser.name) || 
                                 task.assignee === currentUser.name;
                if (!canDelete) {
                    alert('‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Çø„Çπ„ÇØ„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇËá™ÂàÜ„ÅåÊãÖÂΩìËÄÖ„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Çø„Çπ„ÇØ„ÅÆ„ÅøÂâäÈô§ÂèØËÉΩ„Åß„Åô„ÄÇ');
                    return;
                }
            }
            
            const result = confirm(
                `üóëÔ∏è „Çø„Çπ„ÇØ„Çí„Ç¥„ÉüÁÆ±„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                `„Çø„Çπ„ÇØ: ${task.title}\n\n` +
                `‚Äª „Ç¥„ÉüÁÆ±„Åã„Çâ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÂæ©ÂÖÉÂèØËÉΩ„Åß„Åô\n` +
                `‚Äª „Ç¥„ÉüÁÆ±„Åß30Êó•ÁµåÈÅéÂæå„Å´Ëá™ÂãïÂÆåÂÖ®ÂâäÈô§„Åï„Çå„Åæ„Åô`
            );
            
            if (result) {
                // „Ç¥„ÉüÁÆ±„Å´ÁßªÂãï
                const previousColumn = task.columnId;
                task.columnId = 'trash';
                task.deletedAt = new Date().toISOString();
                task.previousColumn = previousColumn; // Âæ©ÂÖÉÁî®
                
                saveTasks();
                render();
                updateStats();
                
                // „Ç¥„ÉüÁÆ±„ÅÆËá™ÂãïÂâäÈô§„ÉÅ„Çß„ÉÉ„ÇØ
                cleanupTrash();
                
                console.log(`üóëÔ∏è „Çø„Çπ„ÇØ„Äå${task.title}„Äç„Çí„Ç¥„ÉüÁÆ±„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü`);
                
                // ÂâäÈô§ÈÄöÁü•
                showNotification(
                    'üóëÔ∏è „Çø„Çπ„ÇØÂâäÈô§',
                    `„Äå${task.title}„Äç„Çí„Ç¥„ÉüÁÆ±„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü`,
                    { tag: `delete-${Date.now()}` }
                );
            }
        }
        
        // „Ç¥„ÉüÁÆ±„ÅÆËá™Âãï„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÊ©üËÉΩ
        function cleanupTrash() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const trashTasks = tasks.filter(t => t.columnId === 'trash');
            const expiredTasks = trashTasks.filter(t => {
                if (!t.deletedAt) return false;
                return new Date(t.deletedAt) < thirtyDaysAgo;
            });
            
            if (expiredTasks.length > 0) {
                // 30Êó•ÁµåÈÅé„Åó„Åü„Çø„Çπ„ÇØ„ÇíÂÆåÂÖ®ÂâäÈô§
                tasks = tasks.filter(t => !expiredTasks.includes(t));
                saveTasks();
                
                console.log(`üßπ „Ç¥„ÉüÁÆ±„Åã„Çâ${expiredTasks.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíËá™ÂãïÂâäÈô§„Åó„Åæ„Åó„Åü`);
                
                // ÂâäÈô§ÈÄöÁü•
                if (expiredTasks.length > 0) {
                    showNotification(
                        'üßπ Ëá™Âãï„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó',
                        `„Ç¥„ÉüÁÆ±„Åã„Çâ${expiredTasks.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíËá™ÂãïÂâäÈô§„Åó„Åæ„Åó„ÅüÔºà30Êó•ÁµåÈÅéÔºâ`,
                        { tag: `cleanup-${Date.now()}` }
                    );
                }
            }
            
            // „Ç¥„ÉüÁÆ±„Åå20‰ª∂„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅÆË≠¶Âëä
            const remainingTrashTasks = tasks.filter(t => t.columnId === 'trash');
            if (remainingTrashTasks.length > 20) {
                console.log(`‚ö†Ô∏è „Ç¥„ÉüÁÆ±„Å´${remainingTrashTasks.length}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô`);
            }
        }
        
        // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆÂàá„ÇäÊõø„Åà
        function toggleHamburgerMenu() {
            console.log('üçî „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÂàá„ÇäÊõø„ÅàÈñãÂßã...');
            
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            
            if (!hamburgerMenu) {
                console.error('‚ùå hamburger-menuË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            if (!menuOverlay) {
                console.error('‚ùå menu-overlayË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const isActive = hamburgerMenu.classList.contains('active');
            
            if (isActive) {
                hamburgerMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                console.log('üçî „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Åæ„Åó„Åü');
            } else {
                hamburgerMenu.classList.add('active');
                menuOverlay.classList.add('active');
                console.log('üçî „É°„Éã„É•„Éº„ÇíÈñã„Åç„Åæ„Åó„Åü');
            }
        }
        
        // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆÊõ¥Êñ∞
        function updateHamburgerMenu() {
            const currentUser = getCurrentUser();
            console.log('üçî „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÊõ¥Êñ∞‰∏≠:', currentUser);
            
            if (currentUser.isLoggedIn) {
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
                const avatar = document.getElementById('user-menu-avatar');
                const name = document.getElementById('user-menu-name');
                const role = document.getElementById('user-menu-role');
                
                if (avatar) avatar.textContent = currentUser.name ? currentUser.name.charAt(0) : '-';
                if (name) name.textContent = currentUser.name || '„Ç≤„Çπ„Éà';
                
                let roleText = '„É¶„Éº„Ç∂„Éº';
                if (currentUser.role === 'developer') roleText = 'ÈñãÁô∫ËÄÖ';
                else if (currentUser.role === 'admin') roleText = 'ÁÆ°ÁêÜËÄÖ';
                if (role) role.textContent = roleText;
                
                // ÈñãÁô∫ËÄÖÊ©üËÉΩ„ÅÆË°®Á§∫Âà∂Âæ°
                const developerSection = document.getElementById('developer-menu-section');
                if (developerSection) {
                    if (currentUser.role === 'developer') {
                        developerSection.style.display = 'block';
                    } else {
                        developerSection.style.display = 'none';
                    }
                }
                
                // ÁÆ°ÁêÜÊ©üËÉΩ„ÅÆË°®Á§∫Âà∂Âæ°
                const adminSection = document.getElementById('admin-menu-section');
                if (adminSection) {
                    // PJË®≠ÂÆö„ÅØÂÖ®„É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„ÄÅ„Åù„ÅÆ‰ªñÁÆ°ÁêÜÊ©üËÉΩ„ÅØadmin‰ª•‰∏ä
                    adminSection.style.display = 'block';
                    
                    // „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Å®ÁÆ°ÁêÜ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÅØadmin‰ª•‰∏ä„ÅÆ„Åø
                    const userManagementLink = adminSection.querySelector('a[href="user-management.html"]');
                    const adminDashboardLink = adminSection.querySelector('a[href="admin-dashboard.html"]');
                    
                    if (currentUser.role === 'developer' || currentUser.role === 'admin') {
                        if (userManagementLink) userManagementLink.style.display = 'block';
                        if (adminDashboardLink) adminDashboardLink.style.display = 'block';
                    } else {
                        if (userManagementLink) userManagementLink.style.display = 'none';
                        if (adminDashboardLink) adminDashboardLink.style.display = 'none';
                    }
                }
            }
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÈñ¢Êï∞
        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem('currentSession');
                window.location.href = 'login.html';
            }
        }
        
        // Ê©üËÉΩÊîπÂñÑÊõ∏„ÇíÈñã„ÅèÔºàÈñãÁô∫ËÄÖÂ∞ÇÁî®Ôºâ
        function openDevelopmentLog() {
            const currentUser = getCurrentUser();
            if (currentUser.role !== 'developer') {
                alert('„Åì„ÅÆÊ©üËÉΩ„ÅØÈñãÁô∫ËÄÖ„ÅÆ„ÅøÂà©Áî®ÂèØËÉΩ„Åß„Åô');
                return;
            }
            window.location.href = 'my-profile.html#development-log';
        }
        
        // „Éï„Ç°„Ç§„É´„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
        function handleFileImport(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            console.log(`üìÅ [IMPORT] ${files.length} files selected`);
            
            for (let file of files) {
                const fileType = file.type;
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
                    // CSV„Éï„Ç°„Ç§„É´Âá¶ÁêÜ
                    importCSV(file);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    // Excel„Éï„Ç°„Ç§„É´Âá¶ÁêÜ
                    alert('ExcelÂΩ¢Âºè„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅØÁèæÂú®ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇCSVÂΩ¢Âºè„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (fileType.startsWith('image/')) {
                    // ÁîªÂÉè„Éï„Ç°„Ç§„É´Âá¶ÁêÜÔºàOCRÔºâ
                    importImageWithOCR(file);
                } else {
                    alert(`„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô: ${file.name}`);
                }
            }
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            event.target.value = '';
        }
        
        // CSV „Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
        function importCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV„Éï„Ç°„Ç§„É´„Å´„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
                        return;
                    }
                    
                    // Á∞°Âçò„Å™CSVËß£ÊûêÔºà„Çø„Çπ„ÇØÂêç, ÊúüÈôê, ÊãÖÂΩìËÄÖ, ÂÑ™ÂÖàÂ∫¶, „É°„É¢„ÅÆÈ†ÜÔºâ
                    let importedCount = 0;
                    const currentTime = new Date();
                    
                    for (let i = 1; i < lines.length; i++) {
                        const columns = lines[i].split(',').map(col => col.trim().replace(/"/g, ''));
                        
                        if (columns.length >= 1 && columns[0]) {
                            const taskTitle = columns[0];
                            const deadline = columns[1] || new Date(currentTime.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                            const assignee = columns[2] || getCurrentUser().name;
                            const priority = columns[3] || 'medium';
                            const memo = columns[4] || '';
                            
                            const newTask = {
                                id: Date.now() + i,
                                title: taskTitle,
                                deadline: new Date(deadline + 'T23:59:59').toISOString(),
                                priority: ['high', 'medium', 'low'].includes(priority) ? priority : 'medium',
                                assignees: [assignee],
                                assignee: assignee,
                                memo: memo,
                                columnId: 'todo',
                                completed: false,
                                createdAt: new Date().toISOString(),
                                comments: [],
                                attachments: []
                            };
                            
                            tasks.unshift(newTask);
                            importedCount++;
                        }
                    }
                    
                    if (importedCount > 0) {
                        saveTasks();
                        render();
                        alert(`${importedCount}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
                    } else {
                        alert('„Ç§„É≥„Éù„Éº„ÉàÂèØËÉΩ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    }
                    
                } catch (error) {
                    console.error('CSV import error:', error);
                    alert('CSV„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            };
            reader.readAsText(file);
        }
        
        // ÁîªÂÉèOCR„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
        function importImageWithOCR(file) {
            if (typeof Tesseract === 'undefined') {
                alert('ÁîªÂÉèË™≠„ÅøÂèñ„ÇäÊ©üËÉΩ„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // OCRÂá¶ÁêÜ„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
                const loadingMsg = alert('ÁîªÂÉè„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíË™≠„ÅøÂèñ„Çä‰∏≠...');
                
                Tesseract.recognize(imageData, 'jpn+eng')
                    .then(result => {
                        const text = result.data.text.trim();
                        if (text) {
                            // Ë™≠„ÅøÂèñ„Å£„Åü„ÉÜ„Ç≠„Çπ„Éà„Åã„Çâ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê
                            const newTask = {
                                id: Date.now(),
                                title: `üì∑ ${file.name}„Åã„ÇâË™≠„ÅøÂèñ„Çä`,
                                deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                                priority: 'medium',
                                assignees: [getCurrentUser().name],
                                assignee: getCurrentUser().name,
                                memo: `ÁîªÂÉè„Åã„ÇâË™≠„ÅøÂèñ„Å£„Åü„ÉÜ„Ç≠„Çπ„Éà:\n${text}`,
                                columnId: 'todo',
                                completed: false,
                                createdAt: new Date().toISOString(),
                                comments: [],
                                attachments: []
                            };
                            
                            tasks.unshift(newTask);
                            saveTasks();
                            render();
                            alert(`ÁîªÂÉè„Åã„Çâ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü:\n${text.substring(0, 100)}...`);
                        } else {
                            alert('ÁîªÂÉè„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíË™≠„ÅøÂèñ„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü');
                        }
                    })
                    .catch(error => {
                        console.error('OCR error:', error);
                        alert('ÁîªÂÉè„ÅÆË™≠„ÅøÂèñ„Çä„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    });
            };
            reader.readAsDataURL(file);
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨Èñã
        window.checkTaskEvidence = checkTaskEvidence;
        window.promptForEvidence = promptForEvidence;
        // „Çø„Çπ„ÇØ„Çπ„Ç≠„ÉÉ„ÉóÊ©üËÉΩÔºàË®≠ÂÆöÁîªÈù¢Áî®Ôºâ
        function toggleTaskSkipModal(index) {
            if (previewTasks[index]) {
                previewTasks[index].isSkip = !previewTasks[index].isSkip;
                displayLineByLinePreviewModal();
            }
        }
        
        // executeImportFromModalÈñ¢Êï∞„ÅÆËøΩÂä†
        function executeImportFromModal() {
            executeImportModal();
        }
        
        // ===== „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜÊ©üËÉΩ =====
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openProjectManagementModal() {
            const modal = document.getElementById('projectManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                loadProjectsList();
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeProjectManagementModal() {
            const modal = document.getElementById('projectManagementModal');
            if (modal) {
                modal.style.display = 'none';
                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                document.getElementById('newProjectName').value = '';
                document.getElementById('newProjectDescription').value = '';
                document.getElementById('newProjectVisibility').value = 'public';
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
        function loadProjectsList() {
            try {
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                const currentUser = getCurrentUser();
                const projectsList = document.getElementById('projectsList');
                
                if (!projectsList) return;
                
                if (projects.length === 0) {
                    projectsList.innerHTML = `
                        <div style="text-align: center; color: #6b7280; padding: 2rem; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb;">
                            üìÇ „Åæ„Å†„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>
                            <span style="font-size: 0.9rem;">Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Å¶„ÉÅ„Éº„É†‰ΩúÊ•≠„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</span>
                        </div>
                    `;
                    return;
                }
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíË°®Á§∫
                projectsList.innerHTML = projects.map(project => {
                    const isOwner = project.createdBy === currentUser.email;
                    const isMember = project.members.includes(currentUser.email);
                    const canView = project.visibility === 'public' || isMember || isOwner;
                    
                    if (!canView) return '';
                    
                    const visibilityIcon = project.visibility === 'public' ? 'üåê' : 'üîí';
                    const statusIcon = project.status === 'active' ? 'üü¢' : project.status === 'completed' ? '‚úÖ' : 'üìÅ';
                    
                    return `
                        <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        ${statusIcon} ${project.name}
                                        ${visibilityIcon}
                                        ${isOwner ? '<span style="background: #fbbf24; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">‰ΩúÊàêËÄÖ</span>' : ''}
                                    </h5>
                                    <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.9rem;">${project.description || '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™¨Êòé„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'}</p>
                                    <div style="font-size: 0.8rem; color: #9ca3af;">
                                        „É°„É≥„Éê„Éº: ${project.members.length}Âêç | ‰ΩúÊàê: ${new Date(project.createdAt).toLocaleDateString('ja-JP')}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                    <button onclick="viewProjectTasks('${project.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                        üìã „Çø„Çπ„ÇØË°®Á§∫
                                    </button>
                                    ${(isOwner || currentUser.role === 'developer') ? `
                                        <button onclick="editProject('${project.id}')" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                            ‚úèÔ∏è Á∑®ÈõÜ
                                        </button>
                                        <button onclick="deleteProject('${project.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                            üóëÔ∏è ÂâäÈô§
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº:</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${project.members.map(email => {
                                        const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                                        const user = systemUsers.find(u => u.email === email);
                                        const userName = user ? user.name : email;
                                        return `<span style="background: #f3f4f6; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${userName}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).filter(html => html).join('');
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                document.getElementById('projectsList').innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 1rem;">
                        „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}
                    </div>
                `;
            }
        }
        
        // Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
        function createNewProject() {
            try {
                const name = document.getElementById('newProjectName').value.trim();
                const description = document.getElementById('newProjectDescription').value.trim();
                const visibility = document.getElementById('newProjectVisibility').value;
                const currentUser = getCurrentUser();
                
                if (!name) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (!currentUser.isLoggedIn) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }
                
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                if (projects.some(p => p.name === name)) {
                    alert('Âêå„ÅòÂêçÂâç„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô');
                    return;
                }
                
                const newProject = {
                    id: 'project_' + Date.now(),
                    name: name,
                    description: description,
                    visibility: visibility,
                    members: [currentUser.email], // ‰ΩúÊàêËÄÖ„ÅØËá™ÂãïÁöÑ„Å´„É°„É≥„Éê„Éº„Å´„Å™„Çã
                    createdBy: currentUser.email,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                };
                
                projects.push(newProject);
                localStorage.setItem('projects', JSON.stringify(projects));
                
                // Firebase„Å´„ÇÇ‰øùÂ≠òÔºàÊé•Á∂ö„Åó„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
                if (window.FirebaseAuth?.getCurrentUser() && window.firebaseConfig?.saveProject) {
                    window.firebaseConfig.saveProject(newProject);
                }
                
                console.log('‚úÖ Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê:', newProject.name);
                
                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢„Åó„Å¶‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
                document.getElementById('newProjectName').value = '';
                document.getElementById('newProjectDescription').value = '';
                document.getElementById('newProjectVisibility').value = 'public';
                
                loadProjectsList();
                
                alert(`‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ`);
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫
        function viewProjectTasks(projectId) {
            try {
                closeProjectManagementModal();
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
                const filterDropdown = document.getElementById('project-filter');
                if (filterDropdown) {
                    filterDropdown.value = projectId;
                    applyProjectFilter();
                } else {
                    // „Éï„Ç£„É´„Çø„Éº„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„Åø„ÇíË°®Á§∫
                    filterTasksByProject(projectId);
                }
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
                showProjectInfo(projectId);
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØË°®Á§∫„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åß„Çø„Çπ„ÇØ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterTasksByProject(projectId) {
            const allTasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const projectTasks = allTasks.filter(task => task.projectId === projectId);
            
            // ÁèæÂú®„ÅÆË°®Á§∫„Çí„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ„ÅÆ„Åø„Å´Êõ¥Êñ∞
            window.currentProjectFilter = projectId;
            loadTasks();
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
        function showProjectInfo(projectId) {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const project = projects.find(p => p.id === projectId);
            
            if (project) {
                // „Éò„ÉÉ„ÉÄ„Éº„Å´„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
                const header = document.querySelector('.header h1');
                if (header) {
                    header.innerHTML = `üìÇ ${project.name} - „Çø„Çπ„ÇØÁÆ°ÁêÜ`;
                }
                
                console.log(`üìÇ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${project.name}„Äç„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫‰∏≠`);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ
        function editProject(projectId) {
            try {
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                const project = projects.find(p => p.id === projectId);
                
                if (!project) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const currentUser = getCurrentUser();
                const isOwner = project.createdBy === currentUser.email;
                const isDeveloper = currentUser.role === 'developer';
                
                if (!isOwner && !isDeveloper) {
                    alert('„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÁ∑®ÈõÜ„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                showProjectEditModal(project);
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÁ∑®ÈõÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showProjectEditModal(project) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 2100;
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;
            
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const memberOptions = systemUsers.map(user => {
                const isSelected = project.members.includes(user.email);
                return `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${isSelected ? '#dbeafe' : '#f9fafb'}; border-radius: 6px; margin-bottom: 0.5rem;">
                        <input type="checkbox" value="${user.email}" ${isSelected ? 'checked' : ''} style="margin: 0;">
                        <span>${user.name} (${user.email})</span>
                    </label>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 80vh; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.25rem;">‚úèÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ</h3>
                        <button onclick="this.closest('div').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>
                    
                    <div style="padding: 1.5rem; overflow-y: auto; max-height: 60vh;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç</label>
                            <input type="text" id="editProjectName" value="${project.name}" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Ë™¨Êòé</label>
                            <textarea id="editProjectDescription" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; height: 80px; resize: vertical;">${project.description}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">ÂÖ¨ÈñãË®≠ÂÆö</label>
                            <select id="editProjectVisibility" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="public" ${project.visibility === 'public' ? 'selected' : ''}>üåê ÂÖ®Âì°„Å´ÂÖ¨Èñã</option>
                                <option value="private" ${project.visibility === 'private' ? 'selected' : ''}>üîí „É°„É≥„Éê„Éº„ÅÆ„Åø</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                            <select id="editProjectStatus" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                <option value="active" ${project.status === 'active' ? 'selected' : ''}>üü¢ „Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>‚úÖ ÂÆå‰∫Ü</option>
                                <option value="archived" ${project.status === 'archived' ? 'selected' : ''}>üìÅ „Ç¢„Éº„Ç´„Ç§„Éñ</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É°„É≥„Éê„Éº</label>
                            <div id="membersList" style="max-height: 200px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                                ${memberOptions}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="this.closest('div').remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                            <button onclick="saveProjectChanges('${project.id}', this.closest('div'))" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;">
                                ‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò
        function saveProjectChanges(projectId, modalElement) {
            try {
                const name = document.getElementById('editProjectName').value.trim();
                const description = document.getElementById('editProjectDescription').value.trim();
                const visibility = document.getElementById('editProjectVisibility').value;
                const status = document.getElementById('editProjectStatus').value;
                
                // „É°„É≥„Éê„Éº„É™„Çπ„Éà„ÇíÂèñÂæó
                const memberCheckboxes = modalElement.querySelectorAll('#membersList input[type="checkbox"]');
                const members = Array.from(memberCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (!name) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (members.length === 0) {
                    alert('Â∞ë„Å™„Åè„Å®„ÇÇ1‰∫∫„ÅÆ„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                const projectIndex = projects.findIndex(p => p.id === projectId);
                
                if (projectIndex === -1) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                projects[projectIndex] = {
                    ...projects[projectIndex],
                    name: name,
                    description: description,
                    visibility: visibility,
                    status: status,
                    members: members,
                    updatedAt: new Date().toISOString()
                };
                
                localStorage.setItem('projects', JSON.stringify(projects));
                
                // Firebase„Å´„ÇÇ‰øùÂ≠òÔºàÊé•Á∂ö„Åó„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
                if (window.FirebaseAuth?.getCurrentUser() && window.firebaseConfig?.saveProject) {
                    window.firebaseConfig.saveProject(projects[projectIndex]);
                }
                
                console.log('‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÊõ¥Êñ∞:', projects[projectIndex].name);
                
                modalElement.remove();
                loadProjectsList();
                
                alert(`‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${name}„Äç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ`);
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§
        function deleteProject(projectId) {
            try {
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                const project = projects.find(p => p.id === projectId);
                
                if (!project) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const currentUser = getCurrentUser();
                const isOwner = project.createdBy === currentUser.email;
                const isDeveloper = currentUser.role === 'developer';
                
                if (!isOwner && !isDeveloper) {
                    alert('„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                if (!confirm(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${project.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n‚ö†Ô∏è „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ\n„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Èñ¢ÈÄ£„Åô„Çã„Çø„Çπ„ÇØ„ÇÇÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ`)) {
                    return;
                }
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Èñ¢ÈÄ£„Åô„Çã„Çø„Çπ„ÇØ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const allTasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const projectTasks = allTasks.filter(task => task.projectId === projectId);
                
                if (projectTasks.length > 0) {
                    const action = confirm(`„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´„ÅØ${projectTasks.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„ÅåÈñ¢ÈÄ£‰ªò„Åë„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n\n„ÄåOK„Äç: „Çø„Çπ„ÇØ„ÇÇ‰∏ÄÁ∑í„Å´ÂâäÈô§\n„Äå„Ç≠„É£„É≥„Çª„É´„Äç: „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„ÅøÂâäÈô§Ôºà„Çø„Çπ„ÇØ„ÅØÂÄã‰∫∫„Çø„Çπ„ÇØ„Å´Â§âÊõ¥Ôºâ`);
                    
                    if (action) {
                        // „Çø„Çπ„ÇØ„ÇÇ‰∏ÄÁ∑í„Å´ÂâäÈô§
                        const remainingTasks = allTasks.filter(task => task.projectId !== projectId);
                        localStorage.setItem('tasks', JSON.stringify(remainingTasks));
                        console.log(`üóëÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ${projectTasks.length}ÂÄã„ÇíÂâäÈô§`);
                    } else {
                        // „Çø„Çπ„ÇØ„ÇíÂÄã‰∫∫„Çø„Çπ„ÇØ„Å´Â§âÊõ¥
                        projectTasks.forEach(task => {
                            delete task.projectId;
                            task.visibility = 'personal';
                        });
                        localStorage.setItem('tasks', JSON.stringify(allTasks));
                        console.log(`üîÑ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØ${projectTasks.length}ÂÄã„ÇíÂÄã‰∫∫„Çø„Çπ„ÇØ„Å´Â§âÊõ¥`);
                    }
                }
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§
                const updatedProjects = projects.filter(p => p.id !== projectId);
                localStorage.setItem('projects', JSON.stringify(updatedProjects));
                
                // Firebase„Åã„Çâ„ÇÇÂâäÈô§ÔºàÊé•Á∂ö„Åó„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
                if (window.FirebaseAuth?.getCurrentUser() && window.firebaseConfig?.deleteProject) {
                    window.firebaseConfig.deleteProject(projectId);
                }
                
                console.log('üóëÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§:', project.name);
                
                loadProjectsList();
                loadTasks(); // „Çø„Çπ„ÇØ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                
                alert(`üóëÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${project.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
                
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // FirebaseÁßªË°å„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showFirebaseMigrationModal() {
            if (!window.FirebaseAuth?.getCurrentUser()) {
                alert('üî• FirebaseÁßªË°å„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\n\nFirebaseË™çË®º„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åã„Çâ„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const modalHTML = `
                <div id="firebase-migration-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) closeFirebaseMigrationModal()">
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748;">üî• Firebase„Éá„Éº„ÇøÁßªË°å</h3>
                            <button onclick="closeFirebaseMigrationModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #a0aec0; padding: 0.5rem;">&times;</button>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #2196f3;">
                            <div style="font-size: 0.9rem; color: #1565c0; line-height: 1.5;">
                                üí° <strong>Firebase„ÇØ„É©„Ç¶„ÉâÂêåÊúü„Å´„Å§„ÅÑ„Å¶</strong><br>
                                LocalStorage„ÅÆ„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÇíFirebase„ÇØ„É©„Ç¶„Éâ„Å´ÁßªË°å„Åô„Çã„Åì„Å®„ÅßÔºö<br>
                                ‚úÖ Ë§áÊï∞„Éá„Éê„Ç§„ÇπÈñì„Åß„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü<br>
                                ‚úÖ „Éá„Éº„Çø„ÅÆÊ∞∏Á∂öÂåñ„Å®ÂÆâÂÖ®ÊÄßÂêë‰∏ä<br>
                                ‚úÖ ‰ªñ„É¶„Éº„Ç∂„Éº„Å®„ÅÆ„Çø„Çπ„ÇØÂÖ±ÊúâÔºàÂ∞ÜÊù•ÂØæÂøúÔºâ<br>
                                ‚Äª ÁßªË°åÂæå„ÇÇLocalStorage„ÅÆ„Éá„Éº„Çø„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„Åô
                            </div>
                        </div>
                        
                        <div id="migration-status" style="margin-bottom: 1rem;"></div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closeFirebaseMigrationModal()" style="padding: 0.75rem 1.5rem; background: #e4e6eb; color: #172b4d; border: none; border-radius: 6px; cursor: pointer;">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="startFirebaseMigration()" style="padding: 0.75rem 1.5rem; background: #026aa7; color: white; border: none; border-radius: 6px; cursor: pointer;">ÁßªË°åÈñãÂßã</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeFirebaseMigrationModal() {
            const modal = document.getElementById('firebase-migration-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function startFirebaseMigration() {
            const statusDiv = document.getElementById('migration-status');
            
            try {
                statusDiv.innerHTML = '<div style="text-align: center; padding: 1rem;"><div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #026aa7; border-radius: 50%; animation: spin 1s linear infinite;"></div> ÁßªË°å‰∏≠...</div>';
                
                // LocalStorage„ÅÆ„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÇíÂèñÂæó
                const localTasks = JSON.parse(localStorage.getItem('salesTasksKanban') || '[]');
                
                if (localTasks.length === 0) {
                    statusDiv.innerHTML = '<div style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 6px;">‚ö†Ô∏è ÁßªË°å„Åô„Çã„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';
                    return;
                }
                
                // FirebaseÁßªË°å„ÇíÂÆüË°å
                const result = await window.FirebaseMigration.migrateFromLocalStorage();
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            ‚úÖ ÁßªË°åÂÆå‰∫Ü: ${result.migratedCount}/${result.totalCount} „Çø„Çπ„ÇØ„ÇíFirebase„Å´ÁßªË°å„Åó„Åæ„Åó„Åü
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            „Åì„Çå„ÅßË§áÊï∞„Éá„Éê„Ç§„ÇπÈñì„Åß„Çø„Çπ„ÇØ„ÅåÂêåÊúü„Åï„Çå„Åæ„Åô„ÄÇ<br>
                            Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÅØËá™ÂãïÁöÑ„Å´Firebase„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ
                        </div>
                    `;
                    
                    // 3ÁßíÂæå„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    setTimeout(() => {
                        closeFirebaseMigrationModal();
                        // „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶Firebase„Éá„Éº„Çø„ÇíÂèçÊò†
                        if (confirm('ÁßªË°å„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶Firebase„Éá„Éº„Çø„ÇíË°®Á§∫„Åó„Åæ„Åô„ÅãÔºü')) {
                            window.location.reload();
                        }
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 6px;">‚ùå ÁßªË°å„Ç®„É©„Éº: ${result.error}</div>`;
                }
                
            } catch (error) {
                console.error('‚ùå FirebaseÁßªË°å„Ç®„É©„Éº:', error);
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 6px;">‚ùå ÁßªË°å‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}</div>`;
            }
        }
        
        window.deleteTask = deleteTask;
        window.toggleHamburgerMenu = toggleHamburgerMenu;
        window.updateHamburgerMenu = updateHamburgerMenu;
        window.logout = logout;
        window.handleFileImport = handleFileImport;
        window.processImportText = processImportText;
        window.toggleTaskSkipModal = toggleTaskSkipModal;
        window.executeImportFromModal = executeImportFromModal;
        window.showFirebaseMigrationModal = showFirebaseMigrationModal;
    </script>
    
    <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº -->
    <div class="hamburger-menu" id="hamburger-menu">
        <div class="user-menu-info">
            <div class="user-menu-avatar" id="user-menu-avatar">-</div>
            <div class="user-menu-name" id="user-menu-name">„Ç≤„Çπ„Éà</div>
            <div class="user-menu-role" id="user-menu-role">Êú™„É≠„Ç∞„Ç§„É≥</div>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">ÂÄã‰∫∫Ë®≠ÂÆö</div>
            <a href="my-profile.html" class="menu-item" onclick="toggleHamburgerMenu();">
                <span>üë§</span>
                <span>„Éû„Ç§„Éö„Éº„Ç∏</span>
            </a>
            <a href="#" class="menu-item" onclick="openSettingsModal(); toggleHamburgerMenu(); return false;">
                <span>‚öôÔ∏è</span>
                <span>Âü∫Êú¨Ë®≠ÂÆö</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„Ç´„É©„É†„ÉªÈÄöÁü•„Éª„ÉÜ„Éº„ÉûË®≠ÂÆö</div>
            </a>
            <a href="#" class="menu-item" onclick="showFirebaseMigrationModal(); toggleHamburgerMenu(); return false;">
                <span>üî•</span>
                <span>Firebase„Éá„Éº„ÇøÁßªË°å</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„Çø„Çπ„ÇØ„Çí„ÇØ„É©„Ç¶„Éâ„Å´ÂêåÊúü„ÉªÁ´ØÊú´ÈñìÂÖ±Êúâ</div>
            </a>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">„Çø„Çπ„ÇØÁÆ°ÁêÜ</div>
            <a href="#" class="menu-item" onclick="openTemplateManagementModal(); toggleHamburgerMenu(); return false;">
                <span>üìã</span>
                <span>„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàË°®Á§∫„Éª‰ΩúÊàê„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§</div>
            </a>
            <a href="#" class="menu-item" onclick="openTaskImportModal(); toggleHamburgerMenu(); return false;">
                <span>üìù</span>
                <span>„ÉÜ„Ç≠„Çπ„Éà„ÉªOCR„Ç§„É≥„Éù„Éº„Éà</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„ÉÜ„Ç≠„Çπ„Éà„ÉªÁîªÂÉè„Åã„Çâ„Çø„Çπ„ÇØ‰ΩúÊàê</div>
            </a>
            <a href="#" class="menu-item" onclick="showTaskRecoveryModal(); toggleHamburgerMenu(); return false;">
                <span>üîÑ</span>
                <span>„Çø„Çπ„ÇØÂæ©Êóß</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">Ê∂àÂ§±„Åó„Åü„Çø„Çπ„ÇØ„ÅÆÂæ©Êóß„Éª„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁÆ°ÁêÜ</div>
            </a>
            <a href="#" class="menu-item" onclick="manualRestore(); toggleHamburgerMenu(); return false;">
                <span>üö®</span>
                <span>Á∑äÊÄ•Âæ©Êóß</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„É™„Ç¢„É´„Çø„Ç§„É†‰øùË≠∑„Ç∑„Çπ„ÉÜ„É†„Åã„Çâ„ÅÆÂæ©Êóß</div>
            </a>
            <a href="#" class="menu-item" onclick="ultimateRecover(); toggleHamburgerMenu(); return false;">
                <span>‚ö°</span>
                <span>Á©∂Ê•µÂæ©Êóß</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">Á©∂Ê•µ‰øùË≠∑„Ç∑„Çπ„ÉÜ„É†„Åã„Çâ„ÅÆÂç≥Â∫ßÂæ©Êóß</div>
            </a>
        </div>
        
        <div class="menu-section" id="developer-menu-section" style="display: none;">
            <div class="menu-section-title">ÈñãÁô∫Ê©üËÉΩ</div>
            <a href="#" class="menu-item" onclick="openDevelopmentLog(); toggleHamburgerMenu(); return false;">
                <span>üìù</span>
                <span>Ê©üËÉΩÊîπÂñÑÊõ∏</span>
            </a>
        </div>
        
        <!-- PJË®≠ÂÆö„ÅØÂÖ®„É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ -->
        <div class="menu-section">
            <div class="menu-section-title">„Éó„É≠„Ç∏„Çß„ÇØ„Éà</div>
            <a href="#" class="menu-item" onclick="openProjectManagementModal(); toggleHamburgerMenu(); return false;">
                <span>üìÇ</span>
                <span>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Éª„É°„É≥„Éê„ÉºÁÆ°ÁêÜ„ÉªÂÖ±ÊúâË®≠ÂÆö</div>
            </a>
            <a href="pj-settings.html" class="menu-item" onclick="toggleHamburgerMenu();">
                <span>üèóÔ∏è</span>
                <span>PJË®≠ÂÆö„ÉªÁÆ°ÁêÜ</span>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Éª„Ç´„É©„É†Ë®≠ÂÆö</div>
            </a>
        </div>

        <div class="menu-section" id="admin-menu-section" style="display: none;">
            <div class="menu-section-title">ÁÆ°ÁêÜÊ©üËÉΩ</div>
            <a href="user-management.html" class="menu-item" onclick="toggleHamburgerMenu();">
                <span>üë•</span>
                <span>„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</span>
            </a>
            <a href="admin-dashboard.html" class="menu-item" onclick="toggleHamburgerMenu();">
                <span>üìä</span>
                <span>ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
            </a>
        </div>
        
        <div class="menu-section">
            <div class="menu-section-title">„Åù„ÅÆ‰ªñ</div>
            <a href="#" class="menu-item" onclick="logout(); toggleHamburgerMenu(); return false;">
                <span>üö™</span>
                <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
            </a>
        </div>
    </div>
    
    <!-- „É°„Éã„É•„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleHamburgerMenu()"></div>
    
    <!-- Èö†„Åó„Éï„Ç°„Ç§„É´ÂÖ•Âäõ -->
    <input type="file" id="file-import" accept=".csv,.xlsx,.xls,.txt,.png,.jpg,.jpeg" multiple style="display: none;" onchange="handleFileImport(event)">
</body>
</html><!-- Cache bust: 1754211273 -->
<!-- UI Update: 1754211273 -->
<!-- EMERGENCY FIX: Force cache refresh for PJ creation feature -->
