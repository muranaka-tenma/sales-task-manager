<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>👥 ユーザー管理 - 営業タスク管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #026aa7;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .user-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .form-input, .form-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #026aa7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #025aa0;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .users-table th,
        .users-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .users-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .role-developer {
            background: #fbb6ce;
            color: #97266d;
        }
        
        .role-admin {
            background: #fed7d7;
            color: #c53030;
        }
        
        .role-user {
            background: #c6f6d5;
            color: #38a169;
        }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .back-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>👥 ユーザー管理</h1>
            <a href="index-kanban.html" class="back-link">← メインページに戻る</a>
        </div>
        
        <div class="content">
            <div id="success-message" class="success-message">
                ✅ ユーザー情報が更新されました
            </div>
            
            <div class="section">
                <h2>新規ユーザー追加</h2>
                <div class="user-form">
                    <form id="user-form" onsubmit="addUser(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">名前 *</label>
                                <input type="text" class="form-input" id="user-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">メールアドレス *</label>
                                <input type="email" class="form-input" id="user-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">権限 *</label>
                                <select class="form-select" id="user-role" required>
                                    <option value="user">一般ユーザー</option>
                                    <option value="admin">管理者</option>
                                    <option value="developer">開発者</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">部署</label>
                                <input type="text" class="form-input" id="user-department" placeholder="例: 営業部">
                            </div>
                            <div class="form-group">
                                <label class="form-label">初期パスワード *</label>
                                <input type="password" class="form-input" id="user-password" required placeholder="8文字以上">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button type="submit" class="btn btn-primary">ユーザー追加</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="section">
                <h2>登録済みユーザー一覧</h2>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>名前</th>
                            <th>メールアドレス</th>
                            <th>権限</th>
                            <th>部署</th>
                            <th>登録日</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <!-- ユーザー一覧がここに表示される -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // 認証チェック（管理者権限も確認）
        function checkAuthentication() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (!session) {
                    window.location.href = 'login.html';
                    return false;
                }
                if (new Date() > new Date(session.expiresAt)) {
                    localStorage.removeItem('currentSession');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // 管理者権限チェック
                if (!['admin', 'developer'].includes(session.user.role)) {
                    alert('この機能は管理者のみ利用可能です。');
                    window.location.href = 'index-kanban.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // 認証チェックを実行
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }
        
        // ユーザー管理システム
        let users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
        
        
        // 初回起動時に必要ユーザーのみを作成（不要ユーザー削除済み）
        if (users.length === 0) {
            const essentialUsers = [
                {
                    id: 1,
                    name: '邨中天真',
                    email: 'muranaka-tenma@terracom.co.jp',
                    role: 'developer',
                    department: '開発部',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'admin123'
                },
                {
                    id: 2,
                    name: '加藤純',
                    email: 'kato-jun@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'kato123'
                },
                {
                    id: 3,
                    name: '朝日圭一',
                    email: 'asahi-keiichi@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'asahi123'
                },
                {
                    id: 4,
                    name: '半澤侑果',
                    email: 'hanzawa-yuka@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'hanzawa123'
                },
                {
                    id: 5,
                    name: '田村渉',
                    email: 'tamura-wataru@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'tamura123'
                },
                {
                    id: 6,
                    name: '橋本友美',
                    email: 'hashimoto-yumi@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'hashimoto123'
                },
                {
                    id: 7,
                    name: '福島亜未',
                    email: 'fukushima-ami@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'fukushima123'
                }
            ];
            users.push(...essentialUsers);
            saveUsers();
            console.log('🗑️ [CLEANUP] 不要ユーザー削除完了: システム管理者・テストユーザー');
        }
        
        // ページ読み込み時に実行
        window.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });
        
        // 新規ユーザーの動的統合機能（マルチデバイス対応）
        function addUserToDynamicDatabase(newUser) {
            try {
                // 1. 既存の動的ユーザーを取得
                let dynamicUsers = [];
                const stored = localStorage.getItem('dynamicUsers');
                if (stored) {
                    dynamicUsers = JSON.parse(stored);
                }
                
                // 2. 重複チェック
                const exists = dynamicUsers.find(u => u.email === newUser.email);
                if (exists) {
                    console.log('⚠️ [DYNAMIC] ユーザーは既に動的DBに存在:', newUser.email);
                    return false;
                }
                
                // 3. 動的ユーザーとして追加
                const dynamicUser = {
                    ...newUser,
                    isDynamic: true, // 動的ユーザーマーク
                    addedAt: new Date().toISOString()
                };
                
                dynamicUsers.push(dynamicUser);
                localStorage.setItem('dynamicUsers', JSON.stringify(dynamicUsers));
                
                console.log('✅ [DYNAMIC] 新規ユーザーを動的DBに追加:', newUser.name);
                console.log('🔄 [DYNAMIC] 現在の動的ユーザー数:', dynamicUsers.length);
                
                return true;
            } catch (e) {
                console.error('⚠️ [DYNAMIC] 動的ユーザー追加エラー:', e);
                return false;
            }
        }
        
        function addUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const role = document.getElementById('user-role').value;
            const department = document.getElementById('user-department').value.trim();
            const password = document.getElementById('user-password').value;
            
            // バリデーション
            if (password.length < 8) {
                alert('パスワードは8文字以上で設定してください');
                return;
            }
            
            // 重複チェック
            if (users.some(u => u.email === email)) {
                alert('このメールアドレスは既に登録されています');
                return;
            }
            
            // 新規ユーザー作成
            const newUser = {
                id: Date.now(),
                name: name,
                email: email,
                role: role,
                department: department,
                password: password, // 実際の運用では暗号化が必要
                createdAt: new Date().toISOString()
            };
            
            // 通常のLocalStorageへ追加
            users.push(newUser);
            saveUsers();
            
            // マルチデバイス対応: 動的ユーザーとしても追加
            const dynamicSuccess = addUserToDynamicDatabase(newUser);
            
            // 担当者リストにも追加
            updateAssigneesList();
            
            // フォームリセット
            document.getElementById('user-form').reset();
            
            // 成功メッセージ表示
            showSuccess();
            
            // ユーザー一覧更新
            loadUsers();
            
            const status = dynamicSuccess ? 'マルチデバイス対応で追加' : 'ローカルのみで追加';
            console.log(`✅ 新規ユーザー追加 (${status}):`, newUser.name, newUser.email, newUser.role);
        }
        
        function loadUsers() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td>${user.department || '-'}</td>
                    <td>${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="editUser(${user.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">編集</button>
                            <button class="btn btn-secondary" onclick="changePassword(${user.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">パスワード</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">削除</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': '開発者',
                'admin': '管理者',
                'user': '一般ユーザー'
            };
            return roleNames[role] || role;
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const newRole = prompt('新しい権限を選択してください:\ndeveloper: 開発者\nadmin: 管理者\nuser: 一般ユーザー', user.role);
            
            if (newRole && ['developer', 'admin', 'user'].includes(newRole)) {
                user.role = newRole;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                loadUsers();
                showSuccess();
                console.log('✅ ユーザー権限更新:', user.name, newRole);
            }
        }
        
        function changePassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // 開発者権限のみパスワード変更可能
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (!currentSession || currentSession.user.role !== 'developer') {
                alert('パスワード変更は開発者権限が必要です。');
                return;
            }
            
            const newPassword = prompt(`${user.name}の新しいパスワードを入力してください:`, '');
            
            if (newPassword) {
                // パスワードの最低要件チェック
                if (newPassword.length < 4) {
                    alert('パスワードは4文字以上で設定してください。');
                    return;
                }
                
                // パスワード更新
                user.password = newPassword;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                
                alert(`✅ ${user.name}のパスワードを変更しました。\n新しいパスワード: ${newPassword}`);
                console.log('🔑 パスワード変更:', user.name, `(${user.email})`);
            }
        }
        
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`${user.name}を削除しますか？\nこの操作は取り消せません。`)) {
                const deletedUserName = user.name;
                
                // ユーザーリストから削除
                users = users.filter(u => u.id !== userId);
                saveUsers();
                
                // 担当者リストからも削除（表示対象同期）
                removeFromAssigneesList(deletedUserName);
                
                loadUsers();
                showSuccess();
                console.log('🗑️ ユーザー削除:', deletedUserName, '- 担当者リストからも削除済み');
            }
        }
        
        function saveUsers() {
            localStorage.setItem('systemUsers', JSON.stringify(users));
        }
        
        function updateAssigneesList() {
            // 既存の担当者リストに新規ユーザーを追加
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            
            users.forEach(user => {
                if (!assignees.includes(user.name)) {
                    assignees.push(user.name);
                }
            });
            
            localStorage.setItem('taskAssignees', JSON.stringify(assignees));
        }
        
        function removeFromAssigneesList(userName) {
            // 担当者リストから削除（表示対象同期）
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            const updatedAssignees = assignees.filter(name => name !== userName);
            localStorage.setItem('taskAssignees', JSON.stringify(updatedAssignees));
            console.log('📝 担当者リスト更新:', `"${userName}"を削除`, updatedAssignees);
        }
        
        function showSuccess() {
            const successMsg = document.getElementById('success-message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>