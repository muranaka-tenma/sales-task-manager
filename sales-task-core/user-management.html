<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>👥 ユーザー管理 - 営業タスク管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #026aa7;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .user-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .form-input, .form-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #026aa7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #025aa0;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .users-table th,
        .users-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .users-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .role-developer {
            background: #fbb6ce;
            color: #97266d;
        }
        
        .role-admin {
            background: #fed7d7;
            color: #c53030;
        }
        
        .role-user {
            background: #c6f6d5;
            color: #38a169;
        }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .back-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>👥 ユーザー管理</h1>
            <a href="index-kanban.html" class="back-link">← メインページに戻る</a>
        </div>
        
        <div class="content">
            <div id="success-message" class="success-message">
                ✅ ユーザー情報が更新されました
            </div>
            
            <div class="section">
                <h2>新規ユーザー追加</h2>
                <div class="user-form">
                    <form id="user-form" onsubmit="addUser(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">名前 *</label>
                                <input type="text" class="form-input" id="user-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">メールアドレス *</label>
                                <input type="email" class="form-input" id="user-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">権限 *</label>
                                <select class="form-select" id="user-role" required>
                                    <option value="user">一般ユーザー</option>
                                    <option value="admin">管理者</option>
                                    <option value="developer">開発者</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">部署</label>
                                <input type="text" class="form-input" id="user-department" placeholder="例: 営業部">
                            </div>
                            <div class="form-group">
                                <label class="form-label">初期パスワード *</label>
                                <input type="password" class="form-input" id="user-password" required placeholder="8文字以上">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button type="submit" class="btn btn-primary">ユーザー追加</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="section">
                <h2>登録済みユーザー一覧</h2>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>名前</th>
                            <th>メールアドレス</th>
                            <th>権限</th>
                            <th>部署</th>
                            <th>登録日</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <!-- ユーザー一覧がここに表示される -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // 認証チェック（管理者権限も確認）
        function checkAuthentication() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (!session) {
                    window.location.href = 'login.html';
                    return false;
                }
                if (new Date() > new Date(session.expiresAt)) {
                    localStorage.removeItem('currentSession');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // 管理者権限チェック（詳細デバッグ付き）
                console.log('🔐 [PERM-CHECK] セッション権限チェック:', {
                    userRole: session.user.role,
                    userName: session.user.name,
                    userEmail: session.user.email,
                    isAdmin: ['admin', 'developer'].includes(session.user.role),
                    sessionData: session.user
                });
                
                if (!['admin', 'developer'].includes(session.user.role)) {
                    console.error('❌ [PERM-CHECK] 権限チェック失敗:', session.user.role, '!= admin or developer');
                    alert(`この機能は管理者のみ利用可能です。\n現在の権限: ${session.user.role}\n必要な権限: admin または developer`);
                    window.location.href = 'index-kanban.html';
                    return false;
                } else {
                    console.log('✅ [PERM-CHECK] 権限チェック成功:', session.user.role);
                }
                
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // 権限完全性チェック関数（index-kanban.htmlと同じ）
        function ensureUserPermissionsIntegrity() {
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const correctRoles = {
                'muranaka-tenma@terracom.co.jp': 'developer',
                'kato-jun@terracom.co.jp': 'admin',
                'asahi-keiichi@terracom.co.jp': 'admin',
                'hanzawa-yuka@terracom.co.jp': 'user',
                'tamura-wataru@terracom.co.jp': 'user',
                'hashimoto-yumi@terracom.co.jp': 'user',
                'fukushima-ami@terracom.co.jp': 'user'
            };
            
            let corrected = false;
            let allUsersAreUser = systemUsers.length > 0 && systemUsers.every(user => user.role === 'user');
            
            if (allUsersAreUser) {
                console.warn('⚠️ [USER-MGMT-CRITICAL] 全ユーザーがuserになっている - 緊急修復実行');
            }
            
            // 🔧 強制的に正しい権限を適用（ユーザー管理画面版）
            systemUsers.forEach(user => {
                const correctRole = correctRoles[user.email];
                if (correctRole) {
                    const oldRole = user.role;
                    user.role = correctRole; // 強制的に正しい権限に設定
                    if (oldRole !== correctRole) {
                        console.log(`🔧 [USER-MGMT-FORCE] ${user.name}: ${oldRole} → ${correctRole} (強制修正)`);
                        corrected = true;
                    }
                }
            });
            
            // 🔄 常に保存（強制修正）
            localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
            console.log('✅ [USER-MGMT-FORCE] ユーザー管理画面で権限の完全性を強制修復');
            
            // 🔍 修正後の権限状況を確認表示
            console.log('📋 [USER-MGMT-STATUS] 修正後の権限状況:');
            systemUsers.forEach(user => {
                const roleEmoji = user.role === 'developer' ? '👨‍💻' : 
                                 user.role === 'admin' ? '👤' : '🧑‍💼';
                console.log(`  ${roleEmoji} ${user.name} (${user.email}) - ${user.role}`);
            });
            
            return corrected;
        }
        
        // 認証チェックを実行
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }
        
        // ユーザー管理システム（Firebase統合対応）
        let users = [];
        
        
        // 初回起動時に必要ユーザーのみを作成（不要ユーザー削除済み）
        if (users.length === 0) {
            const essentialUsers = [
                {
                    id: 1,
                    name: '邨中天真',
                    email: 'muranaka-tenma@terracom.co.jp',
                    role: 'developer',
                    department: '開発部',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'Tenma7041'
                },
                {
                    id: 2,
                    name: '加藤純',
                    email: 'kato-jun@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 3,
                    name: '朝日圭一',
                    email: 'asahi-keiichi@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 4,
                    name: '半澤侑果',
                    email: 'hanzawa-yuka@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 5,
                    name: '田村渉',
                    email: 'tamura-wataru@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 6,
                    name: '橋本友美',
                    email: 'hashimoto-yumi@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 7,
                    name: '福島亜未',
                    email: 'fukushima-ami@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                }
            ];
            users.push(...essentialUsers);
            saveUsers();
            console.log('🗑️ [CLEANUP] 不要ユーザー削除完了: システム管理者・テストユーザー');
        }
        
        // Firebase認証待ち処理
        async function waitForFirebaseAuth(maxWaitTime = 5000) {
            return new Promise((resolve) => {
                let waited = 0;
                const checkInterval = 100;
                
                const checkAuth = () => {
                    if (window.FirebaseAuth?.getCurrentUser() && window.FirebaseDB) {
                        console.log('✅ [USER-MGMT] Firebase認証確認完了');
                        resolve(true);
                    } else if (waited >= maxWaitTime) {
                        console.warn('⚠️ [USER-MGMT] Firebase認証タイムアウト - LocalStorageフォールバック');
                        resolve(false);
                    } else {
                        waited += checkInterval;
                        setTimeout(checkAuth, checkInterval);
                    }
                };
                checkAuth();
            });
        }
        
        // ページ読み込み時に実行（Firebase認証待ち対応）
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🔄 [USER-MGMT] Firebase認証を待機中...');
                
                // 🔧 権限完全性チェックを最初に実行
                ensureUserPermissionsIntegrity();
                
                await waitForFirebaseAuth();
                await loadUsers();
            } catch (error) {
                console.error('❌ [USER-MGMT] 初期ユーザー読み込みエラー:', error);
                // エラー時もLocalStorageフォールバックで読み込み
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const tbody = document.getElementById('users-list');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                        <td>${user.department || '-'}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-secondary" onclick="editUser('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">編集</button>
                                <button class="btn btn-secondary" onclick="changePassword('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">パスワード</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">削除</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });
        
        // 新規ユーザーの動的統合機能（マルチデバイス対応）
        function addUserToDynamicDatabase(newUser) {
            try {
                // 1. 既存の動的ユーザーを取得
                let dynamicUsers = [];
                const stored = localStorage.getItem('dynamicUsers');
                if (stored) {
                    dynamicUsers = JSON.parse(stored);
                }
                
                // 2. 重複チェック
                const exists = dynamicUsers.find(u => u.email === newUser.email);
                if (exists) {
                    console.log('⚠️ [DYNAMIC] ユーザーは既に動的DBに存在:', newUser.email);
                    return false;
                }
                
                // 3. 動的ユーザーとして追加
                const dynamicUser = {
                    ...newUser,
                    isDynamic: true, // 動的ユーザーマーク
                    addedAt: new Date().toISOString()
                };
                
                dynamicUsers.push(dynamicUser);
                localStorage.setItem('dynamicUsers', JSON.stringify(dynamicUsers));
                
                console.log('✅ [DYNAMIC] 新規ユーザーを動的DBに追加:', newUser.name);
                console.log('🔄 [DYNAMIC] 現在の動的ユーザー数:', dynamicUsers.length);
                
                return true;
            } catch (e) {
                console.error('⚠️ [DYNAMIC] 動的ユーザー追加エラー:', e);
                return false;
            }
        }
        
        async function addUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const role = document.getElementById('user-role').value;
            const department = document.getElementById('user-department').value.trim();
            const password = document.getElementById('user-password').value;
            
            // バリデーション
            if (password.length < 8) {
                alert('パスワードは8文字以上で設定してください');
                return;
            }
            
            // 重複チェック
            if (users.some(u => u.email === email)) {
                alert('このメールアドレスは既に登録されています');
                return;
            }
            
            try {
                // Firebase統合 - ユーザー作成
                if (window.FirebaseAuth && window.FirebaseDB) {
                    console.log('🔥 [USER-MGMT] Firebase Authでユーザーを作成中...', email);
                    
                    // Firebase Authでユーザー作成
                    const authResult = await window.FirebaseAuth.createUser(email, password, name);
                    
                    if (authResult.success) {
                        console.log('✅ [FIREBASE] Firebase Authユーザー作成成功:', authResult.user.uid);
                        
                        // 新規ユーザーデータ
                        const newUser = {
                            id: Date.now(),
                            uid: authResult.user.uid,
                            name: name,
                            email: email,
                            role: role,
                            department: department,
                            createdAt: new Date().toISOString()
                        };
                        
                        // LocalStorageに追加（フォールバック用）
                        users.push(newUser);
                        saveUsers();
                        
                        // 担当者リストにも追加
                        updateAssigneesList();
                        
                        // 成功メッセージ表示
                        showSuccess();
                        console.log('✅ [FIREBASE] 新規ユーザー追加成功:', name, email, role);
                        
                    } else if (authResult.error && authResult.error.includes('email-already-in-use')) {
                        // メールアドレスが既に使用されている場合
                        console.log('⚠️ [FIREBASE] メールアドレス既存 - 既存ユーザーとして登録:', email);
                        
                        // 既存のFirebaseユーザーを利用してFirestoreに追加
                        const newUser = {
                            id: Date.now(),
                            name: name,
                            email: email,
                            role: role,
                            department: department,
                            createdAt: new Date().toISOString(),
                            isFirebaseExisting: true // 既存Firebase認証ユーザー
                        };
                        
                        users.push(newUser);
                        saveUsers();
                        updateAssigneesList();
                        showSuccess();
                        console.log('✅ [FIREBASE-EXISTING] 既存Firebaseユーザーを追加:', name, email, role);
                        alert(`✅ ユーザー「${name}」を追加しました。\n\n※ このメールアドレスは既にFirebase認証に登録済みです。\n既存のFirebaseパスワードでログイン可能です。`);
                    } else {
                        console.error('❌ [FIREBASE] Firebase Authユーザー作成エラー:', authResult.error);
                        alert(`ユーザー作成エラー: ${authResult.error}`);
                        return;
                    }
                } else {
                    throw new Error('Firebase未対応');
                }
            } catch (error) {
                console.warn('⚠️ [USER-MGMT] Firebase作成エラー - LocalStorageフォールバック:', error);
                
                // LocalStorageフォールバック
                const newUser = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    role: role,
                    department: department,
                    password: password, // LocalStorageでは保持
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
                saveUsers();
                updateAssigneesList();
                showSuccess();
                console.log('✅ [LOCAL] 新規ユーザー追加（LocalStorageのみ）:', name, email, role);
            }
            
            // フォームリセット
            document.getElementById('user-form').reset();
            
            // ユーザー一覧更新
            await loadUsers();
        }
        
        // Firebase統合 - ユーザー一覧読み込み
        async function loadUsers() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #666;">読み込み中...</td></tr>';
            
            try {
                // Firebase認証チェック（より厳密）
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (window.FirebaseDB && window.FirebaseDB.getUsers && currentUser) {
                    console.log('🔥 [USER-MGMT] Firestoreからユーザー一覧を読み込み中...', currentUser.email);
                    const result = await window.FirebaseDB.getUsers();
                    
                    if (result.success) {
                        users = result.users.map(user => ({
                            id: user.uid || user.id,
                            name: user.displayName || user.name,
                            email: user.email,
                            role: user.role || 'user',
                            department: user.department || '-',
                            createdAt: user.createdAt,
                            uid: user.uid || user.id,
                            isDisabled: user.isDisabled || false,
                            disabledAt: user.disabledAt,
                            disabledBy: user.disabledBy
                        }));
                        console.log('✅ [FIREBASE] ユーザー一覧取得成功:', users.length, '件');
                        
                        // LocalStorageにも保存（フォールバック用）
                        localStorage.setItem('systemUsers', JSON.stringify(users));
                    } else {
                        console.warn('⚠️ [FIREBASE] Firestore読み込み失敗 - LocalStorageフォールバック');
                        throw new Error('Firebase読み込み失敗');
                    }
                } else {
                    const authStatus = currentUser ? 'ユーザー認証済み' : '未認証';
                    const dbStatus = window.FirebaseDB ? 'DB接続済み' : 'DB未接続';
                    throw new Error(`Firebase未準備 (${authStatus}, ${dbStatus})`);
                }
            } catch (error) {
                console.warn('⚠️ [USER-MGMT] Firebase読み込みエラー - LocalStorageフォールバック:', error);
                // LocalStorageフォールバック
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                
                // 🔧 権限完全性チェック（user-management画面用）
                ensureUserPermissionsIntegrity();
                // 修復後に再読み込み
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            }
            
            // UIを更新
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                // ローカル専用ユーザーかFirebaseユーザーかを判定
                const userType = user.isLocalOnly ? '📁 ローカル' : (user.uid ? '🔥 Firebase' : '📁 ローカル');
                const userTypeClass = user.isLocalOnly ? 'local-user' : (user.uid ? 'firebase-user' : 'local-user');
                
                // ユーザー状態のスタイリング
                const isDisabled = user.isDisabled;
                const isHidden = user.isHidden;
                
                let statusStyle = '';
                let statusText = '';
                let statusInfo = '';
                
                if (isHidden) {
                    statusStyle = 'opacity: 0.3; background-color: #f5f5f5; text-decoration: line-through;';
                    statusText = ` <span style="color: #6b7280; font-weight: bold;">👻 非表示</span>`;
                    statusInfo = ` <br><small style="color: #666;">非表示化: ${user.hiddenAt ? new Date(user.hiddenAt).toLocaleDateString('ja-JP') : '不明'} by ${user.hiddenBy || '不明'}</small>`;
                } else if (isDisabled) {
                    statusStyle = 'opacity: 0.5; background-color: #f9f9f9;';
                    statusText = ` <span style="color: #e53e3e; font-weight: bold;">🚫 無効化済</span>`;
                    statusInfo = ` <br><small style="color: #666;">無効化: ${user.disabledAt ? new Date(user.disabledAt).toLocaleDateString('ja-JP') : '不明'} by ${user.disabledBy || '不明'}</small>`;
                }
                
                // ユーザーの状態に基づいてボタンを制御
                let actionButtons = '';
                if (user.isHidden) {
                    // 非表示ユーザー: 復旧と完全削除
                    actionButtons = `
                        <button class="btn btn-primary" onclick="restoreUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">復旧</button>
                        <button class="btn btn-danger" onclick="permanentDeleteUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">完全削除</button>
                    `;
                } else if (isDisabled) {
                    // 無効化ユーザー: 復旧と非表示
                    actionButtons = `
                        <button class="btn btn-primary" onclick="restoreUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">復旧</button>
                        <button class="btn btn-warning" onclick="hideUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">非表示化</button>
                    `;
                } else {
                    // 通常ユーザー: 編集・パスワード・無効化
                    actionButtons = `
                        <button class="btn btn-secondary" onclick="editUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">編集</button>
                        <button class="btn btn-secondary" onclick="changePassword('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">パスワード</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">無効化</button>
                    `;
                }
                
                row.innerHTML = `
                    <td style="${statusStyle}">${user.name} <small style="color: #666;">(${userType})</small>${statusText}${statusInfo}</td>
                    <td style="${statusStyle}">${user.email}</td>
                    <td style="${statusStyle}"><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td style="${statusStyle}">${user.department || '-'}</td>
                    <td style="${statusStyle}">${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                    <td style="${statusStyle}">
                        <div class="actions">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                row.className = userTypeClass;
                tbody.appendChild(row);
            });
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': '開発者',
                'admin': '管理者',
                'user': '一般ユーザー'
            };
            return roleNames[role] || role;
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user) {
                console.error('❌ ユーザーが見つかりません:', userId);
                return;
            }
            
            const newRole = prompt('新しい権限を選択してください:\ndeveloper: 開発者\nadmin: 管理者\nuser: 一般ユーザー', user.role);
            
            if (newRole && ['developer', 'admin', 'user'].includes(newRole)) {
                user.role = newRole;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                
                // Firebase更新
                if (window.FirebaseDB && user.uid) {
                    window.FirebaseDB.updateUserInfo(user.uid, { role: newRole })
                        .then(result => {
                            if (result.success) {
                                console.log('✅ Firebase権限更新成功');
                            }
                        });
                }
                
                loadUsers();
                showSuccess();
                console.log('✅ ユーザー権限更新:', user.name, newRole);
            }
        }
        
        function changePassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // 開発者権限のみパスワード変更可能
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (!currentSession || currentSession.user.role !== 'developer') {
                alert('パスワード変更は開発者権限が必要です。');
                return;
            }
            
            const newPassword = prompt(`${user.name}の新しいパスワードを入力してください:`, '');
            
            if (newPassword) {
                // パスワードの最低要件チェック
                if (newPassword.length < 4) {
                    alert('パスワードは4文字以上で設定してください。');
                    return;
                }
                
                // パスワード更新
                user.password = newPassword;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                
                alert(`✅ ${user.name}のパスワードを変更しました。\n新しいパスワード: ${newPassword}`);
                console.log('🔑 パスワード変更:', user.name, `(${user.email})`);
            }
        }
        
        async function deleteUser(userId) {
            console.log('🚨 [DEBUG] deleteUser関数が呼ばれました:', userId);
            
            const user = users.find(u => u.id === userId || u.uid === userId);
            console.log('🚨 [DEBUG] 対象ユーザー検索結果:', user);
            
            if (!user) {
                console.error('❌ [DEBUG] ユーザーが見つかりません:', userId);
                return;
            }
            
            console.log('🚨 [DEBUG] 確認ダイアログ表示前');
            if (confirm(`${user.name}を削除しますか？\nこの操作は取り消せません。`)) {
                console.log('🚨 [DEBUG] 確認ダイアログでOKがクリックされました');
                const deletedUserName = user.name;
                
                try {
                    // 🔥 完全削除ではなく無効化処理に変更
                    console.log('🚨 [DEBUG] window.FirebaseDB存在チェック:', !!window.FirebaseDB);
                    console.log('🚨 [DEBUG] window.FirebaseDB.saveUser存在チェック:', !!(window.FirebaseDB && window.FirebaseDB.saveUser));
                    
                    if (window.FirebaseDB && window.FirebaseDB.saveUser) {
                        console.log('🔥 [DISABLE] ユーザーアカウント無効化中:', deletedUserName);
                        
                        // Firestoreのユーザー情報を無効化マークに変更
                        console.log('🚨 [DEBUG] window.getCurrentUser()テスト:', window.getCurrentUser());
                        
                        const currentUser = window.getCurrentUser();
                        console.log('🚨 [DEBUG] 現在のユーザー:', currentUser);
                        
                        const disabledUser = {
                            ...user,
                            isDisabled: true,
                            disabledAt: new Date().toISOString(),
                            disabledBy: currentUser ? currentUser.name : 'unknown'
                        };
                        
                        console.log('🔍 [DEBUG] 無効化ユーザーデータ:', disabledUser);
                        
                        // 無効化されたユーザーとしてFirestoreに保存
                        const firebaseResult = await window.FirebaseDB.saveUser(disabledUser);
                        if (firebaseResult.success) {
                            console.log('✅ [DISABLE] ユーザー無効化成功:', deletedUserName);
                            
                            alert(`ユーザー「${deletedUserName}」を無効化しました。\n\n📋 処理内容:\n• システムからログアウト\n• 新規ログイン拒否\n• データは保持（監査用）\n\n🔧 完全削除が必要な場合は、Firebase Consoleで ${user.email} を削除してください。`);
                        } else {
                            console.error('❌ [DISABLE] ユーザー無効化エラー:', firebaseResult.error);
                        }
                    } else {
                        console.log('🚨 [DEBUG] Firebase条件に該当せず - LocalStorageフォールバック');
                        console.log('📁 [DISABLE] Firebase無効化機能未対応 - LocalStorageのみ削除');
                        alert('⚠️ デバッグ: Firebase機能が利用できないため、LocalStorageでの削除処理を実行します。');
                    }
                    
                    // LocalStorageからも削除
                    users = users.filter(u => u.id !== userId && u.uid !== userId);
                    saveUsers();
                    
                    // 担当者リストからも削除（表示対象同期）
                    removeFromAssigneesList(deletedUserName);
                    
                    // 🔄 再読み込みでFirebaseとの同期を確認
                    await loadUsers();
                    showSuccess();
                    console.log('🗑️ ユーザー削除完了:', deletedUserName, '- 全データソースから削除済み');
                    
                } catch (error) {
                    console.error('❌ [DELETE] ユーザー削除エラー:', error);
                    alert('ユーザー削除中にエラーが発生しました。\n\n' + error.message);
                }
            } else {
                console.log('🚨 [DEBUG] ユーザーが確認ダイアログでキャンセルしました');
            }
        }

        // ユーザー復旧機能
        async function restoreUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || (!user.isDisabled && !user.isHidden)) {
                alert('復旧対象のユーザーが見つかりません。');
                return;
            }
            
            if (confirm(`${user.name} のアカウントを復旧しますか？\n\n復旧すると再度ログイン可能になります。`)) {
                try {
                    // 無効化・非表示フラグを削除して復旧
                    const restoredUser = {
                        ...user,
                        isDisabled: false,
                        isHidden: false,
                        restoredAt: new Date().toISOString(),
                        restoredBy: window.getCurrentUser().name
                    };
                    
                    // 無効化・非表示関連の情報を削除
                    delete restoredUser.disabledAt;
                    delete restoredUser.disabledBy;
                    delete restoredUser.hiddenAt;
                    delete restoredUser.hiddenBy;
                    
                    console.log('🔄 [RESTORE] ユーザー復旧中:', user.name);
                    const firebaseResult = await window.FirebaseDB.saveUser(restoredUser);
                    
                    if (firebaseResult.success) {
                        console.log('✅ [RESTORE] ユーザー復旧成功:', user.name);
                        
                        // ローカルusers配列も更新
                        const userIndex = users.findIndex(u => (u.id === userId || u.uid === userId));
                        if (userIndex !== -1) {
                            users[userIndex] = restoredUser;
                        }
                        
                        // 表示を更新
                        await loadUsers();
                        updateAssigneesList();
                        showSuccess();
                        
                        alert(`✅ ユーザー「${user.name}」を復旧しました。\n\n📋 処理内容:\n• アカウント無効化を解除\n• ログイン再開可能\n• 全機能利用可能`);
                        
                        console.log('🔄 [RESTORE] ユーザー復旧完了:', user.name);
                    } else {
                        console.error('❌ [RESTORE] ユーザー復旧エラー:', firebaseResult.error);
                        alert('ユーザー復旧中にエラーが発生しました。\n\n' + firebaseResult.error);
                    }
                    
                } catch (error) {
                    console.error('❌ [RESTORE] ユーザー復旧エラー:', error);
                    alert('ユーザー復旧中にエラーが発生しました。\n\n' + error.message);
                }
            }
        }

        // ユーザー非表示化機能
        async function hideUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || !user.isDisabled) {
                alert('非表示化は無効化済みユーザーのみ可能です。');
                return;
            }
            
            if (confirm(`${user.name} を非表示化しますか？\n\n⚠️ 注意:\n• ユーザー管理画面で非表示になります\n• プロジェクト作成画面などからも除外されます\n• 復旧は可能です`)) {
                try {
                    const hiddenUser = {
                        ...user,
                        isHidden: true,
                        hiddenAt: new Date().toISOString(),
                        hiddenBy: window.getCurrentUser().name
                    };
                    
                    console.log('👻 [HIDE] ユーザー非表示化中:', user.name);
                    const firebaseResult = await window.FirebaseDB.saveUser(hiddenUser);
                    
                    if (firebaseResult.success) {
                        console.log('✅ [HIDE] ユーザー非表示化成功:', user.name);
                        
                        // ローカルusers配列も更新
                        const userIndex = users.findIndex(u => (u.id === userId || u.uid === userId));
                        if (userIndex !== -1) {
                            users[userIndex] = hiddenUser;
                        }
                        
                        await loadUsers();
                        updateAssigneesList();
                        showSuccess();
                        
                        alert(`👻 ユーザー「${user.name}」を非表示化しました。\n\n📋 処理内容:\n• UI表示から除外\n• プロジェクト選択から除外\n• 完全削除準備段階\n• 復旧は引き続き可能`);
                    } else {
                        console.error('❌ [HIDE] ユーザー非表示化エラー:', firebaseResult.error);
                        alert('ユーザー非表示化中にエラーが発生しました。\n\n' + firebaseResult.error);
                    }
                } catch (error) {
                    console.error('❌ [HIDE] ユーザー非表示化エラー:', error);
                    alert('ユーザー非表示化中にエラーが発生しました。\n\n' + error.message);
                }
            }
        }

        // 完全削除機能
        async function permanentDeleteUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || !user.isHidden) {
                alert('完全削除は非表示化済みユーザーのみ可能です。');
                return;
            }
            
            if (confirm(`⚠️ 【危険操作】\n\n${user.name} を完全削除しますか？\n\n🚨 この操作は取り消せません:\n• Firestoreから完全削除\n• 関連タスクは残りますが担当者情報が失われます\n• Firebase Authからの削除も推奨されます\n\n本当に実行しますか？`)) {
                try {
                    console.log('🗑️ [PERMANENT] 完全削除実行中:', user.name);
                    
                    // Firestoreから完全削除
                    const firebaseResult = await window.FirebaseDB.deleteUser(userId);
                    if (firebaseResult.success) {
                        console.log('✅ [PERMANENT] Firestore削除成功:', user.name);
                    } else {
                        console.error('❌ [PERMANENT] Firestore削除エラー:', firebaseResult.error);
                    }
                    
                    // ローカルからも削除
                    users = users.filter(u => u.id !== userId && u.uid !== userId);
                    saveUsers();
                    removeFromAssigneesList(user.name);
                    
                    await loadUsers();
                    showSuccess();
                    
                    alert(`🗑️ ユーザー「${user.name}」を完全削除しました。\n\n📋 処理完了:\n• Firestoreから削除済み\n• ローカルデータから削除済み\n\n⚠️ Firebase Console での ${user.email} の削除も推奨します。`);
                    
                    console.log('🗑️ [PERMANENT] 完全削除完了:', user.name);
                } catch (error) {
                    console.error('❌ [PERMANENT] 完全削除エラー:', error);
                    alert('完全削除中にエラーが発生しました。\n\n' + error.message);
                }
            }
        }
        
        function saveUsers() {
            localStorage.setItem('systemUsers', JSON.stringify(users));
        }
        
        function updateAssigneesList() {
            // 既存の担当者リストに新規ユーザーを追加
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            
            users.forEach(user => {
                if (!assignees.includes(user.name)) {
                    assignees.push(user.name);
                }
            });
            
            localStorage.setItem('taskAssignees', JSON.stringify(assignees));
        }
        
        function removeFromAssigneesList(userName) {
            // 担当者リストから削除（表示対象同期）
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            const updatedAssignees = assignees.filter(name => name !== userName);
            localStorage.setItem('taskAssignees', JSON.stringify(updatedAssignees));
            console.log('📝 担当者リスト更新:', `"${userName}"を削除`, updatedAssignees);
        }
        
        function showSuccess() {
            const successMsg = document.getElementById('success-message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }
    </script>
    
    <!-- Firebase統合システム - マルチユーザー対応 -->
    <script type="module" src="firebase-config.js"></script>
</body>
</html>