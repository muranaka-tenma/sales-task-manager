<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† - å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #026aa7;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .user-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .form-input, .form-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #026aa7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #025aa0;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .users-table th,
        .users-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .users-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .role-developer {
            background: #fbb6ce;
            color: #97266d;
        }
        
        .role-admin {
            background: #fed7d7;
            color: #c53030;
        }
        
        .role-user {
            background: #c6f6d5;
            color: #38a169;
        }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .back-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h1>
            <a href="index-kanban.html" class="back-link">â† ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </div>
        
        <div class="content">
            <div id="success-message" class="success-message">
                âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ
            </div>
            
            <div class="section">
                <h2>æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h2>
                <div class="user-form">
                    <form id="user-form" onsubmit="addUser(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">åå‰ *</label>
                                <input type="text" class="form-input" id="user-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                                <input type="email" class="form-input" id="user-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ¨©é™ *</label>
                                <select class="form-select" id="user-role" required>
                                    <option value="user">ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                    <option value="admin">ç®¡ç†è€…</option>
                                    <option value="developer">é–‹ç™ºè€…</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">éƒ¨ç½²</label>
                                <input type="text" class="form-input" id="user-department" placeholder="ä¾‹: å–¶æ¥­éƒ¨">
                            </div>
                            <div class="form-group">
                                <label class="form-label">åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                                <input type="password" class="form-input" id="user-password" required placeholder="8æ–‡å­—ä»¥ä¸Š">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="section">
                <h2>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>åå‰</th>
                            <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                            <th>æ¨©é™</th>
                            <th>éƒ¨ç½²</th>
                            <th>ç™»éŒ²æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…æ¨©é™ã‚‚ç¢ºèªï¼‰
        function checkAuthentication() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (!session) {
                    window.location.href = 'login.html';
                    return false;
                }
                if (new Date() > new Date(session.expiresAt)) {
                    localStorage.removeItem('currentSession');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
                if (!['admin', 'developer'].includes(session.user.role)) {
                    alert('ã“ã®æ©Ÿèƒ½ã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚');
                    window.location.href = 'index-kanban.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        let users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
        
        
        // åˆå›èµ·å‹•æ™‚ã«å¿…è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’ä½œæˆï¼ˆä¸è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ¸ˆã¿ï¼‰
        if (users.length === 0) {
            const essentialUsers = [
                {
                    id: 1,
                    name: 'é‚¨ä¸­å¤©çœŸ',
                    email: 'muranaka-tenma@terracom.co.jp',
                    role: 'developer',
                    department: 'é–‹ç™ºéƒ¨',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'admin123'
                },
                {
                    id: 2,
                    name: 'åŠ è—¤ç´”',
                    email: 'kato-jun@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'kato123'
                },
                {
                    id: 3,
                    name: 'æœæ—¥åœ­ä¸€',
                    email: 'asahi-keiichi@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'asahi123'
                },
                {
                    id: 4,
                    name: 'åŠæ¾¤ä¾‘æœ',
                    email: 'hanzawa-yuka@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'hanzawa123'
                },
                {
                    id: 5,
                    name: 'ç”°æ‘æ¸‰',
                    email: 'tamura-wataru@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'tamura123'
                },
                {
                    id: 6,
                    name: 'æ©‹æœ¬å‹ç¾',
                    email: 'hashimoto-yumi@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'hashimoto123'
                },
                {
                    id: 7,
                    name: 'ç¦å³¶äºœæœª',
                    email: 'fukushima-ami@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'fukushima123'
                }
            ];
            users.push(...essentialUsers);
            saveUsers();
            console.log('ğŸ—‘ï¸ [CLEANUP] ä¸è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒ»ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });
        
        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹•çš„çµ±åˆæ©Ÿèƒ½ï¼ˆãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼‰
        function addUserToDynamicDatabase(newUser) {
            try {
                // 1. æ—¢å­˜ã®å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                let dynamicUsers = [];
                const stored = localStorage.getItem('dynamicUsers');
                if (stored) {
                    dynamicUsers = JSON.parse(stored);
                }
                
                // 2. é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const exists = dynamicUsers.find(u => u.email === newUser.email);
                if (exists) {
                    console.log('âš ï¸ [DYNAMIC] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«å‹•çš„DBã«å­˜åœ¨:', newUser.email);
                    return false;
                }
                
                // 3. å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦è¿½åŠ 
                const dynamicUser = {
                    ...newUser,
                    isDynamic: true, // å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚¯
                    addedAt: new Date().toISOString()
                };
                
                dynamicUsers.push(dynamicUser);
                localStorage.setItem('dynamicUsers', JSON.stringify(dynamicUsers));
                
                console.log('âœ… [DYNAMIC] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‹•çš„DBã«è¿½åŠ :', newUser.name);
                console.log('ğŸ”„ [DYNAMIC] ç¾åœ¨ã®å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', dynamicUsers.length);
                
                return true;
            } catch (e) {
                console.error('âš ï¸ [DYNAMIC] å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e);
                return false;
            }
        }
        
        function addUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const role = document.getElementById('user-role').value;
            const department = document.getElementById('user-department').value.trim();
            const password = document.getElementById('user-password').value;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (password.length < 8) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (users.some(u => u.email === email)) {
                alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
            const newUser = {
                id: Date.now(),
                name: name,
                email: email,
                role: role,
                department: department,
                password: password, // å®Ÿéš›ã®é‹ç”¨ã§ã¯æš—å·åŒ–ãŒå¿…è¦
                createdAt: new Date().toISOString()
            };
            
            // é€šå¸¸ã®LocalStorageã¸è¿½åŠ 
            users.push(newUser);
            saveUsers();
            
            // ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ: å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã‚‚è¿½åŠ 
            const dynamicSuccess = addUserToDynamicDatabase(newUser);
            
            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã«ã‚‚è¿½åŠ 
            updateAssigneesList();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('user-form').reset();
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            showSuccess();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§æ›´æ–°
            loadUsers();
            
            const status = dynamicSuccess ? 'ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œã§è¿½åŠ ' : 'ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã§è¿½åŠ ';
            console.log(`âœ… æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ  (${status}):`, newUser.name, newUser.email, newUser.role);
        }
        
        function loadUsers() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td>${user.department || '-'}</td>
                    <td>${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="editUser(${user.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ç·¨é›†</button>
                            <button class="btn btn-secondary" onclick="changePassword(${user.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">å‰Šé™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': 'é–‹ç™ºè€…',
                'admin': 'ç®¡ç†è€…',
                'user': 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼'
            };
            return roleNames[role] || role;
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const newRole = prompt('æ–°ã—ã„æ¨©é™ã‚’é¸æŠã—ã¦ãã ã•ã„:\ndeveloper: é–‹ç™ºè€…\nadmin: ç®¡ç†è€…\nuser: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼', user.role);
            
            if (newRole && ['developer', 'admin', 'user'].includes(newRole)) {
                user.role = newRole;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                loadUsers();
                showSuccess();
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™æ›´æ–°:', user.name, newRole);
            }
        }
        
        function changePassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // é–‹ç™ºè€…æ¨©é™ã®ã¿ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¯èƒ½
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (!currentSession || currentSession.user.role !== 'developer') {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¯é–‹ç™ºè€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            
            const newPassword = prompt(`${user.name}ã®æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, '');
            
            if (newPassword) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ€ä½è¦ä»¶ãƒã‚§ãƒƒã‚¯
                if (newPassword.length < 4) {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
                user.password = newPassword;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                
                alert(`âœ… ${user.name}ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚\næ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${newPassword}`);
                console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´:', user.name, `(${user.email})`);
            }
        }
        
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`${user.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                const deletedUserName = user.name;
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                users = users.filter(u => u.id !== userId);
                saveUsers();
                
                // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆè¡¨ç¤ºå¯¾è±¡åŒæœŸï¼‰
                removeFromAssigneesList(deletedUserName);
                
                loadUsers();
                showSuccess();
                console.log('ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤:', deletedUserName, '- æ‹…å½“è€…ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤æ¸ˆã¿');
            }
        }
        
        function saveUsers() {
            localStorage.setItem('systemUsers', JSON.stringify(users));
        }
        
        function updateAssigneesList() {
            // æ—¢å­˜ã®æ‹…å½“è€…ãƒªã‚¹ãƒˆã«æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            
            users.forEach(user => {
                if (!assignees.includes(user.name)) {
                    assignees.push(user.name);
                }
            });
            
            localStorage.setItem('taskAssignees', JSON.stringify(assignees));
        }
        
        function removeFromAssigneesList(userName) {
            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆè¡¨ç¤ºå¯¾è±¡åŒæœŸï¼‰
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            const updatedAssignees = assignees.filter(name => name !== userName);
            localStorage.setItem('taskAssignees', JSON.stringify(updatedAssignees));
            console.log('ğŸ“ æ‹…å½“è€…ãƒªã‚¹ãƒˆæ›´æ–°:', `"${userName}"ã‚’å‰Šé™¤`, updatedAssignees);
        }
        
        function showSuccess() {
            const successMsg = document.getElementById('success-message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>