<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† - å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç† (Updated: 2025-08-21-12:49)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #026aa7;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .user-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .form-input, .form-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #026aa7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #025aa0;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-warning {
            background: #f56500;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e53e3e;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .users-table th,
        .users-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .users-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .role-developer {
            background: #fbb6ce;
            color: #97266d;
        }
        
        .role-admin {
            background: #fed7d7;
            color: #c53030;
        }
        
        .role-user {
            background: #c6f6d5;
            color: #38a169;
        }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .back-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #e53e3e;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .disabled-user-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .disabled-user-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .disabled-user-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2d3748;
        }

        .disabled-user-email {
            color: #64748b;
            font-size: 0.9rem;
        }

        .disabled-user-meta {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .disabled-user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h1>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button id="disabled-users-btn" onclick="openDisabledUsersModal()" style="display: none; padding: 0.5rem 1rem; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                    ğŸ”’ ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
                </button>
            </div>
        </div>
        
        <div class="content">
            <div id="success-message" class="success-message">
                âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ
            </div>
            
            <div class="section">
                <h2>æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h2>
                <div class="user-form">
                    <form id="user-form" onsubmit="addUser(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">åå‰ *</label>
                                <input type="text" class="form-input" id="user-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                                <input type="email" class="form-input" id="user-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ¨©é™ *</label>
                                <select class="form-select" id="user-role" required>
                                    <option value="user">ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                    <option value="admin">ç®¡ç†è€…</option>
                                    <option value="developer">é–‹ç™ºè€…</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">éƒ¨ç½²</label>
                                <input type="text" class="form-input" id="user-department" placeholder="ä¾‹: å–¶æ¥­éƒ¨">
                            </div>
                            <div class="form-group">
                                <label class="form-label">åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                                <input type="password" class="form-input" id="user-password" required placeholder="8æ–‡å­—ä»¥ä¸Š">
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                </div>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>åå‰</th>
                            <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                            <th>æ¨©é™</th>
                            <th>éƒ¨ç½²</th>
                            <th>ç™»éŒ²æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…æ¨©é™ã‚‚ç¢ºèªï¼‰
        function checkAuthentication() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (!session) {
                    window.location.href = 'login.html';
                    return false;
                }
                if (new Date() > new Date(session.expiresAt)) {
                    localStorage.removeItem('currentSession');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆè©³ç´°ãƒ‡ãƒãƒƒã‚°ä»˜ãï¼‰
                console.log('ğŸ” [PERM-CHECK] ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨©é™ãƒã‚§ãƒƒã‚¯:', {
                    userRole: session.user.role,
                    userName: session.user.name,
                    userEmail: session.user.email,
                    isAdmin: ['admin', 'developer'].includes(session.user.role),
                    sessionData: session.user
                });
                
                if (!['admin', 'developer'].includes(session.user.role)) {
                    console.error('âŒ [PERM-CHECK] æ¨©é™ãƒã‚§ãƒƒã‚¯å¤±æ•—:', session.user.role, '!= admin or developer');
                    alert(`ã“ã®æ©Ÿèƒ½ã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚\nç¾åœ¨ã®æ¨©é™: ${session.user.role}\nå¿…è¦ãªæ¨©é™: admin ã¾ãŸã¯ developer`);
                    window.location.href = 'index-kanban.html';
                    return false;
                } else {
                    console.log('âœ… [PERM-CHECK] æ¨©é™ãƒã‚§ãƒƒã‚¯æˆåŠŸ:', session.user.role);
                    
                    // é–‹ç™ºè€…ãƒ»ç®¡ç†è€…ã®å ´åˆã¯ç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    const disabledUsersBtn = document.getElementById('disabled-users-btn');
                    if (disabledUsersBtn) {
                        disabledUsersBtn.style.display = 'block';
                    }
                }
                
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // æ¨©é™å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆindex-kanban.htmlã¨åŒã˜ï¼‰
        function ensureUserPermissionsIntegrity() {
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const correctRoles = {
                'muranaka-tenma@terracom.co.jp': 'developer',
                'kato-jun@terracom.co.jp': 'admin',
                'asahi-keiichi@terracom.co.jp': 'admin',
                'hanzawa-yuka@terracom.co.jp': 'user',
                'tamura-wataru@terracom.co.jp': 'user',
                'hashimoto-yumi@terracom.co.jp': 'user',
                'fukushima-ami@terracom.co.jp': 'user'
            };
            
            let corrected = false;
            let allUsersAreUser = systemUsers.length > 0 && systemUsers.every(user => user.role === 'user');
            
            if (allUsersAreUser) {
                console.warn('âš ï¸ [USER-MGMT-CRITICAL] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒuserã«ãªã£ã¦ã„ã‚‹ - ç·Šæ€¥ä¿®å¾©å®Ÿè¡Œ');
            }
            
            // ğŸ”§ å¼·åˆ¶çš„ã«æ­£ã—ã„æ¨©é™ã‚’é©ç”¨ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ç‰ˆï¼‰
            systemUsers.forEach(user => {
                const correctRole = correctRoles[user.email];
                if (correctRole) {
                    const oldRole = user.role;
                    user.role = correctRole; // å¼·åˆ¶çš„ã«æ­£ã—ã„æ¨©é™ã«è¨­å®š
                    if (oldRole !== correctRole) {
                        console.log(`ğŸ”§ [USER-MGMT-FORCE] ${user.name}: ${oldRole} â†’ ${correctRole} (å¼·åˆ¶ä¿®æ­£)`);
                        corrected = true;
                    }
                }
            });
            
            // ğŸ”„ å¸¸ã«ä¿å­˜ï¼ˆå¼·åˆ¶ä¿®æ­£ï¼‰
            localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
            console.log('âœ… [USER-MGMT-FORCE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã§æ¨©é™ã®å®Œå…¨æ€§ã‚’å¼·åˆ¶ä¿®å¾©');
            
            // ğŸ” ä¿®æ­£å¾Œã®æ¨©é™çŠ¶æ³ã‚’ç¢ºèªè¡¨ç¤º
            console.log('ğŸ“‹ [USER-MGMT-STATUS] ä¿®æ­£å¾Œã®æ¨©é™çŠ¶æ³:');
            systemUsers.forEach(user => {
                const roleEmoji = user.role === 'developer' ? 'ğŸ‘¨â€ğŸ’»' : 
                                 user.role === 'admin' ? 'ğŸ‘¤' : 'ğŸ§‘â€ğŸ’¼';
                console.log(`  ${roleEmoji} ${user.name} (${user.email}) - ${user.role}`);
            });
            
            return corrected;
        }
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆFirebaseçµ±åˆå¯¾å¿œï¼‰
        let users = [];
        
        
        // åˆå›èµ·å‹•æ™‚ã«å¿…è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’ä½œæˆï¼ˆä¸è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ¸ˆã¿ï¼‰
        if (users.length === 0) {
            const essentialUsers = [
                {
                    id: 1,
                    name: 'é‚¨ä¸­å¤©çœŸ',
                    email: 'muranaka-tenma@terracom.co.jp',
                    role: 'developer',
                    department: 'é–‹ç™ºéƒ¨',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'Tenma7041'
                },
                {
                    id: 2,
                    name: 'åŠ è—¤ç´”',
                    email: 'kato-jun@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 3,
                    name: 'æœæ—¥åœ­ä¸€',
                    email: 'asahi-keiichi@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 4,
                    name: 'åŠæ¾¤ä¾‘æœ',
                    email: 'hanzawa-yuka@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 5,
                    name: 'ç”°æ‘æ¸‰',
                    email: 'tamura-wataru@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 6,
                    name: 'æ©‹æœ¬å‹ç¾',
                    email: 'hashimoto-yumi@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 7,
                    name: 'ç¦å³¶äºœæœª',
                    email: 'fukushima-ami@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                }
            ];
            users.push(...essentialUsers);
            saveUsers();
            console.log('ğŸ—‘ï¸ [CLEANUP] ä¸è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒ»ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼');
        }
        
        // Firebaseèªè¨¼å¾…ã¡å‡¦ç†
        async function waitForFirebaseAuth(maxWaitTime = 5000) {
            return new Promise((resolve) => {
                let waited = 0;
                const checkInterval = 100;
                
                const checkAuth = () => {
                    if (window.FirebaseAuth?.getCurrentUser() && window.FirebaseDB) {
                        console.log('âœ… [USER-MGMT] Firebaseèªè¨¼ç¢ºèªå®Œäº†');
                        resolve(true);
                    } else if (waited >= maxWaitTime) {
                        console.warn('âš ï¸ [USER-MGMT] Firebaseèªè¨¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                        resolve(false);
                    } else {
                        waited += checkInterval;
                        setTimeout(checkAuth, checkInterval);
                    }
                };
                checkAuth();
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼ˆFirebaseèªè¨¼å¾…ã¡å¯¾å¿œï¼‰
        // FirebaseåˆæœŸåŒ–çŠ¶æ…‹ç¢ºèª
        function checkFirebaseStatus() {
            console.log('ğŸ” [FIREBASE-CHECK] FirebaseåˆæœŸåŒ–çŠ¶æ…‹ç¢ºèª:');
            console.log('  window.FirebaseDB:', !!window.FirebaseDB);
            console.log('  window.FirebaseAuth:', !!window.FirebaseAuth);
            console.log('  window.getCurrentUser:', !!window.getCurrentUser);
            
            if (window.FirebaseDB) {
                console.log('  FirebaseDB.getUsers:', !!window.FirebaseDB.getUsers);
                console.log('  FirebaseDB.saveUser:', !!window.FirebaseDB.saveUser);
                console.log('  FirebaseDB.deleteUser:', !!window.FirebaseDB.deleteUser);
            }
            
            if (window.getCurrentUser) {
                const currentUser = window.getCurrentUser();
                console.log('  ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUser);
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('ğŸ”„ [USER-MGMT] Firebaseèªè¨¼ã‚’å¾…æ©Ÿä¸­...');
                
                // FirebaseåˆæœŸåŒ–çŠ¶æ…‹ã‚’ç¢ºèª
                setTimeout(checkFirebaseStatus, 500);
                
                // ğŸ”§ æ¨©é™å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯ã‚’æœ€åˆã«å®Ÿè¡Œ
                ensureUserPermissionsIntegrity();
                
                await waitForFirebaseAuth();
                await loadUsers();
            } catch (error) {
                console.error('âŒ [USER-MGMT] åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§èª­ã¿è¾¼ã¿
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const tbody = document.getElementById('users-list');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                        <td>${user.department || '-'}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-secondary" onclick="editUser('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ç·¨é›†</button>
                                <button class="btn btn-secondary" onclick="changePassword('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">å‰Šé™¤</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });
        
        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹•çš„çµ±åˆæ©Ÿèƒ½ï¼ˆãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼‰
        function addUserToDynamicDatabase(newUser) {
            try {
                // 1. æ—¢å­˜ã®å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                let dynamicUsers = [];
                const stored = localStorage.getItem('dynamicUsers');
                if (stored) {
                    dynamicUsers = JSON.parse(stored);
                }
                
                // 2. é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const exists = dynamicUsers.find(u => u.email === newUser.email);
                if (exists) {
                    console.log('âš ï¸ [DYNAMIC] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«å‹•çš„DBã«å­˜åœ¨:', newUser.email);
                    return false;
                }
                
                // 3. å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦è¿½åŠ 
                const dynamicUser = {
                    ...newUser,
                    isDynamic: true, // å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚¯
                    addedAt: new Date().toISOString()
                };
                
                dynamicUsers.push(dynamicUser);
                localStorage.setItem('dynamicUsers', JSON.stringify(dynamicUsers));
                
                console.log('âœ… [DYNAMIC] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‹•çš„DBã«è¿½åŠ :', newUser.name);
                console.log('ğŸ”„ [DYNAMIC] ç¾åœ¨ã®å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', dynamicUsers.length);
                
                return true;
            } catch (e) {
                console.error('âš ï¸ [DYNAMIC] å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e);
                return false;
            }
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªFirebase Authãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
        async function checkFirebaseAuthUser(email) {
            try {
                // Firebase Authã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€Firebase Auth Admin SDKã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã‚’é€šã˜ã¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹
                console.log('ğŸ” [CHECK-AUTH] Firebase Authãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª:', email);
                return true; // æ—¢å­˜ã®email-already-in-useã‚¨ãƒ©ãƒ¼ã§åˆ¤æ–­
            } catch (error) {
                console.error('âŒ [CHECK-AUTH] Firebase Authãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        async function addUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const role = document.getElementById('user-role').value;
            const department = document.getElementById('user-department').value.trim();
            const password = document.getElementById('user-password').value;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (password.length < 8) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (users.some(u => u.email === email)) {
                alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            try {
                // Firebaseçµ±åˆ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
                if (window.FirebaseAuth && window.FirebaseDB) {
                    console.log('ğŸ”¥ [USER-MGMT] Firebase Authã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆä¸­...', email);
                    
                    // Firebase Authã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
                    const authResult = await window.FirebaseAuth.createUser(email, password, name);
                    
                    if (authResult.success) {
                        console.log('âœ… [FIREBASE] Firebase Authãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæˆåŠŸ:', authResult.user.uid);
                        
                        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
                        const newUser = {
                            id: String(Date.now()), // æ–‡å­—åˆ—å‹ã«å¤‰æ›
                            uid: authResult.user.uid,
                            name: name,
                            email: email,
                            role: role,
                            department: department,
                            createdAt: new Date().toISOString()
                        };
                        
                        // LocalStorageã«è¿½åŠ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
                        users.push(newUser);
                        saveUsers();
                        
                        // æ‹…å½“è€…ãƒªã‚¹ãƒˆã«ã‚‚è¿½åŠ 
                        updateAssigneesList();
                        
                        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                        showSuccess();
                        console.log('âœ… [FIREBASE] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ æˆåŠŸ:', name, email, role);
                        
                        // Firestoreã«ä¿å­˜ï¼ˆæ–°è¦Firebase Authãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆï¼‰
                        const saveResult = await window.FirebaseDB.saveUser(newUser);
                        if (saveResult.success) {
                            console.log('âœ… [FIREBASE] Firestoreä¿å­˜å®Œäº†:', name);
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                            await loadUsers();
                        } else {
                            console.error('âŒ [FIREBASE] Firestoreä¿å­˜ã‚¨ãƒ©ãƒ¼:', saveResult.error);
                        }
                        
                    } else if (authResult.error && authResult.error.includes('email-already-in-use')) {
                        // Firebase Authã«æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã®ã§ã€Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
                        console.log('âœ… [FIREBASE-EXISTING] Firebase Authã®æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«è¿½åŠ :', email);
                        
                        const newUser = {
                            id: String(Date.now()), // æ–‡å­—åˆ—å‹ã«å¤‰æ›ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
                            name: name,
                            email: email,
                            role: role,
                            department: department,
                            createdAt: new Date().toISOString(),
                            isFirebaseExisting: true
                        };
                        
                        // Firestoreã«ä¿å­˜
                        const saveResult = await window.FirebaseDB.saveUser(newUser);
                        if (saveResult.success) {
                            users.push(newUser);
                            saveUsers();
                            updateAssigneesList();
                            showSuccess();
                            console.log('âœ… [FIREBASE-EXISTING] æ—¢å­˜Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ å®Œäº†:', name, email, role);
                            alert(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\n\nâ€» ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«Firebaseèªè¨¼ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚\næ—¢å­˜ã®Firebaseãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã§ã™ã€‚`);
                            
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                            await loadUsers();
                        } else {
                            console.error('âŒ [FIREBASE-EXISTING] Firestoreä¿å­˜ã‚¨ãƒ©ãƒ¼:', saveResult.error);
                            alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveResult.error}\n\nç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚`);
                        }
                    } else {
                        console.error('âŒ [FIREBASE] Firebase Authãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', authResult.error);
                        alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: ${authResult.error}`);
                        return;
                    }
                } else {
                    throw new Error('Firebaseæœªå¯¾å¿œ');
                }
            } catch (error) {
                console.warn('âš ï¸ [USER-MGMT] Firebaseä½œæˆã‚¨ãƒ©ãƒ¼ - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
                
                // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const newUser = {
                    id: String(Date.now()), // æ–‡å­—åˆ—å‹ã«å¤‰æ›
                    name: name,
                    email: email,
                    role: role,
                    department: department,
                    password: password, // LocalStorageã§ã¯ä¿æŒ
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
                saveUsers();
                updateAssigneesList();
                showSuccess();
                console.log('âœ… [LOCAL] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ï¼ˆLocalStorageã®ã¿ï¼‰:', name, email, role);
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('user-form').reset();
        }
        
        // Firebaseçµ±åˆ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadUsers() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            
            try {
                // Firebaseèªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šå³å¯†ï¼‰
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (window.FirebaseDB && window.FirebaseDB.getUsers && currentUser) {
                    console.log('ğŸ”¥ [USER-MGMT] Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...', currentUser.email);
                    const result = await window.FirebaseDB.getUsers();
                    
                    if (result.success) {
                        users = result.users.map(user => {
                            // æ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚° - Firebaseè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
                            const roleMap = {
                                'muranaka-tenma@terracom.co.jp': 'developer',
                                'kato-jun@terracom.co.jp': 'admin',
                                'asahi-keiichi@terracom.co.jp': 'admin',
                                'hanzawa-yuka@terracom.co.jp': 'user',
                                'tamura-wataru@terracom.co.jp': 'user',
                                'hashimoto-yumi@terracom.co.jp': 'user',
                                'fukushima-ami@terracom.co.jp': 'user'
                            };
                            
                            const correctRole = roleMap[user.email] || user.role || 'user';
                            
                            return {
                                id: user.uid || user.id,
                                name: user.displayName || user.name,
                                email: user.email,
                                role: correctRole,  // æ­£ã—ã„æ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨
                                department: user.department || '-',
                                createdAt: user.createdAt,
                                uid: user.uid || user.id,
                                isDisabled: user.isDisabled || false,
                                disabledAt: user.disabledAt,
                                disabledBy: user.disabledBy,
                                isHidden: user.isHidden || false,
                                hiddenAt: user.hiddenAt,
                                hiddenBy: user.hiddenBy
                            };
                        });
                        console.log('âœ… [FIREBASE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ:', users.length, 'ä»¶');
                        
                        // LocalStorageã«ã‚‚ä¿å­˜ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
                        localStorage.setItem('systemUsers', JSON.stringify(users));
                    } else {
                        console.warn('âš ï¸ [FIREBASE] Firestoreèª­ã¿è¾¼ã¿å¤±æ•— - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                        throw new Error('Firebaseèª­ã¿è¾¼ã¿å¤±æ•—');
                    }
                } else {
                    const authStatus = currentUser ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ¸ˆã¿' : 'æœªèªè¨¼';
                    const dbStatus = window.FirebaseDB ? 'DBæ¥ç¶šæ¸ˆã¿' : 'DBæœªæ¥ç¶š';
                    throw new Error(`Firebaseæœªæº–å‚™ (${authStatus}, ${dbStatus})`);
                }
            } catch (error) {
                console.warn('âš ï¸ [USER-MGMT] Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
                // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                
                // ğŸ”§ æ¨©é™å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆuser-managementç”»é¢ç”¨ï¼‰
                ensureUserPermissionsIntegrity();
                // ä¿®å¾©å¾Œã«å†èª­ã¿è¾¼ã¿
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            }
            
            // UIã‚’æ›´æ–° - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é©ç”¨
            updateUserDisplay();
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºæ›´æ–°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯¾å¿œï¼‰
        function updateUserDisplay() {
            const tbody = document.getElementById('users-list');
            
            tbody.innerHTML = '';
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤ºï¼ˆç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é™¤å¤–ï¼‰
            const filteredUsers = users.filter(user => {
                return !user.isHidden && !user.isDisabled;
            });
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                // ãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚’åˆ¤å®š
                const userType = user.isLocalOnly ? 'ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«' : (user.uid ? 'ğŸ”¥ Firebase' : 'ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«');
                const userTypeClass = user.isLocalOnly ? 'local-user' : (user.uid ? 'firebase-user' : 'local-user');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
                const isDisabled = user.isDisabled;
                const isHidden = user.isHidden;
                
                let statusStyle = '';
                let statusText = '';
                let statusInfo = '';
                
                if (isHidden) {
                    statusStyle = 'opacity: 0.3; background-color: #f5f5f5; text-decoration: line-through;';
                    statusText = ` <span style="color: #6b7280; font-weight: bold;">ğŸ‘» éè¡¨ç¤º</span>`;
                    statusInfo = ` <br><small style="color: #666;">éè¡¨ç¤ºåŒ–: ${user.hiddenAt ? new Date(user.hiddenAt).toLocaleDateString('ja-JP') : 'ä¸æ˜'} by ${user.hiddenBy || 'ä¸æ˜'}</small>`;
                } else if (isDisabled) {
                    statusStyle = 'opacity: 0.5; background-color: #f9f9f9;';
                    statusText = ` <span style="color: #e53e3e; font-weight: bold;">ğŸš« ç„¡åŠ¹åŒ–æ¸ˆ</span>`;
                    statusInfo = ` <br><small style="color: #666;">ç„¡åŠ¹åŒ–: ${user.disabledAt ? new Date(user.disabledAt).toLocaleDateString('ja-JP') : 'ä¸æ˜'} by ${user.disabledBy || 'ä¸æ˜'}</small>`;
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒœã‚¿ãƒ³ã‚’åˆ¶å¾¡ï¼ˆç„¡åŠ¹åŒ–=éè¡¨ç¤ºåŒ–ã«çµ±åˆï¼‰
                let actionButtons = '';
                // é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤ºï¼ˆç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§é™¤å¤–ã•ã‚Œã‚‹ï¼‰
                actionButtons = `
                    <button class="btn btn-secondary" onclick="editUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ç·¨é›†</button>
                    <button class="btn btn-secondary" onclick="changePassword('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</button>
                    <button class="btn btn-warning" onclick="disableUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ğŸ”’ ç„¡åŠ¹åŒ–</button>
                `;
                
                row.innerHTML = `
                    <td style="${statusStyle}">${user.name} <small style="color: #666;">(${userType})</small>${statusText}${statusInfo}</td>
                    <td style="${statusStyle}">${user.email}</td>
                    <td style="${statusStyle}"><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td style="${statusStyle}">${user.department || '-'}</td>
                    <td style="${statusStyle}">${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                    <td style="${statusStyle}">
                        <div class="actions">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                row.className = userTypeClass;
                tbody.appendChild(row);
            });
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function toggleDisabledUsers() {
            updateUserDisplay();
        }
        
        function toggleHiddenUsers() {
            updateUserDisplay();
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': 'é–‹ç™ºè€…',
                'admin': 'ç®¡ç†è€…',
                'user': 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼'
            };
            return roleNames[role] || role;
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', userId);
                return;
            }
            
            const newRole = prompt('æ–°ã—ã„æ¨©é™ã‚’é¸æŠã—ã¦ãã ã•ã„:\ndeveloper: é–‹ç™ºè€…\nadmin: ç®¡ç†è€…\nuser: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼', user.role);
            
            if (newRole && ['developer', 'admin', 'user'].includes(newRole)) {
                user.role = newRole;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                
                // Firebaseæ›´æ–°
                if (window.FirebaseDB && user.uid) {
                    window.FirebaseDB.updateUserInfo(user.uid, { role: newRole })
                        .then(result => {
                            if (result.success) {
                                console.log('âœ… Firebaseæ¨©é™æ›´æ–°æˆåŠŸ');
                            }
                        });
                }
                
                loadUsers();
                showSuccess();
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™æ›´æ–°:', user.name, newRole);
            }
        }
        
        function changePassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // é–‹ç™ºè€…æ¨©é™ã®ã¿ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¯èƒ½
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (!currentSession || currentSession.user.role !== 'developer') {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¯é–‹ç™ºè€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            
            const newPassword = prompt(`${user.name}ã®æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, '');
            
            if (newPassword) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ€ä½è¦ä»¶ãƒã‚§ãƒƒã‚¯
                if (newPassword.length < 4) {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
                user.password = newPassword;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                
                alert(`âœ… ${user.name}ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚\næ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${newPassword}`);
                console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´:', user.name, `(${user.email})`);
            }
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–é–¢æ•°ï¼ˆæ–°è¦ï¼‰
        async function disableUser(userId) {
            console.log('ğŸš¨ [DEBUG] disableUseré–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ:', userId, typeof userId);
            console.log('ğŸš¨ [DEBUG] ç¾åœ¨ã®usersé…åˆ—:', users);
            console.log('ğŸš¨ [DEBUG] å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDå½¢å¼:');
            users.forEach((u, index) => {
                console.log(`  ${index}: id=${u.id}(${typeof u.id}), uid=${u.uid}(${typeof u.uid}), name=${u.name}`);
            });
            
            const user = users.find(u => u.id === userId || u.uid === userId);
            console.log('ğŸš¨ [DEBUG] å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢çµæœ:', user);
            
            // å‹å¤‰æ›ã‚’è©¦ã—ã¦å†æ¤œç´¢
            const userById = users.find(u => String(u.id) === String(userId));
            const userByUid = users.find(u => String(u.uid) === String(userId));
            console.log('ğŸš¨ [DEBUG] æ–‡å­—åˆ—å¤‰æ›ã§ã®æ¤œç´¢çµæœ - id:', userById, 'uid:', userByUid);
            
            // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å‹å¤‰æ›ã§å†è©¦è¡Œ
            let targetUser = user || userById || userByUid;
            
            if (!targetUser) {
                console.error('âŒ [DEBUG] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', userId);
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('ğŸš¨ [DEBUG] æœ€çµ‚çš„ã«ä½¿ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼:', targetUser);
            
            console.log('ğŸš¨ [DEBUG] ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºå‰');
            if (confirm(`${targetUser.name}ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ç„¡åŠ¹åŒ–ã™ã‚‹ã¨ï¼š\nâ€¢ ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚Œã¾ã™\nâ€¢ æ–°è¦ãƒ­ã‚°ã‚¤ãƒ³ãŒæ‹’å¦ã•ã‚Œã¾ã™\nâ€¢ ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã€å¾©æ—§å¯èƒ½ã§ã™`)) {
                console.log('ğŸš¨ [DEBUG] ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§OKãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                const disabledUserName = targetUser.name;
                
                try {
                    // ğŸ”¥ å®Œå…¨å‰Šé™¤ã§ã¯ãªãç„¡åŠ¹åŒ–å‡¦ç†ã«å¤‰æ›´
                    console.log('ğŸš¨ [DEBUG] window.FirebaseDBå­˜åœ¨ãƒã‚§ãƒƒã‚¯:', !!window.FirebaseDB);
                    console.log('ğŸš¨ [DEBUG] window.FirebaseDB.saveUserå­˜åœ¨ãƒã‚§ãƒƒã‚¯:', !!(window.FirebaseDB && window.FirebaseDB.saveUser));
                    
                    if (window.FirebaseDB && window.FirebaseDB.saveUser) {
                        console.log('ğŸ”¥ [DISABLE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–ä¸­:', disabledUserName);
                        
                        // Firestoreã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç„¡åŠ¹åŒ–ãƒãƒ¼ã‚¯ã«å¤‰æ›´
                        console.log('ğŸš¨ [DEBUG] window.getCurrentUser()ãƒ†ã‚¹ãƒˆ:', window.getCurrentUser());
                        
                        const currentUser = window.getCurrentUser();
                        console.log('ğŸš¨ [DEBUG] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUser);
                        
                        const disabledUser = {
                            ...targetUser,
                            isDisabled: true,
                            isHidden: true,  // ç„¡åŠ¹åŒ–ã¨åŒæ™‚ã«éè¡¨ç¤ºåŒ–
                            disabledAt: new Date().toISOString(),
                            disabledBy: currentUser ? currentUser.name : 'unknown',
                            hiddenAt: new Date().toISOString(),
                            hiddenBy: currentUser ? currentUser.name : 'unknown'
                        };
                        
                        console.log('ğŸ” [DEBUG] ç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿:', disabledUser);
                        
                        // ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦Firestoreã«ä¿å­˜
                        const firebaseResult = await window.FirebaseDB.saveUser(disabledUser);
                        if (firebaseResult.success) {
                            console.log('âœ… [DISABLE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–æˆåŠŸ:', disabledUserName);
                            
                            alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${disabledUserName}ã€ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å†…å®¹:\nâ€¢ ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ\nâ€¢ æ–°è¦ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦\nâ€¢ ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼ˆç›£æŸ»ç”¨ï¼‰\n\nğŸ”§ å®Œå…¨å‰Šé™¤ãŒå¿…è¦ãªå ´åˆã¯ã€Firebase Consoleã§ ${targetUser.email} ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`);
                        } else {
                            console.error('âŒ [DISABLE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                        }
                    } else {
                        console.log('ğŸš¨ [DEBUG] Firebaseæ¡ä»¶ã«è©²å½“ã›ãš - LocalStorageã§ç„¡åŠ¹åŒ–å‡¦ç†');
                        console.log('ğŸ“ [DISABLE] LocalStorageã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–ä¸­:', disabledUserName);
                        
                        // LocalStorageã§ã‚‚ç„¡åŠ¹åŒ–å‡¦ç†ï¼ˆå‰Šé™¤ã§ã¯ãªãï¼‰
                        const userIndex = users.findIndex(u => u.id === userId || u.uid === userId);
                        if (userIndex !== -1) {
                            users[userIndex] = {
                                ...targetUser,
                                isDisabled: true,
                                isHidden: true,  // ç„¡åŠ¹åŒ–ã¨åŒæ™‚ã«éè¡¨ç¤ºåŒ–
                                disabledAt: new Date().toISOString(),
                                disabledBy: currentUser ? currentUser.name : 'unknown',
                                hiddenAt: new Date().toISOString(),
                                hiddenBy: currentUser ? currentUser.name : 'unknown'
                            };
                            console.log('âœ… [DISABLE] LocalStorageã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–å®Œäº†:', disabledUserName);
                        }
                        
                        alert(`âš ï¸ Firebaseæ¥ç¶šãªã—: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${disabledUserName}ã€ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å†…å®¹:\nâ€¢ ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ã¿ç„¡åŠ¹åŒ–\nâ€¢ Firebaseæ¥ç¶šå¾©æ—§æ™‚ã«åŒæœŸæ¨å¥¨\nâ€¢ ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼ˆå¾©æ—§å¯èƒ½ï¼‰`);
                    }
                    
                    // LocalStorageã«ä¿å­˜ï¼ˆç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å«ã‚€ï¼‰
                    saveUsers();
                    
                    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆè¡¨ç¤ºå¯¾è±¡åŒæœŸï¼‰
                    removeFromAssigneesList(disabledUserName);
                    
                    // ğŸ”„ å†èª­ã¿è¾¼ã¿ã§Firebaseã¨ã®åŒæœŸã‚’ç¢ºèª
                    await loadUsers();
                    showSuccess();
                    console.log('ğŸ”’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–å®Œäº†:', disabledUserName, '- ç„¡åŠ¹åŒ–æ¸ˆã¿');
                    
                } catch (error) {
                    console.error('âŒ [DISABLE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            } else {
                console.log('ğŸš¨ [DEBUG] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            }
        }


        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§æ©Ÿèƒ½
        async function restoreUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || (!user.isDisabled && !user.isHidden)) {
                alert('å¾©æ—§å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (confirm(`${user.name} ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¾©æ—§ã—ã¾ã™ã‹ï¼Ÿ\n\nå¾©æ—§ã™ã‚‹ã¨å†åº¦ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`)) {
                try {
                    // ç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤ã—ã¦å¾©æ—§
                    const restoredUser = {
                        ...user,
                        isDisabled: false,
                        isHidden: false,
                        restoredAt: new Date().toISOString(),
                        restoredBy: window.getCurrentUser().name
                    };
                    
                    // ç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºé–¢é€£ã®æƒ…å ±ã‚’å‰Šé™¤
                    delete restoredUser.disabledAt;
                    delete restoredUser.disabledBy;
                    delete restoredUser.hiddenAt;
                    delete restoredUser.hiddenBy;
                    
                    console.log('ğŸ”„ [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ä¸­:', user.name);
                    const firebaseResult = await window.FirebaseDB.saveUser(restoredUser);
                    
                    if (firebaseResult.success) {
                        console.log('âœ… [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§æˆåŠŸ:', user.name);
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«usersé…åˆ—ã‚‚æ›´æ–°
                        const userIndex = users.findIndex(u => (u.id === userId || u.uid === userId));
                        if (userIndex !== -1) {
                            users[userIndex] = restoredUser;
                        }
                        
                        // è¡¨ç¤ºã‚’æ›´æ–°
                        await loadUsers();
                        updateAssigneesList();
                        showSuccess();
                        
                        alert(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.name}ã€ã‚’å¾©æ—§ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å†…å®¹:\nâ€¢ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–ã‚’è§£é™¤\nâ€¢ ãƒ­ã‚°ã‚¤ãƒ³å†é–‹å¯èƒ½\nâ€¢ å…¨æ©Ÿèƒ½åˆ©ç”¨å¯èƒ½`);
                        
                        console.log('ğŸ”„ [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§å®Œäº†:', user.name);
                    } else {
                        console.error('âŒ [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + firebaseResult.error);
                    }
                    
                } catch (error) {
                    console.error('âŒ [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–æ©Ÿèƒ½
        async function hideUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || !user.isDisabled) {
                alert('éè¡¨ç¤ºåŒ–ã¯ç„¡åŠ¹åŒ–æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            if (confirm(`${user.name} ã‚’éè¡¨ç¤ºåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ æ³¨æ„:\nâ€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã§éè¡¨ç¤ºã«ãªã‚Šã¾ã™\nâ€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆç”»é¢ãªã©ã‹ã‚‰ã‚‚é™¤å¤–ã•ã‚Œã¾ã™\nâ€¢ å¾©æ—§ã¯å¯èƒ½ã§ã™`)) {
                try {
                    const hiddenUser = {
                        ...user,
                        isHidden: true,
                        hiddenAt: new Date().toISOString(),
                        hiddenBy: window.getCurrentUser().name
                    };
                    
                    console.log('ğŸ‘» [HIDE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ä¸­:', user.name);
                    const firebaseResult = await window.FirebaseDB.saveUser(hiddenUser);
                    
                    if (firebaseResult.success) {
                        console.log('âœ… [HIDE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–æˆåŠŸ:', user.name);
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«usersé…åˆ—ã‚‚æ›´æ–°
                        const userIndex = users.findIndex(u => (u.id === userId || u.uid === userId));
                        if (userIndex !== -1) {
                            users[userIndex] = hiddenUser;
                        }
                        
                        await loadUsers();
                        updateAssigneesList();
                        showSuccess();
                        
                        alert(`ğŸ‘» ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.name}ã€ã‚’éè¡¨ç¤ºåŒ–ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å†…å®¹:\nâ€¢ UIè¡¨ç¤ºã‹ã‚‰é™¤å¤–\nâ€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã‹ã‚‰é™¤å¤–\nâ€¢ å®Œå…¨å‰Šé™¤æº–å‚™æ®µéš\nâ€¢ å¾©æ—§ã¯å¼•ãç¶šãå¯èƒ½`);
                    } else {
                        console.error('âŒ [HIDE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + firebaseResult.error);
                    }
                } catch (error) {
                    console.error('âŒ [HIDE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            }
        }

        // å®Œå…¨å‰Šé™¤æ©Ÿèƒ½
        async function permanentDeleteUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || !user.isHidden) {
                alert('å®Œå…¨å‰Šé™¤ã¯éè¡¨ç¤ºåŒ–æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            if (confirm(`âš ï¸ ã€å±é™ºæ“ä½œã€‘\n\n${user.name} ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nğŸš¨ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“:\nâ€¢ Firestoreã‹ã‚‰å®Œå…¨å‰Šé™¤\nâ€¢ é–¢é€£ã‚¿ã‚¹ã‚¯ã¯æ®‹ã‚Šã¾ã™ãŒæ‹…å½“è€…æƒ…å ±ãŒå¤±ã‚ã‚Œã¾ã™\nâ€¢ Firebase Authã‹ã‚‰ã®å‰Šé™¤ã‚‚æ¨å¥¨ã•ã‚Œã¾ã™\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                try {
                    console.log('ğŸ—‘ï¸ [PERMANENT] å®Œå…¨å‰Šé™¤å®Ÿè¡Œä¸­:', user.name);
                    
                    // Firestoreã‹ã‚‰å®Œå…¨å‰Šé™¤
                    const firebaseResult = await window.FirebaseDB.deleteUser(userId);
                    if (firebaseResult.success) {
                        console.log('âœ… [PERMANENT] Firestoreå‰Šé™¤æˆåŠŸ:', user.name);
                    } else {
                        console.error('âŒ [PERMANENT] Firestoreå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                    }
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤
                    users = users.filter(u => u.id !== userId && u.uid !== userId);
                    saveUsers();
                    removeFromAssigneesList(user.name);
                    
                    await loadUsers();
                    showSuccess();
                    
                    alert(`ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.name}ã€ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å®Œäº†:\nâ€¢ Firestoreã‹ã‚‰å‰Šé™¤æ¸ˆã¿\nâ€¢ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤æ¸ˆã¿\n\nâš ï¸ Firebase Console ã§ã® ${user.email} ã®å‰Šé™¤ã‚‚æ¨å¥¨ã—ã¾ã™ã€‚`);
                    
                    console.log('ğŸ—‘ï¸ [PERMANENT] å®Œå…¨å‰Šé™¤å®Œäº†:', user.name);
                } catch (error) {
                    console.error('âŒ [PERMANENT] å®Œå…¨å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å®Œå…¨å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            }
        }
        
        function saveUsers() {
            localStorage.setItem('systemUsers', JSON.stringify(users));
        }
        
        function updateAssigneesList() {
            // æ—¢å­˜ã®æ‹…å½“è€…ãƒªã‚¹ãƒˆã«æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            
            users.forEach(user => {
                if (!assignees.includes(user.name)) {
                    assignees.push(user.name);
                }
            });
            
            localStorage.setItem('taskAssignees', JSON.stringify(assignees));
        }
        
        function removeFromAssigneesList(userName) {
            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆè¡¨ç¤ºå¯¾è±¡åŒæœŸï¼‰
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            const updatedAssignees = assignees.filter(name => name !== userName);
            localStorage.setItem('taskAssignees', JSON.stringify(updatedAssignees));
            console.log('ğŸ“ æ‹…å½“è€…ãƒªã‚¹ãƒˆæ›´æ–°:', `"${userName}"ã‚’å‰Šé™¤`, updatedAssignees);
        }

        // ===== ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡é–¢æ•° =====

        // ç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openDisabledUsersModal() {
            const modal = document.getElementById('disabled-users-modal');
            modal.style.display = 'block';
            loadDisabledUsers();
        }

        // ç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDisabledUsersModal() {
            const modal = document.getElementById('disabled-users-modal');
            modal.style.display = 'none';
        }

        // ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
        function loadDisabledUsers() {
            const container = document.getElementById('disabled-users-list');

            // ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            const disabledUsers = users.filter(user => user.isDisabled || user.isHidden);

            if (disabledUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ“</div>
                        <p>ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            container.innerHTML = disabledUsers.map(user => {
                const disabledDate = user.disabledAt ? new Date(user.disabledAt).toLocaleDateString('ja-JP') : 'ä¸æ˜';
                const disabledBy = user.disabledBy || 'ä¸æ˜';

                return `
                    <div class="disabled-user-card">
                        <div class="disabled-user-info">
                            <div class="disabled-user-name">${user.name}</div>
                            <div class="disabled-user-email">${user.email}</div>
                            <div class="disabled-user-meta">
                                ç„¡åŠ¹åŒ–æ—¥: ${disabledDate} | å®Ÿè¡Œè€…: ${disabledBy}
                            </div>
                        </div>
                        <div class="disabled-user-actions">
                            <button onclick="restoreUserFromModal('${user.uid || user.id}')" class="btn btn-success">
                                ğŸ”“ å¾©æ—§
                            </button>
                            <button onclick="permanentlyDeleteUserFromModal('${user.uid || user.id}')" class="btn btn-danger">
                                ğŸ—‘ï¸ å®Œå…¨å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾©æ—§
        async function restoreUserFromModal(userId) {
            await restoreUser(userId);
            loadDisabledUsers(); // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…è¡¨ç¤ºã‚’æ›´æ–°
            loadUsers(); // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚‚æ›´æ–°
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®Œå…¨å‰Šé™¤
        async function permanentlyDeleteUserFromModal(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            if (confirm(`âš ï¸ ã€å±é™ºæ“ä½œã€‘\n\n${user.name} ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nğŸš¨ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“:\nâ€¢ Firestoreã‹ã‚‰å®Œå…¨å‰Šé™¤\nâ€¢ é–¢é€£ã‚¿ã‚¹ã‚¯ã¯æ®‹ã‚Šã¾ã™ãŒæ‹…å½“è€…æƒ…å ±ãŒå¤±ã‚ã‚Œã¾ã™\nâ€¢ Firebase Authã‹ã‚‰ã®å‰Šé™¤ã‚‚æ¨å¥¨ã•ã‚Œã¾ã™\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                try {
                    console.log('ğŸ—‘ï¸ [PERMANENT] å®Œå…¨å‰Šé™¤å®Ÿè¡Œä¸­:', user.name);

                    // Firestoreã‹ã‚‰å®Œå…¨å‰Šé™¤
                    if (window.FirebaseDB && window.FirebaseDB.deleteUser) {
                        const firebaseResult = await window.FirebaseDB.deleteUser(userId);
                        if (firebaseResult.success) {
                            console.log('âœ… [PERMANENT] Firestoreå‰Šé™¤æˆåŠŸ:', user.name);
                        } else {
                            console.error('âŒ [PERMANENT] Firestoreå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                        }
                    }

                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤
                    users = users.filter(u => u.id !== userId && u.uid !== userId);
                    saveUsers();
                    removeFromAssigneesList(user.name);

                    loadDisabledUsers(); // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…è¡¨ç¤ºã‚’æ›´æ–°
                    await loadUsers(); // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚‚æ›´æ–°
                    showSuccess();

                    alert(`ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.name}ã€ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å®Œäº†:\nâ€¢ Firestoreã‹ã‚‰å‰Šé™¤æ¸ˆã¿\nâ€¢ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤æ¸ˆã¿\n\nâš ï¸ Firebase Console ã§ã® ${user.email} ã®å‰Šé™¤ã‚‚æ¨å¥¨ã—ã¾ã™ã€‚`);

                    console.log('ğŸ—‘ï¸ [PERMANENT] å®Œå…¨å‰Šé™¤å®Œäº†:', user.name);
                } catch (error) {
                    console.error('âŒ [PERMANENT] å®Œå…¨å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å®Œå…¨å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('disabled-users-modal');
            if (event.target === modal) {
                closeDisabledUsersModal();
            }
        }

        // ===== æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–æ©Ÿèƒ½ =====

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–æ©Ÿèƒ½
        async function hideUser(userId) {
            const user = users.find(u => (u.uid || u.id) === String(userId));
            if (!user) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', userId);
                return;
            }
            
            const currentUser = window.getCurrentUser();
            if (!confirm(`${user.name}ã‚’éè¡¨ç¤ºåŒ–ã—ã¾ã™ã‹ï¼Ÿ\néè¡¨ç¤ºåŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é€šå¸¸ã®ãƒªã‚¹ãƒˆã‹ã‚‰è¦‹ãˆãªããªã‚Šã¾ã™ã€‚`)) {
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’éè¡¨ç¤ºåŒ–
            user.isHidden = true;
            user.hiddenAt = new Date().toISOString();
            user.hiddenBy = currentUser ? currentUser.name : 'unknown';
            
            // LocalStorageã«ä¿å­˜
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            // Firebaseæ›´æ–°
            if (window.FirebaseDB && window.FirebaseDB.saveUser) {
                const result = await window.FirebaseDB.saveUser(user);
                if (result.success) {
                    console.log('âœ… [FIREBASE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ [FIREBASE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ã§Firebaseæ›´æ–°å¤±æ•—');
                }
            }
            
            updateUserDisplay();
            showSuccess();
            console.log('ğŸ‘» [USER-MGMT] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–:', user.name);
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§æ©Ÿèƒ½
        async function restoreUser(userId) {
            const user = users.find(u => (u.uid || u.id) === String(userId));
            if (!user) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', userId);
                return;
            }
            
            if (!confirm(`${user.name}ã‚’å¾©æ—§ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾©æ—§
            user.isDisabled = false;
            user.isHidden = false;
            delete user.disabledAt;
            delete user.disabledBy;
            delete user.hiddenAt;
            delete user.hiddenBy;
            user.restoredAt = new Date().toISOString();
            
            // LocalStorageã«ä¿å­˜
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            // Firebaseæ›´æ–°
            if (window.FirebaseDB && window.FirebaseDB.saveUser) {
                const result = await window.FirebaseDB.saveUser(user);
                if (result.success) {
                    console.log('âœ… [FIREBASE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ [FIREBASE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ã§Firebaseæ›´æ–°å¤±æ•—');
                }
            }
            
            updateUserDisplay();
            updateAssigneesList(); // æ‹…å½“è€…ãƒªã‚¹ãƒˆã«ã‚‚å¾©å¸°
            showSuccess();
            console.log('ğŸ”„ [USER-MGMT] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§:', user.name);
        }
        
        // å®Œå…¨å‰Šé™¤æ©Ÿèƒ½
        async function permanentDeleteUser(userId) {
            const user = users.find(u => (u.uid || u.id) === String(userId));
            if (!user) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', userId);
                return;
            }
            
            const confirmText = `${user.name}ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ è­¦å‘Š: ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n- é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚„ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™\n- Firebase Authã‹ã‚‰ã¯æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ã§ã™\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`;
            
            if (!confirm(confirmText)) {
                return;
            }
            
            // LocalStorageã‹ã‚‰å‰Šé™¤
            users = users.filter(u => (u.uid || u.id) !== String(userId));
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            // Firebaseå‰Šé™¤
            if (window.FirebaseDB && window.FirebaseDB.deleteUser) {
                const result = await window.FirebaseDB.deleteUser(String(userId));
                if (result.success) {
                    console.log('âœ… [FIREBASE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å®Œå…¨å‰Šé™¤æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ [FIREBASE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å®Œå…¨å‰Šé™¤ã§Firebaseå‰Šé™¤å¤±æ•—');
                }
            }
            
            updateUserDisplay();
            showSuccess();
            console.log('ğŸ—‘ï¸ [USER-MGMT] ãƒ¦ãƒ¼ã‚¶ãƒ¼å®Œå…¨å‰Šé™¤:', user.name);
        }
        
        function showSuccess() {
            const successMsg = document.getElementById('success-message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }
    </script>

    <!-- ç¦å³¶äºœæœªã•ã‚“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // ç¦å³¶äºœæœªã•ã‚“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç›´æ¥Firestoreã«è¿½åŠ 
        async function addFukushimaUser() {
            if (!window.FirebaseDB) {
                console.error('âŒ FirebaseæœªåˆæœŸåŒ–');
                return;
            }
            
            const fukushimaUser = {
                id: String(Date.now()),
                name: 'ç¦å³¶äºœæœª',
                email: 'fukushima-ami@terracom.co.jp',
                role: 'user',
                department: 'å–¶æ¥­éƒ¨',
                createdAt: new Date().toISOString(),
                isFirebaseExisting: true,
                addedByScript: true
            };
            
            try {
                const saveResult = await window.FirebaseDB.saveUser(fukushimaUser);
                if (saveResult.success) {
                    console.log('âœ… [SCRIPT] ç¦å³¶äºœæœªã•ã‚“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ æˆåŠŸ');
                    alert('âœ… ç¦å³¶äºœæœªã•ã‚“ã‚’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«è¿½åŠ ã—ã¾ã—ãŸã€‚');
                    loadUsers(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    console.error('âŒ [SCRIPT] ç¦å³¶äºœæœªã•ã‚“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ å¤±æ•—:', saveResult.error);
                }
            } catch (error) {
                console.error('âŒ [SCRIPT] ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // FirebaseåˆæœŸåŒ–å¾Œã«å®Ÿè¡Œ
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.FirebaseDB && window.getCurrentUser && window.getCurrentUser().isLoggedIn) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹ã¤ã€ç¦å³¶äºœæœªã•ã‚“ãŒå­˜åœ¨ã—ãªã„å ´åˆã«è¿½åŠ 
                    const currentUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                    const fukushimaExists = currentUsers.some(u => u.email === 'fukushima-ami@terracom.co.jp');
                    
                    if (!fukushimaExists) {
                        console.log('ğŸ” [SCRIPT] ç¦å³¶äºœæœªã•ã‚“ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚è¿½åŠ å‡¦ç†ã‚’å®Ÿè¡Œ');
                        addFukushimaUser();
                    }
                }
            }, 3000); // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
        });
    </script>

    <!-- ç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="disabled-users-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ”’ ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                <button class="modal-close" onclick="closeDisabledUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="disabled-users-list">
                    <!-- ç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebaseçµ±åˆã‚·ã‚¹ãƒ†ãƒ  - ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ -->
    <script type="module" src="firebase-config-auth-fix-20250819-132508.js?v=20250820-user-mgmt"></script>
    <!-- File Updated: 2025-08-21 13:30 - Simplified user addition, added Fukushima user script -->
</body>
</html>