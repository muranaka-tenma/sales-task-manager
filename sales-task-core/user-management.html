<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† - å–¶æ¥­ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #172b4d;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #026aa7;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .user-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .form-input, .form-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #026aa7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #025aa0;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .users-table th,
        .users-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .users-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .role-developer {
            background: #fbb6ce;
            color: #97266d;
        }
        
        .role-admin {
            background: #fed7d7;
            color: #c53030;
        }
        
        .role-user {
            background: #c6f6d5;
            color: #38a169;
        }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .back-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h1>
            <a href="index-kanban.html" class="back-link">â† ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </div>
        
        <div class="content">
            <div id="success-message" class="success-message">
                âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ
            </div>
            
            <div class="section">
                <h2>æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h2>
                <div class="user-form">
                    <form id="user-form" onsubmit="addUser(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">åå‰ *</label>
                                <input type="text" class="form-input" id="user-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                                <input type="email" class="form-input" id="user-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ¨©é™ *</label>
                                <select class="form-select" id="user-role" required>
                                    <option value="user">ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                    <option value="admin">ç®¡ç†è€…</option>
                                    <option value="developer">é–‹ç™ºè€…</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">éƒ¨ç½²</label>
                                <input type="text" class="form-input" id="user-department" placeholder="ä¾‹: å–¶æ¥­éƒ¨">
                            </div>
                            <div class="form-group">
                                <label class="form-label">åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                                <input type="password" class="form-input" id="user-password" required placeholder="8æ–‡å­—ä»¥ä¸Š">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="section">
                <h2>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>åå‰</th>
                            <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                            <th>æ¨©é™</th>
                            <th>éƒ¨ç½²</th>
                            <th>ç™»éŒ²æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…æ¨©é™ã‚‚ç¢ºèªï¼‰
        function checkAuthentication() {
            try {
                const session = JSON.parse(localStorage.getItem('currentSession') || 'null');
                if (!session) {
                    window.location.href = 'login.html';
                    return false;
                }
                if (new Date() > new Date(session.expiresAt)) {
                    localStorage.removeItem('currentSession');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆè©³ç´°ãƒ‡ãƒãƒƒã‚°ä»˜ãï¼‰
                console.log('ğŸ” [PERM-CHECK] ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨©é™ãƒã‚§ãƒƒã‚¯:', {
                    userRole: session.user.role,
                    userName: session.user.name,
                    userEmail: session.user.email,
                    isAdmin: ['admin', 'developer'].includes(session.user.role),
                    sessionData: session.user
                });
                
                if (!['admin', 'developer'].includes(session.user.role)) {
                    console.error('âŒ [PERM-CHECK] æ¨©é™ãƒã‚§ãƒƒã‚¯å¤±æ•—:', session.user.role, '!= admin or developer');
                    alert(`ã“ã®æ©Ÿèƒ½ã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚\nç¾åœ¨ã®æ¨©é™: ${session.user.role}\nå¿…è¦ãªæ¨©é™: admin ã¾ãŸã¯ developer`);
                    window.location.href = 'index-kanban.html';
                    return false;
                } else {
                    console.log('âœ… [PERM-CHECK] æ¨©é™ãƒã‚§ãƒƒã‚¯æˆåŠŸ:', session.user.role);
                }
                
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // æ¨©é™å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆindex-kanban.htmlã¨åŒã˜ï¼‰
        function ensureUserPermissionsIntegrity() {
            const systemUsers = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const correctRoles = {
                'muranaka-tenma@terracom.co.jp': 'developer',
                'kato-jun@terracom.co.jp': 'admin',
                'asahi-keiichi@terracom.co.jp': 'admin',
                'hanzawa-yuka@terracom.co.jp': 'user',
                'tamura-wataru@terracom.co.jp': 'user',
                'hashimoto-yumi@terracom.co.jp': 'user',
                'fukushima-ami@terracom.co.jp': 'user'
            };
            
            let corrected = false;
            let allUsersAreUser = systemUsers.length > 0 && systemUsers.every(user => user.role === 'user');
            
            if (allUsersAreUser) {
                console.warn('âš ï¸ [USER-MGMT-CRITICAL] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒuserã«ãªã£ã¦ã„ã‚‹ - ç·Šæ€¥ä¿®å¾©å®Ÿè¡Œ');
            }
            
            // ğŸ”§ å¼·åˆ¶çš„ã«æ­£ã—ã„æ¨©é™ã‚’é©ç”¨ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ç‰ˆï¼‰
            systemUsers.forEach(user => {
                const correctRole = correctRoles[user.email];
                if (correctRole) {
                    const oldRole = user.role;
                    user.role = correctRole; // å¼·åˆ¶çš„ã«æ­£ã—ã„æ¨©é™ã«è¨­å®š
                    if (oldRole !== correctRole) {
                        console.log(`ğŸ”§ [USER-MGMT-FORCE] ${user.name}: ${oldRole} â†’ ${correctRole} (å¼·åˆ¶ä¿®æ­£)`);
                        corrected = true;
                    }
                }
            });
            
            // ğŸ”„ å¸¸ã«ä¿å­˜ï¼ˆå¼·åˆ¶ä¿®æ­£ï¼‰
            localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
            console.log('âœ… [USER-MGMT-FORCE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã§æ¨©é™ã®å®Œå…¨æ€§ã‚’å¼·åˆ¶ä¿®å¾©');
            
            // ğŸ” ä¿®æ­£å¾Œã®æ¨©é™çŠ¶æ³ã‚’ç¢ºèªè¡¨ç¤º
            console.log('ğŸ“‹ [USER-MGMT-STATUS] ä¿®æ­£å¾Œã®æ¨©é™çŠ¶æ³:');
            systemUsers.forEach(user => {
                const roleEmoji = user.role === 'developer' ? 'ğŸ‘¨â€ğŸ’»' : 
                                 user.role === 'admin' ? 'ğŸ‘¤' : 'ğŸ§‘â€ğŸ’¼';
                console.log(`  ${roleEmoji} ${user.name} (${user.email}) - ${user.role}`);
            });
            
            return corrected;
        }
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆFirebaseçµ±åˆå¯¾å¿œï¼‰
        let users = [];
        
        
        // åˆå›èµ·å‹•æ™‚ã«å¿…è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’ä½œæˆï¼ˆä¸è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ¸ˆã¿ï¼‰
        if (users.length === 0) {
            const essentialUsers = [
                {
                    id: 1,
                    name: 'é‚¨ä¸­å¤©çœŸ',
                    email: 'muranaka-tenma@terracom.co.jp',
                    role: 'developer',
                    department: 'é–‹ç™ºéƒ¨',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'Tenma7041'
                },
                {
                    id: 2,
                    name: 'åŠ è—¤ç´”',
                    email: 'kato-jun@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 3,
                    name: 'æœæ—¥åœ­ä¸€',
                    email: 'asahi-keiichi@terracom.co.jp',
                    role: 'admin',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 4,
                    name: 'åŠæ¾¤ä¾‘æœ',
                    email: 'hanzawa-yuka@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 5,
                    name: 'ç”°æ‘æ¸‰',
                    email: 'tamura-wataru@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 6,
                    name: 'æ©‹æœ¬å‹ç¾',
                    email: 'hashimoto-yumi@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                },
                {
                    id: 7,
                    name: 'ç¦å³¶äºœæœª',
                    email: 'fukushima-ami@terracom.co.jp',
                    role: 'user',
                    department: '-',
                    createdAt: '2025-08-04T00:00:00.000Z',
                    password: 'aikakumei'
                }
            ];
            users.push(...essentialUsers);
            saveUsers();
            console.log('ğŸ—‘ï¸ [CLEANUP] ä¸è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒ»ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼');
        }
        
        // Firebaseèªè¨¼å¾…ã¡å‡¦ç†
        async function waitForFirebaseAuth(maxWaitTime = 5000) {
            return new Promise((resolve) => {
                let waited = 0;
                const checkInterval = 100;
                
                const checkAuth = () => {
                    if (window.FirebaseAuth?.getCurrentUser() && window.FirebaseDB) {
                        console.log('âœ… [USER-MGMT] Firebaseèªè¨¼ç¢ºèªå®Œäº†');
                        resolve(true);
                    } else if (waited >= maxWaitTime) {
                        console.warn('âš ï¸ [USER-MGMT] Firebaseèªè¨¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                        resolve(false);
                    } else {
                        waited += checkInterval;
                        setTimeout(checkAuth, checkInterval);
                    }
                };
                checkAuth();
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼ˆFirebaseèªè¨¼å¾…ã¡å¯¾å¿œï¼‰
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('ğŸ”„ [USER-MGMT] Firebaseèªè¨¼ã‚’å¾…æ©Ÿä¸­...');
                
                // ğŸ”§ æ¨©é™å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯ã‚’æœ€åˆã«å®Ÿè¡Œ
                ensureUserPermissionsIntegrity();
                
                await waitForFirebaseAuth();
                await loadUsers();
            } catch (error) {
                console.error('âŒ [USER-MGMT] åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§èª­ã¿è¾¼ã¿
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const tbody = document.getElementById('users-list');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                        <td>${user.department || '-'}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-secondary" onclick="editUser('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ç·¨é›†</button>
                                <button class="btn btn-secondary" onclick="changePassword('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">å‰Šé™¤</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });
        
        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹•çš„çµ±åˆæ©Ÿèƒ½ï¼ˆãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼‰
        function addUserToDynamicDatabase(newUser) {
            try {
                // 1. æ—¢å­˜ã®å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                let dynamicUsers = [];
                const stored = localStorage.getItem('dynamicUsers');
                if (stored) {
                    dynamicUsers = JSON.parse(stored);
                }
                
                // 2. é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const exists = dynamicUsers.find(u => u.email === newUser.email);
                if (exists) {
                    console.log('âš ï¸ [DYNAMIC] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«å‹•çš„DBã«å­˜åœ¨:', newUser.email);
                    return false;
                }
                
                // 3. å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦è¿½åŠ 
                const dynamicUser = {
                    ...newUser,
                    isDynamic: true, // å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚¯
                    addedAt: new Date().toISOString()
                };
                
                dynamicUsers.push(dynamicUser);
                localStorage.setItem('dynamicUsers', JSON.stringify(dynamicUsers));
                
                console.log('âœ… [DYNAMIC] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‹•çš„DBã«è¿½åŠ :', newUser.name);
                console.log('ğŸ”„ [DYNAMIC] ç¾åœ¨ã®å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', dynamicUsers.length);
                
                return true;
            } catch (e) {
                console.error('âš ï¸ [DYNAMIC] å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e);
                return false;
            }
        }
        
        async function addUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const role = document.getElementById('user-role').value;
            const department = document.getElementById('user-department').value.trim();
            const password = document.getElementById('user-password').value;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (password.length < 8) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (users.some(u => u.email === email)) {
                alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            try {
                // Firebaseçµ±åˆ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
                if (window.FirebaseAuth && window.FirebaseDB) {
                    console.log('ğŸ”¥ [USER-MGMT] Firebase Authã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆä¸­...', email);
                    
                    // Firebase Authã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
                    const authResult = await window.FirebaseAuth.createUser(email, password, name);
                    
                    if (authResult.success) {
                        console.log('âœ… [FIREBASE] Firebase Authãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæˆåŠŸ:', authResult.user.uid);
                        
                        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
                        const newUser = {
                            id: Date.now(),
                            uid: authResult.user.uid,
                            name: name,
                            email: email,
                            role: role,
                            department: department,
                            createdAt: new Date().toISOString()
                        };
                        
                        // LocalStorageã«è¿½åŠ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
                        users.push(newUser);
                        saveUsers();
                        
                        // æ‹…å½“è€…ãƒªã‚¹ãƒˆã«ã‚‚è¿½åŠ 
                        updateAssigneesList();
                        
                        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                        showSuccess();
                        console.log('âœ… [FIREBASE] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ æˆåŠŸ:', name, email, role);
                        
                    } else if (authResult.error && authResult.error.includes('email-already-in-use')) {
                        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                        console.log('âš ï¸ [FIREBASE] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ—¢å­˜ - æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ç™»éŒ²:', email);
                        
                        // æ—¢å­˜ã®Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ©ç”¨ã—ã¦Firestoreã«è¿½åŠ 
                        const newUser = {
                            id: Date.now(),
                            name: name,
                            email: email,
                            role: role,
                            department: department,
                            createdAt: new Date().toISOString(),
                            isFirebaseExisting: true // æ—¢å­˜Firebaseèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼
                        };
                        
                        users.push(newUser);
                        saveUsers();
                        updateAssigneesList();
                        showSuccess();
                        console.log('âœ… [FIREBASE-EXISTING] æ—¢å­˜Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ :', name, email, role);
                        alert(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\n\nâ€» ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«Firebaseèªè¨¼ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚\næ—¢å­˜ã®Firebaseãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã§ã™ã€‚`);
                    } else {
                        console.error('âŒ [FIREBASE] Firebase Authãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', authResult.error);
                        alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: ${authResult.error}`);
                        return;
                    }
                } else {
                    throw new Error('Firebaseæœªå¯¾å¿œ');
                }
            } catch (error) {
                console.warn('âš ï¸ [USER-MGMT] Firebaseä½œæˆã‚¨ãƒ©ãƒ¼ - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
                
                // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const newUser = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    role: role,
                    department: department,
                    password: password, // LocalStorageã§ã¯ä¿æŒ
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
                saveUsers();
                updateAssigneesList();
                showSuccess();
                console.log('âœ… [LOCAL] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ï¼ˆLocalStorageã®ã¿ï¼‰:', name, email, role);
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('user-form').reset();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§æ›´æ–°
            await loadUsers();
        }
        
        // Firebaseçµ±åˆ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadUsers() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            
            try {
                // Firebaseèªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šå³å¯†ï¼‰
                const currentUser = window.firebaseAuth?.currentUser || window.FirebaseAuth?.getCurrentUser();
                if (window.FirebaseDB && window.FirebaseDB.getUsers && currentUser) {
                    console.log('ğŸ”¥ [USER-MGMT] Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...', currentUser.email);
                    const result = await window.FirebaseDB.getUsers();
                    
                    if (result.success) {
                        users = result.users.map(user => ({
                            id: user.uid || user.id,
                            name: user.displayName || user.name,
                            email: user.email,
                            role: user.role || 'user',
                            department: user.department || '-',
                            createdAt: user.createdAt,
                            uid: user.uid || user.id,
                            isDisabled: user.isDisabled || false,
                            disabledAt: user.disabledAt,
                            disabledBy: user.disabledBy
                        }));
                        console.log('âœ… [FIREBASE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ:', users.length, 'ä»¶');
                        
                        // LocalStorageã«ã‚‚ä¿å­˜ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
                        localStorage.setItem('systemUsers', JSON.stringify(users));
                    } else {
                        console.warn('âš ï¸ [FIREBASE] Firestoreèª­ã¿è¾¼ã¿å¤±æ•— - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                        throw new Error('Firebaseèª­ã¿è¾¼ã¿å¤±æ•—');
                    }
                } else {
                    const authStatus = currentUser ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ¸ˆã¿' : 'æœªèªè¨¼';
                    const dbStatus = window.FirebaseDB ? 'DBæ¥ç¶šæ¸ˆã¿' : 'DBæœªæ¥ç¶š';
                    throw new Error(`Firebaseæœªæº–å‚™ (${authStatus}, ${dbStatus})`);
                }
            } catch (error) {
                console.warn('âš ï¸ [USER-MGMT] Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
                // LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                
                // ğŸ”§ æ¨©é™å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆuser-managementç”»é¢ç”¨ï¼‰
                ensureUserPermissionsIntegrity();
                // ä¿®å¾©å¾Œã«å†èª­ã¿è¾¼ã¿
                users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            }
            
            // UIã‚’æ›´æ–°
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                // ãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚’åˆ¤å®š
                const userType = user.isLocalOnly ? 'ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«' : (user.uid ? 'ğŸ”¥ Firebase' : 'ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«');
                const userTypeClass = user.isLocalOnly ? 'local-user' : (user.uid ? 'firebase-user' : 'local-user');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
                const isDisabled = user.isDisabled;
                const isHidden = user.isHidden;
                
                let statusStyle = '';
                let statusText = '';
                let statusInfo = '';
                
                if (isHidden) {
                    statusStyle = 'opacity: 0.3; background-color: #f5f5f5; text-decoration: line-through;';
                    statusText = ` <span style="color: #6b7280; font-weight: bold;">ğŸ‘» éè¡¨ç¤º</span>`;
                    statusInfo = ` <br><small style="color: #666;">éè¡¨ç¤ºåŒ–: ${user.hiddenAt ? new Date(user.hiddenAt).toLocaleDateString('ja-JP') : 'ä¸æ˜'} by ${user.hiddenBy || 'ä¸æ˜'}</small>`;
                } else if (isDisabled) {
                    statusStyle = 'opacity: 0.5; background-color: #f9f9f9;';
                    statusText = ` <span style="color: #e53e3e; font-weight: bold;">ğŸš« ç„¡åŠ¹åŒ–æ¸ˆ</span>`;
                    statusInfo = ` <br><small style="color: #666;">ç„¡åŠ¹åŒ–: ${user.disabledAt ? new Date(user.disabledAt).toLocaleDateString('ja-JP') : 'ä¸æ˜'} by ${user.disabledBy || 'ä¸æ˜'}</small>`;
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒœã‚¿ãƒ³ã‚’åˆ¶å¾¡
                let actionButtons = '';
                if (user.isHidden) {
                    // éè¡¨ç¤ºãƒ¦ãƒ¼ã‚¶ãƒ¼: å¾©æ—§ã¨å®Œå…¨å‰Šé™¤
                    actionButtons = `
                        <button class="btn btn-primary" onclick="restoreUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">å¾©æ—§</button>
                        <button class="btn btn-danger" onclick="permanentDeleteUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">å®Œå…¨å‰Šé™¤</button>
                    `;
                } else if (isDisabled) {
                    // ç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼: å¾©æ—§ã¨éè¡¨ç¤º
                    actionButtons = `
                        <button class="btn btn-primary" onclick="restoreUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">å¾©æ—§</button>
                        <button class="btn btn-warning" onclick="hideUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">éè¡¨ç¤ºåŒ–</button>
                    `;
                } else {
                    // é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼: ç·¨é›†ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ç„¡åŠ¹åŒ–
                    actionButtons = `
                        <button class="btn btn-secondary" onclick="editUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ç·¨é›†</button>
                        <button class="btn btn-secondary" onclick="changePassword('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.uid || user.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">ç„¡åŠ¹åŒ–</button>
                    `;
                }
                
                row.innerHTML = `
                    <td style="${statusStyle}">${user.name} <small style="color: #666;">(${userType})</small>${statusText}${statusInfo}</td>
                    <td style="${statusStyle}">${user.email}</td>
                    <td style="${statusStyle}"><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td style="${statusStyle}">${user.department || '-'}</td>
                    <td style="${statusStyle}">${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                    <td style="${statusStyle}">
                        <div class="actions">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                row.className = userTypeClass;
                tbody.appendChild(row);
            });
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'developer': 'é–‹ç™ºè€…',
                'admin': 'ç®¡ç†è€…',
                'user': 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼'
            };
            return roleNames[role] || role;
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', userId);
                return;
            }
            
            const newRole = prompt('æ–°ã—ã„æ¨©é™ã‚’é¸æŠã—ã¦ãã ã•ã„:\ndeveloper: é–‹ç™ºè€…\nadmin: ç®¡ç†è€…\nuser: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼', user.role);
            
            if (newRole && ['developer', 'admin', 'user'].includes(newRole)) {
                user.role = newRole;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                
                // Firebaseæ›´æ–°
                if (window.FirebaseDB && user.uid) {
                    window.FirebaseDB.updateUserInfo(user.uid, { role: newRole })
                        .then(result => {
                            if (result.success) {
                                console.log('âœ… Firebaseæ¨©é™æ›´æ–°æˆåŠŸ');
                            }
                        });
                }
                
                loadUsers();
                showSuccess();
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™æ›´æ–°:', user.name, newRole);
            }
        }
        
        function changePassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // é–‹ç™ºè€…æ¨©é™ã®ã¿ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¯èƒ½
            const currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (!currentSession || currentSession.user.role !== 'developer') {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¯é–‹ç™ºè€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            
            const newPassword = prompt(`${user.name}ã®æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, '');
            
            if (newPassword) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ€ä½è¦ä»¶ãƒã‚§ãƒƒã‚¯
                if (newPassword.length < 4) {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
                user.password = newPassword;
                user.updatedAt = new Date().toISOString();
                saveUsers();
                
                alert(`âœ… ${user.name}ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚\næ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${newPassword}`);
                console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´:', user.name, `(${user.email})`);
            }
        }
        
        async function deleteUser(userId) {
            console.log('ğŸš¨ [DEBUG] deleteUseré–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ:', userId);
            
            const user = users.find(u => u.id === userId || u.uid === userId);
            console.log('ğŸš¨ [DEBUG] å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢çµæœ:', user);
            
            if (!user) {
                console.error('âŒ [DEBUG] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', userId);
                return;
            }
            
            console.log('ğŸš¨ [DEBUG] ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºå‰');
            if (confirm(`${user.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                console.log('ğŸš¨ [DEBUG] ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§OKãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                const deletedUserName = user.name;
                
                try {
                    // ğŸ”¥ å®Œå…¨å‰Šé™¤ã§ã¯ãªãç„¡åŠ¹åŒ–å‡¦ç†ã«å¤‰æ›´
                    console.log('ğŸš¨ [DEBUG] window.FirebaseDBå­˜åœ¨ãƒã‚§ãƒƒã‚¯:', !!window.FirebaseDB);
                    console.log('ğŸš¨ [DEBUG] window.FirebaseDB.saveUserå­˜åœ¨ãƒã‚§ãƒƒã‚¯:', !!(window.FirebaseDB && window.FirebaseDB.saveUser));
                    
                    if (window.FirebaseDB && window.FirebaseDB.saveUser) {
                        console.log('ğŸ”¥ [DISABLE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–ä¸­:', deletedUserName);
                        
                        // Firestoreã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç„¡åŠ¹åŒ–ãƒãƒ¼ã‚¯ã«å¤‰æ›´
                        console.log('ğŸš¨ [DEBUG] window.getCurrentUser()ãƒ†ã‚¹ãƒˆ:', window.getCurrentUser());
                        
                        const currentUser = window.getCurrentUser();
                        console.log('ğŸš¨ [DEBUG] ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUser);
                        
                        const disabledUser = {
                            ...user,
                            isDisabled: true,
                            disabledAt: new Date().toISOString(),
                            disabledBy: currentUser ? currentUser.name : 'unknown'
                        };
                        
                        console.log('ğŸ” [DEBUG] ç„¡åŠ¹åŒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿:', disabledUser);
                        
                        // ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦Firestoreã«ä¿å­˜
                        const firebaseResult = await window.FirebaseDB.saveUser(disabledUser);
                        if (firebaseResult.success) {
                            console.log('âœ… [DISABLE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–æˆåŠŸ:', deletedUserName);
                            
                            alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${deletedUserName}ã€ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å†…å®¹:\nâ€¢ ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ\nâ€¢ æ–°è¦ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦\nâ€¢ ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼ˆç›£æŸ»ç”¨ï¼‰\n\nğŸ”§ å®Œå…¨å‰Šé™¤ãŒå¿…è¦ãªå ´åˆã¯ã€Firebase Consoleã§ ${user.email} ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`);
                        } else {
                            console.error('âŒ [DISABLE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                        }
                    } else {
                        console.log('ğŸš¨ [DEBUG] Firebaseæ¡ä»¶ã«è©²å½“ã›ãš - LocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                        console.log('ğŸ“ [DISABLE] Firebaseç„¡åŠ¹åŒ–æ©Ÿèƒ½æœªå¯¾å¿œ - LocalStorageã®ã¿å‰Šé™¤');
                        alert('âš ï¸ ãƒ‡ãƒãƒƒã‚°: Firebaseæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€LocalStorageã§ã®å‰Šé™¤å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚');
                    }
                    
                    // LocalStorageã‹ã‚‰ã‚‚å‰Šé™¤
                    users = users.filter(u => u.id !== userId && u.uid !== userId);
                    saveUsers();
                    
                    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆè¡¨ç¤ºå¯¾è±¡åŒæœŸï¼‰
                    removeFromAssigneesList(deletedUserName);
                    
                    // ğŸ”„ å†èª­ã¿è¾¼ã¿ã§Firebaseã¨ã®åŒæœŸã‚’ç¢ºèª
                    await loadUsers();
                    showSuccess();
                    console.log('ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†:', deletedUserName, '- å…¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤æ¸ˆã¿');
                    
                } catch (error) {
                    console.error('âŒ [DELETE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            } else {
                console.log('ğŸš¨ [DEBUG] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§æ©Ÿèƒ½
        async function restoreUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || (!user.isDisabled && !user.isHidden)) {
                alert('å¾©æ—§å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (confirm(`${user.name} ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¾©æ—§ã—ã¾ã™ã‹ï¼Ÿ\n\nå¾©æ—§ã™ã‚‹ã¨å†åº¦ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`)) {
                try {
                    // ç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤ã—ã¦å¾©æ—§
                    const restoredUser = {
                        ...user,
                        isDisabled: false,
                        isHidden: false,
                        restoredAt: new Date().toISOString(),
                        restoredBy: window.getCurrentUser().name
                    };
                    
                    // ç„¡åŠ¹åŒ–ãƒ»éè¡¨ç¤ºé–¢é€£ã®æƒ…å ±ã‚’å‰Šé™¤
                    delete restoredUser.disabledAt;
                    delete restoredUser.disabledBy;
                    delete restoredUser.hiddenAt;
                    delete restoredUser.hiddenBy;
                    
                    console.log('ğŸ”„ [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ä¸­:', user.name);
                    const firebaseResult = await window.FirebaseDB.saveUser(restoredUser);
                    
                    if (firebaseResult.success) {
                        console.log('âœ… [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§æˆåŠŸ:', user.name);
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«usersé…åˆ—ã‚‚æ›´æ–°
                        const userIndex = users.findIndex(u => (u.id === userId || u.uid === userId));
                        if (userIndex !== -1) {
                            users[userIndex] = restoredUser;
                        }
                        
                        // è¡¨ç¤ºã‚’æ›´æ–°
                        await loadUsers();
                        updateAssigneesList();
                        showSuccess();
                        
                        alert(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.name}ã€ã‚’å¾©æ—§ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å†…å®¹:\nâ€¢ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–ã‚’è§£é™¤\nâ€¢ ãƒ­ã‚°ã‚¤ãƒ³å†é–‹å¯èƒ½\nâ€¢ å…¨æ©Ÿèƒ½åˆ©ç”¨å¯èƒ½`);
                        
                        console.log('ğŸ”„ [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§å®Œäº†:', user.name);
                    } else {
                        console.error('âŒ [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + firebaseResult.error);
                    }
                    
                } catch (error) {
                    console.error('âŒ [RESTORE] ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼å¾©æ—§ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–æ©Ÿèƒ½
        async function hideUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || !user.isDisabled) {
                alert('éè¡¨ç¤ºåŒ–ã¯ç„¡åŠ¹åŒ–æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            if (confirm(`${user.name} ã‚’éè¡¨ç¤ºåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ æ³¨æ„:\nâ€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã§éè¡¨ç¤ºã«ãªã‚Šã¾ã™\nâ€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆç”»é¢ãªã©ã‹ã‚‰ã‚‚é™¤å¤–ã•ã‚Œã¾ã™\nâ€¢ å¾©æ—§ã¯å¯èƒ½ã§ã™`)) {
                try {
                    const hiddenUser = {
                        ...user,
                        isHidden: true,
                        hiddenAt: new Date().toISOString(),
                        hiddenBy: window.getCurrentUser().name
                    };
                    
                    console.log('ğŸ‘» [HIDE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ä¸­:', user.name);
                    const firebaseResult = await window.FirebaseDB.saveUser(hiddenUser);
                    
                    if (firebaseResult.success) {
                        console.log('âœ… [HIDE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–æˆåŠŸ:', user.name);
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«usersé…åˆ—ã‚‚æ›´æ–°
                        const userIndex = users.findIndex(u => (u.id === userId || u.uid === userId));
                        if (userIndex !== -1) {
                            users[userIndex] = hiddenUser;
                        }
                        
                        await loadUsers();
                        updateAssigneesList();
                        showSuccess();
                        
                        alert(`ğŸ‘» ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.name}ã€ã‚’éè¡¨ç¤ºåŒ–ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å†…å®¹:\nâ€¢ UIè¡¨ç¤ºã‹ã‚‰é™¤å¤–\nâ€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã‹ã‚‰é™¤å¤–\nâ€¢ å®Œå…¨å‰Šé™¤æº–å‚™æ®µéš\nâ€¢ å¾©æ—§ã¯å¼•ãç¶šãå¯èƒ½`);
                    } else {
                        console.error('âŒ [HIDE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + firebaseResult.error);
                    }
                } catch (error) {
                    console.error('âŒ [HIDE] ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤ºåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            }
        }

        // å®Œå…¨å‰Šé™¤æ©Ÿèƒ½
        async function permanentDeleteUser(userId) {
            const user = users.find(u => u.id === userId || u.uid === userId);
            if (!user || !user.isHidden) {
                alert('å®Œå…¨å‰Šé™¤ã¯éè¡¨ç¤ºåŒ–æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            if (confirm(`âš ï¸ ã€å±é™ºæ“ä½œã€‘\n\n${user.name} ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nğŸš¨ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“:\nâ€¢ Firestoreã‹ã‚‰å®Œå…¨å‰Šé™¤\nâ€¢ é–¢é€£ã‚¿ã‚¹ã‚¯ã¯æ®‹ã‚Šã¾ã™ãŒæ‹…å½“è€…æƒ…å ±ãŒå¤±ã‚ã‚Œã¾ã™\nâ€¢ Firebase Authã‹ã‚‰ã®å‰Šé™¤ã‚‚æ¨å¥¨ã•ã‚Œã¾ã™\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                try {
                    console.log('ğŸ—‘ï¸ [PERMANENT] å®Œå…¨å‰Šé™¤å®Ÿè¡Œä¸­:', user.name);
                    
                    // Firestoreã‹ã‚‰å®Œå…¨å‰Šé™¤
                    const firebaseResult = await window.FirebaseDB.deleteUser(userId);
                    if (firebaseResult.success) {
                        console.log('âœ… [PERMANENT] Firestoreå‰Šé™¤æˆåŠŸ:', user.name);
                    } else {
                        console.error('âŒ [PERMANENT] Firestoreå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', firebaseResult.error);
                    }
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤
                    users = users.filter(u => u.id !== userId && u.uid !== userId);
                    saveUsers();
                    removeFromAssigneesList(user.name);
                    
                    await loadUsers();
                    showSuccess();
                    
                    alert(`ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.name}ã€ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ å‡¦ç†å®Œäº†:\nâ€¢ Firestoreã‹ã‚‰å‰Šé™¤æ¸ˆã¿\nâ€¢ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤æ¸ˆã¿\n\nâš ï¸ Firebase Console ã§ã® ${user.email} ã®å‰Šé™¤ã‚‚æ¨å¥¨ã—ã¾ã™ã€‚`);
                    
                    console.log('ğŸ—‘ï¸ [PERMANENT] å®Œå…¨å‰Šé™¤å®Œäº†:', user.name);
                } catch (error) {
                    console.error('âŒ [PERMANENT] å®Œå…¨å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å®Œå…¨å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                }
            }
        }
        
        function saveUsers() {
            localStorage.setItem('systemUsers', JSON.stringify(users));
        }
        
        function updateAssigneesList() {
            // æ—¢å­˜ã®æ‹…å½“è€…ãƒªã‚¹ãƒˆã«æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            
            users.forEach(user => {
                if (!assignees.includes(user.name)) {
                    assignees.push(user.name);
                }
            });
            
            localStorage.setItem('taskAssignees', JSON.stringify(assignees));
        }
        
        function removeFromAssigneesList(userName) {
            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆè¡¨ç¤ºå¯¾è±¡åŒæœŸï¼‰
            const assignees = JSON.parse(localStorage.getItem('taskAssignees') || '[]');
            const updatedAssignees = assignees.filter(name => name !== userName);
            localStorage.setItem('taskAssignees', JSON.stringify(updatedAssignees));
            console.log('ğŸ“ æ‹…å½“è€…ãƒªã‚¹ãƒˆæ›´æ–°:', `"${userName}"ã‚’å‰Šé™¤`, updatedAssignees);
        }
        
        function showSuccess() {
            const successMsg = document.getElementById('success-message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }
    </script>
    
    <!-- Firebaseçµ±åˆã‚·ã‚¹ãƒ†ãƒ  - ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ -->
    <script type="module" src="firebase-config.js"></script>
</body>
</html>