# ユーザーごとカラムカスタマイズ設計書

**作成日**: 2025-12-08
**ステータス**: 設計中
**関連課題**: #16

---

## 概要

各ユーザーが自分専用のカラム構成を設定できるようにする。

---

## 実装優先順位

```
1. kanbanColumns を Firestore へ移行（#1の一部）
2. カラム位置変更機能（#13含む）
3. ユーザーごとカラムカスタマイズ（#16）
4. 「全員」表示時の特殊表示
```

---

## 1. kanbanColumns Firestore移行 ✅ 完了（2025-12-08）

### 実装内容
- **保存場所**: Firestore `users/{userId}/settings/columns`
- **形式**:
```javascript
{
  columns: [
    { id: 'todo', title: 'TODO', color: '#667eea' },
    { id: 'inprogress', title: '進行中', color: '#f59e0b' },
    { id: 'waiting', title: '連絡待ち', color: '#8b5cf6' },
    { id: 'done', title: '完了', color: '#10b981' },
    { id: 'trash', title: 'アーカイブ', color: '#6c757d' }
  ],
  updatedAt: '2025-12-08T...',
  updatedBy: 'user@example.com'
}
```

### 追加された関数
- `FirebaseDB.getColumns(userId)` - カラム設定取得
- `FirebaseDB.saveColumns(columns, userId)` - カラム設定保存
- `FirebaseDB.migrateColumnsToFirestore()` - LocalStorage→Firestoreマイグレーション
- `saveColumnsToFirestore()` - ヘルパー関数（index-kanban.html内）
- `initColumnsFromFirestore()` - 初期化関数（index-kanban.html内）

### 動作仕様
- 初回ログイン時、LocalStorageに設定があればFirestoreに自動マイグレーション
- 以降はFirestoreを正とする（読み込み・保存両方）
- LocalStorageはオフライン対応用キャッシュとして残存
- 「ゴミ箱」→「アーカイブ」への自動リネーム
- done/trashカラムの存在チェック・自動追加

---

## 2. カラム位置変更機能

### 現状
- **通常タスク**: 位置変更機能なし
- **プロジェクト**: 位置変更ボタンあるが動作せず（#13）

### 実装内容
- 上下移動ボタン（↑↓）で位置変更
- ドラッグ&ドロップでの並び替え（将来対応）
- done/trash は位置変更可能だが、削除・名前変更は不可

---

## 3. ユーザーごとカラムカスタマイズ

### 表示モード別の動作

| 表示モード | カラム構成 | 備考 |
|-----------|-----------|------|
| 自分のタスク | 自分のカラム設定 | 通常カンバン |
| 特定ユーザー | そのユーザーのカラム設定 | 通常カンバン |
| **全員** | 固定3カラム | 特殊表示 |

### カラム編集ルール

| カラム | 名前変更 | 削除 | 位置変更 |
|--------|----------|------|----------|
| 完了 | ❌ 禁止 | ❌ 禁止 | ⭕ 可能 |
| アーカイブ | ❌ 禁止 | ❌ 禁止 | ⭕ 可能 |
| その他 | ⭕ | ⭕ | ⭕ |

※ developerロールのみ完了・アーカイブも編集可能

---

## 4. 「全員」表示時の特殊表示

### カラム構成
```
[ 未完了タスク一覧 ] [ 完了 ] [ アーカイブ ]
```

### 未完了タスク一覧
- 完了・アーカイブ以外の全タスクをリスト表示
- 表示項目: タスク名、担当者、期限、元カラム名、優先度
- 表示順: 期限順（未設定は最後）→ 優先度順

### 大量タスク対策
- 折りたたみ/展開機能
- またはページネーション（20件ずつ等）

---

## 検証ポイント

### ID整合性
- [ ] 位置変更でdone/trashのIDがバグらないか
- [ ] プロジェクトカラム（pj_形式）との整合性
- [ ] isDoneColumn() / isTrashColumn() の動作確認

### 表示切り替え
- [ ] ユーザー切り替え時のカラム再描画
- [ ] 他ユーザーのカラム設定読み込み
- [ ] 「全員」表示への切り替え

### 既存機能への影響
- [ ] 統計ロジック
- [ ] タスク移動処理
- [ ] フィルター機能
- [ ] ドラッグ&ドロップ

---

## 現状のコード構造（参考）

### カラム関連の主要関数

| 関数名 | 行番号 | 説明 |
|--------|--------|------|
| columns変数初期化 | 3362 | LocalStorageから読み込み |
| isDoneColumn() | 3433-3446 | 完了カラム判定 |
| isTrashColumn() | 3449-3464 | アーカイブカラム判定 |
| getColumnNameById() | 3403-3430 | カラム名取得 |
| getProjectColumns() | 6729-6755 | プロジェクトカラム取得 |
| render() | 6927-7026 | カラム表示・フィルター適用 |
| addColumn() | 8362-8396 | カラム追加 |
| editColumnName() | 8398-8413 | カラム名編集 |
| deleteColumn() | 8428-8475 | カラム削除 |

### フィルター変数
- `selectedAssigneeFilters` - 選択中の担当者
- `selectedProjectFilters` - 選択中のプロジェクト

---

## 変更履歴

| 日付 | 内容 |
|------|------
| 2025-12-08 | **Step 1完了**: kanbanColumns Firestore移行 |
| 2025-12-08 | 設計書作成、実装優先順位決定 |
