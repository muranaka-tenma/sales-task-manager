# 緊急時対応マニュアル

**作成日**: 2025-11-07
**対象**: プロダクション環境での障害対応
**重要度**: Critical

---

## クイックリファレンス

### 30秒で実施すべきこと

```bash
# 1. 即座にロールバック（Netlify）
netlify rollback

# 2. チームに通知
# Slack: #emergency チャンネルに投稿
# 件名: 🚨 緊急: システムロールバック実施

# 3. このドキュメントの該当セクションを開く
```

### 重大度の判断

| レベル | 症状 | 例 | 対応時間 |
|--------|------|----|----|
| **P0** | サービス全停止、データ損失 | ログインできない、全データ消失 | 即座（30秒） |
| **P1** | 主要機能停止 | タスク作成不可、プロジェクト表示不可 | 5分以内 |
| **P2** | 部分的機能不全 | 一部の機能が動作しない | 30分以内 |
| **P3** | 軽微な問題 | 表示崩れ、パフォーマンス低下 | 次回デプロイ |

---

## 目次

1. [P0: 緊急障害（即座対応）](#p0-緊急障害即座対応)
2. [P1: 重大障害（5分以内）](#p1-重大障害5分以内)
3. [P2: 中程度障害（30分以内）](#p2-中程度障害30分以内)
4. [P3: 軽微な問題（計画的対応）](#p3-軽微な問題計画的対応)
5. [障害通知テンプレート](#障害通知テンプレート)
6. [復旧後の対応](#復旧後の対応)

---

## P0: 緊急障害（即座対応）

### 定義
- ログインできない（全ユーザー）
- 全データが表示されない
- サイトが完全にダウン
- データ損失が発生

### 対応フロー（所要時間: 30秒〜2分）

#### ステップ1: 即座ロールバック（10秒）

**Netlify管理画面から**:
```
1. https://app.netlify.com/sites/[your-site]/deploys を開く
2. "Published deploys" セクションで前回の成功デプロイを見つける
3. 該当デプロイの「...」メニュー → "Publish deploy"
4. 確認画面で "Publish" クリック
```

**または CLI から**:
```bash
netlify rollback
```

**タイムスタンプ記録**:
- [ ] ロールバック実施時刻: _______________

#### ステップ2: 通知（10秒）

**Slackテンプレート**:
```
🚨🚨🚨 P0緊急障害

【時刻】 [HH:MM]
【症状】 [具体的な症状]
【対応】 即座にロールバック実施
【状況】 復旧確認中

@channel
全員待機してください。
```

**メールテンプレート**:
```
件名: 🚨 P0緊急障害: システムロールバック実施

緊急障害が発生したため、システムを前回の安定版にロールバックしました。

【発生時刻】 [HH:MM]
【症状】 [具体的な症状]
【対応】 ロールバック完了
【現在の状況】 復旧確認中

ユーザーへの影響時間: 約X分
現在は正常に稼働していると思われます。

詳細調査を実施し、15分以内に続報をお送りします。
```

#### ステップ3: 復旧確認（30秒）

```bash
# サイトアクセス確認
curl -I https://[your-app].netlify.app

# 期待: HTTP/2 200
```

**手動確認**:
- [ ] トップページが表示される
- [ ] ログインできる
- [ ] ダッシュボードが表示される
- [ ] データが表示される

#### ステップ4: ユーザー通知（30秒）

**Twitterテンプレート（公開サービスの場合）**:
```
【復旧完了】
XX時XX分に発生したシステム障害は復旧しました。
影響時間: 約X分
原因: 調査中
ご迷惑をおかけして申し訳ございませんでした。
```

**アプリ内通知テンプレート**:
```javascript
// 復旧後に表示するバナー
{
  type: 'warning',
  message: 'システム障害が発生していましたが、現在は復旧しています。ご不便をおかけして申し訳ございませんでした。',
  dismissible: true
}
```

#### ステップ5: 原因調査開始（並行実行）

```bash
# Netlifyデプロイログ確認
netlify logs

# Firebaseエラーログ確認
# https://console.firebase.google.com/project/[your-project]/firestore/usage

# Git差分確認
git diff HEAD~1 HEAD

# ローカルで再現テスト
git checkout HEAD~1
npm install
npm run dev
```

---

## P1: 重大障害（5分以内）

### 定義
- 主要機能が使えない（タスク作成、プロジェクト作成など）
- 一部ユーザーがログインできない
- データが一部表示されない
- セキュリティホールが発見された

### 対応フロー（所要時間: 5分）

#### ステップ1: 状況確認（1分）

```bash
# エラーログ確認
netlify logs --live

# Firebaseコンソール
# https://console.firebase.google.com/

# ブラウザコンソール確認
# F12 → Console タブ
```

**確認項目**:
- [ ] 影響範囲: 全ユーザー or 一部？
- [ ] 発生頻度: 常に or 間欠的？
- [ ] データ損失リスク: あり or なし？
- [ ] セキュリティリスク: あり or なし？

#### ステップ2: 判断（1分）

**判断フローチャート**:
```
データ損失リスクあり？
  ↓ YES → 即座にロールバック
  ↓ NO
  ↓
セキュリティリスクあり？
  ↓ YES → 即座にロールバック
  ↓ NO
  ↓
Hot Fixで15分以内に修正可能？
  ↓ YES → Hot Fix開発
  ↓ NO → ロールバック
```

**判断記録**:
- [ ] 判断結果: ロールバック / Hot Fix
- [ ] 判断理由: _______________
- [ ] 判断時刻: _______________

#### ステップ3A: ロールバック（2分）

```bash
# Git revert
git revert HEAD --no-edit
git push origin main

# または Netlifyロールバック
netlify rollback
```

#### ステップ3B: Hot Fix開発（15分）

```bash
# 1. 修正ブランチ作成
git checkout -b hotfix/[issue-description]

# 2. 修正実施
# （ファイル編集）

# 3. ローカルテスト
npm run build
npm run dev

# 4. 確認
# ブラウザで動作確認

# 5. コミット
git add .
git commit -m "hotfix: [具体的な修正内容]"

# 6. プッシュ
git push origin hotfix/[issue-description]

# 7. mainにマージ
git checkout main
git merge hotfix/[issue-description]
git push origin main
```

#### ステップ4: 通知（1分）

**Slackテンプレート**:
```
⚠️ P1障害対応中

【時刻】 [HH:MM]
【症状】 [具体的な症状]
【影響】 [影響範囲]
【対応】 [ロールバック/Hot Fix]
【状況】 対応完了、復旧確認中

15分後に状況報告します。
```

---

## P2: 中程度障害（30分以内）

### 定義
- 一部機能が使いにくい
- パフォーマンス低下（許容範囲外）
- UIの軽微な崩れ（機能は使える）
- エラーメッセージが不適切

### 対応フロー（所要時間: 30分）

#### ステップ1: 問題の特定（5分）

```bash
# ログ確認
netlify logs

# パフォーマンスプロファイリング
# Chrome DevTools → Performance タブ

# ネットワーク確認
# Chrome DevTools → Network タブ
```

**問題記録**:
- [ ] 問題の内容: _______________
- [ ] 再現手順: _______________
- [ ] 影響範囲: _______________

#### ステップ2: GitHub Issue作成（2分）

```markdown
## 問題の説明
[具体的な症状]

## 再現手順
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

## 期待される動作
[期待される動作]

## 実際の動作
[実際の動作]

## 環境
- ブラウザ: [Chrome 119 etc.]
- OS: [Windows 11 etc.]
- デプロイID: [Netlify deploy ID]

## 優先度
P2 - 中程度

## 割り当て
@[担当者]
```

#### ステップ3: 修正開発（20分）

```bash
# 修正ブランチ作成
git checkout -b fix/[issue-number]-[description]

# 修正実施
# （コード編集）

# テスト
npm run test
npm run build
npm run dev

# コミット
git add .
git commit -m "fix: [具体的な修正内容] (#[issue-number])"

# プッシュ
git push origin fix/[issue-number]-[description]
```

#### ステップ4: レビューとマージ（3分）

```bash
# Pull Request作成
gh pr create --title "fix: [修正内容]" --body "Fixes #[issue-number]"

# セルフレビュー or チームレビュー

# マージ
gh pr merge --squash
```

---

## P3: 軽微な問題（計画的対応）

### 定義
- 見た目の小さな問題
- 使い勝手の改善
- パフォーマンスの微調整
- ドキュメントの誤字

### 対応フロー（所要時間: 次回スプリント）

#### ステップ1: Issue登録

```markdown
## 問題の説明
[軽微な問題の説明]

## 優先度
P3 - 低

## マイルストーン
[次回スプリント]

## ラベル
- bug / enhancement
- UI / performance / documentation
```

#### ステップ2: バックログに追加

- [ ] Issueをバックログに追加
- [ ] 次回スプリント計画で検討

#### ステップ3: 通知（オプション）

**Slackテンプレート**:
```
ℹ️ 軽微な問題を確認

【内容】 [問題の説明]
【優先度】 P3
【対応】 次回スプリントで修正予定

Issue: #[issue-number]
```

---

## 障害通知テンプレート

### 社内向け（Slack）

#### 障害発生時
```
🚨 [P0/P1/P2] 障害発生

【時刻】 [HH:MM]
【症状】 [1行で簡潔に]
【影響】 [全ユーザー/一部ユーザー/特定機能]
【対応】 [ロールバック/Hot Fix/調査中]

対応中です。続報は[X]分後に共有します。

詳細: [Issue/ドキュメントリンク]
```

#### 復旧完了時
```
✅ 障害復旧完了

【復旧時刻】 [HH:MM]
【影響時間】 約[X]分
【原因】 [簡潔な説明]
【対応】 [実施した対応]

現在は正常に稼働しています。
詳細な報告は[X]時間後に共有します。

ご協力ありがとうございました。
```

### ユーザー向け（メール/Twitter）

#### 障害発生時
```
【システム障害のお知らせ】

現在、システムに障害が発生しており、以下の影響が出ています。

■ 影響範囲
- [影響を受ける機能]

■ 発生時刻
[HH:MM]

■ 現在の状況
復旧作業中です。

復旧次第、改めてご連絡いたします。
ご不便をおかけして申し訳ございません。

最新情報: [ステータスページURL]
```

#### 復旧完了時
```
【復旧完了のお知らせ】

[HH:MM]に発生したシステム障害は復旧しました。

■ 影響時間
約[X]分

■ 原因
[ユーザーに理解できる説明]

■ 再発防止策
[実施する対策]

ご迷惑をおかけして誠に申し訳ございませんでした。
```

### ステータスページ（HTML）

```html
<!DOCTYPE html>
<html>
<head>
  <title>システムステータス</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 50px auto; }
    .status { padding: 20px; border-radius: 5px; margin: 20px 0; }
    .operational { background: #d4edda; color: #155724; }
    .degraded { background: #fff3cd; color: #856404; }
    .outage { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>システムステータス</h1>

  <div class="status operational">
    <h2>✅ 正常稼働中</h2>
    <p>全てのシステムが正常に稼働しています。</p>
    <small>最終更新: 2025-11-07 14:00</small>
  </div>

  <h2>過去の障害</h2>
  <div class="status">
    <h3>2025-11-07 13:30 - 13:35</h3>
    <p>システム障害（約5分）</p>
    <p><strong>原因:</strong> デプロイ時の設定エラー</p>
    <p><strong>対応:</strong> ロールバック実施</p>
  </div>
</body>
</html>
```

---

## 復旧後の対応

### 即座対応（復旧後30分以内）

#### 1. 状況報告書作成（簡易版）

```markdown
# 障害報告（速報）

## 基本情報
- **発生日時**: 2025-11-07 13:30
- **復旧日時**: 2025-11-07 13:35
- **影響時間**: 約5分
- **重大度**: P0/P1/P2

## 症状
[ユーザーから見た症状]

## 影響範囲
- 影響ユーザー数: [全ユーザー/約X人]
- 影響機能: [具体的な機能]
- データ損失: なし/あり（詳細）

## 実施した対応
1. [対応1]
2. [対応2]

## 現在の状況
正常稼働中

## 次のアクション
- 詳細な原因調査（24時間以内）
- Post-Mortem作成（3日以内）
- 再発防止策実施（1週間以内）
```

#### 2. 関係者への共有

- [ ] Slackで共有
- [ ] メールで共有
- [ ] GitHub Issueに記録

### 24時間以内

#### 1. 詳細な原因調査

```bash
# ログの徹底調査
netlify logs --since "2025-11-07 13:00" --until "2025-11-07 14:00"

# コード差分の詳細確認
git log --since="2025-11-07 12:00" --until="2025-11-07 14:00" --stat

# Firebaseログ確認
# Firebase Console → Firestore → Usage タブ

# ローカル再現テスト
git checkout [問題のコミット]
npm install
npm run build
npm run dev
```

**調査結果記録**:
```markdown
## 根本原因
[技術的な詳細]

## なぜ発生したか
[5 Whys分析]
1. なぜ障害が発生したか? → [理由1]
2. なぜ[理由1]? → [理由2]
3. なぜ[理由2]? → [理由3]
4. なぜ[理由3]? → [理由4]
5. なぜ[理由4]? → [根本原因]

## なぜ検出できなかったか
[テスト/監視の不足点]

## 再現手順
1. [ステップ1]
2. [ステップ2]
3. [結果]
```

### 3日以内

#### Post-Mortem レポート作成

```markdown
# Post-Mortem: [日付] [障害タイトル]

## エグゼクティブサマリー
[1-2段落で経営層にも理解できる説明]

## タイムライン
| 時刻 | イベント | 対応者 |
|------|----------|--------|
| 13:00 | デプロイ開始 | muranaka-tenma |
| 13:30 | 障害発生 | - |
| 13:31 | 障害検知 | muranaka-tenma |
| 13:32 | ロールバック決定 | muranaka-tenma |
| 13:35 | 復旧完了 | - |

## 影響
- **ユーザー影響**: [具体的な数値]
- **ビジネス影響**: [売上損失、評判への影響など]
- **データ影響**: [損失有無]

## 根本原因
[技術的詳細]

## 解決策
[実施した対応の詳細]

## 再発防止策
### 短期（1週間以内）
- [ ] [アクション1]
- [ ] [アクション2]

### 中期（1ヶ月以内）
- [ ] [アクション1]
- [ ] [アクション2]

### 長期（3ヶ月以内）
- [ ] [アクション1]
- [ ] [アクション2]

## 学んだ教訓
### うまくいったこと
- [Good 1]
- [Good 2]

### 改善すべきこと
- [Bad 1]
- [Bad 2]

### アクションアイテム
| アクション | 担当者 | 期限 | ステータス |
|-----------|--------|------|-----------|
| [アクション1] | [担当者] | [期限] | 未着手 |
| [アクション2] | [担当者] | [期限] | 進行中 |

## 参考資料
- [関連Issue]
- [関連Pull Request]
- [ログファイル]
```

### 1週間以内

#### 再発防止策の実施

```markdown
## 実施項目

### テストの強化
- [ ] 該当箇所のユニットテスト追加
- [ ] E2Eテストシナリオ追加
- [ ] エッジケースのテスト追加

### 監視の強化
- [ ] エラーアラート設定
- [ ] パフォーマンス監視追加
- [ ] ヘルスチェック追加

### プロセスの改善
- [ ] デプロイ前チェックリスト更新
- [ ] レビュープロセス見直し
- [ ] ステージング環境での事前確認強化

### ドキュメントの更新
- [ ] 緊急対応マニュアル更新
- [ ] ロールバック手順更新
- [ ] トラブルシューティングガイド追加
```

---

## チェックリスト: 障害対応の質確認

### 対応中
- [ ] 重大度を正しく判断した
- [ ] 適切な対応（ロールバック/Hot Fix）を選択した
- [ ] 関係者に迅速に通知した
- [ ] 対応内容を記録した
- [ ] ユーザーに影響を説明した

### 対応後
- [ ] 速報を共有した（30分以内）
- [ ] 詳細調査を実施した（24時間以内）
- [ ] Post-Mortemを作成した（3日以内）
- [ ] 再発防止策を実施した（1週間以内）
- [ ] 関係者にフィードバックした

### 長期
- [ ] 学んだ教訓をチームで共有した
- [ ] プロセスを改善した
- [ ] ドキュメントを更新した
- [ ] 似た問題の横展開を実施した

---

## 付録

### 便利ツール

#### ログ監視スクリプト
```bash
#!/bin/bash
# monitor.sh - リアルタイムログ監視

while true; do
  echo "=== $(date) ==="

  # HTTP ステータス確認
  curl -s -o /dev/null -w "%{http_code}\n" https://[your-app].netlify.app

  # Netlifyログ確認
  netlify logs --live | grep -i "error\|warning"

  sleep 60
done
```

#### ヘルスチェックスクリプト
```bash
#!/bin/bash
# healthcheck.sh - システムヘルスチェック

URL="https://[your-app].netlify.app"
EXPECTED_STATUS=200

STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL)

if [ $STATUS -eq $EXPECTED_STATUS ]; then
  echo "✅ OK: $URL is healthy (status: $STATUS)"
  exit 0
else
  echo "❌ ERROR: $URL is unhealthy (status: $STATUS)"
  # Slackに通知
  curl -X POST -H 'Content-type: application/json' \
    --data '{"text":"🚨 Health check failed: '$URL' returned '$STATUS'"}' \
    https://hooks.slack.com/services/YOUR/WEBHOOK/URL
  exit 1
fi
```

### 連絡先テンプレート

```markdown
## 緊急連絡先

### デプロイ責任者
- 名前: muranaka-tenma
- Email: example@example.com
- Slack: @muranaka-tenma
- 電話: 000-0000-0000

### エスカレーション
#### Level 1（5分以内に応答なし）
- 名前: kato-jun
- Slack: @kato-jun
- 電話: 000-0000-0000

#### Level 2（15分以内に応答なし）
- 名前: asahi-keiichi
- Slack: @asahi-keiichi
- 電話: 000-0000-0000

#### Level 3（30分以内に応答なし）
- 名前: [CTO名]
- Email: cto@example.com
- 電話: 000-0000-0000

### 外部サポート
- Firebase: https://firebase.google.com/support
- Netlify: https://www.netlify.com/support
- GitHub: https://support.github.com/
```

---

**最終更新**: 2025-11-07
**文書オーナー**: muranaka-tenma
**次回レビュー**: 2025-12-07

**注意**: このドキュメントは定期的に更新し、最新の環境に合わせてください。
