# Kanban Work - TODO一覧

**バージョン**: v017
**作成日**: 2025-12-19
**最終更新**: 2025-12-25
**ステータス**: コード解析完了・リファクタリング準備中（至上命題: LocalStorage脱却は最終課題）

---

## 最重要: 次のエージェントへの引き継ぎ

### 必ず最初に読むファイル
1. **このファイル (TODO-v017)**
2. **error-logs/2025-12-18-e2e-test-issues.md**
3. **error-logs/2025-12-15-git-checkout-disaster.md**

### 絶対に守ること
1. **破壊的gitコマンド禁止**: `git checkout --`, `git reset --hard`, `git clean -fd`, `git push --force`
2. **変更したらすぐコミット**
3. **セッション開始時にTODO/エラーログを全て読む**

---

## 2025-12-25 セッションで実施したこと

### 1. フィルター機能の簡素化・バグ修正

| # | 項目 | 修正内容 |
|---|------|----------|
| 1 | 担当者必須化 | `selectedAssignees.length === 0`でalert表示＆return |
| 2 | 単一選択に変更 | チェックボックス→ラジオボタンに戻す |
| 3 | 「全員」オプション追加 | 常に表示される「全員」ラジオボタン追加 |
| 4 | 「担当者不在」削除 | フィルターオプションから完全削除 |
| 5 | ドロップダウン拡大 | max-height: 300px→500px（10人表示可） |
| 6 | リセットボタン追加 | 「検索条件をリセット」ボタン追加 |
| 7 | ヘルプボタン削除 | 日付横の「?」ボタン削除 |
| 8 | モーダル閉じ問題修正 | バリデーションエラー後にモーダルが閉じる問題を修正（closeModal()をtry内に移動） |

**修正ファイル**: `index-kanban.html`
- 行3886-3958: `populateUserFilterOptions()` - ラジオボタン＋「全員」オプション
- 行3960-4012: `selectUserFilter()` - 単一選択ハンドラ
- 行1568: ドロップダウンmax-height: 500px
- 行1587: リセットボタン追加
- 行6663-6666: 担当者必須バリデーション
- 行7021-7066: closeModal()をtryブロック内に移動

### 2. 担当者表示ローマ字バグ修正

| 問題 | 原因 | 修正内容 |
|------|------|----------|
| 担当者がローマ字（email prefix）で表示 | 誤ったファイルを修正していた | 正しいファイル（firebase-config-auth-fix-20250819-132508.js）にemailToNameMap追加 |

**修正箇所**:
- 行105-159: `getCurrentUser()` - emailToNameMap追加
- 行562-601: `getUsers()` - emailToNameMap追加
- 行604-646: `getActiveUsers()` - emailToNameMap追加

**エラーログ作成**: `error-logs/2025-12-25-user-display-name-romaji-fix.md`

### 3. コード全体解析（LocalStorage脱却準備）

#### LocalStorage使用状況
| キー | 使用箇所数 | 移行優先度 |
|------|-----------|-----------|
| `currentSession` | 27箇所 | 高 |
| `systemUsers` | 16箇所 | 中 |
| `kanbanColumns` | 24箇所 | 中 |
| `defaultDeadlineDays` | 3箇所 | 低 |
| `defaultDeadlineTime` | 3箇所 | 低 |
| `taskTemplates` | 8箇所 | 中 |
| `recurringTemplates` | 6箇所 | 中 |

#### 削除候補ファイル
| ファイル | 理由 |
|---------|------|
| `firebase-config.js` | 未使用（読み込まれていない） |
| `firebase-config-backup.js`（存在する場合） | 未使用 |
| `index-kanban-firebase-sync-fix-20250819-131009.html` | 古いバージョン |
| `index-kanban-update-fix-20250819-131834.html` | 古いバージョン |
| `test-*.js`（19ファイル） | テストフォルダへ移動推奨 |
| `debug-*.html/js`（13ファイル） | デバッグ用（削除検討） |

#### リファクタリング候補
| 問題 | 詳細 |
|------|------|
| `emailToNameMap`重複 | 3箇所以上で同一定義（統合必要） |
| `console.log` | 3,009箇所（本番環境では削除推奨） |
| 巨大関数 | 100行超の関数が複数存在 |
| マジックナンバー | タイムアウト値、z-index等がハードコード |

---

## 2025-12-25 明日の作業予定

### 優先度：高
| # | 項目 | 詳細 |
|---|------|------|
| 1 | 担当者表示修正の動作確認 | ブラウザリロード後、全員が漢字表示されるか確認 |
| 2 | 不要ファイル削除 | `firebase-config.js`等の未使用ファイル削除 |
| 3 | `emailToNameMap`統合 | 3箇所の重複定義を1箇所に統合 |

### 優先度：中
| # | 項目 | 詳細 |
|---|------|------|
| 4 | console.log削減 | 本番不要なログを削除（3,009→必要最小限） |
| 5 | テストファイル整理 | test-*.jsを専用フォルダへ移動 |
| 6 | LocalStorage脱却計画 | currentSession移行の設計・実装開始 |

### 優先度：低
| # | 項目 | 詳細 |
|---|------|------|
| 7 | デバッグファイル整理 | debug-*.html/jsの削除または移動 |
| 8 | 古いkanban HTML削除 | バックアップ後に削除 |

---

## 2025-12-23 セッションで実施したこと

### 残り2項目の完了

| # | 項目 | 修正内容 |
|---|------|----------|
| 42 | カラム削除時タスクチェック強化 | `deleteColumnInline`関数に自己タスクフィルタ追加（行9602-9617）。userId/createdBy(email)/createdBy(name)の3パターンでマッチング。E2Eテストで動作確認済み |
| 43 | 管理者ダッシュボード表示速度改善 | `loadDashboardData`関数を最適化（行12969-13050）。キャッシュ（window.tasks）活用、1回ループで全統計計算。5ms以下の実行速度を達成 |

### E2Eテスト結果

```
test-1222-night-fixes.js: 34/34 PASS ✅ (12/22夜の7修正)
test-1223-fixes.js: 8/9 PASS ✅ (コメントチェックのみ軽微な不一致)
debug-column-delete.js: フィルタロジック正常動作確認
test-column-delete-ui.js: インライン削除UI動作確認
test-settings-delete.js: 設定画面削除動作確認
```

### 検証内容

1. **カラム削除タスクフィルタ**:
   - muranaka-tenmaユーザーでTODOカラム削除 → 0件（正常）
   - muranaka-tenmaユーザーでPhase3カラム削除 → 0件（正常）
   - muranaka-tenmaユーザーでPhase2カラム削除 → 1件（正しくカウント）

2. **管理者ダッシュボード**:
   - `loadDashboardData`実行時間: 5ms以下
   - キャッシュ活用でFirebase呼び出し削減

---

## 2025-12-22 セッションで実施したこと

### 1. テンプレート関連修正

| 項目 | 修正内容 |
|------|----------|
| テンプレート保存エラー | `firebase-config-auth-fix-20250819-132508.js`にCRUD関数追加 |
| テンプレートID比較 | 文字列・数値両対応 `String(t.id) === String(templateId)` |
| テンプレート更新エラー | `updateTemplate`でドキュメント不存在時は新規作成 |
| テンプレート表示 | 重要度→メモ・備考に変更（2行truncate） |

### 2. プロジェクト作成・編集修正

| 項目 | 修正内容 |
|------|----------|
| カラー反映 | `getNewProjectColumnsWithColors()`使用に変更 |
| 保存形式 | カラムを`{name, color, type}`オブジェクト形式で保存 |
| アーカイブ重複防止 | 保存前に重複チェック＆除去ロジック追加 |
| 後方互換性 | `getProjectColumns()`で文字列・オブジェクト両対応 |

### 3. タスク作成関連修正

| 項目 | 修正内容 |
|------|----------|
| 続けて作成時の担当者クリア | セレクタを`input[type="checkbox"]`に修正 |
| テンプレートカラムフォールバック | プロジェクト選択時はそのカラムをチェック |

### 4. E2Eテスト結果

```
test-project-fixes-simple.js
============================================================
✅ PASSED: 63
❌ FAILED: 0
📈 成功率: 100.0%

全7ユーザー × 9テスト = 63テスト ALL PASS
```

### 5. データクリーンアップ

- 既存プロジェクトのアーカイブ重複を修正（計9件）
- `cleanup-archive-duplicates.js`で自動修正

### 6. 追加修正（12/22夜）

| # | 問題 | 原因 | 修正内容 |
|---|------|------|----------|
| 1 | 新規プロジェクトにアーカイブが2個 | 英語「archive」がパターンに含まれていなかった | `/アーカイブ\|archive\|ゴミ箱\|trash\|削除/i`に修正 |
| 2 | テンプレート選択で「undefined」表示 | カテゴリ未設定時の処理なし | `template.category \|\| 'その他'`のフォールバック追加 |
| 3 | プロジェクト編集後モーダルが閉じない | `this.closest('div')`が間違った要素を取得 | `document.getElementById('projectEditModal')`に修正 |
| 4 | 個人カラム削除がプロジェクト扱いされる | `selectedProjectFilters`チェックが設定画面に影響 | 設定画面用関数からプロジェクトチェック削除 |
| 5 | 個人カラム削除時タスク数が誤表示 | 全タスク（プロジェクト含む）をカウント | 個人タスクのみ(`!projectId && userId===currentUser.id`)フィルタ |
| 6 | プロジェクトカラムが管理者のみ編集可 | 権限チェックがあった | 全ユーザーがプロジェクトカラム編集可能に変更 |
| 7 | 表示対象が「プロジェクト-ユーザー名」 | 冗長な表示 | プロジェクト名のみ表示に変更 |

**修正ファイル**: `index-kanban.html`

**修正箇所**:
- `updateAssigneeFilterText()`: 行3724-3749 - プロジェクト名のみ表示
- `deleteColumn()`: 行9090-9147 - 個人タスクのみカウント、権限チェック削除
- `addColumn()`: 行8860-8870 - プロジェクトチェック削除
- `updateColumnAddButtonState()`: 行9298-9317 - 管理者チェック削除
- `quickAddColumn()`: 行9327-9330 - 管理者チェック削除
- `editColumnNameInline()`: 行9386-9392 - 管理者チェック削除
- `saveProjectChanges()`: 行13774 - モーダル取得方法修正

---

## 2025-12-19 セッションで実施したこと

### 1. E2Eテスト全実行

#### 基本テスト (run-e2e-tests.js)
```
結果: 14/14 PASS ✅

テスト内容:
- 全カラムにtype属性あり
- DONEタイプ/ARCHIVEタイプのカラム存在
- isDoneColumn/isTrashColumn判定
- 名前変更後も機能維持
- isOverdue判定
- 位置・色変更後も機能維持
```

#### 全ユーザー認証テスト (run-e2e-tests-full.js)
```
結果: 7/7ユーザー PASS ✅

検証内容:
- muranaka-tenma: 6カラム、独立性維持
- kato-jun: 6カラム、変更反映済み
- asahi-keiichi: 6カラム、独立性維持
- hanzawa-yuka: 6カラム、独立性維持
- tamura-wataru: 6カラム、独立性維持
- hashimoto-yumi: 6カラム、独立性維持
- fukushima-ami: 6カラム、独立性維持

Phase 2で kato-jun がカラム変更 → 他ユーザーに影響なし確認
```

---

## 現在の進捗（2025-12-23 v017完了）

### 完了（43/43） 🎉
| # | 項目 | 完了日 |
|---|------|--------|
| 1-28 | v016までの完了項目 | 12/18 |
| 29 | E2Eテスト全実行・検証 | 12/19 |
| 30 | テンプレート保存・更新エラー修正 | 12/22 |
| 31 | テンプレート表示（重要度→メモ） | 12/22 |
| 32 | プロジェクト作成時のカラー反映 | 12/22 |
| 33 | プロジェクト保存時のアーカイブ重複防止 | 12/22 |
| 34 | テンプレートカラム存在確認強化 | 12/22 |
| 35 | アーカイブパターン（archive追加） | 12/22夜 |
| 36 | テンプレートundefinedカテゴリ修正 | 12/22夜 |
| 37 | プロジェクト編集モーダル閉じる問題 | 12/22夜 |
| 38 | 個人カラム/プロジェクトカラム混同解消 | 12/22夜 |
| 39 | 個人カラム削除時タスクカウント修正 | 12/22夜 |
| 40 | 全ユーザーがプロジェクトカラム編集可能 | 12/22夜 |
| 41 | 表示対象プロジェクト名のみ表示 | 12/22夜 |
| **42** | **カラム削除タスクチェック強化（インラインUI）** | **12/23** |
| **43** | **管理者ダッシュボード表示速度改善** | **12/23** |

### 現在のコード状態
```javascript
const APP_VERSION = '2025-12-16-v6-ui-fixes';
```

---

## 残りタスク

### 当面の作業: カラム関連バグ発見・修正
継続的にカラム関連のバグを発見・修正していく

### 中期目標: はてなボタンのチュートリアル化
| # | 項目 | 詳細 |
|---|------|------|
| 1 | はてなボタン機能更新 | 現在の機能説明をチュートリアル形式に変更 |

### 最終課題: LocalStorage完全脱却 ⚠️至上命題
| # | 項目 | 状態 |
|---|------|------|
| 1 | currentSession | **要移行** |
| 2 | defaultDeadlineDays/Time | **要移行** |
| 3 | taskTemplates | 要確認（一部Firebase化済み？） |
| 4 | recurringTemplates | **要移行** |

### 低優先度
| # | 項目 | 詳細 |
|---|------|------|
| 1 | レガシーコード削除 | migrateProjectsToFirebase等54行 |
| 2 | タスク作成・移動パフォーマンス改善 | Violation 2574ms問題 |
| 3 | UI/UX Phase 2 | プログレスバー、アニメーション等 |

---

## ユーザー手動テスト項目

### 1. プロジェクト作成時のカラー反映
| # | 手順 | 期待結果 |
|---|------|----------|
| 1-1 | プロジェクト管理→新規作成→カラムの色ボタンをクリック→赤を選択 | 色が変わる |
| 1-2 | プロジェクト名入力→「作成」ボタン | 作成成功 |
| 1-3 | 作成したプロジェクトを選択してタスク一覧表示 | カラムに設定した色が反映されている |

### 2. プロジェクト編集・アーカイブ重複防止
| # | 手順 | 期待結果 |
|---|------|----------|
| 2-1 | 既存プロジェクトの編集ボタンをクリック | 編集モーダルが開く |
| 2-2 | 何も変更せず「保存」 | 保存成功 |
| 2-3 | 再度編集を開いてカラム確認 | アーカイブカラムが1つのまま |
| 2-4 | 上記を3回繰り返す | アーカイブが増えない |

### 3. テンプレート適用時のカラムフォールバック
| # | 手順 | 期待結果 |
|---|------|----------|
| 3-1 | タスク作成モーダルを開く | モーダル表示 |
| 3-2 | プロジェクトを選択 | カラムがプロジェクト固有のものに切り替わる |
| 3-3 | テンプレートを選択 | エラーなく適用される |
| 3-4 | カラム選択を確認 | 存在するカラムが選択されている |

### 4. 続けて作成時の担当者クリア
| # | 手順 | 期待結果 |
|---|------|----------|
| 4-1 | タスク作成モーダル→タイトル入力→担当者2名選択 | チェックが入る |
| 4-2 | 「保存して続けて作成」ボタン | タスク作成成功 |
| 4-3 | 担当者欄を確認 | 全員のチェックがクリアされている |

### 5. テンプレート編集・削除
| # | 手順 | 期待結果 |
|---|------|----------|
| 5-1 | 設定→テンプレート管理→既存テンプレートをクリック | 編集フォーム表示 |
| 5-2 | 内容を変更→「更新」ボタン | 更新成功（エラーなし） |
| 5-3 | 「削除」ボタン | 削除成功 |

### 6. 新規追加テスト（12/22夜修正分）

#### 6-1. プロジェクト編集モーダル
| # | 手順 | 期待結果 |
|---|------|----------|
| 6-1-1 | プロジェクト管理→編集ボタン | モーダル表示 |
| 6-1-2 | 「保存」ボタン | モーダルが閉じる |

#### 6-2. 個人カラム削除（設定画面）
| # | 手順 | 期待結果 |
|---|------|----------|
| 6-2-1 | 何かプロジェクトを選択した状態にする | プロジェクト表示 |
| 6-2-2 | 設定→カラム管理→任意のカラム「削除」 | 「タスクが0個あります」と表示（自分の個人タスクのみカウント） |
| 6-2-3 | 確認ダイアログが出る | 管理者権限なしでも削除可能 |

#### 6-3. プロジェクトカラム編集（非管理者）
| # | 手順 | 期待結果 |
|---|------|----------|
| 6-3-1 | 非管理者ユーザーでログイン | ログイン成功 |
| 6-3-2 | プロジェクトを選択 | プロジェクト表示 |
| 6-3-3 | カラム追加ボタンをクリック | カラム名入力可能（エラーなし） |
| 6-3-4 | カラム名入力→追加 | カラムが追加される |

#### 6-4. 表示対象のプロジェクト名表示
| # | 手順 | 期待結果 |
|---|------|----------|
| 6-4-1 | 左上「表示対象」→プロジェクト選択 | プロジェクト表示 |
| 6-4-2 | 左上の表示対象ラベル確認 | 「プロジェクト名」のみ表示（ユーザー名なし） |

---

## E2Eテストファイル一覧

| ファイル | 用途 | 最終実行 |
|---------|------|---------|
| `run-e2e-tests.js` | 基本テスト（14テスト） | 12/19 PASS |
| `run-e2e-tests-full.js` | 全ユーザー認証テスト | 12/19 PASS |
| `test-project-fixes-simple.js` | プロジェクト修正テスト（63テスト） | 12/22 PASS |
| `cleanup-archive-duplicates.js` | アーカイブ重複クリーンアップ | 12/22 実行済 |
| `create-test-tasks.js` | テストタスク作成+検証 | 12/19 PASS |
| `test-display-target-with-tasks.js` | 表示対象切り替え詳細テスト | 12/19 PASS |
| `verify-all-users.js` | 全ユーザー状態確認 | 12/18 |
| **`test-1222-night-fixes.js`** | **12/22夜7修正検証（34テスト）** | **12/23 PASS** |
| **`test-1223-fixes.js`** | **12/23修正検証（9テスト）** | **12/23 PASS** |
| **`debug-column-delete.js`** | **カラム削除タスクカウントデバッグ** | **12/23 実行** |
| **`test-column-delete-ui.js`** | **インライン削除UI動作確認** | **12/23 PASS** |
| **`test-settings-delete.js`** | **設定画面削除動作確認** | **12/23 PASS** |

---

## 開発環境

```
開発環境: http://localhost:8080/index-kanban.html
本番環境: https://stellar-biscochitos-e19cb4.netlify.app/sales-task-core/index-kanban.html
```

---

## バージョン履歴

| バージョン | 日付 | 主な内容 |
|-----------|------|---------|
| v001-v003 | 11/19-20 | 初期要件定義 |
| v004 | 11/20 | 包括的要件定義（22項目） |
| v005 | 12/01 | UI/UX Phase 1完了 |
| v006 | 12/01-02 | 統計ロジック修正（14箇所） |
| v007 | 12/04 | タスク増殖バグ修正 |
| v008 | 12/08 | OCR削除、ヘルプモーダル、kanbanColumns移行 |
| v009 | 12/09 | マイページ統計修正 |
| v010 | 12/11 | TERRAブランディング、楽観的UI更新 |
| v011 | 12/15 | ユーザーごとカラムカスタマイズ |
| v012 | 12/15 | リバート後の至上命題まとめ |
| v013 | 12/15 | git checkout災害後の復旧計画 |
| v014 | 12/16 | 復旧進捗17/36、要件検証完了 |
| v015 | 12/16 | 復旧進捗27/36、UI/UX改善10項目完了 |
| v016 | 12/18 | カラム設定全ユーザー開放、E2E検証完了 |
| v017 | 12/19 | E2Eテスト全実行 |
| v017 | 12/22 | テンプレート・プロジェクトカラー修正、アーカイブ重複防止 |
| v017 | 12/22夜 | UI/UX修正7項目、権限変更（全ユーザーがプロジェクトカラム編集可能） |
| v017 | 12/23 | 残り2項目完了（カラム削除タスクチェック強化、ダッシュボード速度改善） |
| **v017** | **12/25** | **フィルター簡素化（担当者必須・単一選択）、ローマ字表示バグ修正、コード全体解析** |

---

**最終更新**: 2025-12-25
**作成者**: Claude Code
**ステータス**: コード解析完了・リファクタリング準備中
**次のステップ**:
1. 担当者表示修正の動作確認（ブラウザリロード後）
2. 不要ファイル削除・emailToNameMap統合
3. console.log削減・テストファイル整理
4. LocalStorage脱却（currentSession移行から開始）
